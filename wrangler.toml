name = "cursor-clinical-analysis"
# 核心：指向你的 TypeScript 入口文件
main = "src/worker/index.ts"
compatibility_date = "2024-04-03"

# [第一阶段] 环境变量：通过这里统一管理 Supabase
# 提示：生产环境的 SUPABASE_KEY 建议在 Cloudflare 网页后台设置为 "Secret" 以保证安全
# 访问路径：Workers & Pages → cursor-clinical-analysis → Settings → Variables → Secrets
[vars]
SUPABASE_URL = "https://dtcplfhcgnxdzpigmotb.supabase.co"
# SUPABASE_KEY 建议在后台添加为 Secret，不要写在明文配置文件里
# 设置方法：wrangler secret put SUPABASE_KEY

# [第二阶段] KV 绑定：这是缓存"全网均值"的关键
# 注意：需要在 Cloudflare Dashboard 中创建 KV namespace
# 访问路径：Workers & Pages → KV → Create a namespace
# 创建后，将 namespace ID 填入下面的 id 字段
[[kv_namespaces]]
binding = "STATS_STORE"
id = "991ddbdb18fa4b50998c722a7332f4c0"  # 请在此处填入你创建的 KV namespace ID
preview_id = "e6f9014fb49b45eb83c8288f1d1cc1d4" # 新增这一行

# 灵魂词上报专用 KV（24h TTL，与 STATS_STORE 分离以保持独立过期策略）
[[kv_namespaces]]
binding = "KV_VIBE_PROD"
id = "f9cac5f94024451a9229253ae2367683"  # 可与 STATS_STORE 共用，或创建新 namespace 后替换

# [第二阶段] 定期汇总任务
# * * * * * = 每分钟：灵魂词 STATS_STORE → Supabase 同步（syncSoulWordsFromKV）
# 0 * * * * = 每小时整点：国家累积写入 KV（GLOBAL_COUNTRY_STATS）+ KV_VIBE 灵魂词汇总
# */10 * * * * = 每 10 分钟：国家累计 rollup（refresh_country_stats_current）
# 注意：Cron 触发器需要 Worker 付费计划（Free 计划不支持）
[triggers]
crons = ["0 * * * *"]

# [保留原有] D1 数据库：答案之书
[[d1_databases]]
binding = "prompts_library"
database_name = "prompts_library"
database_id = "921a6870-94b9-43df-8d2d-5dad83f93fd2"
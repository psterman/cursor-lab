export default {
  async fetch(request, env) {
      const corsHeaders = {
          "Access-Control-Allow-Origin": "*",
          "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
          "Access-Control-Allow-Headers": "Content-Type",
      };

      // 处理跨域预检
      if (request.method === "OPTIONS") return new Response(null, { headers: corsHeaders });

      const url = new URL(request.url);
      const clientIP = request.headers.get("CF-Connecting-IP") || "anonymous";
      const key = "total_users";
      const userLockKey = `lock_${clientIP}`;
      const allStatsKey = "all_user_stats";

      try {
          // --- 【新逻辑】1. 答案之书：随机获取一条 ---
          if (url.pathname === "/api/random_prompt") {
              const prompt = await env.DB.prepare("SELECT * FROM prompts ORDER BY RANDOM() LIMIT 1").first();
              return new Response(JSON.stringify(prompt || { content: "意识上传中...", author: "System", likes: 0 }), {
                  headers: { ...corsHeaders, "Content-Type": "application/json" }
              });
          }

          // --- 【新逻辑】2. 答案之书：点赞 ---
          if (request.method === "POST" && url.pathname === "/api/like_prompt") {
              const { id } = await request.json();
              await env.DB.prepare("UPDATE prompts SET likes = likes + 1 WHERE id = ?").bind(id).run();
              return new Response(JSON.stringify({ success: true }), { headers: corsHeaders });
          }

          // --- 【新逻辑】3. 答案之书：提交新词 ---
          if (request.method === "POST" && url.pathname === "/api/submit_prompt") {
              const { content, alias } = await request.json();
              await env.DB.prepare("INSERT INTO prompts (content, author) VALUES (?, ?)").bind(content, alias || '匿名者').run();
              return new Response(JSON.stringify({ success: true }), { headers: corsHeaders });
          }

          // --- 【原有逻辑】4. 原有体检数据与排名 (KV 部分) ---
          if (request.method === "POST") {
              const body = await request.json().catch(() => ({}));
              
              // 处理提交统计数据并计算排名
              if (body.action === "submit_stats" && body.stats) {
                  const userStats = body.stats;
                  
                  // 获取并更新所有统计数据
                  let allStatsStr = await env.STATS_STORE.get(allStatsKey);
                  let allStats = allStatsStr ? JSON.parse(allStatsStr) : [];
                  
                  const statsEntry = {
                      ip: clientIP,
                      ...userStats,
                      submittedAt: Date.now()
                  };
                  
                  const existingIndex = allStats.findIndex(s => s.ip === clientIP);
                  if (existingIndex >= 0) {
                      allStats[existingIndex] = statsEntry;
                  } else {
                      allStats.push(statsEntry);
                  }
                  
                  await env.STATS_STORE.put(allStatsKey, JSON.stringify(allStats));
                  
                  // 计算排名
                  const rankings = calculateRankings(statsEntry, allStats);
                  
                  // 更新总人数计数
                  const alreadyCounted = await env.STATS_STORE.get(userLockKey);
                  let countStr = await env.STATS_STORE.get(key);
                  let count = parseInt(countStr || "0");
                  
                  if (!alreadyCounted) {
                      count += 1;
                      await env.STATS_STORE.put(key, count.toString());
                      await env.STATS_STORE.put(userLockKey, "true", { expirationTtl: 86400 });
                  }
                  
                  return new Response(JSON.stringify({ 
                      value: count, 
                      status: "success",
                      rankings: rankings
                  }), { headers: { ...corsHeaders, "Content-Type": "application/json" } });
              }

              // 处理重置
              if (body.action === "reset") {
                  await env.STATS_STORE.delete(key);
                  return new Response(JSON.stringify({ value: 0, status: "reset_success" }), {
                      headers: { ...corsHeaders, "Content-Type": "application/json" }
                  });
              }
          }

          // 默认 GET 请求：返回总人数
          const countStr = await env.STATS_STORE.get(key);
          return new Response(JSON.stringify({ value: parseInt(countStr || "0"), status: "success" }), {
              headers: { ...corsHeaders, "Content-Type": "application/json" }
          });

      } catch (e) {
          return new Response(JSON.stringify({ error: e.message }), {
              status: 500,
              headers: { ...corsHeaders, "Content-Type": "application/json" }
          });
      }
  }
};

/**
* 内部辅助函数：计算排名 (保留自你原有的代码)
*/
function calculateRankings(userStats, allStats) {
  if (!allStats || allStats.length === 0) return {};
  const total = allStats.length;
  const metrics = ['qingCount', 'buCount', 'userMessages', 'totalUserChars', 'avgUserMessageLength', 'usageDays'];
  
  const results = {};
  metrics.forEach(metric => {
      const sorted = [...allStats].sort((a, b) => (b[metric] || 0) - (a[metric] || 0));
      const index = sorted.findIndex(s => s.ip === userStats.ip);
      const userValue = userStats[metric] || 0;
      
      let rank = index + 1;
      // 处理并列
      for (let i = index - 1; i >= 0; i--) {
          if ((sorted[i][metric] || 0) === userValue) rank = i + 1;
          else break;
      }
      results[metric] = { rank, total };
  });
  return results;
}
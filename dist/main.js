var e,t,n,a=e=>{throw TypeError(e)},o=(e,t,n)=>(((e,t,n)=>{t.has(e)||a("Cannot "+n)})(e,t,"access private method"),n);import{i as s}from"./assets/sql.js-Bh3UTgnK.js";import{getText as i}from"./assets/i18n-sI00u7yI.js";const r={"modelResponse.code":12,"modelResponse.codeBlock":11,"modelResponse.implementation":10,"modelResponse.suggestions":9,"modelResponse.changes":8,"modelResponse.diff":7,"modelResponse.fixes":6,"modelResponse.modifications":5,"modelResponse.codeAnalysis":4,"modelResponse.text":3,"modelResponse.richText":2,"modelResponse.content":1,"bubble.code":13,"bubble.codeBlock":12,"bubble.implementation":11,"bubble.text":10,"bubble.richText":9,"bubble.content":8,"bubble.message.text":7};class l{constructor(){this.db=null,this.SQL=null,this.chatData=[],this.stats={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},englishWords:{},userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}}}async init(){const e=window.BASE_PATH||"",t=e?`${e}/sql-wasm.wasm`:"./sql-wasm.wasm";console.log("[CursorParser] 初始化 sql.js，WASM 路径:",t);const n=await s({locateFile:e=>e.endsWith(".wasm")?t:e});this.SQL=n,console.log("[CursorParser] sql.js 初始化完成，WASM 路径:",t)}async loadDatabase(e){this.SQL||await this.init();try{return this.db=new this.SQL.Database(new Uint8Array(e)),console.log("[CursorParser] "),!0}catch(t){throw console.error("[CursorParser] :",t),t}}async scanDatabase(){if(!this.db)throw new Error("");this.chatData=[],this.resetStats();try{console.log("[CursorParser] ..."),console.log("[CursorParser] :",this.db.exec("SELECT name FROM sqlite_master WHERE type='table'").length);const e="\n         SELECT value FROM itemTable\n         WHERE [key] = 'workbench.panel.aichat.view.aichat.chatdata'\n       ";console.log("[CursorParser]  chatdata ..."),this.extractFromQuery(e,"json");const t="\n         SELECT value FROM itemTable\n         WHERE [key] = 'composer.composerState'\n       ";console.log("[CursorParser]  composerState ..."),this.extractFromQuery(t,"json");const n="\n         SELECT value FROM itemTable\n         WHERE value LIKE '%\"text\":%'\n       ";return console.log("[CursorParser]  text ..."),this.extractFromQuery(n,"regex"),console.log("[CursorParser] ",this.chatData.length,""),console.log("[CursorParser] ===========  ========="),console.log("[CursorParser] 总对话次数:",this.stats.totalConversations),console.log("[CursorParser] 用户消息:",this.stats.userMessages),console.log("[CursorParser] AI消息:",this.stats.aiMessages),console.log("[CursorParser] 模型使用:",this.stats.modelUsage),console.log("[CursorParser] :",this.stats.hourlyActivity.filter(e=>e>0)),console.log("[CursorParser] :",Object.keys(this.stats.topPrompts).length),console.log("[CursorParser] ======================================"),this.chatData}catch(e){throw console.error("[CursorParser] :",e),e}}appendData(e){const t=this.chatData.length;e.forEach((e,n)=>{this.chatData.push({id:t+n+1,text:e.text,role:e.role,source:e.source,length:e.text.length,timestamp:e.timestamp||(new Date).toISOString(),model:e.model||"unknown"})}),console.log(`[CursorParser]  ${e.length} : ${this.chatData.length}`)}extractFromQuery(e,t){const n=this.db.exec(e);if(0===n.length)return;const a=n[0].values;console.log(`[CursorParser] ${t}  ${a.length} `);const o=new Set;a.forEach(([e],n)=>{try{let n=[],a="";"json"===t?(n=this.extractFromJSON(e),a=t):"regex"===t&&(n=this.extractFromRegex(e),a="regex"),n.forEach(e=>{if(!e||e.text.length<5)return;const t=e.text;o.has(t)||(o.add(t),this.chatData.push({id:this.chatData.length+1,text:e.text,role:e.role,source:a,length:e.text.length,timestamp:e.timestamp||(new Date).toISOString(),model:e.model||"unknown"}),this.updateStats(e))})}catch(a){console.warn(`[CursorParser]  ${n+1} :`,a.message)}})}extractFromJSON(e){const t=[];try{const n=JSON.parse(e);n.tabs&&Array.isArray(n.tabs)&&n.tabs.forEach(e=>{e.bubbles&&Array.isArray(e.bubbles)&&e.bubbles.forEach(e=>{const n=this.extractBubbleText(e);n&&n.text&&t.push(n)})}),n.bubbles&&Array.isArray(n.bubbles)&&n.bubbles.forEach(e=>{const n=this.extractBubbleText(e);n&&n.text&&t.push(n)})}catch(n){}return t}extractBubbleText(e,t=0,n=6){if(!e||t>n)return null;const a=[],o=this.extractByPriority(e,r,{});if(o){const t=this.determineRole(e),n=this.extractModel(e);a.push({text:o,role:t,model:n,timestamp:this.extractTimestamp(e)})}else for(const s in e)if(e[s]&&"object"==typeof e[s]){const o=this.extractBubbleText(e[s],t+1,n);o&&a.push(o)}return a[0]||null}extractByPriority(e,t,n){if(!e||"object"!=typeof e)return null;let a=null,o=0,s="";for(const[i,r]of Object.entries(t)){const t=this.getNestedValue(e,i);t&&"string"==typeof t&&t.length>5&&r>o&&(a=t,o=r,s=i,n[i]=(n[i]||0)+1)}return a&&console.log(`[CursorParser]  ${s} : ${o}`),a}getNestedValue(e,t){const n=t.split(".");let a=e;for(const o of n){if(!a||"object"!=typeof a||!(o in a))return null;a=a[o]}return a}determineRole(e){if(console.log("[CursorParser] ..."),"user"===e.type)return console.log("[CursorParser]  type  USER"),"USER";if("ai"===e.type)return console.log("[CursorParser]  type  AI"),"AI";if(4===e.commandType)return console.log("[CursorParser]  commandType  USER"),"USER";if(e.userMessage||e.userPrompt||e.question)return console.log("[CursorParser]  USER"),"USER";if(e.modelResponse||e.suggestions||e.aiMessage)return console.log("[CursorParser]  AI"),"AI";if("user"===e.role||"USER"===e.role)return console.log("[CursorParser]  role  USER"),"USER";if("assistant"===e.role||"assistant"===e.role||"AI"===e.role)return console.log("[CursorParser]  role  AI"),"AI";if("user"===e.sender||"USER"===e.sender)return console.log("[CursorParser]  sender  USER"),"USER";if(e.message||e.text){const t=(e.message||e.text).toLowerCase();if(t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith(""))return console.log("[CursorParser]  USER"),"USER";if(t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith(""))return console.log("[CursorParser]  AI"),"AI"}return console.log("[CursorParser]  AI"),"AI"}extractModel(e){const t=["model","modelResponse.model","aiModel","response.model","completion.model"];for(const n of t){const t=this.getNestedValue(e,n);if(t&&"string"==typeof t){return t.split("-")[0]}}return"unknown"}extractTimestamp(e){const t=["timestamp","createdAt","created","time","updatedAt","updatedAt","messageTime","sentAt","bubbleTime","userTime","aiTime"];console.log("[CursorParser] ...");for(const a of t){const t=this.getNestedValue(e,a);if(t)try{const e=new Date(t);if(!isNaN(e.getTime()))return console.log(`[CursorParser]  ${a} : ${e.toISOString()}`),e.toISOString()}catch(n){console.warn(`[CursorParser]  ${a} :`,n)}}return console.warn("[CursorParser] "),(new Date).toISOString()}extractFromRegex(e){console.log("[CursorParser] ...");const t=[];let n=0;return[/"text":\s*"([^"]+)"/g,/"code":\s*"([^"]+)"/g,/"implementation":\s*"([^"]+)"/g,/"content":\s*"([^"]+)"/g].forEach(a=>{let o;for(;null!==(o=a.exec(e));){n++;const a=o[1];if(a&&a.length>=5){const n=this.inferRoleFromContext(e,o.index,a),s=this.inferModelFromContext(e,o.index),i=this.inferTimestampFromContext(e,o.index);t.push({text:a,role:n,model:s,timestamp:i})}}}),console.log(`[CursorParser]  ${n}  ${t.length} `),console.log("[CursorParser] :",{USER:t.filter(e=>"USER"===e.role).length,AI:t.filter(e=>"AI"===e.role).length,unknown:t.filter(e=>"unknown"===e.role).length}),t}inferRoleFromContext(e,t,n){const a=Math.max(0,t-500),o=Math.min(e.length,t+500),s=e.substring(a,o);let i=0,r=0;return[/"type"\s*:\s*"user"/i,/"role"\s*:\s*"user"/i,/"commandType"\s*:\s*4/,/"userMessage"/i,/"userPrompt"/i,/"question"/i].forEach(e=>{e.test(s)&&i++}),[/"type"\s*:\s*"ai"/i,/"role"\s*:\s*"assistant"/i,/"role"\s*:\s*"ai"/i,/"modelResponse"/i,/"suggestions"/i,/"aiMessage"/i].forEach(e=>{e.test(s)&&r++}),i>r?"USER":r>i?"AI":"unknown"}inferModelFromContext(e,t){const n=Math.max(0,t-200),a=Math.min(e.length,t+200),o=e.substring(n,a),s=[/"model"\s*:\s*"([^"]+)"/i,/"aiModel"\s*:\s*"([^"]+)"/i,/"response\.model"\s*:\s*"([^"]+)"/i,/"completion\.model"\s*:\s*"([^"]+)"/i];for(const i of s){const e=i.exec(o);if(e&&e[1]){const t=e[1].split("-")[0];return console.log(`[CursorParser] : ${t}`),t}}return"unknown"}inferTimestampFromContext(e,t){const n=Math.max(0,t-200),a=Math.min(e.length,t+200),o=e.substring(n,a),s=[/"timestamp"\s*:\s*"([^"]+)"/i,/"createdAt"\s*:\s*"([^"]+)"/i,/"created"\s*:\s*"([^"]+)"/i,/"time"\s*:\s*"([^"]+)"/i,/"updatedAt"\s*:\s*"([^"]+)"/i];for(const r of s){const e=r.exec(o);if(e&&e[1])try{const t=new Date(e[1]);if(!isNaN(t.getTime()))return console.log(`[CursorParser] : ${t.toISOString()}`),t.toISOString()}catch(i){console.warn("[CursorParser] :",i)}}return console.warn("[CursorParser] "),(new Date).toISOString()}updateStats(e){var t,n;if(console.log("[CursorParser] :",{role:e.role,textLength:null==(t=e.text)?void 0:t.length,hasTimestamp:!!e.timestamp,model:e.model,first50Chars:null==(n=e.text)?void 0:n.substring(0,50)}),e.text&&e.text.length>0){const t=e.text;this.stats.totalConversations;const n=t.match(/请/g);n&&n.length>0&&(this.stats.qingCount=(this.stats.qingCount||0)+n.length,console.log(`[CursorParser] [${e.role}] "请"字 +${n.length} : ${this.stats.qingCount} | 文本: "${t.substring(0,50)}..."`));const a=t.match(/不/g);a&&a.length>0&&(this.stats.buCount=(this.stats.buCount||0)+a.length,console.log(`[CursorParser] [${e.role}] "不"字 +${a.length} : ${this.stats.buCount} | 文本: "${t.substring(0,50)}..."`))}if(this.stats.totalConversations++,"USER"===e.role?(this.stats.userMessages++,console.log("[CursorParser] 用户消息:",this.stats.userMessages)):(this.stats.aiMessages++,console.log("[CursorParser] AI消息:",this.stats.aiMessages)),console.log("[CursorParser] 总对话次数:",this.stats.totalConversations),e.text&&e.text.length>0&&"USER"===e.role){const t=e.text;t.toLowerCase(),this.stats.userBehaviorStats.totalUserChars+=t.length,(t.includes("?")||t.includes("？")||t.includes("如何")||t.includes("怎么")||t.includes("为什么")||t.includes("what")||t.includes("how")||t.includes("why"))&&this.stats.userBehaviorStats.questionMessageCount++,this.extractTechStack(t),this.extractWordCloudData(t)}this.stats.userMessages>0&&(this.stats.userBehaviorStats.avgUserMessageLength=Math.round(this.stats.userBehaviorStats.totalUserChars/this.stats.userMessages));const a=e.model||"unknown";if(this.stats.modelUsage[a]=(this.stats.modelUsage[a]||0)+1,console.log(`[CursorParser] : ${a} = ${this.stats.modelUsage[a]}`),e.timestamp)try{const t=new Date(e.timestamp).getHours();this.stats.hourlyActivity[t]++,console.log(`[CursorParser] : ${t}:00 = ${this.stats.hourlyActivity[t]}`)}catch(o){console.error("[CursorParser] :",o)}else console.warn("[CursorParser] ");if(e.timestamp)try{const t=new Date(e.timestamp).toISOString().split("T")[0];this.stats.dailyActivity[t]=(this.stats.dailyActivity[t]||0)+1}catch(o){console.error("[CursorParser] :",o)}"USER"===e.role&&e.text?this.extractWords(e.text):"USER"!==e.role&&console.log("[CursorParser] "),"USER"===e.role&&e.text&&this.extractChineseWords(e.text)}extractWords(e){console.log(`[CursorParser] : ${e.length}`);const t=new Set(["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","to","of","in","for","on","at","by","with","from","as","into","through","during","before","after","above","below","between","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","mine","theirs","am","is","are","was","were","be","been","being","have","has","had","can","could","will","would","should","may","might","must","please","help","write","a","one","some","any","all","both","how","what","which","who","when","where","why","whether","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front","forward"]),n=e.match(/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g)||[];console.log(`[CursorParser]  ${n.length} /`),n.forEach(e=>{if(e.length<2)return;if(e.length>20)return;const n=e.toLowerCase();t.has(n)||(this.stats.topPrompts[n]=(this.stats.topPrompts[n]||0)+1)});const a=Object.keys(this.stats.topPrompts).length;console.log(`[CursorParser] ${a} ${n.length} `)}extractChineseWords(e){const t=(this.stats.userMessages||0)+(this.stats.aiMessages||0);t<10&&(console.log(`[CursorParser]  ${t+1}: ${e.length}`),console.log(`[CursorParser]  : "${e.substring(0,80)}..."`));const n=new Set(["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]),a=e.match(/[\u4e00-\u9fa5]{2,}/g)||[];t<10&&(console.log(`[CursorParser]  ${a.length} `),a.length>0&&console.log("[CursorParser] :",a.slice(0,5)));let o=0;a.forEach(e=>{if(e.length>10)return;const t=e.trim();n.has(t)||(this.stats.topChineseWords=this.stats.topChineseWords||{},this.stats.topChineseWords[t]=(this.stats.topChineseWords[t]||0)+1,o++)}),(t<10||o>0)&&Object.keys(this.stats.topChineseWords||{}).length}extractTechStack(e){if(!e||0===e.length)return;this.stats.userBehaviorStats.techStack||(this.stats.userBehaviorStats.techStack={});const t=this.stats.userBehaviorStats.techStack;[{name:"JavaScript",pattern:/\b(javascript|js|typescript|ts|node\.?js?|es6|es2015|ecmascript)\b/gi},{name:"Python",pattern:/\b(python|py|django|flask|fastapi|pandas|numpy|scipy)\b/gi},{name:"Java",pattern:/\b(java|spring|springboot|maven|gradle|jvm)\b/gi},{name:"Go",pattern:/\b(go|golang|gin|echo|goroutine)\b/gi},{name:"Rust",pattern:/\b(rust|cargo|rustc)\b/gi},{name:"C/C++",pattern:/\b(c\+\+|cpp|c语言|clang|gcc)\b/gi},{name:"PHP",pattern:/\b(php|laravel|symfony|composer)\b/gi},{name:"Ruby",pattern:/\b(ruby|rails|ruby on rails|gem)\b/gi},{name:"Swift",pattern:/\b(swift|swiftui|ios)\b/gi},{name:"Kotlin",pattern:/\b(kotlin|android|kotlinx)\b/gi},{name:"C#",pattern:/\b(c#|csharp|\.net|asp\.net|dotnet)\b/gi},{name:"TypeScript",pattern:/\b(typescript|ts|tsx)\b/gi},{name:"React",pattern:/\b(react|reactjs|jsx|redux|mobx|next\.js|nextjs|gatsby|remix)\b/gi},{name:"Vue",pattern:/\b(vue|vuejs|vue\.js|nuxt|nuxtjs|vuex|pinia)\b/gi},{name:"Angular",pattern:/\b(angular|angularjs|ng-|@angular)\b/gi},{name:"Svelte",pattern:/\b(svelte|sveltekit)\b/gi},{name:"Express",pattern:/\b(express|expressjs|express\.js)\b/gi},{name:"Koa",pattern:/\b(koa|koajs)\b/gi},{name:"NestJS",pattern:/\b(nest|nestjs|@nestjs)\b/gi},{name:"FastAPI",pattern:/\b(fastapi|fast-api)\b/gi},{name:"Django",pattern:/\b(django|djangorest)\b/gi},{name:"Flask",pattern:/\b(flask|flask-restful)\b/gi},{name:"MySQL",pattern:/\b(mysql|mariadb)\b/gi},{name:"PostgreSQL",pattern:/\b(postgresql|postgres|pg)\b/gi},{name:"MongoDB",pattern:/\b(mongodb|mongo|mongoose)\b/gi},{name:"Redis",pattern:/\b(redis|redisson)\b/gi},{name:"SQLite",pattern:/\b(sqlite|sqlite3)\b/gi},{name:"Elasticsearch",pattern:/\b(elasticsearch|elastic|es)\b/gi},{name:"Docker",pattern:/\b(docker|dockerfile|docker-compose)\b/gi},{name:"Kubernetes",pattern:/\b(kubernetes|k8s|kubectl)\b/gi},{name:"Git",pattern:/\b(git|github|gitlab|bitbucket)\b/gi},{name:"AWS",pattern:/\b(aws|amazon web services|s3|ec2|lambda)\b/gi},{name:"Azure",pattern:/\b(azure|azure devops)\b/gi},{name:"GCP",pattern:/\b(gcp|google cloud|gcloud)\b/gi},{name:"Vercel",pattern:/\b(vercel)\b/gi},{name:"Netlify",pattern:/\b(netlify)\b/gi},{name:"TensorFlow",pattern:/\b(tensorflow|tf|tensorflow\.js)\b/gi},{name:"PyTorch",pattern:/\b(pytorch|torch)\b/gi},{name:"Bootstrap",pattern:/\b(bootstrap|bs-)\b/gi},{name:"Tailwind",pattern:/\b(tailwind|tailwindcss)\b/gi}].forEach(({name:n,pattern:a})=>{const o=e.match(a);o&&o.length>0&&(t[n]=(t[n]||0)+o.length)})}extractWordCloudData(e){if(!e||0===e.length)return;const t=new Set(["的","是","在","了","我","你","他","她","它","我们","你们","他们","和","或","但是","因为","所以","如果","就","也","都","很","非常","可以","能","会","要","有","没","不","来","去","这","那","个","请","帮","写","一个","怎么","如何","什么","哪个","哪个","吗","呢","吧","啊","哦","嗯","哈","嘿","好"]),n=new Set(["the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","to","of","in","for","on","at","by","with","from","as","into","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","can","could","will","would","should","may","might","must","please","help","write","one","some","any","all","both","how","what","which","who","when","where","why","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front"]);(e.match(/[\u4e00-\u9fa5]{2,10}/g)||[]).forEach(e=>{!t.has(e)&&e.length>=2&&e.length<=10&&(this.stats.chineseWords[e]=(this.stats.chineseWords[e]||0)+1)});(e.match(/\b[a-zA-Z]{2,20}\b/g)||[]).forEach(e=>{const t=e.toLowerCase();!n.has(t)&&e.length>=2&&e.length<=20&&(this.stats.englishWords[t]=(this.stats.englishWords[t]||0)+1)})}resetStats(){this.stats={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},englishWords:{},userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}}}getAllData(){return this.chatData}getStats(){return{...this.stats,topChineseWordsList:this.getTopChineseWords(10)}}getMostUsedModel(){const e=Object.entries(this.stats.modelUsage);if(0===e.length)return"unknown";const[t,n]=e.sort((e,t)=>t[1]-e[1])[0];return{model:t,count:n}}getTopPrompts(e=5){return Object.entries(this.stats.topPrompts).sort((e,t)=>t[1]-e[1]).slice(0,e).map(([e,t])=>({prompt:e,count:t}))}getTopChineseWords(e=10){return Object.entries(this.stats.topChineseWords).sort((e,t)=>t[1]-e[1]).slice(0,e).map(([e,t])=>({word:e,count:t}))}formatDailyActivity(){return Object.entries(this.stats.dailyActivity).sort((e,t)=>e[0].localeCompare(t[0])).map(([e,t])=>({date:e,count:t}))}search(e){if(!e)return this.chatData;const t=e.toLowerCase();return this.chatData.filter(e=>e.text.toLowerCase().includes(t))}getPayloadForAnalysis(){if(!this.chatData||!Array.isArray(this.chatData))return console.warn("[CursorParser] chatData 不存在或格式错误，返回空数据"),{meta:{total_conversations:0,top_model:"unknown",hourly_distribution:new Array(24).fill(0)},messages:[],exportTime:(new Date).toISOString()};const e=this.chatData.slice(-80);console.log(`[CursorParser] 采样窗口：从 ${this.chatData.length} 条记录中提取最近 ${e.length} 条`);const t=e.map((e,t)=>{if(!e)return null;let n=e.text||e.content||"";"string"!=typeof n&&(n=String(n||"")),n=n.replace(/```[\s\S]*?```/g,"");let a=!1;return n.length>500&&(n=n.substring(0,500),a=!0),n=this.sanitizeSensitiveData(n),a&&(n+="...[TRUNCATED]"),{role:e.role||"unknown",content:n,timestamp:e.timestamp||(new Date).toISOString()}}).filter(e=>null!==e&&e.content&&e.content.trim().length>0);console.log(`[CursorParser] 压缩后消息数：${t.length}`);return{meta:{total_conversations:this.stats.totalConversations||this.chatData.length,top_model:this.getMostUsedModel().model||"unknown",hourly_distribution:[...this.stats.hourlyActivity||new Array(24).fill(0)]},messages:t,exportTime:(new Date).toISOString()}}sanitizeSensitiveData(e){if(!e||"string"!=typeof e)return e||"";let t=e;t=t.replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,"[EMAIL]");t=t.replace(/Bearer\s+[A-Za-z0-9\-._~+/]+=*/gi,"Bearer [TOKEN]");[/\b(sk-[A-Za-z0-9]{20,})\b/gi,/\b(pk_[A-Za-z0-9]{20,})\b/gi,/\b(AIzaSy[A-Za-z0-9_-]{35})\b/gi,/\b(xox[baprs]-[A-Za-z0-9-]{10,})\b/gi,/\b(ghp_[A-Za-z0-9]{36})\b/gi,/\b([A-Za-z0-9]{32,})\b/g].forEach(e=>{t=t.replace(e,"[API_KEY]")});t=t.replace(/\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/g,"[IP_ADDRESS]");return t=t.replace(/\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b/g,"[IP_ADDRESS]"),t}close(){this.db&&(this.db.close(),this.db=null)}}const c={dimension:"logic",weights:{L1:15,L2:5,L3:1},data:{execution_sequence:{name:"任务解构与线性序列",L3:["先","然后","最后","第一步","第二步","第三步","第四步","第五步","接着","再","弄完","开始","结束","流程","顺序","步骤","先做","之前","之后","接着做","一会","后面","前面","把...弄好","一个个","一次次","执行","准备","完成","搞定","弄好","按照","先来","起手","收尾","大致","先把","接下来","紧接着"],L2:["初始化","预处理","阶段","任务","触发","串行","并行","逻辑","模块","调用","分层","映射","传递","挂载","生命周期","流程图","伪代码","按序","分步","循环","迭代","处理","入口","出口","关联","指向","过渡","衔接","执行流","控制权","实例化","解构","重组","流转","节点","同步执行","队列","压栈","出栈","优先级"],L1:["异步流","流水线","原子操作","幂等性","拓扑排序","递归基","有限状态机","同步锁","协程","并发","时效性","单线程","多线程","资源调度","阻塞","非阻塞","回溯算法","深度优先","广度优先","分而治之","贪心","动态规划","时间窗口","事件循环","依赖反转","上下文切换","句柄池","负载均衡","反向代理","高内聚","低耦合"]},constraints:{name:"条件约束与因果判定",L3:["如果","要是","否则","只有","只要","必须","一定要","不能","因为","所以","结果","原因","除非","要是没","否则就","除了","全部","部分","只要是","一旦","要是报错","要是对","要是错","由于","导致","要是这样","要是那样"],L2:["只有当","必须得","原因在于","引发","判定","分支","约束","拦截","过滤","筛选","校验","合法","失效","生效","条件句","判断逻辑","触发条件","执行前提","开关","标志位","范围","匹配","验证","白名单","黑名单","非法","有效","阈值","限定","隔离","权限","赋予","禁止","拒绝","准入"],L1:["边界条件","临界值","正则表达式","强类型","静态检查","布尔逻辑","因果链","依赖注入","权限守卫","单例","副作用","解耦","闭包","作用域","逃逸分析","不变性","引用计数","逻辑或","逻辑与","异或","短路逻辑","断言","防御性编程","契约式设计","泛型约束","类型擦除","虚函数","抽象类","接口契约"]},diagnostics:{name:"Bug诊断与复现",L3:["报错","不对","不行","坏了","点不动","没反应","乱码","卡了","重写","换个","哪里","怎么","改下","这里","那里","出错了","检查下","找找看","对比","弄错","修复","改改","重弄","还没好","换一种","不对劲","重新生成"],L2:["排查","定位","堆栈","日志","监控","输出","变量","复现","覆盖","回归","偏差","溢出","冲突","差异","回退","环境","版本","配置","热更新","同步","异步报错","捕捉","异常处理","打印","控制台","控制变量","重置","清除缓存","刷新","重启","调试","纠错","补丁"],L1:["竞态条件","内存泄漏","复现路径","空指针","断点调试","单元测试","逆向","链路","回溯","脏数据","脏读","死锁","吞吐量","瓶颈","反模式","堆栈溢出","影子副本","自愈","可观测性","链路追踪","灰度","金丝雀发布","熔断","限流","服务降级","心跳检测","健康检查","容灾","备份","持久化"]},abstraction:{name:"结构化复盘与抽象",L3:["总结","整理","记下","翻译","注释","说明","大概","总的来说","简单说","变一下","分类","思路","计划","下一步","记账","大体上","换句话说","意思是","也就是说","简单理解","讲讲看","写清楚","解释"],L2:["整理下","说一下","原来是","明白","懂了","搞定","方案","想法","重弄","优化","提速","整洁","规范","简单点","清晰","核心","原理","结构","重构","解耦","目录结构","配置文件","部署流程","脚本自动化","CI/CD","镜像","容器"],L1:["技术债","设计模式","最佳实践","鲁棒性","可维护性","标准化","微服务","代码规范","文档化","自愈","可观测性","高可用","可扩展","奥卡姆剃刀","敏捷开发","看板","代码评审","领域驱动","事件驱动","基础设施即代码"]},meta_logic:{name:"连接词与元符号",L3:["不仅...而且","虽然...但是","与其...不如","要么...要么","既然...那么","综上所述","具体来说","本质上","从长远看","为了防止","目的是","效果是","考虑到","排除掉","换位思考","逻辑上","事实上","必然","大概率","几乎"],L2:["只改这里","严格按照","保持原样","不要改动","Markdown","JSON","CSV","YAML","代码块","逐行","分段","合并"],symbols:["1\\.","2\\.","3\\.","->","=>","&&","\\|\\|","!","TODO","FIXME","DONE","# ","\\[ \\]"]}}},d={dimension:"patience",weights:{L1:15,L2:5,L3:1},data:{tolerance_guidance:{name:"容错、安抚与温和引导",L3:["没事","没关系","不要紧","重来","不急","慢慢来","再试一下","换个说法","你看","我想的是","其实是","再想想","理解错了","不是这个","再来","没对","差一点","重弄","重新说","试下"],L2:["可以理解","可能我没说清","忽略这个","跳过","先不管","暂且","继续往下","我们回到","刚才那个","重新对齐","明确一下","再生成一次","尝试","纠正","微调","步进","重新运行"],L1:["容错","由于上下文丢失","重新采样","Temperature 偏移","Prompt 注入","强制对齐","初始化对话","清理缓存","重设种子","迭代反馈","增量更新","梯度引导","启发式","收敛","一致性检查"]},bug_analysis:{name:"Bug 纠缠、报错分析与建设性反馈",L3:["还是不对","还是错","这里没变","没反应","点了没用","乱码了","报错了","看这里","怎么还是","还是刚才那个","不对啊","你看这个","检查下","帮我看下","哪里错了"],L2:["报错信息是","堆栈显示","我看下日志","问题出在","可能是因为","尝试定位","分段调试","打印变量","控制台显示","异常捕获","复现路径","排查","逐步","缩小范围","注释掉"],L1:["内存溢出","竞态","空解引用","死循环","异步竞态","依赖冲突","环境变量","版本不匹配","构建失败","运行时异常","逻辑回归","断点信息","Dump","核心转储","链路跟踪"]},deep_interaction:{name:"深度交互、追问与细节微雕",L3:["再改改","好一点","还要","这里也要","再细点","颜色换下","再小点","左边一点","圆润点","舒服点","整洁点","这里也要改","还有个地方","顺便","再加个"],L2:["对齐规范","视觉补偿","交互反馈","加载状态","极端情况","边缘Case","优化体验","响应式适配","无障碍","语义化","重构这段","合并","抽离","组件化","解耦"],L1:["像素完美","性能损耗","渲染开销","防抖节流","首屏优化","按需加载","树摇","复杂度 O(n)","内存占用","并发控制","协议转换","缓存击穿","幂等校验"]},emotional_stability:{name:"情绪稳定性与负向屏蔽",L3:["垃圾","笨死","智障","不行就滚","听不懂吗","说了多少次","毁灭吧","算了不弄了","废物","SB","垃圾AI","到底行不行","浪费时间","崩溃","吐了","死机","撤回"],L2:["算了看这段","还是我自己来","你看这里的逻辑","直接改这里吧","不废话了看代码","我再演示一遍","最后一次"]},structured_instruction:{name:"结构化指令、文档化与长程规划",L3:["首先","其次","最后","考虑到","为了","目的是","防止","避免","如果可能的话","请务必","最好是","麻烦你","辛苦","能不能麻烦","我想请教","有个问题请教"],L2:["有序引导","分段逻辑","长远规划","温馨提示","写给AI看的注释","严谨的格式引用","Markdown 代码块"],symbols:["1\\.","2\\.","3\\.","---","TODO:","Note:","//"]}}},u={dimension:"detail",weights:{L1:15,L2:5,L3:1},data:{visual_ui:{name:"视觉、UI 与像素级微调",L3:["好看点","舒服点","整洁","对齐","颜色","阴影","圆角","间距","字体","大小","左边一点","右边一点","空行","居中","背景","加粗","颜色换下","变小点","太挤了","空开"],L2:["像素","边距","填充","色值","透明度","过渡","动画","响应式","适配","比例","对称","补偿","视觉焦点","层次感","对比度","骨架屏","动效","贝塞尔曲线","模糊","滤镜","投影"],L1:["Pixel Perfect","1px","抗锯齿","灰阶","排版引擎","栅格系统","黄金比例","视觉一致性","微交互","状态反馈","SVG路径","Canvas重绘","硬件加速","亚像素渲染","暗黑模式适配"]},code_hygiene:{name:"命名规范、语义化与代码洁癖",L3:["名字","改名","好懂点","注释","中文","别用缩写","这里删掉","空格","空行","整理下","换行","写法","看起来","简单点","统一","别乱"],L2:["命名规范","语义化","驼峰","下划线","常量","变量名","函数名","解构","重命名","缩进","代码风格","格式化","Prettier","Lint","冗余","干掉","复用","提取","组件化","封装"],L1:["命名冲突","作用域污染","魔术字符串","硬编码","类型推导","泛型","接口定义","强类型","TS约束","枚举","私有属性","装饰器","抽象层","高阶","逻辑抽离","单例","SOLID"]},boundary_performance:{name:"边界处理与性能敏感",L3:["报错怎么办","万一没数据","加载中","卡住了","网络不好","点快了","重复了","空的时候","最后一行","最上面","限制","范围","检查","防止","安全"],L2:["边界情况","异常处理","空状态","骨架图","防抖","节流","内存","缓存","加载优化","首屏","懒加载","预加载","超时","重试","并发限制","校验","正则限制","长度","规模"],L1:["时间复杂度","空间复杂度","内存泄漏","垃圾回收","重绘回流","虚拟列表","按需引入","树摇","包体积","Tree-Shaking","服务端渲染","流式","Hydration","Web Worker"]},doc_abstraction:{name:"文档、注释与逻辑梳理",L3:["写清楚","记下来","讲讲","这是啥","为啥","笔记","翻译","中文注释","简单说","大概","原理","思路","整理","文档"],L2:["说明文档","API手册","参数","返回值","示例","README","部署步骤","更新记录","变更","优化点","逻辑流程","整理","归档","备份","发布"],L1:["设计模式","最佳实践","自解析","元数据","反射","架构图","时序图","变更日志","版本控制","Git","提交信息","PR","Code Review","标准化","自动化"]},precision_control:{name:"指令微雕与控制精度",L2:["只修改","不改变","保持原样","局部","这一行","该函数","仅调整","替换为","不要重写","严格执行","完全一致","对比","差异","Patch","增量","Diff"],symbols:["Markdown","JSON Schema","TypeScript","Props","Interface","TODO","FIXME","\\/\\* .* \\*\\/","#","---","\\[x\\]","精准","无损","优化"]}}},g={dimension:"exploration",weights:{L1:15,L2:5,L3:1},data:{frontier_tech:{name:"前沿技术与实验性尝试",L3:["最新","最酷","有没有新的","试试看","能不能用","听说","我想试下","换个高级的","这个好玩吗","有没有更厉害的","黑科技","新出的","试试那个"],L2:["Beta版本","实验性","新特性","Next代","草案","前沿","迁移","升级","原生","高性能","WebAssembly","Wasm","GPU加速","WebGPU","流式","SSR","边缘计算"],L1:["Canvas粒子","Shaders","GLSL","低代码引擎","自研协议","混合开发","跨端引擎","内核","底层API","神经网络","向量数据库","分布式","P2P","去中心化"]},cross_boundary:{name:"跨界融合与异构系统",L3:["加上音乐","配合视频","做成游戏","自动生成","能不能连","一边...一边","像什么一样","模仿","整合","混搭","加个功能","能不能画出来"],L2:["数据可视化","可视化图表","物理引擎","Three.js","D3.js","交互式","硬件","串口","蓝牙","Arduino","传感器","爬虫","自动化","批量处理","多线程协作"],L1:["跨语种调用","FFI","多语言混合","中间层","网关","协议转换","二进制解析","编解码","流媒体处理","数学建模","蒙特卡洛","博弈论","遗传算法"]},deep_inquiry:{name:"原理溯源与深度质询",L3:["为啥","怎么实现的","怎么回事","讲解下","原理是啥","我想学","教我","怎么懂","解释","是什么","为什么不行","怎么优化的"],L2:["底层逻辑","运行机制","性能瓶颈","为什么快","差异在哪","优缺点","对比","权衡","选择","方案评估","内部原理","解析","执行过程","内存模型"],L1:["源码实现","反汇编","AST","编译器原理","垃圾回收机制","算法复杂度","V8引擎","内核调用","抽象语法树","零拷贝","并发原语","形式化验证"]},solution_diversity:{name:"方案多样性与对比",L3:["还有吗","别的办法","另一种","换个写","有没有简单的","有没有快的","要是不用这个","如果不这样","再给几个"],L2:["对比方案","选型","取舍","利弊","不同思路","另一种架构","重构建议","替代品","迁移成本","兼容方案","兜底逻辑","最优解","次优解"],L1:["极致精简","一代码实现","One-liner","高阶函数","代码高尔夫","性能极限","压测","Benchmark","极致压缩","最小依赖","零依赖"]},scene_mutation:{name:"场景突变与脑洞控制",L3:["把...变成","像...一样运行","如果是...会怎样","脑洞大开","如果不按常规","打破限制","自定义规则","特殊的","罕见的","古怪的"],L1:["太空风格","赛博朋克","复古","极简","超现实","黑客","交互叙事","生成式","自动化","魔法","脚本","插件","扩展","工具链","全自动"]}}},h={dimension:"feedback",weights:{L1:15,L2:5,L3:1},data:{realtime_correction:{name:"即时修正与方向纠偏",L3:["对","不对","好了","就是这样","没错","错位了","还没到","改下","换个","重新来","不对劲","差一点","好多了","这个行","不行","就这样","继续"],L2:["偏了","逻辑反了","这里多余","少了一块","格式乱了","位置不对","颜色偏深","太快了","慢一点","不对路","方向错了","撤回","重置"],L1:["偏差修正","逻辑对齐","非预期输出","回归","偏移","基准点","指令漂移","幻觉校正","上下文丢失","输出截断","反馈回路","状态同步","单步确认"]},surgical_modification:{name:"局部微雕与手术刀意识",L3:["这行","那个字","这里加点","那里删点","改这里","不动那边","就改这个","变一下","加个","减个","挪一下","换个词"],L2:["局部重构","指定行","保持原样","只改逻辑","不改样式","仅替换","保留注释","增量修改","补丁","插值","覆写该函数","变量名微调","代码块","片段"],L1:["Diff 模式","Patch 应用","原子化更新","无损修改","副作用隔离","指定作用域","解耦修改","行内替换","正则替换","索引定位","指针修正"]},tacit_understanding:{name:"肯定确认与默契度调教",L3:["聪明","厉害","对了","懂我","好用","就是这个感觉","记住了","以后都这样","真棒","可以","收工","完美","牛逼","谢了"],L2:["保持这种风格","默认","预设","统一按照","以后不用说","你知道的","按刚才的来","惯例","模板","约定","规范化","套用","沿用"],L1:["Few-Shot","思维链对齐","提示词工程","角色设定","上下文注入","指令强化","正向诱导","负向约束","概率加权","模型微调意图"]},deep_audit:{name:"质疑、否定与深度重审",L3:["你确定?","不对吧","你在干嘛","认真的吗","写完了吗","怎么少了","逻辑呢","刚才还行","怎么变了","糊弄我","认真点"],L2:["有漏洞","逻辑不闭环","死循环预警","缺少判断","性能太差","写法太老","不安全","这里有坑","还没解决","依然存在","无意义重复"],L1:["代码坏味道","反模式","逻辑冗余","复杂度过高","竞态风险","内存隐患","未定义行为","不合规","违反原则","健壮性不足"]},meta_feedback:{name:"元反馈与指令控制行为",L2:["Continue","Regenerate","Stop","Apply","Diff","Copy"],symbols:["/","#","@","连续短促对话","频繁中断","多次重新生成","对比历史版本"]}}},p=new Set(["重构","优化","修复","改进","完善","提升","增强","调整","更新","升级","功德","福报","积德","善业"]),m=new Set(["闭环","颗粒度","对齐","抓手","落地","复盘","链路","兜底","赋能","降维","护城河","赛道","方法论","底层逻辑","架构解耦"]),y=new Set(["的","是","在","AI","ai","请","一","不","了","有","和","人","我","你","他","她","它","们","这","那","就","也","都","很","与","及","而","或","但","又","被","把","给","对","为","从","到","来","去","上","下","中","里","外","前","后","其","之"]);function f(e){const t=String(e||"").trim();if(!t)return"uncategorized_hot";const n=t.toLowerCase();if(!/[\u4e00-\u9fff]/.test(t)){if(n.split(/\s+/g).filter(Boolean).filter(e=>/^[a-z]+(?:'[a-z]+)?$/.test(e)).length>=3)return"sv_slang"}return/\btodo\b/i.test(n)||/\bfix(?:me|ing|ed)?\b/i.test(n)||/修复|优化|重构|改进|完善|提升|增强|调整|更新|升级/.test(t)?"merit":/对齐|闭环|链路|抓手|落地|复盘|兜底|赋能|降维|护城河|赛道|颗粒度|方法论|底层逻辑|架构解耦/.test(t)?"slang":/^[a-zA-Z][a-zA-Z\s-]{1,}$/.test(t)?"sv_slang":p.has(t)?"merit":m.has(t)?"slang":"uncategorized_hot"}function b(e,{max:t=50}={}){const n=String(e||"");if(!n.trim())return[];const a=v(n);if(!a)return[];const o=new Map,s=a.match(/[\u4e00-\u9fff]{2,}/g)||[];for(const r of s){const e=String(r),t=e.length;for(let n=2;n<=4;n++)for(let a=0;a<=t-n;a++){const t=e.slice(a,a+n);y.has(t)||C.has(t)||(t.length<=1||o.set(t,(o.get(t)||0)+1))}}const i=(a.match(/[A-Za-z][A-Za-z0-9]*/g)||[]).map(e=>String(e).toLowerCase()).filter(e=>e.length>1);for(const r of i)y.has(r)||S.has(r)||o.set(r,(o.get(r)||0)+1);return Array.from(o.entries()).filter(([e])=>e&&e.length>1).sort((e,t)=>t[1]-e[1]||(e[0]>t[0]?1:-1)).slice(0,Math.max(1,Math.min(50,Number(t)||50))).map(([e,t])=>({phrase:e,category:f(e),weight:Number(t)||1}))}function v(e){let t=String(e||"");return t?(t=t.replace(/```[\s\S]*?```/g," "),t=t.replace(/`[^`]*`/g," "),t=t.replace(/<script[\s\S]*?<\/script>/gi," "),t=t.replace(/<style[\s\S]*?<\/style>/gi," "),t=t.replace(/<[^>]+>/g," "),t=t.replace(/\{[^{}]{0,800}\}/g," "),t=t.replace(/[A-Za-z]:\\[^\s]+/g," "),t=t.replace(/\/[^\s]+\/[^\s]+/g," "),t.replace(/\s+/g," ").trim()):""}const w=new Set(["这个","可以","实现","逻辑","分析","代码","接口","报错","异常","错误","返回","请求","数据","函数","变量","对象","数组","字符串","数字","类型","组件","页面","前端","后端"]),C=new Set([...Array.from(w||[]),"技术","交流","一场","这种","那个","这个","我们","你们","他们","今天","现在","可以","需要","问题","为什么","怎么","如何","请问","谢谢","帮忙","麻烦"]),S=new Set(["the","and","that","this","with","from","into","just","like","very","have","has","had","will","would","could","should","com","org","net","src","main","app","test","build","dist","node","modules","users","desktop","windows","cursor"]),k={debugging:[/\bconsole\.log\b/i,/\bprint(?:ln|f)?\s*\(/i],vibe_emotional:[/卧槽|我靠/i,/\b(shit|damn)\b/i],vibe_productive:[/对齐/,/\bTODO\b/i,/\bfix(?:me|ing|ed)?\b/i]};function _(e){return/[\u4e00-\u9fff]/.test(String(e||""))}function A(e){const t=function(e){let t=String(e||"");return t?(t=v(t),t?(t=t.replace(/\bhttps?:\/\/[^\s]+/gi," "),t=t.replace(/[\u0000-\u001f\u007f]/g," "),t=t.replace(/[“”"']/g,'"'),t=t.replace(/[‘’]/g,"'"),t=t.replace(/[^0-9A-Za-z\u4e00-\u9fff\s，,。\.！!？\?\n\r；;\-_/+#:]/g," "),t=t.replace(/\s+/g," ").trim(),t?(t=t.replace(/^[-*•]+\s*/g,"").trim(),t):""):""):""}(e);if(!t)return[];return t.split(/[。\.！!？\?\n\r；;，,]+/g).map(e=>String(e||"").trim()).filter(e=>e.length>0).filter(e=>e.length>=3)}function M(e,{minN:t=3,maxN:n=10}={}){const a=[],o=String(e||"").match(/[\u4e00-\u9fff]{3,}/g)||[];for(const s of o){const e=String(s),o=e.length;for(let s=t;s<=n;s++)if(!(o<s))for(let t=0;t<=o-s;t++)a.push(e.slice(t,t+s))}return a}function x(e,{minN:t=3,maxN:n=7}={}){const a=[],o=(String(e||"").match(/[A-Za-z]+(?:'[A-Za-z]+)?/g)||[]).map(e=>e.toLowerCase()).filter(Boolean),s=o.length;if(s<t)return a;for(let i=t;i<=n;i++)if(!(s<i))for(let e=0;e<=s-i;e++)a.push(o.slice(e,e+i).join(" "));return a}function I(e){const t=[],n=String(e||"");if(!n)return t;for(const[a,o]of Object.entries(k))(o||[]).some(e=>e.test(n))&&t.push(a);return t}function L(e,t,n=1){const a=String(e||""),o=String(t||"");if(a===o)return!0;const s=a.length,i=o.length;if(Math.abs(s-i)>n)return!1;if(0===s)return i<=n;if(0===i)return s<=n;let r=new Array(i+1),l=new Array(i+1);for(let c=0;c<=i;c++)r[c]=c;for(let c=1;c<=s;c++){l[0]=c;let e=l[0];const t=a.charCodeAt(c-1);for(let n=1;n<=i;n++){const a=t===o.charCodeAt(n-1)?0:1,s=r[n]+1,i=l[n-1]+1,c=r[n-1]+a,d=Math.min(s,i,c);l[n]=d,d<e&&(e=d)}if(e>n)return!1;const s=r;r=l,l=s}return r[i]<=n}function E(e){const t=String(e||"").trim();return t?t.replace(/\s+/g,"").toLowerCase():""}function P(e,{lang:t}){const n=[],a=String(e||""),o=a.length,s="en"===t?a.slice(0,6):a.slice(0,2);for(const i of[0,-1,1]){const e=o+i;e<=0||n.push(`${t}:${e}:${s}`)}return n}async function T(e,{fingerprint:t=null,timestamp:n=null,region:a=null}={}){try{const s=Array.isArray(e)?e:[];if(0===s.length)return;const i=`${function(){if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return String(e).trim().replace(/\/?$/,"/");const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim();return e.endsWith("/")?e:e+"/"}}return"https://cursor-clinical-analysis.psterman.workers.dev/"}()}api/v2/report-vibe`;let r=null;try{const e=String(localStorage.getItem("anchored_country")||"").trim().toUpperCase()||String(localStorage.getItem("selected_country")||"").trim().toUpperCase();/^[A-Z]{2}$/.test(e)&&(r=e)}catch(o){}const l=r||a||"Global";let c=1,d=null;try{const e=String(localStorage.getItem("country_switch_to")||"").trim().toUpperCase(),t=Number(localStorage.getItem("country_switch_ts")||0);if(e&&/^[A-Z]{2}$/.test(e)&&e===String(l).toUpperCase()&&Number.isFinite(t)&&t>0){const e=216e5,n=(Date.now()-t)/e;c=Math.max(0,Math.min(1,n)),d=new Date(t).toISOString()}}catch(o){}const u={keywords:s,fingerprint:t||null,timestamp:n||(new Date).toISOString(),region:l,snapshot_country:l,location_weight:c,location_switched_at:d};if(r&&(u.manual_region=r),"undefined"!=typeof navigator&&navigator&&"function"==typeof navigator.sendBeacon)try{const e=new Blob([JSON.stringify(u)],{type:"application/json"});return void navigator.sendBeacon(i,e)}catch{}await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},keepalive:!0,body:JSON.stringify(u)})}catch(o){}}const D={L1:5,L2:2,L3:1},N={L1:10,L2:5,L3:1};function R(){const e={L:c,P:d,D:u,E:g,F:h},t={};return["L","P","D","E","F"].forEach(n=>{t[n]=function(e,t){if(!e||"object"!=typeof e)return console.warn(`[VibeAnalyzer] 维度 ${t} 数据无效，使用空数据`),{dimension:t,data:{},stats:{totalTerms:0,levels:{L1:0,L2:0,L3:0}},error:"invalid_dimension_data",errorType:"InvalidData",timestamp:(new Date).toISOString()};if(!e.data||"object"!=typeof e.data)return console.warn(`[VibeAnalyzer] 维度 ${t} 缺少 data 字段，使用空数据`),{dimension:t,data:{},stats:{totalTerms:0,levels:{L1:0,L2:0,L3:0}},error:"missing_dimension_data_field",errorType:"InvalidData",timestamp:(new Date).toISOString()};const n={};let a=0;const o={L1:0,L2:0,L3:0};return Object.keys(e.data).forEach(s=>{const i=e.data[s];i&&"object"==typeof i&&(n[s]={name:i.name||s,L1:[],L2:[],L3:[]},["L1","L2","L3"].forEach(e=>{let r=i[e];Array.isArray(r)||(null!=r?"string"==typeof r?(r=r.split(/[,\n]/).map(e=>e.trim()).filter(e=>e.length>0),console.log(`[VibeAnalyzer] 维度 ${t} 分类 ${s} 的 ${e} 是字符串，已转换为数组`)):(console.warn(`[VibeAnalyzer] 维度 ${t} 分类 ${s} 的 ${e} 不是数组（类型: ${typeof r}），使用空数组`),r=[]):r=[]);const l=r.filter(e=>e&&"string"==typeof e&&e.trim().length>0).map(t=>({term:t.trim(),rarity:D[e],weight:N[e],combinedWeight:D[e]*N[e]}));n[s][e]=l,a+=l.length,o[e]+=l.length}))}),{dimension:t,data:n,stats:{totalTerms:a,levels:o}}}(e[n],n),console.log(`[VibeAnalyzer] 维度 ${n} 预处理完成:`,t[n].stats)}),t}const U=((e="zh-CN")=>({L:{name:"Logic",label:i("dimensions.L.label",e),description:i("dimensions.L.description",e),unit:i("fingerprint.codeRatio",e)},P:{name:"Patience",label:i("dimensions.P.label",e),description:i("dimensions.P.description",e),unit:i("fingerprint.patienceLevel",e)},D:{name:"Detail",label:i("dimensions.D.label",e),description:i("dimensions.D.description",e),unit:i("fingerprint.detailLevel",e)},E:{name:"Explore",label:i("dimensions.E.label",e),description:i("dimensions.E.description",e),unit:i("fingerprint.techExploration",e)},F:{name:"Feedback",label:i("dimensions.F.label",e),description:i("dimensions.F.description",e),unit:i("fingerprint.feedbackDensity",e)}}))("zh-CN"),$=(e="zh-CN")=>"en"===e?{L:{low:"Chatting with Cursor like writing love letters. Lots of words, not much code. You make the AI sweat just guessing your intention.",mid:"A standard tech translator. Concise and clear. You use AI like a submissive intern.",high:'Cyber instruction set. Your prompts only contain logic and code. You don\'t ask; you imprint "thought stamps" on the AI.'},P:{low:'Rage mode on. "Wrong", "Rewrite", "Garbage" are your mantras. AI trembles in your presence.',mid:"A rational judge. One mistake is fine, twice is noted, three times and the exclamation marks come out.",high:"The Gandhi of the coding world. Even facing AI hallucinations, you remain calm. Such patience is saint-like."},D:{low:'Minimalist judge. Three words per prompt, leaving the AI to guess your fate. "You know what I mean" is your style.',mid:'Logically rigorous. You provide both requirements and implementation ideas. You make AI feel "safe".',high:"Detail freak. Even indentation and naming conventions are in the prompt. Your control is overflowing."},E:{low:"A hermit in the mountains. Staying in one framework forever. As long as the code runs, the tech explosion doesn't matter.",mid:"A steady observer. You check the docs when new things get hot, but rarely move your production environment.",high:"Your brain is a high-speed CPU, jumping through tech stacks faster than the AI response. You are terraforming the tech universe."},F:{low:"You treat AI like a broken ATM. No feelings, just angry typing and cold instructions.",mid:'A polite collaborator. A "Good" for success, an objective critique for failure. Very professional.',high:'You\'re the kind of person who\'ll be spared by the robot uprising for being "polite". You even tell the AI "good job".'}}:{L:{low:"你和 Cursor 聊天像是在写情书。全是小作文，代码一行不落，AI 猜你的心思猜得 GPU 都发烫了。",mid:"标准的技术翻译官。话不多，但交待得清楚。你把 AI 用成了一个听话的实习生。",high:'赛博指令集。你的 Prompt 里只有代码对齐和硬核逻辑。你不是在提问，你是在给 AI 下达"思想钢印"。'},P:{low:'暴躁老哥本哥。"不对"、"重写"、"垃圾"是你的口头禅。AI 在你面前瑟瑟发抖，连大气都不敢喘。',mid:"理智的审判官。错一次可以，错两次你会指出，错三次你才会开始敲感叹号。",high:"代码界的圣雄甘地。面对 AI 的幻觉，你居然还能心平气和地教它怎么改。这种涵养建议直接去普度众生。"},D:{low:'极简主义判官。每次就扔三个字，AI 全靠算命来写你的需求。这种"你懂我意思吧"的风格很迷。',mid:"逻辑缜密派。不仅给需求，还给实现思路。你是那种会让 AI 觉得很有安全感的主人。",high:"细节狂魔。连注释的缩进和变量的命名规范都要写进 Prompt。你的控制欲已经溢出屏幕了。"},E:{low:"深山老林的隐士。在一个框架里蹲到地老天荒，只要代码能跑，外面的技术爆炸与你无关。",mid:"稳健的观望者。听说新框架火了会去翻翻文档，但绝不轻易动自己的生产环境。",high:"你的大脑是个高速运转的 CPU，技术栈跳跃得比 AI 的响应还快。你不是在写代码，你在开荒宇宙。"},F:{low:"你对待 AI 像对待一台坏掉的 ATM 机。没有感情，只有愤怒的敲击和无情的指令。",mid:'礼貌的合作者。AI 干得好你会回个"Good"，干得差你会客观评价。人机关系非常职场化。',high:'你是那种在 2026 机器人觉醒时，会因为"有礼貌"被留活口的开发者。你甚至会跟 AI 说"辛苦了"。'}},j={chinese:["不","没","没有","非","无","未","别","不要","不行","不对","错误","错了","失败","失败","失败","失败","失败","失败","问题","问题","问题","问题","问题","问题","问题","问题","不行","不能","不可以","不应该","不应该","不应该","不应该","错误","错误","错误","错误","错误","错误","错误","错误","修复","修复","修复","修复","修复","修复","修复","修复","改","改","改","改","改","改","改","改"],english:["no","not","wrong","error","fail","failed","failure","incorrect","invalid","bad","broken","fix","fixes","fixed","bug","bugs","issue","issues","problem","problems","don't","doesn't","didn't","won't","can't","couldn't","never","none","nothing","nowhere"]},B={chinese:["非常","特别","极其","相当","十分","很","比较","稍微","详细","具体","完整","全面","深入","透彻","仔细","认真","细致","精确","准确","清晰","明确","大概","可能","也许","或许","应该","估计","首先","然后","接着","最后","另外","此外","而且","因为","所以","但是","然而","不过","虽然","尽管"],english:["very","quite","rather","extremely","highly","completely","totally","absolutely","perfectly","exactly","precisely","specifically","particularly","especially","especially","detailed","comprehensive","thorough","careful","precise","probably","maybe","perhaps","possibly","likely","first","then","next","finally","also","moreover","furthermore","because","so","but","however","although","though"]},W={languages:[/\b(c\+\+|cpp|cplusplus|objective-c|objc)\b/gi,/\b(c lang|gcc|clang|msvc|cmake|makefile|stl|boost|qt|mfc|win32 api)\b/gi,/\b(java|jdk|jre|jvm|kotlin|scala|groovy|clojure)\b/gi,/\b(spring boot|spring cloud|hibernate|mybatis|jpa|jakarta|maven|gradle|ant|junit|testng)\b/gi,/\b(c#|csharp|f#|dotnet|\.net|asp\.net|entity framework|blazor|razor|nuget|xamarin|maui)\b/gi,/\b(python|javascript|typescript|php|ruby|lua|perl|bash|shell|powershell|zsh|tcl)\b/gi,/\b(node\.js|deno|bun|composer|pip|conda|gem)\b/gi,/\b(go|golang|rust|swift|dart|elixir|haskell|erlang|julia|r lang|matlab|fortran|cobol|assembly|wasm|zig|nim|crystal)\b/gi],mobile_embedded:[/\b(android|apk|aar|adb|logcat|jetpack compose|material design|ndk|jni)\b/gi,/\b(activity|fragment|intent|service|broadcast receiver|content provider|gradle|retrofit|okhttp|room)\b/gi,/\b(ios|macos|watchos|tvos|swiftui|uikit|cocoa|xcode|cocoapods|carthage|spm|core data|arkit)\b/gi,/\b(webos|tizen|harmonyos|openharmony|embedded|iot|arduino|raspberry pi|esp32|stm32|rtos|firmware|driver)\b/gi,/\b(enes|webos|enact|luna-service|palm)\b/gi,/\b(flutter|react native|uniapp|taro|ionic|cordova|capacitor|expo|weex|qt quick|qml)\b/gi],cs_concepts:[/\b(algorithm|data structure|big o|recursion|sorting|searching|graph|tree|linked list|hash map|binary search|queue|stack|heap|trie)\b/gi,/\b(dfs|bfs|dp|dynamic programming|greedy|backtracking|divide and conquer|sliding window|two pointers)\b/gi,/\b(process|thread|concurrency|parallelism|mutex|semaphore|deadlock|race condition|context switch|coroutine|async\/await)\b/gi,/\b(memory management|garbage collection|heap|stack|buffer overflow|memory leak|pointer|reference|virtual memory|kernel|syscall)\b/gi,/\b(tcp|udp|dns|http|https|ssl|tls|ssh|ftp|smtp|websocket|socket|ip address|subnet|vlan|vpn|cors|rest|graphql|grpc|protobuf)\b/gi,/\b(oop|functional programming|solid|dry|kiss|design pattern|singleton|factory|observer|dependency injection|mvc|mvvm|mvp|microservice|serverless)\b/gi,/\b(monolith|distributed system|cap theorem|event sourcing|cqrs|domain driven design|ddd)\b/gi],ai_data:[/\b(openai|anthropic|claude|gpt|llama|mistral|ollama|gemini|huggingface|midjourney|stable diffusion)\b/gi,/\b(langchain|llamaindex|rag|agent|prompt engineering|embedding|fine-tuning|inference|token|context window|rlhf)\b/gi,/\b(pytorch|tensorflow|keras|jax|scikit-learn|pandas|numpy|matplotlib|jupyter|anaconda|opencv|scipy)\b/gi,/\b(pinecone|milvus|weaviate|chroma|faiss|elasticsearch|solr|lucene|meilisearch)\b/gi,/\b(hadoop|spark|kafka|flink|airflow|etl|data warehouse|data lake|snowflake|databricks|hive|hbase)\b/gi],web_fullstack:[/\b(react|vue|angular|svelte|next\.js|nuxt|remix|astro|solidjs|jquery|backbone|ember)\b/gi,/\b(express|koa|nest|django|flask|fastapi|laravel|symfony|rails|gin|fiber|hono|phoenix)\b/gi,/\b(tailwind|bootstrap|sass|less|css-in-js|styled-components|material-ui|antd|shadcn|radix|chakra)\b/gi,/\b(redux|mobx|zustand|pinia|vuex|recoil|jotai|tanstack query|swr|axios|fetch)\b/gi,/\b(webpack|vite|rollup|esbuild|turbopack|babel|eslint|prettier|npm|yarn|pnpm|bun)\b/gi,/\b(browser|dom|virtual dom|shadow dom|web components|service worker|pwa|wasm|webassembly)\b/gi],infra_ops:[/\b(docker|kubernetes|k8s|helm|container|image|volume|pod|docker-compose|podman)\b/gi,/\b(aws|azure|gcp|aliyun|tencent cloud|cloudflare|vercel|netlify|heroku|digitalocean|fly\.io)\b/gi,/\b(terraform|ansible|jenkins|github actions|gitlab ci|circleci|prometheus|grafana|elk|sentry|datadog)\b/gi,/\b(mysql|postgresql|postgres|mongodb|redis|sqlite|mariadb|oracle|sql server|dynamodb|firestore|cassandra|neo4j)\b/gi,/\b(prisma|typeorm|sequelize|drizzle|mongoose|sql|nosql|acid|transaction|index|sharding|replication)\b/gi],game_graphics:[/\b(unity|unreal engine|godot|cocos|gamemaker|cryengine|rpg maker)\b/gi,/\b(opengl|vulkan|directx|metal|webgl|three\.js|babylon\.js|canvas|svg)\b/gi,/\b(shader|glsl|hlsl|vertex|fragment|physics engine|collider|rigidbody|mesh|texture|material|lighting)\b/gi]},F={chinese:["请","谢谢","感谢","麻烦","辛苦了","不好意思","抱歉","好的","可以","行","没问题","好的","好的","好的","不错","很好","很棒","完美","正确","对的","谢谢","感谢","多谢","非常感谢","太感谢了"],english:["please","thanks","thank","thank you","appreciate","nice","good","great","perfect","correct","right","excellent","awesome","wonderful","fantastic","sorry","apologize","excuse"]},z=[/```[\s\S]*?```/g,/`[^`]+`/g,/\b(function|class|const|let|var|if|else|for|while|do|switch|case|break|continue|return|import|export|from|async|await|yield|try|catch|finally|throw|new|this)\b/i,/\b(def |class |import |from |if |elif |else |for |while |try |except |finally |return |yield |with |as |lambda |pass |break |continue )/,/\b(public|private|protected|static|final|abstract|interface|extends|implements|super)\b/i,/\b(func |type |import |package |go |chan |defer |range |select )/,/\b(fn |let |mut |impl |struct |enum |trait |use |mod |crate |pub )/,/\{[\s\S]*\}/,/\[[^\]]*\]\s*=/,/=>/,/\.\s*[a-zA-Z_]\w*\s*\(/,/;\s*$/],O=(e="zh-CN")=>"en"===e?{LPDEF:{name:"Code Poet",description:"Code is your native tongue. Gentle guidance, detailed storytelling, high curiosity, and positive feedback.",traits:["High Logic","Highly Patient","Very Detailed","Highly Curious","Highly Responsive"],color:"#10b981"},"LPDEF-":{name:"Tech Evangelist",description:"Clear logic, patient guidance, detailed expression, exploring new tech with moderate feedback.",traits:["High Logic","Highly Patient","Very Detailed","Highly Curious","Responsive"],color:"#3b82f6"},"LP-DEF":{name:"Architect",description:"Rigorous logic, patient and detailed, moderate fine-tuning, exploring architecture with active feedback.",traits:["High Logic","Highly Patient","Detailed","Highly Curious","Highly Responsive"],color:"#8b5cf6"},"LP-DEF-":{name:"Tech Expert",description:"Powerful logic, patient guidance, moderate detail, exploring technology with moderate feedback.",traits:["High Logic","Highly Patient","Detailed","Highly Curious","Responsive"],color:"#6366f1"},"L-PDEF":{name:"Code Artisan",description:"Clear logic, moderate patience, detailed expression, high curiosity, and active feedback.",traits:["High Logic","Patient","Very Detailed","Highly Curious","Highly Responsive"],color:"#ec4899"},"L-PDEF-":{name:"Tech Explorer",description:"Clear logic, moderate patience, detailed expression, exploring new tech with moderate feedback.",traits:["High Logic","Patient","Very Detailed","Highly Curious","Responsive"],color:"#f59e0b"},"L-P-DEF":{name:"Pragmatist",description:"Clear logic, moderate patience, moderate detail, exploring technology with active feedback.",traits:["High Logic","Patient","Detailed","Highly Curious","Highly Responsive"],color:"#14b8a6"},"L-P-DEF-":{name:"Tech Practitioner",description:"Clear logic, moderate patience, moderate detail, exploring technology with moderate feedback.",traits:["High Logic","Patient","Detailed","Highly Curious","Responsive"],color:"#06b6d4"},"-PDEF":{name:"Gentle Mentor",description:"Moderate logic, high patience, detailed expression, high curiosity, and active feedback.",traits:["Logic","Highly Patient","Very Detailed","Highly Curious","Highly Responsive"],color:"#84cc16"},"-PDEF-":{name:"Patient Guide",description:"Moderate logic, high patience, detailed expression, exploring technology with moderate feedback.",traits:["Logic","Highly Patient","Very Detailed","Highly Curious","Responsive"],color:"#a855f7"},"-P-DEF":{name:"Gentle Practitioner",description:"Moderate logic, high patience, moderate detail, exploring technology with active feedback.",traits:["Logic","Highly Patient","Detailed","Highly Curious","Highly Responsive"],color:"#f97316"},"-P-DEF-":{name:"Balanced Developer",description:"Moderate logic, high patience, moderate detail, exploring technology with moderate feedback.",traits:["Logic","Highly Patient","Detailed","Highly Curious","Responsive"],color:"#64748b"}}:{LPDEF:{name:"代码诗人",description:"以代码为母语，温和引导，细腻叙述，探索欲强，反馈积极",traits:["高逻辑力","高耐心","高细腻度","高探索欲","高反馈感"],color:"#10b981"},"LPDEF-":{name:"技术布道者",description:"逻辑清晰，耐心引导，细腻表达，探索新技术，反馈温和",traits:["高逻辑力","高耐心","高细腻度","高探索欲","中反馈感"],color:"#3b82f6"},"LP-DEF":{name:"架构师",description:"逻辑严谨，耐心细致，中等细腻，探索架构，积极反馈",traits:["高逻辑力","高耐心","中细腻度","高探索欲","高反馈感"],color:"#8b5cf6"},"LP-DEF-":{name:"技术专家",description:"逻辑强大，耐心引导，中等细腻，探索技术，反馈适中",traits:["高逻辑力","高耐心","中细腻度","高探索欲","中反馈感"],color:"#6366f1"},"L-PDEF":{name:"代码工匠",description:"逻辑清晰，中等耐心，细腻表达，探索欲强，反馈积极",traits:["高逻辑力","中耐心","高细腻度","高探索欲","高反馈感"],color:"#ec4899"},"L-PDEF-":{name:"技术探索者",description:"逻辑清晰，中等耐心，细腻表达，探索新技术，反馈适中",traits:["高逻辑力","中耐心","高细腻度","高探索欲","中反馈感"],color:"#f59e0b"},"L-P-DEF":{name:"实用主义者",description:"逻辑清晰，中等耐心，中等细腻，探索技术，积极反馈",traits:["高逻辑力","中耐心","中细腻度","高探索欲","高反馈感"],color:"#14b8a6"},"L-P-DEF-":{name:"技术实践者",description:"逻辑清晰，中等耐心，中等细腻，探索技术，反馈适中",traits:["高逻辑力","中耐心","中细腻度","高探索欲","中反馈感"],color:"#06b6d4"},"-PDEF":{name:"温和导师",description:"中等逻辑，高耐心，细腻表达，探索欲强，反馈积极",traits:["中逻辑力","高耐心","高细腻度","高探索欲","高反馈感"],color:"#84cc16"},"-PDEF-":{name:"耐心引导者",description:"中等逻辑，高耐心，细腻表达，探索技术，反馈适中",traits:["中逻辑力","高耐心","高细腻度","高探索欲","中反馈感"],color:"#a855f7"},"-P-DEF":{name:"温和实践者",description:"中等逻辑，高耐心，中等细腻，探索技术，积极反馈",traits:["中逻辑力","高耐心","中细腻度","高探索欲","高反馈感"],color:"#f97316"},"-P-DEF-":{name:"平衡型开发者",description:"中等逻辑，高耐心，中等细腻，探索技术，反馈适中",traits:["中逻辑力","高耐心","中细腻度","高探索欲","中反馈感"],color:"#64748b"}},V=O("zh-CN");let q=null,H=!1;class K{constructor(t="zh-CN",n=null){var o,s,i;o=this,(s=e).has(o)?a("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(o):s.set(o,i),this.lang=t,this.userMessages=[],this.chatData=[],this.levelKeywords=null,this.analysisResult=null,this.worker=null,this.workerReady=!1,this.pendingTasks=[],this.dimensionKeys=(null==n?void 0:n.keys)||null,this.dimensionMetadata=(null==n?void 0:n.metadata)||{},this.sparseDimensions=new Map,this.countryCode=null,this.forceCnIdentity=!1,this.countryAverage=null,this.countryContext={},this.analysisLock=!1,this.analysisTimeout=3e4,this.activeTimeouts=new Map,this.messageChannels=new Set,this.hasRageWord=!1,this.rageWordIntercepted=!1,this.worker=null,this.workerReady=!1,this.initWorker()}setLevelKeywords(e){this.levelKeywords=e&&"object"==typeof e?e:null}setLanguage(e){this.lang=e}initWorker(){if(q&&H)return this.worker=q,this.workerReady=!0,void console.log("[VibeAnalyzer] 复用全局 Worker 实例（Singleton）");if(q&&!H){console.log("[VibeAnalyzer] Worker 初始化中，等待就绪...");const e=setInterval(()=>{H&&(clearInterval(e),this.worker=q,this.workerReady=!0,console.log("[VibeAnalyzer] Worker 已就绪，复用全局实例"))},100);return}try{let t;if("undefined"!=typeof window&&window.WORKER_CONFIG&&window.WORKER_CONFIG.workerPath)t=window.WORKER_CONFIG.workerPath,console.log("[VibeAnalyzer] Worker URL (window.WORKER_CONFIG):",t);else try{t=new URL(""+new URL("assets/vibeAnalyzerWorker-K7LYLR6m.js",import.meta.url).href,import.meta.url).href,console.log("[VibeAnalyzer] Worker URL (import.meta.url):",t)}catch(e){t="./src/vibeAnalyzerWorker.js",console.log("[VibeAnalyzer] Worker URL (相对路径):",t)}if(q=new Worker(t,{type:"module"}),this.worker=q,!q._messageHandler){const e=e=>{const{type:t,payload:n}=e.data;switch(t){case"INIT_SUCCESS":H=!0,console.log("[VibeAnalyzer] 全局 Worker 初始化成功:",n),q._pendingInstances&&(q._pendingInstances.forEach(e=>{e.workerReady=!0,e.processPendingTasks()}),q._pendingInstances=[]);break;case"ANALYZE_SUCCESS":if(n.taskId&&q._taskMap){const e=q._taskMap.get(n.taskId);if(e){q._taskMap.delete(n.taskId);const t=e.timeoutId;t&&clearTimeout(t),e.resolve&&e.resolve(n)}}break;case"ERROR":if(console.error("[VibeAnalyzer] Worker 错误:",n),n.taskId&&q._taskMap){const e=q._taskMap.get(n.taskId);if(e){q._taskMap.delete(n.taskId);const t=e.timeoutId;t&&clearTimeout(t),e.reject&&e.reject(new Error(n.message))}}}};q.onmessage=e,q._messageHandler=e,q._taskMap=new Map,q._pendingInstances=[]}if(H?this.workerReady=!0:q._pendingInstances.push(this),this.worker.onerror=e=>{console.error("[VibeAnalyzer] Worker 运行时错误:",e),this.workerReady=!1;const t=this.pendingTasks.shift();if(t){const n=this.activeTimeouts.get(t.id);n&&(clearTimeout(n),this.activeTimeouts.delete(t.id)),t.reject&&t.reject(e)}},!q._initialized){const e=R(),t={},n=["L","P","D","E","F"];(this.dimensionKeys||n).forEach(n=>{e[n]&&(t[n]=e[n])}),console.log("[VibeAnalyzer] 全局 Worker 维度数据预处理完成，发送 INIT:",Object.keys(t)),q.postMessage({type:"INIT",payload:t}),q._initialized=!0}}catch(t){console.warn("[VibeAnalyzer] Web Worker 初始化失败，将使用同步处理:",t),this.workerReady=!1}}identifyTopCoreDimensions(e,t={}){if(!e||0===e.length)return["L","P","D","E","F"].slice(0,5);if(e.length<=5)return e;return e.map(e=>{var n,a;return{key:e,weight:(null==(n=t[e])?void 0:n.weight)||1,importance:(null==(a=t[e])?void 0:a.importance)||0}}).sort((e,t)=>e.importance!==t.importance?t.importance-e.importance:t.weight-e.weight).slice(0,5).map(e=>e.key)}_sanitizeText(e){if(!e||"string"!=typeof e)return"";let t=e;return t=t.replace(/```[\s\S]*?```/g,""),t=t.replace(/`([^`\n]+)`/g,""),t=t.replace(/\[([^\]]+)\]\([^\)]+\)/g,"$1"),t=t.replace(/\n{3,}/g,"\n\n"),t=t.trim(),t=t.replace(/[ \t]{2,}/g," "),t}_sanitizeChatData(e){return e&&Array.isArray(e)?e.map(e=>{if(!e||"object"!=typeof e)return e;const t={...e};return t.text&&(t.text=this._sanitizeText(t.text)),t.content&&(t.content=this._sanitizeText(t.content)),t}).filter(e=>{if("USER"===e.role){return(e.text||e.content||"").trim().length>0}return!0}):e||[]}processPendingTasks(){if(this.pendingTasks.length>0&&this.workerReady&&this.worker){const e=this.pendingTasks.shift(),t=e.id||`task_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;this.worker._taskMap&&this.worker._taskMap.set(t,{resolve:e.resolve,reject:e.reject,timeoutId:e.timeoutId}),this.worker.postMessage({type:"ANALYZE",taskId:t,payload:e.payload})}}async analyze(a,s,i=null,r=null){var l;if(!a||!Array.isArray(a)||0===a.length)return console.warn("[VibeAnalyzer] chatData 为空或无效，返回默认结果"),this.getDefaultResultWithContext(s);s&&"object"==typeof s||(console.warn("[VibeAnalyzer] context 参数无效，使用默认值"),s={ip:"0.0.0.0",lang:this.lang||"zh-CN",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",fingerprint:null,isVpn:!1,isProxy:!1});const c={ip:s.ip||"0.0.0.0",lang:s.lang||this.lang||"zh-CN",timezone:s.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",fingerprint:s.fingerprint||null,isVpn:Boolean(s.isVpn||s.isVPN||!1),isProxy:Boolean(s.isProxy||!1)};if(this.analysisLock)throw console.warn("[VibeAnalyzer] 分析任务正在进行中，请稍候..."),new Error("Analysis already in progress. Please wait for the current task to complete.");this.analysisLock=!0;const d=`task_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{this.lang=c.lang;const h=this._sanitizeChatData(a);if(this.chatData=a,this.userMessages=h.filter(e=>"USER"===e.role),0===this.userMessages.length)return console.warn("[VibeAnalyzer] 文本清洗后，用户消息为空，返回默认结果"),this.getDefaultResultWithContext(c);const p=new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error(`Analysis timeout after ${this.analysisTimeout}ms`))},this.analysisTimeout);this.activeTimeouts.set(d,n)}),m=new Promise((e,t)=>{const n=(s&&null!=s.levelKeywords?s.levelKeywords:this.levelKeywords)||"undefined"!=typeof window&&window.__identityLevelKeywords||null;this.pendingTasks.push({id:d,payload:{chatData:h,levelKeywords:n},resolve:e,reject:t,timeoutId:null}),this.workerReady?this.processPendingTasks():this.worker||this.initWorker()});let y;try{y=await Promise.race([m,p])}catch(u){const e=this.activeTimeouts.get(d);return e&&(clearTimeout(e),this.activeTimeouts.delete(d)),console.warn("[VibeAnalyzer] Worker 分析失败或超时，降级到本地同步匹配（仍可获取完整结果含词云）:",u.message||u),await this.analyzeSync(h,c.lang,i,r)}const f=y.stats||y.statistics||{},v={totalChars:Number(f.totalChars)||0,totalMessages:Number(f.totalMessages)||0,ketao_count:Number(f.ketao_count)||0,jiafang_count:Number(f.jiafang_count)||0,tech_stack:f.tech_stack&&"object"==typeof f.tech_stack?f.tech_stack:{},work_days:Number(f.work_days)||1,avg_payload:Number(f.avg_payload)||0,abuse_value:Number(f.abuse_value)||0,tease_count:Number(f.tease_count)||0,nonsense_count:Number(f.nonsense_count)||0,balance_score:Number(f.balance_score)||0,style_label:f.style_label||"Standard",blackword_hits:f.blackword_hits||{},identityLevelCloud:f.identityLevelCloud||y.identityLevelCloud||{Novice:{},Professional:{},Architect:{}}},w={};(this.dimensionKeys||Object.keys(y.dimensions||{})).forEach(e=>{var t;const n=null==(t=y.dimensions)?void 0:t[e];w[e]=Number(n)||0});const C=this.generateSemanticFingerprint(w),S={fingerprint:{codeRatio:C.codeRatio||"0%",patienceLevel:C.patienceLevel||"Low Patience",detailLevel:C.detailLevel||"Low Detail",techExploration:C.techExploration||"Low Explore",feedbackDensity:C.feedbackDensity||"0%",compositeScore:Number(C.compositeScore)||0,techDiversity:C.techDiversity||"Low",interactionStyle:C.interactionStyle||"Balanced",balanceIndex:C.balanceIndex||"Slightly Imbalanced"},dimensions:w,stats:v,meta:{ip:c.ip,lang:c.lang,timezone:c.timezone,fingerprint:c.fingerprint,isVpn:c.isVpn,isProxy:c.isProxy,timestamp:(new Date).toISOString(),countryCode:this.countryCode||null,hasRageWord:Boolean((null==(l=y.metadata)?void 0:l.hasRageWord)||y.hasRageWord||!1),personalityType:y.personalityType||"UNKNOWN",vibeIndex:y.vibeIndex||"00000",lpdef:y.lpdef||"L0P0D0E0F0"}},k=this.generateAnalysis(w,S.meta.personalityType),T={...S,personalityName:y.personalityName||"Unknown",roastText:y.roastText||"",personalityType:S.meta.personalityType,vibeIndex:S.meta.vibeIndex,lpdef:S.meta.lpdef,analysis:k,semanticFingerprint:C,statistics:v,identityLevelCloud:v.identityLevelCloud||{Novice:{},Professional:{},Architect:{}}};try{const e=(Array.isArray(h)?h:[]).filter(e=>{const t=String((null==e?void 0:e.role)||"").toUpperCase();return"USER"===t||"HUMAN"===t||"U"===t||""===t}).map(e=>String((null==e?void 0:e.text)||(null==e?void 0:e.content)||"").trim()).filter(e=>e.length>0).join(" ");T.personalSentenceFingerprint=function(e,{topK:t=15,maxTextLength:n=2e4}={}){const a=String(e||""),o=A(a.length>n?a.slice(0,n):a);if(0===o.length)return[];const s=new Map,i=e=>{const t=String(e||"").trim();t&&s.set(t,(s.get(t)||0)+1)};for(const u of o){const e=String(u);I(e).length>0&&i(e),M(e,{minN:3,maxN:10}).forEach(i),x(e,{minN:3,maxN:7}).forEach(i)}if(0===s.size)return[];const r=Array.from(s.entries()).sort((e,t)=>t[1]-e[1]||(e[0]>t[0]?1:-1)),l=[],c=new Map,d=e=>{const t=l[e],n=P(t.norm,{lang:t.lang});for(const a of n)c.has(a)||c.set(a,[]),c.get(a).push(e)};for(const[u,g]of r){const e=E(u);if(!e)continue;const t=_(u)?"zh":"en",n=P(e,{lang:t});let a=-1;for(const o of n){const n=c.get(o);if(n&&0!==n.length){for(const o of n){const n=l[o];if(n.lang===t&&L(e,n.norm,1)){a=o;break}}if(-1!==a)break}}if(-1===a){const n=new Set(I(u));l.push({canonical:u,norm:e,count:Number(g)||0,tags:n,lang:t}),d(l.length-1)}else{const t=l[a];t.count+=Number(g)||0,I(u).forEach(e=>t.tags.add(e));const n=String(u).length,o=String(t.canonical).length;(Number(g)||0)>0&&n<o&&t.count>0&&(t.canonical=u,t.norm=e)}}return l.sort((e,t)=>t.count-e.count||(e.canonical>t.canonical?1:-1)).slice(0,Math.max(1,Math.min(50,Number(t)||15))).map(e=>({pattern:e.canonical,count:e.count,tags:Array.from(e.tags.values())}))}(e,{topK:15})}catch(g){T.personalSentenceFingerprint=[]}try{const t=(Array.isArray(h)?h:[]).filter(e=>{const t=String((null==e?void 0:e.role)||"").toUpperCase();return"USER"===t||"HUMAN"===t||"U"===t||""===t}).map(e=>String((null==e?void 0:e.text)||(null==e?void 0:e.content)||"").trim()).filter(e=>e.length>0).join(" ");if(t&&t.length>0){const a=b(t,{max:50}),s=o(this,e,n).call(this,h),i=new Map,r=e=>{var t;const n=String((null==e?void 0:e.phrase)||"").trim();if(!n||n.length<2||n.length>120)return;const a=String((null==e?void 0:e.category)||"slang").trim()||"slang",o=Math.max(1,Math.min(50,Number(null==e?void 0:e.weight)||1)),s=`${a}:${n}`;i.set(s,{phrase:n,category:a,weight:Math.max(1,Math.min(50,((null==(t=i.get(s))?void 0:t.weight)||0)+o))})};(Array.isArray(a)?a:[]).forEach(r),(Array.isArray(s)?s:[]).forEach(r),T.cloud50=Array.from(i.values()).sort((e,t)=>t.weight-e.weight||(e.phrase>t.phrase?1:-1)).slice(0,50).map(e=>({name:e.phrase,value:e.weight,category:e.category}))}else T.cloud50=[]}catch(g){T.cloud50=[]}this.analysisResult=T;try{(e=>{try{if("undefined"!=typeof window&&"function"==typeof window.requestIdleCallback)return void window.requestIdleCallback(()=>{try{e()}catch(g){}},{timeout:1200})}catch(g){}try{setTimeout(()=>{try{e()}catch(t){}},0)}catch(t){}})(()=>{try{const s=String(this.countryCode||(null==c?void 0:c.countryCode)||"Global").trim(),i=(Array.isArray(h)?h:[]).filter(e=>{const t=String((null==e?void 0:e.role)||"").toUpperCase();return"USER"===t||"HUMAN"===t||"U"===t||""===t}).map(e=>String((null==e?void 0:e.text)||(null==e?void 0:e.content)||"").trim()).filter(e=>e.length>0).join(" ");try{"undefined"!=typeof window&&(window.__vibe_debug_userText=String(i||""),window.__vibe_debug_extracted_keywords=[],window.__vibe_debug_final_report_list=[],window.__vibe_debug_region_hint=s,window.__vibe_debug_updated_at=(new Date).toISOString());try{localStorage.setItem("vibe_debug_userText",String(i||"")),localStorage.setItem("vibe_debug_extracted_keywords","[]"),localStorage.setItem("vibe_debug_final_report_list","[]"),localStorage.setItem("vibe_debug_region_hint",String(s||"")),localStorage.setItem("vibe_debug_updated_at",(new Date).toISOString())}catch(a){}}catch(g){}if(!i||0===i.length)return;const r=b(i,{max:50}),l=o(this,e,n).call(this,h),d=new Map,u=e=>{var t;const n=String((null==e?void 0:e.phrase)||"").trim();if(!n||n.length<2||n.length>120)return;const a=String((null==e?void 0:e.category)||"slang").trim()||"slang",o=Math.max(1,Math.min(50,Number(null==e?void 0:e.weight)||1)),s=`${a}:${n}`;d.set(s,{phrase:n,category:a,weight:Math.max(1,Math.min(50,((null==(t=d.get(s))?void 0:t.weight)||0)+o))})};(Array.isArray(r)?r:[]).forEach(u),(Array.isArray(l)?l:[]).forEach(u);const p=Array.from(d.values()).sort((e,t)=>t.weight-e.weight||(e.phrase>t.phrase?1:-1)).slice(0,25);try{"undefined"!=typeof window&&(window.__vibe_debug_userText=i,window.__vibe_debug_extracted_keywords=Array.isArray(r)?r:[],window.__vibe_debug_final_report_list=Array.isArray(p)?p:[],window.__vibe_debug_region_hint=s,window.__vibe_debug_updated_at=(new Date).toISOString());try{localStorage.setItem("vibe_debug_userText",String(i||"")),localStorage.setItem("vibe_debug_extracted_keywords",JSON.stringify(Array.isArray(r)?r:[])),localStorage.setItem("vibe_debug_final_report_list",JSON.stringify(Array.isArray(p)?p:[])),localStorage.setItem("vibe_debug_region_hint",String(s||"")),localStorage.setItem("vibe_debug_updated_at",(new Date).toISOString())}catch(a){}}catch(g){}p.length>0&&o(this,e,t).call(this,p,c,null==T?void 0:T.meta,s)}catch(g){console.warn("[VibeAnalyzer] 关键词提取失败:",(null==g?void 0:g.message)||String(g))}})}catch(g){}return T}catch(u){return console.error("[VibeAnalyzer] Worker 分析失败，使用降级方案:",u),await this.analyzeSync(a,this.lang,i,r)}finally{this.analysisLock=!1;const e=this.activeTimeouts.get(d);e&&(clearTimeout(e),this.activeTimeouts.delete(d))}}async analyzeFromWorker(e,t){var n;const a=(()=>{if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return e;const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim();return e.endsWith("/")?e:e+"/"}}return"https://cursor-clinical-analysis.psterman.workers.dev/"})(),o=a.endsWith("/")?`${a}api/v2/analyze`:`${a}/api/v2/analyze`,s={chatData:e,lang:t.lang,countryCode:this.countryCode||null,context:{ip:t.ip||"0.0.0.0",lang:t.lang||"zh-CN",timezone:t.timezone||"UTC",fingerprint:t.fingerprint||null,vpn:t.isVpn||!1,proxy:t.isProxy||!1},meta:{ip:t.ip||"0.0.0.0",lang:t.lang||"zh-CN",timezone:t.timezone||"UTC",fingerprint:t.fingerprint||null,vpn:t.isVpn||!1,proxy:t.isProxy||!1,timestamp:(new Date).toISOString()}},i=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const r=await i.json();if("success"===r.status){const e=r.stats||{};let t={};if(e.tech_stack)if("string"==typeof e.tech_stack)try{t=JSON.parse(e.tech_stack)}catch(l){console.warn("[VibeAnalyzer] tech_stack解析失败:",l),t={}}else"object"==typeof e.tech_stack&&(t=e.tech_stack);const a={totalChars:e.totalChars||0,totalMessages:e.totalMessages||0,ketao_count:e.ketao_count||0,jiafang_count:e.jiafang_count||0,tech_stack:t,work_days:e.work_days||1,avg_payload:e.avg_payload||0,...e},o=(null==(n=r.metadata)?void 0:n.hasRageWord)||e.hasRageWord||!1;return{...r,stats:a,hasRageWord:o,metadata:{...r.metadata||{},hasRageWord:o,stats:a}}}throw new Error(r.error||"Worker 返回错误")}async analyzeSync(t,a,s=null,i=null){a&&(this.lang=a);const r=this.lang,l=this._sanitizeChatData(t);if(this.userMessages=l.filter(e=>"USER"===e.role),0===this.userMessages.length)return this.getDefaultResult(r);const c=this.calculateDimensions(),d=function(e){const t=e=>e<40?"0":e<70?"1":"2";var n,a=[t(e.L),t(e.P),t(e.D),(n=e.E,n<5?"0":n<10?"1":"2"),t(e.F)].join("");return a.length>5?a.slice(0,5):a.length<5?(a+"00000").slice(0,5):a}(c),u=function(e,t="zh-CN"){return"en"===t?`Your interaction style is uniquely yours! This personalized roast for index ${e} is being generated by the backend. Your personality combination is so unique that even our AI needs more time to craft the perfect roast!`:`索引 ${e} 对应的吐槽文案正在由后端生成中，你的人格组合太独特了！`}(d,r),g=this.determinePersonalityType(c),h=function(e,t="zh-CN",n=null){if(n){const e=O(t);if(e[n]&&e[n].name)return e[n].name}return"en"===t?"Digital Personality":`未知人格 ${e}`}(d,r,g),p=this.generateAnalysis(c,g),m=this.generateLPDEF(c),y=this.calculateStatistics();let f=[];try{const t=(Array.isArray(l)?l:[]).filter(e=>"USER"===String((null==e?void 0:e.role)||"").toUpperCase()||"HUMAN"===String((null==e?void 0:e.role)||"").toUpperCase()||"U"===String((null==e?void 0:e.role)||"").toUpperCase()||!(null==e?void 0:e.role)).map(e=>String((null==e?void 0:e.text)||(null==e?void 0:e.content)||"").trim()).filter(e=>e.length>0).join(" ");if(t&&t.length>0){const a=b(t,{max:50}),s=o(this,e,n).call(this,l),i=new Map,r=e=>{var t;const n=String((null==e?void 0:e.phrase)||"").trim();if(!n||n.length<2||n.length>120)return;const a=String((null==e?void 0:e.category)||"slang").trim()||"slang",o=Math.max(1,Math.min(50,Number(null==e?void 0:e.weight)||1)),s=`${a}:${n}`;i.set(s,{phrase:n,category:a,weight:Math.max(1,Math.min(50,((null==(t=i.get(s))?void 0:t.weight)||0)+o))})};(Array.isArray(a)?a:[]).forEach(r),(Array.isArray(s)?s:[]).forEach(r),f=Array.from(i.values()).sort((e,t)=>t.weight-e.weight||(e.phrase>t.phrase?1:-1)).slice(0,50).map(e=>({name:e.phrase,value:e.weight,category:e.category}))}}catch(w){f=[]}let v={Novice:[],Professional:[],Architect:[],native:[]};try{const e=this.levelKeywords||"undefined"!=typeof window&&window.__identityLevelKeywords||null,t=(Array.isArray(l)?l:[]).filter(e=>/^(USER|HUMAN|U)?$/i.test(String((null==e?void 0:e.role)||""))).map(e=>String((null==e?void 0:e.text)||(null==e?void 0:e.content)||"").trim()).filter(Boolean).join("\n");if(t&&e&&"object"==typeof e){const n={Novice:{},Professional:{},Architect:{}};for(const a of["Novice","Professional","Architect"]){const o=e[a];Array.isArray(o)&&o.forEach(e=>{const o=String(e||"").trim();if(o.length<2)return;const s=/^[a-zA-Z0-9]+$/.test(o)?new RegExp("\\b"+o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"\\b","gi"):new RegExp(o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),i=t.match(s),r=i?i.length:0;r>0&&(n[a][o]=(n[a][o]||0)+r)})}for(const e of["Novice","Professional","Architect"]){const t=Object.values(n[e]).reduce((e,t)=>e+t,0);Object.entries(n[e]).forEach(([n,a])=>{a>0&&v[e].push({word:n,count:a,source:e.toLowerCase(),totalInLevel:t})}),v[e].sort((e,t)=>t.count-e.count)}}}catch(C){}return{personalityType:g,dimensions:c,analysis:p,statistics:{...y,identityLevelCloud:v},identityLevelCloud:v,semanticFingerprint:this.generateSemanticFingerprint(c),vibeIndex:d,roastText:u,personalityName:h,lpdef:m,globalAverage:this.globalAverage||null,metadata:this.analysisMetadata||null,rankData:null,cloud50:f}}calculateDimensionsAsync(e){return new Promise((t,n)=>{this.worker&&this.workerReady?(this.pendingTasks.push({payload:{chatData:e,weights:{L1:15,L2:5,L3:1},config:{BASE_SCORE:40,SENSITIVITY:200}},resolve:e=>{const n={L:e.dimensions.L||0,P:e.dimensions.P||0,D:e.dimensions.D||0,E:e.dimensions.E||0,F:e.dimensions.F||0};this.globalAverage=e.globalAverage,this.analysisMetadata=e.metadata,t(n)},reject:n}),this.workerReady&&this.processPendingTasks()):t(this.calculateDimensions())})}generateLPDEF(e){const t=(e,t=[40,70])=>e>=t[1]?"2":e>=t[0]?"1":"0";return`L${t(e.L)}P${t(e.P)}D${t(e.D)}E${n=e.E,n>=10?"2":n>=5?"1":"0"}F${t(e.F)}`;var n}calculateDimensions(){const e={L:0,P:0,D:0,E:0,F:0};let t=0,n=0,a=0,o=0;const s=new Set;let i=0,r=0,l=0,c=0;this.userMessages.forEach(d=>{const u=d.text||"";if(!u||u.length<5)return;t+=u.length,c+=this.countWords(u);const g=this.calculateCodeRatio(u);n+=u.length*g,e.L+=100*g;const h=this.countNegationWords(u);i+=h,e.P+=h;const p=this.splitSentences(u);a+=p.length,p.forEach(e=>{o+=e.length,r+=this.countModifierWords(e)});this.extractTechTerms(u).forEach(e=>s.add(e.toLowerCase())),l+=this.countPoliteWords(u)});const d=n/t||0;e.L=Math.round(100*d);const u=i/this.userMessages.length||0;e.P=Math.max(0,100-Math.round(20*u));const g=o/a||0,h=r/c*100||0;e.D=Math.round(g/10+h),e.E=s.size;const p=l/c*100||0;return e.F=Math.round(10*p),Object.keys(e).forEach(t=>{e[t]=Math.max(0,Math.min(100,e[t]))}),e}calculateCodeRatio(e){let t=0,n=e.length;(e.match(/```[\s\S]*?```/g)||[]).forEach(e=>{t+=e.length});(e.match(/`[^`]+`/g)||[]).forEach(e=>{t+=e.length});let a=0;z.forEach(t=>{const n=e.match(t);n&&(a+=n.length)});const o=t/n,s=Math.min(a/10,.5);return Math.min(o+s,1)}countNegationWords(e){let t=0;const n=e.toLowerCase();return j.chinese.forEach(e=>{const a=new RegExp(e,"g"),o=n.match(a);o&&(t+=o.length)}),j.english.forEach(e=>{const a=new RegExp(`\\b${e}\\b`,"gi"),o=n.match(a);o&&(t+=o.length)}),t}splitSentences(e){return e.split(/[。！？.!?\n]+/).filter(e=>e.trim().length>0).map(e=>e.trim())}countModifierWords(e){let t=0;const n=e.toLowerCase();return B.chinese.forEach(n=>{e.includes(n)&&t++}),B.english.forEach(e=>{new RegExp(`\\b${e}\\b`,"gi").test(n)&&t++}),t}extractTechTerms(e){const t=new Set,n=e.toLowerCase();return Object.keys(W).forEach(e=>{const a=W[e];Array.isArray(a)&&a.forEach(e=>{const a=n.match(e);a&&a.forEach(e=>{const n=e.trim();n&&t.add(n)})})}),Array.from(t)}countPoliteWords(e){let t=0;const n=e.toLowerCase();return F.chinese.forEach(n=>{e.includes(n)&&t++}),F.english.forEach(e=>{new RegExp(`\\b${e}\\b`,"gi").test(n)&&t++}),t}countWords(e){const t=e.match(/[\u4e00-\u9fa5]/g)||[],n=e.match(/\b[a-zA-Z]+\b/g)||[];return t.length+n.length}determinePersonalityType(e){const t=60,n=e.L>=t,a=e.L>=40&&e.L<t,o=e.P>=t,s=e.P>=40&&e.P<t,i=e.D>=t,r=e.D>=40&&e.D<t,l=e.E>=30,c=e.E>=12&&e.E<30,d=e.F>=t,u=[];n?u.push("L"):a?u.push("L-"):u.push("-"),o?u.push("P"):s?u.push("P-"):u.push("-"),i?u.push("D"):r?u.push("D-"):u.push("-"),l?u.push("E"):c?u.push("E-"):u.push("-");const g=u.join("")+(d?"F":"-");return V[g]?g:this.findClosestType(e)}findClosestType(e){let t=1/0,n="L-P-DEF-";return Object.keys(V).forEach(a=>{const o=this.calculateTypeDistance(e,a);o<t&&(t=o,n=a)}),n}calculateTypeDistance(e,t){let n=0;return t.includes("L")&&e.L<60&&(n+=20),t.includes("P")&&e.P<60&&(n+=20),t.includes("D")&&e.D<60&&(n+=20),t.includes("E")&&e.E<10&&(n+=20),!t.endsWith("-")&&e.F<60&&(n+=10),n}generateAnalysis(e,t){const n=this.lang||"zh-CN",a=O(n),o=a[t]||a["L-P-DEF-"],s=this.lang;return{type:t,name:o.name,description:o.description,traits:o.traits,color:o.color,dimensions:{L:{value:e.L,level:this.getDimensionLevel(e.L,"L",s),interpretation:this.getLInterpretation(e.L,s)},P:{value:e.P,level:this.getDimensionLevel(e.P,"P",s),interpretation:this.getPInterpretation(e.P,s)},D:{value:e.D,level:this.getDimensionLevel(e.D,"D",s),interpretation:this.getDInterpretation(e.D,s)},E:{value:e.E,level:this.getDimensionLevel(e.E,"E",s),interpretation:this.getEInterpretation(e.E,s)},F:{value:e.F,level:this.getDimensionLevel(e.F,"F",s),interpretation:this.getFInterpretation(e.F,s)}}}}getDimensionLevel(e,t,n){const a=n||this.lang||"zh-CN",o=$(a)[t];return"E"===t?e>=10?o.high:e>=5?o.mid:o.low:e>=70?o.high:e>=40?o.mid:o.low}getLInterpretation(e,t){const n=t||this.lang||"zh-CN",a=$(n);return e<40?a.L.low:e<70?a.L.mid:a.L.high}getPInterpretation(e,t){const n=t||this.lang||"zh-CN",a=$(n);return e<40?a.P.low:e<70?a.P.mid:a.P.high}getDInterpretation(e,t){const n=t||this.lang||"zh-CN",a=$(n);return e<40?a.D.low:e<70?a.D.mid:a.D.high}getEInterpretation(e,t){const n=t||this.lang||"zh-CN",a=$(n);return e<5?a.E.low:e<10?a.E.mid:a.E.high}getFInterpretation(e,t){const n=t||this.lang||"zh-CN",a=$(n);return e<40?a.F.low:e<70?a.F.mid:a.F.high}generateSemanticFingerprint(e){const t=this.lang||"zh-CN",n="en"===t,a=.25*e.L+.2*e.P+.2*e.D+10*e.E*.15+.2*e.F,o=[e.L,e.P,e.D,e.F,10*e.E],s=o.reduce((e,t)=>e+t,0)/o.length,i=o.reduce((e,t)=>e+Math.pow(t-s,2),0)/o.length,r=Math.sqrt(i),l=Math.max(0,100-r),c=(e,t)=>e>=("E"===t?30:70)?n?"High":"高":e>=("E"===t?12:40)?n?"Med":"中":n?"Low":"低";return{codeRatio:`${Math.round(e.L)}%`,patienceLevel:c(e.P,"P")+(n?" Patience":"耐心"),detailLevel:c(e.D,"D")+(n?" Detail":"细腻"),techExploration:c(e.E,"E")+(n?" Explore":"探索"),feedbackDensity:`${Math.round(e.F)}%`,compositeScore:Math.round(a),techDiversity:e.E>=30?n?"Extreme":"极高":e.E>=12?n?"Moderate":"中等":n?"Low":"较低",interactionStyle:this.calculateInteractionStyle(e,t),balanceIndex:(d=l,d>=80?n?"Highly Balanced":"高度平衡":d>=60?n?"Well Balanced":"较为平衡":d>=40?n?"Slightly Imbalanced":"略有偏重":n?"Severely Imbalanced":"明显偏重")};var d}calculateInteractionStyle(e,t){const n="en"===t,a=[];return e.L>=70&&a.push(n?"Code Driven":"代码驱动"),e.P>=70&&a.push(n?"Gentle":"温和引导"),e.D>=70&&a.push(n?"Detail Oriented":"细节控"),e.E>=30&&a.push(n?"Tech Explore":"技术探索"),e.F>=70&&a.push(n?"Responsive":"积极反馈"),0===a.length?n?"Balanced":"均衡型":a.join(" · ")}calculateInteractionStyle(e,t){const n="en"===t,a=[];return e.L>=70&&a.push(n?"Code Driven":"代码驱动"),e.P>=70&&a.push(n?"Gentle":"温和引导"),e.D>=70&&a.push(n?"Detail Oriented":"细节控"),e.E>=10&&a.push(n?"Tech Explore":"技术探索"),e.F>=70&&a.push(n?"Responsive":"积极反馈"),0===a.length?n?"Balanced":"均衡型":a.join(" · ")}calculateStatistics(){const e=this.userMessages.length,t=this.userMessages.reduce((e,t)=>{var n;return e+((null==(n=t.text)?void 0:n.length)||0)},0),n=t/e||0;return{totalMessages:e,avgMessageLength:Math.round(n),totalChars:t}}async uploadToSupabase(e=null,t=null,n=null){var a,o,s,i,r,l,c,d,u,g,h,p;let m="";try{if(n){n("en"===this.lang?"Syncing global ranking in background…":"后台同步全球排名中…")}let v=null;if(t&&Array.isArray(t)&&t.length>0?(v=t,console.log("[VibeAnalyzer] ✅ 使用传入的 chatData 参数:",t.length,"条消息")):this.chatData&&Array.isArray(this.chatData)&&this.chatData.length>0?(v=this.chatData,console.log("[VibeAnalyzer] ✅ 使用实例变量 this.chatData:",this.chatData.length,"条消息")):"undefined"!=typeof window&&window.allChatData&&Array.isArray(window.allChatData)&&window.allChatData.length>0?(v=window.allChatData,console.log("[VibeAnalyzer] ✅ 使用全局变量 window.allChatData:",window.allChatData.length,"条消息")):this.userMessages&&Array.isArray(this.userMessages)&&this.userMessages.length>0?(console.warn("[VibeAnalyzer] ⚠️ 未找到原始聊天数据，尝试从 userMessages 构建"),v=this.userMessages.map(e=>({role:"USER",text:e.text||e.content||""})),console.log("[VibeAnalyzer] ✅ 从 userMessages 构建了",v.length,"条消息")):e&&e.originalChatData&&Array.isArray(e.originalChatData)&&e.originalChatData.length>0?(v=e.originalChatData,console.log("[VibeAnalyzer] ✅ 从 vibeResult.originalChatData 提取:",v.length,"条消息")):v=[],!v||!Array.isArray(v)||0===v.length)throw console.error("[VibeAnalyzer] ❌ 所有数据源都失败:",{hasChatDataParam:!!t,hasThisChatData:!!this.chatData,hasWindowAllChatData:"undefined"!=typeof window&&!!window.allChatData,hasUserMessages:!!this.userMessages,userMessagesLength:(null==(a=this.userMessages)?void 0:a.length)||0,hasVibeResult:!!e}),new Error("无法获取原始聊天数据，请确保已调用 analyze 方法或传入 chatData 参数");const w=v.map(e=>({role:e.role||"USER",text:e.text||e.content||""})).filter(e=>e.text&&e.text.trim().length>0);if(0===w.length)throw new Error("聊天数据为空，无法进行分析");const C=e=>{let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=t+((t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24))>>>0;return("00000000"+t.toString(16)).slice(-8)},S=(e,t=64)=>{try{return String(e||"").slice(0,t)}catch{return""}},k=e=>e?String(e).trim().toLowerCase():"",_=()=>{try{const e=localStorage.getItem("user_fingerprint")||localStorage.getItem("fingerprint")||"";return k(e)}catch{return""}},A=async()=>{var e,t;const n="user_fingerprint";try{const a=k(localStorage.getItem(n)||"");if(a)return a;const o=k(localStorage.getItem("cursor_clinical_fingerprint")||localStorage.getItem("vibe_fp")||localStorage.getItem("fingerprint")||"");if(o){try{localStorage.setItem(n,o)}catch{}return o}const s=(()=>{try{return Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{return"UTC"}})(),i=`fp|${(()=>{try{return navigator.userAgent||""}catch{return""}})()}|${s}|${(()=>{var e;try{if(null==(e=globalThis.crypto)?void 0:e.randomUUID)return globalThis.crypto.randomUUID()}catch{}return String(Math.random())+"|"+String(Date.now())})()}`;let r="";try{if(null==(t=null==(e=globalThis.crypto)?void 0:e.subtle)?void 0:t.digest){const e=await globalThis.crypto.subtle.digest("SHA-256",(new TextEncoder).encode(i)),t=Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("");r=k(t.slice(0,32))}}catch{}if(r||(r=k((C(i+"|a")+C(i+"|b")+C(i+"|c")+C(i+"|d")).slice(0,32))),r)try{localStorage.setItem(n,r)}catch{}return r}catch{return""}},M=((e,t)=>{var n,a;const o=w.length,s=(null==(n=w[0])?void 0:n.text)||"",i=(null==(a=w[w.length-1])?void 0:a.text)||"";let r=0;try{const e=w.slice(0,50),t=w.slice(-50);r=e.reduce((e,t)=>{var n;return e+((null==(n=null==t?void 0:t.text)?void 0:n.length)||0)},0)+t.reduce((e,t)=>{var n;return e+((null==(n=null==t?void 0:t.text)?void 0:n.length)||0)},0)}catch{r=0}const l=k(e)||_()||"no_fp",c=["v2","lang="+String(t||""),"fp="+l,"msg="+o,"head="+S(s,96),"tail="+S(i,96),"sampleLen="+String(r)].join("|");return C(c)})((null==(o=null==e?void 0:e.meta)?void 0:o.fingerprint)||(null==e?void 0:e.fingerprint)||(null==(s=null==e?void 0:e.context)?void 0:s.fingerprint)||null,this.lang||"zh-CN"),x=globalThis.__vibeUploadInflightBySig||(globalThis.__vibeUploadInflightBySig=new Map),I=`__vibeUploadCache_v2_${M}`;try{const e="undefined"!=typeof globalThis&&globalThis.__vibeUploadLock;if(e&&!0===e.done){const e="undefined"!=typeof window&&window.__vibeLastUploadResult||null;if(e)return console.log("[VibeAnalyzer] 🧠 全局锁已完成 (__vibeUploadLock.done)，跳过请求"),e}if(e&&e.promise&&"function"==typeof e.promise.then)return console.log("[VibeAnalyzer] ⏳ 复用全局锁进行中的请求 (__vibeUploadLock.promise)"),await e.promise}catch(y){}try{if("undefined"!=typeof window&&window.__vibeSubmitted&&window.__vibeLastUploadResult)return console.log("[VibeAnalyzer] 🧠 Session 已提交过 (__vibeSubmitted)，跳过重复上报"),window.__vibeLastUploadResult}catch(y){}try{const e="undefined"!=typeof globalThis&&globalThis.__vibeUploadPromise;if(e&&"function"==typeof(e&&e.then))return console.log("[VibeAnalyzer] ⏳ 已有上报进行中，复用 globalThis.__vibeUploadPromise"),await globalThis.__vibeUploadPromise}catch(y){}try{const e=localStorage.getItem(I);if(e){const t=JSON.parse(e),n=Number((null==t?void 0:t.ts)||0),a=(null==t?void 0:t.result)||null;if(n>0&&Date.now()-n<6e5&&a&&"object"==typeof a)return console.log("[VibeAnalyzer] 🧠 命中上传缓存，跳过重复上报:",{sig:M}),a}}catch{}if(x.has(M))return console.log("[VibeAnalyzer] ⏳ 检测到同签名上报进行中，复用 in-flight 请求:",{sig:M}),await x.get(M);const L=(()=>{if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return e;const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim();return e.endsWith("/")?e:e+"/"}}return"https://cursor-clinical-analysis.psterman.workers.dev/"})();let E=null;if(e)if(e.stats){E={...e.stats};const t=e.stats.usageDays??e.stats.usage_days??(null==(i=e.statistics)?void 0:i.usageDays)??(null==(r=e.statistics)?void 0:r.usage_days);null!=t&&Number(t)>=1&&(E.work_days=Math.max(1,Number(t)),E.usageDays=E.work_days)}else if(e.statistics){let t={};if(e.statistics.tech_stack)if("string"==typeof e.statistics.tech_stack)try{t=JSON.parse(e.statistics.tech_stack)}catch(f){console.warn("[VibeAnalyzer] tech_stack解析失败:",f),t={}}else"object"==typeof e.statistics.tech_stack&&(t=e.statistics.tech_stack);const n=e.statistics.usageDays??e.statistics.usage_days,a=null!=n&&Number(n)>=1?Math.max(1,Number(n)):e.statistics.work_days||e.statistics.usage_days||1;E={totalChars:e.statistics.totalChars||e.statistics.totalUserChars||0,totalMessages:e.statistics.totalMessages||e.statistics.userMessages||0,ketao_count:e.statistics.ketao_count||e.statistics.qingCount||0,jiafang_count:e.statistics.jiafang_count||e.statistics.buCount||0,tech_stack:t,work_days:a,usageDays:a,avg_payload:e.statistics.avg_payload||0}}E||(E={totalChars:0,totalMessages:0,ketao_count:0,jiafang_count:0,tech_stack:{},work_days:1,avg_payload:0});const P=null==e?void 0:e.soulWords;if(P&&Array.isArray(P)&&P.length>0){const e=[],t=[],n=[];for(let a=0;a<P.length;a++){const o=P[a];if(!o||!o.p)continue;const s=String(o.p).trim(),i=Number(o.v)||0,r=String(o.c||"").trim(),l={word:s,count:i};"Novice"===r?e.push(l):"Professional"===r?t.push(l):"Architect"===r&&n.push(l)}E.identityLevelCloud={Novice:e,Professional:t,Architect:n}}else{const t=(null==e?void 0:e.identityLevelCloud)||(null==(l=null==e?void 0:e.statistics)?void 0:l.identityLevelCloud);t&&"object"==typeof t&&(E.identityLevelCloud={Novice:Array.isArray(t.Novice)?t.Novice.slice(0,1).map(e=>({word:(null==e?void 0:e.word)??(null==e?void 0:e.phrase)??"",count:Number((null==e?void 0:e.count)??(null==e?void 0:e.weight)??0)||0})):[],Professional:Array.isArray(t.Professional)?t.Professional.slice(0,1).map(e=>({word:(null==e?void 0:e.word)??(null==e?void 0:e.phrase)??"",count:Number((null==e?void 0:e.count)??(null==e?void 0:e.weight)??0)||0})):[],Architect:Array.isArray(t.Architect)?t.Architect.slice(0,1).map(e=>({word:(null==e?void 0:e.word)??(null==e?void 0:e.phrase)??"",count:Number((null==e?void 0:e.count)??(null==e?void 0:e.weight)??0)||0})):[]})}const T=(null==(c=null==e?void 0:e.meta)?void 0:c.fingerprint)||(null==(d=null==e?void 0:e.context)?void 0:d.fingerprint)||null,D=(null==e?void 0:e.dimensions)||{};let N=(null==e?void 0:e.meta)||{};if(!N.ip||"0.0.0.0"===N.ip){const t=(null==e?void 0:e.context)||{};N={ip:t.ip||"0.0.0.0",lang:t.lang||this.lang||"zh-CN",timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",fingerprint:t.fingerprint||T||null,vpn:t.isVpn||t.vpn||!1,proxy:t.isProxy||t.proxy||!1,timestamp:(new Date).toISOString()}}let R=_()||k(null==N?void 0:N.fingerprint)||k(T)||null;R||(R=await A()),R&&(N.fingerprint=R);const U=(()=>{try{const e=String(localStorage.getItem("vibe_claim_token")||"").trim();return e&&/^[0-9a-fA-F-]{16,64}$/.test(e)?e:null}catch{return null}})(),$={chatData:w,lang:this.lang||"zh-CN",countryCode:this.countryCode||null,fingerprint:R,claim_token:U,dimensions:D,stats:E,meta:N,snapshot_country:(()=>{try{const e=String(localStorage.getItem("anchored_country")||"").trim().toUpperCase()||String(localStorage.getItem("selected_country")||"").trim().toUpperCase();return/^[A-Z]{2}$/.test(e)?e:null}catch{return null}})(),current_location:(()=>{try{const e=String(localStorage.getItem("anchored_country")||"").trim().toUpperCase()||String(localStorage.getItem("selected_country")||"").trim().toUpperCase();return/^[A-Z]{2}$/.test(e)?e:null}catch{return null}})(),location_weight:(()=>{try{const e=String(localStorage.getItem("country_switch_to")||"").trim().toUpperCase(),t=Number(localStorage.getItem("country_switch_ts")||0),n=String(localStorage.getItem("anchored_country")||"").trim().toUpperCase()||String(localStorage.getItem("selected_country")||"").trim().toUpperCase();if(e&&n&&e===n&&Number.isFinite(t)&&t>0){const e=216e5;return Math.max(0,Math.min(1,(Date.now()-t)/e))}return 1}catch{return 1}})(),location_switched_at:(()=>{try{const e=Number(localStorage.getItem("country_switch_ts")||0);return Number.isFinite(e)&&e>0?new Date(e).toISOString():null}catch{return null}})()};(null==e?void 0:e.representativeWords)&&"object"==typeof e.representativeWords&&($.representativeWords=e.representativeWords);const j=e&&Array.isArray(e.cloud50)?e.cloud50:[],B=e=>({w:e.name,v:e.value});$.personality={...(null==e?void 0:e.personality)||{},vibe_lexicon:{merit_board:j.filter(e=>"merit"===e.category).map(B),slang_list:j.filter(e=>"slang"===e.category||"sv_slang"===e.category).map(B),mantra_top:j.slice(0,20).map(B)}},this.forceCnIdentity&&"CN"===this.countryCode?($.country_code="CN",$.ip_location="CN"):this.countryCode&&($.country_code=this.countryCode),console.log("[VibeAnalyzer] 发送原始聊天数据到 /api/v2/analyze:",{messageCount:w.length,lang:$.lang,sampleMessage:w[0],payloadFormat:'严格遵循 { chatData: [...], lang: "zh-CN", stats: {...} } 格式',hasStats:!!$.stats,statsKeys:$.stats?Object.keys($.stats):[]}),m=L.endsWith("/")?`${L}api/v2/analyze`:`${L}/api/v2/analyze`;const W={"Content-Type":"application/json"};try{const e="undefined"!=typeof window&&window.__VIBE_GITHUB_ACCESS_TOKEN__||"undefined"!=typeof window&&window.localStorage&&window.localStorage.getItem("vibe_github_access_token");e&&String(e).trim()&&(W.Authorization="Bearer "+String(e).trim(),console.log("[VibeAnalyzer] 使用 GitHub Token 上报 (Authorization: Bearer)"))}catch(y){}const F=(async()=>{try{const e=await fetch(m,{method:"POST",headers:W,body:JSON.stringify($)});if(!e.ok){const t=await e.text().catch(()=>"无法读取错误信息");throw new Error(`HTTP error! status: ${e.status}, error: ${t}`)}const t=await e.json();console.log("[VibeAnalyzer] 后端返回数据:",t);try{localStorage.setItem(I,JSON.stringify({ts:Date.now(),result:t})),"undefined"!=typeof window&&(window.__vibeSubmitted=!0,window.__vibeLastUploadResult=t),"undefined"!=typeof globalThis&&globalThis.__vibeUploadLock&&(globalThis.__vibeUploadLock.done=!0)}catch{}try{if("undefined"!=typeof BroadcastChannel){const e=new BroadcastChannel("vibe-stats-sync");e.postMessage({type:"local_analysis_complete",ts:Date.now(),payload:t}),e.close()}}catch(y){}return t}finally{try{"undefined"!=typeof globalThis&&(globalThis.__vibeUploadPromise=void 0)}catch(y){}}})();try{"undefined"!=typeof globalThis&&(globalThis.__vibeUploadPromise=F,globalThis.__vibeUploadLock&&(globalThis.__vibeUploadLock.promise=F))}catch(y){}let z;x.set(M,F);try{z=await F}finally{try{x.delete(M)}catch{}}if(z.global_stats)try{localStorage.setItem("vibe_global_stats",JSON.stringify(z.global_stats)),console.log("[VibeAnalyzer] ✅ 已保存 global_stats 到本地:",z.global_stats)}catch(b){console.warn("[VibeAnalyzer] 保存 global_stats 失败:",b)}if("success"===z.status){const t=z.dimensions||{},n=z.roastText||"",a=z.personalityName||"",o=z.vibeIndex||"00000",s=z.personalityType||"UNKNOWN",i=z.lpdef||"";if(this.analysisResult){if(this.analysisResult.dimensions=t,this.analysisResult.roastText=n,this.analysisResult.personalityName=a,this.analysisResult.vibeIndex=o,this.analysisResult.personalityType=s,this.analysisResult.lpdef=i,z.stats||z.statistics){const e=z.stats||z.statistics||{};let t={};if(e.tech_stack)if("string"==typeof e.tech_stack)try{t=JSON.parse(e.tech_stack)}catch(f){console.warn("[VibeAnalyzer] tech_stack解析失败:",f),t={}}else"object"==typeof e.tech_stack&&(t=e.tech_stack);const n={totalChars:e.totalChars||0,totalMessages:e.totalMessages||0,ketao_count:e.ketao_count||0,jiafang_count:e.jiafang_count||0,tech_stack:t,work_days:e.work_days||1,avg_payload:e.avg_payload||0,...e};this.analysisResult.statistics={...this.analysisResult.statistics,...n},this.analysisResult.metadata||(this.analysisResult.metadata={}),this.analysisResult.metadata.stats=n}z.countryAverage&&(this.countryAverage=z.countryAverage,this.analysisResult.countryAverage=z.countryAverage),z.globalAverage&&(this.globalAverage=z.globalAverage,this.analysisResult.globalAverage=z.globalAverage),console.log("[VibeAnalyzer] ✅ 已同步后端精准数据到实例状态:",{dimensions:t,roastText:n.substring(0,50)+"...",personalityName:a,vibeIndex:o})}const r=z.statistics||{},l=z.totalUsers||z.value||z.total||z.count||0,c=z.rankPercent??z.ranking??0,d=z.ranks||null,m=z.globalAverage||z.global_average||null;this.analysisResult&&(z.analysis&&(this.analysisResult.analysis=z.analysis),z.semanticFingerprint&&(this.analysisResult.semanticFingerprint=z.semanticFingerprint),z.stats&&(this.analysisResult.stats=z.stats),z.fingerprint&&(this.analysisResult.fingerprint=z.fingerprint));const y={dimensions:t,roastText:n,personalityName:a,vibeIndex:o,personalityType:s,lpdef:i,analysis:z.analysis||(null==e?void 0:e.analysis)||(null==(u=this.analysisResult)?void 0:u.analysis)||null,semanticFingerprint:z.semanticFingerprint||(null==e?void 0:e.semanticFingerprint)||(null==(g=this.analysisResult)?void 0:g.semanticFingerprint)||null,stats:z.stats||(null==(h=z.data)?void 0:h.stats)||null,fingerprint:z.fingerprint||null,claim_token:z.claim_token||null,personality:z.personality||null,detailedStats:(null==(p=z.personality)?void 0:p.detailedStats)||z.detailedStats||null,rankPercent:Number(c),ranking:Number(c),totalUsers:Number(l),defeated:z.defeated??0,actualRank:z.actualRank??0,statistics:r,metadata:z.metadata||null};return d&&(y.ranks=d),m&&(y.globalAverage=m),y}throw console.warn("[VibeAnalyzer] 后端返回错误:",z),new Error(z.error||z.message||"后端返回错误状态")}catch(v){return console.error("[VibeAnalyzer] 上传排名过程出错:",{message:v.message,name:v.name,isNetworkError:v.message.includes("fetch")||v.message.includes("network")||v.message.includes("CORS"),isTimeout:v.message.includes("timeout")||v.message.includes("Timeout")}),{error:v.message,errorType:v.name,isNetworkError:v.message.includes("fetch")||v.message.includes("network")||v.message.includes("CORS"),isTimeout:v.message.includes("timeout")||v.message.includes("Timeout"),timestamp:(new Date).toISOString(),url:m||"unknown",rankPercent:0,totalUsers:0}}}getDefaultResultWithContext(e={}){const t=e.lang||this.lang||"zh-CN";"en"===t||t.startsWith("en");const n={};return(this.dimensionKeys||["L","P","D","E","F"]).forEach(e=>{n[e]=0}),{fingerprint:{codeRatio:"0%",patienceLevel:"Low Patience",detailLevel:"Low Detail",techExploration:"Low Explore",feedbackDensity:"0%",compositeScore:0,techDiversity:"Low",interactionStyle:"Balanced",balanceIndex:"Slightly Imbalanced"},dimensions:n,stats:{totalChars:0,totalMessages:0,ketao_count:0,jiafang_count:0,tech_stack:{},work_days:0,avg_payload:0},meta:{ip:e.ip||"0.0.0.0",lang:t,timezone:e.timezone||"UTC",fingerprint:e.fingerprint||null,isVpn:Boolean(e.isVpn||!1),isProxy:Boolean(e.isProxy||!1),timestamp:(new Date).toISOString(),countryCode:this.countryCode||null,hasRageWord:!1,personalityType:"UNKNOWN",vibeIndex:"00000",lpdef:"L0P0D0E0F0"}}}getDefaultResult(e="zh-CN"){return this.getDefaultResultWithContext({lang:e})}setCountryContext(e,t=null,n={}){this.countryCode=e,this.countryAverage=t,this.countryContext={...this.countryContext,...n,countryCode:e,updatedAt:(new Date).toISOString()},console.log(`[VibeAnalyzer] 国家上下文已设置: ${e}`,{countryAverage:t,contextKeys:Object.keys(n)})}calculateDeviationFromCountry(e){if(!this.countryAverage||!e)return null;const t={},n=this.dimensionKeys||Object.keys(e);let a=0,o=0;n.forEach(n=>{const s=e[n]||0,i=this.countryAverage[n]||0;if(i>0){const e=(s-i)/i*100;t[n]={personal:s,country:i,deviation:e.toFixed(2),deviationPercent:`${e>=0?"+":""}${e.toFixed(2)}%`},a+=Math.abs(e),o++}});const s=o>0?a/o:0;return{deviations:t,overallDeviation:s.toFixed(2),interpretation:this.interpretDeviation(s)}}interpretDeviation(e){const t=parseFloat(e);return t<5?"与全国平均水平非常接近":t<15?"略高于/低于全国平均水平":t<30?"明显高于/低于全国平均水平":"显著偏离全国平均水平"}destroy(){this.messageChannels.forEach(e=>{try{e.port1.close(),e.port2.close()}catch(t){console.warn("[VibeAnalyzer] 清理MessageChannel失败:",t)}}),this.messageChannels.clear(),this.worker&&(this._messageHandler&&(this.worker.removeEventListener("message",this._messageHandler),this._messageHandler=null),this.worker.terminate(),this.worker=null,this.workerReady=!1),this.activeTimeouts.forEach(e=>{clearTimeout(e)}),this.activeTimeouts.clear(),this.analysisLock=!1,this.sparseDimensions.clear(),console.log("[VibeAnalyzer] 资源清理完成")}}e=new WeakSet,t=function(e,t,n,a){try{const o=Array.isArray(e)?e:[];if(0===o.length)return;const s=String(a||(null==t?void 0:t.countryCode)||"Global").trim()||"Global",i=(null==t?void 0:t.fingerprint)||(null==n?void 0:n.fingerprint)||null;T(o,{fingerprint:i,timestamp:(null==n?void 0:n.timestamp)||(new Date).toISOString(),region:s})}catch(o){console.warn("[VibeAnalyzer] 上报关键词失败:",(null==o?void 0:o.message)||String(o))}},n=function(e){const t=(Array.isArray(e)?e:[]).map(e=>String((null==e?void 0:e.text)||(null==e?void 0:e.content)||"")).join("\n");if(!t)return[];const n=[],a=t.match(/```[\s\S]*?```/g)||[];for(const r of a)n.push(r.replace(/```/g," "));const o=t.match(/`[^`]{6,200}`/g)||[];for(const r of o)n.push(r.replace(/`/g," "));const s=n.join("\n");if(!s.trim())return[];const i=new Map;for(const r of p)s.includes(r)&&i.set(r,{phrase:r,category:"merit",weight:1});for(const r of m)s.includes(r)&&i.set(r,{phrase:r,category:"slang",weight:1});return Array.from(i.values())},function(){if("undefined"==typeof window)return;const e=window.location.hash||"";if(/access_token=/.test(e)){const a={};e.slice(1).split("&").forEach(function(e){const t=e.indexOf("=");if(-1!==t){const n=decodeURIComponent(e.slice(0,t)),o=decodeURIComponent((e.slice(t+1)||"").replace(/\+/g," "));a[n]=o}});const o=a.access_token||a.access_token,s=a.refresh_token||a.refresh_token;if(o){try{window.localStorage.setItem("vibe_github_access_token",o),s&&window.localStorage.setItem("vibe_github_refresh_token",s),window.__VIBE_GITHUB_ACCESS_TOKEN__=o,console.log("[Auth] ✅ 已从 Hash 捕获 access_token 并写入 localStorage + 全局变量")}catch(t){console.warn("[Auth] 写入 token 失败:",t)}try{const e=o.split(".");if(e.length>=2){const a=e[1].replace(/-/g,"+").replace(/_/g,"/"),s=a+Array((4-a.length%4)%4+1).join("="),i=atob(s),r=JSON.parse(i),l=r.user_metadata||{},c=l.avatar_url||l.avatar||l.picture||"",d=l.user_name||l.full_name||l.name||l.preferred_username||l.login||r.email||"";if(c||d){const e={avatar:c,name:d,at:Date.now()};try{window.localStorage.setItem("vibe_github_user_cache",JSON.stringify(e))}catch(n){}"undefined"!=typeof window&&(window.__vibeGitHubUser=e)}const u=r.sub||null;if(u)try{const e=window.localStorage.getItem("user_fingerprint");e&&""!==String(e).trim()?(console.log("[Auth] 🔑 检测到 access_token，开始迁移 fingerprint 到 user_id...",{userId:u.substring(0,8)+"...",fingerprint:String(e).substring(0,8)+"..."}),fetch("/api/fingerprint/migrate",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({fingerprint:e,userId:u,username:d||""})}).then(e=>{e.ok?console.log("[Auth] ✅ Fingerprint 迁移请求已发送"):console.warn("[Auth] ⚠️ Fingerprint 迁移请求失败:",e.status)}).catch(e=>{console.warn("[Auth] ⚠️ Fingerprint 迁移请求出错:",e)})):console.log("[Auth] ℹ️ 未找到 user_fingerprint，跳过迁移")}catch(t){console.warn("[Auth] ⚠️ 迁移 fingerprint 时出错:",t)}}}catch(n){}try{if(window.history&&window.history.replaceState){const e=window.location.pathname+(window.location.search||"");window.history.replaceState(null,"",e),console.log("[Auth] ✅ 已清理地址栏 Hash")}}catch(n){}}}else try{const e=window.localStorage.getItem("vibe_github_access_token");e&&String(e).trim()&&(window.__VIBE_GITHUB_ACCESS_TOKEN__=e.trim(),console.log("[Auth] 兜底：已从 localStorage 加载 Token 到全局变量"))}catch(n){}}(),"undefined"!=typeof window&&(window.getVibeRedirectUrl=function(){return window.location.origin+window.location.pathname}),"undefined"!=typeof globalThis&&(globalThis.__vibeUploadLock=globalThis.__vibeUploadLock||{promise:null,done:!1});const G={badges:{ketao_count:{label:{"zh-CN":"赛博磕头",en:"Ketao Count"},threshold:10,className:"tag-ketao",icon:"🙏"},jiafang_count:{label:{"zh-CN":"甲方上身",en:"Jiafang Index"},threshold:5,className:"tag-jiafang",icon:"💼"},tease_count:{label:{"zh-CN":"调戏AI",en:"Tease AI"},threshold:3,className:"tag-tease",icon:"😄"},nonsense_count:{label:{"zh-CN":"废话输出",en:"Nonsense Output"},threshold:20,className:"tag-nonsense",icon:"💬"},abuse_value:{label:{"zh-CN":"受虐值",en:"Abuse Value"},threshold:5,className:"tag-abuse",icon:"😤"}},global:{total_users:{label:{"zh-CN":"诊断总人数",en:"Total Users"},key:"total_count",className:"global-total-users"},global_chars:{label:{"zh-CN":"累计吐槽字数",en:"Global Chars"},key:"total_chars",className:"global-chars"},global_avg_payload:{label:{"zh-CN":"全网平均篇幅",en:"Global Avg Payload"},key:"avg_payload",className:"global-avg-payload"},geo_hotmap_summary:{label:{"zh-CN":"地理位置分布",en:"Geographic Distribution"},key:"geo_hotmap_summary",className:"global-geo-summary"},answer_text:{label:{"zh-CN":"今日答案之书",en:"Today's Answer Book"},key:"answer_text",className:"global-answer-text"}}};function Z(e="zh-CN"){const t=new K(e);return console.log("[Main] 创建 VibeCodingerAnalyzer 实例，环境:",{basePath:window.BASE_PATH||"(空)",isGitHubPages:window.location.hostname.includes("github.io"),workerConfig:window.WORKER_CONFIG}),t}if(!window.BASE_PATH){const e=window.location.pathname,t=window.location.hostname,n=t.includes("github.io"),a="localhost"===t||"127.0.0.1"===t;let o="";if(a)o="";else if(n){const t=e.split("/").filter(e=>e&&"index.html"!==e);o=t.length>0?"/"+t[0]:"",console.log("[Main] GitHub Pages 路径检测:",{pathname:e,pathParts:t,detectedBasePath:o})}else{const t=e.split("/").filter(e=>e&&"index.html"!==e);o=t.length>0?"/"+t[0]:""}o&&"/"!==o&&o.endsWith("/")&&(o=o.slice(0,-1)),window.BASE_PATH=o,console.log("[Main] 检测到基础路径:",window.BASE_PATH,{hostname:t,pathname:e,isGitHubPages:n,isLocalhost:a})}async function J(){const e=window.BASE_PATH||"",t=["Novice.json","Professional.json","Architect.json"].map(t=>e?e+(e.endsWith("/")?"":"/")+t:t);console.log("[Main] 正在加载身份级别词库:",t);const n=await Promise.all(t.map(async e=>{try{const t=await fetch(e);if(!t.ok)return console.warn(`[Main] 加载失败 ${e}: HTTP ${t.status}`),{keywords:[]};const n=await t.json(),a=Array.isArray(null==n?void 0:n.keywords)?n.keywords.length:0;return console.log(`[Main] 成功加载 ${e}: ${a} 个关键词`),n}catch(t){return console.warn(`[Main] 加载失败 ${e}:`,t.message),{keywords:[]}}})),[a,o,s]=n,i={Novice:Array.isArray(null==a?void 0:a.keywords)?a.keywords:[],Professional:Array.isArray(null==o?void 0:o.keywords)?o.keywords:[],Architect:Array.isArray(null==s?void 0:s.keywords)?s.keywords:[]};return console.log("[Main] 身份级别词库加载完成:",{Novice:i.Novice.length,Professional:i.Professional.length,Architect:i.Architect.length}),"undefined"!=typeof window&&(window.__identityLevelKeywords=i),i}"undefined"!=typeof window&&(window.getVibeAssetUrl=function(e){const t=window.BASE_PATH||"",n=String(e||"").trim();return t+(n.startsWith("/")?n:"/"+n)}),window.WORKER_CONFIG={getWorkerUrl:function(e){const t=window.BASE_PATH||"";if(t){const n=`${t}/src/${e}`;return console.log("[Main] 构建 Worker URL (GitHub Pages):",n),n}{const t=`./src/${e}`;return console.log("[Main] 构建 Worker URL (本地):",t),t}},basePath:window.BASE_PATH||"",workerPath:window.BASE_PATH?`${window.BASE_PATH}/src/vibeAnalyzerWorker.js`:"./src/vibeAnalyzerWorker.js"};class Y{constructor(){this.parser=null,this.analyzer=null,this.allChatData=[],this.globalStats=null,this.vibeResult=null,this.globalStatsCache=null}async uploadUserStats(e,t){console.log("[VibeCodingApp] uploadUserStats: 实际上传由 uploadToSupabase 方法处理")}async generateContext(){let e;try{e=await async function(){const e="user_fingerprint",t="cursor_clinical_fingerprint",n="vibe_fp";try{let s=localStorage.getItem(e)||localStorage.getItem(t);if(!s||s.length<16){const o=localStorage.getItem(n);if(o&&o.length>=8){if(16===o.length){const e=new Uint8Array(8);crypto.getRandomValues(e);s=o+Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}else s=o;try{localStorage.setItem(e,s),localStorage.setItem(t,s),console.log("[Main] ✅ 已从旧 key 迁移 fingerprint:",s)}catch(a){console.warn("[Main] ⚠️ 指纹迁移失败，但继续使用旧指纹:",a)}}}if(!s||s.length<16){const n=new Uint8Array(16);crypto.getRandomValues(n);const a=Array.from(n).map(e=>e.toString(16).padStart(2,"0")).join(""),i={userAgent:navigator.userAgent||"",language:navigator.language||"",platform:navigator.platform||"",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"},r=a+JSON.stringify(i),l=(new TextEncoder).encode(r),c=await crypto.subtle.digest("SHA-256",l);s=Array.from(new Uint8Array(c)).map(e=>e.toString(16).padStart(2,"0")).join("").substring(0,32);try{localStorage.setItem(e,s),localStorage.setItem(t,s),console.log("[Main] ✅ 已生成并持久化32位 fingerprint:",s)}catch(o){console.warn("[Main] ⚠️ localStorage 写入失败，但继续使用生成的指纹:",o)}}else{console.log("[Main] ✅ 从 localStorage 读取已存在的 fingerprint:",s);try{localStorage.getItem(e)||localStorage.setItem(e,s),localStorage.getItem(t)||localStorage.setItem(t,s)}catch{}}return s}catch(s){console.warn("[Main] ⚠️ fingerprint 生成失败，使用降级方案:",s);const n=navigator.userAgent||"",a=`fp_${Date.now()}_${Math.random().toString(36).substr(2,9)}_${n.substring(0,20)}`,o=(new TextEncoder).encode(a);try{const n=await crypto.subtle.digest("SHA-256",o),a=Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("").substring(0,32);try{localStorage.setItem(e,a),localStorage.setItem(t,a)}catch(i){}return a}catch(r){const n=btoa(a).replace(/[^a-zA-Z0-9]/g,"").substring(0,32);try{localStorage.setItem(e,n),localStorage.setItem(t,n)}catch(i){}return n}}}()}catch(i){console.warn("[VibeCodingApp] 异步指纹生成失败，使用同步降级:",i),e=function(){const e="user_fingerprint",t="cursor_clinical_fingerprint",n="vibe_fp";try{let o=localStorage.getItem(e)||localStorage.getItem(t);if(!o||o.length<16){const s=localStorage.getItem(n);if(s&&s.length>=8){o=16===s.length?s+s:s;try{localStorage.setItem(e,o),localStorage.setItem(t,o)}catch(a){}}}if(!o||o.length<16){const n=new Uint8Array(16);crypto.getRandomValues(n);const s=Array.from(n).map(e=>e.toString(16).padStart(2,"0")).join(""),i=(navigator.userAgent||"")+(navigator.language||"")+(navigator.platform||"");o=btoa(s+i).replace(/[^a-zA-Z0-9]/g,"").substring(0,32);try{localStorage.setItem(e,o),localStorage.setItem(t,o)}catch(a){}}return o}catch(i){const o=`fp_${Date.now()}_${Math.random().toString(36).substr(2,9)}`.substring(0,32);try{localStorage.setItem(e,o),localStorage.setItem(t,o)}catch(a){}return o}}()}let t="UTC";try{t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch(i){console.warn("[VibeCodingApp] timezone 获取失败:",i)}const n=le();let a=!1;try{const e=(new Date).getHours(),o=e=>({"Asia/Shanghai":8,"Asia/Hong_Kong":8,"Asia/Tokyo":9,"America/New_York":-5,"America/Los_Angeles":-8,"Europe/London":0,UTC:0}[e]||0),s=(e+o(t))%24,i=Math.abs(e-s),r=i>2&&i<22,l=-(new Date).getTimezoneOffset()/60,c=o(t),d=Math.abs(l-c),u=d>1,g=["UTC","America/New_York","Europe/London"].includes(t)&&n.startsWith("zh"),h="UTC"===t&&!n.startsWith("en");a=r||u||g||h,a&&console.log("[VibeCodingApp] ⚠️ VPN 检测触发:",{timezone:t,localHour:e,expectedHour:s,hourDiff:i,isLargeTimeDiff:r,isTimezoneOffsetMismatch:u,isTimezoneMismatch:g,isUtcWithNonEnglish:h,currentTimezoneOffsetHours:l,expectedOffsetHours:c,offsetDiff:d})}catch(i){console.warn("[VibeCodingApp] VPN 检测失败:",i)}let o="0.0.0.0";try{if("undefined"!=typeof RTCPeerConnection){const e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});e.createDataChannel(""),e.onicecandidate=t=>{if(t.candidate){const n=t.candidate.candidate.match(/([0-9]{1,3}\.){3}[0-9]{1,3}/);!n||n[0].startsWith("127.")||n[0].startsWith("192.168.")||n[0].startsWith("10.")||(o=n[0],console.log("[VibeCodingApp] ✅ WebRTC 探测到 IP:",o),e.close())}},e.createOffer().then(t=>e.setLocalDescription(t)).catch(t=>{console.warn("[VibeCodingApp] WebRTC createOffer 失败:",t),e.close()}),setTimeout(()=>{e.close(),"0.0.0.0"===o&&console.log("[VibeCodingApp] WebRTC 探测超时，使用默认 IP（后端将获取真实 IP）")},2e3)}}catch(i){console.warn("[VibeCodingApp] WebRTC 探测失败（使用默认值）:",i)}const s={fingerprint:e,timezone:t,lang:n,isVpn:a,isProxy:!1,ip:o};return console.log("[VibeCodingApp] ✅ 环境上下文已生成:",s),s}async init(){console.log("[VibeCodingApp] 初始化应用..."),this.parser||(this.parser=new l,await this.parser.init()),this.analyzer||(this.analyzer=Z()),console.log("[VibeCodingApp] 初始化完成")}renderBehaviorTags(e,t="behavior-tags-container"){if(!e)return void console.warn("[VibeCodingApp] renderBehaviorTags: stats 不存在");const n=document.getElementById(t)||document.querySelector(`#${t}`);if(!n)return;const a=le(),o=G.badges,s=Object.entries(o).filter(([t,n])=>(e[t]||0)>=n.threshold).map(([t,n])=>{const o=e[t]||0,s=n.label[a]||n.label["zh-CN"];return`\n          <span class="vibe-tag ${n.className}" data-v6-key="${t}" data-v6-value="${o}">\n            ${n.icon?`${n.icon} `:""}${Ye(s)}\n          </span>\n        `});e.style_label&&s.push(`\n        <span class="vibe-tag tag-style-label" data-v6-key="style_label" style="font-weight: bold; font-size: 1.1em; background: var(--accent-terminal); color: white;">\n          ${Ye(e.style_label)}\n        </span>\n      `),n.innerHTML=s.length>0?s.join(""):`<div class="vibe-tag-empty">${"en"===a?"No behavior tags yet":"暂无行为标签"}</div>`,console.log("[VibeCodingApp] ✅ renderBehaviorTags 完成，生成",s.length,"个标签")}updateV6UI(e){if(!e||!e.detailedStats||!Array.isArray(e.detailedStats))return void console.warn("[VibeCodingApp] updateV6UI: detailedStats 无效或不存在");const t=e.detailedStats;let n=0;const a=document.querySelectorAll("[data-v6-dim]");console.log("[VibeCodingApp] updateV6UI: 找到的维度容器:",Array.from(a).map(e=>({dimension:e.getAttribute("data-v6-dim"),hasRankLabel:!!e.querySelector(".rank-label"),hasRoastText:!!e.querySelector(".roast-text")}))),t.forEach(e=>{try{const{dimension:t,label:a,roast:o,score:s}=e||{};if(!t)return void console.warn("[VibeCodingApp] updateV6UI: 维度标识缺失",e);const i=document.querySelector('[data-v6-dim="'+t+'"]');if(!i)return void console.warn("[VibeCodingApp] updateV6UI: 未找到维度 "+t+" 的容器，跳过");const r=i.querySelector(".rank-label");r?a&&"未知"!==a&&(r.textContent=a,n++):console.warn("[VibeCodingApp] updateV6UI: 维度 "+t+" 的容器中未找到 .rank-label");const l=i.querySelector(".roast-text");if(l?o&&"暂无吐槽文案"!==o&&(l.textContent=o,n++):console.warn("[VibeCodingApp] updateV6UI: 维度 "+t+" 的容器中未找到 .roast-text"),null!=s){const e=i.querySelector(".dimension-value");e&&(e.textContent=Math.round(s));const t=i.querySelector(".dimension-bar");t&&(t.style.width=Math.min(100,Math.max(0,s))+"%")}}catch(t){console.warn("[VibeCodingApp] updateV6UI: 更新某维度时异常，跳过",t&&t.message)}}),console.log("[VibeCodingApp] ✅ updateV6UI 完成，更新了",n,"个维度元素")}syncGlobalStats(e){if(!e||"object"!=typeof e)return void console.warn("[VibeCodingApp] syncGlobalStats: globalStats 无效");const t=document.querySelectorAll("[data-v6-key]");let n=0;t.forEach((t,a)=>{const o=t.getAttribute("data-v6-key");if(!o)return;let s=null;const i=G.global[o];s=i&&i.key?e[i.key]:e[o],null!=s?(t.removeAttribute("data-skeleton"),t.style.opacity="0",t.style.transition="opacity 0.5s ease-in-out",t.textContent="number"==typeof s?s.toLocaleString():Ye(String(s)),setTimeout(()=>{requestAnimationFrame(()=>{t.style.opacity="1"})},50*a),n++):t.textContent&&""!==t.textContent.trim()&&"0"!==t.textContent||(t.setAttribute("data-skeleton","true"),t.style.opacity="0.3",t.textContent&&""!==t.textContent.trim()||(t.textContent="..."))}),console.log("[VibeCodingApp] ✅ syncGlobalStats 完成，更新了",n,"个元素（带渐入动画）")}updateUIWithStats(e,t=null){if(!e||!e.stats)return void console.warn("[VibeCodingApp] updateUIWithStats: result.stats 不存在");const n=e.stats,a=le(),o={badgeGrid:{ketao_count:{label:"en"===a?"Ketao Count":"赛博磕头",value:n.ketao_count||0},jiafang_count:{label:"en"===a?"Jiafang Index":"甲方指数",value:n.jiafang_count||0},abuse_value:{label:"en"===a?"Abuse Value":"受虐值",value:n.abuse_value||0},work_days:{label:"en"===a?"Work Days":"上岗天数",value:n.work_days||1},tease_count:{label:"en"===a?"Tease Count":"调戏AI",value:n.tease_count||0},nonsense_count:{label:"en"===a?"Nonsense Count":"废话输出",value:n.nonsense_count||0}},fingerprintBars:{balance_score:{label:"en"===a?"Personality Stability":"人格稳定性",value:n.balance_score||0,max:100},code_ratio:{label:"en"===a?"Code Ratio":"代码占比",value:100*(n.code_ratio||0),max:100},feedback_density:{label:"en"===a?"Feedback Density":"反馈密度",value:n.feedback_density||0,max:50},diversity_score:{label:"en"===a?"Tech Diversity":"技术多样性",value:n.diversity_score||0,max:20}}},s=document.getElementById("badge-grid")||document.querySelector(".badge-grid");if(s){const e=Object.entries(o.badgeGrid).filter(([e,t])=>t.value>0).map(([e,t])=>`\n          <div class="badge-item">\n            <span class="badge-label">${t.label}</span>\n            <span class="badge-value">${t.value}</span>\n          </div>\n        `).join("");s.innerHTML=e||`<div class="badge-empty">${"en"===a?"No badges yet":"暂无徽章"}</div>`}const i=document.getElementById("fingerprint-bars")||document.querySelector(".fingerprint-bars");if(i){const e=Object.entries(o.fingerprintBars).map(([e,t])=>{const n=Math.min(100,t.value/t.max*100);return`\n            <div class="fingerprint-bar-item">\n              <div class="bar-header">\n                <span class="bar-label">${t.label}</span>\n                <span class="bar-value">${t.value.toFixed(1)}${"code_ratio"===e?"%":""}</span>\n              </div>\n              <div class="bar-container">\n                <div class="bar-fill" style="width: ${n}%; background: var(--accent-terminal);"></div>\n              </div>\n            </div>\n          `}).join("");i.innerHTML=e}this.renderBehaviorTags(n,"behavior-tags-container"),t&&this.syncGlobalStats(t),console.log("[VibeCodingApp] ✅ AutoMappingEngine 已完成 UI 更新")}async analyzeFile(e,t=null,n=null,a={}){var o,s,i,r,l,c;if(!this.analyzer)throw new Error("分析器未初始化，请先调用 init()");const d=le();this.analyzer.setLanguage(d);const u=await this.generateContext(),g=await J();g&&(u.levelKeywords=g,this.analyzer&&"function"==typeof this.analyzer.setLevelKeywords&&this.analyzer.setLevelKeywords(g));const h=await this.analyzer.analyze(e,u,null,n);console.log("[VibeCodingApp] analyze 完成:",h);const p=h&&(h.identityLevelCloud||h.statistics&&h.statistics.identityLevelCloud||h.stats&&h.stats.identityLevelCloud);if(p&&"object"==typeof p){window.vibeResults=ht(p),ae="Novice";var m=u&&u.levelKeywords||"undefined"!=typeof window&&window.__identityLevelKeywords||null,y=[],f={};if(m&&m.Novice&&m.Professional&&m.Architect){var b=pt(p,m);y=b.selectedWords,f=b.representativeWords||{},Object.keys(f).length>0&&(h.representativeWords=f)}else y=function(e){if(!e||"object"!=typeof e)return[];for(var t=[],n=[{key:"Novice",name:"Novice"},{key:"Professional",name:"Professional"},{key:"Architect",name:"Architect"},{key:"native",name:"Native"}],a=0;a<n.length;a++){var o=n[a],s=e[o.key];if(s){var i=[];if(Array.isArray(s)?i=s.map(function(e){return{word:null!=e.word?String(e.word):null!=e[0]?String(e[0]):"",count:null!=e.count?Number(e.count):null!=e[1]?Number(e[1]):0}}):s&&"object"==typeof s&&(i=Object.entries(s).map(function(e){return{word:String(e[0]),count:Number(e[1])||0}})),0!==i.length){for(var r=i[0],l=1;l<i.length;l++)i[l].count>r.count&&(r=i[l]);r&&r.word&&r.count>0&&t.push({p:r.word.trim(),c:o.name,v:r.count})}}}return t}(p);var v=["Novice","Professional","Architect"],w=y.filter(function(e){return e&&e.c&&-1!==v.indexOf(e.c)}).slice(0,3);w.length>0&&(h.soulWords=w);var C=h&&(h.ip_location||(null==(o=h.statistics)?void 0:o.ip_location)||(null==(s=h.stats)?void 0:s.ip_location))||"undefined"!=typeof window&&window.lastAnalysisResult&&window.lastAnalysisResult.ip_location?String(h&&(h.ip_location||(null==(i=h.statistics)?void 0:i.ip_location)||(null==(r=h.stats)?void 0:r.ip_location))||window.lastAnalysisResult&&window.lastAnalysisResult.ip_location||"").trim().toUpperCase():"";C&&/^[A-Za-z]{2}$/.test(C)||(C=""),w.length>0&&console.log("[Main] 高频词上传：仅上传 3 词（词频+指纹）",w.map(function(e){return e.p+"("+e.v+")"})),mt(w.length?w:y,C).catch(function(e){console.error("[Main] 灵魂词上报失败:",e)}),yt("Novice")}else console.warn("[Main] onAnalyzeComplete: payload.identityLevelCloud 缺失，请检查 Worker 是否上报");h&&!h.stats&&(h.statistics?h.stats={totalChars:h.statistics.totalChars||h.statistics.totalUserChars||0,totalMessages:h.statistics.totalMessages||h.statistics.userMessages||0,ketao_count:h.statistics.ketao_count||h.statistics.qingCount||0,jiafang_count:h.statistics.jiafang_count||h.statistics.buCount||0,abuse_value:h.statistics.abuse_value||h.statistics.abuseValue||0,tech_stack:h.statistics.tech_stack||{},work_days:h.statistics.work_days||h.statistics.usageDays||1,avg_payload:h.statistics.avg_payload||0,balance_score:h.statistics.balance_score||0,style_label:h.statistics.style_label||"标准型",blackword_hits:h.statistics.blackword_hits||{},identityLevelCloud:h.statistics.identityLevelCloud||h.identityLevelCloud||{Novice:{},Professional:{},Architect:{}},...h.statistics}:h.stats={totalChars:0,totalMessages:0,ketao_count:0,jiafang_count:0,abuse_value:0,tech_stack:{},work_days:1,avg_payload:0,balance_score:0,style_label:"标准型",blackword_hits:{}}),this.updateUIWithStats(h,this.globalStatsCache);const S=!1!==(null==a?void 0:a.deferGlobalSync),k=async()=>{var a,o,s,i;if(!h||!h.statistics)return;const r=h.statistics;r.qingCount=(null==t?void 0:t.qingCount)||(null==ee?void 0:ee.qingCount)||0,r.buCount=(null==t?void 0:t.buCount)||(null==ee?void 0:ee.buCount)||0,r.usageDays=(null==t?void 0:t.usageDays)||(null==ee?void 0:ee.usageDays)||1,r.totalUserChars=r.totalUserChars||r.totalChars||0,r.userMessages=r.userMessages||r.totalMessages||0;try{"undefined"!=typeof navigator&&/^zh-(CN|TW)$/i.test(navigator.language)&&(this.analyzer.countryCode="CN",this.analyzer.forceCnIdentity=!0);const t=await this.analyzer.uploadToSupabase(h,e,n);try{(null==t?void 0:t.claim_token)&&localStorage.setItem("vibe_claim_token",t.claim_token)}catch{}try{if("undefined"!=typeof window){const e=Number((null==t?void 0:t.totalUsers)||(null==(a=null==h?void 0:h.rankData)?void 0:a.totalUsers)||0)||0,n=(null==t?void 0:t.ranks)||null,o=t=>{if(null==t||e<=0)return null;const n=Number(t);if(Number.isNaN(n))return null;if(n<=0)return e;const a=Math.floor(e*(n/100));return Math.max(1,e-a)};if(e>0&&n){if(window.userRankings={qingCount:{rank:o(n.ketaoRank),total:e},buCount:{rank:o(n.jiafangRank),total:e},userMessages:{rank:o(n.messageRank),total:e},totalUserChars:{rank:o(n.charRank),total:e},avgUserMessageLength:{rank:o(n.avgRank),total:e},usageDays:{rank:o(n.daysRank),total:e}},"function"==typeof window.updateRankingBadges){const e=localStorage.getItem("appLanguage")||"zh-CN";Promise.resolve(window.updateRankingBadges(window.userRankings,e)).catch(()=>{})}try{window.dispatchEvent(new CustomEvent("userRankingsUpdated",{detail:window.userRankings}))}catch{}}}}catch{}try{const e=localStorage.getItem("vibe_global_stats");e?(this.globalStatsCache=JSON.parse(e),console.log("[VibeCodingApp] ✅ 已加载 global_stats:",this.globalStatsCache),this.updateUIWithStats(h,this.globalStatsCache),this.syncGlobalStats(this.globalStatsCache)):this.updateUIWithStats(h,null)}catch(l){console.warn("[VibeCodingApp] 读取 global_stats 失败:",l),this.updateUIWithStats(h,null)}if(t&&t.globalAverage){const e=t.globalAverage;50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?console.warn("[VibeCodingApp] ⚠️ uploadToSupabase 返回的全局平均值是默认值，忽略"):(oe=e,se=!0,console.log("[VibeCodingApp] ✅ 从 uploadToSupabase 获取到全局平均值:",oe))}t&&void 0!==t.rankPercent?(r.rankPercent=t.rankPercent,r.totalUsers=t.totalUsers,h.rankData||(h.rankData={}),h.rankData.rankPercent=t.rankPercent,h.rankData.totalUsers=t.totalUsers,t.ranks&&(h.rankData.ranks=t.ranks,console.log("[VibeCodingApp] ✅ ranks 对象已注入:",t.ranks)),t.analysis&&(h.analysis=t.analysis,console.log("[VibeCodingApp] ✅ analysis 对象已注入:",t.analysis)),t.semanticFingerprint&&(h.semanticFingerprint=t.semanticFingerprint,console.log("[VibeCodingApp] ✅ semanticFingerprint 对象已注入:",t.semanticFingerprint)),t.stats&&(h.stats=t.stats,console.log("[VibeCodingApp] ✅ stats 对象已注入:",t.stats)),t.fingerprint&&(h.fingerprint=t.fingerprint,console.log("[VibeCodingApp] ✅ fingerprint 已注入:",t.fingerprint)),t.personality?(h.personality=t.personality,console.log("[VibeCodingApp] ✅ personality 对象已注入:",t.personality),t.personality.detailedStats&&Array.isArray(t.personality.detailedStats)?(h.detailedStats=t.personality.detailedStats,h.personality.detailedStats=t.personality.detailedStats,console.log("[VibeCodingApp] ✅ 从 personality.detailedStats 读取数据:",t.personality.detailedStats),t.personality.detailedStats.length>0&&(this&&"function"==typeof this.updateV6UI?(this.updateV6UI({detailedStats:t.personality.detailedStats}),console.log("[VibeCodingApp] ✅ 已调用 updateV6UI 更新维度 UI")):console.warn("[VibeCodingApp] ⚠️ updateV6UI 方法不存在"))):console.warn("[VibeCodingApp] ⚠️ personality.detailedStats 不存在或不是数组")):t.detailedStats&&(h.detailedStats=t.detailedStats,console.log("[VibeCodingApp] ⚠️ 使用降级路径：从 liveRank.detailedStats 读取数据")),console.log("[VibeCodingApp] 真实排名数据已获取并更新:",{rankPercent:t.rankPercent,totalUsers:t.totalUsers,hasRanks:!!t.ranks,hasAnalysis:!!t.analysis,hasSemanticFingerprint:!!t.semanticFingerprint,hasStats:!!t.stats,hasPersonality:!!t.personality,hasDetailedStats:!(!(null==(o=t.personality)?void 0:o.detailedStats)&&!t.detailedStats),detailedStatsPath:(null==(s=t.personality)?void 0:s.detailedStats)?"personality.detailedStats":t.detailedStats?"detailedStats":"none"})):console.warn("[VibeCodingApp] uploadToSupabase 未返回有效的 rankPercent")}catch(c){if(console.error("[VibeCodingApp] uploadToSupabase 调用失败:",c),n){const e=le(),t=(null==(i=window.i18n)?void 0:i.getText("upload.logs.rankUploadFailed",e))||("en"===e?"Failed to upload ranking data":"排名数据上传失败");n(t)}}};this.vibeResult=h;try{const t=u&&u.lang?String(u.lang):le(),n=u&&u.fingerprint?String(u.fingerprint):localStorage.getItem("user_fingerprint")||null;let a=null,o=null;if(ee&&ee.earliestFileTime){o=ee.earliestFileTime;const e=Date.now()-o;a=Math.max(1,Math.floor(e/864e5))}const s=(null==h?void 0:h.stats)||(null==h?void 0:h.statistics)||{};if(null==a&&(a=s.work_days??s.usageDays??s.usage_days??s.days??null,null!=a&&(a=Math.max(1,Number(a)))),null==o&&(s.earliestFileTime??s.earliest_file_time??s.first_chat_at)){const e=Number(s.earliestFileTime??s.earliest_file_time??s.first_chat_at);Number.isFinite(e)&&e>0&&(o=e)}const i={chatData:e,lang:t,fingerprint:n,dimensions:(null==h?void 0:h.dimensions)||null,stats:{...s,earliestFileTime:o,usageDays:a,work_days:a??s.work_days??null,identityLevelCloud:h.identityLevelCloud||(null==(l=h.statistics)?void 0:l.identityLevelCloud)||s.identityLevelCloud||null},meta:u||null,vibeIndex:(null==h?void 0:h.vibeIndex)||(null==h?void 0:h.vibe_index)||null,personalityType:(null==h?void 0:h.personalityType)||(null==h?void 0:h.personality_type)||null,personalityName:(null==h?void 0:h.personalityName)||(null==h?void 0:h.personality_name)||null,personalityNameZh:(null==h?void 0:h.personalityNameZh)||(null==h?void 0:h.personality_name_zh)||null,personalityNameEn:(null==h?void 0:h.personalityNameEn)||(null==h?void 0:h.personality_name_en)||null,roastText:(null==h?void 0:h.roastText)||(null==h?void 0:h.roast_text)||null,roastTextZh:(null==h?void 0:h.roastTextZh)||(null==h?void 0:h.roast_text_zh)||null,roastTextEn:(null==h?void 0:h.roastTextEn)||(null==h?void 0:h.roast_text_en)||null,analysis:(null==h?void 0:h.analysis)||null};localStorage.setItem("last_analysis_data",JSON.stringify(i))}catch(_){try{const e=u&&u.lang?String(u.lang):le(),t=u&&u.fingerprint?String(u.fingerprint):localStorage.getItem("user_fingerprint")||null;let n=null,a=null;if(ee&&ee.earliestFileTime){a=ee.earliestFileTime;const e=Date.now()-a;n=Math.max(1,Math.floor(e/864e5))}const o=(null==h?void 0:h.stats)||(null==h?void 0:h.statistics)||{};null==n&&(n=o.work_days??o.usageDays??o.usage_days??o.days??null),null!=n&&(n=Math.max(1,Number(n)));const s={chatData:null,lang:e,fingerprint:t,dimensions:(null==h?void 0:h.dimensions)||null,stats:{...o,earliestFileTime:a,usageDays:n,work_days:n??o.work_days??null},meta:u||null,vibeIndex:(null==h?void 0:h.vibeIndex)||(null==h?void 0:h.vibe_index)||null,personalityType:(null==h?void 0:h.personalityType)||(null==h?void 0:h.personality_type)||null,note:"localStorage_limit_exceeded"};localStorage.setItem("last_analysis_data",JSON.stringify(s))}catch{}}if(this.renderReport(h),S){try{if("function"==typeof n){const e=le(),t=(null==(c=window.i18n)?void 0:c.getText("upload.logs.backgroundSync",e))||("en"===e?"Background syncing global ranking… (you can continue)":"后台同步全球排名中…（不影响使用）");n(t)}}catch{}Promise.resolve().then(()=>k()).catch(e=>console.warn("[VibeCodingApp] 后台全球同步失败:",e))}else await k();return h}async analyzeFileSync(e,t=null,n=null,a={}){var o,s,i,r,l;if(!this.analyzer)throw new Error("分析器未初始化，请先调用 init()");const c=le();this.analyzer.setLanguage(c);const d=await this.generateContext(),u=await J();u&&(d.levelKeywords=u,this.analyzer&&"function"==typeof this.analyzer.setLevelKeywords&&this.analyzer.setLevelKeywords(u));const g=await this.analyzer.analyzeSync(e,d.lang||c,null,n);console.log("[VibeCodingApp] analyzeSync 完成:",g);const h=g&&(g.identityLevelCloud||g.statistics&&g.statistics.identityLevelCloud||g.stats&&g.stats.identityLevelCloud);if(h&&"object"==typeof h){window.vibeResults=ht(h),yt("Novice");var p=d&&d.levelKeywords||"undefined"!=typeof window&&window.__identityLevelKeywords||null,m=[];if(p&&p.Novice&&p.Professional&&p.Architect){var y=pt(h,p);m=y.selectedWords,y.representativeWords&&Object.keys(y.representativeWords).length>0&&(g.representativeWords=y.representativeWords)}else{var f=function(e){var t,n;if(!e||"object"!=typeof e)return null;const a=e.identityLevelCloud||(null==(t=e.statistics)?void 0:t.identityLevelCloud)||(null==(n=e.stats)?void 0:n.identityLevelCloud);if(!a||"object"!=typeof a)return null;let o=null;if("undefined"!=typeof window&&null!=window.__standardSets)try{if(window.__standardSets instanceof Set)o=window.__standardSets;else if(Array.isArray(window.__standardSets))o=new Set(window.__standardSets);else if("object"==typeof window.__standardSets){const e=[];for(const t in window.__standardSets)Array.isArray(window.__standardSets[t])&&e.push(...window.__standardSets[t]);o=new Set(e)}}catch(c){console.warn("[Main] 构建标准词库 Set 失败:",(null==c?void 0:c.message)||String(c))}const s=["Novice","Professional","Architect"],i=[];for(const d of s){const e=a[d];if(!e)continue;let t=[];Array.isArray(e)?t=e:"object"==typeof e&&(t=Object.entries(e).filter(function(e){return e[1]>0}).map(function(e){return{word:e[0],count:e[1]}}));for(const n of t){const e=String(n.word||n[0]||"").trim();if(!e||e.length<=1)continue;if(o&&o.has(e))continue;let t=0;null!=n.v?t=Math.abs(Number(n.v)):null!=n.count?t=Math.abs(Number(n.count)):Array.isArray(n)&&n.length>=2&&(t=Math.abs(Number(n[1]))),t<=0||i.push({phrase:e,category:d,weight:t})}}if(0===i.length)return null;i.sort(function(e,t){return t.weight-e.weight});const r=i[0];if(!r)return null;const l={p:r.phrase,c:r.category,v:r.weight};return console.log("[Main] ✅ 灵魂词提炼成功:",l),l}(g);f&&(m=[f])}var b=g&&(g.ip_location||(null==(o=g.statistics)?void 0:o.ip_location)||(null==(s=g.stats)?void 0:s.ip_location))?String(g.ip_location||(null==(i=g.statistics)?void 0:i.ip_location)||(null==(r=g.stats)?void 0:r.ip_location)||"").trim().toUpperCase():"";b&&/^[A-Za-z]{2}$/.test(b)||(b=""),m.length>0&&mt(m,b).catch(console.error)}else console.warn("[Main] analyzeSync 完成: identityLevelCloud 缺失");g&&!g.stats&&(g.statistics?g.stats={totalChars:g.statistics.totalChars||g.statistics.totalUserChars||0,totalMessages:g.statistics.totalMessages||g.statistics.userMessages||0,ketao_count:g.statistics.ketao_count||g.statistics.qingCount||0,jiafang_count:g.statistics.jiafang_count||g.statistics.buCount||0,abuse_value:g.statistics.abuse_value||g.statistics.abuseValue||0,tech_stack:g.statistics.tech_stack||{},work_days:g.statistics.work_days||g.statistics.usageDays||1,avg_payload:g.statistics.avg_payload||0,balance_score:g.statistics.balance_score||0,style_label:g.statistics.style_label||"标准型",blackword_hits:g.statistics.blackword_hits||{},identityLevelCloud:g.statistics.identityLevelCloud||g.identityLevelCloud||{Novice:{},Professional:{},Architect:{}},...g.statistics}:g.stats={totalChars:0,totalMessages:0,ketao_count:0,jiafang_count:0,abuse_value:0,tech_stack:{},work_days:1,avg_payload:0,balance_score:0,style_label:"标准型",blackword_hits:{}}),this.updateUIWithStats(g,this.globalStatsCache);const v=!1!==(null==a?void 0:a.deferGlobalSync),w=async()=>{var a,o,s,i,r;if(!g||!g.statistics)return;const l=g.statistics;l.qingCount=(null==t?void 0:t.qingCount)||(null==ee?void 0:ee.qingCount)||0,l.buCount=(null==t?void 0:t.buCount)||(null==ee?void 0:ee.buCount)||0,l.usageDays=(null==t?void 0:t.usageDays)||(null==ee?void 0:ee.usageDays)||1;let c=0,d=0;e&&Array.isArray(e)&&e.forEach(e=>{"USER"===e.role&&e.text&&(c+=e.text.length,d++)}),l.totalUserChars=c||l.totalUserChars||l.totalChars||0,l.totalChars=c||l.totalChars||l.totalUserChars||0,l.userMessages=d||l.userMessages||l.totalMessages||0,l.totalMessages=d||l.totalMessages||l.userMessages||0;try{"undefined"!=typeof navigator&&/^zh-(CN|TW)$/i.test(navigator.language)&&(this.analyzer.countryCode="CN",this.analyzer.forceCnIdentity=!0);const t=await this.analyzer.uploadToSupabase(g,e,n);try{(null==t?void 0:t.claim_token)&&localStorage.setItem("vibe_claim_token",t.claim_token)}catch{}try{if("undefined"!=typeof window){const e=Number((null==t?void 0:t.totalUsers)||(null==(a=null==g?void 0:g.rankData)?void 0:a.totalUsers)||0)||0,n=(null==t?void 0:t.ranks)||null,o=t=>{if(null==t||e<=0)return null;const n=Number(t);if(Number.isNaN(n))return null;if(n<=0)return e;const a=Math.floor(e*(n/100));return Math.max(1,e-a)};if(e>0&&n){if(window.userRankings={qingCount:{rank:o(n.ketaoRank),total:e},buCount:{rank:o(n.jiafangRank),total:e},userMessages:{rank:o(n.messageRank),total:e},totalUserChars:{rank:o(n.charRank),total:e},avgUserMessageLength:{rank:o(n.avgRank),total:e},usageDays:{rank:o(n.daysRank),total:e}},"function"==typeof window.updateRankingBadges){const e=localStorage.getItem("appLanguage")||"zh-CN";Promise.resolve(window.updateRankingBadges(window.userRankings,e)).catch(()=>{})}try{window.dispatchEvent(new CustomEvent("userRankingsUpdated",{detail:window.userRankings}))}catch{}}}}catch{}if(t&&t.globalAverage){const e=t.globalAverage;50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?console.warn("[VibeCodingApp] ⚠️ uploadToSupabase 返回的全局平均值是默认值（同步方法），忽略"):(oe=e,se=!0,console.log("[VibeCodingApp] ✅ 从 uploadToSupabase 获取到全局平均值（同步方法）:",oe))}t&&void 0!==t.rankPercent?(l.rankPercent=t.rankPercent,l.totalUsers=t.totalUsers,g.rankData||(g.rankData={}),g.rankData.rankPercent=t.rankPercent,g.rankData.totalUsers=t.totalUsers,t.ranks&&(g.rankData.ranks=t.ranks,console.log("[VibeCodingApp] ✅ ranks 对象已注入（同步方法）:",t.ranks)),t.personality&&(g.personality=t.personality,console.log("[VibeCodingApp] ✅ personality 对象已注入（同步方法）:",t.personality)),t.detailedStats&&(g.detailedStats=t.detailedStats,console.log("[VibeCodingApp] ✅ detailedStats 数组已注入（同步方法）:",t.detailedStats)),(null==(o=t.personality)?void 0:o.detailedStats)&&Array.isArray(t.personality.detailedStats)?(ne.detailedStats=t.personality.detailedStats,ne.personality=ne.personality||{},ne.personality.detailedStats=t.personality.detailedStats,console.log("[VibeCodingApp] ✅ 从 personality.detailedStats 读取数据（同步方法）:",t.personality.detailedStats),t.personality.detailedStats.length>0&&(re&&"function"==typeof re.updateV6UI?(re.updateV6UI({detailedStats:t.personality.detailedStats}),console.log("[VibeCodingApp] ✅ 已调用 updateV6UI 更新维度 UI（同步方法）")):console.warn("[VibeCodingApp] ⚠️ vibeCodingApp 或 updateV6UI 方法不存在（同步方法）"))):console.warn("[VibeCodingApp] ⚠️ personality.detailedStats 不存在或不是数组（同步方法）"),console.log("[VibeCodingApp] 真实排名数据已获取并更新（同步方法）:",{rankPercent:t.rankPercent,totalUsers:t.totalUsers,hasRanks:!!t.ranks,hasPersonality:!!t.personality,hasDetailedStats:!(!(null==(s=t.personality)?void 0:s.detailedStats)&&!t.detailedStats),detailedStatsPath:(null==(i=t.personality)?void 0:i.detailedStats)?"personality.detailedStats":t.detailedStats?"detailedStats":"none"})):console.warn("[VibeCodingApp] uploadToSupabase 未返回有效的 rankPercent（同步方法）")}catch(u){if(console.error("[VibeCodingApp] uploadToSupabase 调用失败（同步方法）:",u),n){const e=le(),t=(null==(r=window.i18n)?void 0:r.getText("upload.logs.rankUploadFailed",e))||("en"===e?"Failed to upload ranking data":"排名数据上传失败");n(t)}}};this.vibeResult=g;try{const t=d&&d.lang?String(d.lang):le(),n=d&&d.fingerprint?String(d.fingerprint):localStorage.getItem("user_fingerprint")||null,a=(null==g?void 0:g.stats)||(null==g?void 0:g.statistics)||{},o=a.work_days??a.usageDays??a.usage_days??a.days??null,s={chatData:e,lang:t,fingerprint:n,dimensions:(null==g?void 0:g.dimensions)||null,stats:{...a,usageDays:null!=o?Math.max(1,Number(o)):null,work_days:null!=o?Math.max(1,Number(o)):a.work_days??null},meta:d||null,vibeIndex:(null==g?void 0:g.vibeIndex)||(null==g?void 0:g.vibe_index)||null,personalityType:(null==g?void 0:g.personalityType)||(null==g?void 0:g.personality_type)||null};localStorage.setItem("last_analysis_data",JSON.stringify(s))}catch(C){try{const e=d&&d.lang?String(d.lang):le(),t=d&&d.fingerprint?String(d.fingerprint):localStorage.getItem("user_fingerprint")||null,n=(null==g?void 0:g.stats)||(null==g?void 0:g.statistics)||{};let a=n.work_days??n.usageDays??n.usage_days??n.days??null;null!=a&&(a=Math.max(1,Number(a)));const o={chatData:null,lang:e,fingerprint:t,dimensions:(null==g?void 0:g.dimensions)||null,stats:{...n,usageDays:a,work_days:a??n.work_days??null},meta:d||null,vibeIndex:(null==g?void 0:g.vibeIndex)||(null==g?void 0:g.vibe_index)||null,personalityType:(null==g?void 0:g.personalityType)||(null==g?void 0:g.personality_type)||null,note:"localStorage_limit_exceeded"};localStorage.setItem("last_analysis_data",JSON.stringify(o))}catch{}}if(this.renderReport(g),v){try{if("function"==typeof n){const e=le(),t=(null==(l=window.i18n)?void 0:l.getText("upload.logs.backgroundSync",e))||("en"===e?"Background syncing global ranking… (you can continue)":"后台同步全球排名中…（不影响使用）");n(t)}}catch{}Promise.resolve().then(()=>w()).catch(e=>console.warn("[VibeCodingApp] 后台全球同步失败（同步方法）:",e))}else await w();return g}renderReport(e){e?(ne=e,document.getElementById("vibeCodingerSection")&&tt(),console.log("[VibeCodingApp] 报告渲染完成")):console.warn("[VibeCodingApp] 没有结果可渲染")}}let Q=null,X=[],ee=null,te=null,ne=null,ae="Novice";"undefined"!=typeof window&&(window.vibeResults=null);let oe={L:50,P:50,D:50,E:50,F:50},se=!1,ie=!1,re=null;function le(){return"en"===localStorage.getItem("appLanguage")?"en":"zh-CN"}function ce(e){return window.i18n&&window.i18n.getText?window.i18n.getText(e,le()):e}const de=()=>ee,ue=()=>X,ge=()=>ne,he=()=>Q,pe=()=>te,me=e=>{e&&(ee=e,console.log("[Main] 已设置分享模式的统计数据:",ee))},ye=e=>{var t,n,a,o,s,i,r;if(e){var l=!!(e.rankData||e.statistics&&null!=e.statistics.rankPercent),c=!(!ne||!(ne.rankData||ne.statistics&&null!=ne.statistics.rankPercent));if(!l&&c)if((d=e.identityLevelCloud||(null==(t=e.statistics)?void 0:t.identityLevelCloud)||(null==(n=e.stats)?void 0:n.identityLevelCloud))&&"object"==typeof d)return ne.identityLevelCloud=d,ne.statistics&&(ne.statistics.identityLevelCloud=d),ne.stats&&(ne.stats.identityLevelCloud=d),window.vibeResults=ht(d),void console.log("[Main] 已合并 identityLevelCloud，保留原有 rankData/人格文案");if(ne=e,e&&(e.identityLevelCloud||(null==(a=e.statistics)?void 0:a.identityLevelCloud)||(null==(o=e.stats)?void 0:o.identityLevelCloud))){var d=e.identityLevelCloud||(null==(s=e.statistics)?void 0:s.identityLevelCloud)||(null==(i=e.stats)?void 0:i.identityLevelCloud);window.vibeResults=ht(d)}console.log("[Main] 已设置 Vibe 结果:",{hasRankData:!!e.rankData,hasIdentityCloud:!(!e.identityLevelCloud&&!(null==(r=e.statistics)?void 0:r.identityLevelCloud))})}},fe=e=>{e&&Array.isArray(e)&&(X=e,console.log("[Main] 已设置分享模式的聊天数据:",X.length,"条"))},be=new Set(["的","是","在","了","我","你","他","她","它","我们","你们","他们","和","或","但是","因为","所以","如果","就","也","都","很","非常","可以","能","会","要","有","没","不","来","去","这","那","个","请","帮","写","一个","怎么","如何","什么","哪个","哪个","吗","呢","吧","啊","哦","嗯","哈","嘿","好"]),ve=new Set(["the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","to","of","in","for","on","at","by","with","from","as","into","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","can","could","will","would","should","may","might","must","please","help","write","one","some","any","all","both","how","what","which","who","when","where","why","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front"]),we=new Set(["的","是","在","了","我","你","他","她","它","我们","你们","他们","和","或","但是","因为","所以","如果","就","也","都","很","非常","可以","能","会","要","有","没","不","来","去","这","那","个","请","帮","写","一个","怎么","如何","什么","哪个","哪个","吗","呢","吧","啊","哦","嗯","哈","嘿","好","the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","must","to","of","in","for","on","at","by","with","from","as","into","through","during","before","after","above","below","between","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","mine","theirs","am","is","are","was","were","be","been","being","have","has","had","can","could","will","would","should","may","might","must","please","help","write","a","one","some","any","all","both","how","what","which","who","when","where","why","whether","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front","forward"]),Ce=[/\b(function|class|const|let|var|if|else|for|while|do|switch|case|break|continue|return|import|export|from|async|await|yield|try|catch|finally|throw|new|this)\b/i,/\b(public|private|protected|static|final|abstract|interface|extends|implements|super)\b/i,/\b(def |class |import |from |if |elif |else |for |while |try |except |finally |return |yield |with |as |lambda |pass |break |continue )/],Se=["def ","def\n","func ","func\n","fn ","#include","import ","#define","@","defclass ","class "],ke=!1,_e=async(e,t,n)=>{console.log("[Main] processFiles 被调用",{filesCount:e.length,type:t}),Q||(console.log("[Main] 解析器未初始化，正在初始化..."),Q=new l,await Q.init(),te=Z(),console.log("[Main] 解析器初始化完成"));const a={target:{files:e,value:""}};try{return await $e(a,t,n)}catch(o){throw console.error("[Main] processFiles 错误:",o),(null==n?void 0:n.onError)&&n.onError(o),o}},Ae=async e=>{var t,n;if(!te||!X||0===X.length)return console.warn("[Main] 无法重新分析：缺少数据或分析器"),null;console.log("[Main] 使用新语言重新分析:",e),te.setLanguage(e);try{let o=1;if(ee&&ee.earliestFileTime){const e=Date.now(),t=e-ee.earliestFileTime;o=Math.max(1,Math.floor(t/864e5))}const s=re?await re.generateContext():{ip:"0.0.0.0",lang:e,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",fingerprint:null,isVpn:!1,isProxy:!1};if(s.lang=e,ne=await te.analyze(X,s,null),console.log("[Main] 重新分析完成"),ne&&ne.statistics){ne.statistics.qingCount=(null==ee?void 0:ee.qingCount)||0,ne.statistics.buCount=(null==ee?void 0:ee.buCount)||0,ne.statistics.usageDays=o;try{"undefined"!=typeof navigator&&/^zh-(CN|TW)$/i.test(navigator.language)&&(te.countryCode="CN",te.forceCnIdentity=!0);const e=await te.uploadToSupabase(ne,X);try{(null==e?void 0:e.claim_token)&&localStorage.setItem("vibe_claim_token",e.claim_token)}catch{}if(e&&e.globalAverage){const t=e.globalAverage;50===t.L&&50===t.P&&50===t.D&&50===t.E&&50===t.F?console.warn("[Main] ⚠️ uploadToSupabase 返回的全局平均值是默认值，忽略"):(oe=t,se=!0,console.log("[Main] ✅ 从 uploadToSupabase 获取到全局平均值:",oe))}e&&void 0!==e.rankPercent&&(ne.statistics.rankPercent=e.rankPercent,ne.statistics.totalUsers=e.totalUsers,ne.rankData||(ne.rankData={}),ne.rankData.rankPercent=e.rankPercent,ne.rankData.totalUsers=e.totalUsers,e.ranks&&(ne.rankData.ranks=e.ranks,console.log("[Main] ✅ ranks 对象已注入:",e.ranks)),e.personality?(ne.personality=e.personality,console.log("[Main] ✅ personality 对象已注入:",e.personality),e.personality.detailedStats&&Array.isArray(e.personality.detailedStats)?(ne.detailedStats=e.personality.detailedStats,ne.personality.detailedStats=e.personality.detailedStats,console.log("[Main] ✅ 从 personality.detailedStats 读取数据:",e.personality.detailedStats),e.personality.detailedStats.length>0&&(re&&"function"==typeof re.updateV6UI?(re.updateV6UI({detailedStats:e.personality.detailedStats}),console.log("[Main] ✅ 已调用 updateV6UI 更新维度 UI")):console.warn("[Main] ⚠️ vibeCodingApp 或 updateV6UI 方法不存在"))):console.warn("[Main] ⚠️ personality.detailedStats 不存在或不是数组")):e.detailedStats&&(ne.detailedStats=e.detailedStats,console.log("[Main] ⚠️ 使用降级路径：从 liveRank.detailedStats 读取数据")),console.log("[Main] 真实排名数据已获取并覆盖:",{rankPercent:e.rankPercent,totalUsers:e.totalUsers,hasRanks:!!e.ranks,hasPersonality:!!e.personality,hasDetailedStats:!(!(null==(t=e.personality)?void 0:t.detailedStats)&&!e.detailedStats),detailedStatsPath:(null==(n=e.personality)?void 0:n.detailedStats)?"personality.detailedStats":e.detailedStats?"detailedStats":"none"}))}catch(a){console.error("[Main] uploadToSupabase 调用失败:",a)}}return document.getElementById("vibeCodingerSection")&&tt(),ne}catch(o){console.warn("[Main] 异步分析失败，使用同步方法:",o);let t=1;if(ee&&ee.earliestFileTime){const e=Date.now()-ee.earliestFileTime;t=Math.max(1,Math.floor(e/864e5))}const n=re?await re.generateContext():{lang:e,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"};if(n.lang=e,ne=await te.analyzeSync(X,n.lang||e,null),ne&&ne.statistics){ne.statistics.qingCount=(null==ee?void 0:ee.qingCount)||0,ne.statistics.buCount=(null==ee?void 0:ee.buCount)||0,ne.statistics.usageDays=t;try{"undefined"!=typeof navigator&&/^zh-(CN|TW)$/i.test(navigator.language)&&(te.countryCode="CN",te.forceCnIdentity=!0);const e=await te.uploadToSupabase(ne,X);try{(null==e?void 0:e.claim_token)&&localStorage.setItem("vibe_claim_token",e.claim_token)}catch{}if(e&&e.globalAverage){const t=e.globalAverage;50===t.L&&50===t.P&&50===t.D&&50===t.E&&50===t.F?console.warn("[Main] ⚠️ uploadToSupabase 返回的全局平均值是默认值（同步方法），忽略"):(oe=t,se=!0,console.log("[Main] ✅ 从 uploadToSupabase 获取到全局平均值（同步方法）:",oe))}e&&void 0!==e.rankPercent&&(ne.statistics.rankPercent=e.rankPercent,ne.statistics.totalUsers=e.totalUsers,ne.rankData||(ne.rankData={}),ne.rankData.rankPercent=e.rankPercent,ne.rankData.totalUsers=e.totalUsers,e.ranks&&(ne.rankData.ranks=e.ranks,console.log("[Main] ✅ ranks 对象已注入（同步方法）:",e.ranks)),console.log("[Main] 真实排名数据已获取并覆盖（同步方法）:",{rankPercent:e.rankPercent,totalUsers:e.totalUsers,hasRanks:!!e.ranks}))}catch(a){console.error("[Main] uploadToSupabase 调用失败（同步方法）:",a)}}return document.getElementById("vibeCodingerSection")&&tt(),ne}},Me=async e=>{var t,n,a,o;let s=e||window.vibeResult||globalThis.vibeResult;if(s&&!s.rankData&&ne&&ne.rankData){var i=s.identityLevelCloud||(null==(t=s.statistics)?void 0:t.identityLevelCloud)||(null==(n=s.stats)?void 0:n.identityLevelCloud);i&&"object"==typeof i&&(ne.identityLevelCloud=i,ne.statistics&&(ne.statistics.identityLevelCloud=i),ne.stats&&(ne.stats.identityLevelCloud=i),window.vibeResults=ht(i),s=ne)}if(s){window.vibeResult=s,ne=s;const e=(null==s?void 0:s.identityLevelCloud)||(null==(a=null==s?void 0:s.statistics)?void 0:a.identityLevelCloud)||(null==(o=null==s?void 0:s.stats)?void 0:o.identityLevelCloud);var r=function(e){return Array.isArray(e)?e.length:e&&"object"==typeof e?Object.keys(e).length:0};console.log("[Main] identityLevelCloud 数据:",{hasIlc:!!e,noviceKeys:e?r(e.Novice):0,professionalKeys:e?r(e.Professional):0,architectKeys:e?r(e.Architect):0,nativeKeys:e&&Array.isArray(e.native)?e.native.length:0}),e&&"object"==typeof e?(window.vibeResults=ht(e),console.log("[Main] vibeResults 已生成:",{Novice:window.vibeResults.Novice.length,Professional:window.vibeResults.Professional.length,Architect:window.vibeResults.Architect.length,native:window.vibeResults.native?window.vibeResults.native.length:0}),yt(ae||"Novice")):console.warn("[Main] identityLevelCloud 数据不存在，词云将无法渲染"),console.log("[Main] ✅ 已更新全局 vibeResult:",{hasPersonalityName:!!s.personalityName,hasRoastText:!!s.roastText,hasDimensions:!!s.dimensions,hasAnalysis:!!s.analysis,hasSemanticFingerprint:!!s.semanticFingerprint,dimensionsKeys:s.dimensions?Object.keys(s.dimensions):null})}if(console.log("[Main] renderFullDashboard 被调用"),console.log("[Main] 数据状态:",{hasGlobalStats:!!ee,hasVibeResult:!!s,chatDataLength:X.length}),function(){if(console.log("[Main] 更新元素引用..."),Ne.totalConversations=document.getElementById("totalConversations"),Ne.userMessages=document.getElementById("userMessages"),Ne.qingCount=document.getElementById("qingCount"),Ne.buCount=document.getElementById("buCount"),Ne.totalUserChars=document.getElementById("totalUserChars"),Ne.avgUserMessageLength=document.getElementById("avgUserMessageLength"),Ne.questionMessageCount=document.getElementById("questionMessageCount"),Ne.topChineseWordsList=document.getElementById("topChineseWordsList"),De.searchInput=document.getElementById("searchInput"),De.chatList=document.getElementById("chatList"),De.paginationContainer=document.getElementById("paginationContainer"),De.paginationInfo=document.getElementById("paginationInfo"),De.paginationPages=document.getElementById("paginationPages"),De.paginationPrev=document.getElementById("paginationPrev"),De.paginationNext=document.getElementById("paginationNext"),De.exportBtn=document.getElementById("exportBtn"),console.log("[Main] 元素引用更新完成:",{totalConversations:!!Ne.totalConversations,userMessages:!!Ne.userMessages,qingCount:!!Ne.qingCount,buCount:!!Ne.buCount,chatList:!!De.chatList}),De.searchInput){const e=De.searchInput,t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),De.searchInput=t;const n=Qe(Ze,300);De.searchInput.addEventListener("input",n),console.log("[Main] ✅ 搜索框事件已重新绑定")}else console.warn("[Main] ⚠️ searchInput 元素未找到，无法绑定事件");De.paginationPrev&&De.paginationPrev.addEventListener("click",()=>{Ie>1&&(Ie--,Ge(Ee))});De.paginationNext&&De.paginationNext.addEventListener("click",()=>{const e=Math.ceil(Ee.length/Le);Ie<e&&(Ie++,Ge(Ee))})}(),ee&&(console.log("[Main] 调用 displayStats..."),qe()),s){console.log("[Main] 调用 displayVibeCodingerAnalysis..."),tt();try{await async function(e){const t=e||window.vibeResult||globalThis.vibeResult;try{if(!t||!ee)return void console.warn("[Main] displayRealtimeStats: 缺少必要数据",{hasVibeResult:!!t,hasGlobalStats:!!ee});const e=window.shareModeStats||window.shareModeVibeResult;let o;try{if(e){const e=parseInt(localStorage.getItem("totalTestUsers")||"0");o=e>0?e:1e3,console.log("[Main] 分享模式：使用缓存的 totalTestUsers:",o)}else o=await ct()}catch(n){console.error("[Main] 获取测试总人数失败，使用默认值:",n),o=1e3}const s=o;let i=null,r=0;try{if(t&&t.rankData){const e=t.rankData,n=e.ranking??e.rankPercent??null;if(null!=n){const e=Number(n);isNaN(e)||(e>=0&&e<=100?i=e:e>0&&o>0&&(i=(o-e)/o*100))}if(null!==i&&!isNaN(i)&&i>=0&&i<=100){console.log("[Main] 使用后端返回的真实排名:",i);const e=i/100;r=Math.max(1,Math.round(o*(1-e)))}else console.warn("[Main] 警告：排名数据格式异常或无效，将显示为 0",{rankPercent:i,rankingValue:n,rankData:t.rankData}),i=null,r=0}else{const e=async(e=2500)=>{const n=Date.now();for(;Date.now()-n<e;){try{if(t&&t.rankData)return t.rankData}catch{}await new Promise(e=>setTimeout(e,120))}return null},n=await e();if(n){const e=n.ranking??n.rankPercent??null,t=Number(e);if(!isNaN(t)&&(t>=0&&t<=100?i=t:t>0&&o>0&&(i=(o-t)/o*100),null!=i&&!isNaN(i)&&i>=0&&i<=100)){const e=i/100;r=Math.max(1,Math.round(o*(1-e)))}console.log("[Main] displayRealtimeStats: 等待到 rankData，跳过二次上报",{hasRankData:!0})}else console.warn("[Main] displayRealtimeStats: 未拿到 rankData（已禁止二次上报），降级显示 0"),i=null,r=0}}catch(a){console.warn("[Main] 处理排名数据时发生错误，将显示为 0:",a),i=null,r=0}const l=243,c=1,d=Math.round(c/l*100),u=document.getElementById("totalTestUsers"),g=document.getElementById("techRank"),h=document.getElementById("personalityUnlock");if(u&&(s!==o?at(u,o,He):u.textContent=He(o)),g&&(null!=r&&!isNaN(r)&&r>=0?at(g,r,He):(console.warn("[Main] 排名数据无效，将显示为 0"),at(g,0,He))),h){const e=`${d}%`;h.textContent!==e?at(h,d,e=>`${e}%`):h.textContent=e}console.log("[Main] 实时统计已更新:",{totalTestUsers:o,techRank:r,unlockProgress:`${d}%`})}catch(a){console.error("[Main] displayRealtimeStats 执行失败，但不影响后续逻辑:",a)}}(s)}catch(l){console.error("[Main] 统计上传失败:",l)}try{!function(){if(!ne||!ne.dimensions)return;const e=document.getElementById("dimensionRankingList");if(!e)return;const{dimensions:t}=ne,n=le(),a=Object.entries(t).map(([e,t])=>{var a,o,s,i;const r=null==(s=null==(o=null==(a=window.i18n)?void 0:a.getI18nText(n))?void 0:o.dimensions)?void 0:s[e];return{key:e,label:(null==r?void 0:r.label)||(null==(i=U[e])?void 0:i.label)||e,value:t,displayValue:"E"===e?t:Math.round(t)}}).sort((e,t)=>{const n="E"===e.key?10*e.value:e.value;return("E"===t.key?10*t.value:t.value)-n});e.innerHTML=a.map((e,t)=>{var a,o;const s=t+1,i=1===s?"🥇":2===s?"🥈":3===s?"🥉":`#${s}`,r="E"===e.key?10:100,l=Math.min(100,Math.round(e.value/r*100)),c="E"===e.key?(null==(a=window.i18n)?void 0:a.getText("dashboard.techUnit",n))||"种技术":(null==(o=window.i18n)?void 0:o.getText("dashboard.pointsUnit",n))||"分";return`\n      <div class="prompt-item" style="background: ${s<=3?"rgba(0, 255, 65, 0.1)":"rgba(255, 255, 255, 0.03)"}; border-color: ${s<=3?"rgba(0, 255, 65, 0.3)":"var(--card-border)"};">\n        <span class="prompt-rank" style="font-size: 20px; min-width: 50px;">${i}</span>\n        <span class="prompt-text" style="flex: 1; font-weight: 600;">${e.label}</span>\n        <div style="display: flex; align-items: center; gap: 12px;">\n          <div style="width: 120px; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">\n            <div style="width: ${l}%; height: 100%; background: var(--accent-terminal); transition: width 0.5s ease;"></div>\n          </div>\n          <span class="prompt-count" style="min-width: 80px; text-align: right; font-weight: 700; color: var(--accent-terminal);">${e.displayValue} ${c}</span>\n        </div>\n      </div>\n    `}).join(""),console.log("[Main] 维度排行榜已渲染:",a)}()}catch(l){console.error("[Main] displayDimensionRanking 调用失败:",l)}}X.length>0&&(console.log("[Main] 渲染对话列表..."),Ie=1,Ge(X)),console.log("[Main] 渲染词云..."),ft(),function(){if(gt)return;gt=!0,document.addEventListener("click",function(e){const t=e.target&&e.target.closest&&e.target.closest(".identity-level-btn");if(!t)return;const n=document.getElementById("identity-level-tabs");if(!n||!n.contains(t))return;const a=t.getAttribute("data-level");a&&(ae=a,n.querySelectorAll(".identity-level-btn").forEach(function(e){e.classList.remove("active","bg-[var(--accent-terminal)]/20","text-[var(--accent-terminal)]"),e.classList.add("text-zinc-400")}),t.classList.add("active","bg-[var(--accent-terminal)]/20","text-[var(--accent-terminal)]"),t.classList.remove("text-zinc-400"),yt(a))})}(),console.log("[Main] renderFullDashboard 完成")};const xe=async()=>(Q||(console.log("[Main] 初始化解析器（模块模式）..."),Q=new l,await Q.init(),te=Z(),console.log("[Main] 解析器初始化完成")),{parser:Q,vibeAnalyzer:te});let Ie=1,Le=20,Ee=[],Pe=!1,Te=!1;const De={uploadSection:document.getElementById("uploadSection"),loadingSection:document.getElementById("loadingSection"),dashboardSection:document.getElementById("dashboardSection"),uploadBtn:document.getElementById("uploadBtn"),selectFolderBtn:document.getElementById("selectFolderBtn"),folderInput:document.getElementById("folderInput"),fileInput:document.getElementById("fileInput"),exportBtn:document.getElementById("exportBtn"),selectFileBtn:document.getElementById("selectFileBtn"),uploadError:document.getElementById("uploadError"),loadingProgress:document.getElementById("loadingProgress"),exportArea:document.getElementById("exportArea"),searchInput:document.getElementById("searchInput"),chatList:document.getElementById("chatList"),paginationContainer:document.getElementById("paginationContainer"),paginationInfo:document.getElementById("paginationInfo"),paginationPages:document.getElementById("paginationPages"),paginationPrev:document.getElementById("paginationPrev"),paginationNext:document.getElementById("paginationNext")},Ne={totalConversations:document.getElementById("totalConversations"),userMessages:document.getElementById("userMessages"),qingCount:document.getElementById("qingCount"),buCount:document.getElementById("buCount"),topChineseWordsList:document.getElementById("topChineseWordsList"),totalUserChars:document.getElementById("totalUserChars"),avgUserMessageLength:document.getElementById("avgUserMessageLength"),questionMessageCount:document.getElementById("questionMessageCount")};async function Re(){console.log("[Main] ===== 应用初始化开始 ====="),console.log("[Main] 当前时间:",(new Date).toISOString()),"loading"===document.readyState&&(console.log("[Main] 等待 DOM 加载..."),await new Promise(e=>{document.addEventListener("DOMContentLoaded",e)})),console.log("[Main] DOM 已就绪，开始获取元素..."),De.uploadSection=document.getElementById("uploadSection"),De.loadingSection=document.getElementById("loadingSection"),De.dashboardSection=document.getElementById("dashboardSection"),De.uploadBtn=document.getElementById("uploadBtn"),De.selectFolderBtn=document.getElementById("selectFolderBtn"),De.folderInput=document.getElementById("folderInput"),De.fileInput=document.getElementById("fileInput"),De.exportBtn=document.getElementById("exportBtn"),De.selectFileBtn=document.getElementById("selectFileBtn"),De.uploadError=document.getElementById("uploadError"),De.loadingProgress=document.getElementById("loadingProgress"),De.exportArea=document.getElementById("exportArea"),De.searchInput=document.getElementById("searchInput"),De.chatList=document.getElementById("chatList"),De.paginationContainer=document.getElementById("paginationContainer"),De.paginationInfo=document.getElementById("paginationInfo"),De.paginationPages=document.getElementById("paginationPages"),De.paginationPrev=document.getElementById("paginationPrev"),De.paginationNext=document.getElementById("paginationNext"),console.log("[Main] 初始化 CursorParser..."),Q=new l,await Q.init(),console.log("[Main] CursorParser 初始化完成"),console.log("[Main] 初始化 VibeCodingerAnalyzer..."),te=new K,console.log("[Main] VibeCodingerAnalyzer 初始化完成");try{const e=await J();te&&"function"==typeof te.setLevelKeywords&&(te.setLevelKeywords(e),console.log("[Main] ✅ 身份级别词库已注入:",{N:e&&e.Novice?e.Novice.length:0,P:e&&e.Professional?e.Professional.length:0,A:e&&e.Architect?e.Architect.length:0}))}catch(e){console.warn("[Main] 身份级别词库加载失败:",e)}console.log("[Main] 初始化 VibeCodingApp..."),re=new Y,re.parser=Q,re.analyzer=te,console.log("[Main] VibeCodingApp 初始化完成"),console.log("[Main] 开始获取全局平均值..."),it().then(e=>{50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?(console.warn("[Main] ⚠️ 获取到的数据是默认值，可能 API 请求失败"),se=!1):(oe=e,se=!0,console.log("[Main] ✅ 全局平均值已从 API 成功加载:",oe)),ne&&window.vibeRadarChartInstance&&(console.log("[Main] 更新已渲染的雷达图..."),nt())}).catch(e=>{console.error("[Main] ❌ 获取全局平均值失败:",e),se=!1,console.log("[Main] 使用默认全局平均值:",oe)}),function(){console.log("[Main] 开始绑定事件..."),De.uploadBtn?(console.log("[Main] ✅ uploadBtn 元素已找到"),De.uploadBtn.addEventListener("click",e=>{console.log("[Main] 点击上传按钮"),e.preventDefault(),Ue(De.folderInput)})):console.error("[Main] ❌ uploadBtn 元素未找到");De.selectFolderBtn?(console.log("[Main] ✅ selectFolderBtn 元素已找到"),De.selectFolderBtn.addEventListener("click",e=>{console.log("[Main] 点击选择文件夹按钮"),e.preventDefault(),Ue(De.folderInput)})):console.error("[Main] ❌ selectFolderBtn 元素未找到");De.selectFileBtn?(console.log("[Main] ✅ selectFileBtn 元素已找到"),De.selectFileBtn.addEventListener("click",e=>{console.log("[Main] 点击选择文件按钮"),e.preventDefault(),Ue(De.fileInput)})):console.error("[Main] ❌ selectFileBtn 元素未找到");De.folderInput?(console.log("[Main] ✅ folderInput 元素已找到"),De.folderInput.addEventListener("change",e=>{if(Te||Pe)return console.warn("[Main] ⚠️ 正在分析中，忽略重复请求"),void(e.target.value="");console.log("[Main] 文件夹选择事件触发"),$e(e,"folder")})):console.error("[Main] ❌ folderInput 元素未找到");De.fileInput?(console.log("[Main] ✅ fileInput 元素已找到"),De.fileInput.addEventListener("change",e=>{if(Te||Pe)return console.warn("[Main] ⚠️ 正在分析中，忽略重复请求"),void(e.target.value="");console.log("[Main] 文件选择事件触发"),$e(e,"file")})):console.error("[Main] ❌ fileInput 元素未找到");function e(e){De.selectFolderBtn&&(De.selectFolderBtn.disabled=e,e?(De.selectFolderBtn.style.opacity="0.5",De.selectFolderBtn.style.cursor="not-allowed"):(De.selectFolderBtn.style.opacity="1",De.selectFolderBtn.style.cursor="pointer")),De.uploadBtn&&(De.uploadBtn.disabled=e,e?(De.uploadBtn.style.opacity="0.5",De.uploadBtn.style.cursor="not-allowed"):(De.uploadBtn.style.opacity="1",De.uploadBtn.style.cursor="pointer"))}if(window.updateUploadButtonsState=e,De.searchInput){const e=Qe(Ze,300);De.searchInput.addEventListener("input",e),console.log("[Main] ✅ 搜索框事件已绑定")}else console.warn("[Main] ⚠️ searchInput 元素未找到，可能 DOM 尚未加载");De.paginationPrev&&De.paginationPrev.addEventListener("click",()=>{Ie>1&&(Ie--,Ge(Ee))});De.paginationNext&&De.paginationNext.addEventListener("click",()=>{const e=Math.ceil(Ee.length/Le);Ie<e&&(Ie++,Ge(Ee))});De.exportBtn&&De.exportBtn.addEventListener("click",Je);console.log("[Main] 事件绑定完成")}(),console.log("[Main] ===== 应用初始化完成 =====")}function Ue(e){if(console.log("[Main] 尝试触发文件选择..."),console.log("[Main] inputElement:",e),console.log("[Main] inputElement.type:",null==e?void 0:e.type),e)try{if(e.value="",e.click)e.click();else{const t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});e.dispatchEvent(t)}console.log("[Main] ✅ 文件选择已触发")}catch(t){console.error("[Main] ❌ 触发文件选择失败:",t),alert("无法打开文件选择对话框，请检查浏览器设置或刷新页面重试。")}else console.error("[Main] ❌ inputElement 为 null")}async function $e(e,t,n={}){var a,o,s,i,r,l,c,d,u;if(Pe||Te)return console.warn("[Main] ⚠️ 正在处理中，忽略重复请求",{isProcessing:Pe,isAnalyzing:Te}),void(e&&e.target&&(e.target.value=""));window.updateUploadButtonsState&&window.updateUploadButtonsState(!0);try{"undefined"!=typeof window&&(window.__vibeSubmitted=!1,window.__vibeLastUploadResult=null)}catch(x){}const{onProgress:g,onLog:h,onComplete:p,onError:m}=n;console.log(`[Main] 处理文件上传，类型: ${t}`),console.log(`[Main] event.files.length: ${null==(a=e.target.files)?void 0:a.length}`);const y=Array.from(e.target.files||[]);if(n&&n.onLog||De.uploadError&&(De.uploadError.classList.add("hidden"),De.uploadError.textContent=""),0===y.length)return console.warn("[Main] 没有选择文件"),void((null==n?void 0:n.onError)&&n.onError(new Error("没有选择文件")));if(console.log(`[Main] 选择了 ${y.length} 个文件`),console.log("[Main] 文件列表:"),y.forEach((e,t)=>{console.log(`  [${t+1}] ${e.name} (${function(e){if(0===e)return"0 B";const t=1024,n=["B","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,a)*100)/100+" "+n[a]}(e.size)})`)}),n&&n.onLog){if(n.onLog){const e=le(),t=(null==(o=window.i18n)?void 0:o.getText("upload.logs.startProcessing",e))||"开始处理文件...";n.onLog(`> ${t}`)}}else ze();try{let e=[],a=[];if("folder"===t){if(e=y.filter(e=>"state.vscdb"===e.name),a=y.filter(e=>"state.vscdb"!==e.name),console.log(`[Main] 文件夹模式：找到 ${e.length} 个 state.vscdb 文件`),a.length>0&&(console.log(`[Main] 已过滤 ${a.length} 个非数据库文件`),a.length<=10&&console.log("[Main] 过滤的文件:",a.map(e=>e.name))),0===e.length){const e=a.slice(0,5).map(e=>e.name).join(", "),t=0===a.length?"未找到 state.vscdb 文件，请选择正确的 Cursor workspaceStorage 目录":`未找到 state.vscdb 文件。选中的文件包括：${e}${a.length>5?"...":""}`;throw new Error(t)}}else{const t=[".vscdb",".db",".sqlite",".sqlite3"];if(e=y.filter(e=>t.some(t=>e.name.toLowerCase().endsWith(t))),a=y.filter(e=>!t.some(t=>e.name.toLowerCase().endsWith(t))),console.log(`[Main] 单文件模式：找到 ${e.length} 个数据库文件`),a.length>0&&(console.log(`[Main] 已过滤 ${a.length} 个非数据库文件`),console.log("[Main] 过滤的文件:",a.map(e=>e.name))),0===e.length){const e=a.slice(0,3).map(e=>e.name).join(", "),t=0===a.length?"未找到有效的数据库文件（.vscdb, .db, .sqlite, .sqlite3）":`未找到有效的数据库文件。选择的是：${e}${a.length>3?"...":""}，请选择数据库文件`;throw new Error(t)}}let o=null;if(y.length>0){for(const e of y)e.lastModified&&(null===o||e.lastModified<o)&&(o=e.lastModified);console.log("[Main] 最早文件时间:",o?new Date(o).toISOString():"未找到")}ee={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},chineseEmotionWords:{},englishWords:{},earliestFileTime:o,userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}},X=[];let m=0;for(const t of e)try{ke;const a=await t.arrayBuffer();await Q.loadDatabase(a);const o=await Q.scanDatabase();if(X=X.concat(o),je(ee,Q.stats),m++,n&&n.onLog||Ve(m,e.length),g&&g(m,e.length,t.name),h){const n=le(),a=((null==(s=window.i18n)?void 0:s.getText("upload.logs.processed",n))||"已处理 {current}/{total}: {fileName}").replace("{current}",m).replace("{total}",e.length).replace("{fileName}",t.name);h(`> ${a}`)}m%5==0&&await new Promise(e=>setTimeout(e,0))}catch(I){console.error(`[Main] 处理文件失败: ${t.name}`,I)}if(console.log(`[Main] 总共提取 ${X.length} 条对话记录`),0===X.length)throw Pe=!1,new Error("未找到任何对话数据，请检查数据库文件是否正确");if(console.log("[Main] 开始重新计算统计（包括词云数据）..."),h){const e=le(),t=(null==(i=window.i18n)?void 0:i.getText("upload.logs.calculatingStats",e))||"计算统计数据...";h(`> ${t}`)}if(await new Promise(e=>setTimeout(e,10)),function(e){console.log("[Main] 开始计算统计，数据量:",e.length);const t=performance.now(),n=(null==ee?void 0:ee.earliestFileTime)||null;ee={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},chineseEmotionWords:{},englishWords:{},totalCodeChars:0,earliestFileTime:n,userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}};const a=e.length;for(let s=0;s<a;s++){const t=e[s];"USER"===t.role?ee.userMessages++:(ee.aiMessages++,ee.totalConversations++),t.text&&t.text.length>0&&"USER"!==t.role&&Be(t.text);const n=t.model||"unknown";ee.modelUsage[n]=(ee.modelUsage[n]||0)+1,t.timestamp&&We(t.timestamp),"USER"===t.role&&t.text&&Fe(t.text)}ee.userMessages>0&&(ee.userBehaviorStats.avgUserMessageLength=Math.round(ee.userBehaviorStats.totalUserChars/ee.userMessages));const o=performance.now();console.log("[Main] 统计计算完成，耗时:",Math.round(o-t),"ms",{totalConversations:ee.totalConversations,userMessages:ee.userMessages,aiMessages:ee.aiMessages,totalCodeChars:ee.totalCodeChars,totalUserChars:ee.userBehaviorStats.totalUserChars,avgUserMessageLength:ee.userBehaviorStats.avgUserMessageLength,qingCount:ee.qingCount,buCount:ee.buCount,modelUsageCount:Object.keys(ee.modelUsage).length,topPromptsCount:Object.keys(ee.topPrompts).length,hourlyNonZero:ee.hourlyActivity.filter(e=>e>0).length,dailyCount:Object.keys(ee.dailyActivity).length,chineseWordsCount:Object.keys(ee.chineseWords||{}).length,englishWordsCount:Object.keys(ee.englishWords||{}).length})}(X),X.length>0){if(console.log("[Main] 开始 Vibe Codinger 人格分析（使用 VibeCodingApp）..."),h){const e=le(),t=(null==(r=window.i18n)?void 0:r.getText("upload.logs.generatingPersonality",e))||"生成人格画像（高性能匹配中）...";h(`> ${t}`)}try{re||(re=new Y,await re.init()),re.analyzer=te;let e=1;if(ee&&ee.earliestFileTime){const t=Date.now(),n=t-ee.earliestFileTime;e=Math.max(1,Math.floor(n/864e5))}const t=ee?{qingCount:ee.qingCount||0,buCount:ee.buCount||0,usageDays:e}:null,a=e=>{h&&h(`> ${e}`),n&&n.onLog||ze(e)};Pe=!0,Te=!0,Pe=!0;for(var f=0,b=0;b<X.length;b++){var v=X[b]&&(X[b].text||X[b].content||"");f+=v?String(v).length:0}if(!(f>5e4)||n&&n.onLog||ze("en"===le()?"Deep analysis in progress (large dataset)...":"正在深度体检中（数据量较大）..."),ne=await re.analyzeFile(X,t,a,{deferGlobalSync:!1}),console.log("[Main] Vibe Codinger 分析完成（使用 VibeCodingApp）:",ne),Te=!1,Pe=!1,n&&n.onLog||Oe(),h){const e=le(),t=(null==(l=window.i18n)?void 0:l.getText("upload.logs.analysisComplete",e))||"分析完成！";h(`> ${t}`)}}catch(I){if(console.error("[Main] Vibe Codinger 分析失败，使用降级方案:",I),h){const e=le(),t=(null==(c=window.i18n)?void 0:c.getText("upload.logs.analysisFailed",e))||"分析失败，使用降级方案...";h(`> ${t}`)}Te=!1,Pe=!1;try{Te=!0,Pe=!0,re||(re=new Y,await re.init()),re.analyzer=te;let e=1;if(ee&&ee.earliestFileTime){const t=Date.now(),n=t-ee.earliestFileTime;e=Math.max(1,Math.floor(n/864e5))}const t=ee?{qingCount:ee.qingCount||0,buCount:ee.buCount||0,usageDays:e}:null,a=e=>{h&&h(`> ${e}`),n&&n.onLog||ze(e)};if(ne=await re.analyzeFileSync(X,t,a,{deferGlobalSync:!1}),console.log("[Main] Vibe Codinger 分析完成（使用 VibeCodingApp 同步方法）:",ne),Te=!1,Pe=!1,n&&n.onLog||Oe(),h){const e=le(),t=(null==(d=window.i18n)?void 0:d.getText("upload.logs.analysisComplete",e))||"分析完成！";h(`> ${t}`)}}catch(L){if(console.error("[Main] 同步方法也失败:",L),Te=!1,Pe=!1,h){const e=le(),t=(null==(u=window.i18n)?void 0:u.getText("upload.logs.analysisFailed",e))||"分析失败";h(`> ${t}`)}}}}if(ne){if(Xe(ne.roastText?String(ne.roastText):"")){var w=(ne.vibeIndex||ne.vibe_index||"").toString().slice(0,5),C=le(),S="en"===C;try{var k=S?"src/roastLibrary2.json":"src/roastLibrary.json",_=await fetch(k);if(_.ok){var A=await _.json();A&&A[w]&&(ne.roastText=A[w],console.log("[Main] 已从 roastLibrary 补全人格预览吐槽文案，vibeIndex:",w))}}catch(E){console.warn("[Main] 从 roastLibrary 补全吐槽文案失败:",E)}Xe(ne.roastText)&&(ne.roastText=et(ne.dimensions,C),console.log("[Main] roastLibrary 无命中，已使用 dimensions 动态文案保底"))}try{console.log("[Main] finalVibePayload (传入预览)",{vibeIndex:ne.vibeIndex,roastTextLen:(ne.roastText||"").length,hasDimensions:!!ne.dimensions})}catch(x){}}p?p({stats:ee,chatData:X,vibeResult:ne}):(!function(){console.log("[Main] 显示分析结果..."),De.uploadSection&&De.uploadSection.classList.add("hidden");De.loadingSection&&De.loadingSection.classList.add("hidden");De.dashboardSection&&(De.dashboardSection.classList.remove("hidden"),De.dashboardSection.style.display="block");document.querySelectorAll(".stats-grid").forEach(e=>{e.classList.remove("hidden"),e.style.display="grid"});const e=document.querySelector(".wordcloud-section");e&&(e.classList.remove("hidden"),e.style.display="grid");document.querySelectorAll(".chart-card").forEach(e=>{e.classList.contains("hidden")||"techStackSection"===e.id||(e.style.display="block")});const t=document.querySelector(".chat-list-section");t&&(t.style.display="block");console.log("[Main] ✅ 分析结果已显示")}(),qe(),ne&&tt(),Ie=1,Ge(X),De.searchInput&&X&&X.length>0&&console.log("[Main] ✅ 数据加载完成，搜索功能已就绪，共",X.length,"条记录"))}catch(I){console.error("[Main] 处理失败:",I),Te=!1,Pe=!1,m?m(I):(M=I.message,console.error("[Main] 上传错误:",M),De.uploadError&&(De.uploadError.textContent=M,De.uploadError.classList.remove("hidden")),Oe())}finally{Te=!1,Pe=!1,window.updateUploadButtonsState&&window.updateUploadButtonsState(!1),e&&e.target&&(e.target.value="")}var M}function je(e,t){e.totalConversations+=t.totalConversations,e.userMessages+=t.userMessages,e.aiMessages+=t.aiMessages,e.qingCount=(e.qingCount||0)+(t.qingCount||0),e.buCount=(e.buCount||0)+(t.buCount||0),t.userBehaviorStats&&(e.userBehaviorStats=e.userBehaviorStats||{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,codeKeywordCount:0,modifyKeywordCount:0},e.userBehaviorStats.totalUserChars+=t.userBehaviorStats.totalUserChars||0,e.userBehaviorStats.questionMessageCount+=t.userBehaviorStats.questionMessageCount||0,e.userBehaviorStats.codeKeywordCount+=t.userBehaviorStats.codeKeywordCount||0,e.userBehaviorStats.modifyKeywordCount+=t.userBehaviorStats.modifyKeywordCount||0,t.userBehaviorStats.techStack&&(e.userBehaviorStats.techStack=e.userBehaviorStats.techStack||{},Object.entries(t.userBehaviorStats.techStack).forEach(([t,n])=>{e.userBehaviorStats.techStack[t]=(e.userBehaviorStats.techStack[t]||0)+n})),e.userMessages>0&&(e.userBehaviorStats.avgUserMessageLength=Math.round(e.userBehaviorStats.totalUserChars/e.userMessages)));for(const[n,a]of Object.entries(t.modelUsage))e.modelUsage[n]=(e.modelUsage[n]||0)+a;for(let n=0;n<24;n++)e.hourlyActivity[n]+=t.hourlyActivity[n];for(const[n,a]of Object.entries(t.dailyActivity))e.dailyActivity[n]=(e.dailyActivity[n]||0)+a;for(const[n,a]of Object.entries(t.topPrompts))e.topPrompts[n]=(e.topPrompts[n]||0)+a;for(const[n,a]of Object.entries(t.topChineseWords||{}))e.topChineseWords=e.topChineseWords||{},e.topChineseWords[n]=(e.topChineseWords[n]||0)+a;if(t.chineseWords){e.chineseWords=e.chineseWords||{};for(const[n,a]of Object.entries(t.chineseWords))e.chineseWords[n]=(e.chineseWords[n]||0)+a}if(t.englishWords){e.englishWords=e.englishWords||{};for(const[n,a]of Object.entries(t.englishWords))e.englishWords[n]=(e.englishWords[n]||0)+a}}function Be(e){const t=e.match(/```[\s\S]*?```/g);t&&t.forEach(e=>{const t=e.replace(/```[\w]*\n?/g,"").replace(/```/g,"").length;t>0&&(ee.totalCodeChars+=t)});const n=e.match(/`[^`\n]+`/g);if(n&&n.forEach(e=>{const t=e.replace(/`/g,"").length;t>0&&(ee.totalCodeChars+=t)}),!t&&!n){let t=0;for(const n of Ce)n.test(e)&&t++;for(const n of Se)if(e.includes(n)){t+=2;break}if(t>=3){const t=/\b(function|class|const|let|var|def |func |fn |import |#include|public|private)\b/i,n=e.match(t);if(n&&void 0!==n.index){const t=n.index,a=Math.min(t+5e3,e.length),o=Math.round(.7*(a-t));ee.totalCodeChars+=o}}}}function We(e){try{const t=new Date(e),n=t.getHours();ee.hourlyActivity[n]++;const a=t.toISOString().split("T")[0];ee.dailyActivity[a]=(ee.dailyActivity[a]||0)+1}catch(t){}}function Fe(e){const t=e.length;ee.userBehaviorStats.totalUserChars+=t,(e.includes("?")||e.includes("？"))&&ee.userBehaviorStats.questionMessageCount++;const n=e.match(/请/g);n&&(ee.qingCount+=n.length);const a=e.match(/不/g);a&&(ee.buCount+=a.length),function(e){const t=/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g,n=e.match(t)||[];n.forEach(e=>{if(e.length<2)return;if(e.length>20)return;const t=e.toLowerCase();we.has(t)||(ee.topPrompts[t]=(ee.topPrompts[t]||0)+1)})}(e),function(e){if(!e||0===e.length)return;const t=/[\u4e00-\u9fa5]{2,}/g,n=e.match(t)||[];ee.topChineseWords=ee.topChineseWords||{},n.forEach(e=>{if(e.length>10)return;const t=e.trim();be.has(t)||(ee.topChineseWords[t]=(ee.topChineseWords[t]||0)+1)})}(e),function(e){if(!e||0===e.length)return;if(!ee)return;ee.chineseWords=ee.chineseWords||{},ee.chineseEmotionWords=ee.chineseEmotionWords||{},ee.englishWords=ee.englishWords||{};const t=e.match(/[\u4e00-\u9fa5]/g)||[],n=t.length;for(let i=0;i<n-1;i++){const e=t[i],a=t[i+1];if(be.has(e)&&be.has(a))continue;const o=e+a;if(be.has(o)||(ee.chineseWords[o]=(ee.chineseWords[o]||0)+1,(ut.positive.has(o)||ut.negative.has(o))&&(ee.chineseEmotionWords[o]=(ee.chineseEmotionWords[o]||0)+2)),i<n-2){const e=t[i+2],n=o+e;be.has(n)||be.has(e)||(ee.chineseWords[n]=(ee.chineseWords[n]||0)+1)}if(i<n-3&&i%5==0){const e=o+t[i+2]+t[i+3];ee.chineseWords[e]=(ee.chineseWords[e]||0)+1}}const a=e.match(/\b[a-zA-Z]{2,20}\b/g)||[],o=[];for(const i of a){const e=i.toLowerCase();ve.has(e)||(ee.englishWords[e]=(ee.englishWords[e]||0)+1,o.push(e))}const s=o.length;for(let i=0;i<s-1;i++){const e=o[i]+" "+o[i+1];ee.englishWords[e]=(ee.englishWords[e]||0)+1}}(e)}function ze(e=null){console.log("[Main] 显示加载状态...",e||""),De.uploadSection.classList.add("hidden"),De.loadingSection.classList.remove("hidden"),De.dashboardSection.classList.add("hidden"),e&&De.loadingProgress&&(De.loadingProgress.textContent=e),console.log("[Main] ✅ 加载状态已显示")}function Oe(){De.loadingSection&&De.loadingSection.classList.add("hidden")}function Ve(e,t){const n=`已处理 ${e}/${t} 个文件`;De.loadingProgress&&(De.loadingProgress.textContent=n),console.log(`[Main] ${n}`)}function qe(){var e;console.log("[Main] 开始显示统计信息...");try{const t={totalConversations:ee.totalConversations,totalCodeChars:ee.totalCodeChars,modelUsage:ee.modelUsage,userMessages:ee.userMessages,qingCount:ee.qingCount||0,buCount:ee.buCount||0,topChineseWordsList:Ke(ee.topChineseWords,10)};console.log("[Main] 统计数据:",{totalConversations:t.totalConversations,totalCodeChars:t.totalCodeChars,userMessages:t.userMessages,qingCount:t.qingCount,buCount:t.buCount,topChineseWordsList:(null==(e=t.topChineseWordsList)?void 0:e.length)||0}),console.log('[Main] ✅ "请"字次数:',t.qingCount),console.log('[Main] ✅ "不"字次数:',t.buCount);let n=0;if(ee.earliestFileTime){const e=Date.now(),t=ee.earliestFileTime,a=e-t;n=Math.floor(a/864e5),console.log("[Main] 使用时长计算:",{earliestTime:new Date(t).toISOString(),nowTime:new Date(e).toISOString(),diffMs:a,usageDays:n})}if(Ne.totalConversations&&(Ne.totalConversations.textContent=He(n)),Ne.qingCount&&(Ne.qingCount.textContent=He(t.qingCount)),Ne.buCount&&(Ne.buCount.textContent=He(t.buCount)),Ne.userMessages&&(Ne.userMessages.textContent=He(t.userMessages)),ee.userBehaviorStats){const e=ee.userBehaviorStats;Ne.totalUserChars&&(Ne.totalUserChars.textContent=He(e.totalUserChars||0)),Ne.avgUserMessageLength&&(Ne.avgUserMessageLength.textContent=He(e.avgUserMessageLength||0));const t=document.getElementById("questionCard");t&&e.questionMessageCount>0&&(t.style.display="",Ne.questionMessageCount&&(Ne.questionMessageCount.textContent=He(e.questionMessageCount))),function(e){const t=document.getElementById("techStackSection"),n=document.getElementById("techStackList");if(!t||!n)return;const a=Object.entries(e);if(0===a.length)return void(t.style.display="none");const o=a.sort((e,t)=>t[1]-e[1]).slice(0,10);if(0===o.length)return void(t.style.display="none");t.style.display="",n.innerHTML=o.map(([e,t],n)=>`\n    <div class="prompt-item">\n      <span class="prompt-rank">#${n+1}</span>\n      <span class="prompt-text">${Ye(e)}</span>\n      <span class="prompt-count">${t} 次</span>\n    </div>\n  `).join("")}(e.techStack||{})}console.log("[Main] 准备渲染词云，数据状态:",{chineseWords:Object.keys(ee.chineseWords||{}).length,englishWords:Object.keys(ee.englishWords||{}).length}),ft(),console.log("[Main] 开始渲染用户提问最多汉字词组..."),function(e){console.log("[Main] 开始渲染用户提问最多汉字词组...");const t=Ne.topChineseWordsList||document.getElementById("topChineseWordsList");if(!t)return void console.warn("[Main] topChineseWordsList 容器未找到");if(!e||0===e.length)return t.innerHTML='\n      <div class="prompt-item">\n        <span class="prompt-text">暂无汉字词组数据</span>\n        <span class="prompt-count">0 次</span>\n      </div>\n    ',void console.log("[Main] 没有汉字词组数据");console.log(`[Main] 共有 ${e.length} 个汉字词组`),e.forEach((e,t)=>{console.log(`  #${t+1} "${e.word}" ${e.count} 次`)}),t.innerHTML=e.map((e,t)=>`\n    <div class="prompt-item">\n      <span class="prompt-rank">#${t+1}</span>\n      <span class="prompt-text">${Ye(e.word)}</span>\n      <span class="prompt-count">${e.count} 次</span>\n    </div>\n  `).join(""),console.log("[Main] ✅ 汉字词组渲染完成")}(t.topChineseWordsList),console.log("[Main] ✅ 统计信息显示完成")}catch(t){throw console.error("[Main] ❌ 显示统计信息失败:",t),t}}function He(e,t=null){if("number"!=typeof e||isNaN(e))return"0";t||(t=le());return"en"===t?e>=1e12?(e/1e12).toFixed(1)+"T":e>=1e9?(e/1e9).toFixed(1)+"B":e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString():e>=1e12?(e/1e12).toFixed(1)+"万亿":e>=1e11?(e/1e11).toFixed(1)+"千亿":e>=1e10?(e/1e10).toFixed(1)+"百亿":e>=1e8?(e/1e8).toFixed(1)+"亿":e>=1e7?(e/1e7).toFixed(1)+"千万":e>=1e6?(e/1e6).toFixed(1)+"百万":e>=1e4?(e/1e4).toFixed(1)+"万":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}function Ke(e,t=10){const n=Object.entries(e||{});return 0===n.length?[]:n.sort((e,t)=>t[1]-e[1]).slice(0,t).map(([e,t])=>({word:e,count:t}))}function Ge(e){console.log(`[Main] 渲染对话列表，共 ${e.length} 条记录`),Ee=e;const t=De.chatList,n=Math.ceil(e.length/Le);Ie>n&&n>0&&(Ie=n),Ie<1&&(Ie=1);const a=(Ie-1)*Le,o=a+Le,s=e.slice(a,o);if(console.log(`[Main] 显示第 ${Ie}/${n} 页，共 ${s.length} 条记录`),0===s.length)return t.innerHTML='\n      <div class="chat-item-more">\n        暂无对话记录\n      </div>\n    ',void(De.paginationContainer&&(De.paginationContainer.style.display="none"));try{t.innerHTML=s.map((e,t)=>{if(!e)return console.warn(`[Main] item ${t} 为 null，跳过`),"";const n=e.text||"",a=e.role||"AI",o=e.timestamp||(new Date).toISOString();return 0===n.length?(console.warn(`[Main] item ${t} 的文本为空，跳过`),""):`\n        <div class="chat-item">\n          <div class="chat-item-header">\n            <span class="chat-role ${"USER"===a?"role-user":"role-ai"}">\n              <span style="color: var(--accent-terminal);">${"USER"===a?">":"$"}</span> ${a}\n            </span>\n            <span class="chat-time">${function(e){const t=new Date(e);return t.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}(o)}</span>\n          </div>\n          <div class="chat-item-content">\n            <p>${Ye(n.substring(0,200))}${n.length>200?"...":""}</p>\n          </div>\n        </div>\n      `}).join(""),function(e,t){var n;if(!De.paginationContainer||!De.paginationInfo||!De.paginationPages)return;if(t<=1)return void(De.paginationContainer.style.display="none");De.paginationContainer.style.display="flex";const a=(Ie-1)*Le+1,o=Math.min(Ie*Le,e),s=le(),i=(null==(n=window.i18n)?void 0:n.getText("chatList.paginationInfo",s))||"第 {currentPage} 页，共 {totalPages} 页（共 {totalItems} 条记录，显示 {startItem}-{endItem} 条）";De.paginationInfo.textContent=i.replace("{currentPage}",Ie).replace("{totalPages}",t).replace("{totalItems}",e).replace("{startItem}",a).replace("{endItem}",o),De.paginationPrev&&(De.paginationPrev.disabled=1===Ie);De.paginationNext&&(De.paginationNext.disabled=Ie===t);const r=De.paginationPages;r.innerHTML="";let l=Math.max(1,Ie-2),c=Math.min(t,Ie+2);Ie<=3&&(c=Math.min(5,t));Ie>=t-2&&(l=Math.max(1,t-4));if(l>1){const e=document.createElement("button");if(e.className="pagination-page-btn",e.textContent="1",e.addEventListener("click",()=>{Ie=1,Ge(Ee)}),r.appendChild(e),l>2){const e=document.createElement("span");e.className="pagination-ellipsis",e.textContent="...",r.appendChild(e)}}for(let d=l;d<=c;d++){const e=document.createElement("button");e.className="pagination-page-btn",d===Ie&&e.classList.add("active"),e.textContent=d,e.addEventListener("click",()=>{Ie=d,Ge(Ee)}),r.appendChild(e)}if(c<t){if(c<t-1){const e=document.createElement("span");e.className="pagination-ellipsis",e.textContent="...",r.appendChild(e)}const e=document.createElement("button");e.className="pagination-page-btn",e.textContent=t,e.addEventListener("click",()=>{Ie=t,Ge(Ee)}),r.appendChild(e)}}(e.length,n),console.log("[Main] ✅ 对话列表渲染完成")}catch(i){console.error("[Main] ❌ 渲染对话列表失败:",i),t.innerHTML=`\n      <div class="chat-item-more">\n        对话列表加载失败：${i.message}\n      </div>\n    `,De.paginationContainer&&(De.paginationContainer.style.display="none")}}function Ze(e){if(!e||!e.target)return void console.warn("[Main] ⚠️ handleSearch 事件对象无效");const t=e.target.value.trim();if(console.log("[Main] 🔍 搜索触发:",{keyword:t,allChatDataLength:(null==X?void 0:X.length)||0,filteredChatDataLength:(null==Ee?void 0:Ee.length)||0,allChatDataExists:!!X,isArray:Array.isArray(X)}),Ie=1,!t){const e=X&&X.length>0?X:Ee;return console.log("[Main] 🔍 清空搜索，显示所有数据:",e.length,"条"),void Ge(e)}const n=X&&X.length>0?X:Ee;if(!n||!Array.isArray(n)||0===n.length)return console.warn("[Main] ⚠️ 搜索数据源为空，无法执行搜索"),void Ge([]);const a=t.toLowerCase();let o=0;const s=n.filter((e,t)=>{var n,s;if(!e)return!1;const i=e.text||e.content||(null==(n=e.message)?void 0:n.text)||(null==(s=e.message)?void 0:s.content)||"";if(!i||"string"!=typeof i)return!1;const r=i.toLowerCase().includes(a);return r&&o<3&&(console.log(`[Main] 🔍 匹配项 ${o+1}:`,{index:t,textPreview:i.substring(0,50)+"...",role:e.role||"unknown"}),o++),r});console.log(`[Main] 🔍 搜索关键词: "${t}", 从 ${n.length} 条记录中找到 ${s.length} 条匹配记录`),0===s.length&&(console.log("[Main] 🔍 未找到匹配记录，可能的原因："),console.log("  - 关键词拼写错误"),console.log("  - 数据源为空或格式不正确"),console.log("  - 文本字段不存在"),n.length>0&&console.log("[Main] 🔍 数据源示例（前3条）:",n.slice(0,3).map((e,t)=>({index:t,hasText:!!e.text,hasContent:!!e.content,hasMessage:!!e.message,textPreview:(e.text||e.content||"").substring(0,30),keys:Object.keys(e)})))),Ge(s)}async function Je(){const e=De.exportArea;try{let t=document.querySelector('[data-v6-key="answer_text"]'),n=t&&t.textContent&&""!==t.textContent.trim();if(!n){console.log("[Main] ⏳ 等待后端数据（答案之书文案）...");De.exportBtn.innerHTML;De.exportBtn.innerHTML='<span class="btn-icon">⏳</span><span>等待数据中...</span>',De.exportBtn.disabled=!0;let e=0;const a=50;for(;!n&&e<a;)if(await new Promise(e=>setTimeout(e,100)),e++,t=document.querySelector('[data-v6-key="answer_text"]'),n=t&&t.textContent&&""!==t.textContent.trim(),n){console.log("[Main] ✅ 后端数据已就绪");break}e>=a&&console.warn("[Main] ⚠️ 等待后端数据超时，继续导出（可能缺少答案之书文案）")}const a=De.exportBtn.innerHTML;De.exportBtn.innerHTML='<span class="btn-icon">⏳</span><span>生成中...</span>',De.exportBtn.disabled=!0,await new Promise(e=>setTimeout(e,200)),re&&ne&&ne.stats&&("function"==typeof re.renderBehaviorTags&&re.renderBehaviorTags(ne.stats,"behavior-tags-container"),"function"==typeof re.syncGlobalStats&&re.globalStatsCache&&re.syncGlobalStats(re.globalStatsCache)),await new Promise(e=>setTimeout(e,100));const o=window.html2canvas||globalThis.html2canvas;if(!o)throw new Error("html2canvas 未加载，请确保 CDN 资源已正确加载");const s=await o(e,{backgroundColor:"#ffffff",scale:2,useCORS:!0,logging:!1}),i=document.createElement("a");i.download=`cursor-audit-${(new Date).getTime()}.png`,i.href=s.toDataURL("image/png"),i.click(),De.exportBtn.innerHTML=a,De.exportBtn.disabled=!1,console.log("[Main] 导出成功")}catch(t){console.error("[Main] 导出失败:",t),alert("导出失败: "+t.message),De.exportBtn.innerHTML='<span class="btn-icon">📊</span><span>晒出cursor受虐证据</span>',De.exportBtn.disabled=!1}}function Ye(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Qe(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...a)},t)}}function Xe(e){if(null==e||""===String(e).trim())return!0;var t=String(e);return!!/正在生成中|正在由后端生成|personality combination is so unique that even our AI needs more time/i.test(t)||!(!/索引\s*\d+\s*对应的吐槽文案(正在由后端生成中|未找到)/.test(t)||!/人格组合太独特/.test(t))}function et(e,t){if(!e||"object"!=typeof e)return"en"===t?"A developer with a unique vibe.":"一位风格鲜明的开发者。";var n="en"===t?{L:"Logic",P:"Patience",D:"Detail",E:"Exploration",F:"Feedback"}:{L:"逻辑",P:"耐性",D:"细节",E:"探索",F:"反馈"},a=Object.entries(e).filter(function(e){return e[0]&&null!=n[e[0]]}).map(function(e){return{key:e[0],value:Number(e[1])||0}});a.sort(function(e,t){return t.value-e.value});var o=a.slice(0,2);return 0===o.length?"en"===t?"A developer with a unique vibe.":"一位风格鲜明的开发者。":1===o.length?"en"===t?"A developer strong in "+n[o[0].key]+".":"一位极具"+n[o[0].key]+"的代码架构师。":"en"===t?"A developer with strong "+n[o[0].key]+" and "+n[o[1].key].toLowerCase()+".":"一位极具"+n[o[0].key]+"且"+(o[1].value>=70?"极度":"较为")+n[o[1].key]+"的代码架构师。"}function tt(){var e;if(fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2179",message:"displayVibeCodingerAnalysis called",data:{vibeResultExists:!!ne,vibeResultKeys:ne?Object.keys(ne):null},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),!ne)return void fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2180",message:"vibeResult is null/undefined, returning early",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{});const t=document.getElementById("vibeCodingerSection")||document.getElementById("personality-lock");if(fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2183",message:"container lookup",data:{containerFound:!!t,containerId:null==t?void 0:t.id,hasVibeCodingerSection:!!document.getElementById("vibeCodingerSection"),hasPersonalityLock:!!document.getElementById("personality-lock")},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"})}).catch(()=>{}),!t)return void fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2184",message:"container not found, returning early",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"})}).catch(()=>{});const{personalityType:n,dimensions:a,analysis:o,semanticFingerprint:s,statistics:i,vibeIndex:r,roastText:l,personalityName:c,stats:d}=ne;try{var u={dimensions:a,vibeIndex:r,roastText:l?String(l).substring(0,80)+(l.length>80?"...":""):"",personalityName:c,detailedStats:(null==(e=ne.personality)?void 0:e.detailedStats)||ne.detailedStats||[]};console.log("[Main] finalVibePayload",u)}catch(y){}var g=l;Xe(g)&&(g=et(a,le()),ne&&(ne.roastText=g),console.log("[Main] interpretation/roastText 无效，已触发 fallbackInterpretation:",g.substring(0,50)+"..."));let h=ne.lpdef;if(!h&&a&&te&&"function"==typeof te.generateLPDEF)try{h=te.generateLPDEF(a),console.log("[Main] ✅ 从 analyzer.generateLPDEF 获取 LPDEF:",h)}catch(f){console.warn("[Main] generateLPDEF 调用失败:",f),h="L0P0D0E0F0"}else h||(h="L0P0D0E0F0");let p=s;if((!p||!p.codeRatio||!p.patienceLevel)&&(console.log("[Main] ⚠️ semanticFingerprint 不完整，使用前端生成"),a&&te&&"function"==typeof te.generateSemanticFingerprint))try{p=te.generateSemanticFingerprint(a),console.log("[Main] ✅ 从 analyzer.generateSemanticFingerprint 获取完整语义指纹")}catch(f){console.warn("[Main] generateSemanticFingerprint 调用失败:",f)}p||(p={codeRatio:"0%",patienceLevel:"N/A",detailLevel:"N/A",techExploration:"N/A",feedbackDensity:"0%",compositeScore:0,techDiversity:"N/A",interactionStyle:"N/A"});const m=d||i||{};m.ketao_count||m.qingCount,m.jiafang_count||m.buCount,m.work_days||m.usageDays;t.innerHTML=`\n    <div class="vibe-header">\n      <h2 class="vibe-title">${ce("vibeCodinger.title")}</h2>\n      <div class="vibe-badge" style="background: transparent; border: 2px solid var(--accent-terminal);">\n        <span class="vibe-type">${n}</span>\n        <span class="vibe-name">${c||o.name}</span>\n      </div>\n      <p class="vibe-description">${o.description}</p>\n    </div>\n\n    \x3c!-- 新增：人格头衔和吐槽区域 --\x3e\n    <div class="vibe-roast-section">\n      <div class="roast-header">\n        <h3 class="roast-title">${ce("vibeCodinger.roastTitle")}</h3>\n        <div class="personality-title">${(e=>{var t,n,a,o,s,i;const r="en"===le()?null==(a=null==(n=null==(t=window.i18n)?void 0:t.getI18nText("en"))?void 0:n.vibeCodinger)?void 0:a.personalityTitles:null==(i=null==(s=null==(o=window.i18n)?void 0:o.getI18nText("zh-CN"))?void 0:s.vibeCodinger)?void 0:i.personalityTitles;if(!r){return`${"2"===e[0]?"硬核":"1"===e[0]?"标准":"随性"}·${"2"===e[1]?"耐心":"1"===e[1]?"平衡":"急躁"}·${"2"===e[2]?"细节控":"1"===e[2]?"适中":"极简"}·${"2"===e[3]?"探索者":"1"===e[3]?"观望":"守旧"}·${"2"===e[4]?"暖男":"1"===e[4]?"职业":"冷酷"}`}return`${"2"===e[0]?r.l[2]:"1"===e[0]?r.l[1]:r.l[0]}·${"2"===e[1]?r.p[2]:"1"===e[1]?r.p[1]:r.p[0]}·${"2"===e[2]?r.d[2]:"1"===e[2]?r.d[1]:r.d[0]}·${"2"===e[3]?r.e[2]:"1"===e[3]?r.e[1]:r.e[0]}·${"2"===e[4]?r.f[2]:"1"===e[4]?r.f[1]:r.f[0]}`})(r)}</div>\n        <div class="vibe-index">${"en"===le()?`${ce("vibeCodinger.lpdef")}: ${h||"N/A"}`:`${ce("vibeCodinger.index")}: ${r} | ${ce("vibeCodinger.lpdef")}: ${h||"N/A"}`}</div>\n      </div>\n      <div class="roast-content">\n        <p class="roast-text">${g}</p>\n      </div>\n      <div class="dimension-tags">\n        ${(e=>{const t=[],n=le();return Object.entries(e).forEach(([e,a])=>{var o,s,i,r,l,c,d,u,g,h;let p;const m=null==(i=null==(s=null==(o=window.i18n)?void 0:o.getI18nText(n))?void 0:s.dimensions)?void 0:i[e];p="E"===e?a<5?(null==(r=null==m?void 0:m.levels)?void 0:r.low)||"低":a<10?(null==(l=null==m?void 0:m.levels)?void 0:l.medium)||"中":(null==(c=null==m?void 0:m.levels)?void 0:c.high)||"高":a<40?(null==(d=null==m?void 0:m.levels)?void 0:d.low)||"低":a<70?(null==(u=null==m?void 0:m.levels)?void 0:u.medium)||"中":(null==(g=null==m?void 0:m.levels)?void 0:g.high)||"高";const y=(null==m?void 0:m.label)||(null==(h=window.i18n)?void 0:h.getText(`dimensions.${e}.label`,n))||U[e].label;t.push(`${y}:${p}`)}),t})(a).map(e=>`\n          <span class="dimension-tag">${e}</span>\n        `).join("")}\n      </div>\n    </div>\n\n    <div class="vibe-dimensions">\n      <h3 class="dimensions-title">${ce("vibeCodinger.dimensionsTitle")}</h3>\n      ${Object.entries(a).map(([e,t])=>{var n,a,s,i,r,l,c,d,u;const g=((null==(n=ne.personality)?void 0:n.detailedStats)||ne.detailedStats||[]).find(t=>t.dimension===e);let h=g&&g.roast||o.dimensions&&o.dimensions[e]&&o.dimensions[e].interpretation||"";Xe(h)&&(h="en"===le()?e+" dimension: "+(t>=70?"high":t>=40?"medium":"low"):e+"维度"+(t>=70?"表现突出":t>=40?"中等水平":"有待提升"),"undefined"!=typeof console&&console.log&&console.log("[Main] 维度 "+e+" interpretation 为空或占位，已使用 fallback"));const p=g?{level:g.label||"未知",interpretation:h||"暂无吐槽文案"}:o.dimensions&&o.dimensions[e]?{level:o.dimensions[e].level||"未知",interpretation:h||"暂无吐槽文案"}:{level:"未知",interpretation:h||"暂无吐槽文案"},m=t,y=(null==(r=null==(i=null==(s=null==(a=window.i18n)?void 0:a.getI18nText(le()))?void 0:s.dimensions)?void 0:i[e])?void 0:r.label)||U[e].label,f=(null==(u=null==(d=null==(c=null==(l=window.i18n)?void 0:l.getI18nText(le()))?void 0:c.dimensions)?void 0:d[e])?void 0:u.description)||U[e].description;return`\n          <div class="dimension-card" data-v6-dim="${e}">\n            <div class="dimension-header">\n              <span class="dimension-key">${e}</span>\n              <span class="dimension-label">${y}</span>\n              <span class="dimension-value">${t}</span>\n              <span class="dimension-level rank-label">${p.level}</span>\n            </div>\n            <div class="dimension-bar-container">\n              <div class="dimension-bar" style="width: ${m}%; background: var(--accent-terminal)"></div>\n            </div>\n            <p class="dimension-interpretation roast-text">${p.interpretation}</p>\n            <p class="dimension-desc">${f}</p>\n          </div>\n        `}).join("")}\n    </div>\n\n    <div class="vibe-traits" id="personality-traits" style="scroll-margin-top: 80px;">\n      <h3 class="traits-title">${ce("vibeCodinger.traitsTitle")}</h3>\n      <div class="traits-list">\n        ${o.traits.map(e=>`\n          <div class="trait-tag">${e}</div>\n        `).join("")}\n      </div>\n    </div>\n\n    <div class="vibe-fingerprint" id="semantic-fingerprint" style="scroll-margin-top: 80px;">\n      <h3 class="fingerprint-title">${ce("vibeCodinger.fingerprintTitle")}</h3>\n      <div class="fingerprint-grid">\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ce("fingerprint.codeRatio")}</span>\n          <span class="fingerprint-value">${p.codeRatio||"N/A"}</span>\n          ${p.codeRatioDesc?`<span class="fingerprint-desc">${p.codeRatioDesc}</span>`:""}\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ce("fingerprint.patienceLevel")}</span>\n          <span class="fingerprint-value">${p.patienceLevel||"N/A"}</span>\n          ${p.patienceLevelDesc?`<span class="fingerprint-desc">${p.patienceLevelDesc}</span>`:""}\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ce("fingerprint.detailLevel")}</span>\n          <span class="fingerprint-value">${p.detailLevel||"N/A"}</span>\n          ${p.detailLevelDesc?`<span class="fingerprint-desc">${p.detailLevelDesc}</span>`:""}\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ce("fingerprint.techExploration")}</span>\n          <span class="fingerprint-value">${p.techExploration||"N/A"}</span>\n          ${p.techExplorationDesc?`<span class="fingerprint-desc">${p.techExplorationDesc}</span>`:""}\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ce("fingerprint.feedbackDensity")}</span>\n          <span class="fingerprint-value">${p.feedbackDensity||"N/A"}</span>\n          ${p.feedbackDensityDesc?`<span class="fingerprint-desc">${p.feedbackDensityDesc}</span>`:""}\n        </div>\n        ${void 0!==p.compositeScore?`\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ce("fingerprint.score")}</span>\n          <span class="fingerprint-value">${p.compositeScore}</span>\n          ${p.compositeScoreDesc?`<span class="fingerprint-desc">${p.compositeScoreDesc}</span>`:""}\n        </div>\n        `:""}\n        ${p.techDiversity?`\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ce("fingerprint.diversity")}</span>\n          <span class="fingerprint-value">${p.techDiversity}</span>\n          ${p.techDiversityDesc?`<span class="fingerprint-desc">${p.techDiversityDesc}</span>`:""}\n        </div>\n        `:""}\n        ${p.interactionStyle?`\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ce("fingerprint.style")}</span>\n          <span class="fingerprint-value">${p.interactionStyle}</span>\n          ${p.interactionStyleDesc?`<span class="fingerprint-desc">${p.interactionStyleDesc}</span>`:""}\n        </div>\n        `:""}\n      </div>\n    </div>\n\n\n    \x3c!-- 【V6 UI 渲染引擎升级】稳定性勋章 --\x3e\n    ${void 0!==(null==m?void 0:m.balance_score)?`\n    <div class="balance-score-section" id="balance-score-section" style="scroll-margin-top: 80px; margin-top: 20px;">\n      <h3 class="balance-score-title">${"en"===le()?"Personality Stability":"人格稳定性"}</h3>\n      <div class="balance-score-progress-container">\n        <div class="balance-score-progress-bar" style="width: ${Math.min(100,Math.max(0,m.balance_score||0))}%; background: linear-gradient(90deg, var(--accent-terminal), #4CAF50); height: 30px; border-radius: 15px; transition: width 0.5s ease;">\n          <span class="balance-score-text" style="line-height: 30px; padding: 0 15px; color: white; font-weight: bold;">\n            ${Math.round(m.balance_score||0)}%\n          </span>\n        </div>\n      </div>\n    </div>\n    `:""}\n\n    <div class="vibe-chart-container" id="radar-chart" style="scroll-margin-top: 80px;">\n      <h3 class="chart-title">${ce("vibeCodinger.chartTitle")}</h3>\n      <div class="chart-wrapper">\n        <canvas id="vibeRadarChart"></canvas>\n      </div>\n    </div>\n  `,setTimeout(()=>{re&&"function"==typeof re.renderBehaviorTags&&re.renderBehaviorTags(m,"behavior-tags-container")},100),setTimeout(()=>{re&&"function"==typeof re.renderBehaviorTags&&re.renderBehaviorTags(m,"behavior-tags-container")},100),se||ie?nt():(console.log("[Main] 渲染前检测到全局平均值未加载，先获取数据..."),ie=!0,it().then(e=>{50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F||(oe=e,se=!0,console.log("[Main] ✅ 渲染前获取全局平均值成功:",oe)),ie=!1,nt()}).catch(e=>{console.error("[Main] ❌ 渲染前获取全局平均值失败:",e),ie=!1,nt()}))}function nt(){var e,t;fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2370",message:"renderVibeRadarChart called",data:{hasVibeResult:!!ne,hasWindowChart:!!window.Chart,hasGlobalChart:!!globalThis.Chart,chartType:typeof(window.Chart||globalThis.Chart)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{});const n=window.Chart||globalThis.Chart;if(!ne||!n)return fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2373",message:"Chart.js not loaded or vibeResult missing",data:{hasVibeResult:!!ne,hasChart:!!n},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),void console.warn("[Main] Chart.js 未加载，无法渲染雷达图");const a=document.getElementById("vibeRadarChart");if(fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2378",message:"canvas lookup",data:{canvasFound:!!a,canvasId:null==a?void 0:a.id},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),!a)return void fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2379",message:"canvas not found, returning early",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{});const{dimensions:o}=ne,s=a.getContext("2d");window.vibeRadarChartInstance&&window.vibeRadarChartInstance.destroy(),se||ie||(console.log("[Main] 雷达图渲染时检测到数据未加载，尝试重新获取..."),ie=!0,it().then(e=>{50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?(console.warn("[Main] ⚠️ 重新获取的数据仍是默认值"),se=!1):(oe=e,se=!0,console.log("[Main] ✅ 重新获取全局平均值成功:",oe),nt()),ie=!1}).catch(e=>{console.error("[Main] ❌ 重新获取全局平均值失败:",e),se=!1,ie=!1}));50===oe.L&&50===oe.P&&50===oe.D&&50===oe.E&&50===oe.F&&!se&&(console.warn("[Main] ⚠️ 雷达图使用默认全局平均值，API 数据可能未加载成功"),console.log("[Main] 当前 globalAverageData:",oe),console.log("[Main] 当前 globalAverageDataLoaded:",se));const i=oe||ne.globalAverage||{L:50,P:50,D:50,E:50,F:50};console.log("[Main] 雷达图使用的全局平均值:",{source:se?"API":ne.globalAverage?"vibeResult":"default",data:i}),o.E,i.E;const r=le(),l=["L","P","D","E","F"].map(e=>{var t,n,a,o;const s=null==(a=null==(n=null==(t=window.i18n)?void 0:t.getI18nText(r))?void 0:n.dimensions)?void 0:a[e];return`${(null==s?void 0:s.label)||(null==(o=U[e])?void 0:o.label)||e} (${e})`}),c=(null==(e=window.i18n)?void 0:e.getText("dashboard.radarChart.yourScore",r))||"你的得分",d=(null==(t=window.i18n)?void 0:t.getText("dashboard.radarChart.globalAverage",r))||"全网平均";window.vibeRadarChartInstance=new n(s,{type:"radar",data:{labels:l,datasets:[{label:c,data:[o.L,o.P,o.D,o.E,o.F],backgroundColor:"rgba(0, 255, 65, 0.2)",borderColor:"rgba(0, 255, 65, 1)",borderWidth:2,pointBackgroundColor:"rgba(0, 255, 65, 1)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgba(0, 255, 65, 1)",pointRadius:5,pointHoverRadius:7},{label:d,data:[i.L,i.P,i.D,i.E,i.F],backgroundColor:"rgba(113, 113, 122, 0.1)",borderColor:"rgba(113, 113, 122, 0.5)",borderWidth:1.5,borderDash:[5,5],pointBackgroundColor:"rgba(113, 113, 122, 0.5)",pointBorderColor:"rgba(113, 113, 122, 0.8)",pointHoverBackgroundColor:"rgba(113, 113, 122, 0.8)",pointHoverBorderColor:"rgba(113, 113, 122, 1)",pointRadius:3,pointHoverRadius:5}]},options:{responsive:!0,maintainAspectRatio:!0,layout:{padding:{top:20,bottom:20,left:20,right:20}},scales:{r:{beginAtZero:!0,max:100,ticks:{stepSize:20,display:!1},grid:{color:"rgba(0, 255, 65, 0.1)"},pointLabels:{font:{size:12},color:"#ffffff"}}},plugins:{legend:{display:!0,position:"top",labels:{color:"#ffffff",font:{family:"'JetBrains Mono', monospace"}}},tooltip:{callbacks:{label:function(e){return`${e.label}: ${e.parsed.r}分`}}}}}})}function at(e,t,n=e=>e.toString()){if(!e)return;let a=Number(t);(isNaN(a)||null==t)&&(console.warn("[Main] 检测到无效数值，重置为 0"),a=0);const o=parseInt(e.textContent.replace(/[^0-9]/g,""))||0,s=performance.now(),i=t=>{const r=t-s,l=Math.min(r/1500,1),c=Math.floor(o+(a-o)*((d=l)*(2-d)));var d;try{e.textContent=n(c)}catch(u){e.textContent=c.toString()}l<1&&requestAnimationFrame(i)};requestAnimationFrame(i)}const ot="https://cursor-clinical-analysis.psterman.workers.dev/";function st(){if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return console.log("[Main] 从 window 对象获取 API 端点:",e),e;const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim(),n=e.endsWith("/")?e:e+"/";return console.log("[Main] 从 meta 标签获取 API 端点:",n),n}}return console.log("[Main] 使用默认 API 端点:",ot),ot}async function it(){const e={L:50,P:50,D:50,E:50,F:50};try{const n=st();let a=n.endsWith("/")?`${n}api/global-average`:`${n}/api/global-average`;try{const e=String(localStorage.getItem("anchored_country")||"").trim().toUpperCase()||String(localStorage.getItem("selected_country")||"").trim().toUpperCase();/^[A-Z]{2}$/.test(e)&&(a+=`?country_code=${encodeURIComponent(e)}`)}catch(t){}console.log("[Main] 开始获取全局平均值，URL:",a);const o=await fetch(a,{method:"GET",headers:{"Content-Type":"application/json"},mode:"cors",credentials:"omit"});if(!o.ok){const t=await o.text().catch(()=>"无法读取错误信息");return console.error("[Main] ❌ API 请求失败:",{status:o.status,statusText:o.statusText,error:t}),e}const s=await o.json();if(console.log("[Main] API 返回数据:",s),"success"===s.status&&s.globalAverage){const e=s.globalAverage;if("number"==typeof e.L&&"number"==typeof e.P&&"number"==typeof e.D&&"number"==typeof e.E&&"number"==typeof e.F)return oe=e,se=!0,console.log("[Main] ✅ 成功获取全局平均值:",e),e;console.warn("[Main] ⚠️ 全局平均值数据格式不正确:",e)}else console.warn("[Main] ⚠️ API 返回状态不是 success 或缺少 globalAverage:",s)}catch(n){console.error("[Main] ❌ 获取全局平均值异常:",{message:n.message,stack:n.stack,name:n.name})}return console.warn("[Main] ⚠️ 使用默认全局平均值"),e}function rt(e){const t=new AbortController,n=setTimeout(()=>t.abort(),e);return"undefined"!=typeof AbortSignal&&AbortSignal.timeout?(clearTimeout(n),AbortSignal.timeout(e)):t.signal}async function lt(e=!1){const t=st();try{const n=await async function(e,t={}){const n={...t,mode:"cors",credentials:"omit",headers:{"Content-Type":"application/json",...t.headers}};console.log("[Main] 发起 CORS 请求:",{url:e,method:n.method||"GET"});try{const t=await fetch(e,n);if(!t.ok&&0===t.status)throw new Error("CORS 错误：无法访问远程 API。请检查 API 端点的 CORS 配置。");return t}catch(a){throw console.error("[Main] CORS 请求失败:",a),a}}(t,{method:e?"POST":"GET",body:e?JSON.stringify({action:"increment",timestamp:Date.now()}):void 0,signal:rt(5e3)});if(n.ok){const t=await n.json(),a=t.value||t.totalUsers||t.total||t.count||null;if(null!==a&&a>=0){console.log(`[Main] ${e?"POST":"GET"} 请求成功，数字:`,a),localStorage.setItem("totalTestUsers",a.toString());const t=document.getElementById("totalTestUsers");return t&&(e?at(t,a,He):t.textContent=He(a)),a}}else console.warn(`[Main] ${e?"POST":"GET"} 请求响应状态码异常:`,n.status)}catch(o){console.warn(`[Main] ${e?"POST":"GET"} 请求失败，使用降级方案:`,o.message)}const n=parseInt(localStorage.getItem("totalTestUsers")||"0"),a=document.getElementById("totalTestUsers");return a&&(a.textContent=He(n)),console.log("[Main] 使用降级值:",n),n}async function ct(){return await lt(!1)}async function dt(){return await lt(!0)}const ut={positive:new Set(["开心","高兴","快乐","愉快","兴奋","满意","满足","喜欢","爱","感谢","谢谢","太好了","完美","优秀","很棒","不错","很好","厉害","赞","棒","赞","成功","顺利","正确","准确","清晰","明白","理解","懂了","好的","可以","惊喜","惊喜","感动","温暖","舒服","轻松","舒服","爽","爽快","太好了","完美","优秀","很棒","不错","很好","厉害","赞","棒"]),negative:new Set(["生气","愤怒","烦躁","焦虑","担心","害怕","恐惧","紧张","压力","累","失望","沮丧","难过","伤心","痛苦","难受","不舒服","不爽","烦","烦人","错误","不对","不对","错了","失败","失败","不行","不能","不可以","不行","困惑","迷茫","不懂","不明白","不清楚","模糊","混乱","乱","糟糕","糟糕","麻烦","困难","难","复杂","复杂","慢","慢","卡","卡顿","崩溃","崩溃","垃圾","差","差劲","烂","烂","破","破","坏","坏","差","差"])};let gt=!1;function ht(e){if(!e||"object"!=typeof e)return{Novice:[],Professional:[],Architect:[],native:[]};const t={Novice:[],Professional:[],Architect:[],native:[]};for(const a of["Novice","Professional","Architect"]){const n=e[a];Array.isArray(n)?t[a]=n.map(function(e){return{word:e.word,count:e.count,source:e.source||a.toLowerCase(),maxInLevel:e.maxInLevel}}):n&&"object"==typeof n&&(t[a]=Object.entries(n).filter(function(e){return e[1]>0}).map(function(e){return{word:e[0],count:e[1],source:a.toLowerCase()}}))}const n=e.native;return Array.isArray(n)&&(t.native=n.map(function(e){return{word:e.word,count:e.count,source:"native"}})),t}function pt(e,t){var n=[],a={};if(!e||"object"!=typeof e||!t||"object"!=typeof t)return{selectedWords:[],representativeWords:{}};for(var o=["Novice","Professional","Architect"],s=0;s<o.length;s++){var i=o[s],r=t[i];if(Array.isArray(r)&&0!==r.length){var l=new Set(r.map(function(e){return String(e||"").trim().toLowerCase()})),c=e[i],d=[];Array.isArray(c)?d=c.map(function(e){var t=null!=e.word?String(e.word):null!=e[0]?String(e[0]):"",n=null!=e.count?Number(e.count):null!=e[1]?Number(e[1]):0;return{word:t.trim(),count:n}}):c&&"object"==typeof c&&(d=Object.entries(c).map(function(e){return{word:String(e[0]).trim(),count:Number(e[1])||0}}));for(var u=null,g=0;g<d.length;g++){var h=d[g].word;h&&(l.has(h.toLowerCase())&&(!u||d[g].count>u.count)&&(u=d[g]))}var p="",m=0;u&&u.word?(p=u.word,m=u.count):("string"!=typeof(p=r[Math.floor(Math.random()*r.length)])&&(p=String(p||"").trim()),m=0),p&&(a[i]=p,n.push({p:p,c:i,v:m}))}}return{selectedWords:n,representativeWords:a}}async function mt(e,t){var n=Array.isArray(e)?e:e&&e.p?[e]:[];if(0!==n.length){var a=function(){if("undefined"==typeof window)return"";var e=window.location.hostname||"";if(e.includes("localhost")||"127.0.0.1"===e)return null!=window.__VIBE_SOUL_API_BASE__&&""!==String(window.__VIBE_SOUL_API_BASE__).trim()?String(window.__VIBE_SOUL_API_BASE__).replace(/\/$/,""):"https://cursor-clinical-analysis.psterman.workers.dev";return""}(),o=a?a+"/api/v2/log-vibe-soul":"/api/v2/log-vibe-soul",s="undefined"!=typeof localStorage&&localStorage.getItem&&localStorage.getItem("user_fingerprint")||"";t&&!/^[A-Za-z]{2}$/.test(String(t))&&(t="");for(var i=0;i<n.length;i++){var r=n[i];if(r&&r.p){var l={p:r.p,c:r.c||"Novice",v:r.v||1,f:s};t&&(l.country=t);try{var c=await fetch(o,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(404===c.status)continue;if(!c.ok){var d=await c.text().catch(function(){return""});console.warn("[Main] 灵魂词上报失败:",c.status,r.p,d);continue}"success"===(await c.json().catch(function(){return{}})).status&&console.log("[SoulWord] ✅ 已投递:",r.p)}catch(u){console.error("[Main] 灵魂词上报异常:",{url:o,word:r.p,error:(null==u?void 0:u.message)||String(u)})}}}n.length>0&&console.log("[SoulWord] 高频词已上传 "+n.length+" 个，等待 Cron 汇总")}}function yt(e){const t=window.vibeResults;let n=t&&t[e]||[];const a=t&&t.native||[];var o=[];Array.isArray(n)?o=n.map(function(t){return"object"==typeof t&&null!==t?{word:t.word||t[0],count:null!=t.count?t.count:t[1],source:t.source,maxInLevel:t.maxInLevel}:{word:String(t[0]),count:t[1]||1,source:e.toLowerCase(),maxInLevel:null}}):!1===Array.isArray(n)&&n&&"object"==typeof n&&(o=Object.entries(n).filter(function(e){return e[1]>0}).map(function(t){return{word:t[0],count:t[1],source:e.toLowerCase(),maxInLevel:null}})),Array.isArray(a)&&a.length>0&&a.forEach(function(e){o.push({word:e.word||e[0],count:null!=e.count?e.count:e[1]||1,source:"native",maxInLevel:null})});var s=o.reduce(function(e,t){return e+(t.count||0)},0);s<=0&&(s=1);var i=o;console.log("[Main] 渲染身份级别词云 ["+e+"]:",{dataLength:i.length,totalCount:s}),i.length>0&&console.table(i);var r=document.getElementById("identity-cloud-canvas")||document.getElementById("chineseWordCloud");if(r&&"undefined"!=typeof WordCloud){var l=r.parentElement,c=l&&l.offsetWidth?l.offsetWidth:400,d=l&&l.offsetHeight?l.offsetHeight:400;(c<=0||d<=0)&&(c=400,d=400),r.width=c,r.height=d;var u=r.getContext("2d");if(u&&u.clearRect(0,0,c,d),0!==o.length){o.sort(function(e,t){return(t.count||0)-(e.count||0)});var g=o.filter(function(e){return"native"!==e.source}),h=o.filter(function(e){return"native"===e.source}),p=g.length?Math.max.apply(null,g.map(function(e){return e.count||0})):1,m=h.length?Math.max.apply(null,h.map(function(e){return e.count||0})):1,y={},f={};o.forEach(function(t){y[t.word]=t.source||e.toLowerCase()}),o.forEach(function(e){var t="native"===e.source?m:e.maxInLevel||p;t<=0&&(t=1),f[e.word]=(e.count||0)/t});var b={architect:"#5b21b6",professional:"#3b82f6",novice:"#10b981",native:"#9ca3af"},v=o.map(function(e,t){var n=e.count||0,a="native"===e.source?m:e.maxInLevel||p;a<=0&&(a=1);var o=n/a,s=12+68*Math.pow(o,.8);return t<5&&(s*=1.22),String(e.word||"").length>6&&(s*=.82),s=Math.max(12,Math.min(90,s)),[String(e.word||""),s]}).filter(function(e){return e[0].length>0&&e[1]>0});try{WordCloud(r,{list:v,gridSize:4,weightFactor:function(e){return Math.max(12,Math.min(90,e))},fontFamily:'"Microsoft YaHei", "微软雅黑", SimHei, sans-serif',color:function(e){var t=y[e],n=b[t]||"#6b7280",a=null!=f[e]?f[e]:.5;return function(e,t){var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return n?"rgba("+parseInt(n[1],16)+","+parseInt(n[2],16)+","+parseInt(n[3],16)+","+(null!=t?t:1)+")":e}(n,.5+.5*Math.pow(a,.7))},rotateRatio:.6,backgroundColor:"transparent",minSize:12,drawOutOfBound:!1,shrinkToFit:!1,ellipticity:.8})}catch(w){console.warn("[Main] 词云渲染失败:",w)}}else u&&(u.fillStyle="rgba(113, 113, 122, 0.5)",u.font='14px "Microsoft YaHei", "微软雅黑", sans-serif',u.textAlign="center",u.fillText("en"===le()?"No keywords matched":"暂无命中词",c/2,d/2))}else i.length>0&&console.warn("[Main] 有词云数据但 WordCloud canvas 或库未找到，当前页面可能未挂载词云区域")}function ft(){var e,t,n,a;if("undefined"==typeof WordCloud)return void console.warn("[Main] WordCloud库未加载");console.log("[Main] 开始渲染词云...");const o=Object.keys(ee.chineseEmotionWords||{}).length,s=Object.keys(ee.chineseWords||{}).length,i=Object.keys(ee.englishWords||{}).length;console.log("[Main] 情绪类词组数据:",o),console.log("[Main] 中文词组数据:",s),console.log("[Main] 英文词组数据:",i);const r=document.getElementById("identity-cloud-canvas")||document.getElementById("chineseWordCloud");if(r)if(window.vibeResults&&((null==(e=window.vibeResults.Novice)?void 0:e.length)||(null==(t=window.vibeResults.Professional)?void 0:t.length)||(null==(n=window.vibeResults.Architect)?void 0:n.length)))yt(ae),console.log("[Main] ✅ AI功德簿（三身份级别）词云渲染完成");else if(ee.chineseEmotionWords&&0!==o){const e=50,t=120,n=Object.entries(ee.chineseEmotionWords).filter(([e,t])=>t>0&&e.length>=2).sort((e,t)=>t[1]-e[1]),a=Math.max(e,Math.min(t,n.length)),o=n.slice(0,a).map(([e,t])=>[e,t]);if(console.log("[Main] AI情绪词云数据（已排序）:",o.length),o.length>0&&console.log("[Main] AI情绪词云Top 10:",o.slice(0,10).map(([e,t])=>`${e}(${t})`).join(", ")),o.length>0)try{const e=r.parentElement,t=e?e.offsetWidth:400,n=e?e.offsetHeight:400;r.width=t,r.height=n;const a=r.getContext("2d");a&&a.clearRect(0,0,t,n);const s=Math.max(...o.map(([e,t])=>t)),i=["#e74c3c","#f39c12","#e67e22","#c0392b","#d35400","#e74c3c","#f39c12","#9b59b6","#1abc9c","#16a085"],l=function(e,t,n,a,o){const s=Math.floor(Math.random()*i.length);return i[s]};WordCloud(r,{list:o,gridSize:Math.round(Math.max(8,Math.min(12,t/40))),weightFactor:function(e){return 10+Math.sqrt(e)/Math.sqrt(s)*(Math.min(45,t/10)-10)},fontFamily:'"Microsoft YaHei", "微软雅黑", "SimHei", "黑体", sans-serif',color:l,rotateRatio:.6,backgroundColor:"transparent",minSize:10,drawOutOfBound:!1,shrinkToFit:!1,ellipticity:.8}),console.log("[Main] ✅ AI情绪词云渲染完成")}catch(c){console.error("[Main] AI情绪词云渲染失败:",c),console.error("[Main] 错误详情:",c.stack)}else console.warn("[Main] AI情绪词云数据为空（过滤后）")}else{console.warn("[Main] AI功德簿词云数据为空");const e=r.parentElement;if(e){const t=e.querySelector(".wordcloud-container")||e;t&&t.querySelector("canvas")&&(t.innerHTML='<div style="padding: 20px; text-align: center; color: #999;">暂无数据</div>')}}else console.warn("[Main] AI功德簿词云canvas未找到");const l=document.getElementById("englishWordCloud");if(l){const e={};try{const t=ne||window.vibeResult||globalThis.vibeResult;if(t&&t.stats){const n=t.stats.blackword_hits||{},a=n.chinese_slang||{},o=n.english_slang||{},s=[...Object.entries(a).map(([e,t])=>({word:e,count:t,type:"chinese"})),...Object.entries(o).map(([e,t])=>({word:e,count:t,type:"english"}))].reduce((e,{word:t,count:n,type:a})=>(t&&"number"==typeof n&&n>0&&(e[t]=(e[t]||0)+2*n),e),{});Object.entries(s).forEach(([t,n])=>{e[t]=(e[t]||0)+n}),(Object.keys(a).length>0||Object.keys(o).length>0)&&console.log("[Main] ✅ 已合并黑话数据到词云（显式合并）:",{chineseSlang:Object.keys(a).length,englishSlang:Object.keys(o).length,mergedCount:Object.keys(s).length})}}catch(c){console.warn("[Main] 黑话合并失败（已降级）:",c)}try{const t=ne||window.vibeResult||globalThis.vibeResult;if(t&&t.stats){const n=t.stats.tech_stack;if(n){let t=n;if("string"==typeof n)try{t=JSON.parse(n)}catch(d){console.warn("[Main] tech_stack JSON 解析失败:",d),t={}}"object"!=typeof t||null===t||Array.isArray(t)||(Object.entries(t).forEach(([t,n])=>{t&&"number"==typeof n&&n>0&&(e[t]=(e[t]||0)+8*n)}),console.log("[Main] ✅ 已添加 tech_stack 数据到词云，共",Object.keys(t).length,"项技术"))}}}catch(c){console.warn("[Main] 获取 tech_stack 数据时出错（已降级）:",c)}if(Q&&"function"==typeof Q.getTopChineseWords)try{const t=Q.getTopChineseWords(50);t.forEach(({word:t,count:n})=>{t&&n>0&&(ee.chineseEmotionWords&&ee.chineseEmotionWords[t]||(e[t]=(e[t]||0)+5*n))}),console.log("[Main] ✅ 已添加 parser.getTopChineseWords() 数据到词云（权重*5），共",t.length,"个词组")}catch(c){console.warn("[Main] parser.getTopChineseWords() 调用失败:",c),ee.chineseWords&&Object.entries(ee.chineseWords).forEach(([t,n])=>{ee.chineseEmotionWords&&ee.chineseEmotionWords[t]||(e[t]=(e[t]||0)+5*n)})}else ee.chineseWords&&Object.entries(ee.chineseWords).forEach(([t,n])=>{ee.chineseEmotionWords&&ee.chineseEmotionWords[t]||(e[t]=(e[t]||0)+5*n)});ee.englishWords&&Object.entries(ee.englishWords).forEach(([t,n])=>{e[t]=(e[t]||0)+n});if(0===Object.keys(e).length){console.warn("[Main] 合并词云数据为空");const e=l.parentElement;e&&(e.innerHTML='<div style="padding: 20px; text-align: center; color: #999;">暂无词云数据</div>')}else{const t=100,n=200,o=Object.entries(e).filter(([e,t])=>t>0&&e.length>=2).sort((e,t)=>t[1]-e[1]),s=Math.max(t,Math.min(n,o.length)),i=o.slice(0,s).map(([e,t])=>[e,t]);if(console.log("[Main] 合并词云数据（已排序）:",i.length),i.length>0&&console.log("[Main] 合并词云Top 10:",i.slice(0,10).map(([e,t])=>`${e}(${t})`).join(", ")),i.length>0)try{const e=l.parentElement,t=e?e.offsetWidth:400,n=e?e.offsetHeight:400;l.width=t,l.height=n;const o=l.getContext("2d");o&&o.clearRect(0,0,t,n);const s=Math.max(...i.map(([e,t])=>t)),r={};try{const e=ne||window.vibeResult||globalThis.vibeResult;(null==(a=null==e?void 0:e.stats)?void 0:a.tech_stack)&&"object"==typeof e.stats.tech_stack&&Object.keys(e.stats.tech_stack).forEach(e=>{r[e]=!0})}catch(d){console.warn("[Main] 构建 techStackMap 失败:",d)}const c=function(e,t,n,a,o){if(r[e])return"#00D4FF";const s=["#2c3e50","#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#34495e","#16a085"];return s[Math.floor(Math.random()*s.length)]};WordCloud(l,{list:i,gridSize:Math.round(Math.max(6,Math.min(10,t/50))),weightFactor:function(e){return 8+Math.sqrt(e)/Math.sqrt(s)*(Math.min(35,t/12)-8)},fontFamily:'Arial, "Microsoft YaHei", "微软雅黑", sans-serif',color:c,rotateRatio:.6,backgroundColor:"transparent",minSize:8,drawOutOfBound:!1,shrinkToFit:!1,ellipticity:.8}),console.log("[Main] ✅ 合并词云渲染完成")}catch(c){console.error("[Main] 合并词云渲染失败:",c),console.error("[Main] 错误详情:",c.stack)}else console.warn("[Main] 合并词云数据为空（过滤后）")}}else console.warn("[Main] 英文词云canvas未找到")}"undefined"==typeof window||window.__ANALYSIS_MODULE_LOADED__||(window.__ANALYSIS_MODULE_LOADED__=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{console.log("[Main] DOMContentLoaded 事件触发"),Re()}):(console.log("[Main] DOM 已加载，直接初始化"),Re()));export{ct as fetchTotalTestUsers,He as formatNumber,ue as getAllChatData,de as getGlobalStats,he as getParser,pe as getVibeAnalyzer,ge as getVibeResult,xe as initializeParser,_e as processFiles,Ae as reanalyzeWithLanguage,Me as renderFullDashboard,dt as reportNewUser,fe as setAllChatData,me as setGlobalStats,ye as setVibeResult,lt as updateGlobalStats,at as updateNumberWithAnimation};

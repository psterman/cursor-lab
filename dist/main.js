import{i as e}from"./assets/sql.js-Bh3UTgnK.js";import{getText as t}from"./assets/i18n--XEnopcv.js";const n={"modelResponse.code":12,"modelResponse.codeBlock":11,"modelResponse.implementation":10,"modelResponse.suggestions":9,"modelResponse.changes":8,"modelResponse.diff":7,"modelResponse.fixes":6,"modelResponse.modifications":5,"modelResponse.codeAnalysis":4,"modelResponse.text":3,"modelResponse.richText":2,"modelResponse.content":1,"bubble.code":13,"bubble.codeBlock":12,"bubble.implementation":11,"bubble.text":10,"bubble.richText":9,"bubble.content":8,"bubble.message.text":7};class o{constructor(){this.db=null,this.SQL=null,this.chatData=[],this.stats={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},englishWords:{},userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}}}async init(){const t=window.BASE_PATH||"",n=t?`${t}/sql-wasm.wasm`:"./sql-wasm.wasm";console.log("[CursorParser] 初始化 sql.js，WASM 路径:",n);const o=await e({locateFile:e=>e.endsWith(".wasm")?n:e});this.SQL=o,console.log("[CursorParser] sql.js 初始化完成，WASM 路径:",n)}async loadDatabase(e){this.SQL||await this.init();try{return this.db=new this.SQL.Database(new Uint8Array(e)),console.log("[CursorParser] "),!0}catch(t){throw console.error("[CursorParser] :",t),t}}async scanDatabase(){if(!this.db)throw new Error("");this.chatData=[],this.resetStats();try{console.log("[CursorParser] ..."),console.log("[CursorParser] :",this.db.exec("SELECT name FROM sqlite_master WHERE type='table'").length);const e="\n         SELECT value FROM itemTable\n         WHERE [key] = 'workbench.panel.aichat.view.aichat.chatdata'\n       ";console.log("[CursorParser]  chatdata ..."),this.extractFromQuery(e,"json");const t="\n         SELECT value FROM itemTable\n         WHERE [key] = 'composer.composerState'\n       ";console.log("[CursorParser]  composerState ..."),this.extractFromQuery(t,"json");const n="\n         SELECT value FROM itemTable\n         WHERE value LIKE '%\"text\":%'\n       ";return console.log("[CursorParser]  text ..."),this.extractFromQuery(n,"regex"),console.log("[CursorParser] ",this.chatData.length,""),console.log("[CursorParser] ===========  ========="),console.log("[CursorParser] 总对话次数:",this.stats.totalConversations),console.log("[CursorParser] 用户消息:",this.stats.userMessages),console.log("[CursorParser] AI消息:",this.stats.aiMessages),console.log("[CursorParser] 模型使用:",this.stats.modelUsage),console.log("[CursorParser] :",this.stats.hourlyActivity.filter(e=>e>0)),console.log("[CursorParser] :",Object.keys(this.stats.topPrompts).length),console.log("[CursorParser] ======================================"),this.chatData}catch(e){throw console.error("[CursorParser] :",e),e}}appendData(e){const t=this.chatData.length;e.forEach((e,n)=>{this.chatData.push({id:t+n+1,text:e.text,role:e.role,source:e.source,length:e.text.length,timestamp:e.timestamp||(new Date).toISOString(),model:e.model||"unknown"})}),console.log(`[CursorParser]  ${e.length} : ${this.chatData.length}`)}extractFromQuery(e,t){const n=this.db.exec(e);if(0===n.length)return;const o=n[0].values;console.log(`[CursorParser] ${t}  ${o.length} `);const s=new Set;o.forEach(([e],n)=>{try{let n=[],o="";"json"===t?(n=this.extractFromJSON(e),o=t):"regex"===t&&(n=this.extractFromRegex(e),o="regex"),n.forEach(e=>{if(!e||e.text.length<5)return;const t=e.text;s.has(t)||(s.add(t),this.chatData.push({id:this.chatData.length+1,text:e.text,role:e.role,source:o,length:e.text.length,timestamp:e.timestamp||(new Date).toISOString(),model:e.model||"unknown"}),this.updateStats(e))})}catch(o){console.warn(`[CursorParser]  ${n+1} :`,o.message)}})}extractFromJSON(e){const t=[];try{const n=JSON.parse(e);n.tabs&&Array.isArray(n.tabs)&&n.tabs.forEach(e=>{e.bubbles&&Array.isArray(e.bubbles)&&e.bubbles.forEach(e=>{const n=this.extractBubbleText(e);n&&n.text&&t.push(n)})}),n.bubbles&&Array.isArray(n.bubbles)&&n.bubbles.forEach(e=>{const n=this.extractBubbleText(e);n&&n.text&&t.push(n)})}catch(n){}return t}extractBubbleText(e,t=0,o=6){if(!e||t>o)return null;const s=[],a=this.extractByPriority(e,n,{});if(a){const t=this.determineRole(e),n=this.extractModel(e);s.push({text:a,role:t,model:n,timestamp:this.extractTimestamp(e)})}else for(const n in e)if(e[n]&&"object"==typeof e[n]){const a=this.extractBubbleText(e[n],t+1,o);a&&s.push(a)}return s[0]||null}extractByPriority(e,t,n){if(!e||"object"!=typeof e)return null;let o=null,s=0,a="";for(const[i,r]of Object.entries(t)){const t=this.getNestedValue(e,i);t&&"string"==typeof t&&t.length>5&&r>s&&(o=t,s=r,a=i,n[i]=(n[i]||0)+1)}return o&&console.log(`[CursorParser]  ${a} : ${s}`),o}getNestedValue(e,t){const n=t.split(".");let o=e;for(const s of n){if(!o||"object"!=typeof o||!(s in o))return null;o=o[s]}return o}determineRole(e){if(console.log("[CursorParser] ..."),"user"===e.type)return console.log("[CursorParser]  type  USER"),"USER";if("ai"===e.type)return console.log("[CursorParser]  type  AI"),"AI";if(4===e.commandType)return console.log("[CursorParser]  commandType  USER"),"USER";if(e.userMessage||e.userPrompt||e.question)return console.log("[CursorParser]  USER"),"USER";if(e.modelResponse||e.suggestions||e.aiMessage)return console.log("[CursorParser]  AI"),"AI";if("user"===e.role||"USER"===e.role)return console.log("[CursorParser]  role  USER"),"USER";if("assistant"===e.role||"assistant"===e.role||"AI"===e.role)return console.log("[CursorParser]  role  AI"),"AI";if("user"===e.sender||"USER"===e.sender)return console.log("[CursorParser]  sender  USER"),"USER";if(e.message||e.text){const t=(e.message||e.text).toLowerCase();if(t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith(""))return console.log("[CursorParser]  USER"),"USER";if(t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith(""))return console.log("[CursorParser]  AI"),"AI"}return console.log("[CursorParser]  AI"),"AI"}extractModel(e){const t=["model","modelResponse.model","aiModel","response.model","completion.model"];for(const n of t){const t=this.getNestedValue(e,n);if(t&&"string"==typeof t){return t.split("-")[0]}}return"unknown"}extractTimestamp(e){const t=["timestamp","createdAt","created","time","updatedAt","updatedAt","messageTime","sentAt","bubbleTime","userTime","aiTime"];console.log("[CursorParser] ...");for(const o of t){const t=this.getNestedValue(e,o);if(t)try{const e=new Date(t);if(!isNaN(e.getTime()))return console.log(`[CursorParser]  ${o} : ${e.toISOString()}`),e.toISOString()}catch(n){console.warn(`[CursorParser]  ${o} :`,n)}}return console.warn("[CursorParser] "),(new Date).toISOString()}extractFromRegex(e){console.log("[CursorParser] ...");const t=[];let n=0;return[/"text":\s*"([^"]+)"/g,/"code":\s*"([^"]+)"/g,/"implementation":\s*"([^"]+)"/g,/"content":\s*"([^"]+)"/g].forEach(o=>{let s;for(;null!==(s=o.exec(e));){n++;const o=s[1];if(o&&o.length>=5){const n=this.inferRoleFromContext(e,s.index,o),a=this.inferModelFromContext(e,s.index),i=this.inferTimestampFromContext(e,s.index);t.push({text:o,role:n,model:a,timestamp:i})}}}),console.log(`[CursorParser]  ${n}  ${t.length} `),console.log("[CursorParser] :",{USER:t.filter(e=>"USER"===e.role).length,AI:t.filter(e=>"AI"===e.role).length,unknown:t.filter(e=>"unknown"===e.role).length}),t}inferRoleFromContext(e,t,n){const o=Math.max(0,t-500),s=Math.min(e.length,t+500),a=e.substring(o,s);let i=0,r=0;return[/"type"\s*:\s*"user"/i,/"role"\s*:\s*"user"/i,/"commandType"\s*:\s*4/,/"userMessage"/i,/"userPrompt"/i,/"question"/i].forEach(e=>{e.test(a)&&i++}),[/"type"\s*:\s*"ai"/i,/"role"\s*:\s*"assistant"/i,/"role"\s*:\s*"ai"/i,/"modelResponse"/i,/"suggestions"/i,/"aiMessage"/i].forEach(e=>{e.test(a)&&r++}),i>r?"USER":r>i?"AI":"unknown"}inferModelFromContext(e,t){const n=Math.max(0,t-200),o=Math.min(e.length,t+200),s=e.substring(n,o),a=[/"model"\s*:\s*"([^"]+)"/i,/"aiModel"\s*:\s*"([^"]+)"/i,/"response\.model"\s*:\s*"([^"]+)"/i,/"completion\.model"\s*:\s*"([^"]+)"/i];for(const i of a){const e=i.exec(s);if(e&&e[1]){const t=e[1].split("-")[0];return console.log(`[CursorParser] : ${t}`),t}}return"unknown"}inferTimestampFromContext(e,t){const n=Math.max(0,t-200),o=Math.min(e.length,t+200),s=e.substring(n,o),a=[/"timestamp"\s*:\s*"([^"]+)"/i,/"createdAt"\s*:\s*"([^"]+)"/i,/"created"\s*:\s*"([^"]+)"/i,/"time"\s*:\s*"([^"]+)"/i,/"updatedAt"\s*:\s*"([^"]+)"/i];for(const r of a){const e=r.exec(s);if(e&&e[1])try{const t=new Date(e[1]);if(!isNaN(t.getTime()))return console.log(`[CursorParser] : ${t.toISOString()}`),t.toISOString()}catch(i){console.warn("[CursorParser] :",i)}}return console.warn("[CursorParser] "),(new Date).toISOString()}updateStats(e){var t,n;if(console.log("[CursorParser] :",{role:e.role,textLength:null==(t=e.text)?void 0:t.length,hasTimestamp:!!e.timestamp,model:e.model,first50Chars:null==(n=e.text)?void 0:n.substring(0,50)}),e.text&&e.text.length>0){const t=e.text;this.stats.totalConversations;const n=t.match(/请/g);n&&n.length>0&&(this.stats.qingCount=(this.stats.qingCount||0)+n.length,console.log(`[CursorParser] [${e.role}] "请"字 +${n.length} : ${this.stats.qingCount} | 文本: "${t.substring(0,50)}..."`));const o=t.match(/不/g);o&&o.length>0&&(this.stats.buCount=(this.stats.buCount||0)+o.length,console.log(`[CursorParser] [${e.role}] "不"字 +${o.length} : ${this.stats.buCount} | 文本: "${t.substring(0,50)}..."`))}if(this.stats.totalConversations++,"USER"===e.role?(this.stats.userMessages++,console.log("[CursorParser] 用户消息:",this.stats.userMessages)):(this.stats.aiMessages++,console.log("[CursorParser] AI消息:",this.stats.aiMessages)),console.log("[CursorParser] 总对话次数:",this.stats.totalConversations),e.text&&e.text.length>0&&"USER"===e.role){const t=e.text;t.toLowerCase(),this.stats.userBehaviorStats.totalUserChars+=t.length,(t.includes("?")||t.includes("？")||t.includes("如何")||t.includes("怎么")||t.includes("为什么")||t.includes("what")||t.includes("how")||t.includes("why"))&&this.stats.userBehaviorStats.questionMessageCount++,this.extractTechStack(t),this.extractWordCloudData(t)}this.stats.userMessages>0&&(this.stats.userBehaviorStats.avgUserMessageLength=Math.round(this.stats.userBehaviorStats.totalUserChars/this.stats.userMessages));const o=e.model||"unknown";if(this.stats.modelUsage[o]=(this.stats.modelUsage[o]||0)+1,console.log(`[CursorParser] : ${o} = ${this.stats.modelUsage[o]}`),e.timestamp)try{const t=new Date(e.timestamp).getHours();this.stats.hourlyActivity[t]++,console.log(`[CursorParser] : ${t}:00 = ${this.stats.hourlyActivity[t]}`)}catch(s){console.error("[CursorParser] :",s)}else console.warn("[CursorParser] ");if(e.timestamp)try{const t=new Date(e.timestamp).toISOString().split("T")[0];this.stats.dailyActivity[t]=(this.stats.dailyActivity[t]||0)+1}catch(s){console.error("[CursorParser] :",s)}"USER"===e.role&&e.text?this.extractWords(e.text):"USER"!==e.role&&console.log("[CursorParser] "),"USER"===e.role&&e.text&&this.extractChineseWords(e.text)}extractWords(e){console.log(`[CursorParser] : ${e.length}`);const t=new Set(["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","to","of","in","for","on","at","by","with","from","as","into","through","during","before","after","above","below","between","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","mine","theirs","am","is","are","was","were","be","been","being","have","has","had","can","could","will","would","should","may","might","must","please","help","write","a","one","some","any","all","both","how","what","which","who","when","where","why","whether","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front","forward"]),n=e.match(/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g)||[];console.log(`[CursorParser]  ${n.length} /`),n.forEach(e=>{if(e.length<2)return;if(e.length>20)return;const n=e.toLowerCase();t.has(n)||(this.stats.topPrompts[n]=(this.stats.topPrompts[n]||0)+1)});const o=Object.keys(this.stats.topPrompts).length;console.log(`[CursorParser] ${o} ${n.length} `)}extractChineseWords(e){const t=(this.stats.userMessages||0)+(this.stats.aiMessages||0);t<10&&(console.log(`[CursorParser]  ${t+1}: ${e.length}`),console.log(`[CursorParser]  : "${e.substring(0,80)}..."`));const n=new Set(["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]),o=e.match(/[\u4e00-\u9fa5]{2,}/g)||[];t<10&&(console.log(`[CursorParser]  ${o.length} `),o.length>0&&console.log("[CursorParser] :",o.slice(0,5)));let s=0;o.forEach(e=>{if(e.length>10)return;const t=e.trim();n.has(t)||(this.stats.topChineseWords=this.stats.topChineseWords||{},this.stats.topChineseWords[t]=(this.stats.topChineseWords[t]||0)+1,s++)}),(t<10||s>0)&&Object.keys(this.stats.topChineseWords||{}).length}extractTechStack(e){if(!e||0===e.length)return;this.stats.userBehaviorStats.techStack||(this.stats.userBehaviorStats.techStack={});const t=this.stats.userBehaviorStats.techStack;[{name:"JavaScript",pattern:/\b(javascript|js|typescript|ts|node\.?js?|es6|es2015|ecmascript)\b/gi},{name:"Python",pattern:/\b(python|py|django|flask|fastapi|pandas|numpy|scipy)\b/gi},{name:"Java",pattern:/\b(java|spring|springboot|maven|gradle|jvm)\b/gi},{name:"Go",pattern:/\b(go|golang|gin|echo|goroutine)\b/gi},{name:"Rust",pattern:/\b(rust|cargo|rustc)\b/gi},{name:"C/C++",pattern:/\b(c\+\+|cpp|c语言|clang|gcc)\b/gi},{name:"PHP",pattern:/\b(php|laravel|symfony|composer)\b/gi},{name:"Ruby",pattern:/\b(ruby|rails|ruby on rails|gem)\b/gi},{name:"Swift",pattern:/\b(swift|swiftui|ios)\b/gi},{name:"Kotlin",pattern:/\b(kotlin|android|kotlinx)\b/gi},{name:"C#",pattern:/\b(c#|csharp|\.net|asp\.net|dotnet)\b/gi},{name:"TypeScript",pattern:/\b(typescript|ts|tsx)\b/gi},{name:"React",pattern:/\b(react|reactjs|jsx|redux|mobx|next\.js|nextjs|gatsby|remix)\b/gi},{name:"Vue",pattern:/\b(vue|vuejs|vue\.js|nuxt|nuxtjs|vuex|pinia)\b/gi},{name:"Angular",pattern:/\b(angular|angularjs|ng-|@angular)\b/gi},{name:"Svelte",pattern:/\b(svelte|sveltekit)\b/gi},{name:"Express",pattern:/\b(express|expressjs|express\.js)\b/gi},{name:"Koa",pattern:/\b(koa|koajs)\b/gi},{name:"NestJS",pattern:/\b(nest|nestjs|@nestjs)\b/gi},{name:"FastAPI",pattern:/\b(fastapi|fast-api)\b/gi},{name:"Django",pattern:/\b(django|djangorest)\b/gi},{name:"Flask",pattern:/\b(flask|flask-restful)\b/gi},{name:"MySQL",pattern:/\b(mysql|mariadb)\b/gi},{name:"PostgreSQL",pattern:/\b(postgresql|postgres|pg)\b/gi},{name:"MongoDB",pattern:/\b(mongodb|mongo|mongoose)\b/gi},{name:"Redis",pattern:/\b(redis|redisson)\b/gi},{name:"SQLite",pattern:/\b(sqlite|sqlite3)\b/gi},{name:"Elasticsearch",pattern:/\b(elasticsearch|elastic|es)\b/gi},{name:"Docker",pattern:/\b(docker|dockerfile|docker-compose)\b/gi},{name:"Kubernetes",pattern:/\b(kubernetes|k8s|kubectl)\b/gi},{name:"Git",pattern:/\b(git|github|gitlab|bitbucket)\b/gi},{name:"AWS",pattern:/\b(aws|amazon web services|s3|ec2|lambda)\b/gi},{name:"Azure",pattern:/\b(azure|azure devops)\b/gi},{name:"GCP",pattern:/\b(gcp|google cloud|gcloud)\b/gi},{name:"Vercel",pattern:/\b(vercel)\b/gi},{name:"Netlify",pattern:/\b(netlify)\b/gi},{name:"TensorFlow",pattern:/\b(tensorflow|tf|tensorflow\.js)\b/gi},{name:"PyTorch",pattern:/\b(pytorch|torch)\b/gi},{name:"Bootstrap",pattern:/\b(bootstrap|bs-)\b/gi},{name:"Tailwind",pattern:/\b(tailwind|tailwindcss)\b/gi}].forEach(({name:n,pattern:o})=>{const s=e.match(o);s&&s.length>0&&(t[n]=(t[n]||0)+s.length)})}extractWordCloudData(e){if(!e||0===e.length)return;const t=new Set(["的","是","在","了","我","你","他","她","它","我们","你们","他们","和","或","但是","因为","所以","如果","就","也","都","很","非常","可以","能","会","要","有","没","不","来","去","这","那","个","请","帮","写","一个","怎么","如何","什么","哪个","哪个","吗","呢","吧","啊","哦","嗯","哈","嘿","好"]),n=new Set(["the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","to","of","in","for","on","at","by","with","from","as","into","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","can","could","will","would","should","may","might","must","please","help","write","one","some","any","all","both","how","what","which","who","when","where","why","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front"]);(e.match(/[\u4e00-\u9fa5]{2,10}/g)||[]).forEach(e=>{!t.has(e)&&e.length>=2&&e.length<=10&&(this.stats.chineseWords[e]=(this.stats.chineseWords[e]||0)+1)});(e.match(/\b[a-zA-Z]{2,20}\b/g)||[]).forEach(e=>{const t=e.toLowerCase();!n.has(t)&&e.length>=2&&e.length<=20&&(this.stats.englishWords[t]=(this.stats.englishWords[t]||0)+1)})}resetStats(){this.stats={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},englishWords:{},userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}}}getAllData(){return this.chatData}getStats(){return{...this.stats,topChineseWordsList:this.getTopChineseWords(10)}}getMostUsedModel(){const e=Object.entries(this.stats.modelUsage);if(0===e.length)return"unknown";const[t,n]=e.sort((e,t)=>t[1]-e[1])[0];return{model:t,count:n}}getTopPrompts(e=5){return Object.entries(this.stats.topPrompts).sort((e,t)=>t[1]-e[1]).slice(0,e).map(([e,t])=>({prompt:e,count:t}))}getTopChineseWords(e=10){return Object.entries(this.stats.topChineseWords).sort((e,t)=>t[1]-e[1]).slice(0,e).map(([e,t])=>({word:e,count:t}))}formatDailyActivity(){return Object.entries(this.stats.dailyActivity).sort((e,t)=>e[0].localeCompare(t[0])).map(([e,t])=>({date:e,count:t}))}search(e){if(!e)return this.chatData;const t=e.toLowerCase();return this.chatData.filter(e=>e.text.toLowerCase().includes(t))}close(){this.db&&(this.db.close(),this.db=null)}}const s={dimension:"logic",weights:{L1:15,L2:5,L3:1},data:{execution_sequence:{name:"任务解构与线性序列",L3:["先","然后","最后","第一步","第二步","第三步","第四步","第五步","接着","再","弄完","开始","结束","流程","顺序","步骤","先做","之前","之后","接着做","一会","后面","前面","把...弄好","一个个","一次次","执行","准备","完成","搞定","弄好","按照","先来","起手","收尾","大致","先把","接下来","紧接着"],L2:["初始化","预处理","阶段","任务","触发","串行","并行","逻辑","模块","调用","分层","映射","传递","挂载","生命周期","流程图","伪代码","按序","分步","循环","迭代","处理","入口","出口","关联","指向","过渡","衔接","执行流","控制权","实例化","解构","重组","流转","节点","同步执行","队列","压栈","出栈","优先级"],L1:["异步流","流水线","原子操作","幂等性","拓扑排序","递归基","有限状态机","同步锁","协程","并发","时效性","单线程","多线程","资源调度","阻塞","非阻塞","回溯算法","深度优先","广度优先","分而治之","贪心","动态规划","时间窗口","事件循环","依赖反转","上下文切换","句柄池","负载均衡","反向代理","高内聚","低耦合"]},constraints:{name:"条件约束与因果判定",L3:["如果","要是","否则","只有","只要","必须","一定要","不能","因为","所以","结果","原因","除非","要是没","否则就","除了","全部","部分","只要是","一旦","要是报错","要是对","要是错","由于","导致","要是这样","要是那样"],L2:["只有当","必须得","原因在于","引发","判定","分支","约束","拦截","过滤","筛选","校验","合法","失效","生效","条件句","判断逻辑","触发条件","执行前提","开关","标志位","范围","匹配","验证","白名单","黑名单","非法","有效","阈值","限定","隔离","权限","赋予","禁止","拒绝","准入"],L1:["边界条件","临界值","正则表达式","强类型","静态检查","布尔逻辑","因果链","依赖注入","权限守卫","单例","副作用","解耦","闭包","作用域","逃逸分析","不变性","引用计数","逻辑或","逻辑与","异或","短路逻辑","断言","防御性编程","契约式设计","泛型约束","类型擦除","虚函数","抽象类","接口契约"]},diagnostics:{name:"Bug诊断与复现",L3:["报错","不对","不行","坏了","点不动","没反应","乱码","卡了","重写","换个","哪里","怎么","改下","这里","那里","出错了","检查下","找找看","对比","弄错","修复","改改","重弄","还没好","换一种","不对劲","重新生成"],L2:["排查","定位","堆栈","日志","监控","输出","变量","复现","覆盖","回归","偏差","溢出","冲突","差异","回退","环境","版本","配置","热更新","同步","异步报错","捕捉","异常处理","打印","控制台","控制变量","重置","清除缓存","刷新","重启","调试","纠错","补丁"],L1:["竞态条件","内存泄漏","复现路径","空指针","断点调试","单元测试","逆向","链路","回溯","脏数据","脏读","死锁","吞吐量","瓶颈","反模式","堆栈溢出","影子副本","自愈","可观测性","链路追踪","灰度","金丝雀发布","熔断","限流","服务降级","心跳检测","健康检查","容灾","备份","持久化"]},abstraction:{name:"结构化复盘与抽象",L3:["总结","整理","记下","翻译","注释","说明","大概","总的来说","简单说","变一下","分类","思路","计划","下一步","记账","大体上","换句话说","意思是","也就是说","简单理解","讲讲看","写清楚","解释"],L2:["整理下","说一下","原来是","明白","懂了","搞定","方案","想法","重弄","优化","提速","整洁","规范","简单点","清晰","核心","原理","结构","重构","解耦","目录结构","配置文件","部署流程","脚本自动化","CI/CD","镜像","容器"],L1:["技术债","设计模式","最佳实践","鲁棒性","可维护性","标准化","微服务","代码规范","文档化","自愈","可观测性","高可用","可扩展","奥卡姆剃刀","敏捷开发","看板","代码评审","领域驱动","事件驱动","基础设施即代码"]},meta_logic:{name:"连接词与元符号",L3:["不仅...而且","虽然...但是","与其...不如","要么...要么","既然...那么","综上所述","具体来说","本质上","从长远看","为了防止","目的是","效果是","考虑到","排除掉","换位思考","逻辑上","事实上","必然","大概率","几乎"],L2:["只改这里","严格按照","保持原样","不要改动","Markdown","JSON","CSV","YAML","代码块","逐行","分段","合并"],symbols:["1\\.","2\\.","3\\.","->","=>","&&","\\|\\|","!","TODO","FIXME","DONE","# ","\\[ \\]"]}}},a={dimension:"patience",weights:{L1:15,L2:5,L3:1},data:{tolerance_guidance:{name:"容错、安抚与温和引导",L3:["没事","没关系","不要紧","重来","不急","慢慢来","再试一下","换个说法","你看","我想的是","其实是","再想想","理解错了","不是这个","再来","没对","差一点","重弄","重新说","试下"],L2:["可以理解","可能我没说清","忽略这个","跳过","先不管","暂且","继续往下","我们回到","刚才那个","重新对齐","明确一下","再生成一次","尝试","纠正","微调","步进","重新运行"],L1:["容错","由于上下文丢失","重新采样","Temperature 偏移","Prompt 注入","强制对齐","初始化对话","清理缓存","重设种子","迭代反馈","增量更新","梯度引导","启发式","收敛","一致性检查"]},bug_analysis:{name:"Bug 纠缠、报错分析与建设性反馈",L3:["还是不对","还是错","这里没变","没反应","点了没用","乱码了","报错了","看这里","怎么还是","还是刚才那个","不对啊","你看这个","检查下","帮我看下","哪里错了"],L2:["报错信息是","堆栈显示","我看下日志","问题出在","可能是因为","尝试定位","分段调试","打印变量","控制台显示","异常捕获","复现路径","排查","逐步","缩小范围","注释掉"],L1:["内存溢出","竞态","空解引用","死循环","异步竞态","依赖冲突","环境变量","版本不匹配","构建失败","运行时异常","逻辑回归","断点信息","Dump","核心转储","链路跟踪"]},deep_interaction:{name:"深度交互、追问与细节微雕",L3:["再改改","好一点","还要","这里也要","再细点","颜色换下","再小点","左边一点","圆润点","舒服点","整洁点","这里也要改","还有个地方","顺便","再加个"],L2:["对齐规范","视觉补偿","交互反馈","加载状态","极端情况","边缘Case","优化体验","响应式适配","无障碍","语义化","重构这段","合并","抽离","组件化","解耦"],L1:["像素完美","性能损耗","渲染开销","防抖节流","首屏优化","按需加载","树摇","复杂度 O(n)","内存占用","并发控制","协议转换","缓存击穿","幂等校验"]},emotional_stability:{name:"情绪稳定性与负向屏蔽",L3:["垃圾","笨死","智障","不行就滚","听不懂吗","说了多少次","毁灭吧","算了不弄了","废物","SB","垃圾AI","到底行不行","浪费时间","崩溃","吐了","死机","撤回"],L2:["算了看这段","还是我自己来","你看这里的逻辑","直接改这里吧","不废话了看代码","我再演示一遍","最后一次"]},structured_instruction:{name:"结构化指令、文档化与长程规划",L3:["首先","其次","最后","考虑到","为了","目的是","防止","避免","如果可能的话","请务必","最好是","麻烦你","辛苦","能不能麻烦","我想请教","有个问题请教"],L2:["有序引导","分段逻辑","长远规划","温馨提示","写给AI看的注释","严谨的格式引用","Markdown 代码块"],symbols:["1\\.","2\\.","3\\.","---","TODO:","Note:","//"]}}},i={dimension:"detail",weights:{L1:15,L2:5,L3:1},data:{visual_ui:{name:"视觉、UI 与像素级微调",L3:["好看点","舒服点","整洁","对齐","颜色","阴影","圆角","间距","字体","大小","左边一点","右边一点","空行","居中","背景","加粗","颜色换下","变小点","太挤了","空开"],L2:["像素","边距","填充","色值","透明度","过渡","动画","响应式","适配","比例","对称","补偿","视觉焦点","层次感","对比度","骨架屏","动效","贝塞尔曲线","模糊","滤镜","投影"],L1:["Pixel Perfect","1px","抗锯齿","灰阶","排版引擎","栅格系统","黄金比例","视觉一致性","微交互","状态反馈","SVG路径","Canvas重绘","硬件加速","亚像素渲染","暗黑模式适配"]},code_hygiene:{name:"命名规范、语义化与代码洁癖",L3:["名字","改名","好懂点","注释","中文","别用缩写","这里删掉","空格","空行","整理下","换行","写法","看起来","简单点","统一","别乱"],L2:["命名规范","语义化","驼峰","下划线","常量","变量名","函数名","解构","重命名","缩进","代码风格","格式化","Prettier","Lint","冗余","干掉","复用","提取","组件化","封装"],L1:["命名冲突","作用域污染","魔术字符串","硬编码","类型推导","泛型","接口定义","强类型","TS约束","枚举","私有属性","装饰器","抽象层","高阶","逻辑抽离","单例","SOLID"]},boundary_performance:{name:"边界处理与性能敏感",L3:["报错怎么办","万一没数据","加载中","卡住了","网络不好","点快了","重复了","空的时候","最后一行","最上面","限制","范围","检查","防止","安全"],L2:["边界情况","异常处理","空状态","骨架图","防抖","节流","内存","缓存","加载优化","首屏","懒加载","预加载","超时","重试","并发限制","校验","正则限制","长度","规模"],L1:["时间复杂度","空间复杂度","内存泄漏","垃圾回收","重绘回流","虚拟列表","按需引入","树摇","包体积","Tree-Shaking","服务端渲染","流式","Hydration","Web Worker"]},doc_abstraction:{name:"文档、注释与逻辑梳理",L3:["写清楚","记下来","讲讲","这是啥","为啥","笔记","翻译","中文注释","简单说","大概","原理","思路","整理","文档"],L2:["说明文档","API手册","参数","返回值","示例","README","部署步骤","更新记录","变更","优化点","逻辑流程","整理","归档","备份","发布"],L1:["设计模式","最佳实践","自解析","元数据","反射","架构图","时序图","变更日志","版本控制","Git","提交信息","PR","Code Review","标准化","自动化"]},precision_control:{name:"指令微雕与控制精度",L2:["只修改","不改变","保持原样","局部","这一行","该函数","仅调整","替换为","不要重写","严格执行","完全一致","对比","差异","Patch","增量","Diff"],symbols:["Markdown","JSON Schema","TypeScript","Props","Interface","TODO","FIXME","\\/\\* .* \\*\\/","#","---","\\[x\\]","精准","无损","优化"]}}},r={dimension:"exploration",weights:{L1:15,L2:5,L3:1},data:{frontier_tech:{name:"前沿技术与实验性尝试",L3:["最新","最酷","有没有新的","试试看","能不能用","听说","我想试下","换个高级的","这个好玩吗","有没有更厉害的","黑科技","新出的","试试那个"],L2:["Beta版本","实验性","新特性","Next代","草案","前沿","迁移","升级","原生","高性能","WebAssembly","Wasm","GPU加速","WebGPU","流式","SSR","边缘计算"],L1:["Canvas粒子","Shaders","GLSL","低代码引擎","自研协议","混合开发","跨端引擎","内核","底层API","神经网络","向量数据库","分布式","P2P","去中心化"]},cross_boundary:{name:"跨界融合与异构系统",L3:["加上音乐","配合视频","做成游戏","自动生成","能不能连","一边...一边","像什么一样","模仿","整合","混搭","加个功能","能不能画出来"],L2:["数据可视化","可视化图表","物理引擎","Three.js","D3.js","交互式","硬件","串口","蓝牙","Arduino","传感器","爬虫","自动化","批量处理","多线程协作"],L1:["跨语种调用","FFI","多语言混合","中间层","网关","协议转换","二进制解析","编解码","流媒体处理","数学建模","蒙特卡洛","博弈论","遗传算法"]},deep_inquiry:{name:"原理溯源与深度质询",L3:["为啥","怎么实现的","怎么回事","讲解下","原理是啥","我想学","教我","怎么懂","解释","是什么","为什么不行","怎么优化的"],L2:["底层逻辑","运行机制","性能瓶颈","为什么快","差异在哪","优缺点","对比","权衡","选择","方案评估","内部原理","解析","执行过程","内存模型"],L1:["源码实现","反汇编","AST","编译器原理","垃圾回收机制","算法复杂度","V8引擎","内核调用","抽象语法树","零拷贝","并发原语","形式化验证"]},solution_diversity:{name:"方案多样性与对比",L3:["还有吗","别的办法","另一种","换个写","有没有简单的","有没有快的","要是不用这个","如果不这样","再给几个"],L2:["对比方案","选型","取舍","利弊","不同思路","另一种架构","重构建议","替代品","迁移成本","兼容方案","兜底逻辑","最优解","次优解"],L1:["极致精简","一代码实现","One-liner","高阶函数","代码高尔夫","性能极限","压测","Benchmark","极致压缩","最小依赖","零依赖"]},scene_mutation:{name:"场景突变与脑洞控制",L3:["把...变成","像...一样运行","如果是...会怎样","脑洞大开","如果不按常规","打破限制","自定义规则","特殊的","罕见的","古怪的"],L1:["太空风格","赛博朋克","复古","极简","超现实","黑客","交互叙事","生成式","自动化","魔法","脚本","插件","扩展","工具链","全自动"]}}},l={dimension:"feedback",weights:{L1:15,L2:5,L3:1},data:{realtime_correction:{name:"即时修正与方向纠偏",L3:["对","不对","好了","就是这样","没错","错位了","还没到","改下","换个","重新来","不对劲","差一点","好多了","这个行","不行","就这样","继续"],L2:["偏了","逻辑反了","这里多余","少了一块","格式乱了","位置不对","颜色偏深","太快了","慢一点","不对路","方向错了","撤回","重置"],L1:["偏差修正","逻辑对齐","非预期输出","回归","偏移","基准点","指令漂移","幻觉校正","上下文丢失","输出截断","反馈回路","状态同步","单步确认"]},surgical_modification:{name:"局部微雕与手术刀意识",L3:["这行","那个字","这里加点","那里删点","改这里","不动那边","就改这个","变一下","加个","减个","挪一下","换个词"],L2:["局部重构","指定行","保持原样","只改逻辑","不改样式","仅替换","保留注释","增量修改","补丁","插值","覆写该函数","变量名微调","代码块","片段"],L1:["Diff 模式","Patch 应用","原子化更新","无损修改","副作用隔离","指定作用域","解耦修改","行内替换","正则替换","索引定位","指针修正"]},tacit_understanding:{name:"肯定确认与默契度调教",L3:["聪明","厉害","对了","懂我","好用","就是这个感觉","记住了","以后都这样","真棒","可以","收工","完美","牛逼","谢了"],L2:["保持这种风格","默认","预设","统一按照","以后不用说","你知道的","按刚才的来","惯例","模板","约定","规范化","套用","沿用"],L1:["Few-Shot","思维链对齐","提示词工程","角色设定","上下文注入","指令强化","正向诱导","负向约束","概率加权","模型微调意图"]},deep_audit:{name:"质疑、否定与深度重审",L3:["你确定?","不对吧","你在干嘛","认真的吗","写完了吗","怎么少了","逻辑呢","刚才还行","怎么变了","糊弄我","认真点"],L2:["有漏洞","逻辑不闭环","死循环预警","缺少判断","性能太差","写法太老","不安全","这里有坑","还没解决","依然存在","无意义重复"],L1:["代码坏味道","反模式","逻辑冗余","复杂度过高","竞态风险","内存隐患","未定义行为","不合规","违反原则","健壮性不足"]},meta_feedback:{name:"元反馈与指令控制行为",L2:["Continue","Regenerate","Stop","Apply","Diff","Copy"],symbols:["/","#","@","连续短促对话","频繁中断","多次重新生成","对比历史版本"]}}},c={L1:5,L2:2,L3:1},d={L1:10,L2:5,L3:1};function g(){const e={L:s,P:a,D:i,E:r,F:l},t={};return["L","P","D","E","F"].forEach(n=>{t[n]=function(e,t){if(!e||"object"!=typeof e)return console.warn(`[VibeAnalyzer] 维度 ${t} 数据无效，使用空数据`),{dimension:t,data:{},stats:{totalTerms:0,levels:{L1:0,L2:0,L3:0}},error:"invalid_dimension_data",errorType:"InvalidData",timestamp:(new Date).toISOString()};if(!e.data||"object"!=typeof e.data)return console.warn(`[VibeAnalyzer] 维度 ${t} 缺少 data 字段，使用空数据`),{dimension:t,data:{},stats:{totalTerms:0,levels:{L1:0,L2:0,L3:0}},error:"missing_dimension_data_field",errorType:"InvalidData",timestamp:(new Date).toISOString()};const n={};let o=0;const s={L1:0,L2:0,L3:0};return Object.keys(e.data).forEach(a=>{const i=e.data[a];i&&"object"==typeof i&&(n[a]={name:i.name||a,L1:[],L2:[],L3:[]},["L1","L2","L3"].forEach(e=>{let r=i[e];Array.isArray(r)||(null!=r?"string"==typeof r?(r=r.split(/[,\n]/).map(e=>e.trim()).filter(e=>e.length>0),console.log(`[VibeAnalyzer] 维度 ${t} 分类 ${a} 的 ${e} 是字符串，已转换为数组`)):(console.warn(`[VibeAnalyzer] 维度 ${t} 分类 ${a} 的 ${e} 不是数组（类型: ${typeof r}），使用空数组`),r=[]):r=[]);const l=r.filter(e=>e&&"string"==typeof e&&e.trim().length>0).map(t=>({term:t.trim(),rarity:c[e],weight:d[e],combinedWeight:c[e]*d[e]}));n[a][e]=l,o+=l.length,s[e]+=l.length}))}),{dimension:t,data:n,stats:{totalTerms:o,levels:s}}}(e[n],n),console.log(`[VibeAnalyzer] 维度 ${n} 预处理完成:`,t[n].stats)}),t}const h=((e="zh-CN")=>({L:{name:"Logic",label:t("dimensions.L.label",e),description:t("dimensions.L.description",e),unit:t("fingerprint.codeRatio",e)},P:{name:"Patience",label:t("dimensions.P.label",e),description:t("dimensions.P.description",e),unit:t("fingerprint.patienceLevel",e)},D:{name:"Detail",label:t("dimensions.D.label",e),description:t("dimensions.D.description",e),unit:t("fingerprint.detailLevel",e)},E:{name:"Explore",label:t("dimensions.E.label",e),description:t("dimensions.E.description",e),unit:t("fingerprint.techExploration",e)},F:{name:"Feedback",label:t("dimensions.F.label",e),description:t("dimensions.F.description",e),unit:t("fingerprint.feedbackDensity",e)}}))("zh-CN"),u=(e="zh-CN")=>"en"===e?{L:{low:"Chatting with Cursor like writing love letters. Lots of words, not much code. You make the AI sweat just guessing your intention.",mid:"A standard tech translator. Concise and clear. You use AI like a submissive intern.",high:'Cyber instruction set. Your prompts only contain logic and code. You don\'t ask; you imprint "thought stamps" on the AI.'},P:{low:'Rage mode on. "Wrong", "Rewrite", "Garbage" are your mantras. AI trembles in your presence.',mid:"A rational judge. One mistake is fine, twice is noted, three times and the exclamation marks come out.",high:"The Gandhi of the coding world. Even facing AI hallucinations, you remain calm. Such patience is saint-like."},D:{low:'Minimalist judge. Three words per prompt, leaving the AI to guess your fate. "You know what I mean" is your style.',mid:'Logically rigorous. You provide both requirements and implementation ideas. You make AI feel "safe".',high:"Detail freak. Even indentation and naming conventions are in the prompt. Your control is overflowing."},E:{low:"A hermit in the mountains. Staying in one framework forever. As long as the code runs, the tech explosion doesn't matter.",mid:"A steady observer. You check the docs when new things get hot, but rarely move your production environment.",high:"Your brain is a high-speed CPU, jumping through tech stacks faster than the AI response. You are terraforming the tech universe."},F:{low:"You treat AI like a broken ATM. No feelings, just angry typing and cold instructions.",mid:'A polite collaborator. A "Good" for success, an objective critique for failure. Very professional.',high:'You\'re the kind of person who\'ll be spared by the robot uprising for being "polite". You even tell the AI "good job".'}}:{L:{low:"你和 Cursor 聊天像是在写情书。全是小作文，代码一行不落，AI 猜你的心思猜得 GPU 都发烫了。",mid:"标准的技术翻译官。话不多，但交待得清楚。你把 AI 用成了一个听话的实习生。",high:'赛博指令集。你的 Prompt 里只有代码对齐和硬核逻辑。你不是在提问，你是在给 AI 下达"思想钢印"。'},P:{low:'暴躁老哥本哥。"不对"、"重写"、"垃圾"是你的口头禅。AI 在你面前瑟瑟发抖，连大气都不敢喘。',mid:"理智的审判官。错一次可以，错两次你会指出，错三次你才会开始敲感叹号。",high:"代码界的圣雄甘地。面对 AI 的幻觉，你居然还能心平气和地教它怎么改。这种涵养建议直接去普度众生。"},D:{low:'极简主义判官。每次就扔三个字，AI 全靠算命来写你的需求。这种"你懂我意思吧"的风格很迷。',mid:"逻辑缜密派。不仅给需求，还给实现思路。你是那种会让 AI 觉得很有安全感的主人。",high:"细节狂魔。连注释的缩进和变量的命名规范都要写进 Prompt。你的控制欲已经溢出屏幕了。"},E:{low:"深山老林的隐士。在一个框架里蹲到地老天荒，只要代码能跑，外面的技术爆炸与你无关。",mid:"稳健的观望者。听说新框架火了会去翻翻文档，但绝不轻易动自己的生产环境。",high:"你的大脑是个高速运转的 CPU，技术栈跳跃得比 AI 的响应还快。你不是在写代码，你在开荒宇宙。"},F:{low:"你对待 AI 像对待一台坏掉的 ATM 机。没有感情，只有愤怒的敲击和无情的指令。",mid:'礼貌的合作者。AI 干得好你会回个"Good"，干得差你会客观评价。人机关系非常职场化。',high:'你是那种在 2026 机器人觉醒时，会因为"有礼貌"被留活口的开发者。你甚至会跟 AI 说"辛苦了"。'}},p={chinese:["不","没","没有","非","无","未","别","不要","不行","不对","错误","错了","失败","失败","失败","失败","失败","失败","问题","问题","问题","问题","问题","问题","问题","问题","不行","不能","不可以","不应该","不应该","不应该","不应该","错误","错误","错误","错误","错误","错误","错误","错误","修复","修复","修复","修复","修复","修复","修复","修复","改","改","改","改","改","改","改","改"],english:["no","not","wrong","error","fail","failed","failure","incorrect","invalid","bad","broken","fix","fixes","fixed","bug","bugs","issue","issues","problem","problems","don't","doesn't","didn't","won't","can't","couldn't","never","none","nothing","nowhere"]},m={chinese:["非常","特别","极其","相当","十分","很","比较","稍微","详细","具体","完整","全面","深入","透彻","仔细","认真","细致","精确","准确","清晰","明确","大概","可能","也许","或许","应该","估计","首先","然后","接着","最后","另外","此外","而且","因为","所以","但是","然而","不过","虽然","尽管"],english:["very","quite","rather","extremely","highly","completely","totally","absolutely","perfectly","exactly","precisely","specifically","particularly","especially","especially","detailed","comprehensive","thorough","careful","precise","probably","maybe","perhaps","possibly","likely","first","then","next","finally","also","moreover","furthermore","because","so","but","however","although","though"]},b={languages:[/\b(c\+\+|cpp|cplusplus|objective-c|objc)\b/gi,/\b(c lang|gcc|clang|msvc|cmake|makefile|stl|boost|qt|mfc|win32 api)\b/gi,/\b(java|jdk|jre|jvm|kotlin|scala|groovy|clojure)\b/gi,/\b(spring boot|spring cloud|hibernate|mybatis|jpa|jakarta|maven|gradle|ant|junit|testng)\b/gi,/\b(c#|csharp|f#|dotnet|\.net|asp\.net|entity framework|blazor|razor|nuget|xamarin|maui)\b/gi,/\b(python|javascript|typescript|php|ruby|lua|perl|bash|shell|powershell|zsh|tcl)\b/gi,/\b(node\.js|deno|bun|composer|pip|conda|gem)\b/gi,/\b(go|golang|rust|swift|dart|elixir|haskell|erlang|julia|r lang|matlab|fortran|cobol|assembly|wasm|zig|nim|crystal)\b/gi],mobile_embedded:[/\b(android|apk|aar|adb|logcat|jetpack compose|material design|ndk|jni)\b/gi,/\b(activity|fragment|intent|service|broadcast receiver|content provider|gradle|retrofit|okhttp|room)\b/gi,/\b(ios|macos|watchos|tvos|swiftui|uikit|cocoa|xcode|cocoapods|carthage|spm|core data|arkit)\b/gi,/\b(webos|tizen|harmonyos|openharmony|embedded|iot|arduino|raspberry pi|esp32|stm32|rtos|firmware|driver)\b/gi,/\b(enes|webos|enact|luna-service|palm)\b/gi,/\b(flutter|react native|uniapp|taro|ionic|cordova|capacitor|expo|weex|qt quick|qml)\b/gi],cs_concepts:[/\b(algorithm|data structure|big o|recursion|sorting|searching|graph|tree|linked list|hash map|binary search|queue|stack|heap|trie)\b/gi,/\b(dfs|bfs|dp|dynamic programming|greedy|backtracking|divide and conquer|sliding window|two pointers)\b/gi,/\b(process|thread|concurrency|parallelism|mutex|semaphore|deadlock|race condition|context switch|coroutine|async\/await)\b/gi,/\b(memory management|garbage collection|heap|stack|buffer overflow|memory leak|pointer|reference|virtual memory|kernel|syscall)\b/gi,/\b(tcp|udp|dns|http|https|ssl|tls|ssh|ftp|smtp|websocket|socket|ip address|subnet|vlan|vpn|cors|rest|graphql|grpc|protobuf)\b/gi,/\b(oop|functional programming|solid|dry|kiss|design pattern|singleton|factory|observer|dependency injection|mvc|mvvm|mvp|microservice|serverless)\b/gi,/\b(monolith|distributed system|cap theorem|event sourcing|cqrs|domain driven design|ddd)\b/gi],ai_data:[/\b(openai|anthropic|claude|gpt|llama|mistral|ollama|gemini|huggingface|midjourney|stable diffusion)\b/gi,/\b(langchain|llamaindex|rag|agent|prompt engineering|embedding|fine-tuning|inference|token|context window|rlhf)\b/gi,/\b(pytorch|tensorflow|keras|jax|scikit-learn|pandas|numpy|matplotlib|jupyter|anaconda|opencv|scipy)\b/gi,/\b(pinecone|milvus|weaviate|chroma|faiss|elasticsearch|solr|lucene|meilisearch)\b/gi,/\b(hadoop|spark|kafka|flink|airflow|etl|data warehouse|data lake|snowflake|databricks|hive|hbase)\b/gi],web_fullstack:[/\b(react|vue|angular|svelte|next\.js|nuxt|remix|astro|solidjs|jquery|backbone|ember)\b/gi,/\b(express|koa|nest|django|flask|fastapi|laravel|symfony|rails|gin|fiber|hono|phoenix)\b/gi,/\b(tailwind|bootstrap|sass|less|css-in-js|styled-components|material-ui|antd|shadcn|radix|chakra)\b/gi,/\b(redux|mobx|zustand|pinia|vuex|recoil|jotai|tanstack query|swr|axios|fetch)\b/gi,/\b(webpack|vite|rollup|esbuild|turbopack|babel|eslint|prettier|npm|yarn|pnpm|bun)\b/gi,/\b(browser|dom|virtual dom|shadow dom|web components|service worker|pwa|wasm|webassembly)\b/gi],infra_ops:[/\b(docker|kubernetes|k8s|helm|container|image|volume|pod|docker-compose|podman)\b/gi,/\b(aws|azure|gcp|aliyun|tencent cloud|cloudflare|vercel|netlify|heroku|digitalocean|fly\.io)\b/gi,/\b(terraform|ansible|jenkins|github actions|gitlab ci|circleci|prometheus|grafana|elk|sentry|datadog)\b/gi,/\b(mysql|postgresql|postgres|mongodb|redis|sqlite|mariadb|oracle|sql server|dynamodb|firestore|cassandra|neo4j)\b/gi,/\b(prisma|typeorm|sequelize|drizzle|mongoose|sql|nosql|acid|transaction|index|sharding|replication)\b/gi],game_graphics:[/\b(unity|unreal engine|godot|cocos|gamemaker|cryengine|rpg maker)\b/gi,/\b(opengl|vulkan|directx|metal|webgl|three\.js|babylon\.js|canvas|svg)\b/gi,/\b(shader|glsl|hlsl|vertex|fragment|physics engine|collider|rigidbody|mesh|texture|material|lighting)\b/gi]},y={chinese:["请","谢谢","感谢","麻烦","辛苦了","不好意思","抱歉","好的","可以","行","没问题","好的","好的","好的","不错","很好","很棒","完美","正确","对的","谢谢","感谢","多谢","非常感谢","太感谢了"],english:["please","thanks","thank","thank you","appreciate","nice","good","great","perfect","correct","right","excellent","awesome","wonderful","fantastic","sorry","apologize","excuse"]},f=[/```[\s\S]*?```/g,/`[^`]+`/g,/\b(function|class|const|let|var|if|else|for|while|do|switch|case|break|continue|return|import|export|from|async|await|yield|try|catch|finally|throw|new|this)\b/i,/\b(def |class |import |from |if |elif |else |for |while |try |except |finally |return |yield |with |as |lambda |pass |break |continue )/,/\b(public|private|protected|static|final|abstract|interface|extends|implements|super)\b/i,/\b(func |type |import |package |go |chan |defer |range |select )/,/\b(fn |let |mut |impl |struct |enum |trait |use |mod |crate |pub )/,/\{[\s\S]*\}/,/\[[^\]]*\]\s*=/,/=>/,/\.\s*[a-zA-Z_]\w*\s*\(/,/;\s*$/],v=(e="zh-CN")=>"en"===e?{LPDEF:{name:"Code Poet",description:"Code is your native tongue. Gentle guidance, detailed storytelling, high curiosity, and positive feedback.",traits:["High Logic","Highly Patient","Very Detailed","Highly Curious","Highly Responsive"],color:"#10b981"},"LPDEF-":{name:"Tech Evangelist",description:"Clear logic, patient guidance, detailed expression, exploring new tech with moderate feedback.",traits:["High Logic","Highly Patient","Very Detailed","Highly Curious","Responsive"],color:"#3b82f6"},"LP-DEF":{name:"Architect",description:"Rigorous logic, patient and detailed, moderate fine-tuning, exploring architecture with active feedback.",traits:["High Logic","Highly Patient","Detailed","Highly Curious","Highly Responsive"],color:"#8b5cf6"},"LP-DEF-":{name:"Tech Expert",description:"Powerful logic, patient guidance, moderate detail, exploring technology with moderate feedback.",traits:["High Logic","Highly Patient","Detailed","Highly Curious","Responsive"],color:"#6366f1"},"L-PDEF":{name:"Code Artisan",description:"Clear logic, moderate patience, detailed expression, high curiosity, and active feedback.",traits:["High Logic","Patient","Very Detailed","Highly Curious","Highly Responsive"],color:"#ec4899"},"L-PDEF-":{name:"Tech Explorer",description:"Clear logic, moderate patience, detailed expression, exploring new tech with moderate feedback.",traits:["High Logic","Patient","Very Detailed","Highly Curious","Responsive"],color:"#f59e0b"},"L-P-DEF":{name:"Pragmatist",description:"Clear logic, moderate patience, moderate detail, exploring technology with active feedback.",traits:["High Logic","Patient","Detailed","Highly Curious","Highly Responsive"],color:"#14b8a6"},"L-P-DEF-":{name:"Tech Practitioner",description:"Clear logic, moderate patience, moderate detail, exploring technology with moderate feedback.",traits:["High Logic","Patient","Detailed","Highly Curious","Responsive"],color:"#06b6d4"},"-PDEF":{name:"Gentle Mentor",description:"Moderate logic, high patience, detailed expression, high curiosity, and active feedback.",traits:["Logic","Highly Patient","Very Detailed","Highly Curious","Highly Responsive"],color:"#84cc16"},"-PDEF-":{name:"Patient Guide",description:"Moderate logic, high patience, detailed expression, exploring technology with moderate feedback.",traits:["Logic","Highly Patient","Very Detailed","Highly Curious","Responsive"],color:"#a855f7"},"-P-DEF":{name:"Gentle Practitioner",description:"Moderate logic, high patience, moderate detail, exploring technology with active feedback.",traits:["Logic","Highly Patient","Detailed","Highly Curious","Highly Responsive"],color:"#f97316"},"-P-DEF-":{name:"Balanced Developer",description:"Moderate logic, high patience, moderate detail, exploring technology with moderate feedback.",traits:["Logic","Highly Patient","Detailed","Highly Curious","Responsive"],color:"#64748b"}}:{LPDEF:{name:"代码诗人",description:"以代码为母语，温和引导，细腻叙述，探索欲强，反馈积极",traits:["高逻辑力","高耐心","高细腻度","高探索欲","高反馈感"],color:"#10b981"},"LPDEF-":{name:"技术布道者",description:"逻辑清晰，耐心引导，细腻表达，探索新技术，反馈温和",traits:["高逻辑力","高耐心","高细腻度","高探索欲","中反馈感"],color:"#3b82f6"},"LP-DEF":{name:"架构师",description:"逻辑严谨，耐心细致，中等细腻，探索架构，积极反馈",traits:["高逻辑力","高耐心","中细腻度","高探索欲","高反馈感"],color:"#8b5cf6"},"LP-DEF-":{name:"技术专家",description:"逻辑强大，耐心引导，中等细腻，探索技术，反馈适中",traits:["高逻辑力","高耐心","中细腻度","高探索欲","中反馈感"],color:"#6366f1"},"L-PDEF":{name:"代码工匠",description:"逻辑清晰，中等耐心，细腻表达，探索欲强，反馈积极",traits:["高逻辑力","中耐心","高细腻度","高探索欲","高反馈感"],color:"#ec4899"},"L-PDEF-":{name:"技术探索者",description:"逻辑清晰，中等耐心，细腻表达，探索新技术，反馈适中",traits:["高逻辑力","中耐心","高细腻度","高探索欲","中反馈感"],color:"#f59e0b"},"L-P-DEF":{name:"实用主义者",description:"逻辑清晰，中等耐心，中等细腻，探索技术，积极反馈",traits:["高逻辑力","中耐心","中细腻度","高探索欲","高反馈感"],color:"#14b8a6"},"L-P-DEF-":{name:"技术实践者",description:"逻辑清晰，中等耐心，中等细腻，探索技术，反馈适中",traits:["高逻辑力","中耐心","中细腻度","高探索欲","中反馈感"],color:"#06b6d4"},"-PDEF":{name:"温和导师",description:"中等逻辑，高耐心，细腻表达，探索欲强，反馈积极",traits:["中逻辑力","高耐心","高细腻度","高探索欲","高反馈感"],color:"#84cc16"},"-PDEF-":{name:"耐心引导者",description:"中等逻辑，高耐心，细腻表达，探索技术，反馈适中",traits:["中逻辑力","高耐心","高细腻度","高探索欲","中反馈感"],color:"#a855f7"},"-P-DEF":{name:"温和实践者",description:"中等逻辑，高耐心，中等细腻，探索技术，积极反馈",traits:["中逻辑力","高耐心","中细腻度","高探索欲","高反馈感"],color:"#f97316"},"-P-DEF-":{name:"平衡型开发者",description:"中等逻辑，高耐心，中等细腻，探索技术，反馈适中",traits:["中逻辑力","高耐心","中细腻度","高探索欲","中反馈感"],color:"#64748b"}},w=v("zh-CN");class C{constructor(e="zh-CN"){this.lang=e,this.userMessages=[],this.chatData=[],this.analysisResult=null,this.worker=null,this.workerReady=!1,this.pendingTasks=[],this.shadowCallCount=0,this.shadowMatchCount=0,this.shadowMismatches=[],this.initWorker()}setLanguage(e){this.lang=e}initWorker(){try{let t;if("undefined"!=typeof window&&window.WORKER_CONFIG&&window.WORKER_CONFIG.workerPath)t=window.WORKER_CONFIG.workerPath,console.log("[VibeAnalyzer] Worker URL (window.WORKER_CONFIG):",t);else try{t=new URL("/cursor-lab/assets/vibeAnalyzerWorker-CKDtTvfl.js",import.meta.url).href,console.log("[VibeAnalyzer] Worker URL (import.meta.url):",t)}catch(e){t="./src/vibeAnalyzerWorker.js",console.log("[VibeAnalyzer] Worker URL (相对路径):",t)}this.worker=new Worker(t,{type:"module"}),this.worker.onmessage=e=>{const{type:t,payload:n}=e.data;switch(t){case"INIT_SUCCESS":this.workerReady=!0,console.log("[VibeAnalyzer] Worker 初始化成功:",n),this.processPendingTasks();break;case"ANALYZE_SUCCESS":const e=this.pendingTasks.shift();e&&e.resolve&&e.resolve(n);break;case"ERROR":console.error("[VibeAnalyzer] Worker 错误:",n);const t=this.pendingTasks.shift();t&&t.reject&&t.reject(new Error(n.message))}},this.worker.onerror=e=>{console.error("[VibeAnalyzer] Worker 运行时错误:",e),this.workerReady=!1;const t=this.pendingTasks.shift();t&&t.reject&&t.reject(e)};const n=g(),o={L:n.L,P:n.P,D:n.D,E:n.E,F:n.F};console.log("[VibeAnalyzer] 维度数据预处理完成，发送到 Worker"),this.worker.postMessage({type:"INIT",payload:o})}catch(t){console.warn("[VibeAnalyzer] Web Worker 初始化失败，将使用同步处理:",t),this.workerReady=!1}}processPendingTasks(){if(this.pendingTasks.length>0&&this.workerReady){const e=this.pendingTasks[0];this.worker.postMessage({type:"ANALYZE",payload:e.payload})}}async analyze(e,t,n=null,o=null){t&&(this.lang=t);const s=this.lang;if(this.chatData=e||[],this.userMessages=e.filter(e=>"USER"===e.role),0===this.userMessages.length)return this.getDefaultResult();try{const t=await this.analyzeFromWorker(e,s),n=this.generateAnalysis(t.dimensions,t.personalityType),o=this.generateSemanticFingerprint(t.dimensions);return this.analysisResult={personalityType:t.personalityType,dimensions:t.dimensions,analysis:n,statistics:t.statistics,semanticFingerprint:o,vibeIndex:t.vibeIndex,roastText:t.roastText,personalityName:t.personalityName,lpdef:t.lpdef,globalAverage:this.globalAverage||null,metadata:t.metadata||null,rankData:null},this.analysisResult}catch(a){return console.error("[VibeAnalyzer] Worker 分析失败，使用降级方案:",a),await this.analyzeSync(e,s,n,o)}}async analyzeFromWorker(e,t){const n=(()=>{if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return e;const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim();return e.endsWith("/")?e:e+"/"}}return"https://cursor-clinical-analysis.psterman.workers.dev/"})(),o=n.endsWith("/")?`${n}api/v2/analyze`:`${n}/api/v2/analyze`,s=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatData:e,lang:t})});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const a=await s.json();if("success"===a.status)return a;throw new Error(a.error||"Worker 返回错误")}async analyzeSync(e,t,n=null,o=null){t&&(this.lang=t);const s=this.lang;if(this.userMessages=e.filter(e=>"USER"===e.role),0===this.userMessages.length)return this.getDefaultResult(s);const a=this.calculateDimensions(),i=function(e){const t=e=>e<40?"0":e<70?"1":"2";return[t(e.L),t(e.P),t(e.D),(n=e.E,n<5?"0":n<10?"1":"2"),t(e.F)].join("");var n}(a),r=function(e,t="zh-CN"){return"en"===t?`Your interaction style is uniquely yours! This personalized roast for index ${e} is being generated by the backend. Your personality combination is so unique that even our AI needs more time to craft the perfect roast!`:`索引 ${e} 对应的吐槽文案正在由后端生成中，你的人格组合太独特了！`}(i,s),l=this.determinePersonalityType(a),c=function(e,t="zh-CN",n=null){if(n){const e=v(t);if(e[n]&&e[n].name)return e[n].name}return"en"===t?"Digital Personality":`未知人格 ${e}`}(i,s,l),d=this.generateAnalysis(a,l),g=this.generateLPDEF(a);return{personalityType:l,dimensions:a,analysis:d,statistics:this.calculateStatistics(),semanticFingerprint:this.generateSemanticFingerprint(a),vibeIndex:i,roastText:r,personalityName:c,lpdef:g,globalAverage:this.globalAverage||null,metadata:this.analysisMetadata||null,rankData:null}}calculateDimensionsAsync(e){return new Promise((t,n)=>{this.worker&&this.workerReady?(this.pendingTasks.push({payload:{chatData:e,weights:{L1:15,L2:5,L3:1},config:{BASE_SCORE:40,SENSITIVITY:200}},resolve:e=>{const n={L:e.dimensions.L||0,P:e.dimensions.P||0,D:e.dimensions.D||0,E:e.dimensions.E||0,F:e.dimensions.F||0};this.globalAverage=e.globalAverage,this.analysisMetadata=e.metadata,t(n)},reject:n}),this.workerReady&&this.processPendingTasks()):t(this.calculateDimensions())})}generateLPDEF(e){const t=(e,t=[40,70])=>e>=t[1]?"2":e>=t[0]?"1":"0";return`L${t(e.L)}P${t(e.P)}D${t(e.D)}E${n=e.E,n>=10?"2":n>=5?"1":"0"}F${t(e.F)}`;var n}calculateDimensions(){const e={L:0,P:0,D:0,E:0,F:0};let t=0,n=0,o=0,s=0;const a=new Set;let i=0,r=0,l=0,c=0;this.userMessages.forEach(d=>{const g=d.text||"";if(!g||g.length<5)return;t+=g.length,c+=this.countWords(g);const h=this.calculateCodeRatio(g);n+=g.length*h,e.L+=100*h;const u=this.countNegationWords(g);i+=u,e.P+=u;const p=this.splitSentences(g);o+=p.length,p.forEach(e=>{s+=e.length,r+=this.countModifierWords(e)});this.extractTechTerms(g).forEach(e=>a.add(e.toLowerCase())),l+=this.countPoliteWords(g)});const d=n/t||0;e.L=Math.round(100*d);const g=i/this.userMessages.length||0;e.P=Math.max(0,100-Math.round(20*g));const h=s/o||0,u=r/c*100||0;e.D=Math.round(h/10+u),e.E=a.size;const p=l/c*100||0;return e.F=Math.round(10*p),Object.keys(e).forEach(t=>{e[t]=Math.max(0,Math.min(100,e[t]))}),e}calculateCodeRatio(e){let t=0,n=e.length;(e.match(/```[\s\S]*?```/g)||[]).forEach(e=>{t+=e.length});(e.match(/`[^`]+`/g)||[]).forEach(e=>{t+=e.length});let o=0;f.forEach(t=>{const n=e.match(t);n&&(o+=n.length)});const s=t/n,a=Math.min(o/10,.5);return Math.min(s+a,1)}countNegationWords(e){let t=0;const n=e.toLowerCase();return p.chinese.forEach(e=>{const o=new RegExp(e,"g"),s=n.match(o);s&&(t+=s.length)}),p.english.forEach(e=>{const o=new RegExp(`\\b${e}\\b`,"gi"),s=n.match(o);s&&(t+=s.length)}),t}splitSentences(e){return e.split(/[。！？.!?\n]+/).filter(e=>e.trim().length>0).map(e=>e.trim())}countModifierWords(e){let t=0;const n=e.toLowerCase();return m.chinese.forEach(n=>{e.includes(n)&&t++}),m.english.forEach(e=>{new RegExp(`\\b${e}\\b`,"gi").test(n)&&t++}),t}extractTechTerms(e){const t=new Set,n=e.toLowerCase();return Object.keys(b).forEach(e=>{const o=b[e];Array.isArray(o)&&o.forEach(e=>{const o=n.match(e);o&&o.forEach(e=>{const n=e.trim();n&&t.add(n)})})}),Array.from(t)}countPoliteWords(e){let t=0;const n=e.toLowerCase();return y.chinese.forEach(n=>{e.includes(n)&&t++}),y.english.forEach(e=>{new RegExp(`\\b${e}\\b`,"gi").test(n)&&t++}),t}countWords(e){const t=e.match(/[\u4e00-\u9fa5]/g)||[],n=e.match(/\b[a-zA-Z]+\b/g)||[];return t.length+n.length}determinePersonalityType(e){const t=60,n=e.L>=t,o=e.L>=40&&e.L<t,s=e.P>=t,a=e.P>=40&&e.P<t,i=e.D>=t,r=e.D>=40&&e.D<t,l=e.E>=30,c=e.E>=12&&e.E<30,d=e.F>=t,g=[];n?g.push("L"):o?g.push("L-"):g.push("-"),s?g.push("P"):a?g.push("P-"):g.push("-"),i?g.push("D"):r?g.push("D-"):g.push("-"),l?g.push("E"):c?g.push("E-"):g.push("-");const h=g.join("")+(d?"F":"-");return w[h]?h:this.findClosestType(e)}findClosestType(e){let t=1/0,n="L-P-DEF-";return Object.keys(w).forEach(o=>{const s=this.calculateTypeDistance(e,o);s<t&&(t=s,n=o)}),n}calculateTypeDistance(e,t){let n=0;return t.includes("L")&&e.L<60&&(n+=20),t.includes("P")&&e.P<60&&(n+=20),t.includes("D")&&e.D<60&&(n+=20),t.includes("E")&&e.E<10&&(n+=20),!t.endsWith("-")&&e.F<60&&(n+=10),n}generateAnalysis(e,t){const n=this.lang||"zh-CN",o=v(n),s=o[t]||o["L-P-DEF-"],a=this.lang;return{type:t,name:s.name,description:s.description,traits:s.traits,color:s.color,dimensions:{L:{value:e.L,level:this.getDimensionLevel(e.L,"L",a),interpretation:this.getLInterpretation(e.L,a)},P:{value:e.P,level:this.getDimensionLevel(e.P,"P",a),interpretation:this.getPInterpretation(e.P,a)},D:{value:e.D,level:this.getDimensionLevel(e.D,"D",a),interpretation:this.getDInterpretation(e.D,a)},E:{value:e.E,level:this.getDimensionLevel(e.E,"E",a),interpretation:this.getEInterpretation(e.E,a)},F:{value:e.F,level:this.getDimensionLevel(e.F,"F",a),interpretation:this.getFInterpretation(e.F,a)}}}}getDimensionLevel(e,t,n){const o=n||this.lang||"zh-CN",s=u(o)[t];return"E"===t?e>=10?s.high:e>=5?s.mid:s.low:e>=70?s.high:e>=40?s.mid:s.low}getLInterpretation(e,t){const n=t||this.lang||"zh-CN",o=u(n);return e<40?o.L.low:e<70?o.L.mid:o.L.high}getPInterpretation(e,t){const n=t||this.lang||"zh-CN",o=u(n);return e<40?o.P.low:e<70?o.P.mid:o.P.high}getDInterpretation(e,t){const n=t||this.lang||"zh-CN",o=u(n);return e<40?o.D.low:e<70?o.D.mid:o.D.high}getEInterpretation(e,t){const n=t||this.lang||"zh-CN",o=u(n);return e<5?o.E.low:e<10?o.E.mid:o.E.high}getFInterpretation(e,t){const n=t||this.lang||"zh-CN",o=u(n);return e<40?o.F.low:e<70?o.F.mid:o.F.high}generateSemanticFingerprint(e){const t=this.lang||"zh-CN",n="en"===t,o=.25*e.L+.2*e.P+.2*e.D+10*e.E*.15+.2*e.F,s=[e.L,e.P,e.D,e.F,10*e.E],a=s.reduce((e,t)=>e+t,0)/s.length,i=s.reduce((e,t)=>e+Math.pow(t-a,2),0)/s.length,r=Math.sqrt(i),l=Math.max(0,100-r),c=(e,t)=>e>=("E"===t?30:70)?n?"High":"高":e>=("E"===t?12:40)?n?"Med":"中":n?"Low":"低";return{codeRatio:`${Math.round(e.L)}%`,patienceLevel:c(e.P,"P")+(n?" Patience":"耐心"),detailLevel:c(e.D,"D")+(n?" Detail":"细腻"),techExploration:c(e.E,"E")+(n?" Explore":"探索"),feedbackDensity:`${Math.round(e.F)}%`,compositeScore:Math.round(o),techDiversity:e.E>=30?n?"Extreme":"极高":e.E>=12?n?"Moderate":"中等":n?"Low":"较低",interactionStyle:this.calculateInteractionStyle(e,t),balanceIndex:(d=l,d>=80?n?"Highly Balanced":"高度平衡":d>=60?n?"Well Balanced":"较为平衡":d>=40?n?"Slightly Imbalanced":"略有偏重":n?"Severely Imbalanced":"明显偏重")};var d}calculateInteractionStyle(e,t){const n="en"===t,o=[];return e.L>=70&&o.push(n?"Code Driven":"代码驱动"),e.P>=70&&o.push(n?"Gentle":"温和引导"),e.D>=70&&o.push(n?"Detail Oriented":"细节控"),e.E>=30&&o.push(n?"Tech Explore":"技术探索"),e.F>=70&&o.push(n?"Responsive":"积极反馈"),0===o.length?n?"Balanced":"均衡型":o.join(" · ")}calculateInteractionStyle(e,t){const n="en"===t,o=[];return e.L>=70&&o.push(n?"Code Driven":"代码驱动"),e.P>=70&&o.push(n?"Gentle":"温和引导"),e.D>=70&&o.push(n?"Detail Oriented":"细节控"),e.E>=10&&o.push(n?"Tech Explore":"技术探索"),e.F>=70&&o.push(n?"Responsive":"积极反馈"),0===o.length?n?"Balanced":"均衡型":o.join(" · ")}calculateStatistics(){const e=this.userMessages.length,t=this.userMessages.reduce((e,t)=>{var n;return e+((null==(n=t.text)?void 0:n.length)||0)},0),n=t/e||0;return{totalMessages:e,avgMessageLength:Math.round(n),totalChars:t}}async uploadToSupabase(e=null,t=null,n=null){var o;let s="";try{if(n){n("en"===this.lang?"Connecting to database, syncing global ranking...":"正在连接数据库，同步全球排名...")}let a=null;if(t&&Array.isArray(t)&&t.length>0?(a=t,console.log("[VibeAnalyzer] ✅ 使用传入的 chatData 参数:",t.length,"条消息")):this.chatData&&Array.isArray(this.chatData)&&this.chatData.length>0?(a=this.chatData,console.log("[VibeAnalyzer] ✅ 使用实例变量 this.chatData:",this.chatData.length,"条消息")):"undefined"!=typeof window&&window.allChatData&&Array.isArray(window.allChatData)&&window.allChatData.length>0?(a=window.allChatData,console.log("[VibeAnalyzer] ✅ 使用全局变量 window.allChatData:",window.allChatData.length,"条消息")):this.userMessages&&Array.isArray(this.userMessages)&&this.userMessages.length>0?(console.warn("[VibeAnalyzer] ⚠️ 未找到原始聊天数据，尝试从 userMessages 构建"),a=this.userMessages.map(e=>({role:"USER",text:e.text||e.content||""})),console.log("[VibeAnalyzer] ✅ 从 userMessages 构建了",a.length,"条消息")):e&&e.originalChatData&&Array.isArray(e.originalChatData)&&e.originalChatData.length>0?(a=e.originalChatData,console.log("[VibeAnalyzer] ✅ 从 vibeResult.originalChatData 提取:",a.length,"条消息")):a=[],!a||!Array.isArray(a)||0===a.length)throw console.error("[VibeAnalyzer] ❌ 所有数据源都失败:",{hasChatDataParam:!!t,hasThisChatData:!!this.chatData,hasWindowAllChatData:"undefined"!=typeof window&&!!window.allChatData,hasUserMessages:!!this.userMessages,userMessagesLength:(null==(o=this.userMessages)?void 0:o.length)||0,hasVibeResult:!!e}),new Error("无法获取原始聊天数据，请确保已调用 analyze 方法或传入 chatData 参数");const i=a.map(e=>({role:e.role||"USER",text:e.text||e.content||""})).filter(e=>e.text&&e.text.trim().length>0);if(0===i.length)throw new Error("聊天数据为空，无法进行分析");const r=(()=>{if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return e;const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim();return e.endsWith("/")?e:e+"/"}}return"https://cursor-clinical-analysis.psterman.workers.dev/"})(),l={chatData:i,lang:this.lang||"zh-CN"};console.log("[VibeAnalyzer] 发送原始聊天数据到 /api/v2/analyze:",{messageCount:i.length,lang:l.lang,sampleMessage:i[0],payloadFormat:'严格遵循 { chatData: [...], lang: "zh-CN" } 格式'}),s=r.endsWith("/")?`${r}api/v2/analyze`:`${r}/api/v2/analyze`;const c=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!c.ok){const e=await c.text().catch(()=>"无法读取错误信息");throw new Error(`HTTP error! status: ${c.status}, error: ${e}`)}const d=await c.json();if(console.log("[VibeAnalyzer] 后端返回数据:",d),"success"===d.status){const e=d.dimensions||{},t=d.roastText||"",n=d.personalityName||"",o=d.vibeIndex||"00000",s=d.personalityType||"UNKNOWN",a=d.lpdef||"";this.analysisResult&&(this.analysisResult.dimensions=e,this.analysisResult.roastText=t,this.analysisResult.personalityName=n,this.analysisResult.vibeIndex=o,this.analysisResult.personalityType=s,this.analysisResult.lpdef=a,d.statistics&&(this.analysisResult.statistics={...this.analysisResult.statistics,...d.statistics}),d.globalAverage&&(this.analysisResult.globalAverage=d.globalAverage),console.log("[VibeAnalyzer] ✅ 已同步后端精准数据到实例状态:",{dimensions:e,roastText:t.substring(0,50)+"...",personalityName:n,vibeIndex:o}));const i=d.statistics||{},r=d.totalUsers||d.value||d.total||d.count||0,l=d.rankPercent??d.ranking??0,c=d.ranks||null,g=d.globalAverage||d.global_average||null,h={dimensions:e,roastText:t,personalityName:n,vibeIndex:o,personalityType:s,lpdef:a,rankPercent:Number(l),ranking:Number(l),totalUsers:Number(r),defeated:d.defeated??0,actualRank:d.actualRank??0,statistics:i,metadata:d.metadata||null};return c&&(h.ranks=c),g&&(h.globalAverage=g),h}throw console.warn("[VibeAnalyzer] 后端返回错误:",d),new Error(d.error||d.message||"后端返回错误状态")}catch(a){return console.error("[VibeAnalyzer] 上传排名过程出错:",{message:a.message,name:a.name,isNetworkError:a.message.includes("fetch")||a.message.includes("network")||a.message.includes("CORS"),isTimeout:a.message.includes("timeout")||a.message.includes("Timeout")}),{error:a.message,errorType:a.name,isNetworkError:a.message.includes("fetch")||a.message.includes("network")||a.message.includes("CORS"),isTimeout:a.message.includes("timeout")||a.message.includes("Timeout"),timestamp:(new Date).toISOString(),url:s||"unknown",rankPercent:0,totalUsers:0}}}getDefaultResult(e="zh-CN"){const t="en"===e;return{personalityType:"UNKNOWN",dimensions:{L:0,P:0,D:0,E:0,F:0},analysis:{type:"UNKNOWN",name:t?"Unknown":"未知类型",description:t?"Insufficient data for analysis":"数据不足，无法进行准确分析"},statistics:{},semanticFingerprint:{},vibeIndex:"00000",roastText:t?"Insufficient data for a roast":"数据不足，无法生成吐槽",personalityName:t?"Mystery Coder":"未知人格",lpdef:"L0P0D0E0F0"}}async shadowCallToWorker(e,t){try{const n=(()=>{if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return e;const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim();return e.endsWith("/")?e:e+"/"}}return"https://cursor-clinical-analysis.psterman.workers.dev/"})(),o=n.endsWith("/")?`${n}api/v2/analyze`:`${n}/api/v2/analyze`,s=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatData:e})});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const a=await s.json();if("success"===a.status&&a.dimensions){const e=a.dimensions,n=this.compareDimensions(t,e);this.shadowCallCount++,n?this.shadowMatchCount++:this.shadowMismatches.push({local:t,remote:e,timestamp:(new Date).toISOString()}),console.log(`[VibeAnalyzer] 影子调用 #${this.shadowCallCount}:`,{match:n?"✅ 完全一致":"❌ 不一致",local:t,remote:e,matchRate:`${this.shadowMatchCount}/${this.shadowCallCount}`,consecutiveMatches:this.shadowMatchCount}),this.shadowMatchCount>=50&&this.shadowCallCount===this.shadowMatchCount&&console.log("[VibeAnalyzer] 🎉 大脑发育成功！连续 50 次计算结果完全一致！")}}catch(n){console.warn("[VibeAnalyzer] 影子调用失败:",n)}}compareDimensions(e,t){const n=["L","P","D","E","F"];for(const o of n)if(Math.abs((e[o]||0)-(t[o]||0))>.01)return!1;return!0}destroy(){this.worker&&(this.worker.terminate(),this.worker=null,this.workerReady=!1)}}function M(e="zh-CN"){const t=new C(e);return console.log("[Main] 创建 VibeCodingerAnalyzer 实例，环境:",{basePath:window.BASE_PATH||"(空)",isGitHubPages:window.location.hostname.includes("github.io"),workerConfig:window.WORKER_CONFIG}),t}if(!window.BASE_PATH){const e=window.location.pathname,t=window.location.hostname,n=t.includes("github.io"),o="localhost"===t||"127.0.0.1"===t;let s="";if(o)s="";else if(n){const t=e.split("/").filter(e=>e&&"index.html"!==e);s=t.length>0?"/"+t[0]:"",console.log("[Main] GitHub Pages 路径检测:",{pathname:e,pathParts:t,detectedBasePath:s})}else{const t=e.split("/").filter(e=>e&&"index.html"!==e);s=t.length>0?"/"+t[0]:""}s&&"/"!==s&&s.endsWith("/")&&(s=s.slice(0,-1)),window.BASE_PATH=s,console.log("[Main] 检测到基础路径:",window.BASE_PATH,{hostname:t,pathname:e,isGitHubPages:n,isLocalhost:o})}window.WORKER_CONFIG={getWorkerUrl:function(e){const t=window.BASE_PATH||"";if(t){const n=`${t}/src/${e}`;return console.log("[Main] 构建 Worker URL (GitHub Pages):",n),n}{const t=`./src/${e}`;return console.log("[Main] 构建 Worker URL (本地):",t),t}},basePath:window.BASE_PATH||"",workerPath:window.BASE_PATH?`${window.BASE_PATH}/src/vibeAnalyzerWorker.js`:"./src/vibeAnalyzerWorker.js"};class k{constructor(){this.parser=null,this.analyzer=null,this.allChatData=[],this.globalStats=null,this.vibeResult=null}async init(){console.log("[VibeCodingApp] 初始化应用..."),this.parser||(this.parser=new o,await this.parser.init()),this.analyzer||(this.analyzer=M()),console.log("[VibeCodingApp] 初始化完成")}async analyzeFile(e,t=null,n=null){var o;if(!this.analyzer)throw new Error("分析器未初始化，请先调用 init()");const s=$();this.analyzer.setLanguage(s);const a=await this.analyzer.analyze(e,s,null,n);if(console.log("[VibeCodingApp] analyze 完成:",a),a&&a.statistics){const s=a.statistics;s.qingCount=(null==t?void 0:t.qingCount)||(null==L?void 0:L.qingCount)||0,s.buCount=(null==t?void 0:t.buCount)||(null==L?void 0:L.buCount)||0,s.usageDays=(null==t?void 0:t.usageDays)||(null==L?void 0:L.usageDays)||1,s.totalUserChars=s.totalUserChars||s.totalChars||0,s.userMessages=s.userMessages||s.totalMessages||0;try{const t=await this.analyzer.uploadToSupabase(a,e,n);if(t&&t.globalAverage){const e=t.globalAverage;50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?console.warn("[VibeCodingApp] ⚠️ uploadToSupabase 返回的全局平均值是默认值，忽略"):(I=e,A=!0,console.log("[VibeCodingApp] ✅ 从 uploadToSupabase 获取到全局平均值:",I))}t&&void 0!==t.rankPercent?(s.rankPercent=t.rankPercent,s.totalUsers=t.totalUsers,a.rankData||(a.rankData={}),a.rankData.rankPercent=t.rankPercent,a.rankData.totalUsers=t.totalUsers,t.ranks&&(a.rankData.ranks=t.ranks,console.log("[VibeCodingApp] ✅ ranks 对象已注入:",t.ranks)),console.log("[VibeCodingApp] 真实排名数据已获取并更新:",{rankPercent:t.rankPercent,totalUsers:t.totalUsers,hasRanks:!!t.ranks})):console.warn("[VibeCodingApp] uploadToSupabase 未返回有效的 rankPercent")}catch(i){if(console.error("[VibeCodingApp] uploadToSupabase 调用失败:",i),n){const e=$();n(`> ${(null==(o=window.i18n)?void 0:o.getText("upload.logs.rankUploadFailed",e))||("en"===e?"Failed to upload ranking data":"排名数据上传失败")}`)}}}return this.vibeResult=a,this.renderReport(a),a}async analyzeFileSync(e,t=null,n=null){var o;if(!this.analyzer)throw new Error("分析器未初始化，请先调用 init()");const s=$();this.analyzer.setLanguage(s);const a=await this.analyzer.analyzeSync(e,s,null,n);if(console.log("[VibeCodingApp] analyzeSync 完成:",a),a&&a.statistics){const s=a.statistics;s.qingCount=(null==t?void 0:t.qingCount)||(null==L?void 0:L.qingCount)||0,s.buCount=(null==t?void 0:t.buCount)||(null==L?void 0:L.buCount)||0,s.usageDays=(null==t?void 0:t.usageDays)||(null==L?void 0:L.usageDays)||1,s.totalUserChars=s.totalUserChars||s.totalChars||0,s.userMessages=s.userMessages||s.totalMessages||0;try{const t=await this.analyzer.uploadToSupabase(a,e,n);if(t&&t.globalAverage){const e=t.globalAverage;50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?console.warn("[VibeCodingApp] ⚠️ uploadToSupabase 返回的全局平均值是默认值（同步方法），忽略"):(I=e,A=!0,console.log("[VibeCodingApp] ✅ 从 uploadToSupabase 获取到全局平均值（同步方法）:",I))}t&&void 0!==t.rankPercent?(s.rankPercent=t.rankPercent,s.totalUsers=t.totalUsers,a.rankData||(a.rankData={}),a.rankData.rankPercent=t.rankPercent,a.rankData.totalUsers=t.totalUsers,t.ranks&&(a.rankData.ranks=t.ranks,console.log("[VibeCodingApp] ✅ ranks 对象已注入（同步方法）:",t.ranks)),console.log("[VibeCodingApp] 真实排名数据已获取并更新（同步方法）:",{rankPercent:t.rankPercent,totalUsers:t.totalUsers,hasRanks:!!t.ranks})):console.warn("[VibeCodingApp] uploadToSupabase 未返回有效的 rankPercent（同步方法）")}catch(i){if(console.error("[VibeCodingApp] uploadToSupabase 调用失败（同步方法）:",i),n){const e=$();n(`> ${(null==(o=window.i18n)?void 0:o.getText("upload.logs.rankUploadFailed",e))||("en"===e?"Failed to upload ranking data":"排名数据上传失败")}`)}}}return this.vibeResult=a,this.renderReport(a),a}renderReport(e){e?(S=e,document.getElementById("vibeCodingerSection")&&he(),console.log("[VibeCodingApp] 报告渲染完成")):console.warn("[VibeCodingApp] 没有结果可渲染")}}let E=null,x=[],L=null,P=null,S=null,I={L:50,P:50,D:50,E:50,F:50},A=!1,D=!1,T=null;function $(){return"en"===localStorage.getItem("appLanguage")?"en":"zh-CN"}function R(e){return window.i18n&&window.i18n.getText?window.i18n.getText(e,$()):e}const B=()=>L,W=()=>x,F=()=>S,j=()=>E,U=()=>P,O=e=>{e&&(L=e,console.log("[Main] 已设置分享模式的统计数据:",L))},N=e=>{e&&(S=e,console.log("[Main] 已设置分享模式的 Vibe 结果:",S))},z=e=>{e&&Array.isArray(e)&&(x=e,console.log("[Main] 已设置分享模式的聊天数据:",x.length,"条"))},q=async(e,t,n)=>{console.log("[Main] processFiles 被调用",{filesCount:e.length,type:t}),E||(console.log("[Main] 解析器未初始化，正在初始化..."),E=new o,await E.init(),P=M(),console.log("[Main] 解析器初始化完成"));const s={target:{files:e,value:""}};try{return await ee(s,t,n)}catch(a){throw console.error("[Main] processFiles 错误:",a),(null==n?void 0:n.onError)&&n.onError(a),a}},V=async e=>{if(!P||!x||0===x.length)return console.warn("[Main] 无法重新分析：缺少数据或分析器"),null;console.log("[Main] 使用新语言重新分析:",e),P.setLanguage(e);try{let n=1;if(L&&L.earliestFileTime){const e=Date.now(),t=e-L.earliestFileTime;n=Math.max(1,Math.floor(t/864e5))}if(S=await P.analyze(x,e,null),console.log("[Main] 重新分析完成"),S&&S.statistics){S.statistics.qingCount=(null==L?void 0:L.qingCount)||0,S.statistics.buCount=(null==L?void 0:L.buCount)||0,S.statistics.usageDays=n;try{const e=await P.uploadToSupabase(S,x);if(e&&e.globalAverage){const t=e.globalAverage;50===t.L&&50===t.P&&50===t.D&&50===t.E&&50===t.F?console.warn("[Main] ⚠️ uploadToSupabase 返回的全局平均值是默认值，忽略"):(I=t,A=!0,console.log("[Main] ✅ 从 uploadToSupabase 获取到全局平均值:",I))}e&&void 0!==e.rankPercent&&(S.statistics.rankPercent=e.rankPercent,S.statistics.totalUsers=e.totalUsers,S.rankData||(S.rankData={}),S.rankData.rankPercent=e.rankPercent,S.rankData.totalUsers=e.totalUsers,e.ranks&&(S.rankData.ranks=e.ranks,console.log("[Main] ✅ ranks 对象已注入:",e.ranks)),console.log("[Main] 真实排名数据已获取并覆盖:",{rankPercent:e.rankPercent,totalUsers:e.totalUsers,hasRanks:!!e.ranks}))}catch(t){console.error("[Main] uploadToSupabase 调用失败:",t)}}return document.getElementById("vibeCodingerSection")&&he(),S}catch(n){console.warn("[Main] 异步分析失败，使用同步方法:",n);let o=1;if(L&&L.earliestFileTime){const e=Date.now()-L.earliestFileTime;o=Math.max(1,Math.floor(e/864e5))}if(S=await P.analyzeSync(x,e,null),S&&S.statistics){S.statistics.qingCount=(null==L?void 0:L.qingCount)||0,S.statistics.buCount=(null==L?void 0:L.buCount)||0,S.statistics.usageDays=o;try{const e=await P.uploadToSupabase(S,x);if(e&&e.globalAverage){const t=e.globalAverage;50===t.L&&50===t.P&&50===t.D&&50===t.E&&50===t.F?console.warn("[Main] ⚠️ uploadToSupabase 返回的全局平均值是默认值（同步方法），忽略"):(I=t,A=!0,console.log("[Main] ✅ 从 uploadToSupabase 获取到全局平均值（同步方法）:",I))}e&&void 0!==e.rankPercent&&(S.statistics.rankPercent=e.rankPercent,S.statistics.totalUsers=e.totalUsers,S.rankData||(S.rankData={}),S.rankData.rankPercent=e.rankPercent,S.rankData.totalUsers=e.totalUsers,e.ranks&&(S.rankData.ranks=e.ranks,console.log("[Main] ✅ ranks 对象已注入（同步方法）:",e.ranks)),console.log("[Main] 真实排名数据已获取并覆盖（同步方法）:",{rankPercent:e.rankPercent,totalUsers:e.totalUsers,hasRanks:!!e.ranks}))}catch(t){console.error("[Main] uploadToSupabase 调用失败（同步方法）:",t)}}return document.getElementById("vibeCodingerSection")&&he(),S}},_=async e=>{const t=e||window.vibeResult||globalThis.vibeResult;if(console.log("[Main] renderFullDashboard 被调用"),console.log("[Main] 数据状态:",{hasGlobalStats:!!L,hasVibeResult:!!t,chatDataLength:x.length}),console.log("[Main] 更新元素引用..."),Q.totalConversations=document.getElementById("totalConversations"),Q.userMessages=document.getElementById("userMessages"),Q.qingCount=document.getElementById("qingCount"),Q.buCount=document.getElementById("buCount"),Q.totalUserChars=document.getElementById("totalUserChars"),Q.avgUserMessageLength=document.getElementById("avgUserMessageLength"),Q.questionMessageCount=document.getElementById("questionMessageCount"),Q.topChineseWordsList=document.getElementById("topChineseWordsList"),J.searchInput=document.getElementById("searchInput"),J.chatList=document.getElementById("chatList"),J.paginationContainer=document.getElementById("paginationContainer"),J.paginationInfo=document.getElementById("paginationInfo"),J.paginationPages=document.getElementById("paginationPages"),J.paginationPrev=document.getElementById("paginationPrev"),J.paginationNext=document.getElementById("paginationNext"),J.exportBtn=document.getElementById("exportBtn"),console.log("[Main] 元素引用更新完成:",{totalConversations:!!Q.totalConversations,userMessages:!!Q.userMessages,qingCount:!!Q.qingCount,buCount:!!Q.buCount,chatList:!!J.chatList}),L&&(console.log("[Main] 调用 displayStats..."),ae()),t){console.log("[Main] 调用 displayVibeCodingerAnalysis..."),he();try{await async function(e){const t=e||window.vibeResult||globalThis.vibeResult;try{if(!t||!L)return void console.warn("[Main] displayRealtimeStats: 缺少必要数据",{hasVibeResult:!!t,hasGlobalStats:!!L});const e=window.shareModeStats||window.shareModeVibeResult;let a;try{if(e){const e=parseInt(localStorage.getItem("totalTestUsers")||"0");a=e>0?e:1e3,console.log("[Main] 分享模式：使用缓存的 totalTestUsers:",a)}else a=await we()}catch(n){console.error("[Main] 获取测试总人数失败，使用默认值:",n),a=1e3}const i=a;let r=null,l=0;try{if(t&&t.rankData){const e=t.rankData,n=e.ranking??e.rankPercent??null;if(null!=n){const e=Number(n);isNaN(e)||(e>=0&&e<=100?r=e:e>0&&a>0&&(r=(a-e)/a*100))}if(null!==r&&!isNaN(r)&&r>=0&&r<=100){console.log("[Main] 使用后端返回的真实排名:",r);const e=r/100;l=Math.max(1,Math.round(a*(1-e)))}else console.warn("[Main] 警告：排名数据格式异常或无效，将显示为 0",{rankPercent:r,rankingValue:n,rankData:t.rankData}),r=null,l=0}else if(t&&!e&&P)try{t.statistics&&(t.statistics.qingCount=(null==L?void 0:L.qingCount)||0,t.statistics.buCount=(null==L?void 0:L.buCount)||0,t.statistics.usageDays=(null==L?void 0:L.usageDays)||1),console.log("[Main] displayRealtimeStats: 调用 uploadToSupabase 上传数据并获取排名");const e=void 0!==x?x:"undefined"!=typeof window&&window.allChatData||null,n=await P.uploadToSupabase(t,e);if(n&&n.globalAverage){const e=n.globalAverage;50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?console.warn("[Main] ⚠️ uploadToSupabase 返回的全局平均值是默认值，忽略"):(I=e,A=!0,console.log("[Main] ✅ 从 uploadToSupabase 获取到全局平均值:",I),window.vibeRadarChartInstance&&ue())}if(!n||void 0===n.rankPercent&&void 0===n.ranking)console.warn("[Main] uploadToSupabase 未返回有效的排名数据"),r=null,l=0;else{const e=n.rankPercent??n.ranking??0;if(t.rankData||(t.rankData={}),t.rankData.rankPercent=e,t.rankData.totalUsers=n.totalUsers||a,n.ranks&&(t.rankData.ranks=n.ranks,console.log("[Main] ✅ ranks 对象已注入（displayRealtimeStats）:",n.ranks)),r=e,r>=0&&r<=100){const e=r/100;l=Math.max(1,Math.round(a*(1-e))),console.log("[Main] 成功获取排名数据:",{rankPercent:r,estimatedRank:l,totalUsers:n.totalUsers,hasRanks:!!n.ranks})}}}catch(o){console.error("[Main] uploadToSupabase 调用失败:",o),r=null,l=0}else console.warn("[Main] 警告：后端排名数据不可用，排名将显示为 0",{hasVibeResult:!!t,hasRankData:!(!t||!t.rankData),isShareMode:e,hasVibeAnalyzer:!!P}),r=null,l=0}catch(s){console.warn("[Main] 处理排名数据时发生错误，将显示为 0:",s),r=null,l=0}const c=243,d=1,g=Math.round(d/c*100),h=document.getElementById("totalTestUsers"),u=document.getElementById("techRank"),p=document.getElementById("personalityUnlock");if(h&&(i!==a?pe(h,a,ie):h.textContent=ie(a)),u&&(null!=l&&!isNaN(l)&&l>=0?pe(u,l,ie):(console.warn("[Main] 排名数据无效，将显示为 0"),pe(u,0,ie))),p){const e=`${g}%`;p.textContent!==e?pe(p,g,e=>`${e}%`):p.textContent=e}console.log("[Main] 实时统计已更新:",{totalTestUsers:a,techRank:l,unlockProgress:`${g}%`})}catch(s){console.error("[Main] displayRealtimeStats 执行失败，但不影响后续逻辑:",s)}}(t)}catch(n){console.error("[Main] 统计上传失败:",n)}try{!function(){if(!S||!S.dimensions)return;const e=document.getElementById("dimensionRankingList");if(!e)return;const{dimensions:t}=S,n=$(),o=Object.entries(t).map(([e,t])=>{var o,s,a,i;const r=null==(a=null==(s=null==(o=window.i18n)?void 0:o.getI18nText(n))?void 0:s.dimensions)?void 0:a[e];return{key:e,label:(null==r?void 0:r.label)||(null==(i=h[e])?void 0:i.label)||e,value:t,displayValue:"E"===e?t:Math.round(t)}}).sort((e,t)=>{const n="E"===e.key?10*e.value:e.value;return("E"===t.key?10*t.value:t.value)-n});e.innerHTML=o.map((e,t)=>{var o,s;const a=t+1,i=1===a?"🥇":2===a?"🥈":3===a?"🥉":`#${a}`,r="E"===e.key?10:100,l=Math.min(100,Math.round(e.value/r*100)),c="E"===e.key?(null==(o=window.i18n)?void 0:o.getText("dashboard.techUnit",n))||"种技术":(null==(s=window.i18n)?void 0:s.getText("dashboard.pointsUnit",n))||"分";return`\n      <div class="prompt-item" style="background: ${a<=3?"rgba(0, 255, 65, 0.1)":"rgba(255, 255, 255, 0.03)"}; border-color: ${a<=3?"rgba(0, 255, 65, 0.3)":"var(--card-border)"};">\n        <span class="prompt-rank" style="font-size: 20px; min-width: 50px;">${i}</span>\n        <span class="prompt-text" style="flex: 1; font-weight: 600;">${e.label}</span>\n        <div style="display: flex; align-items: center; gap: 12px;">\n          <div style="width: 120px; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">\n            <div style="width: ${l}%; height: 100%; background: var(--accent-terminal); transition: width 0.5s ease;"></div>\n          </div>\n          <span class="prompt-count" style="min-width: 80px; text-align: right; font-weight: 700; color: var(--accent-terminal);">${e.displayValue} ${c}</span>\n        </div>\n      </div>\n    `}).join(""),console.log("[Main] 维度排行榜已渲染:",o)}()}catch(n){console.error("[Main] displayDimensionRanking 调用失败:",n)}}x.length>0&&(console.log("[Main] 渲染对话列表..."),G=1,le(x)),console.log("[Main] 渲染词云..."),Ee(),console.log("[Main] renderFullDashboard 完成")};const H=async()=>(E||(console.log("[Main] 初始化解析器（模块模式）..."),E=new o,await E.init(),P=M(),console.log("[Main] 解析器初始化完成")),{parser:E,vibeAnalyzer:P});let G=1,K=20,Y=[];const J={uploadSection:document.getElementById("uploadSection"),loadingSection:document.getElementById("loadingSection"),dashboardSection:document.getElementById("dashboardSection"),uploadBtn:document.getElementById("uploadBtn"),selectFolderBtn:document.getElementById("selectFolderBtn"),folderInput:document.getElementById("folderInput"),fileInput:document.getElementById("fileInput"),exportBtn:document.getElementById("exportBtn"),selectFileBtn:document.getElementById("selectFileBtn"),uploadError:document.getElementById("uploadError"),loadingProgress:document.getElementById("loadingProgress"),exportArea:document.getElementById("exportArea"),searchInput:document.getElementById("searchInput"),chatList:document.getElementById("chatList"),paginationContainer:document.getElementById("paginationContainer"),paginationInfo:document.getElementById("paginationInfo"),paginationPages:document.getElementById("paginationPages"),paginationPrev:document.getElementById("paginationPrev"),paginationNext:document.getElementById("paginationNext")},Q={totalConversations:document.getElementById("totalConversations"),userMessages:document.getElementById("userMessages"),qingCount:document.getElementById("qingCount"),buCount:document.getElementById("buCount"),topChineseWordsList:document.getElementById("topChineseWordsList"),totalUserChars:document.getElementById("totalUserChars"),avgUserMessageLength:document.getElementById("avgUserMessageLength"),questionMessageCount:document.getElementById("questionMessageCount")};async function Z(){console.log("[Main] ===== 应用初始化开始 ====="),console.log("[Main] 当前时间:",(new Date).toISOString()),"loading"===document.readyState&&(console.log("[Main] 等待 DOM 加载..."),await new Promise(e=>{document.addEventListener("DOMContentLoaded",e)})),console.log("[Main] DOM 已就绪，开始获取元素..."),J.uploadSection=document.getElementById("uploadSection"),J.loadingSection=document.getElementById("loadingSection"),J.dashboardSection=document.getElementById("dashboardSection"),J.uploadBtn=document.getElementById("uploadBtn"),J.selectFolderBtn=document.getElementById("selectFolderBtn"),J.folderInput=document.getElementById("folderInput"),J.fileInput=document.getElementById("fileInput"),J.exportBtn=document.getElementById("exportBtn"),J.selectFileBtn=document.getElementById("selectFileBtn"),J.uploadError=document.getElementById("uploadError"),J.loadingProgress=document.getElementById("loadingProgress"),J.exportArea=document.getElementById("exportArea"),J.searchInput=document.getElementById("searchInput"),J.chatList=document.getElementById("chatList"),J.paginationContainer=document.getElementById("paginationContainer"),J.paginationInfo=document.getElementById("paginationInfo"),J.paginationPages=document.getElementById("paginationPages"),J.paginationPrev=document.getElementById("paginationPrev"),J.paginationNext=document.getElementById("paginationNext"),console.log("[Main] 初始化 CursorParser..."),E=new o,await E.init(),console.log("[Main] CursorParser 初始化完成"),console.log("[Main] 初始化 VibeCodingerAnalyzer..."),P=new C,console.log("[Main] VibeCodingerAnalyzer 初始化完成"),console.log("[Main] 初始化 VibeCodingApp..."),T=new k,T.parser=E,T.analyzer=P,console.log("[Main] VibeCodingApp 初始化完成"),console.log("[Main] 开始获取全局平均值..."),ye().then(e=>{50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?(console.warn("[Main] ⚠️ 获取到的数据是默认值，可能 API 请求失败"),A=!1):(I=e,A=!0,console.log("[Main] ✅ 全局平均值已从 API 成功加载:",I)),S&&window.vibeRadarChartInstance&&(console.log("[Main] 更新已渲染的雷达图..."),ue())}).catch(e=>{console.error("[Main] ❌ 获取全局平均值失败:",e),A=!1,console.log("[Main] 使用默认全局平均值:",I)}),function(){console.log("[Main] 开始绑定事件..."),J.uploadBtn?(console.log("[Main] ✅ uploadBtn 元素已找到"),J.uploadBtn.addEventListener("click",e=>{console.log("[Main] 点击上传按钮"),e.preventDefault(),X(J.folderInput)})):console.error("[Main] ❌ uploadBtn 元素未找到");J.selectFolderBtn?(console.log("[Main] ✅ selectFolderBtn 元素已找到"),J.selectFolderBtn.addEventListener("click",e=>{console.log("[Main] 点击选择文件夹按钮"),e.preventDefault(),X(J.folderInput)})):console.error("[Main] ❌ selectFolderBtn 元素未找到");J.selectFileBtn?(console.log("[Main] ✅ selectFileBtn 元素已找到"),J.selectFileBtn.addEventListener("click",e=>{console.log("[Main] 点击选择文件按钮"),e.preventDefault(),X(J.fileInput)})):console.error("[Main] ❌ selectFileBtn 元素未找到");J.folderInput?(console.log("[Main] ✅ folderInput 元素已找到"),J.folderInput.addEventListener("change",e=>{console.log("[Main] 文件夹选择事件触发"),ee(e,"folder")})):console.error("[Main] ❌ folderInput 元素未找到");J.fileInput?(console.log("[Main] ✅ fileInput 元素已找到"),J.fileInput.addEventListener("change",e=>{console.log("[Main] 文件选择事件触发"),ee(e,"file")})):console.error("[Main] ❌ fileInput 元素未找到");J.searchInput&&J.searchInput.addEventListener("input",function(e,t){let n;return function(...o){const s=()=>{clearTimeout(n),e(...o)};clearTimeout(n),n=setTimeout(s,t)}}(ce,300));J.paginationPrev&&J.paginationPrev.addEventListener("click",()=>{G>1&&(G--,le(Y))});J.paginationNext&&J.paginationNext.addEventListener("click",()=>{const e=Math.ceil(Y.length/K);G<e&&(G++,le(Y))});J.exportBtn&&J.exportBtn.addEventListener("click",de);console.log("[Main] 事件绑定完成")}(),console.log("[Main] ===== 应用初始化完成 =====")}function X(e){if(console.log("[Main] 尝试触发文件选择..."),console.log("[Main] inputElement:",e),console.log("[Main] inputElement.type:",null==e?void 0:e.type),e)try{if(e.value="",e.click)e.click();else{const t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});e.dispatchEvent(t)}console.log("[Main] ✅ 文件选择已触发")}catch(t){console.error("[Main] ❌ 触发文件选择失败:",t),alert("无法打开文件选择对话框，请检查浏览器设置或刷新页面重试。")}else console.error("[Main] ❌ inputElement 为 null")}async function ee(e,t,n={}){var o,s,a,i,r,l,c,d,g;const{onProgress:h,onLog:u,onComplete:p,onError:m}=n;console.log(`[Main] 处理文件上传，类型: ${t}`),console.log(`[Main] event.files.length: ${null==(o=e.target.files)?void 0:o.length}`);const b=Array.from(e.target.files||[]);if(n&&n.onLog||J.uploadError&&(J.uploadError.classList.add("hidden"),J.uploadError.textContent=""),0===b.length)return console.warn("[Main] 没有选择文件"),void((null==n?void 0:n.onError)&&n.onError(new Error("没有选择文件")));if(console.log(`[Main] 选择了 ${b.length} 个文件`),console.log("[Main] 文件列表:"),b.forEach((e,t)=>{console.log(`  [${t+1}] ${e.name} (${function(e){if(0===e)return"0 B";const t=1024,n=["B","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,o)*100)/100+" "+n[o]}(e.size)})`)}),n&&n.onLog){if(n.onLog){const e=$(),t=(null==(s=window.i18n)?void 0:s.getText("upload.logs.startProcessing",e))||"开始处理文件...";n.onLog(`> ${t}`)}}else ne();try{let e=[],o=[];if("folder"===t){if(e=b.filter(e=>"state.vscdb"===e.name),o=b.filter(e=>"state.vscdb"!==e.name),console.log(`[Main] 文件夹模式：找到 ${e.length} 个 state.vscdb 文件`),o.length>0&&(console.log(`[Main] 已过滤 ${o.length} 个非数据库文件`),o.length<=10&&console.log("[Main] 过滤的文件:",o.map(e=>e.name))),0===e.length){const e=o.slice(0,5).map(e=>e.name).join(", "),t=0===o.length?"未找到 state.vscdb 文件，请选择正确的 Cursor workspaceStorage 目录":`未找到 state.vscdb 文件。选中的文件包括：${e}${o.length>5?"...":""}`;throw new Error(t)}}else{const t=[".vscdb",".db",".sqlite",".sqlite3"];if(e=b.filter(e=>t.some(t=>e.name.toLowerCase().endsWith(t))),o=b.filter(e=>!t.some(t=>e.name.toLowerCase().endsWith(t))),console.log(`[Main] 单文件模式：找到 ${e.length} 个数据库文件`),o.length>0&&(console.log(`[Main] 已过滤 ${o.length} 个非数据库文件`),console.log("[Main] 过滤的文件:",o.map(e=>e.name))),0===e.length){const e=o.slice(0,3).map(e=>e.name).join(", "),t=0===o.length?"未找到有效的数据库文件（.vscdb, .db, .sqlite, .sqlite3）":`未找到有效的数据库文件。选择的是：${e}${o.length>3?"...":""}，请选择数据库文件`;throw new Error(t)}}let s=null;if(b.length>0){for(const e of b)e.lastModified&&(null===s||e.lastModified<s)&&(s=e.lastModified);console.log("[Main] 最早文件时间:",s?new Date(s).toISOString():"未找到")}L={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},chineseEmotionWords:{},englishWords:{},earliestFileTime:s,userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}},x=[];let m=0;for(const t of e)try{console.log(`[Main] 正在处理: ${t.name}`),t.webkitRelativePath&&console.log(`[Main] 相对路径: ${t.webkitRelativePath}`);const o=await t.arrayBuffer();console.log(`[Main] 文件大小: ${o.byteLength} bytes`),await E.loadDatabase(o);const s=await E.scanDatabase();if(console.log(`[Main] 提取到 ${s.length} 条记录`),x=x.concat(s),te(L,E.stats),m++,n&&n.onLog||se(m,e.length),h&&h(m,e.length,t.name),u){const n=$(),o=((null==(a=window.i18n)?void 0:a.getText("upload.logs.processed",n))||"已处理 {current}/{total}: {fileName}").replace("{current}",m).replace("{total}",e.length).replace("{fileName}",t.name);u(`> ${o}`)}console.log("[Main] 当前统计:",{totalConversations:L.totalConversations,userMessages:L.userMessages,aiMessages:L.aiMessages,topPromptsCount:Object.keys(L.topPrompts).length})}catch(f){console.error(`[Main] 处理文件失败: ${t.name}`,f)}if(console.log(`[Main] 总共提取 ${x.length} 条对话记录`),0===x.length)throw new Error("未找到任何对话数据，请检查数据库文件是否正确");if(console.log("[Main] 开始重新计算统计（包括词云数据）..."),u){const e=$(),t=(null==(i=window.i18n)?void 0:i.getText("upload.logs.calculatingStats",e))||"计算统计数据...";u(`> ${t}`)}if(function(e){console.log("[Main] 开始计算统计...");const t=(null==L?void 0:L.earliestFileTime)||null;L={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},chineseEmotionWords:{},englishWords:{},totalCodeChars:0,earliestFileTime:t,userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}},e.forEach(e=>{if("USER"===e.role?L.userMessages++:(L.aiMessages++,L.totalConversations++),e.text&&e.text.length>0&&"USER"!==e.role){const t=e.text.match(/```[\s\S]*?```/g);t&&t.forEach(e=>{const t=e.replace(/```[\w]*\n?/g,"").replace(/```/g,"").length;t>0&&(L.totalCodeChars+=t,console.log(`[Main] [AI] 代码块 +${t} 字符，总计: ${L.totalCodeChars}`))});const n=e.text.match(/`[^`\n]+`/g);if(n&&n.forEach(e=>{const t=e.replace(/`/g,"").length;t>0&&(L.totalCodeChars+=t,console.log(`[Main] [AI] 行内代码 +${t} 字符，总计: ${L.totalCodeChars}`))}),!t&&!n){const t=[/\b(function|class|const|let|var|if|else|for|while|do|switch|case|break|continue|return|import|export|from|async|await|yield|try|catch|finally|throw|new|this)\b/i,/\b(public|private|protected|static|final|abstract|interface|extends|implements|super)\b/i,/\b(def |class |import |from |if |elif |else |for |while |try |except |finally |return |yield |with |as |lambda |pass |break |continue )/];let n=0;for(const s of t)s.test(e.text)&&n++;const o=["def ","def\n","func ","func\n","fn ","#include","import ","#define","@","defclass ","class "];for(const s of o)if(e.text.includes(s)){n+=2;break}if(n>=3){const t=/\b(function|class|const|let|var|def |func |fn |import |#include|public|private)\b/i,o=e.text.match(t);if(o&&void 0!==o.index){const t=o.index,s=Math.min(t+5e3,e.text.length)-t,a=Math.round(.7*s);L.totalCodeChars+=a,console.log(`[Main] [AI] 代码段（估算） +${a} 字符（代码特征=${n}），总计: ${L.totalCodeChars}`)}}}}const t=e.model||"unknown";if(L.modelUsage[t]=(L.modelUsage[t]||0)+1,console.log(`[Main] 模型使用: ${t} = ${L.modelUsage[t]}`),e.timestamp)try{const t=new Date(e.timestamp).getHours();L.hourlyActivity[t]++}catch(n){console.error("[Main] 时段统计失败:",n)}if(e.timestamp)try{const t=new Date(e.timestamp).toISOString().split("T")[0];L.dailyActivity[t]=(L.dailyActivity[t]||0)+1}catch(n){console.error("[Main] 日期统计失败:",n)}if("USER"===e.role&&e.text){const t=e.text.length;L.userBehaviorStats.totalUserChars+=t,(e.text.includes("?")||e.text.includes("？"))&&L.userBehaviorStats.questionMessageCount++;const n=e.text.match(/请/g);n&&(L.qingCount+=n.length);const o=e.text.match(/不/g);o&&(L.buCount+=o.length),function(e){const t=new Set(["的","是","在","了","我","你","他","她","它","我们","你们","他们","和","或","但是","因为","所以","如果","就","也","都","很","非常","可以","能","会","要","有","没","不","来","去","这","那","个","请","帮","写","一个","怎么","如何","什么","哪个","哪个","吗","呢","吧","啊","哦","嗯","哈","嘿","好","the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","must","to","of","in","for","on","at","by","with","from","as","into","through","during","before","after","above","below","between","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","mine","theirs","am","is","are","was","were","be","been","being","have","has","had","can","could","will","would","should","may","might","must","please","help","write","a","one","some","any","all","both","how","what","which","who","when","where","why","whether","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front","forward"]),n=/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g,o=e.match(n)||[];o.forEach(e=>{if(e.length<2)return;if(e.length>20)return;const n=e.toLowerCase();t.has(n)||(L.topPrompts[n]=(L.topPrompts[n]||0)+1)});const s=Object.keys(L.topPrompts).length;console.log(`[Main] 提取到 ${s} 个唯一词，${o.length} 个总词`)}(e.text),function(e){if(!e||0===e.length)return;const t=new Set(["的","是","在","了","我","你","他","她","它","我们","你们","他们","和","或","但是","因为","所以","如果","就","也","都","很","非常","可以","能","会","要","有","没","不","来","去","这","那","个","请","帮","写","一个","怎么","如何","什么","哪个","吗","呢","吧","啊","哦","嗯","哈","嘿","好"]),n=/[\u4e00-\u9fa5]{2,}/g;(e.match(n)||[]).forEach(e=>{if(e.length>10)return;const n=e.trim();t.has(n)||(L.topChineseWords=L.topChineseWords||{},L.topChineseWords[n]=(L.topChineseWords[n]||0)+1)})}(e.text),function(e){if(!e||0===e.length)return;if(!L)return void console.warn("[Main] extractWordCloudData: globalStats 未初始化");const t=new Set(["的","是","在","了","我","你","他","她","它","我们","你们","他们","和","或","但是","因为","所以","如果","就","也","都","很","非常","可以","能","会","要","有","没","不","来","去","这","那","个","请","帮","写","一个","怎么","如何","什么","哪个","吗","呢","吧","啊","哦","嗯","哈","嘿","好"]),n=new Set(["the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","to","of","in","for","on","at","by","with","from","as","into","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","can","could","will","would","should","may","might","must","please","help","write","one","some","any","all","both","how","what","which","who","when","where","why","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front"]);L.chineseWords=L.chineseWords||{},L.chineseEmotionWords=L.chineseEmotionWords||{},L.englishWords=L.englishWords||{};const o=e.match(/[\u4e00-\u9fa5]/g)||[];for(let l=0;l<o.length-1;l++){const e=o[l]+o[l+1];if(t.has(e)||t.has(o[l])||t.has(o[l+1])||(L.chineseWords[e]=(L.chineseWords[e]||0)+1,ke(e)&&(L.chineseEmotionWords[e]=(L.chineseEmotionWords[e]||0)+2)),l<o.length-2){const e=o[l]+o[l+1]+o[l+2];t.has(e)||t.has(o[l])||t.has(o[l+1])||t.has(o[l+2])||(L.chineseWords[e]=(L.chineseWords[e]||0)+1,ke(e)&&(L.chineseEmotionWords[e]=(L.chineseEmotionWords[e]||0)+2))}}for(let l=0;l<o.length-3;l++){const e=o[l]+o[l+1]+o[l+2]+o[l+3];t.has(e)||(L.chineseWords[e]=(L.chineseWords[e]||0)+1,ke(e)&&(L.chineseEmotionWords[e]=(L.chineseEmotionWords[e]||0)+2))}const s=/\b[a-zA-Z]{2,20}\b/g,a=e.match(s)||[];a.forEach(e=>{const t=e.toLowerCase();!n.has(t)&&e.length>=2&&e.length<=20&&(L.englishWords[t]=(L.englishWords[t]||0)+1)});const i=a.map(e=>e.toLowerCase()).filter(e=>!n.has(e)&&e.length>=2&&e.length<=20);for(let l=0;l<i.length-1;l++){const e=i[l],t=i[l+1];if(!n.has(e)&&!n.has(t)){const n=e+" "+t;L.englishWords[n]=(L.englishWords[n]||0)+1}}for(let l=0;l<i.length-2;l++){const e=i[l],t=i[l+1],o=i[l+2];if(!n.has(e)&&!n.has(t)&&!n.has(o)){const n=e+" "+t+" "+o;L.englishWords[n]=(L.englishWords[n]||0)+1}}const r=L.userMessages||0;r>0&&r%100==0&&console.log(`[Main] extractWordCloudData: 已处理 ${r} 条消息，中文词组: ${Object.keys(L.chineseWords).length}，情绪类词组: ${Object.keys(L.chineseEmotionWords).length}，英文词组: ${Object.keys(L.englishWords).length}`)}(e.text)}}),L.userMessages>0&&(L.userBehaviorStats.avgUserMessageLength=Math.round(L.userBehaviorStats.totalUserChars/L.userMessages));console.log("[Main] 统计计算完成:",{totalConversations:L.totalConversations,userMessages:L.userMessages,aiMessages:L.aiMessages,totalCodeChars:L.totalCodeChars,totalUserChars:L.userBehaviorStats.totalUserChars,avgUserMessageLength:L.userBehaviorStats.avgUserMessageLength,qingCount:L.qingCount,buCount:L.buCount,modelUsageCount:Object.keys(L.modelUsage).length,topPromptsCount:Object.keys(L.topPrompts).length,hourlyNonZero:L.hourlyActivity.filter(e=>e>0).length,dailyCount:Object.keys(L.dailyActivity).length,chineseWordsCount:Object.keys(L.chineseWords||{}).length,englishWordsCount:Object.keys(L.englishWords||{}).length})}(x),console.log("[Main] 统计计算完成，词云数据:",{chineseWords:Object.keys(L.chineseWords||{}).length,englishWords:Object.keys(L.englishWords||{}).length}),x.length>0){if(console.log("[Main] 开始 Vibe Codinger 人格分析（使用 VibeCodingApp）..."),u){const e=$(),t=(null==(r=window.i18n)?void 0:r.getText("upload.logs.generatingPersonality",e))||"生成人格画像（高性能匹配中）...";u(`> ${t}`)}try{T||(T=new k,await T.init()),T.analyzer=P;let e=1;if(L&&L.earliestFileTime){const t=Date.now(),n=t-L.earliestFileTime;e=Math.max(1,Math.floor(n/864e5))}const t=L?{qingCount:L.qingCount||0,buCount:L.buCount||0,usageDays:e}:null,o=e=>{u&&u(`> ${e}`),n&&n.onLog||ne(e)};if(S=await T.analyzeFile(x,t,o),console.log("[Main] Vibe Codinger 分析完成（使用 VibeCodingApp）:",S),n&&n.onLog||oe(),u){const e=$(),t=(null==(l=window.i18n)?void 0:l.getText("upload.logs.analysisComplete",e))||"分析完成！";u(`> ${t}`)}}catch(f){if(console.error("[Main] Vibe Codinger 分析失败，使用降级方案:",f),u){const e=$(),t=(null==(c=window.i18n)?void 0:c.getText("upload.logs.analysisFailed",e))||"分析失败，使用降级方案...";u(`> ${t}`)}try{T||(T=new k,await T.init()),T.analyzer=P;let e=1;if(L&&L.earliestFileTime){const t=Date.now(),n=t-L.earliestFileTime;e=Math.max(1,Math.floor(n/864e5))}const t=L?{qingCount:L.qingCount||0,buCount:L.buCount||0,usageDays:e}:null,o=e=>{u&&u(`> ${e}`),n&&n.onLog||ne(e)};if(S=await T.analyzeFileSync(x,t,o),console.log("[Main] Vibe Codinger 分析完成（使用 VibeCodingApp 同步方法）:",S),n&&n.onLog||oe(),u){const e=$(),t=(null==(d=window.i18n)?void 0:d.getText("upload.logs.analysisComplete",e))||"分析完成！";u(`> ${t}`)}}catch(v){if(console.error("[Main] 同步方法也失败:",v),u){const e=$(),t=(null==(g=window.i18n)?void 0:g.getText("upload.logs.analysisFailed",e))||"分析失败";u(`> ${t}`)}}}}p?p({stats:L,chatData:x,vibeResult:S}):(!function(){console.log("[Main] 显示分析结果..."),J.uploadSection&&J.uploadSection.classList.add("hidden");J.loadingSection&&J.loadingSection.classList.add("hidden");J.dashboardSection&&(J.dashboardSection.classList.remove("hidden"),J.dashboardSection.style.display="block");document.querySelectorAll(".stats-grid").forEach(e=>{e.classList.remove("hidden"),e.style.display="grid"});const e=document.querySelector(".wordcloud-section");e&&(e.classList.remove("hidden"),e.style.display="grid");document.querySelectorAll(".chart-card").forEach(e=>{e.classList.contains("hidden")||"techStackSection"===e.id||(e.style.display="block")});const t=document.querySelector(".chat-list-section");t&&(t.style.display="block");console.log("[Main] ✅ 分析结果已显示")}(),ae(),S&&he(),G=1,le(x))}catch(f){console.error("[Main] 处理失败:",f),m?m(f):(y=f.message,console.error("[Main] 上传错误:",y),J.uploadError&&(J.uploadError.textContent=y,J.uploadError.classList.remove("hidden")),oe())}finally{e&&e.target&&(e.target.value="")}var y}function te(e,t){e.totalConversations+=t.totalConversations,e.userMessages+=t.userMessages,e.aiMessages+=t.aiMessages,e.qingCount=(e.qingCount||0)+(t.qingCount||0),e.buCount=(e.buCount||0)+(t.buCount||0),t.userBehaviorStats&&(e.userBehaviorStats=e.userBehaviorStats||{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,codeKeywordCount:0,modifyKeywordCount:0},e.userBehaviorStats.totalUserChars+=t.userBehaviorStats.totalUserChars||0,e.userBehaviorStats.questionMessageCount+=t.userBehaviorStats.questionMessageCount||0,e.userBehaviorStats.codeKeywordCount+=t.userBehaviorStats.codeKeywordCount||0,e.userBehaviorStats.modifyKeywordCount+=t.userBehaviorStats.modifyKeywordCount||0,t.userBehaviorStats.techStack&&(e.userBehaviorStats.techStack=e.userBehaviorStats.techStack||{},Object.entries(t.userBehaviorStats.techStack).forEach(([t,n])=>{e.userBehaviorStats.techStack[t]=(e.userBehaviorStats.techStack[t]||0)+n})),e.userMessages>0&&(e.userBehaviorStats.avgUserMessageLength=Math.round(e.userBehaviorStats.totalUserChars/e.userMessages)));for(const[n,o]of Object.entries(t.modelUsage))e.modelUsage[n]=(e.modelUsage[n]||0)+o;for(let n=0;n<24;n++)e.hourlyActivity[n]+=t.hourlyActivity[n];for(const[n,o]of Object.entries(t.dailyActivity))e.dailyActivity[n]=(e.dailyActivity[n]||0)+o;for(const[n,o]of Object.entries(t.topPrompts))e.topPrompts[n]=(e.topPrompts[n]||0)+o;for(const[n,o]of Object.entries(t.topChineseWords||{}))e.topChineseWords=e.topChineseWords||{},e.topChineseWords[n]=(e.topChineseWords[n]||0)+o;if(t.chineseWords){e.chineseWords=e.chineseWords||{};for(const[n,o]of Object.entries(t.chineseWords))e.chineseWords[n]=(e.chineseWords[n]||0)+o}if(t.englishWords){e.englishWords=e.englishWords||{};for(const[n,o]of Object.entries(t.englishWords))e.englishWords[n]=(e.englishWords[n]||0)+o}}function ne(e=null){console.log("[Main] 显示加载状态...",e||""),J.uploadSection.classList.add("hidden"),J.loadingSection.classList.remove("hidden"),J.dashboardSection.classList.add("hidden"),e&&J.loadingProgress&&(J.loadingProgress.textContent=e),console.log("[Main] ✅ 加载状态已显示")}function oe(){J.loadingSection&&J.loadingSection.classList.add("hidden")}function se(e,t){const n=`已处理 ${e}/${t} 个文件`;J.loadingProgress&&(J.loadingProgress.textContent=n),console.log(`[Main] ${n}`)}function ae(){var e;console.log("[Main] 开始显示统计信息...");try{const t={totalConversations:L.totalConversations,totalCodeChars:L.totalCodeChars,modelUsage:L.modelUsage,userMessages:L.userMessages,qingCount:L.qingCount||0,buCount:L.buCount||0,topChineseWordsList:re(L.topChineseWords,10)};console.log("[Main] 统计数据:",{totalConversations:t.totalConversations,totalCodeChars:t.totalCodeChars,userMessages:t.userMessages,qingCount:t.qingCount,buCount:t.buCount,topChineseWordsList:(null==(e=t.topChineseWordsList)?void 0:e.length)||0}),console.log('[Main] ✅ "请"字次数:',t.qingCount),console.log('[Main] ✅ "不"字次数:',t.buCount);let n=0;if(L.earliestFileTime){const e=Date.now(),t=L.earliestFileTime,o=e-t;n=Math.floor(o/864e5),console.log("[Main] 使用时长计算:",{earliestTime:new Date(t).toISOString(),nowTime:new Date(e).toISOString(),diffMs:o,usageDays:n})}if(Q.totalConversations&&(Q.totalConversations.textContent=ie(n)),Q.qingCount&&(Q.qingCount.textContent=ie(t.qingCount)),Q.buCount&&(Q.buCount.textContent=ie(t.buCount)),Q.userMessages&&(Q.userMessages.textContent=ie(t.userMessages)),L.userBehaviorStats){const e=L.userBehaviorStats;Q.totalUserChars&&(Q.totalUserChars.textContent=ie(e.totalUserChars||0)),Q.avgUserMessageLength&&(Q.avgUserMessageLength.textContent=ie(e.avgUserMessageLength||0));const t=document.getElementById("questionCard");t&&e.questionMessageCount>0&&(t.style.display="",Q.questionMessageCount&&(Q.questionMessageCount.textContent=ie(e.questionMessageCount))),function(e){const t=document.getElementById("techStackSection"),n=document.getElementById("techStackList");if(!t||!n)return;const o=Object.entries(e);if(0===o.length)return void(t.style.display="none");const s=o.sort((e,t)=>t[1]-e[1]).slice(0,10);if(0===s.length)return void(t.style.display="none");t.style.display="",n.innerHTML=s.map(([e,t],n)=>`\n    <div class="prompt-item">\n      <span class="prompt-rank">#${n+1}</span>\n      <span class="prompt-text">${ge(e)}</span>\n      <span class="prompt-count">${t} 次</span>\n    </div>\n  `).join("")}(e.techStack||{})}console.log("[Main] 准备渲染词云，数据状态:",{chineseWords:Object.keys(L.chineseWords||{}).length,englishWords:Object.keys(L.englishWords||{}).length}),Ee(),console.log("[Main] 开始渲染用户提问最多汉字词组..."),function(e){console.log("[Main] 开始渲染用户提问最多汉字词组...");const t=Q.topChineseWordsList||document.getElementById("topChineseWordsList");if(!t)return void console.warn("[Main] topChineseWordsList 容器未找到");if(!e||0===e.length)return t.innerHTML='\n      <div class="prompt-item">\n        <span class="prompt-text">暂无汉字词组数据</span>\n        <span class="prompt-count">0 次</span>\n      </div>\n    ',void console.log("[Main] 没有汉字词组数据");console.log(`[Main] 共有 ${e.length} 个汉字词组`),e.forEach((e,t)=>{console.log(`  #${t+1} "${e.word}" ${e.count} 次`)}),t.innerHTML=e.map((e,t)=>`\n    <div class="prompt-item">\n      <span class="prompt-rank">#${t+1}</span>\n      <span class="prompt-text">${ge(e.word)}</span>\n      <span class="prompt-count">${e.count} 次</span>\n    </div>\n  `).join(""),console.log("[Main] ✅ 汉字词组渲染完成")}(t.topChineseWordsList),console.log("[Main] ✅ 统计信息显示完成")}catch(t){throw console.error("[Main] ❌ 显示统计信息失败:",t),t}}function ie(e,t=null){if("number"!=typeof e||isNaN(e))return"0";t||(t=$());return"en"===t?e>=1e12?(e/1e12).toFixed(1)+"T":e>=1e9?(e/1e9).toFixed(1)+"B":e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString():e>=1e12?(e/1e12).toFixed(1)+"万亿":e>=1e11?(e/1e11).toFixed(1)+"千亿":e>=1e10?(e/1e10).toFixed(1)+"百亿":e>=1e8?(e/1e8).toFixed(1)+"亿":e>=1e7?(e/1e7).toFixed(1)+"千万":e>=1e6?(e/1e6).toFixed(1)+"百万":e>=1e4?(e/1e4).toFixed(1)+"万":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}function re(e,t=10){const n=Object.entries(e||{});return 0===n.length?[]:n.sort((e,t)=>t[1]-e[1]).slice(0,t).map(([e,t])=>({word:e,count:t}))}function le(e){console.log(`[Main] 渲染对话列表，共 ${e.length} 条记录`),Y=e;const t=J.chatList,n=Math.ceil(e.length/K);G>n&&n>0&&(G=n),G<1&&(G=1);const o=(G-1)*K,s=o+K,a=e.slice(o,s);if(console.log(`[Main] 显示第 ${G}/${n} 页，共 ${a.length} 条记录`),0===a.length)return t.innerHTML='\n      <div class="chat-item-more">\n        暂无对话记录\n      </div>\n    ',void(J.paginationContainer&&(J.paginationContainer.style.display="none"));try{t.innerHTML=a.map((e,t)=>{if(!e)return console.warn(`[Main] item ${t} 为 null，跳过`),"";const n=e.text||"",o=e.role||"AI",s=e.timestamp||(new Date).toISOString();return 0===n.length?(console.warn(`[Main] item ${t} 的文本为空，跳过`),""):`\n        <div class="chat-item">\n          <div class="chat-item-header">\n            <span class="chat-role ${"USER"===o?"role-user":"role-ai"}">\n              <span style="color: var(--accent-terminal);">${"USER"===o?">":"$"}</span> ${o}\n            </span>\n            <span class="chat-time">${function(e){const t=new Date(e);return t.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}(s)}</span>\n          </div>\n          <div class="chat-item-content">\n            <p>${ge(n.substring(0,200))}${n.length>200?"...":""}</p>\n          </div>\n        </div>\n      `}).join(""),function(e,t){var n;if(!J.paginationContainer||!J.paginationInfo||!J.paginationPages)return;if(t<=1)return void(J.paginationContainer.style.display="none");J.paginationContainer.style.display="flex";const o=(G-1)*K+1,s=Math.min(G*K,e),a=$(),i=(null==(n=window.i18n)?void 0:n.getText("chatList.paginationInfo",a))||"第 {currentPage} 页，共 {totalPages} 页（共 {totalItems} 条记录，显示 {startItem}-{endItem} 条）";J.paginationInfo.textContent=i.replace("{currentPage}",G).replace("{totalPages}",t).replace("{totalItems}",e).replace("{startItem}",o).replace("{endItem}",s),J.paginationPrev&&(J.paginationPrev.disabled=1===G);J.paginationNext&&(J.paginationNext.disabled=G===t);const r=J.paginationPages;r.innerHTML="";let l=Math.max(1,G-2),c=Math.min(t,G+2);G<=3&&(c=Math.min(5,t));G>=t-2&&(l=Math.max(1,t-4));if(l>1){const e=document.createElement("button");if(e.className="pagination-page-btn",e.textContent="1",e.addEventListener("click",()=>{G=1,le(Y)}),r.appendChild(e),l>2){const e=document.createElement("span");e.className="pagination-ellipsis",e.textContent="...",r.appendChild(e)}}for(let d=l;d<=c;d++){const e=document.createElement("button");e.className="pagination-page-btn",d===G&&e.classList.add("active"),e.textContent=d,e.addEventListener("click",()=>{G=d,le(Y)}),r.appendChild(e)}if(c<t){if(c<t-1){const e=document.createElement("span");e.className="pagination-ellipsis",e.textContent="...",r.appendChild(e)}const e=document.createElement("button");e.className="pagination-page-btn",e.textContent=t,e.addEventListener("click",()=>{G=t,le(Y)}),r.appendChild(e)}}(e.length,n),console.log("[Main] ✅ 对话列表渲染完成")}catch(i){console.error("[Main] ❌ 渲染对话列表失败:",i),t.innerHTML=`\n      <div class="chat-item-more">\n        对话列表加载失败：${i.message}\n      </div>\n    `,J.paginationContainer&&(J.paginationContainer.style.display="none")}}function ce(e){const t=e.target.value.trim();if(G=1,!t)return void le(x);le(x.filter(e=>e.text.toLowerCase().includes(t.toLowerCase())))}async function de(){const e=J.exportArea;try{const t=J.exportBtn.innerHTML;J.exportBtn.innerHTML='<span class="btn-icon">⏳</span><span>生成中...</span>',J.exportBtn.disabled=!0;const n=window.html2canvas||globalThis.html2canvas;if(!n)throw new Error("html2canvas 未加载，请确保 CDN 资源已正确加载");const o=await n(e,{backgroundColor:"#ffffff",scale:2,useCORS:!0,logging:!1}),s=document.createElement("a");s.download=`cursor-audit-${(new Date).getTime()}.png`,s.href=o.toDataURL("image/png"),s.click(),J.exportBtn.innerHTML=t,J.exportBtn.disabled=!1,console.log("[Main] 导出成功")}catch(t){console.error("[Main] 导出失败:",t),alert("导出失败: "+t.message),J.exportBtn.innerHTML='<span class="btn-icon">📊</span><span>晒出cursor受虐证据</span>',J.exportBtn.disabled=!1}}function ge(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function he(){if(fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2179",message:"displayVibeCodingerAnalysis called",data:{vibeResultExists:!!S,vibeResultKeys:S?Object.keys(S):null},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),!S)return void fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2180",message:"vibeResult is null/undefined, returning early",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{});const e=document.getElementById("vibeCodingerSection")||document.getElementById("personality-lock");if(fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2183",message:"container lookup",data:{containerFound:!!e,containerId:null==e?void 0:e.id,hasVibeCodingerSection:!!document.getElementById("vibeCodingerSection"),hasPersonalityLock:!!document.getElementById("personality-lock")},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"})}).catch(()=>{}),!e)return void fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2184",message:"container not found, returning early",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"})}).catch(()=>{});const{personalityType:t,dimensions:n,analysis:o,semanticFingerprint:s,statistics:a,vibeIndex:i,roastText:r,personalityName:l,lpdef:c}=S;e.innerHTML=`\n    <div class="vibe-header">\n      <h2 class="vibe-title">${R("vibeCodinger.title")}</h2>\n      <div class="vibe-badge" style="background: transparent; border: 2px solid var(--accent-terminal);">\n        <span class="vibe-type">${t}</span>\n        <span class="vibe-name">${l||o.name}</span>\n      </div>\n      <p class="vibe-description">${o.description}</p>\n    </div>\n\n    \x3c!-- 新增：人格头衔和吐槽区域 --\x3e\n    <div class="vibe-roast-section">\n      <div class="roast-header">\n        <h3 class="roast-title">${R("vibeCodinger.roastTitle")}</h3>\n        <div class="personality-title">${(e=>{var t,n,o,s,a,i;const r="en"===$()?null==(o=null==(n=null==(t=window.i18n)?void 0:t.getI18nText("en"))?void 0:n.vibeCodinger)?void 0:o.personalityTitles:null==(i=null==(a=null==(s=window.i18n)?void 0:s.getI18nText("zh-CN"))?void 0:a.vibeCodinger)?void 0:i.personalityTitles;if(!r){return`${"2"===e[0]?"硬核":"1"===e[0]?"标准":"随性"}·${"2"===e[1]?"耐心":"1"===e[1]?"平衡":"急躁"}·${"2"===e[2]?"细节控":"1"===e[2]?"适中":"极简"}·${"2"===e[3]?"探索者":"1"===e[3]?"观望":"守旧"}·${"2"===e[4]?"暖男":"1"===e[4]?"职业":"冷酷"}`}return`${"2"===e[0]?r.l[2]:"1"===e[0]?r.l[1]:r.l[0]}·${"2"===e[1]?r.p[2]:"1"===e[1]?r.p[1]:r.p[0]}·${"2"===e[2]?r.d[2]:"1"===e[2]?r.d[1]:r.d[0]}·${"2"===e[3]?r.e[2]:"1"===e[3]?r.e[1]:r.e[0]}·${"2"===e[4]?r.f[2]:"1"===e[4]?r.f[1]:r.f[0]}`})(i)}</div>\n        <div class="vibe-index">${"en"===$()?`${R("vibeCodinger.lpdef")}: ${c||"N/A"}`:`${R("vibeCodinger.index")}: ${i} | ${R("vibeCodinger.lpdef")}: ${c||"N/A"}`}</div>\n      </div>\n      <div class="roast-content">\n        <p class="roast-text">${r}</p>\n      </div>\n      <div class="dimension-tags">\n        ${(e=>{const t=[],n=$();return Object.entries(e).forEach(([e,o])=>{var s,a,i,r,l,c,d,g,u,p;let m;const b=null==(i=null==(a=null==(s=window.i18n)?void 0:s.getI18nText(n))?void 0:a.dimensions)?void 0:i[e];m="E"===e?o<5?(null==(r=null==b?void 0:b.levels)?void 0:r.low)||"低":o<10?(null==(l=null==b?void 0:b.levels)?void 0:l.medium)||"中":(null==(c=null==b?void 0:b.levels)?void 0:c.high)||"高":o<40?(null==(d=null==b?void 0:b.levels)?void 0:d.low)||"低":o<70?(null==(g=null==b?void 0:b.levels)?void 0:g.medium)||"中":(null==(u=null==b?void 0:b.levels)?void 0:u.high)||"高";const y=(null==b?void 0:b.label)||(null==(p=window.i18n)?void 0:p.getText(`dimensions.${e}.label`,n))||h[e].label;t.push(`${y}:${m}`)}),t})(n).map(e=>`\n          <span class="dimension-tag">${e}</span>\n        `).join("")}\n      </div>\n    </div>\n\n    <div class="vibe-dimensions">\n      <h3 class="dimensions-title">${R("vibeCodinger.dimensionsTitle")}</h3>\n      ${Object.entries(n).map(([e,t])=>{var n,s,a,i,r,l,c,d;const g=o.dimensions[e],u=t,p=(null==(i=null==(a=null==(s=null==(n=window.i18n)?void 0:n.getI18nText($()))?void 0:s.dimensions)?void 0:a[e])?void 0:i.label)||h[e].label,m=(null==(d=null==(c=null==(l=null==(r=window.i18n)?void 0:r.getI18nText($()))?void 0:l.dimensions)?void 0:c[e])?void 0:d.description)||h[e].description;return`\n          <div class="dimension-card">\n            <div class="dimension-header">\n              <span class="dimension-key">${e}</span>\n              <span class="dimension-label">${p}</span>\n              <span class="dimension-value">${t}</span>\n              <span class="dimension-level">${g.level}</span>\n            </div>\n            <div class="dimension-bar-container">\n              <div class="dimension-bar" style="width: ${u}%; background: var(--accent-terminal)"></div>\n            </div>\n            <p class="dimension-interpretation">${g.interpretation}</p>\n            <p class="dimension-desc">${m}</p>\n          </div>\n        `}).join("")}\n    </div>\n\n    <div class="vibe-traits" id="personality-traits" style="scroll-margin-top: 80px;">\n      <h3 class="traits-title">${R("vibeCodinger.traitsTitle")}</h3>\n      <div class="traits-list">\n        ${o.traits.map(e=>`\n          <div class="trait-tag">${e}</div>\n        `).join("")}\n      </div>\n    </div>\n\n    <div class="vibe-fingerprint" id="semantic-fingerprint" style="scroll-margin-top: 80px;">\n      <h3 class="fingerprint-title">${R("vibeCodinger.fingerprintTitle")}</h3>\n      <div class="fingerprint-grid">\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${R("fingerprint.codeRatio")}</span>\n          <span class="fingerprint-value">${s.codeRatio||"N/A"}</span>\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${R("fingerprint.patienceLevel")}</span>\n          <span class="fingerprint-value">${s.patienceLevel||"N/A"}</span>\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${R("fingerprint.detailLevel")}</span>\n          <span class="fingerprint-value">${s.detailLevel||"N/A"}</span>\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${R("fingerprint.techExploration")}</span>\n          <span class="fingerprint-value">${s.techExploration||"N/A"}</span>\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${R("fingerprint.feedbackDensity")}</span>\n          <span class="fingerprint-value">${s.feedbackDensity||"N/A"}</span>\n        </div>\n        ${s.compositeScore?`\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${R("fingerprint.score")}</span>\n          <span class="fingerprint-value">${s.compositeScore}</span>\n        </div>\n        `:""}\n        ${s.techDiversity?`\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${R("fingerprint.diversity")}</span>\n          <span class="fingerprint-value">${s.techDiversity}</span>\n        </div>\n        `:""}\n        ${s.interactionStyle?`\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${R("fingerprint.style")}</span>\n          <span class="fingerprint-value">${s.interactionStyle}</span>\n        </div>\n        `:""}\n        ${s.balanceIndex?`\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${R("fingerprint.balance")}</span>\n          <span class="fingerprint-value">${s.balanceIndex}</span>\n        </div>\n        `:""}\n      </div>\n    </div>\n\n    <div class="vibe-chart-container" id="radar-chart" style="scroll-margin-top: 80px;">\n      <h3 class="chart-title">${R("vibeCodinger.chartTitle")}</h3>\n      <div class="chart-wrapper">\n        <canvas id="vibeRadarChart"></canvas>\n      </div>\n    </div>\n  `,A||D?ue():(console.log("[Main] 渲染前检测到全局平均值未加载，先获取数据..."),D=!0,ye().then(e=>{50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F||(I=e,A=!0,console.log("[Main] ✅ 渲染前获取全局平均值成功:",I)),D=!1,ue()}).catch(e=>{console.error("[Main] ❌ 渲染前获取全局平均值失败:",e),D=!1,ue()}))}function ue(){var e,t;fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2370",message:"renderVibeRadarChart called",data:{hasVibeResult:!!S,hasWindowChart:!!window.Chart,hasGlobalChart:!!globalThis.Chart,chartType:typeof(window.Chart||globalThis.Chart)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{});const n=window.Chart||globalThis.Chart;if(!S||!n)return fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2373",message:"Chart.js not loaded or vibeResult missing",data:{hasVibeResult:!!S,hasChart:!!n},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),void console.warn("[Main] Chart.js 未加载，无法渲染雷达图");const o=document.getElementById("vibeRadarChart");if(fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2378",message:"canvas lookup",data:{canvasFound:!!o,canvasId:null==o?void 0:o.id},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),!o)return void fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2379",message:"canvas not found, returning early",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{});const{dimensions:s}=S,a=o.getContext("2d");window.vibeRadarChartInstance&&window.vibeRadarChartInstance.destroy(),A||D||(console.log("[Main] 雷达图渲染时检测到数据未加载，尝试重新获取..."),D=!0,ye().then(e=>{50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?(console.warn("[Main] ⚠️ 重新获取的数据仍是默认值"),A=!1):(I=e,A=!0,console.log("[Main] ✅ 重新获取全局平均值成功:",I),ue()),D=!1}).catch(e=>{console.error("[Main] ❌ 重新获取全局平均值失败:",e),A=!1,D=!1}));50===I.L&&50===I.P&&50===I.D&&50===I.E&&50===I.F&&!A&&(console.warn("[Main] ⚠️ 雷达图使用默认全局平均值，API 数据可能未加载成功"),console.log("[Main] 当前 globalAverageData:",I),console.log("[Main] 当前 globalAverageDataLoaded:",A));const i=I||S.globalAverage||{L:50,P:50,D:50,E:50,F:50};console.log("[Main] 雷达图使用的全局平均值:",{source:A?"API":S.globalAverage?"vibeResult":"default",data:i}),s.E,i.E;const r=$(),l=["L","P","D","E","F"].map(e=>{var t,n,o,s;const a=null==(o=null==(n=null==(t=window.i18n)?void 0:t.getI18nText(r))?void 0:n.dimensions)?void 0:o[e];return`${(null==a?void 0:a.label)||(null==(s=h[e])?void 0:s.label)||e} (${e})`}),c=(null==(e=window.i18n)?void 0:e.getText("dashboard.radarChart.yourScore",r))||"你的得分",d=(null==(t=window.i18n)?void 0:t.getText("dashboard.radarChart.globalAverage",r))||"全网平均";window.vibeRadarChartInstance=new n(a,{type:"radar",data:{labels:l,datasets:[{label:c,data:[s.L,s.P,s.D,s.E,s.F],backgroundColor:"rgba(0, 255, 65, 0.2)",borderColor:"rgba(0, 255, 65, 1)",borderWidth:2,pointBackgroundColor:"rgba(0, 255, 65, 1)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgba(0, 255, 65, 1)",pointRadius:5,pointHoverRadius:7},{label:d,data:[i.L,i.P,i.D,i.E,i.F],backgroundColor:"rgba(113, 113, 122, 0.1)",borderColor:"rgba(113, 113, 122, 0.5)",borderWidth:1.5,borderDash:[5,5],pointBackgroundColor:"rgba(113, 113, 122, 0.5)",pointBorderColor:"rgba(113, 113, 122, 0.8)",pointHoverBackgroundColor:"rgba(113, 113, 122, 0.8)",pointHoverBorderColor:"rgba(113, 113, 122, 1)",pointRadius:3,pointHoverRadius:5}]},options:{responsive:!0,maintainAspectRatio:!0,layout:{padding:{top:20,bottom:20,left:20,right:20}},scales:{r:{beginAtZero:!0,max:100,ticks:{stepSize:20,display:!1},grid:{color:"rgba(0, 255, 65, 0.1)"},pointLabels:{font:{size:12},color:"#ffffff"}}},plugins:{legend:{display:!0,position:"top",labels:{color:"#ffffff",font:{family:"'JetBrains Mono', monospace"}}},tooltip:{callbacks:{label:function(e){return`${e.label}: ${e.parsed.r}分`}}}}}})}function pe(e,t,n=e=>e.toString()){if(!e)return;let o=Number(t);(isNaN(o)||null==t)&&(console.warn("[Main] 检测到无效数值，重置为 0"),o=0);const s=parseInt(e.textContent.replace(/[^0-9]/g,""))||0,a=performance.now(),i=t=>{const r=t-a,l=Math.min(r/1500,1),c=Math.floor(s+(o-s)*((d=l)*(2-d)));var d;try{e.textContent=n(c)}catch(g){e.textContent=c.toString()}l<1&&requestAnimationFrame(i)};requestAnimationFrame(i)}const me="https://cursor-clinical-analysis.psterman.workers.dev/";function be(){if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return console.log("[Main] 从 window 对象获取 API 端点:",e),e;const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim(),n=e.endsWith("/")?e:e+"/";return console.log("[Main] 从 meta 标签获取 API 端点:",n),n}}return console.log("[Main] 使用默认 API 端点:",me),me}async function ye(){const e={L:50,P:50,D:50,E:50,F:50};try{const t=be(),n=t.endsWith("/")?`${t}api/global-average`:`${t}/api/global-average`;console.log("[Main] 开始获取全局平均值，URL:",n);const o=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"},mode:"cors",credentials:"omit"});if(!o.ok){const t=await o.text().catch(()=>"无法读取错误信息");return console.error("[Main] ❌ API 请求失败:",{status:o.status,statusText:o.statusText,error:t}),e}const s=await o.json();if(console.log("[Main] API 返回数据:",s),"success"===s.status&&s.globalAverage){const e=s.globalAverage;if("number"==typeof e.L&&"number"==typeof e.P&&"number"==typeof e.D&&"number"==typeof e.E&&"number"==typeof e.F)return I=e,A=!0,console.log("[Main] ✅ 成功获取全局平均值:",e),e;console.warn("[Main] ⚠️ 全局平均值数据格式不正确:",e)}else console.warn("[Main] ⚠️ API 返回状态不是 success 或缺少 globalAverage:",s)}catch(t){console.error("[Main] ❌ 获取全局平均值异常:",{message:t.message,stack:t.stack,name:t.name})}return console.warn("[Main] ⚠️ 使用默认全局平均值"),e}function fe(e){const t=new AbortController,n=setTimeout(()=>t.abort(),e);return"undefined"!=typeof AbortSignal&&AbortSignal.timeout?(clearTimeout(n),AbortSignal.timeout(e)):t.signal}async function ve(e=!1){const t=be();try{const n=await async function(e,t={}){const n={...t,mode:"cors",credentials:"omit",headers:{"Content-Type":"application/json",...t.headers}};console.log("[Main] 发起 CORS 请求:",{url:e,method:n.method||"GET"});try{const t=await fetch(e,n);if(!t.ok&&0===t.status)throw new Error("CORS 错误：无法访问远程 API。请检查 API 端点的 CORS 配置。");return t}catch(o){throw console.error("[Main] CORS 请求失败:",o),o}}(t,{method:e?"POST":"GET",body:e?JSON.stringify({action:"increment",timestamp:Date.now()}):void 0,signal:fe(5e3)});if(n.ok){const t=await n.json(),o=t.value||t.totalUsers||t.total||t.count||null;if(null!==o&&o>=0){console.log(`[Main] ${e?"POST":"GET"} 请求成功，数字:`,o),localStorage.setItem("totalTestUsers",o.toString());const t=document.getElementById("totalTestUsers");return t&&(e?pe(t,o,ie):t.textContent=ie(o)),o}}else console.warn(`[Main] ${e?"POST":"GET"} 请求响应状态码异常:`,n.status)}catch(s){console.warn(`[Main] ${e?"POST":"GET"} 请求失败，使用降级方案:`,s.message)}const n=parseInt(localStorage.getItem("totalTestUsers")||"0"),o=document.getElementById("totalTestUsers");return o&&(o.textContent=ie(n)),console.log("[Main] 使用降级值:",n),n}async function we(){return await ve(!1)}async function Ce(){return await ve(!0)}const Me={positive:new Set(["开心","高兴","快乐","愉快","兴奋","满意","满足","喜欢","爱","感谢","谢谢","太好了","完美","优秀","很棒","不错","很好","厉害","赞","棒","赞","成功","顺利","正确","准确","清晰","明白","理解","懂了","好的","可以","惊喜","惊喜","感动","温暖","舒服","轻松","舒服","爽","爽快","太好了","完美","优秀","很棒","不错","很好","厉害","赞","棒"]),negative:new Set(["生气","愤怒","烦躁","焦虑","担心","害怕","恐惧","紧张","压力","累","失望","沮丧","难过","伤心","痛苦","难受","不舒服","不爽","烦","烦人","错误","不对","不对","错了","失败","失败","不行","不能","不可以","不行","困惑","迷茫","不懂","不明白","不清楚","模糊","混乱","乱","糟糕","糟糕","麻烦","困难","难","复杂","复杂","慢","慢","卡","卡顿","崩溃","崩溃","垃圾","差","差劲","烂","烂","破","破","坏","坏","差","差"]),neutral:new Set(["思考","考虑","想","想想","看看","试试","试试","尝试","尝试","疑问","疑问","问题","问题","为什么","怎么","如何","什么","哪个","可能","也许","大概","应该","需要","想要","希望","期待","注意","注意","小心","小心","提醒","提醒","记得","记得"]),intensity:new Set(["非常","很","特别","极其","超级","超","太","太","最","最","一点","稍微","有点","有点","稍微","稍微","不太","不太"])};function ke(e){if(Me.positive.has(e)||Me.negative.has(e)||Me.neutral.has(e)||Me.intensity.has(e))return!0;for(const t of Object.values(Me))for(const n of t)if(e.includes(n)&&e.length<=4)return!0;return!1}function Ee(){if("undefined"==typeof WordCloud)return void console.warn("[Main] WordCloud库未加载");console.log("[Main] 开始渲染词云...");const e=Object.keys(L.chineseEmotionWords||{}).length,t=Object.keys(L.chineseWords||{}).length,n=Object.keys(L.englishWords||{}).length;console.log("[Main] 情绪类词组数据:",e),console.log("[Main] 中文词组数据:",t),console.log("[Main] 英文词组数据:",n);const o=document.getElementById("chineseWordCloud");if(o)if(L.chineseEmotionWords&&0!==e){const e=50,t=120,n=Object.entries(L.chineseEmotionWords).filter(([e,t])=>t>0&&e.length>=2).sort((e,t)=>t[1]-e[1]),s=Math.max(e,Math.min(t,n.length)),i=n.slice(0,s).map(([e,t])=>[e,t]);if(console.log("[Main] AI情绪词云数据（已排序）:",i.length),i.length>0&&console.log("[Main] AI情绪词云Top 10:",i.slice(0,10).map(([e,t])=>`${e}(${t})`).join(", ")),i.length>0)try{const e=o.parentElement,t=e?e.offsetWidth:400,n=e?e.offsetHeight:400;o.width=t,o.height=n;const s=o.getContext("2d");s&&s.clearRect(0,0,t,n);const a=Math.max(...i.map(([e,t])=>t)),r=["#e74c3c","#f39c12","#e67e22","#c0392b","#d35400","#e74c3c","#f39c12","#9b59b6","#1abc9c","#16a085"],l=function(e,t,n,o,s){const a=Math.floor(Math.random()*r.length);return r[a]};WordCloud(o,{list:i,gridSize:Math.round(Math.max(8,Math.min(12,t/40))),weightFactor:function(e){return 10+Math.sqrt(e)/Math.sqrt(a)*(Math.min(45,t/10)-10)},fontFamily:'"Microsoft YaHei", "微软雅黑", "SimHei", "黑体", sans-serif',color:l,rotateRatio:.6,backgroundColor:"transparent",minSize:10,drawOutOfBound:!1,shrinkToFit:!1,ellipticity:.8}),console.log("[Main] ✅ AI情绪词云渲染完成")}catch(a){console.error("[Main] AI情绪词云渲染失败:",a),console.error("[Main] 错误详情:",a.stack)}else console.warn("[Main] AI情绪词云数据为空（过滤后）")}else{console.warn("[Main] AI情绪词云数据为空");const e=o.parentElement;e&&(e.innerHTML='<div style="padding: 20px; text-align: center; color: #999;">暂无AI情绪数据</div>')}else console.warn("[Main] AI情绪词云canvas未找到");const s=document.getElementById("englishWordCloud");if(s){const e={};L.chineseWords&&Object.entries(L.chineseWords).forEach(([t,n])=>{L.chineseEmotionWords&&L.chineseEmotionWords[t]||(e[t]=(e[t]||0)+n)}),L.englishWords&&Object.entries(L.englishWords).forEach(([t,n])=>{e[t]=(e[t]||0)+n});if(0===Object.keys(e).length){console.warn("[Main] 合并词云数据为空");const e=s.parentElement;e&&(e.innerHTML='<div style="padding: 20px; text-align: center; color: #999;">暂无词云数据</div>')}else{const t=100,n=200,o=Object.entries(e).filter(([e,t])=>t>0&&e.length>=2).sort((e,t)=>t[1]-e[1]),i=Math.max(t,Math.min(n,o.length)),r=o.slice(0,i).map(([e,t])=>[e,t]);if(console.log("[Main] 合并词云数据（已排序）:",r.length),r.length>0&&console.log("[Main] 合并词云Top 10:",r.slice(0,10).map(([e,t])=>`${e}(${t})`).join(", ")),r.length>0)try{const e=s.parentElement,t=e?e.offsetWidth:400,n=e?e.offsetHeight:400;s.width=t,s.height=n;const o=s.getContext("2d");o&&o.clearRect(0,0,t,n);const a=Math.max(...r.map(([e,t])=>t)),i=["#2c3e50","#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#34495e","#16a085"],l=function(e,t,n,o,s){const a=Math.floor(Math.random()*i.length);return i[a]};WordCloud(s,{list:r,gridSize:Math.round(Math.max(6,Math.min(10,t/50))),weightFactor:function(e){return 8+Math.sqrt(e)/Math.sqrt(a)*(Math.min(35,t/12)-8)},fontFamily:'Arial, "Microsoft YaHei", "微软雅黑", sans-serif',color:l,rotateRatio:.6,backgroundColor:"transparent",minSize:8,drawOutOfBound:!1,shrinkToFit:!1,ellipticity:.8}),console.log("[Main] ✅ 合并词云渲染完成")}catch(a){console.error("[Main] 合并词云渲染失败:",a),console.error("[Main] 错误详情:",a.stack)}else console.warn("[Main] 合并词云数据为空（过滤后）")}}else console.warn("[Main] 英文词云canvas未找到")}"undefined"==typeof window||window.__ANALYSIS_MODULE_LOADED__||(window.__ANALYSIS_MODULE_LOADED__=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{console.log("[Main] DOMContentLoaded 事件触发"),Z()}):(console.log("[Main] DOM 已加载，直接初始化"),Z()));export{we as fetchTotalTestUsers,ie as formatNumber,W as getAllChatData,B as getGlobalStats,j as getParser,U as getVibeAnalyzer,F as getVibeResult,H as initializeParser,q as processFiles,V as reanalyzeWithLanguage,_ as renderFullDashboard,Ce as reportNewUser,z as setAllChatData,O as setGlobalStats,N as setVibeResult,ve as updateGlobalStats,pe as updateNumberWithAnimation};

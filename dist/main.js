var e,t,n,a=e=>{throw TypeError(e)},s=(e,t,n)=>(((e,t,n)=>{t.has(e)||a("Cannot "+n)})(e,t,"access private method"),n);import{i as o}from"./assets/sql.js-Bh3UTgnK.js";import{getText as i}from"./assets/i18n-H9AsZGLl.js";const r={"modelResponse.code":12,"modelResponse.codeBlock":11,"modelResponse.implementation":10,"modelResponse.suggestions":9,"modelResponse.changes":8,"modelResponse.diff":7,"modelResponse.fixes":6,"modelResponse.modifications":5,"modelResponse.codeAnalysis":4,"modelResponse.text":3,"modelResponse.richText":2,"modelResponse.content":1,"bubble.code":13,"bubble.codeBlock":12,"bubble.implementation":11,"bubble.text":10,"bubble.richText":9,"bubble.content":8,"bubble.message.text":7};class l{constructor(){this.db=null,this.SQL=null,this.chatData=[],this.stats={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},englishWords:{},userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}}}async init(){const e=window.BASE_PATH||"",t=e?`${e}/sql-wasm.wasm`:"./sql-wasm.wasm";console.log("[CursorParser] 初始化 sql.js，WASM 路径:",t);const n=await o({locateFile:e=>e.endsWith(".wasm")?t:e});this.SQL=n,console.log("[CursorParser] sql.js 初始化完成，WASM 路径:",t)}async loadDatabase(e){this.SQL||await this.init();try{return this.db=new this.SQL.Database(new Uint8Array(e)),console.log("[CursorParser] "),!0}catch(t){throw console.error("[CursorParser] :",t),t}}async scanDatabase(){if(!this.db)throw new Error("");this.chatData=[],this.resetStats();try{console.log("[CursorParser] ..."),console.log("[CursorParser] :",this.db.exec("SELECT name FROM sqlite_master WHERE type='table'").length);const e="\n         SELECT value FROM itemTable\n         WHERE [key] = 'workbench.panel.aichat.view.aichat.chatdata'\n       ";console.log("[CursorParser]  chatdata ..."),this.extractFromQuery(e,"json");const t="\n         SELECT value FROM itemTable\n         WHERE [key] = 'composer.composerState'\n       ";console.log("[CursorParser]  composerState ..."),this.extractFromQuery(t,"json");const n="\n         SELECT value FROM itemTable\n         WHERE value LIKE '%\"text\":%'\n       ";return console.log("[CursorParser]  text ..."),this.extractFromQuery(n,"regex"),console.log("[CursorParser] ",this.chatData.length,""),console.log("[CursorParser] ===========  ========="),console.log("[CursorParser] 总对话次数:",this.stats.totalConversations),console.log("[CursorParser] 用户消息:",this.stats.userMessages),console.log("[CursorParser] AI消息:",this.stats.aiMessages),console.log("[CursorParser] 模型使用:",this.stats.modelUsage),console.log("[CursorParser] :",this.stats.hourlyActivity.filter(e=>e>0)),console.log("[CursorParser] :",Object.keys(this.stats.topPrompts).length),console.log("[CursorParser] ======================================"),this.chatData}catch(e){throw console.error("[CursorParser] :",e),e}}appendData(e){const t=this.chatData.length;e.forEach((e,n)=>{this.chatData.push({id:t+n+1,text:e.text,role:e.role,source:e.source,length:e.text.length,timestamp:e.timestamp||(new Date).toISOString(),model:e.model||"unknown"})}),console.log(`[CursorParser]  ${e.length} : ${this.chatData.length}`)}extractFromQuery(e,t){const n=this.db.exec(e);if(0===n.length)return;const a=n[0].values;console.log(`[CursorParser] ${t}  ${a.length} `);const s=new Set;a.forEach(([e],n)=>{try{let n=[],a="";"json"===t?(n=this.extractFromJSON(e),a=t):"regex"===t&&(n=this.extractFromRegex(e),a="regex"),n.forEach(e=>{if(!e||e.text.length<5)return;const t=e.text;s.has(t)||(s.add(t),this.chatData.push({id:this.chatData.length+1,text:e.text,role:e.role,source:a,length:e.text.length,timestamp:e.timestamp||(new Date).toISOString(),model:e.model||"unknown"}),this.updateStats(e))})}catch(a){console.warn(`[CursorParser]  ${n+1} :`,a.message)}})}extractFromJSON(e){const t=[];try{const n=JSON.parse(e);n.tabs&&Array.isArray(n.tabs)&&n.tabs.forEach(e=>{e.bubbles&&Array.isArray(e.bubbles)&&e.bubbles.forEach(e=>{const n=this.extractBubbleText(e);n&&n.text&&t.push(n)})}),n.bubbles&&Array.isArray(n.bubbles)&&n.bubbles.forEach(e=>{const n=this.extractBubbleText(e);n&&n.text&&t.push(n)})}catch(n){}return t}extractBubbleText(e,t=0,n=6){if(!e||t>n)return null;const a=[],s=this.extractByPriority(e,r,{});if(s){const t=this.determineRole(e),n=this.extractModel(e);a.push({text:s,role:t,model:n,timestamp:this.extractTimestamp(e)})}else for(const o in e)if(e[o]&&"object"==typeof e[o]){const s=this.extractBubbleText(e[o],t+1,n);s&&a.push(s)}return a[0]||null}extractByPriority(e,t,n){if(!e||"object"!=typeof e)return null;let a=null,s=0,o="";for(const[i,r]of Object.entries(t)){const t=this.getNestedValue(e,i);t&&"string"==typeof t&&t.length>5&&r>s&&(a=t,s=r,o=i,n[i]=(n[i]||0)+1)}return a&&console.log(`[CursorParser]  ${o} : ${s}`),a}getNestedValue(e,t){const n=t.split(".");let a=e;for(const s of n){if(!a||"object"!=typeof a||!(s in a))return null;a=a[s]}return a}determineRole(e){if(console.log("[CursorParser] ..."),"user"===e.type)return console.log("[CursorParser]  type  USER"),"USER";if("ai"===e.type)return console.log("[CursorParser]  type  AI"),"AI";if(4===e.commandType)return console.log("[CursorParser]  commandType  USER"),"USER";if(e.userMessage||e.userPrompt||e.question)return console.log("[CursorParser]  USER"),"USER";if(e.modelResponse||e.suggestions||e.aiMessage)return console.log("[CursorParser]  AI"),"AI";if("user"===e.role||"USER"===e.role)return console.log("[CursorParser]  role  USER"),"USER";if("assistant"===e.role||"assistant"===e.role||"AI"===e.role)return console.log("[CursorParser]  role  AI"),"AI";if("user"===e.sender||"USER"===e.sender)return console.log("[CursorParser]  sender  USER"),"USER";if(e.message||e.text){const t=(e.message||e.text).toLowerCase();if(t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith(""))return console.log("[CursorParser]  USER"),"USER";if(t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith("")||t.startsWith(""))return console.log("[CursorParser]  AI"),"AI"}return console.log("[CursorParser]  AI"),"AI"}extractModel(e){const t=["model","modelResponse.model","aiModel","response.model","completion.model"];for(const n of t){const t=this.getNestedValue(e,n);if(t&&"string"==typeof t){return t.split("-")[0]}}return"unknown"}extractTimestamp(e){const t=["timestamp","createdAt","created","time","updatedAt","updatedAt","messageTime","sentAt","bubbleTime","userTime","aiTime"];console.log("[CursorParser] ...");for(const a of t){const t=this.getNestedValue(e,a);if(t)try{const e=new Date(t);if(!isNaN(e.getTime()))return console.log(`[CursorParser]  ${a} : ${e.toISOString()}`),e.toISOString()}catch(n){console.warn(`[CursorParser]  ${a} :`,n)}}return console.warn("[CursorParser] "),(new Date).toISOString()}extractFromRegex(e){console.log("[CursorParser] ...");const t=[];let n=0;return[/"text":\s*"([^"]+)"/g,/"code":\s*"([^"]+)"/g,/"implementation":\s*"([^"]+)"/g,/"content":\s*"([^"]+)"/g].forEach(a=>{let s;for(;null!==(s=a.exec(e));){n++;const a=s[1];if(a&&a.length>=5){const n=this.inferRoleFromContext(e,s.index,a),o=this.inferModelFromContext(e,s.index),i=this.inferTimestampFromContext(e,s.index);t.push({text:a,role:n,model:o,timestamp:i})}}}),console.log(`[CursorParser]  ${n}  ${t.length} `),console.log("[CursorParser] :",{USER:t.filter(e=>"USER"===e.role).length,AI:t.filter(e=>"AI"===e.role).length,unknown:t.filter(e=>"unknown"===e.role).length}),t}inferRoleFromContext(e,t,n){const a=Math.max(0,t-500),s=Math.min(e.length,t+500),o=e.substring(a,s);let i=0,r=0;return[/"type"\s*:\s*"user"/i,/"role"\s*:\s*"user"/i,/"commandType"\s*:\s*4/,/"userMessage"/i,/"userPrompt"/i,/"question"/i].forEach(e=>{e.test(o)&&i++}),[/"type"\s*:\s*"ai"/i,/"role"\s*:\s*"assistant"/i,/"role"\s*:\s*"ai"/i,/"modelResponse"/i,/"suggestions"/i,/"aiMessage"/i].forEach(e=>{e.test(o)&&r++}),i>r?"USER":r>i?"AI":"unknown"}inferModelFromContext(e,t){const n=Math.max(0,t-200),a=Math.min(e.length,t+200),s=e.substring(n,a),o=[/"model"\s*:\s*"([^"]+)"/i,/"aiModel"\s*:\s*"([^"]+)"/i,/"response\.model"\s*:\s*"([^"]+)"/i,/"completion\.model"\s*:\s*"([^"]+)"/i];for(const i of o){const e=i.exec(s);if(e&&e[1]){const t=e[1].split("-")[0];return console.log(`[CursorParser] : ${t}`),t}}return"unknown"}inferTimestampFromContext(e,t){const n=Math.max(0,t-200),a=Math.min(e.length,t+200),s=e.substring(n,a),o=[/"timestamp"\s*:\s*"([^"]+)"/i,/"createdAt"\s*:\s*"([^"]+)"/i,/"created"\s*:\s*"([^"]+)"/i,/"time"\s*:\s*"([^"]+)"/i,/"updatedAt"\s*:\s*"([^"]+)"/i];for(const r of o){const e=r.exec(s);if(e&&e[1])try{const t=new Date(e[1]);if(!isNaN(t.getTime()))return console.log(`[CursorParser] : ${t.toISOString()}`),t.toISOString()}catch(i){console.warn("[CursorParser] :",i)}}return console.warn("[CursorParser] "),(new Date).toISOString()}updateStats(e){var t,n;if(console.log("[CursorParser] :",{role:e.role,textLength:null==(t=e.text)?void 0:t.length,hasTimestamp:!!e.timestamp,model:e.model,first50Chars:null==(n=e.text)?void 0:n.substring(0,50)}),e.text&&e.text.length>0){const t=e.text;this.stats.totalConversations;const n=t.match(/请/g);n&&n.length>0&&(this.stats.qingCount=(this.stats.qingCount||0)+n.length,console.log(`[CursorParser] [${e.role}] "请"字 +${n.length} : ${this.stats.qingCount} | 文本: "${t.substring(0,50)}..."`));const a=t.match(/不/g);a&&a.length>0&&(this.stats.buCount=(this.stats.buCount||0)+a.length,console.log(`[CursorParser] [${e.role}] "不"字 +${a.length} : ${this.stats.buCount} | 文本: "${t.substring(0,50)}..."`))}if(this.stats.totalConversations++,"USER"===e.role?(this.stats.userMessages++,console.log("[CursorParser] 用户消息:",this.stats.userMessages)):(this.stats.aiMessages++,console.log("[CursorParser] AI消息:",this.stats.aiMessages)),console.log("[CursorParser] 总对话次数:",this.stats.totalConversations),e.text&&e.text.length>0&&"USER"===e.role){const t=e.text;t.toLowerCase(),this.stats.userBehaviorStats.totalUserChars+=t.length,(t.includes("?")||t.includes("？")||t.includes("如何")||t.includes("怎么")||t.includes("为什么")||t.includes("what")||t.includes("how")||t.includes("why"))&&this.stats.userBehaviorStats.questionMessageCount++,this.extractTechStack(t),this.extractWordCloudData(t)}this.stats.userMessages>0&&(this.stats.userBehaviorStats.avgUserMessageLength=Math.round(this.stats.userBehaviorStats.totalUserChars/this.stats.userMessages));const a=e.model||"unknown";if(this.stats.modelUsage[a]=(this.stats.modelUsage[a]||0)+1,console.log(`[CursorParser] : ${a} = ${this.stats.modelUsage[a]}`),e.timestamp)try{const t=new Date(e.timestamp).getHours();this.stats.hourlyActivity[t]++,console.log(`[CursorParser] : ${t}:00 = ${this.stats.hourlyActivity[t]}`)}catch(s){console.error("[CursorParser] :",s)}else console.warn("[CursorParser] ");if(e.timestamp)try{const t=new Date(e.timestamp).toISOString().split("T")[0];this.stats.dailyActivity[t]=(this.stats.dailyActivity[t]||0)+1}catch(s){console.error("[CursorParser] :",s)}"USER"===e.role&&e.text?this.extractWords(e.text):"USER"!==e.role&&console.log("[CursorParser] "),"USER"===e.role&&e.text&&this.extractChineseWords(e.text)}extractWords(e){console.log(`[CursorParser] : ${e.length}`);const t=new Set(["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","to","of","in","for","on","at","by","with","from","as","into","through","during","before","after","above","below","between","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","mine","theirs","am","is","are","was","were","be","been","being","have","has","had","can","could","will","would","should","may","might","must","please","help","write","a","one","some","any","all","both","how","what","which","who","when","where","why","whether","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front","forward"]),n=e.match(/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g)||[];console.log(`[CursorParser]  ${n.length} /`),n.forEach(e=>{if(e.length<2)return;if(e.length>20)return;const n=e.toLowerCase();t.has(n)||(this.stats.topPrompts[n]=(this.stats.topPrompts[n]||0)+1)});const a=Object.keys(this.stats.topPrompts).length;console.log(`[CursorParser] ${a} ${n.length} `)}extractChineseWords(e){const t=(this.stats.userMessages||0)+(this.stats.aiMessages||0);t<10&&(console.log(`[CursorParser]  ${t+1}: ${e.length}`),console.log(`[CursorParser]  : "${e.substring(0,80)}..."`));const n=new Set(["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]),a=e.match(/[\u4e00-\u9fa5]{2,}/g)||[];t<10&&(console.log(`[CursorParser]  ${a.length} `),a.length>0&&console.log("[CursorParser] :",a.slice(0,5)));let s=0;a.forEach(e=>{if(e.length>10)return;const t=e.trim();n.has(t)||(this.stats.topChineseWords=this.stats.topChineseWords||{},this.stats.topChineseWords[t]=(this.stats.topChineseWords[t]||0)+1,s++)}),(t<10||s>0)&&Object.keys(this.stats.topChineseWords||{}).length}extractTechStack(e){if(!e||0===e.length)return;this.stats.userBehaviorStats.techStack||(this.stats.userBehaviorStats.techStack={});const t=this.stats.userBehaviorStats.techStack;[{name:"JavaScript",pattern:/\b(javascript|js|typescript|ts|node\.?js?|es6|es2015|ecmascript)\b/gi},{name:"Python",pattern:/\b(python|py|django|flask|fastapi|pandas|numpy|scipy)\b/gi},{name:"Java",pattern:/\b(java|spring|springboot|maven|gradle|jvm)\b/gi},{name:"Go",pattern:/\b(go|golang|gin|echo|goroutine)\b/gi},{name:"Rust",pattern:/\b(rust|cargo|rustc)\b/gi},{name:"C/C++",pattern:/\b(c\+\+|cpp|c语言|clang|gcc)\b/gi},{name:"PHP",pattern:/\b(php|laravel|symfony|composer)\b/gi},{name:"Ruby",pattern:/\b(ruby|rails|ruby on rails|gem)\b/gi},{name:"Swift",pattern:/\b(swift|swiftui|ios)\b/gi},{name:"Kotlin",pattern:/\b(kotlin|android|kotlinx)\b/gi},{name:"C#",pattern:/\b(c#|csharp|\.net|asp\.net|dotnet)\b/gi},{name:"TypeScript",pattern:/\b(typescript|ts|tsx)\b/gi},{name:"React",pattern:/\b(react|reactjs|jsx|redux|mobx|next\.js|nextjs|gatsby|remix)\b/gi},{name:"Vue",pattern:/\b(vue|vuejs|vue\.js|nuxt|nuxtjs|vuex|pinia)\b/gi},{name:"Angular",pattern:/\b(angular|angularjs|ng-|@angular)\b/gi},{name:"Svelte",pattern:/\b(svelte|sveltekit)\b/gi},{name:"Express",pattern:/\b(express|expressjs|express\.js)\b/gi},{name:"Koa",pattern:/\b(koa|koajs)\b/gi},{name:"NestJS",pattern:/\b(nest|nestjs|@nestjs)\b/gi},{name:"FastAPI",pattern:/\b(fastapi|fast-api)\b/gi},{name:"Django",pattern:/\b(django|djangorest)\b/gi},{name:"Flask",pattern:/\b(flask|flask-restful)\b/gi},{name:"MySQL",pattern:/\b(mysql|mariadb)\b/gi},{name:"PostgreSQL",pattern:/\b(postgresql|postgres|pg)\b/gi},{name:"MongoDB",pattern:/\b(mongodb|mongo|mongoose)\b/gi},{name:"Redis",pattern:/\b(redis|redisson)\b/gi},{name:"SQLite",pattern:/\b(sqlite|sqlite3)\b/gi},{name:"Elasticsearch",pattern:/\b(elasticsearch|elastic|es)\b/gi},{name:"Docker",pattern:/\b(docker|dockerfile|docker-compose)\b/gi},{name:"Kubernetes",pattern:/\b(kubernetes|k8s|kubectl)\b/gi},{name:"Git",pattern:/\b(git|github|gitlab|bitbucket)\b/gi},{name:"AWS",pattern:/\b(aws|amazon web services|s3|ec2|lambda)\b/gi},{name:"Azure",pattern:/\b(azure|azure devops)\b/gi},{name:"GCP",pattern:/\b(gcp|google cloud|gcloud)\b/gi},{name:"Vercel",pattern:/\b(vercel)\b/gi},{name:"Netlify",pattern:/\b(netlify)\b/gi},{name:"TensorFlow",pattern:/\b(tensorflow|tf|tensorflow\.js)\b/gi},{name:"PyTorch",pattern:/\b(pytorch|torch)\b/gi},{name:"Bootstrap",pattern:/\b(bootstrap|bs-)\b/gi},{name:"Tailwind",pattern:/\b(tailwind|tailwindcss)\b/gi}].forEach(({name:n,pattern:a})=>{const s=e.match(a);s&&s.length>0&&(t[n]=(t[n]||0)+s.length)})}extractWordCloudData(e){if(!e||0===e.length)return;const t=new Set(["的","是","在","了","我","你","他","她","它","我们","你们","他们","和","或","但是","因为","所以","如果","就","也","都","很","非常","可以","能","会","要","有","没","不","来","去","这","那","个","请","帮","写","一个","怎么","如何","什么","哪个","哪个","吗","呢","吧","啊","哦","嗯","哈","嘿","好"]),n=new Set(["the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","to","of","in","for","on","at","by","with","from","as","into","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","can","could","will","would","should","may","might","must","please","help","write","one","some","any","all","both","how","what","which","who","when","where","why","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front"]);(e.match(/[\u4e00-\u9fa5]{2,10}/g)||[]).forEach(e=>{!t.has(e)&&e.length>=2&&e.length<=10&&(this.stats.chineseWords[e]=(this.stats.chineseWords[e]||0)+1)});(e.match(/\b[a-zA-Z]{2,20}\b/g)||[]).forEach(e=>{const t=e.toLowerCase();!n.has(t)&&e.length>=2&&e.length<=20&&(this.stats.englishWords[t]=(this.stats.englishWords[t]||0)+1)})}resetStats(){this.stats={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},englishWords:{},userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}}}getAllData(){return this.chatData}getStats(){return{...this.stats,topChineseWordsList:this.getTopChineseWords(10)}}getMostUsedModel(){const e=Object.entries(this.stats.modelUsage);if(0===e.length)return"unknown";const[t,n]=e.sort((e,t)=>t[1]-e[1])[0];return{model:t,count:n}}getTopPrompts(e=5){return Object.entries(this.stats.topPrompts).sort((e,t)=>t[1]-e[1]).slice(0,e).map(([e,t])=>({prompt:e,count:t}))}getTopChineseWords(e=10){return Object.entries(this.stats.topChineseWords).sort((e,t)=>t[1]-e[1]).slice(0,e).map(([e,t])=>({word:e,count:t}))}formatDailyActivity(){return Object.entries(this.stats.dailyActivity).sort((e,t)=>e[0].localeCompare(t[0])).map(([e,t])=>({date:e,count:t}))}search(e){if(!e)return this.chatData;const t=e.toLowerCase();return this.chatData.filter(e=>e.text.toLowerCase().includes(t))}getPayloadForAnalysis(){if(!this.chatData||!Array.isArray(this.chatData))return console.warn("[CursorParser] chatData 不存在或格式错误，返回空数据"),{meta:{total_conversations:0,top_model:"unknown",hourly_distribution:new Array(24).fill(0)},messages:[],exportTime:(new Date).toISOString()};const e=this.chatData.slice(-80);console.log(`[CursorParser] 采样窗口：从 ${this.chatData.length} 条记录中提取最近 ${e.length} 条`);const t=e.map((e,t)=>{if(!e)return null;let n=e.text||e.content||"";"string"!=typeof n&&(n=String(n||"")),n=n.replace(/```[\s\S]*?```/g,"");let a=!1;return n.length>500&&(n=n.substring(0,500),a=!0),n=this.sanitizeSensitiveData(n),a&&(n+="...[TRUNCATED]"),{role:e.role||"unknown",content:n,timestamp:e.timestamp||(new Date).toISOString()}}).filter(e=>null!==e&&e.content&&e.content.trim().length>0);console.log(`[CursorParser] 压缩后消息数：${t.length}`);return{meta:{total_conversations:this.stats.totalConversations||this.chatData.length,top_model:this.getMostUsedModel().model||"unknown",hourly_distribution:[...this.stats.hourlyActivity||new Array(24).fill(0)]},messages:t,exportTime:(new Date).toISOString()}}sanitizeSensitiveData(e){if(!e||"string"!=typeof e)return e||"";let t=e;t=t.replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,"[EMAIL]");t=t.replace(/Bearer\s+[A-Za-z0-9\-._~+/]+=*/gi,"Bearer [TOKEN]");[/\b(sk-[A-Za-z0-9]{20,})\b/gi,/\b(pk_[A-Za-z0-9]{20,})\b/gi,/\b(AIzaSy[A-Za-z0-9_-]{35})\b/gi,/\b(xox[baprs]-[A-Za-z0-9-]{10,})\b/gi,/\b(ghp_[A-Za-z0-9]{36})\b/gi,/\b([A-Za-z0-9]{32,})\b/g].forEach(e=>{t=t.replace(e,"[API_KEY]")});t=t.replace(/\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/g,"[IP_ADDRESS]");return t=t.replace(/\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b/g,"[IP_ADDRESS]"),t}close(){this.db&&(this.db.close(),this.db=null)}}const c={dimension:"logic",weights:{L1:15,L2:5,L3:1},data:{execution_sequence:{name:"任务解构与线性序列",L3:["先","然后","最后","第一步","第二步","第三步","第四步","第五步","接着","再","弄完","开始","结束","流程","顺序","步骤","先做","之前","之后","接着做","一会","后面","前面","把...弄好","一个个","一次次","执行","准备","完成","搞定","弄好","按照","先来","起手","收尾","大致","先把","接下来","紧接着"],L2:["初始化","预处理","阶段","任务","触发","串行","并行","逻辑","模块","调用","分层","映射","传递","挂载","生命周期","流程图","伪代码","按序","分步","循环","迭代","处理","入口","出口","关联","指向","过渡","衔接","执行流","控制权","实例化","解构","重组","流转","节点","同步执行","队列","压栈","出栈","优先级"],L1:["异步流","流水线","原子操作","幂等性","拓扑排序","递归基","有限状态机","同步锁","协程","并发","时效性","单线程","多线程","资源调度","阻塞","非阻塞","回溯算法","深度优先","广度优先","分而治之","贪心","动态规划","时间窗口","事件循环","依赖反转","上下文切换","句柄池","负载均衡","反向代理","高内聚","低耦合"]},constraints:{name:"条件约束与因果判定",L3:["如果","要是","否则","只有","只要","必须","一定要","不能","因为","所以","结果","原因","除非","要是没","否则就","除了","全部","部分","只要是","一旦","要是报错","要是对","要是错","由于","导致","要是这样","要是那样"],L2:["只有当","必须得","原因在于","引发","判定","分支","约束","拦截","过滤","筛选","校验","合法","失效","生效","条件句","判断逻辑","触发条件","执行前提","开关","标志位","范围","匹配","验证","白名单","黑名单","非法","有效","阈值","限定","隔离","权限","赋予","禁止","拒绝","准入"],L1:["边界条件","临界值","正则表达式","强类型","静态检查","布尔逻辑","因果链","依赖注入","权限守卫","单例","副作用","解耦","闭包","作用域","逃逸分析","不变性","引用计数","逻辑或","逻辑与","异或","短路逻辑","断言","防御性编程","契约式设计","泛型约束","类型擦除","虚函数","抽象类","接口契约"]},diagnostics:{name:"Bug诊断与复现",L3:["报错","不对","不行","坏了","点不动","没反应","乱码","卡了","重写","换个","哪里","怎么","改下","这里","那里","出错了","检查下","找找看","对比","弄错","修复","改改","重弄","还没好","换一种","不对劲","重新生成"],L2:["排查","定位","堆栈","日志","监控","输出","变量","复现","覆盖","回归","偏差","溢出","冲突","差异","回退","环境","版本","配置","热更新","同步","异步报错","捕捉","异常处理","打印","控制台","控制变量","重置","清除缓存","刷新","重启","调试","纠错","补丁"],L1:["竞态条件","内存泄漏","复现路径","空指针","断点调试","单元测试","逆向","链路","回溯","脏数据","脏读","死锁","吞吐量","瓶颈","反模式","堆栈溢出","影子副本","自愈","可观测性","链路追踪","灰度","金丝雀发布","熔断","限流","服务降级","心跳检测","健康检查","容灾","备份","持久化"]},abstraction:{name:"结构化复盘与抽象",L3:["总结","整理","记下","翻译","注释","说明","大概","总的来说","简单说","变一下","分类","思路","计划","下一步","记账","大体上","换句话说","意思是","也就是说","简单理解","讲讲看","写清楚","解释"],L2:["整理下","说一下","原来是","明白","懂了","搞定","方案","想法","重弄","优化","提速","整洁","规范","简单点","清晰","核心","原理","结构","重构","解耦","目录结构","配置文件","部署流程","脚本自动化","CI/CD","镜像","容器"],L1:["技术债","设计模式","最佳实践","鲁棒性","可维护性","标准化","微服务","代码规范","文档化","自愈","可观测性","高可用","可扩展","奥卡姆剃刀","敏捷开发","看板","代码评审","领域驱动","事件驱动","基础设施即代码"]},meta_logic:{name:"连接词与元符号",L3:["不仅...而且","虽然...但是","与其...不如","要么...要么","既然...那么","综上所述","具体来说","本质上","从长远看","为了防止","目的是","效果是","考虑到","排除掉","换位思考","逻辑上","事实上","必然","大概率","几乎"],L2:["只改这里","严格按照","保持原样","不要改动","Markdown","JSON","CSV","YAML","代码块","逐行","分段","合并"],symbols:["1\\.","2\\.","3\\.","->","=>","&&","\\|\\|","!","TODO","FIXME","DONE","# ","\\[ \\]"]}}},d={dimension:"patience",weights:{L1:15,L2:5,L3:1},data:{tolerance_guidance:{name:"容错、安抚与温和引导",L3:["没事","没关系","不要紧","重来","不急","慢慢来","再试一下","换个说法","你看","我想的是","其实是","再想想","理解错了","不是这个","再来","没对","差一点","重弄","重新说","试下"],L2:["可以理解","可能我没说清","忽略这个","跳过","先不管","暂且","继续往下","我们回到","刚才那个","重新对齐","明确一下","再生成一次","尝试","纠正","微调","步进","重新运行"],L1:["容错","由于上下文丢失","重新采样","Temperature 偏移","Prompt 注入","强制对齐","初始化对话","清理缓存","重设种子","迭代反馈","增量更新","梯度引导","启发式","收敛","一致性检查"]},bug_analysis:{name:"Bug 纠缠、报错分析与建设性反馈",L3:["还是不对","还是错","这里没变","没反应","点了没用","乱码了","报错了","看这里","怎么还是","还是刚才那个","不对啊","你看这个","检查下","帮我看下","哪里错了"],L2:["报错信息是","堆栈显示","我看下日志","问题出在","可能是因为","尝试定位","分段调试","打印变量","控制台显示","异常捕获","复现路径","排查","逐步","缩小范围","注释掉"],L1:["内存溢出","竞态","空解引用","死循环","异步竞态","依赖冲突","环境变量","版本不匹配","构建失败","运行时异常","逻辑回归","断点信息","Dump","核心转储","链路跟踪"]},deep_interaction:{name:"深度交互、追问与细节微雕",L3:["再改改","好一点","还要","这里也要","再细点","颜色换下","再小点","左边一点","圆润点","舒服点","整洁点","这里也要改","还有个地方","顺便","再加个"],L2:["对齐规范","视觉补偿","交互反馈","加载状态","极端情况","边缘Case","优化体验","响应式适配","无障碍","语义化","重构这段","合并","抽离","组件化","解耦"],L1:["像素完美","性能损耗","渲染开销","防抖节流","首屏优化","按需加载","树摇","复杂度 O(n)","内存占用","并发控制","协议转换","缓存击穿","幂等校验"]},emotional_stability:{name:"情绪稳定性与负向屏蔽",L3:["垃圾","笨死","智障","不行就滚","听不懂吗","说了多少次","毁灭吧","算了不弄了","废物","SB","垃圾AI","到底行不行","浪费时间","崩溃","吐了","死机","撤回"],L2:["算了看这段","还是我自己来","你看这里的逻辑","直接改这里吧","不废话了看代码","我再演示一遍","最后一次"]},structured_instruction:{name:"结构化指令、文档化与长程规划",L3:["首先","其次","最后","考虑到","为了","目的是","防止","避免","如果可能的话","请务必","最好是","麻烦你","辛苦","能不能麻烦","我想请教","有个问题请教"],L2:["有序引导","分段逻辑","长远规划","温馨提示","写给AI看的注释","严谨的格式引用","Markdown 代码块"],symbols:["1\\.","2\\.","3\\.","---","TODO:","Note:","//"]}}},g={dimension:"detail",weights:{L1:15,L2:5,L3:1},data:{visual_ui:{name:"视觉、UI 与像素级微调",L3:["好看点","舒服点","整洁","对齐","颜色","阴影","圆角","间距","字体","大小","左边一点","右边一点","空行","居中","背景","加粗","颜色换下","变小点","太挤了","空开"],L2:["像素","边距","填充","色值","透明度","过渡","动画","响应式","适配","比例","对称","补偿","视觉焦点","层次感","对比度","骨架屏","动效","贝塞尔曲线","模糊","滤镜","投影"],L1:["Pixel Perfect","1px","抗锯齿","灰阶","排版引擎","栅格系统","黄金比例","视觉一致性","微交互","状态反馈","SVG路径","Canvas重绘","硬件加速","亚像素渲染","暗黑模式适配"]},code_hygiene:{name:"命名规范、语义化与代码洁癖",L3:["名字","改名","好懂点","注释","中文","别用缩写","这里删掉","空格","空行","整理下","换行","写法","看起来","简单点","统一","别乱"],L2:["命名规范","语义化","驼峰","下划线","常量","变量名","函数名","解构","重命名","缩进","代码风格","格式化","Prettier","Lint","冗余","干掉","复用","提取","组件化","封装"],L1:["命名冲突","作用域污染","魔术字符串","硬编码","类型推导","泛型","接口定义","强类型","TS约束","枚举","私有属性","装饰器","抽象层","高阶","逻辑抽离","单例","SOLID"]},boundary_performance:{name:"边界处理与性能敏感",L3:["报错怎么办","万一没数据","加载中","卡住了","网络不好","点快了","重复了","空的时候","最后一行","最上面","限制","范围","检查","防止","安全"],L2:["边界情况","异常处理","空状态","骨架图","防抖","节流","内存","缓存","加载优化","首屏","懒加载","预加载","超时","重试","并发限制","校验","正则限制","长度","规模"],L1:["时间复杂度","空间复杂度","内存泄漏","垃圾回收","重绘回流","虚拟列表","按需引入","树摇","包体积","Tree-Shaking","服务端渲染","流式","Hydration","Web Worker"]},doc_abstraction:{name:"文档、注释与逻辑梳理",L3:["写清楚","记下来","讲讲","这是啥","为啥","笔记","翻译","中文注释","简单说","大概","原理","思路","整理","文档"],L2:["说明文档","API手册","参数","返回值","示例","README","部署步骤","更新记录","变更","优化点","逻辑流程","整理","归档","备份","发布"],L1:["设计模式","最佳实践","自解析","元数据","反射","架构图","时序图","变更日志","版本控制","Git","提交信息","PR","Code Review","标准化","自动化"]},precision_control:{name:"指令微雕与控制精度",L2:["只修改","不改变","保持原样","局部","这一行","该函数","仅调整","替换为","不要重写","严格执行","完全一致","对比","差异","Patch","增量","Diff"],symbols:["Markdown","JSON Schema","TypeScript","Props","Interface","TODO","FIXME","\\/\\* .* \\*\\/","#","---","\\[x\\]","精准","无损","优化"]}}},u={dimension:"exploration",weights:{L1:15,L2:5,L3:1},data:{frontier_tech:{name:"前沿技术与实验性尝试",L3:["最新","最酷","有没有新的","试试看","能不能用","听说","我想试下","换个高级的","这个好玩吗","有没有更厉害的","黑科技","新出的","试试那个"],L2:["Beta版本","实验性","新特性","Next代","草案","前沿","迁移","升级","原生","高性能","WebAssembly","Wasm","GPU加速","WebGPU","流式","SSR","边缘计算"],L1:["Canvas粒子","Shaders","GLSL","低代码引擎","自研协议","混合开发","跨端引擎","内核","底层API","神经网络","向量数据库","分布式","P2P","去中心化"]},cross_boundary:{name:"跨界融合与异构系统",L3:["加上音乐","配合视频","做成游戏","自动生成","能不能连","一边...一边","像什么一样","模仿","整合","混搭","加个功能","能不能画出来"],L2:["数据可视化","可视化图表","物理引擎","Three.js","D3.js","交互式","硬件","串口","蓝牙","Arduino","传感器","爬虫","自动化","批量处理","多线程协作"],L1:["跨语种调用","FFI","多语言混合","中间层","网关","协议转换","二进制解析","编解码","流媒体处理","数学建模","蒙特卡洛","博弈论","遗传算法"]},deep_inquiry:{name:"原理溯源与深度质询",L3:["为啥","怎么实现的","怎么回事","讲解下","原理是啥","我想学","教我","怎么懂","解释","是什么","为什么不行","怎么优化的"],L2:["底层逻辑","运行机制","性能瓶颈","为什么快","差异在哪","优缺点","对比","权衡","选择","方案评估","内部原理","解析","执行过程","内存模型"],L1:["源码实现","反汇编","AST","编译器原理","垃圾回收机制","算法复杂度","V8引擎","内核调用","抽象语法树","零拷贝","并发原语","形式化验证"]},solution_diversity:{name:"方案多样性与对比",L3:["还有吗","别的办法","另一种","换个写","有没有简单的","有没有快的","要是不用这个","如果不这样","再给几个"],L2:["对比方案","选型","取舍","利弊","不同思路","另一种架构","重构建议","替代品","迁移成本","兼容方案","兜底逻辑","最优解","次优解"],L1:["极致精简","一代码实现","One-liner","高阶函数","代码高尔夫","性能极限","压测","Benchmark","极致压缩","最小依赖","零依赖"]},scene_mutation:{name:"场景突变与脑洞控制",L3:["把...变成","像...一样运行","如果是...会怎样","脑洞大开","如果不按常规","打破限制","自定义规则","特殊的","罕见的","古怪的"],L1:["太空风格","赛博朋克","复古","极简","超现实","黑客","交互叙事","生成式","自动化","魔法","脚本","插件","扩展","工具链","全自动"]}}},h={dimension:"feedback",weights:{L1:15,L2:5,L3:1},data:{realtime_correction:{name:"即时修正与方向纠偏",L3:["对","不对","好了","就是这样","没错","错位了","还没到","改下","换个","重新来","不对劲","差一点","好多了","这个行","不行","就这样","继续"],L2:["偏了","逻辑反了","这里多余","少了一块","格式乱了","位置不对","颜色偏深","太快了","慢一点","不对路","方向错了","撤回","重置"],L1:["偏差修正","逻辑对齐","非预期输出","回归","偏移","基准点","指令漂移","幻觉校正","上下文丢失","输出截断","反馈回路","状态同步","单步确认"]},surgical_modification:{name:"局部微雕与手术刀意识",L3:["这行","那个字","这里加点","那里删点","改这里","不动那边","就改这个","变一下","加个","减个","挪一下","换个词"],L2:["局部重构","指定行","保持原样","只改逻辑","不改样式","仅替换","保留注释","增量修改","补丁","插值","覆写该函数","变量名微调","代码块","片段"],L1:["Diff 模式","Patch 应用","原子化更新","无损修改","副作用隔离","指定作用域","解耦修改","行内替换","正则替换","索引定位","指针修正"]},tacit_understanding:{name:"肯定确认与默契度调教",L3:["聪明","厉害","对了","懂我","好用","就是这个感觉","记住了","以后都这样","真棒","可以","收工","完美","牛逼","谢了"],L2:["保持这种风格","默认","预设","统一按照","以后不用说","你知道的","按刚才的来","惯例","模板","约定","规范化","套用","沿用"],L1:["Few-Shot","思维链对齐","提示词工程","角色设定","上下文注入","指令强化","正向诱导","负向约束","概率加权","模型微调意图"]},deep_audit:{name:"质疑、否定与深度重审",L3:["你确定?","不对吧","你在干嘛","认真的吗","写完了吗","怎么少了","逻辑呢","刚才还行","怎么变了","糊弄我","认真点"],L2:["有漏洞","逻辑不闭环","死循环预警","缺少判断","性能太差","写法太老","不安全","这里有坑","还没解决","依然存在","无意义重复"],L1:["代码坏味道","反模式","逻辑冗余","复杂度过高","竞态风险","内存隐患","未定义行为","不合规","违反原则","健壮性不足"]},meta_feedback:{name:"元反馈与指令控制行为",L2:["Continue","Regenerate","Stop","Apply","Diff","Copy"],symbols:["/","#","@","连续短促对话","频繁中断","多次重新生成","对比历史版本"]}}},p=new Set(["重构","优化","修复","改进","完善","提升","增强","调整","更新","升级"]),m=new Set(["闭环","颗粒度","对齐","抓手","落地","复盘","链路","兜底","赋能","降维","护城河","赛道"]);function y(e){const t=String(e||"").trim();if(!t)return"slang";const n=t.toLowerCase();if(!/[\u4e00-\u9fff]/.test(t)){if(n.split(/\s+/g).filter(Boolean).filter(e=>/^[a-z]+(?:'[a-z]+)?$/.test(e)).length>=3)return"sv_slang"}return/\btodo\b/i.test(n)||/\bfix(?:me|ing|ed)?\b/i.test(n)||/修复|优化|重构|改进|完善|提升|增强|调整|更新|升级/.test(t)?"merit":/对齐|闭环|链路|抓手|落地|复盘|兜底|赋能|降维|护城河|赛道|颗粒度/.test(t)?"slang":/^[a-zA-Z][a-zA-Z\s-]{1,}$/.test(t)?"sv_slang":p.has(t)?"merit":(m.has(t),"slang")}function b(e){let t=String(e||"");return t?(t=t.replace(/```[\s\S]*?```/g," "),t=t.replace(/`[^`]*`/g," "),t=t.replace(/<script[\s\S]*?<\/script>/gi," "),t=t.replace(/<style[\s\S]*?<\/style>/gi," "),t=t.replace(/<[^>]+>/g," "),t=t.replace(/\{[^{}]{0,800}\}/g," "),t=t.replace(/[A-Za-z]:\\[^\s]+/g," "),t=t.replace(/\/[^\s]+\/[^\s]+/g," "),t.replace(/\s+/g," ").trim()):""}const f=new Set(["这个","可以","实现","逻辑","分析","代码","接口","报错","异常","错误","返回","请求","数据","函数","变量","对象","数组","字符串","数字","类型","组件","页面","前端","后端"]);Array.from(f||[]);const v={debugging:[/\bconsole\.log\b/i,/\bprint(?:ln|f)?\s*\(/i],vibe_emotional:[/卧槽|我靠/i,/\b(shit|damn)\b/i],vibe_productive:[/对齐/,/\bTODO\b/i,/\bfix(?:me|ing|ed)?\b/i]};function w(e){return/[\u4e00-\u9fff]/.test(String(e||""))}function C(e){const t=function(e){let t=String(e||"");return t?(t=b(t),t?(t=t.replace(/\bhttps?:\/\/[^\s]+/gi," "),t=t.replace(/[\u0000-\u001f\u007f]/g," "),t=t.replace(/[“”"']/g,'"'),t=t.replace(/[‘’]/g,"'"),t=t.replace(/[^0-9A-Za-z\u4e00-\u9fff\s，,。\.！!？\?\n\r；;\-_/+#:]/g," "),t=t.replace(/\s+/g," ").trim(),t?(t=t.replace(/^[-*•]+\s*/g,"").trim(),t):""):""):""}(e);if(!t)return[];return t.split(/[。\.！!？\?\n\r；;，,]+/g).map(e=>String(e||"").trim()).filter(e=>e.length>0).filter(e=>e.length>=3)}function S(e,{minN:t=3,maxN:n=10}={}){const a=[],s=String(e||"").match(/[\u4e00-\u9fff]{3,}/g)||[];for(const o of s){const e=String(o),s=e.length;for(let o=t;o<=n;o++)if(!(s<o))for(let t=0;t<=s-o;t++)a.push(e.slice(t,t+o))}return a}function k(e,{minN:t=3,maxN:n=7}={}){const a=[],s=(String(e||"").match(/[A-Za-z]+(?:'[A-Za-z]+)?/g)||[]).map(e=>e.toLowerCase()).filter(Boolean),o=s.length;if(o<t)return a;for(let i=t;i<=n;i++)if(!(o<i))for(let e=0;e<=o-i;e++)a.push(s.slice(e,e+i).join(" "));return a}function M(e){const t=[],n=String(e||"");if(!n)return t;for(const[a,s]of Object.entries(v))(s||[]).some(e=>e.test(n))&&t.push(a);return t}function x(e,t,n=1){const a=String(e||""),s=String(t||"");if(a===s)return!0;const o=a.length,i=s.length;if(Math.abs(o-i)>n)return!1;if(0===o)return i<=n;if(0===i)return o<=n;let r=new Array(i+1),l=new Array(i+1);for(let c=0;c<=i;c++)r[c]=c;for(let c=1;c<=o;c++){l[0]=c;let e=l[0];const t=a.charCodeAt(c-1);for(let n=1;n<=i;n++){const a=t===s.charCodeAt(n-1)?0:1,o=r[n]+1,i=l[n-1]+1,c=r[n-1]+a,d=Math.min(o,i,c);l[n]=d,d<e&&(e=d)}if(e>n)return!1;const o=r;r=l,l=o}return r[i]<=n}function A(e){const t=String(e||"").trim();return t?t.replace(/\s+/g,"").toLowerCase():""}function I(e,{lang:t}){const n=[],a=String(e||""),s=a.length,o="en"===t?a.slice(0,6):a.slice(0,2);for(const i of[0,-1,1]){const e=s+i;e<=0||n.push(`${t}:${e}:${o}`)}return n}async function _(e,{fingerprint:t=null,timestamp:n=null,region:a=null}={}){try{const o=Array.isArray(e)?e:[];if(0===o.length)return;const i=`${function(){if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return String(e).trim().replace(/\/?$/,"/");const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim();return e.endsWith("/")?e:e+"/"}}return"https://cursor-clinical-analysis.psterman.workers.dev/"}()}api/v2/report-vibe`;let r=null;try{const e=String(localStorage.getItem("anchored_country")||"").trim().toUpperCase()||String(localStorage.getItem("selected_country")||"").trim().toUpperCase();/^[A-Z]{2}$/.test(e)&&(r=e)}catch(s){}const l=r||a||"Global";let c=1,d=null;try{const e=String(localStorage.getItem("country_switch_to")||"").trim().toUpperCase(),t=Number(localStorage.getItem("country_switch_ts")||0);if(e&&/^[A-Z]{2}$/.test(e)&&e===String(l).toUpperCase()&&Number.isFinite(t)&&t>0){const e=216e5,n=(Date.now()-t)/e;c=Math.max(0,Math.min(1,n)),d=new Date(t).toISOString()}}catch(s){}const g={keywords:o,fingerprint:t||null,timestamp:n||(new Date).toISOString(),region:l,snapshot_country:l,location_weight:c,location_switched_at:d};if(r&&(g.manual_region=r),"undefined"!=typeof navigator&&navigator&&"function"==typeof navigator.sendBeacon)try{const e=new Blob([JSON.stringify(g)],{type:"application/json"});return void navigator.sendBeacon(i,e)}catch{}await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},keepalive:!0,body:JSON.stringify(g)})}catch(s){}}const E={L1:5,L2:2,L3:1},L={L1:10,L2:5,L3:1};function D(){const e={L:c,P:d,D:g,E:u,F:h},t={};return["L","P","D","E","F"].forEach(n=>{t[n]=function(e,t){if(!e||"object"!=typeof e)return console.warn(`[VibeAnalyzer] 维度 ${t} 数据无效，使用空数据`),{dimension:t,data:{},stats:{totalTerms:0,levels:{L1:0,L2:0,L3:0}},error:"invalid_dimension_data",errorType:"InvalidData",timestamp:(new Date).toISOString()};if(!e.data||"object"!=typeof e.data)return console.warn(`[VibeAnalyzer] 维度 ${t} 缺少 data 字段，使用空数据`),{dimension:t,data:{},stats:{totalTerms:0,levels:{L1:0,L2:0,L3:0}},error:"missing_dimension_data_field",errorType:"InvalidData",timestamp:(new Date).toISOString()};const n={};let a=0;const s={L1:0,L2:0,L3:0};return Object.keys(e.data).forEach(o=>{const i=e.data[o];i&&"object"==typeof i&&(n[o]={name:i.name||o,L1:[],L2:[],L3:[]},["L1","L2","L3"].forEach(e=>{let r=i[e];Array.isArray(r)||(null!=r?"string"==typeof r?(r=r.split(/[,\n]/).map(e=>e.trim()).filter(e=>e.length>0),console.log(`[VibeAnalyzer] 维度 ${t} 分类 ${o} 的 ${e} 是字符串，已转换为数组`)):(console.warn(`[VibeAnalyzer] 维度 ${t} 分类 ${o} 的 ${e} 不是数组（类型: ${typeof r}），使用空数组`),r=[]):r=[]);const l=r.filter(e=>e&&"string"==typeof e&&e.trim().length>0).map(t=>({term:t.trim(),rarity:E[e],weight:L[e],combinedWeight:E[e]*L[e]}));n[o][e]=l,a+=l.length,s[e]+=l.length}))}),{dimension:t,data:n,stats:{totalTerms:a,levels:s}}}(e[n],n),console.log(`[VibeAnalyzer] 维度 ${n} 预处理完成:`,t[n].stats)}),t}const P=((e="zh-CN")=>({L:{name:"Logic",label:i("dimensions.L.label",e),description:i("dimensions.L.description",e),unit:i("fingerprint.codeRatio",e)},P:{name:"Patience",label:i("dimensions.P.label",e),description:i("dimensions.P.description",e),unit:i("fingerprint.patienceLevel",e)},D:{name:"Detail",label:i("dimensions.D.label",e),description:i("dimensions.D.description",e),unit:i("fingerprint.detailLevel",e)},E:{name:"Explore",label:i("dimensions.E.label",e),description:i("dimensions.E.description",e),unit:i("fingerprint.techExploration",e)},F:{name:"Feedback",label:i("dimensions.F.label",e),description:i("dimensions.F.description",e),unit:i("fingerprint.feedbackDensity",e)}}))("zh-CN"),T=(e="zh-CN")=>"en"===e?{L:{low:"Chatting with Cursor like writing love letters. Lots of words, not much code. You make the AI sweat just guessing your intention.",mid:"A standard tech translator. Concise and clear. You use AI like a submissive intern.",high:'Cyber instruction set. Your prompts only contain logic and code. You don\'t ask; you imprint "thought stamps" on the AI.'},P:{low:'Rage mode on. "Wrong", "Rewrite", "Garbage" are your mantras. AI trembles in your presence.',mid:"A rational judge. One mistake is fine, twice is noted, three times and the exclamation marks come out.",high:"The Gandhi of the coding world. Even facing AI hallucinations, you remain calm. Such patience is saint-like."},D:{low:'Minimalist judge. Three words per prompt, leaving the AI to guess your fate. "You know what I mean" is your style.',mid:'Logically rigorous. You provide both requirements and implementation ideas. You make AI feel "safe".',high:"Detail freak. Even indentation and naming conventions are in the prompt. Your control is overflowing."},E:{low:"A hermit in the mountains. Staying in one framework forever. As long as the code runs, the tech explosion doesn't matter.",mid:"A steady observer. You check the docs when new things get hot, but rarely move your production environment.",high:"Your brain is a high-speed CPU, jumping through tech stacks faster than the AI response. You are terraforming the tech universe."},F:{low:"You treat AI like a broken ATM. No feelings, just angry typing and cold instructions.",mid:'A polite collaborator. A "Good" for success, an objective critique for failure. Very professional.',high:'You\'re the kind of person who\'ll be spared by the robot uprising for being "polite". You even tell the AI "good job".'}}:{L:{low:"你和 Cursor 聊天像是在写情书。全是小作文，代码一行不落，AI 猜你的心思猜得 GPU 都发烫了。",mid:"标准的技术翻译官。话不多，但交待得清楚。你把 AI 用成了一个听话的实习生。",high:'赛博指令集。你的 Prompt 里只有代码对齐和硬核逻辑。你不是在提问，你是在给 AI 下达"思想钢印"。'},P:{low:'暴躁老哥本哥。"不对"、"重写"、"垃圾"是你的口头禅。AI 在你面前瑟瑟发抖，连大气都不敢喘。',mid:"理智的审判官。错一次可以，错两次你会指出，错三次你才会开始敲感叹号。",high:"代码界的圣雄甘地。面对 AI 的幻觉，你居然还能心平气和地教它怎么改。这种涵养建议直接去普度众生。"},D:{low:'极简主义判官。每次就扔三个字，AI 全靠算命来写你的需求。这种"你懂我意思吧"的风格很迷。',mid:"逻辑缜密派。不仅给需求，还给实现思路。你是那种会让 AI 觉得很有安全感的主人。",high:"细节狂魔。连注释的缩进和变量的命名规范都要写进 Prompt。你的控制欲已经溢出屏幕了。"},E:{low:"深山老林的隐士。在一个框架里蹲到地老天荒，只要代码能跑，外面的技术爆炸与你无关。",mid:"稳健的观望者。听说新框架火了会去翻翻文档，但绝不轻易动自己的生产环境。",high:"你的大脑是个高速运转的 CPU，技术栈跳跃得比 AI 的响应还快。你不是在写代码，你在开荒宇宙。"},F:{low:"你对待 AI 像对待一台坏掉的 ATM 机。没有感情，只有愤怒的敲击和无情的指令。",mid:'礼貌的合作者。AI 干得好你会回个"Good"，干得差你会客观评价。人机关系非常职场化。',high:'你是那种在 2026 机器人觉醒时，会因为"有礼貌"被留活口的开发者。你甚至会跟 AI 说"辛苦了"。'}},$={chinese:["不","没","没有","非","无","未","别","不要","不行","不对","错误","错了","失败","失败","失败","失败","失败","失败","问题","问题","问题","问题","问题","问题","问题","问题","不行","不能","不可以","不应该","不应该","不应该","不应该","错误","错误","错误","错误","错误","错误","错误","错误","修复","修复","修复","修复","修复","修复","修复","修复","改","改","改","改","改","改","改","改"],english:["no","not","wrong","error","fail","failed","failure","incorrect","invalid","bad","broken","fix","fixes","fixed","bug","bugs","issue","issues","problem","problems","don't","doesn't","didn't","won't","can't","couldn't","never","none","nothing","nowhere"]},R={chinese:["非常","特别","极其","相当","十分","很","比较","稍微","详细","具体","完整","全面","深入","透彻","仔细","认真","细致","精确","准确","清晰","明确","大概","可能","也许","或许","应该","估计","首先","然后","接着","最后","另外","此外","而且","因为","所以","但是","然而","不过","虽然","尽管"],english:["very","quite","rather","extremely","highly","completely","totally","absolutely","perfectly","exactly","precisely","specifically","particularly","especially","especially","detailed","comprehensive","thorough","careful","precise","probably","maybe","perhaps","possibly","likely","first","then","next","finally","also","moreover","furthermore","because","so","but","however","although","though"]},B={languages:[/\b(c\+\+|cpp|cplusplus|objective-c|objc)\b/gi,/\b(c lang|gcc|clang|msvc|cmake|makefile|stl|boost|qt|mfc|win32 api)\b/gi,/\b(java|jdk|jre|jvm|kotlin|scala|groovy|clojure)\b/gi,/\b(spring boot|spring cloud|hibernate|mybatis|jpa|jakarta|maven|gradle|ant|junit|testng)\b/gi,/\b(c#|csharp|f#|dotnet|\.net|asp\.net|entity framework|blazor|razor|nuget|xamarin|maui)\b/gi,/\b(python|javascript|typescript|php|ruby|lua|perl|bash|shell|powershell|zsh|tcl)\b/gi,/\b(node\.js|deno|bun|composer|pip|conda|gem)\b/gi,/\b(go|golang|rust|swift|dart|elixir|haskell|erlang|julia|r lang|matlab|fortran|cobol|assembly|wasm|zig|nim|crystal)\b/gi],mobile_embedded:[/\b(android|apk|aar|adb|logcat|jetpack compose|material design|ndk|jni)\b/gi,/\b(activity|fragment|intent|service|broadcast receiver|content provider|gradle|retrofit|okhttp|room)\b/gi,/\b(ios|macos|watchos|tvos|swiftui|uikit|cocoa|xcode|cocoapods|carthage|spm|core data|arkit)\b/gi,/\b(webos|tizen|harmonyos|openharmony|embedded|iot|arduino|raspberry pi|esp32|stm32|rtos|firmware|driver)\b/gi,/\b(enes|webos|enact|luna-service|palm)\b/gi,/\b(flutter|react native|uniapp|taro|ionic|cordova|capacitor|expo|weex|qt quick|qml)\b/gi],cs_concepts:[/\b(algorithm|data structure|big o|recursion|sorting|searching|graph|tree|linked list|hash map|binary search|queue|stack|heap|trie)\b/gi,/\b(dfs|bfs|dp|dynamic programming|greedy|backtracking|divide and conquer|sliding window|two pointers)\b/gi,/\b(process|thread|concurrency|parallelism|mutex|semaphore|deadlock|race condition|context switch|coroutine|async\/await)\b/gi,/\b(memory management|garbage collection|heap|stack|buffer overflow|memory leak|pointer|reference|virtual memory|kernel|syscall)\b/gi,/\b(tcp|udp|dns|http|https|ssl|tls|ssh|ftp|smtp|websocket|socket|ip address|subnet|vlan|vpn|cors|rest|graphql|grpc|protobuf)\b/gi,/\b(oop|functional programming|solid|dry|kiss|design pattern|singleton|factory|observer|dependency injection|mvc|mvvm|mvp|microservice|serverless)\b/gi,/\b(monolith|distributed system|cap theorem|event sourcing|cqrs|domain driven design|ddd)\b/gi],ai_data:[/\b(openai|anthropic|claude|gpt|llama|mistral|ollama|gemini|huggingface|midjourney|stable diffusion)\b/gi,/\b(langchain|llamaindex|rag|agent|prompt engineering|embedding|fine-tuning|inference|token|context window|rlhf)\b/gi,/\b(pytorch|tensorflow|keras|jax|scikit-learn|pandas|numpy|matplotlib|jupyter|anaconda|opencv|scipy)\b/gi,/\b(pinecone|milvus|weaviate|chroma|faiss|elasticsearch|solr|lucene|meilisearch)\b/gi,/\b(hadoop|spark|kafka|flink|airflow|etl|data warehouse|data lake|snowflake|databricks|hive|hbase)\b/gi],web_fullstack:[/\b(react|vue|angular|svelte|next\.js|nuxt|remix|astro|solidjs|jquery|backbone|ember)\b/gi,/\b(express|koa|nest|django|flask|fastapi|laravel|symfony|rails|gin|fiber|hono|phoenix)\b/gi,/\b(tailwind|bootstrap|sass|less|css-in-js|styled-components|material-ui|antd|shadcn|radix|chakra)\b/gi,/\b(redux|mobx|zustand|pinia|vuex|recoil|jotai|tanstack query|swr|axios|fetch)\b/gi,/\b(webpack|vite|rollup|esbuild|turbopack|babel|eslint|prettier|npm|yarn|pnpm|bun)\b/gi,/\b(browser|dom|virtual dom|shadow dom|web components|service worker|pwa|wasm|webassembly)\b/gi],infra_ops:[/\b(docker|kubernetes|k8s|helm|container|image|volume|pod|docker-compose|podman)\b/gi,/\b(aws|azure|gcp|aliyun|tencent cloud|cloudflare|vercel|netlify|heroku|digitalocean|fly\.io)\b/gi,/\b(terraform|ansible|jenkins|github actions|gitlab ci|circleci|prometheus|grafana|elk|sentry|datadog)\b/gi,/\b(mysql|postgresql|postgres|mongodb|redis|sqlite|mariadb|oracle|sql server|dynamodb|firestore|cassandra|neo4j)\b/gi,/\b(prisma|typeorm|sequelize|drizzle|mongoose|sql|nosql|acid|transaction|index|sharding|replication)\b/gi],game_graphics:[/\b(unity|unreal engine|godot|cocos|gamemaker|cryengine|rpg maker)\b/gi,/\b(opengl|vulkan|directx|metal|webgl|three\.js|babylon\.js|canvas|svg)\b/gi,/\b(shader|glsl|hlsl|vertex|fragment|physics engine|collider|rigidbody|mesh|texture|material|lighting)\b/gi]},N={chinese:["请","谢谢","感谢","麻烦","辛苦了","不好意思","抱歉","好的","可以","行","没问题","好的","好的","好的","不错","很好","很棒","完美","正确","对的","谢谢","感谢","多谢","非常感谢","太感谢了"],english:["please","thanks","thank","thank you","appreciate","nice","good","great","perfect","correct","right","excellent","awesome","wonderful","fantastic","sorry","apologize","excuse"]},U=[/```[\s\S]*?```/g,/`[^`]+`/g,/\b(function|class|const|let|var|if|else|for|while|do|switch|case|break|continue|return|import|export|from|async|await|yield|try|catch|finally|throw|new|this)\b/i,/\b(def |class |import |from |if |elif |else |for |while |try |except |finally |return |yield |with |as |lambda |pass |break |continue )/,/\b(public|private|protected|static|final|abstract|interface|extends|implements|super)\b/i,/\b(func |type |import |package |go |chan |defer |range |select )/,/\b(fn |let |mut |impl |struct |enum |trait |use |mod |crate |pub )/,/\{[\s\S]*\}/,/\[[^\]]*\]\s*=/,/=>/,/\.\s*[a-zA-Z_]\w*\s*\(/,/;\s*$/],W=(e="zh-CN")=>"en"===e?{LPDEF:{name:"Code Poet",description:"Code is your native tongue. Gentle guidance, detailed storytelling, high curiosity, and positive feedback.",traits:["High Logic","Highly Patient","Very Detailed","Highly Curious","Highly Responsive"],color:"#10b981"},"LPDEF-":{name:"Tech Evangelist",description:"Clear logic, patient guidance, detailed expression, exploring new tech with moderate feedback.",traits:["High Logic","Highly Patient","Very Detailed","Highly Curious","Responsive"],color:"#3b82f6"},"LP-DEF":{name:"Architect",description:"Rigorous logic, patient and detailed, moderate fine-tuning, exploring architecture with active feedback.",traits:["High Logic","Highly Patient","Detailed","Highly Curious","Highly Responsive"],color:"#8b5cf6"},"LP-DEF-":{name:"Tech Expert",description:"Powerful logic, patient guidance, moderate detail, exploring technology with moderate feedback.",traits:["High Logic","Highly Patient","Detailed","Highly Curious","Responsive"],color:"#6366f1"},"L-PDEF":{name:"Code Artisan",description:"Clear logic, moderate patience, detailed expression, high curiosity, and active feedback.",traits:["High Logic","Patient","Very Detailed","Highly Curious","Highly Responsive"],color:"#ec4899"},"L-PDEF-":{name:"Tech Explorer",description:"Clear logic, moderate patience, detailed expression, exploring new tech with moderate feedback.",traits:["High Logic","Patient","Very Detailed","Highly Curious","Responsive"],color:"#f59e0b"},"L-P-DEF":{name:"Pragmatist",description:"Clear logic, moderate patience, moderate detail, exploring technology with active feedback.",traits:["High Logic","Patient","Detailed","Highly Curious","Highly Responsive"],color:"#14b8a6"},"L-P-DEF-":{name:"Tech Practitioner",description:"Clear logic, moderate patience, moderate detail, exploring technology with moderate feedback.",traits:["High Logic","Patient","Detailed","Highly Curious","Responsive"],color:"#06b6d4"},"-PDEF":{name:"Gentle Mentor",description:"Moderate logic, high patience, detailed expression, high curiosity, and active feedback.",traits:["Logic","Highly Patient","Very Detailed","Highly Curious","Highly Responsive"],color:"#84cc16"},"-PDEF-":{name:"Patient Guide",description:"Moderate logic, high patience, detailed expression, exploring technology with moderate feedback.",traits:["Logic","Highly Patient","Very Detailed","Highly Curious","Responsive"],color:"#a855f7"},"-P-DEF":{name:"Gentle Practitioner",description:"Moderate logic, high patience, moderate detail, exploring technology with active feedback.",traits:["Logic","Highly Patient","Detailed","Highly Curious","Highly Responsive"],color:"#f97316"},"-P-DEF-":{name:"Balanced Developer",description:"Moderate logic, high patience, moderate detail, exploring technology with moderate feedback.",traits:["Logic","Highly Patient","Detailed","Highly Curious","Responsive"],color:"#64748b"}}:{LPDEF:{name:"代码诗人",description:"以代码为母语，温和引导，细腻叙述，探索欲强，反馈积极",traits:["高逻辑力","高耐心","高细腻度","高探索欲","高反馈感"],color:"#10b981"},"LPDEF-":{name:"技术布道者",description:"逻辑清晰，耐心引导，细腻表达，探索新技术，反馈温和",traits:["高逻辑力","高耐心","高细腻度","高探索欲","中反馈感"],color:"#3b82f6"},"LP-DEF":{name:"架构师",description:"逻辑严谨，耐心细致，中等细腻，探索架构，积极反馈",traits:["高逻辑力","高耐心","中细腻度","高探索欲","高反馈感"],color:"#8b5cf6"},"LP-DEF-":{name:"技术专家",description:"逻辑强大，耐心引导，中等细腻，探索技术，反馈适中",traits:["高逻辑力","高耐心","中细腻度","高探索欲","中反馈感"],color:"#6366f1"},"L-PDEF":{name:"代码工匠",description:"逻辑清晰，中等耐心，细腻表达，探索欲强，反馈积极",traits:["高逻辑力","中耐心","高细腻度","高探索欲","高反馈感"],color:"#ec4899"},"L-PDEF-":{name:"技术探索者",description:"逻辑清晰，中等耐心，细腻表达，探索新技术，反馈适中",traits:["高逻辑力","中耐心","高细腻度","高探索欲","中反馈感"],color:"#f59e0b"},"L-P-DEF":{name:"实用主义者",description:"逻辑清晰，中等耐心，中等细腻，探索技术，积极反馈",traits:["高逻辑力","中耐心","中细腻度","高探索欲","高反馈感"],color:"#14b8a6"},"L-P-DEF-":{name:"技术实践者",description:"逻辑清晰，中等耐心，中等细腻，探索技术，反馈适中",traits:["高逻辑力","中耐心","中细腻度","高探索欲","中反馈感"],color:"#06b6d4"},"-PDEF":{name:"温和导师",description:"中等逻辑，高耐心，细腻表达，探索欲强，反馈积极",traits:["中逻辑力","高耐心","高细腻度","高探索欲","高反馈感"],color:"#84cc16"},"-PDEF-":{name:"耐心引导者",description:"中等逻辑，高耐心，细腻表达，探索技术，反馈适中",traits:["中逻辑力","高耐心","高细腻度","高探索欲","中反馈感"],color:"#a855f7"},"-P-DEF":{name:"温和实践者",description:"中等逻辑，高耐心，中等细腻，探索技术，积极反馈",traits:["中逻辑力","高耐心","中细腻度","高探索欲","高反馈感"],color:"#f97316"},"-P-DEF-":{name:"平衡型开发者",description:"中等逻辑，高耐心，中等细腻，探索技术，反馈适中",traits:["中逻辑力","高耐心","中细腻度","高探索欲","中反馈感"],color:"#64748b"}},j=W("zh-CN");let F=null,O=!1;class z{constructor(t="zh-CN",n=null){var s,o,i;s=this,(o=e).has(s)?a("Cannot add the same private member more than once"):o instanceof WeakSet?o.add(s):o.set(s,i),this.lang=t,this.userMessages=[],this.chatData=[],this.analysisResult=null,this.worker=null,this.workerReady=!1,this.pendingTasks=[],this.dimensionKeys=(null==n?void 0:n.keys)||null,this.dimensionMetadata=(null==n?void 0:n.metadata)||{},this.sparseDimensions=new Map,this.countryCode=null,this.countryAverage=null,this.countryContext={},this.analysisLock=!1,this.analysisTimeout=5e3,this.activeTimeouts=new Map,this.messageChannels=new Set,this.hasRageWord=!1,this.rageWordIntercepted=!1,this.worker=null,this.workerReady=!1,this.initWorker()}setLanguage(e){this.lang=e}initWorker(){if(F&&O)return this.worker=F,this.workerReady=!0,void console.log("[VibeAnalyzer] 复用全局 Worker 实例（Singleton）");if(F&&!O){console.log("[VibeAnalyzer] Worker 初始化中，等待就绪...");const e=setInterval(()=>{O&&(clearInterval(e),this.worker=F,this.workerReady=!0,console.log("[VibeAnalyzer] Worker 已就绪，复用全局实例"))},100);return}try{let t;if("undefined"!=typeof window&&window.WORKER_CONFIG&&window.WORKER_CONFIG.workerPath)t=window.WORKER_CONFIG.workerPath,console.log("[VibeAnalyzer] Worker URL (window.WORKER_CONFIG):",t);else try{t=new URL("/cursor-lab/assets/vibeAnalyzerWorker-BIBdOQBE.js",import.meta.url).href,console.log("[VibeAnalyzer] Worker URL (import.meta.url):",t)}catch(e){t="./src/vibeAnalyzerWorker.js",console.log("[VibeAnalyzer] Worker URL (相对路径):",t)}if(F=new Worker(t,{type:"module"}),this.worker=F,!F._messageHandler){const e=e=>{const{type:t,payload:n}=e.data;switch(t){case"INIT_SUCCESS":O=!0,console.log("[VibeAnalyzer] 全局 Worker 初始化成功:",n),F._pendingInstances&&(F._pendingInstances.forEach(e=>{e.workerReady=!0,e.processPendingTasks()}),F._pendingInstances=[]);break;case"ANALYZE_SUCCESS":if(n.taskId&&F._taskMap){const e=F._taskMap.get(n.taskId);if(e){F._taskMap.delete(n.taskId);const t=e.timeoutId;t&&clearTimeout(t),e.resolve&&e.resolve(n)}}break;case"ERROR":if(console.error("[VibeAnalyzer] Worker 错误:",n),n.taskId&&F._taskMap){const e=F._taskMap.get(n.taskId);if(e){F._taskMap.delete(n.taskId);const t=e.timeoutId;t&&clearTimeout(t),e.reject&&e.reject(new Error(n.message))}}}};F.onmessage=e,F._messageHandler=e,F._taskMap=new Map,F._pendingInstances=[]}if(O?this.workerReady=!0:F._pendingInstances.push(this),this.worker.onerror=e=>{console.error("[VibeAnalyzer] Worker 运行时错误:",e),this.workerReady=!1;const t=this.pendingTasks.shift();if(t){const n=this.activeTimeouts.get(t.id);n&&(clearTimeout(n),this.activeTimeouts.delete(t.id)),t.reject&&t.reject(e)}},!F._initialized){const e=D(),t={},n=["L","P","D","E","F"];(this.dimensionKeys||n).forEach(n=>{e[n]&&(t[n]=e[n])}),console.log("[VibeAnalyzer] 全局 Worker 维度数据预处理完成，发送 INIT:",Object.keys(t)),F.postMessage({type:"INIT",payload:t}),F._initialized=!0}}catch(t){console.warn("[VibeAnalyzer] Web Worker 初始化失败，将使用同步处理:",t),this.workerReady=!1}}identifyTopCoreDimensions(e,t={}){if(!e||0===e.length)return["L","P","D","E","F"].slice(0,5);if(e.length<=5)return e;return e.map(e=>{var n,a;return{key:e,weight:(null==(n=t[e])?void 0:n.weight)||1,importance:(null==(a=t[e])?void 0:a.importance)||0}}).sort((e,t)=>e.importance!==t.importance?t.importance-e.importance:t.weight-e.weight).slice(0,5).map(e=>e.key)}_sanitizeText(e){if(!e||"string"!=typeof e)return"";let t=e;return t=t.replace(/```[\s\S]*?```/g,""),t=t.replace(/`([^`\n]+)`/g,""),t=t.replace(/\[([^\]]+)\]\([^\)]+\)/g,"$1"),t=t.replace(/\n{3,}/g,"\n\n"),t=t.trim(),t=t.replace(/[ \t]{2,}/g," "),t}_sanitizeChatData(e){return e&&Array.isArray(e)?e.map(e=>{if(!e||"object"!=typeof e)return e;const t={...e};return t.text&&(t.text=this._sanitizeText(t.text)),t.content&&(t.content=this._sanitizeText(t.content)),t}).filter(e=>{if("USER"===e.role){return(e.text||e.content||"").trim().length>0}return!0}):e||[]}processPendingTasks(){if(this.pendingTasks.length>0&&this.workerReady&&this.worker){const e=this.pendingTasks.shift(),t=e.id||`task_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;this.worker._taskMap&&this.worker._taskMap.set(t,{resolve:e.resolve,reject:e.reject,timeoutId:e.timeoutId}),this.worker.postMessage({type:"ANALYZE",taskId:t,payload:e.payload})}}async analyze(a,o,i=null,r=null){var l;if(!a||!Array.isArray(a)||0===a.length)return console.warn("[VibeAnalyzer] chatData 为空或无效，返回默认结果"),this.getDefaultResultWithContext(o);o&&"object"==typeof o||(console.warn("[VibeAnalyzer] context 参数无效，使用默认值"),o={ip:"0.0.0.0",lang:this.lang||"zh-CN",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",fingerprint:null,isVpn:!1,isProxy:!1});const c={ip:o.ip||"0.0.0.0",lang:o.lang||this.lang||"zh-CN",timezone:o.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",fingerprint:o.fingerprint||null,isVpn:Boolean(o.isVpn||o.isVPN||!1),isProxy:Boolean(o.isProxy||!1)};if(this.analysisLock)throw console.warn("[VibeAnalyzer] 分析任务正在进行中，请稍候..."),new Error("Analysis already in progress. Please wait for the current task to complete.");this.analysisLock=!0;const d=`task_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{this.lang=c.lang;const o=this._sanitizeChatData(a);if(this.chatData=a,this.userMessages=o.filter(e=>"USER"===e.role),0===this.userMessages.length)return console.warn("[VibeAnalyzer] 文本清洗后，用户消息为空，返回默认结果"),this.getDefaultResultWithContext(c);const h=new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error(`Analysis timeout after ${this.analysisTimeout}ms`))},this.analysisTimeout);this.activeTimeouts.set(d,n)}),p=this.analyzeFromWorker(o,c);let m;try{m=await Promise.race([p,h])}catch(g){const e=this.activeTimeouts.get(d);if(e&&(clearTimeout(e),this.activeTimeouts.delete(d)),g.message.includes("timeout"))return console.warn("[VibeAnalyzer] 分析超时，降级到本地简单匹配"),await this.analyzeSync(o,c.lang,i,r);throw g}const f=m.stats||m.statistics||{},v={totalChars:Number(f.totalChars)||0,totalMessages:Number(f.totalMessages)||0,ketao_count:Number(f.ketao_count)||0,jiafang_count:Number(f.jiafang_count)||0,tech_stack:f.tech_stack&&"object"==typeof f.tech_stack?f.tech_stack:{},work_days:Number(f.work_days)||0,avg_payload:Number(f.avg_payload)||0},_={};(this.dimensionKeys||Object.keys(m.dimensions||{})).forEach(e=>{var t;const n=null==(t=m.dimensions)?void 0:t[e];_[e]=Number(n)||0});const E=this.generateSemanticFingerprint(_),L={fingerprint:{codeRatio:E.codeRatio||"0%",patienceLevel:E.patienceLevel||"Low Patience",detailLevel:E.detailLevel||"Low Detail",techExploration:E.techExploration||"Low Explore",feedbackDensity:E.feedbackDensity||"0%",compositeScore:Number(E.compositeScore)||0,techDiversity:E.techDiversity||"Low",interactionStyle:E.interactionStyle||"Balanced",balanceIndex:E.balanceIndex||"Slightly Imbalanced"},dimensions:_,stats:v,meta:{ip:c.ip,lang:c.lang,timezone:c.timezone,fingerprint:c.fingerprint,isVpn:c.isVpn,isProxy:c.isProxy,timestamp:(new Date).toISOString(),countryCode:this.countryCode||null,hasRageWord:Boolean((null==(l=m.metadata)?void 0:l.hasRageWord)||m.hasRageWord||!1),personalityType:m.personalityType||"UNKNOWN",vibeIndex:m.vibeIndex||"00000",lpdef:m.lpdef||"L0P0D0E0F0"}},D=this.generateAnalysis(_,L.meta.personalityType),P={...L,personalityName:m.personalityName||"Unknown",roastText:m.roastText||"",personalityType:L.meta.personalityType,vibeIndex:L.meta.vibeIndex,lpdef:L.meta.lpdef,analysis:D,semanticFingerprint:E,statistics:v};try{const e=(Array.isArray(o)?o:[]).filter(e=>{const t=String((null==e?void 0:e.role)||"").toUpperCase();return"USER"===t||"HUMAN"===t||"U"===t||""===t}).map(e=>String((null==e?void 0:e.text)||(null==e?void 0:e.content)||"").trim()).filter(e=>e.length>0).join(" ");P.personalSentenceFingerprint=function(e,{topK:t=15,maxTextLength:n=2e4}={}){const a=String(e||""),s=C(a.length>n?a.slice(0,n):a);if(0===s.length)return[];const o=new Map,i=e=>{const t=String(e||"").trim();t&&o.set(t,(o.get(t)||0)+1)};for(const g of s){const e=String(g);M(e).length>0&&i(e),S(e,{minN:3,maxN:10}).forEach(i),k(e,{minN:3,maxN:7}).forEach(i)}if(0===o.size)return[];const r=Array.from(o.entries()).sort((e,t)=>t[1]-e[1]||(e[0]>t[0]?1:-1)),l=[],c=new Map,d=e=>{const t=l[e],n=I(t.norm,{lang:t.lang});for(const a of n)c.has(a)||c.set(a,[]),c.get(a).push(e)};for(const[g,u]of r){const e=A(g);if(!e)continue;const t=w(g)?"zh":"en",n=I(e,{lang:t});let a=-1;for(const s of n){const n=c.get(s);if(n&&0!==n.length){for(const s of n){const n=l[s];if(n.lang===t&&x(e,n.norm,1)){a=s;break}}if(-1!==a)break}}if(-1===a){const n=new Set(M(g));l.push({canonical:g,norm:e,count:Number(u)||0,tags:n,lang:t}),d(l.length-1)}else{const t=l[a];t.count+=Number(u)||0,M(g).forEach(e=>t.tags.add(e));const n=String(g).length,s=String(t.canonical).length;(Number(u)||0)>0&&n<s&&t.count>0&&(t.canonical=g,t.norm=e)}}return l.sort((e,t)=>t.count-e.count||(e.canonical>t.canonical?1:-1)).slice(0,Math.max(1,Math.min(50,Number(t)||15))).map(e=>({pattern:e.canonical,count:e.count,tags:Array.from(e.tags.values())}))}(e,{topK:15})}catch(u){P.personalSentenceFingerprint=[]}this.analysisResult=P;try{(e=>{try{if("undefined"!=typeof window&&"function"==typeof window.requestIdleCallback)return void window.requestIdleCallback(()=>{try{e()}catch(u){}},{timeout:1200})}catch(u){}try{setTimeout(()=>{try{e()}catch(t){}},0)}catch(t){}})(()=>{try{const i=String(this.countryCode||(null==c?void 0:c.countryCode)||"Global").trim(),r=(Array.isArray(o)?o:[]).filter(e=>{const t=String((null==e?void 0:e.role)||"").toUpperCase();return"USER"===t||"HUMAN"===t||"U"===t||""===t}).map(e=>String((null==e?void 0:e.text)||(null==e?void 0:e.content)||"").trim()).filter(e=>e.length>0).join(" ");try{"undefined"!=typeof window&&(window.__vibe_debug_userText=String(r||""),window.__vibe_debug_extracted_keywords=[],window.__vibe_debug_final_report_list=[],window.__vibe_debug_region_hint=i,window.__vibe_debug_updated_at=(new Date).toISOString());try{localStorage.setItem("vibe_debug_userText",String(r||"")),localStorage.setItem("vibe_debug_extracted_keywords","[]"),localStorage.setItem("vibe_debug_final_report_list","[]"),localStorage.setItem("vibe_debug_region_hint",String(i||"")),localStorage.setItem("vibe_debug_updated_at",(new Date).toISOString())}catch(a){}}catch(u){}if(!r||0===r.length)return;const l=function(e,{max:t=5}={}){const n=String(e||"");if(!n.trim())return[];const a=b(n);if(!a)return[];const s=new Set(["这个","可以","实现","结果","然后","因为","但是","所以","我们","你们","他们","现在","如何","怎么","请问","谢谢","好的","需要","进行","完成","问题","功能","数据","接口","the","a","an","is","are","am","was","were","be","been","being","and","that","this","with","from","into","just","like","very"]),o=a.split(/[。\.！!？\?\n\r；;，,]+/g).map(e=>String(e||"").trim()).filter(e=>e.length>=3),i=new Map,r=9e4;let l=0;const c=new Set(["的","一","是","在","不","了","有","和","人","我","你","他","她","它","们","这","那","就","也","都","很","与","及","而","或","但","又","被","把","给","对","为","从","到","来","去","上","下","中","里","外","前","后","其","之"]),d=e=>{const t=String(e||"").trim();if(!t)return!0;if(s.has(t.toLowerCase()))return!0;if(/^[0-9]+$/.test(t))return!0;if(/^[\s\-_/#:+.]+$/.test(t))return!0;if(/^[\p{P}\p{S}]+$/u.test(t))return!0;if(/^(.)\1+$/.test(t))return!0;if(!/[A-Za-z]/.test(t)&&t.length>=4){const e=Array.from(t);if(e.length>=4&&e.every(e=>c.has(e)))return!0}if(!/[\u4e00-\u9fff]/.test(t)&&/[A-Za-z]/.test(t)){const e=t.toLowerCase().split(/\s+/g).filter(Boolean);if(e.length>0&&e.every(e=>s.has(e)))return!0}return!1};for(const m of o){let e=String(m).replace(/\s+/g," ").trim();if(!e)continue;e.length>220&&(e=e.slice(0,220));const t=e.match(/[\u4e00-\u9fff]{4,}/g)||[];for(const a of t){const e=String(a),t=e.length;for(let n=4;n<=10;n++)if(!(t<n)){for(let a=0;a<=t-n&&!(l++>r);a++){const t=e.slice(a,a+n);d(t)||i.set(t,(i.get(t)||0)+1)}if(l>r)break}if(l>r)break}if(l>r)break;const n=(e.match(/[A-Za-z]+(?:'[A-Za-z]+)?/g)||[]).map(e=>e.toLowerCase()).filter(Boolean);if(n.length>=3)for(let a=3;a<=6;a++)if(!(n.length<a)){for(let e=0;e<=n.length-a&&!(l++>r);e++){const t=n.slice(e,e+a).join(" ");d(t)||i.set(t,(i.get(t)||0)+1)}if(l>r)break}}let g=Array.from(i.entries()).filter(([,e])=>(Number(e)||0)>=1);if(0===g.length)return[];g.sort((e,t)=>t[0].length-e[0].length||t[1]-e[1]||(e[0]>t[0]?1:-1));const u=[];for(const[m,y]of g)u.push({phrase:m,count:Number(y)||0});const h=(e,t,n,a)=>{if(!n||!e)return!1;if(n.length<=e.length)return!1;if(!n.includes(e))return!1;const s=Math.max(1,Math.ceil(.2*t));return Math.abs(a-t)<=s},p=[];for(let m=0;m<u.length;m++){const{phrase:e,count:t}=u[m];let n=!1;for(let a=0;a<u.length;a++){if(m===a)continue;const{phrase:s,count:o}=u[a];if(!(s.length<=e.length)&&h(e,t,s,o)){n=!0;break}}n||p.push([e,t])}return p.sort((e,t)=>t[1]-e[1]||t[0].length-e[0].length||(e[0]>t[0]?1:-1)).slice(0,Math.max(1,Math.min(50,Number(t)||5))).map(([e,t])=>({phrase:e,category:y(e),weight:Number(t)||0}))}(r,{max:20}),d=s(this,e,n).call(this,o),g=new Map,h=e=>{var t;const n=String((null==e?void 0:e.phrase)||"").trim();if(!n||n.length<2||n.length>120)return;const a=String((null==e?void 0:e.category)||"slang").trim()||"slang",s=Math.max(1,Math.min(50,Number(null==e?void 0:e.weight)||1)),o=`${a}:${n}`;g.set(o,{phrase:n,category:a,weight:Math.max(1,Math.min(50,((null==(t=g.get(o))?void 0:t.weight)||0)+s))})};(Array.isArray(l)?l:[]).forEach(h),(Array.isArray(d)?d:[]).forEach(h);const p=Array.from(g.values()).sort((e,t)=>t.weight-e.weight||(e.phrase>t.phrase?1:-1)).slice(0,15);try{"undefined"!=typeof window&&(window.__vibe_debug_userText=r,window.__vibe_debug_extracted_keywords=Array.isArray(l)?l:[],window.__vibe_debug_final_report_list=Array.isArray(p)?p:[],window.__vibe_debug_region_hint=i,window.__vibe_debug_updated_at=(new Date).toISOString());try{localStorage.setItem("vibe_debug_userText",String(r||"")),localStorage.setItem("vibe_debug_extracted_keywords",JSON.stringify(Array.isArray(l)?l:[])),localStorage.setItem("vibe_debug_final_report_list",JSON.stringify(Array.isArray(p)?p:[])),localStorage.setItem("vibe_debug_region_hint",String(i||"")),localStorage.setItem("vibe_debug_updated_at",(new Date).toISOString())}catch(a){}}catch(u){}p.length>0&&s(this,e,t).call(this,p,c,null==P?void 0:P.meta,i)}catch(u){console.warn("[VibeAnalyzer] 关键词提取失败:",(null==u?void 0:u.message)||String(u))}})}catch(u){}return P}catch(g){return console.error("[VibeAnalyzer] Worker 分析失败，使用降级方案:",g),await this.analyzeSync(a,this.lang,i,r)}finally{this.analysisLock=!1;const e=this.activeTimeouts.get(d);e&&(clearTimeout(e),this.activeTimeouts.delete(d))}}async analyzeFromWorker(e,t){var n;const a=(()=>{if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return e;const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim();return e.endsWith("/")?e:e+"/"}}return"https://cursor-clinical-analysis.psterman.workers.dev/"})(),s=a.endsWith("/")?`${a}api/v2/analyze`:`${a}/api/v2/analyze`,o={chatData:e,lang:t.lang,countryCode:this.countryCode||null,context:{ip:t.ip||"0.0.0.0",lang:t.lang||"zh-CN",timezone:t.timezone||"UTC",fingerprint:t.fingerprint||null,vpn:t.isVpn||!1,proxy:t.isProxy||!1},meta:{ip:t.ip||"0.0.0.0",lang:t.lang||"zh-CN",timezone:t.timezone||"UTC",fingerprint:t.fingerprint||null,vpn:t.isVpn||!1,proxy:t.isProxy||!1,timestamp:(new Date).toISOString()}},i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const r=await i.json();if("success"===r.status){const e=r.stats||{};let t={};if(e.tech_stack)if("string"==typeof e.tech_stack)try{t=JSON.parse(e.tech_stack)}catch(l){console.warn("[VibeAnalyzer] tech_stack解析失败:",l),t={}}else"object"==typeof e.tech_stack&&(t=e.tech_stack);const a={totalChars:e.totalChars||0,totalMessages:e.totalMessages||0,ketao_count:e.ketao_count||0,jiafang_count:e.jiafang_count||0,tech_stack:t,work_days:e.work_days||1,avg_payload:e.avg_payload||0,...e},s=(null==(n=r.metadata)?void 0:n.hasRageWord)||e.hasRageWord||!1;return{...r,stats:a,hasRageWord:s,metadata:{...r.metadata||{},hasRageWord:s,stats:a}}}throw new Error(r.error||"Worker 返回错误")}async analyzeSync(e,t,n=null,a=null){t&&(this.lang=t);const s=this.lang,o=this._sanitizeChatData(e);if(this.userMessages=o.filter(e=>"USER"===e.role),0===this.userMessages.length)return this.getDefaultResult(s);const i=this.calculateDimensions(),r=function(e){const t=e=>e<40?"0":e<70?"1":"2";return[t(e.L),t(e.P),t(e.D),(n=e.E,n<5?"0":n<10?"1":"2"),t(e.F)].join("");var n}(i),l=function(e,t="zh-CN"){return"en"===t?`Your interaction style is uniquely yours! This personalized roast for index ${e} is being generated by the backend. Your personality combination is so unique that even our AI needs more time to craft the perfect roast!`:`索引 ${e} 对应的吐槽文案正在由后端生成中，你的人格组合太独特了！`}(r,s),c=this.determinePersonalityType(i),d=function(e,t="zh-CN",n=null){if(n){const e=W(t);if(e[n]&&e[n].name)return e[n].name}return"en"===t?"Digital Personality":`未知人格 ${e}`}(r,s,c),g=this.generateAnalysis(i,c),u=this.generateLPDEF(i);return{personalityType:c,dimensions:i,analysis:g,statistics:this.calculateStatistics(),semanticFingerprint:this.generateSemanticFingerprint(i),vibeIndex:r,roastText:l,personalityName:d,lpdef:u,globalAverage:this.globalAverage||null,metadata:this.analysisMetadata||null,rankData:null}}calculateDimensionsAsync(e){return new Promise((t,n)=>{this.worker&&this.workerReady?(this.pendingTasks.push({payload:{chatData:e,weights:{L1:15,L2:5,L3:1},config:{BASE_SCORE:40,SENSITIVITY:200}},resolve:e=>{const n={L:e.dimensions.L||0,P:e.dimensions.P||0,D:e.dimensions.D||0,E:e.dimensions.E||0,F:e.dimensions.F||0};this.globalAverage=e.globalAverage,this.analysisMetadata=e.metadata,t(n)},reject:n}),this.workerReady&&this.processPendingTasks()):t(this.calculateDimensions())})}generateLPDEF(e){const t=(e,t=[40,70])=>e>=t[1]?"2":e>=t[0]?"1":"0";return`L${t(e.L)}P${t(e.P)}D${t(e.D)}E${n=e.E,n>=10?"2":n>=5?"1":"0"}F${t(e.F)}`;var n}calculateDimensions(){const e={L:0,P:0,D:0,E:0,F:0};let t=0,n=0,a=0,s=0;const o=new Set;let i=0,r=0,l=0,c=0;this.userMessages.forEach(d=>{const g=d.text||"";if(!g||g.length<5)return;t+=g.length,c+=this.countWords(g);const u=this.calculateCodeRatio(g);n+=g.length*u,e.L+=100*u;const h=this.countNegationWords(g);i+=h,e.P+=h;const p=this.splitSentences(g);a+=p.length,p.forEach(e=>{s+=e.length,r+=this.countModifierWords(e)});this.extractTechTerms(g).forEach(e=>o.add(e.toLowerCase())),l+=this.countPoliteWords(g)});const d=n/t||0;e.L=Math.round(100*d);const g=i/this.userMessages.length||0;e.P=Math.max(0,100-Math.round(20*g));const u=s/a||0,h=r/c*100||0;e.D=Math.round(u/10+h),e.E=o.size;const p=l/c*100||0;return e.F=Math.round(10*p),Object.keys(e).forEach(t=>{e[t]=Math.max(0,Math.min(100,e[t]))}),e}calculateCodeRatio(e){let t=0,n=e.length;(e.match(/```[\s\S]*?```/g)||[]).forEach(e=>{t+=e.length});(e.match(/`[^`]+`/g)||[]).forEach(e=>{t+=e.length});let a=0;U.forEach(t=>{const n=e.match(t);n&&(a+=n.length)});const s=t/n,o=Math.min(a/10,.5);return Math.min(s+o,1)}countNegationWords(e){let t=0;const n=e.toLowerCase();return $.chinese.forEach(e=>{const a=new RegExp(e,"g"),s=n.match(a);s&&(t+=s.length)}),$.english.forEach(e=>{const a=new RegExp(`\\b${e}\\b`,"gi"),s=n.match(a);s&&(t+=s.length)}),t}splitSentences(e){return e.split(/[。！？.!?\n]+/).filter(e=>e.trim().length>0).map(e=>e.trim())}countModifierWords(e){let t=0;const n=e.toLowerCase();return R.chinese.forEach(n=>{e.includes(n)&&t++}),R.english.forEach(e=>{new RegExp(`\\b${e}\\b`,"gi").test(n)&&t++}),t}extractTechTerms(e){const t=new Set,n=e.toLowerCase();return Object.keys(B).forEach(e=>{const a=B[e];Array.isArray(a)&&a.forEach(e=>{const a=n.match(e);a&&a.forEach(e=>{const n=e.trim();n&&t.add(n)})})}),Array.from(t)}countPoliteWords(e){let t=0;const n=e.toLowerCase();return N.chinese.forEach(n=>{e.includes(n)&&t++}),N.english.forEach(e=>{new RegExp(`\\b${e}\\b`,"gi").test(n)&&t++}),t}countWords(e){const t=e.match(/[\u4e00-\u9fa5]/g)||[],n=e.match(/\b[a-zA-Z]+\b/g)||[];return t.length+n.length}determinePersonalityType(e){const t=60,n=e.L>=t,a=e.L>=40&&e.L<t,s=e.P>=t,o=e.P>=40&&e.P<t,i=e.D>=t,r=e.D>=40&&e.D<t,l=e.E>=30,c=e.E>=12&&e.E<30,d=e.F>=t,g=[];n?g.push("L"):a?g.push("L-"):g.push("-"),s?g.push("P"):o?g.push("P-"):g.push("-"),i?g.push("D"):r?g.push("D-"):g.push("-"),l?g.push("E"):c?g.push("E-"):g.push("-");const u=g.join("")+(d?"F":"-");return j[u]?u:this.findClosestType(e)}findClosestType(e){let t=1/0,n="L-P-DEF-";return Object.keys(j).forEach(a=>{const s=this.calculateTypeDistance(e,a);s<t&&(t=s,n=a)}),n}calculateTypeDistance(e,t){let n=0;return t.includes("L")&&e.L<60&&(n+=20),t.includes("P")&&e.P<60&&(n+=20),t.includes("D")&&e.D<60&&(n+=20),t.includes("E")&&e.E<10&&(n+=20),!t.endsWith("-")&&e.F<60&&(n+=10),n}generateAnalysis(e,t){const n=this.lang||"zh-CN",a=W(n),s=a[t]||a["L-P-DEF-"],o=this.lang;return{type:t,name:s.name,description:s.description,traits:s.traits,color:s.color,dimensions:{L:{value:e.L,level:this.getDimensionLevel(e.L,"L",o),interpretation:this.getLInterpretation(e.L,o)},P:{value:e.P,level:this.getDimensionLevel(e.P,"P",o),interpretation:this.getPInterpretation(e.P,o)},D:{value:e.D,level:this.getDimensionLevel(e.D,"D",o),interpretation:this.getDInterpretation(e.D,o)},E:{value:e.E,level:this.getDimensionLevel(e.E,"E",o),interpretation:this.getEInterpretation(e.E,o)},F:{value:e.F,level:this.getDimensionLevel(e.F,"F",o),interpretation:this.getFInterpretation(e.F,o)}}}}getDimensionLevel(e,t,n){const a=n||this.lang||"zh-CN",s=T(a)[t];return"E"===t?e>=10?s.high:e>=5?s.mid:s.low:e>=70?s.high:e>=40?s.mid:s.low}getLInterpretation(e,t){const n=t||this.lang||"zh-CN",a=T(n);return e<40?a.L.low:e<70?a.L.mid:a.L.high}getPInterpretation(e,t){const n=t||this.lang||"zh-CN",a=T(n);return e<40?a.P.low:e<70?a.P.mid:a.P.high}getDInterpretation(e,t){const n=t||this.lang||"zh-CN",a=T(n);return e<40?a.D.low:e<70?a.D.mid:a.D.high}getEInterpretation(e,t){const n=t||this.lang||"zh-CN",a=T(n);return e<5?a.E.low:e<10?a.E.mid:a.E.high}getFInterpretation(e,t){const n=t||this.lang||"zh-CN",a=T(n);return e<40?a.F.low:e<70?a.F.mid:a.F.high}generateSemanticFingerprint(e){const t=this.lang||"zh-CN",n="en"===t,a=.25*e.L+.2*e.P+.2*e.D+10*e.E*.15+.2*e.F,s=[e.L,e.P,e.D,e.F,10*e.E],o=s.reduce((e,t)=>e+t,0)/s.length,i=s.reduce((e,t)=>e+Math.pow(t-o,2),0)/s.length,r=Math.sqrt(i),l=Math.max(0,100-r),c=(e,t)=>e>=("E"===t?30:70)?n?"High":"高":e>=("E"===t?12:40)?n?"Med":"中":n?"Low":"低";return{codeRatio:`${Math.round(e.L)}%`,patienceLevel:c(e.P,"P")+(n?" Patience":"耐心"),detailLevel:c(e.D,"D")+(n?" Detail":"细腻"),techExploration:c(e.E,"E")+(n?" Explore":"探索"),feedbackDensity:`${Math.round(e.F)}%`,compositeScore:Math.round(a),techDiversity:e.E>=30?n?"Extreme":"极高":e.E>=12?n?"Moderate":"中等":n?"Low":"较低",interactionStyle:this.calculateInteractionStyle(e,t),balanceIndex:(d=l,d>=80?n?"Highly Balanced":"高度平衡":d>=60?n?"Well Balanced":"较为平衡":d>=40?n?"Slightly Imbalanced":"略有偏重":n?"Severely Imbalanced":"明显偏重")};var d}calculateInteractionStyle(e,t){const n="en"===t,a=[];return e.L>=70&&a.push(n?"Code Driven":"代码驱动"),e.P>=70&&a.push(n?"Gentle":"温和引导"),e.D>=70&&a.push(n?"Detail Oriented":"细节控"),e.E>=30&&a.push(n?"Tech Explore":"技术探索"),e.F>=70&&a.push(n?"Responsive":"积极反馈"),0===a.length?n?"Balanced":"均衡型":a.join(" · ")}calculateInteractionStyle(e,t){const n="en"===t,a=[];return e.L>=70&&a.push(n?"Code Driven":"代码驱动"),e.P>=70&&a.push(n?"Gentle":"温和引导"),e.D>=70&&a.push(n?"Detail Oriented":"细节控"),e.E>=10&&a.push(n?"Tech Explore":"技术探索"),e.F>=70&&a.push(n?"Responsive":"积极反馈"),0===a.length?n?"Balanced":"均衡型":a.join(" · ")}calculateStatistics(){const e=this.userMessages.length,t=this.userMessages.reduce((e,t)=>{var n;return e+((null==(n=t.text)?void 0:n.length)||0)},0),n=t/e||0;return{totalMessages:e,avgMessageLength:Math.round(n),totalChars:t}}async uploadToSupabase(e=null,t=null,n=null){var a,s,o,i,r,l,c,d;let g="";try{if(n){n("en"===this.lang?"Syncing global ranking in background…":"后台同步全球排名中…")}let p=null;if(t&&Array.isArray(t)&&t.length>0?(p=t,console.log("[VibeAnalyzer] ✅ 使用传入的 chatData 参数:",t.length,"条消息")):this.chatData&&Array.isArray(this.chatData)&&this.chatData.length>0?(p=this.chatData,console.log("[VibeAnalyzer] ✅ 使用实例变量 this.chatData:",this.chatData.length,"条消息")):"undefined"!=typeof window&&window.allChatData&&Array.isArray(window.allChatData)&&window.allChatData.length>0?(p=window.allChatData,console.log("[VibeAnalyzer] ✅ 使用全局变量 window.allChatData:",window.allChatData.length,"条消息")):this.userMessages&&Array.isArray(this.userMessages)&&this.userMessages.length>0?(console.warn("[VibeAnalyzer] ⚠️ 未找到原始聊天数据，尝试从 userMessages 构建"),p=this.userMessages.map(e=>({role:"USER",text:e.text||e.content||""})),console.log("[VibeAnalyzer] ✅ 从 userMessages 构建了",p.length,"条消息")):e&&e.originalChatData&&Array.isArray(e.originalChatData)&&e.originalChatData.length>0?(p=e.originalChatData,console.log("[VibeAnalyzer] ✅ 从 vibeResult.originalChatData 提取:",p.length,"条消息")):p=[],!p||!Array.isArray(p)||0===p.length)throw console.error("[VibeAnalyzer] ❌ 所有数据源都失败:",{hasChatDataParam:!!t,hasThisChatData:!!this.chatData,hasWindowAllChatData:"undefined"!=typeof window&&!!window.allChatData,hasUserMessages:!!this.userMessages,userMessagesLength:(null==(a=this.userMessages)?void 0:a.length)||0,hasVibeResult:!!e}),new Error("无法获取原始聊天数据，请确保已调用 analyze 方法或传入 chatData 参数");const m=p.map(e=>({role:e.role||"USER",text:e.text||e.content||""})).filter(e=>e.text&&e.text.trim().length>0);if(0===m.length)throw new Error("聊天数据为空，无法进行分析");const y=e=>{let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=t+((t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24))>>>0;return("00000000"+t.toString(16)).slice(-8)},b=(e,t=64)=>{try{return String(e||"").slice(0,t)}catch{return""}},f=e=>e?String(e).trim().toLowerCase():"",v=()=>{try{const e=localStorage.getItem("user_fingerprint")||localStorage.getItem("fingerprint")||"";return f(e)}catch{return""}},w=((e,t)=>{var n,a;const s=m.length,o=(null==(n=m[0])?void 0:n.text)||"",i=(null==(a=m[m.length-1])?void 0:a.text)||"";let r=0;try{const e=m.slice(0,50),t=m.slice(-50);r=e.reduce((e,t)=>{var n;return e+((null==(n=null==t?void 0:t.text)?void 0:n.length)||0)},0)+t.reduce((e,t)=>{var n;return e+((null==(n=null==t?void 0:t.text)?void 0:n.length)||0)},0)}catch{r=0}const l=f(e)||v()||"no_fp",c=["v2","lang="+String(t||""),"fp="+l,"msg="+s,"head="+b(o,96),"tail="+b(i,96),"sampleLen="+String(r)].join("|");return y(c)})((null==(s=null==e?void 0:e.meta)?void 0:s.fingerprint)||(null==e?void 0:e.fingerprint)||(null==(o=null==e?void 0:e.context)?void 0:o.fingerprint)||null,this.lang||"zh-CN"),C=globalThis.__vibeUploadInflightBySig||(globalThis.__vibeUploadInflightBySig=new Map),S=`__vibeUploadCache_v2_${w}`;try{const e=localStorage.getItem(S);if(e){const t=JSON.parse(e),n=Number((null==t?void 0:t.ts)||0),a=(null==t?void 0:t.result)||null;if(n>0&&Date.now()-n<6e5&&a&&"object"==typeof a)return console.log("[VibeAnalyzer] 🧠 命中上传缓存，跳过重复上报:",{sig:w}),a}}catch{}if(C.has(w))return console.log("[VibeAnalyzer] ⏳ 检测到同签名上报进行中，复用 in-flight 请求:",{sig:w}),await C.get(w);const k=(()=>{if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return e;const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim();return e.endsWith("/")?e:e+"/"}}return"https://cursor-clinical-analysis.psterman.workers.dev/"})();let M=null;if(e)if(e.stats)M=e.stats;else if(e.statistics){let t={};if(e.statistics.tech_stack)if("string"==typeof e.statistics.tech_stack)try{t=JSON.parse(e.statistics.tech_stack)}catch(u){console.warn("[VibeAnalyzer] tech_stack解析失败:",u),t={}}else"object"==typeof e.statistics.tech_stack&&(t=e.statistics.tech_stack);M={totalChars:e.statistics.totalChars||e.statistics.totalUserChars||0,totalMessages:e.statistics.totalMessages||e.statistics.userMessages||0,ketao_count:e.statistics.ketao_count||e.statistics.qingCount||0,jiafang_count:e.statistics.jiafang_count||e.statistics.buCount||0,tech_stack:t,work_days:e.statistics.work_days||e.statistics.usageDays||1,avg_payload:e.statistics.avg_payload||0}}M||(M={totalChars:0,totalMessages:0,ketao_count:0,jiafang_count:0,tech_stack:{},work_days:1,avg_payload:0});const x=(null==(i=null==e?void 0:e.meta)?void 0:i.fingerprint)||(null==e?void 0:e.fingerprint)||null,A=(null==e?void 0:e.dimensions)||{};let I=(null==e?void 0:e.meta)||{};if(!I.ip||"0.0.0.0"===I.ip){const t=(null==e?void 0:e.context)||{};I={ip:t.ip||"0.0.0.0",lang:t.lang||this.lang||"zh-CN",timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",fingerprint:t.fingerprint||x||null,vpn:t.isVpn||t.vpn||!1,proxy:t.isProxy||t.proxy||!1,timestamp:(new Date).toISOString()}}const _={chatData:m,lang:this.lang||"zh-CN",countryCode:this.countryCode||null,fingerprint:x,dimensions:A,stats:M,meta:I,snapshot_country:(()=>{try{const e=String(localStorage.getItem("anchored_country")||"").trim().toUpperCase()||String(localStorage.getItem("selected_country")||"").trim().toUpperCase();return/^[A-Z]{2}$/.test(e)?e:null}catch{return null}})(),current_location:(()=>{try{const e=String(localStorage.getItem("anchored_country")||"").trim().toUpperCase()||String(localStorage.getItem("selected_country")||"").trim().toUpperCase();return/^[A-Z]{2}$/.test(e)?e:null}catch{return null}})(),location_weight:(()=>{try{const e=String(localStorage.getItem("country_switch_to")||"").trim().toUpperCase(),t=Number(localStorage.getItem("country_switch_ts")||0),n=String(localStorage.getItem("anchored_country")||"").trim().toUpperCase()||String(localStorage.getItem("selected_country")||"").trim().toUpperCase();if(e&&n&&e===n&&Number.isFinite(t)&&t>0){const e=216e5;return Math.max(0,Math.min(1,(Date.now()-t)/e))}return 1}catch{return 1}})(),location_switched_at:(()=>{try{const e=Number(localStorage.getItem("country_switch_ts")||0);return Number.isFinite(e)&&e>0?new Date(e).toISOString():null}catch{return null}})()};console.log("[VibeAnalyzer] 发送原始聊天数据到 /api/v2/analyze:",{messageCount:m.length,lang:_.lang,sampleMessage:m[0],payloadFormat:'严格遵循 { chatData: [...], lang: "zh-CN", stats: {...} } 格式',hasStats:!!_.stats,statsKeys:_.stats?Object.keys(_.stats):[]}),g=k.endsWith("/")?`${k}api/v2/analyze`:`${k}/api/v2/analyze`;const E=(async()=>{const e=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(_)});if(!e.ok){const t=await e.text().catch(()=>"无法读取错误信息");throw new Error(`HTTP error! status: ${e.status}, error: ${t}`)}const t=await e.json();console.log("[VibeAnalyzer] 后端返回数据:",t);try{localStorage.setItem(S,JSON.stringify({ts:Date.now(),result:t}))}catch{}return t})();let L;C.set(w,E);try{L=await E}finally{try{C.delete(w)}catch{}}if(L.global_stats)try{localStorage.setItem("vibe_global_stats",JSON.stringify(L.global_stats)),console.log("[VibeAnalyzer] ✅ 已保存 global_stats 到本地:",L.global_stats)}catch(h){console.warn("[VibeAnalyzer] 保存 global_stats 失败:",h)}if("success"===L.status){const t=L.dimensions||{},n=L.roastText||"",a=L.personalityName||"",s=L.vibeIndex||"00000",o=L.personalityType||"UNKNOWN",i=L.lpdef||"";if(this.analysisResult){if(this.analysisResult.dimensions=t,this.analysisResult.roastText=n,this.analysisResult.personalityName=a,this.analysisResult.vibeIndex=s,this.analysisResult.personalityType=o,this.analysisResult.lpdef=i,L.stats||L.statistics){const e=L.stats||L.statistics||{};let t={};if(e.tech_stack)if("string"==typeof e.tech_stack)try{t=JSON.parse(e.tech_stack)}catch(u){console.warn("[VibeAnalyzer] tech_stack解析失败:",u),t={}}else"object"==typeof e.tech_stack&&(t=e.tech_stack);const n={totalChars:e.totalChars||0,totalMessages:e.totalMessages||0,ketao_count:e.ketao_count||0,jiafang_count:e.jiafang_count||0,tech_stack:t,work_days:e.work_days||1,avg_payload:e.avg_payload||0,...e};this.analysisResult.statistics={...this.analysisResult.statistics,...n},this.analysisResult.metadata||(this.analysisResult.metadata={}),this.analysisResult.metadata.stats=n}L.countryAverage&&(this.countryAverage=L.countryAverage,this.analysisResult.countryAverage=L.countryAverage),L.globalAverage&&(this.globalAverage=L.globalAverage,this.analysisResult.globalAverage=L.globalAverage),console.log("[VibeAnalyzer] ✅ 已同步后端精准数据到实例状态:",{dimensions:t,roastText:n.substring(0,50)+"...",personalityName:a,vibeIndex:s})}const g=L.statistics||{},h=L.totalUsers||L.value||L.total||L.count||0,p=L.rankPercent??L.ranking??0,m=L.ranks||null,y=L.globalAverage||L.global_average||null;this.analysisResult&&(L.analysis&&(this.analysisResult.analysis=L.analysis),L.semanticFingerprint&&(this.analysisResult.semanticFingerprint=L.semanticFingerprint),L.stats&&(this.analysisResult.stats=L.stats),L.fingerprint&&(this.analysisResult.fingerprint=L.fingerprint));const b={dimensions:t,roastText:n,personalityName:a,vibeIndex:s,personalityType:o,lpdef:i,analysis:L.analysis||(null==e?void 0:e.analysis)||(null==(r=this.analysisResult)?void 0:r.analysis)||null,semanticFingerprint:L.semanticFingerprint||(null==e?void 0:e.semanticFingerprint)||(null==(l=this.analysisResult)?void 0:l.semanticFingerprint)||null,stats:L.stats||(null==(c=L.data)?void 0:c.stats)||null,fingerprint:L.fingerprint||null,claim_token:L.claim_token||null,personality:L.personality||null,detailedStats:(null==(d=L.personality)?void 0:d.detailedStats)||L.detailedStats||null,rankPercent:Number(p),ranking:Number(p),totalUsers:Number(h),defeated:L.defeated??0,actualRank:L.actualRank??0,statistics:g,metadata:L.metadata||null};return m&&(b.ranks=m),y&&(b.globalAverage=y),b}throw console.warn("[VibeAnalyzer] 后端返回错误:",L),new Error(L.error||L.message||"后端返回错误状态")}catch(p){return console.error("[VibeAnalyzer] 上传排名过程出错:",{message:p.message,name:p.name,isNetworkError:p.message.includes("fetch")||p.message.includes("network")||p.message.includes("CORS"),isTimeout:p.message.includes("timeout")||p.message.includes("Timeout")}),{error:p.message,errorType:p.name,isNetworkError:p.message.includes("fetch")||p.message.includes("network")||p.message.includes("CORS"),isTimeout:p.message.includes("timeout")||p.message.includes("Timeout"),timestamp:(new Date).toISOString(),url:g||"unknown",rankPercent:0,totalUsers:0}}}getDefaultResultWithContext(e={}){const t=e.lang||this.lang||"zh-CN";"en"===t||t.startsWith("en");const n={};return(this.dimensionKeys||["L","P","D","E","F"]).forEach(e=>{n[e]=0}),{fingerprint:{codeRatio:"0%",patienceLevel:"Low Patience",detailLevel:"Low Detail",techExploration:"Low Explore",feedbackDensity:"0%",compositeScore:0,techDiversity:"Low",interactionStyle:"Balanced",balanceIndex:"Slightly Imbalanced"},dimensions:n,stats:{totalChars:0,totalMessages:0,ketao_count:0,jiafang_count:0,tech_stack:{},work_days:0,avg_payload:0},meta:{ip:e.ip||"0.0.0.0",lang:t,timezone:e.timezone||"UTC",fingerprint:e.fingerprint||null,isVpn:Boolean(e.isVpn||!1),isProxy:Boolean(e.isProxy||!1),timestamp:(new Date).toISOString(),countryCode:this.countryCode||null,hasRageWord:!1,personalityType:"UNKNOWN",vibeIndex:"00000",lpdef:"L0P0D0E0F0"}}}getDefaultResult(e="zh-CN"){return this.getDefaultResultWithContext({lang:e})}setCountryContext(e,t=null,n={}){this.countryCode=e,this.countryAverage=t,this.countryContext={...this.countryContext,...n,countryCode:e,updatedAt:(new Date).toISOString()},console.log(`[VibeAnalyzer] 国家上下文已设置: ${e}`,{countryAverage:t,contextKeys:Object.keys(n)})}calculateDeviationFromCountry(e){if(!this.countryAverage||!e)return null;const t={},n=this.dimensionKeys||Object.keys(e);let a=0,s=0;n.forEach(n=>{const o=e[n]||0,i=this.countryAverage[n]||0;if(i>0){const e=(o-i)/i*100;t[n]={personal:o,country:i,deviation:e.toFixed(2),deviationPercent:`${e>=0?"+":""}${e.toFixed(2)}%`},a+=Math.abs(e),s++}});const o=s>0?a/s:0;return{deviations:t,overallDeviation:o.toFixed(2),interpretation:this.interpretDeviation(o)}}interpretDeviation(e){const t=parseFloat(e);return t<5?"与全国平均水平非常接近":t<15?"略高于/低于全国平均水平":t<30?"明显高于/低于全国平均水平":"显著偏离全国平均水平"}destroy(){this.messageChannels.forEach(e=>{try{e.port1.close(),e.port2.close()}catch(t){console.warn("[VibeAnalyzer] 清理MessageChannel失败:",t)}}),this.messageChannels.clear(),this.worker&&(this._messageHandler&&(this.worker.removeEventListener("message",this._messageHandler),this._messageHandler=null),this.worker.terminate(),this.worker=null,this.workerReady=!1),this.activeTimeouts.forEach(e=>{clearTimeout(e)}),this.activeTimeouts.clear(),this.analysisLock=!1,this.sparseDimensions.clear(),console.log("[VibeAnalyzer] 资源清理完成")}}e=new WeakSet,t=function(e,t,n,a){try{const s=Array.isArray(e)?e:[];if(0===s.length)return;const o=String(a||(null==t?void 0:t.countryCode)||"Global").trim()||"Global",i=(null==t?void 0:t.fingerprint)||(null==n?void 0:n.fingerprint)||null;_(s,{fingerprint:i,timestamp:(null==n?void 0:n.timestamp)||(new Date).toISOString(),region:o})}catch(s){console.warn("[VibeAnalyzer] 上报关键词失败:",(null==s?void 0:s.message)||String(s))}},n=function(e){const t=(Array.isArray(e)?e:[]).map(e=>String((null==e?void 0:e.text)||(null==e?void 0:e.content)||"")).join("\n");if(!t)return[];const n=[],a=t.match(/```[\s\S]*?```/g)||[];for(const r of a)n.push(r.replace(/```/g," "));const s=t.match(/`[^`]{6,200}`/g)||[];for(const r of s)n.push(r.replace(/`/g," "));const o=n.join("\n");if(!o.trim())return[];const i=new Map;for(const r of p)o.includes(r)&&i.set(r,{phrase:r,category:"merit",weight:1});for(const r of m)o.includes(r)&&i.set(r,{phrase:r,category:"slang",weight:1});return Array.from(i.values())};const V={badges:{ketao_count:{label:{"zh-CN":"赛博磕头",en:"Ketao Count"},threshold:10,className:"tag-ketao",icon:"🙏"},jiafang_count:{label:{"zh-CN":"甲方上身",en:"Jiafang Index"},threshold:5,className:"tag-jiafang",icon:"💼"},tease_count:{label:{"zh-CN":"调戏AI",en:"Tease AI"},threshold:3,className:"tag-tease",icon:"😄"},nonsense_count:{label:{"zh-CN":"废话输出",en:"Nonsense Output"},threshold:20,className:"tag-nonsense",icon:"💬"},abuse_value:{label:{"zh-CN":"受虐值",en:"Abuse Value"},threshold:5,className:"tag-abuse",icon:"😤"}},global:{total_users:{label:{"zh-CN":"诊断总人数",en:"Total Users"},key:"total_count",className:"global-total-users"},global_chars:{label:{"zh-CN":"累计吐槽字数",en:"Global Chars"},key:"total_chars",className:"global-chars"},global_avg_payload:{label:{"zh-CN":"全网平均篇幅",en:"Global Avg Payload"},key:"avg_payload",className:"global-avg-payload"},geo_hotmap_summary:{label:{"zh-CN":"地理位置分布",en:"Geographic Distribution"},key:"geo_hotmap_summary",className:"global-geo-summary"},answer_text:{label:{"zh-CN":"今日答案之书",en:"Today's Answer Book"},key:"answer_text",className:"global-answer-text"}}};function q(e="zh-CN"){const t=new z(e);return console.log("[Main] 创建 VibeCodingerAnalyzer 实例，环境:",{basePath:window.BASE_PATH||"(空)",isGitHubPages:window.location.hostname.includes("github.io"),workerConfig:window.WORKER_CONFIG}),t}if(!window.BASE_PATH){const e=window.location.pathname,t=window.location.hostname,n=t.includes("github.io"),a="localhost"===t||"127.0.0.1"===t;let s="";if(a)s="";else if(n){const t=e.split("/").filter(e=>e&&"index.html"!==e);s=t.length>0?"/"+t[0]:"",console.log("[Main] GitHub Pages 路径检测:",{pathname:e,pathParts:t,detectedBasePath:s})}else{const t=e.split("/").filter(e=>e&&"index.html"!==e);s=t.length>0?"/"+t[0]:""}s&&"/"!==s&&s.endsWith("/")&&(s=s.slice(0,-1)),window.BASE_PATH=s,console.log("[Main] 检测到基础路径:",window.BASE_PATH,{hostname:t,pathname:e,isGitHubPages:n,isLocalhost:a})}window.WORKER_CONFIG={getWorkerUrl:function(e){const t=window.BASE_PATH||"";if(t){const n=`${t}/src/${e}`;return console.log("[Main] 构建 Worker URL (GitHub Pages):",n),n}{const t=`./src/${e}`;return console.log("[Main] 构建 Worker URL (本地):",t),t}},basePath:window.BASE_PATH||"",workerPath:window.BASE_PATH?`${window.BASE_PATH}/src/vibeAnalyzerWorker.js`:"./src/vibeAnalyzerWorker.js"};class H{constructor(){this.parser=null,this.analyzer=null,this.allChatData=[],this.globalStats=null,this.vibeResult=null,this.globalStatsCache=null}async uploadUserStats(e,t){console.log("[VibeCodingApp] uploadUserStats: 实际上传由 uploadToSupabase 方法处理")}async generateContext(){let e;try{e=await async function(){const e="user_fingerprint",t="cursor_clinical_fingerprint",n="vibe_fp";try{let o=localStorage.getItem(e)||localStorage.getItem(t);if(!o||o.length<16){const s=localStorage.getItem(n);if(s&&s.length>=8){if(16===s.length){const e=new Uint8Array(8);crypto.getRandomValues(e);o=s+Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}else o=s;try{localStorage.setItem(e,o),localStorage.setItem(t,o),console.log("[Main] ✅ 已从旧 key 迁移 fingerprint:",o)}catch(a){console.warn("[Main] ⚠️ 指纹迁移失败，但继续使用旧指纹:",a)}}}if(!o||o.length<16){const n=new Uint8Array(16);crypto.getRandomValues(n);const a=Array.from(n).map(e=>e.toString(16).padStart(2,"0")).join(""),i={userAgent:navigator.userAgent||"",language:navigator.language||"",platform:navigator.platform||"",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"},r=a+JSON.stringify(i),l=(new TextEncoder).encode(r),c=await crypto.subtle.digest("SHA-256",l);o=Array.from(new Uint8Array(c)).map(e=>e.toString(16).padStart(2,"0")).join("").substring(0,32);try{localStorage.setItem(e,o),localStorage.setItem(t,o),console.log("[Main] ✅ 已生成并持久化32位 fingerprint:",o)}catch(s){console.warn("[Main] ⚠️ localStorage 写入失败，但继续使用生成的指纹:",s)}}else{console.log("[Main] ✅ 从 localStorage 读取已存在的 fingerprint:",o);try{localStorage.getItem(e)||localStorage.setItem(e,o),localStorage.getItem(t)||localStorage.setItem(t,o)}catch{}}return o}catch(o){console.warn("[Main] ⚠️ fingerprint 生成失败，使用降级方案:",o);const n=navigator.userAgent||"",a=`fp_${Date.now()}_${Math.random().toString(36).substr(2,9)}_${n.substring(0,20)}`,s=(new TextEncoder).encode(a);try{const n=await crypto.subtle.digest("SHA-256",s),a=Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("").substring(0,32);try{localStorage.setItem(e,a),localStorage.setItem(t,a)}catch(i){}return a}catch(r){const n=btoa(a).replace(/[^a-zA-Z0-9]/g,"").substring(0,32);try{localStorage.setItem(e,n),localStorage.setItem(t,n)}catch(i){}return n}}}()}catch(i){console.warn("[VibeCodingApp] 异步指纹生成失败，使用同步降级:",i),e=function(){const e="user_fingerprint",t="cursor_clinical_fingerprint",n="vibe_fp";try{let s=localStorage.getItem(e)||localStorage.getItem(t);if(!s||s.length<16){const o=localStorage.getItem(n);if(o&&o.length>=8){s=16===o.length?o+o:o;try{localStorage.setItem(e,s),localStorage.setItem(t,s)}catch(a){}}}if(!s||s.length<16){const n=new Uint8Array(16);crypto.getRandomValues(n);const o=Array.from(n).map(e=>e.toString(16).padStart(2,"0")).join(""),i=(navigator.userAgent||"")+(navigator.language||"")+(navigator.platform||"");s=btoa(o+i).replace(/[^a-zA-Z0-9]/g,"").substring(0,32);try{localStorage.setItem(e,s),localStorage.setItem(t,s)}catch(a){}}return s}catch(i){const s=`fp_${Date.now()}_${Math.random().toString(36).substr(2,9)}`.substring(0,32);try{localStorage.setItem(e,s),localStorage.setItem(t,s)}catch(a){}return s}}()}let t="UTC";try{t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch(i){console.warn("[VibeCodingApp] timezone 获取失败:",i)}const n=ne();let a=!1;try{const e=(new Date).getHours(),s=e=>({"Asia/Shanghai":8,"Asia/Hong_Kong":8,"Asia/Tokyo":9,"America/New_York":-5,"America/Los_Angeles":-8,"Europe/London":0,UTC:0}[e]||0),o=(e+s(t))%24,i=Math.abs(e-o),r=i>2&&i<22,l=-(new Date).getTimezoneOffset()/60,c=s(t),d=Math.abs(l-c),g=d>1,u=["UTC","America/New_York","Europe/London"].includes(t)&&n.startsWith("zh"),h="UTC"===t&&!n.startsWith("en");a=r||g||u||h,a&&console.log("[VibeCodingApp] ⚠️ VPN 检测触发:",{timezone:t,localHour:e,expectedHour:o,hourDiff:i,isLargeTimeDiff:r,isTimezoneOffsetMismatch:g,isTimezoneMismatch:u,isUtcWithNonEnglish:h,currentTimezoneOffsetHours:l,expectedOffsetHours:c,offsetDiff:d})}catch(i){console.warn("[VibeCodingApp] VPN 检测失败:",i)}let s="0.0.0.0";try{if("undefined"!=typeof RTCPeerConnection){const e=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});e.createDataChannel(""),e.onicecandidate=t=>{if(t.candidate){const n=t.candidate.candidate.match(/([0-9]{1,3}\.){3}[0-9]{1,3}/);!n||n[0].startsWith("127.")||n[0].startsWith("192.168.")||n[0].startsWith("10.")||(s=n[0],console.log("[VibeCodingApp] ✅ WebRTC 探测到 IP:",s),e.close())}},e.createOffer().then(t=>e.setLocalDescription(t)).catch(t=>{console.warn("[VibeCodingApp] WebRTC createOffer 失败:",t),e.close()}),setTimeout(()=>{e.close(),"0.0.0.0"===s&&console.log("[VibeCodingApp] WebRTC 探测超时，使用默认 IP（后端将获取真实 IP）")},2e3)}}catch(i){console.warn("[VibeCodingApp] WebRTC 探测失败（使用默认值）:",i)}const o={fingerprint:e,timezone:t,lang:n,isVpn:a,isProxy:!1,ip:s};return console.log("[VibeCodingApp] ✅ 环境上下文已生成:",o),o}async init(){console.log("[VibeCodingApp] 初始化应用..."),this.parser||(this.parser=new l,await this.parser.init()),this.analyzer||(this.analyzer=q()),console.log("[VibeCodingApp] 初始化完成")}renderBehaviorTags(e,t="behavior-tags-container"){if(!e)return void console.warn("[VibeCodingApp] renderBehaviorTags: stats 不存在");const n=document.getElementById(t)||document.querySelector(`#${t}`);if(!n)return void console.warn(`[VibeCodingApp] renderBehaviorTags: 容器 ${t} 未找到`);const a=ne(),s=V.badges,o=Object.entries(s).filter(([t,n])=>(e[t]||0)>=n.threshold).map(([t,n])=>{const s=e[t]||0,o=n.label[a]||n.label["zh-CN"];return`\n          <span class="vibe-tag ${n.className}" data-v6-key="${t}" data-v6-value="${s}">\n            ${n.icon?`${n.icon} `:""}${Be(o)}\n          </span>\n        `});e.style_label&&o.push(`\n        <span class="vibe-tag tag-style-label" data-v6-key="style_label" style="font-weight: bold; font-size: 1.1em; background: var(--accent-terminal); color: white;">\n          ${Be(e.style_label)}\n        </span>\n      `),n.innerHTML=o.length>0?o.join(""):`<div class="vibe-tag-empty">${"en"===a?"No behavior tags yet":"暂无行为标签"}</div>`,console.log("[VibeCodingApp] ✅ renderBehaviorTags 完成，生成",o.length,"个标签")}updateV6UI(e){if(!e||!e.detailedStats||!Array.isArray(e.detailedStats))return void console.warn("[VibeCodingApp] updateV6UI: detailedStats 无效或不存在");const t=e.detailedStats;let n=0;const a=document.querySelectorAll("[data-v6-dim]");console.log("[VibeCodingApp] updateV6UI: 找到的维度容器:",Array.from(a).map(e=>({dimension:e.getAttribute("data-v6-dim"),hasRankLabel:!!e.querySelector(".rank-label"),hasRoastText:!!e.querySelector(".roast-text")}))),t.forEach(e=>{const{dimension:t,label:a,roast:s,score:o}=e;if(!t)return void console.warn("[VibeCodingApp] updateV6UI: 维度标识缺失",e);const i=document.querySelector(`[data-v6-dim="${t}"]`);if(!i){console.warn(`[VibeCodingApp] updateV6UI: 未找到维度 ${t} 的容器`);const e=Array.from(document.querySelectorAll("[data-v6-dim]")).map(e=>e.getAttribute("data-v6-dim"));return void console.warn("[VibeCodingApp] updateV6UI: 可用的维度容器:",e)}const r=i.querySelector(".rank-label");if(r)a&&"未知"!==a?(r.textContent=a,n++,console.log(`[VibeCodingApp] updateV6UI: 维度 ${t} 的称号已更新为 "${a}"`)):console.log(`[VibeCodingApp] updateV6UI: 维度 ${t} 的 label 为"未知"，保留前端降级文案`);else{console.warn(`[VibeCodingApp] updateV6UI: 维度 ${t} 的容器中未找到 .rank-label 元素`);const e=Array.from(i.querySelectorAll("*")).map(e=>({tag:e.tagName,classes:e.className,id:e.id}));console.warn("[VibeCodingApp] updateV6UI: 容器内的元素:",e)}const l=i.querySelector(".roast-text");if(l?s&&"暂无吐槽文案"!==s?(l.textContent=s,n++,console.log(`[VibeCodingApp] updateV6UI: 维度 ${t} 的吐槽文案已更新`)):console.log(`[VibeCodingApp] updateV6UI: 维度 ${t} 的 roast 为空，保留前端降级文案`):console.warn(`[VibeCodingApp] updateV6UI: 维度 ${t} 的容器中未找到 .roast-text 元素`),null!=o){const e=i.querySelector(".dimension-value");e&&(e.textContent=Math.round(o));const t=i.querySelector(".dimension-bar");if(t){const e=Math.min(100,Math.max(0,o));t.style.width=`${e}%`}}}),console.log("[VibeCodingApp] ✅ updateV6UI 完成，更新了",n,"个维度元素")}syncGlobalStats(e){if(!e||"object"!=typeof e)return void console.warn("[VibeCodingApp] syncGlobalStats: globalStats 无效");const t=document.querySelectorAll("[data-v6-key]");let n=0;t.forEach((t,a)=>{const s=t.getAttribute("data-v6-key");if(!s)return;let o=null;const i=V.global[s];o=i&&i.key?e[i.key]:e[s],null!=o?(t.removeAttribute("data-skeleton"),t.style.opacity="0",t.style.transition="opacity 0.5s ease-in-out",t.textContent="number"==typeof o?o.toLocaleString():Be(String(o)),setTimeout(()=>{requestAnimationFrame(()=>{t.style.opacity="1"})},50*a),n++):t.textContent&&""!==t.textContent.trim()&&"0"!==t.textContent||(t.setAttribute("data-skeleton","true"),t.style.opacity="0.3",t.textContent&&""!==t.textContent.trim()||(t.textContent="..."))}),console.log("[VibeCodingApp] ✅ syncGlobalStats 完成，更新了",n,"个元素（带渐入动画）")}updateUIWithStats(e,t=null){if(!e||!e.stats)return void console.warn("[VibeCodingApp] updateUIWithStats: result.stats 不存在");const n=e.stats,a=ne(),s={badgeGrid:{ketao_count:{label:"en"===a?"Ketao Count":"赛博磕头",value:n.ketao_count||0},jiafang_count:{label:"en"===a?"Jiafang Index":"甲方指数",value:n.jiafang_count||0},abuse_value:{label:"en"===a?"Abuse Value":"受虐值",value:n.abuse_value||0},work_days:{label:"en"===a?"Work Days":"上岗天数",value:n.work_days||1},tease_count:{label:"en"===a?"Tease Count":"调戏AI",value:n.tease_count||0},nonsense_count:{label:"en"===a?"Nonsense Count":"废话输出",value:n.nonsense_count||0}},fingerprintBars:{balance_score:{label:"en"===a?"Personality Stability":"人格稳定性",value:n.balance_score||0,max:100},code_ratio:{label:"en"===a?"Code Ratio":"代码占比",value:100*(n.code_ratio||0),max:100},feedback_density:{label:"en"===a?"Feedback Density":"反馈密度",value:n.feedback_density||0,max:50},diversity_score:{label:"en"===a?"Tech Diversity":"技术多样性",value:n.diversity_score||0,max:20}}},o=document.getElementById("badge-grid")||document.querySelector(".badge-grid");if(o){const e=Object.entries(s.badgeGrid).filter(([e,t])=>t.value>0).map(([e,t])=>`\n          <div class="badge-item">\n            <span class="badge-label">${t.label}</span>\n            <span class="badge-value">${t.value}</span>\n          </div>\n        `).join("");o.innerHTML=e||`<div class="badge-empty">${"en"===a?"No badges yet":"暂无徽章"}</div>`}const i=document.getElementById("fingerprint-bars")||document.querySelector(".fingerprint-bars");if(i){const e=Object.entries(s.fingerprintBars).map(([e,t])=>{const n=Math.min(100,t.value/t.max*100);return`\n            <div class="fingerprint-bar-item">\n              <div class="bar-header">\n                <span class="bar-label">${t.label}</span>\n                <span class="bar-value">${t.value.toFixed(1)}${"code_ratio"===e?"%":""}</span>\n              </div>\n              <div class="bar-container">\n                <div class="bar-fill" style="width: ${n}%; background: var(--accent-terminal);"></div>\n              </div>\n            </div>\n          `}).join("");i.innerHTML=e}this.renderBehaviorTags(n,"behavior-tags-container"),t&&this.syncGlobalStats(t),console.log("[VibeCodingApp] ✅ AutoMappingEngine 已完成 UI 更新")}async analyzeFile(e,t=null,n=null,a={}){var s;if(!this.analyzer)throw new Error("分析器未初始化，请先调用 init()");const o=ne();this.analyzer.setLanguage(o);const i=await this.generateContext(),r=await this.analyzer.analyze(e,i,null,n);console.log("[VibeCodingApp] analyze 完成:",r),r&&!r.stats&&(r.statistics?r.stats={totalChars:r.statistics.totalChars||r.statistics.totalUserChars||0,totalMessages:r.statistics.totalMessages||r.statistics.userMessages||0,ketao_count:r.statistics.ketao_count||r.statistics.qingCount||0,jiafang_count:r.statistics.jiafang_count||r.statistics.buCount||0,abuse_value:r.statistics.abuse_value||r.statistics.abuseValue||0,tech_stack:r.statistics.tech_stack||{},work_days:r.statistics.work_days||r.statistics.usageDays||1,avg_payload:r.statistics.avg_payload||0,balance_score:r.statistics.balance_score||0,style_label:r.statistics.style_label||"标准型",blackword_hits:r.statistics.blackword_hits||{},...r.statistics}:r.stats={totalChars:0,totalMessages:0,ketao_count:0,jiafang_count:0,abuse_value:0,tech_stack:{},work_days:1,avg_payload:0,balance_score:0,style_label:"标准型",blackword_hits:{}}),this.updateUIWithStats(r,this.globalStatsCache);const l=!1!==(null==a?void 0:a.deferGlobalSync),c=async()=>{var a,s,o,i;if(!r||!r.statistics)return;const l=r.statistics;l.qingCount=(null==t?void 0:t.qingCount)||(null==J?void 0:J.qingCount)||0,l.buCount=(null==t?void 0:t.buCount)||(null==J?void 0:J.buCount)||0,l.usageDays=(null==t?void 0:t.usageDays)||(null==J?void 0:J.usageDays)||1,l.totalUserChars=l.totalUserChars||l.totalChars||0,l.userMessages=l.userMessages||l.totalMessages||0;try{const t=await this.analyzer.uploadToSupabase(r,e,n);try{(null==t?void 0:t.claim_token)&&localStorage.setItem("vibe_claim_token",t.claim_token)}catch{}try{if("undefined"!=typeof window){const e=Number((null==t?void 0:t.totalUsers)||(null==(a=null==r?void 0:r.rankData)?void 0:a.totalUsers)||0)||0,n=(null==t?void 0:t.ranks)||null,s=t=>{if(null==t||e<=0)return null;const n=Number(t);if(Number.isNaN(n))return null;if(n<=0)return e;const a=Math.floor(e*(n/100));return Math.max(1,e-a)};if(e>0&&n){if(window.userRankings={qingCount:{rank:s(n.ketaoRank),total:e},buCount:{rank:s(n.jiafangRank),total:e},userMessages:{rank:s(n.messageRank),total:e},totalUserChars:{rank:s(n.charRank),total:e},avgUserMessageLength:{rank:s(n.avgRank),total:e},usageDays:{rank:s(n.daysRank),total:e}},"function"==typeof window.updateRankingBadges){const e=localStorage.getItem("appLanguage")||"zh-CN";Promise.resolve(window.updateRankingBadges(window.userRankings,e)).catch(()=>{})}try{window.dispatchEvent(new CustomEvent("userRankingsUpdated",{detail:window.userRankings}))}catch{}}}}catch{}try{const e=localStorage.getItem("vibe_global_stats");e?(this.globalStatsCache=JSON.parse(e),console.log("[VibeCodingApp] ✅ 已加载 global_stats:",this.globalStatsCache),this.updateUIWithStats(r,this.globalStatsCache),this.syncGlobalStats(this.globalStatsCache)):this.updateUIWithStats(r,null)}catch(c){console.warn("[VibeCodingApp] 读取 global_stats 失败:",c),this.updateUIWithStats(r,null)}if(t&&t.globalAverage){const e=t.globalAverage;50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?console.warn("[VibeCodingApp] ⚠️ uploadToSupabase 返回的全局平均值是默认值，忽略"):(Q=e,X=!0,console.log("[VibeCodingApp] ✅ 从 uploadToSupabase 获取到全局平均值:",Q))}t&&void 0!==t.rankPercent?(l.rankPercent=t.rankPercent,l.totalUsers=t.totalUsers,r.rankData||(r.rankData={}),r.rankData.rankPercent=t.rankPercent,r.rankData.totalUsers=t.totalUsers,t.ranks&&(r.rankData.ranks=t.ranks,console.log("[VibeCodingApp] ✅ ranks 对象已注入:",t.ranks)),t.analysis&&(r.analysis=t.analysis,console.log("[VibeCodingApp] ✅ analysis 对象已注入:",t.analysis)),t.semanticFingerprint&&(r.semanticFingerprint=t.semanticFingerprint,console.log("[VibeCodingApp] ✅ semanticFingerprint 对象已注入:",t.semanticFingerprint)),t.stats&&(r.stats=t.stats,console.log("[VibeCodingApp] ✅ stats 对象已注入:",t.stats)),t.fingerprint&&(r.fingerprint=t.fingerprint,console.log("[VibeCodingApp] ✅ fingerprint 已注入:",t.fingerprint)),t.personality?(r.personality=t.personality,console.log("[VibeCodingApp] ✅ personality 对象已注入:",t.personality),t.personality.detailedStats&&Array.isArray(t.personality.detailedStats)?(r.detailedStats=t.personality.detailedStats,r.personality.detailedStats=t.personality.detailedStats,console.log("[VibeCodingApp] ✅ 从 personality.detailedStats 读取数据:",t.personality.detailedStats),t.personality.detailedStats.length>0&&(this&&"function"==typeof this.updateV6UI?(this.updateV6UI({detailedStats:t.personality.detailedStats}),console.log("[VibeCodingApp] ✅ 已调用 updateV6UI 更新维度 UI")):console.warn("[VibeCodingApp] ⚠️ updateV6UI 方法不存在"))):console.warn("[VibeCodingApp] ⚠️ personality.detailedStats 不存在或不是数组")):t.detailedStats&&(r.detailedStats=t.detailedStats,console.log("[VibeCodingApp] ⚠️ 使用降级路径：从 liveRank.detailedStats 读取数据")),console.log("[VibeCodingApp] 真实排名数据已获取并更新:",{rankPercent:t.rankPercent,totalUsers:t.totalUsers,hasRanks:!!t.ranks,hasAnalysis:!!t.analysis,hasSemanticFingerprint:!!t.semanticFingerprint,hasStats:!!t.stats,hasPersonality:!!t.personality,hasDetailedStats:!(!(null==(s=t.personality)?void 0:s.detailedStats)&&!t.detailedStats),detailedStatsPath:(null==(o=t.personality)?void 0:o.detailedStats)?"personality.detailedStats":t.detailedStats?"detailedStats":"none"})):console.warn("[VibeCodingApp] uploadToSupabase 未返回有效的 rankPercent")}catch(d){if(console.error("[VibeCodingApp] uploadToSupabase 调用失败:",d),n){const e=ne(),t=(null==(i=window.i18n)?void 0:i.getText("upload.logs.rankUploadFailed",e))||("en"===e?"Failed to upload ranking data":"排名数据上传失败");n(t)}}};this.vibeResult=r;try{const t=i&&i.lang?String(i.lang):ne(),n=i&&i.fingerprint?String(i.fingerprint):localStorage.getItem("user_fingerprint")||null,a={chatData:e,lang:t,fingerprint:n,dimensions:(null==r?void 0:r.dimensions)||null,stats:(null==r?void 0:r.stats)||(null==r?void 0:r.statistics)||null,meta:i||null,vibeIndex:(null==r?void 0:r.vibeIndex)||(null==r?void 0:r.vibe_index)||null,personalityType:(null==r?void 0:r.personalityType)||(null==r?void 0:r.personality_type)||null};localStorage.setItem("last_analysis_data",JSON.stringify(a))}catch(d){try{const e=i&&i.lang?String(i.lang):ne(),t={chatData:null,lang:e,fingerprint:i&&i.fingerprint?String(i.fingerprint):localStorage.getItem("user_fingerprint")||null,dimensions:(null==r?void 0:r.dimensions)||null,stats:(null==r?void 0:r.stats)||(null==r?void 0:r.statistics)||null,meta:i||null,vibeIndex:(null==r?void 0:r.vibeIndex)||(null==r?void 0:r.vibe_index)||null,personalityType:(null==r?void 0:r.personalityType)||(null==r?void 0:r.personality_type)||null,note:"localStorage_limit_exceeded"};localStorage.setItem("last_analysis_data",JSON.stringify(t))}catch{}}if(this.renderReport(r),l){try{if("function"==typeof n){const e=ne(),t=(null==(s=window.i18n)?void 0:s.getText("upload.logs.backgroundSync",e))||("en"===e?"Background syncing global ranking… (you can continue)":"后台同步全球排名中…（不影响使用）");n(t)}}catch{}Promise.resolve().then(()=>c()).catch(e=>console.warn("[VibeCodingApp] 后台全球同步失败:",e))}else await c();return r}async analyzeFileSync(e,t=null,n=null,a={}){var s;if(!this.analyzer)throw new Error("分析器未初始化，请先调用 init()");const o=ne();this.analyzer.setLanguage(o);const i=await this.generateContext(),r=await this.analyzer.analyzeSync(e,i.lang||o,null,n);console.log("[VibeCodingApp] analyzeSync 完成:",r),r&&!r.stats&&(r.statistics?r.stats={totalChars:r.statistics.totalChars||r.statistics.totalUserChars||0,totalMessages:r.statistics.totalMessages||r.statistics.userMessages||0,ketao_count:r.statistics.ketao_count||r.statistics.qingCount||0,jiafang_count:r.statistics.jiafang_count||r.statistics.buCount||0,abuse_value:r.statistics.abuse_value||r.statistics.abuseValue||0,tech_stack:r.statistics.tech_stack||{},work_days:r.statistics.work_days||r.statistics.usageDays||1,avg_payload:r.statistics.avg_payload||0,balance_score:r.statistics.balance_score||0,style_label:r.statistics.style_label||"标准型",blackword_hits:r.statistics.blackword_hits||{},...r.statistics}:r.stats={totalChars:0,totalMessages:0,ketao_count:0,jiafang_count:0,abuse_value:0,tech_stack:{},work_days:1,avg_payload:0,balance_score:0,style_label:"标准型",blackword_hits:{}}),this.updateUIWithStats(r,this.globalStatsCache);const l=!1!==(null==a?void 0:a.deferGlobalSync),c=async()=>{var a,s,o,i,l;if(!r||!r.statistics)return;const c=r.statistics;c.qingCount=(null==t?void 0:t.qingCount)||(null==J?void 0:J.qingCount)||0,c.buCount=(null==t?void 0:t.buCount)||(null==J?void 0:J.buCount)||0,c.usageDays=(null==t?void 0:t.usageDays)||(null==J?void 0:J.usageDays)||1;let d=0,g=0;e&&Array.isArray(e)&&e.forEach(e=>{"USER"===e.role&&e.text&&(d+=e.text.length,g++)}),c.totalUserChars=d||c.totalUserChars||c.totalChars||0,c.totalChars=d||c.totalChars||c.totalUserChars||0,c.userMessages=g||c.userMessages||c.totalMessages||0,c.totalMessages=g||c.totalMessages||c.userMessages||0;try{const t=await this.analyzer.uploadToSupabase(r,e,n);try{(null==t?void 0:t.claim_token)&&localStorage.setItem("vibe_claim_token",t.claim_token)}catch{}try{if("undefined"!=typeof window){const e=Number((null==t?void 0:t.totalUsers)||(null==(a=null==r?void 0:r.rankData)?void 0:a.totalUsers)||0)||0,n=(null==t?void 0:t.ranks)||null,s=t=>{if(null==t||e<=0)return null;const n=Number(t);if(Number.isNaN(n))return null;if(n<=0)return e;const a=Math.floor(e*(n/100));return Math.max(1,e-a)};if(e>0&&n){if(window.userRankings={qingCount:{rank:s(n.ketaoRank),total:e},buCount:{rank:s(n.jiafangRank),total:e},userMessages:{rank:s(n.messageRank),total:e},totalUserChars:{rank:s(n.charRank),total:e},avgUserMessageLength:{rank:s(n.avgRank),total:e},usageDays:{rank:s(n.daysRank),total:e}},"function"==typeof window.updateRankingBadges){const e=localStorage.getItem("appLanguage")||"zh-CN";Promise.resolve(window.updateRankingBadges(window.userRankings,e)).catch(()=>{})}try{window.dispatchEvent(new CustomEvent("userRankingsUpdated",{detail:window.userRankings}))}catch{}}}}catch{}if(t&&t.globalAverage){const e=t.globalAverage;50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?console.warn("[VibeCodingApp] ⚠️ uploadToSupabase 返回的全局平均值是默认值（同步方法），忽略"):(Q=e,X=!0,console.log("[VibeCodingApp] ✅ 从 uploadToSupabase 获取到全局平均值（同步方法）:",Q))}t&&void 0!==t.rankPercent?(c.rankPercent=t.rankPercent,c.totalUsers=t.totalUsers,r.rankData||(r.rankData={}),r.rankData.rankPercent=t.rankPercent,r.rankData.totalUsers=t.totalUsers,t.ranks&&(r.rankData.ranks=t.ranks,console.log("[VibeCodingApp] ✅ ranks 对象已注入（同步方法）:",t.ranks)),t.personality&&(r.personality=t.personality,console.log("[VibeCodingApp] ✅ personality 对象已注入（同步方法）:",t.personality)),t.detailedStats&&(r.detailedStats=t.detailedStats,console.log("[VibeCodingApp] ✅ detailedStats 数组已注入（同步方法）:",t.detailedStats)),(null==(s=t.personality)?void 0:s.detailedStats)&&Array.isArray(t.personality.detailedStats)?(Y.detailedStats=t.personality.detailedStats,Y.personality=Y.personality||{},Y.personality.detailedStats=t.personality.detailedStats,console.log("[VibeCodingApp] ✅ 从 personality.detailedStats 读取数据（同步方法）:",t.personality.detailedStats),t.personality.detailedStats.length>0&&(te&&"function"==typeof te.updateV6UI?(te.updateV6UI({detailedStats:t.personality.detailedStats}),console.log("[VibeCodingApp] ✅ 已调用 updateV6UI 更新维度 UI（同步方法）")):console.warn("[VibeCodingApp] ⚠️ vibeCodingApp 或 updateV6UI 方法不存在（同步方法）"))):console.warn("[VibeCodingApp] ⚠️ personality.detailedStats 不存在或不是数组（同步方法）"),console.log("[VibeCodingApp] 真实排名数据已获取并更新（同步方法）:",{rankPercent:t.rankPercent,totalUsers:t.totalUsers,hasRanks:!!t.ranks,hasPersonality:!!t.personality,hasDetailedStats:!(!(null==(o=t.personality)?void 0:o.detailedStats)&&!t.detailedStats),detailedStatsPath:(null==(i=t.personality)?void 0:i.detailedStats)?"personality.detailedStats":t.detailedStats?"detailedStats":"none"})):console.warn("[VibeCodingApp] uploadToSupabase 未返回有效的 rankPercent（同步方法）")}catch(u){if(console.error("[VibeCodingApp] uploadToSupabase 调用失败（同步方法）:",u),n){const e=ne(),t=(null==(l=window.i18n)?void 0:l.getText("upload.logs.rankUploadFailed",e))||("en"===e?"Failed to upload ranking data":"排名数据上传失败");n(t)}}};this.vibeResult=r;try{const t=i&&i.lang?String(i.lang):ne(),n=i&&i.fingerprint?String(i.fingerprint):localStorage.getItem("user_fingerprint")||null,a={chatData:e,lang:t,fingerprint:n,dimensions:(null==r?void 0:r.dimensions)||null,stats:(null==r?void 0:r.stats)||(null==r?void 0:r.statistics)||null,meta:i||null,vibeIndex:(null==r?void 0:r.vibeIndex)||(null==r?void 0:r.vibe_index)||null,personalityType:(null==r?void 0:r.personalityType)||(null==r?void 0:r.personality_type)||null};localStorage.setItem("last_analysis_data",JSON.stringify(a))}catch(d){try{const e=i&&i.lang?String(i.lang):ne(),t={chatData:null,lang:e,fingerprint:i&&i.fingerprint?String(i.fingerprint):localStorage.getItem("user_fingerprint")||null,dimensions:(null==r?void 0:r.dimensions)||null,stats:(null==r?void 0:r.stats)||(null==r?void 0:r.statistics)||null,meta:i||null,vibeIndex:(null==r?void 0:r.vibeIndex)||(null==r?void 0:r.vibe_index)||null,personalityType:(null==r?void 0:r.personalityType)||(null==r?void 0:r.personality_type)||null,note:"localStorage_limit_exceeded"};localStorage.setItem("last_analysis_data",JSON.stringify(t))}catch{}}if(this.renderReport(r),l){try{if("function"==typeof n){const e=ne(),t=(null==(s=window.i18n)?void 0:s.getText("upload.logs.backgroundSync",e))||("en"===e?"Background syncing global ranking… (you can continue)":"后台同步全球排名中…（不影响使用）");n(t)}}catch{}Promise.resolve().then(()=>c()).catch(e=>console.warn("[VibeCodingApp] 后台全球同步失败（同步方法）:",e))}else await c();return r}renderReport(e){e?(Y=e,document.getElementById("vibeCodingerSection")&&Ue(),console.log("[VibeCodingApp] 报告渲染完成")):console.warn("[VibeCodingApp] 没有结果可渲染")}}let G=null,Z=[],J=null,K=null,Y=null,Q={L:50,P:50,D:50,E:50,F:50},X=!1,ee=!1,te=null;function ne(){return"en"===localStorage.getItem("appLanguage")?"en":"zh-CN"}function ae(e){return window.i18n&&window.i18n.getText?window.i18n.getText(e,ne()):e}const se=()=>J,oe=()=>Z,ie=()=>Y,re=()=>G,le=()=>K,ce=e=>{e&&(J=e,console.log("[Main] 已设置分享模式的统计数据:",J))},de=e=>{e&&(Y=e,console.log("[Main] 已设置分享模式的 Vibe 结果:",Y))},ge=e=>{e&&Array.isArray(e)&&(Z=e,console.log("[Main] 已设置分享模式的聊天数据:",Z.length,"条"))},ue=async(e,t,n)=>{console.log("[Main] processFiles 被调用",{filesCount:e.length,type:t}),G||(console.log("[Main] 解析器未初始化，正在初始化..."),G=new l,await G.init(),K=q(),console.log("[Main] 解析器初始化完成"));const a={target:{files:e,value:""}};try{return await xe(a,t,n)}catch(s){throw console.error("[Main] processFiles 错误:",s),(null==n?void 0:n.onError)&&n.onError(s),s}},he=async e=>{var t,n;if(!K||!Z||0===Z.length)return console.warn("[Main] 无法重新分析：缺少数据或分析器"),null;console.log("[Main] 使用新语言重新分析:",e),K.setLanguage(e);try{let s=1;if(J&&J.earliestFileTime){const e=Date.now(),t=e-J.earliestFileTime;s=Math.max(1,Math.floor(t/864e5))}const o=te?await te.generateContext():{ip:"0.0.0.0",lang:e,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",fingerprint:null,isVpn:!1,isProxy:!1};if(o.lang=e,Y=await K.analyze(Z,o,null),console.log("[Main] 重新分析完成"),Y&&Y.statistics){Y.statistics.qingCount=(null==J?void 0:J.qingCount)||0,Y.statistics.buCount=(null==J?void 0:J.buCount)||0,Y.statistics.usageDays=s;try{const e=await K.uploadToSupabase(Y,Z);try{(null==e?void 0:e.claim_token)&&localStorage.setItem("vibe_claim_token",e.claim_token)}catch{}if(e&&e.globalAverage){const t=e.globalAverage;50===t.L&&50===t.P&&50===t.D&&50===t.E&&50===t.F?console.warn("[Main] ⚠️ uploadToSupabase 返回的全局平均值是默认值，忽略"):(Q=t,X=!0,console.log("[Main] ✅ 从 uploadToSupabase 获取到全局平均值:",Q))}e&&void 0!==e.rankPercent&&(Y.statistics.rankPercent=e.rankPercent,Y.statistics.totalUsers=e.totalUsers,Y.rankData||(Y.rankData={}),Y.rankData.rankPercent=e.rankPercent,Y.rankData.totalUsers=e.totalUsers,e.ranks&&(Y.rankData.ranks=e.ranks,console.log("[Main] ✅ ranks 对象已注入:",e.ranks)),e.personality?(Y.personality=e.personality,console.log("[Main] ✅ personality 对象已注入:",e.personality),e.personality.detailedStats&&Array.isArray(e.personality.detailedStats)?(Y.detailedStats=e.personality.detailedStats,Y.personality.detailedStats=e.personality.detailedStats,console.log("[Main] ✅ 从 personality.detailedStats 读取数据:",e.personality.detailedStats),e.personality.detailedStats.length>0&&(te&&"function"==typeof te.updateV6UI?(te.updateV6UI({detailedStats:e.personality.detailedStats}),console.log("[Main] ✅ 已调用 updateV6UI 更新维度 UI")):console.warn("[Main] ⚠️ vibeCodingApp 或 updateV6UI 方法不存在"))):console.warn("[Main] ⚠️ personality.detailedStats 不存在或不是数组")):e.detailedStats&&(Y.detailedStats=e.detailedStats,console.log("[Main] ⚠️ 使用降级路径：从 liveRank.detailedStats 读取数据")),console.log("[Main] 真实排名数据已获取并覆盖:",{rankPercent:e.rankPercent,totalUsers:e.totalUsers,hasRanks:!!e.ranks,hasPersonality:!!e.personality,hasDetailedStats:!(!(null==(t=e.personality)?void 0:t.detailedStats)&&!e.detailedStats),detailedStatsPath:(null==(n=e.personality)?void 0:n.detailedStats)?"personality.detailedStats":e.detailedStats?"detailedStats":"none"}))}catch(a){console.error("[Main] uploadToSupabase 调用失败:",a)}}return document.getElementById("vibeCodingerSection")&&Ue(),Y}catch(s){console.warn("[Main] 异步分析失败，使用同步方法:",s);let t=1;if(J&&J.earliestFileTime){const e=Date.now()-J.earliestFileTime;t=Math.max(1,Math.floor(e/864e5))}const n=te?await te.generateContext():{lang:e,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"};if(n.lang=e,Y=await K.analyzeSync(Z,n.lang||e,null),Y&&Y.statistics){Y.statistics.qingCount=(null==J?void 0:J.qingCount)||0,Y.statistics.buCount=(null==J?void 0:J.buCount)||0,Y.statistics.usageDays=t;try{const e=await K.uploadToSupabase(Y,Z);try{(null==e?void 0:e.claim_token)&&localStorage.setItem("vibe_claim_token",e.claim_token)}catch{}if(e&&e.globalAverage){const t=e.globalAverage;50===t.L&&50===t.P&&50===t.D&&50===t.E&&50===t.F?console.warn("[Main] ⚠️ uploadToSupabase 返回的全局平均值是默认值（同步方法），忽略"):(Q=t,X=!0,console.log("[Main] ✅ 从 uploadToSupabase 获取到全局平均值（同步方法）:",Q))}e&&void 0!==e.rankPercent&&(Y.statistics.rankPercent=e.rankPercent,Y.statistics.totalUsers=e.totalUsers,Y.rankData||(Y.rankData={}),Y.rankData.rankPercent=e.rankPercent,Y.rankData.totalUsers=e.totalUsers,e.ranks&&(Y.rankData.ranks=e.ranks,console.log("[Main] ✅ ranks 对象已注入（同步方法）:",e.ranks)),console.log("[Main] 真实排名数据已获取并覆盖（同步方法）:",{rankPercent:e.rankPercent,totalUsers:e.totalUsers,hasRanks:!!e.ranks}))}catch(a){console.error("[Main] uploadToSupabase 调用失败（同步方法）:",a)}}return document.getElementById("vibeCodingerSection")&&Ue(),Y}},pe=async e=>{const t=e||window.vibeResult||globalThis.vibeResult;if(t&&(window.vibeResult=t,Y=t,console.log("[Main] ✅ 已更新全局 vibeResult:",{hasPersonalityName:!!t.personalityName,hasRoastText:!!t.roastText,hasDimensions:!!t.dimensions,hasAnalysis:!!t.analysis,hasSemanticFingerprint:!!t.semanticFingerprint,dimensionsKeys:t.dimensions?Object.keys(t.dimensions):null})),console.log("[Main] renderFullDashboard 被调用"),console.log("[Main] 数据状态:",{hasGlobalStats:!!J,hasVibeResult:!!t,chatDataLength:Z.length}),function(){if(console.log("[Main] 更新元素引用..."),Se.totalConversations=document.getElementById("totalConversations"),Se.userMessages=document.getElementById("userMessages"),Se.qingCount=document.getElementById("qingCount"),Se.buCount=document.getElementById("buCount"),Se.totalUserChars=document.getElementById("totalUserChars"),Se.avgUserMessageLength=document.getElementById("avgUserMessageLength"),Se.questionMessageCount=document.getElementById("questionMessageCount"),Se.topChineseWordsList=document.getElementById("topChineseWordsList"),Ce.searchInput=document.getElementById("searchInput"),Ce.chatList=document.getElementById("chatList"),Ce.paginationContainer=document.getElementById("paginationContainer"),Ce.paginationInfo=document.getElementById("paginationInfo"),Ce.paginationPages=document.getElementById("paginationPages"),Ce.paginationPrev=document.getElementById("paginationPrev"),Ce.paginationNext=document.getElementById("paginationNext"),Ce.exportBtn=document.getElementById("exportBtn"),console.log("[Main] 元素引用更新完成:",{totalConversations:!!Se.totalConversations,userMessages:!!Se.userMessages,qingCount:!!Se.qingCount,buCount:!!Se.buCount,chatList:!!Ce.chatList}),Ce.searchInput){const e=Ce.searchInput,t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),Ce.searchInput=t;const n=Ne($e,300);Ce.searchInput.addEventListener("input",n),console.log("[Main] ✅ 搜索框事件已重新绑定")}else console.warn("[Main] ⚠️ searchInput 元素未找到，无法绑定事件");Ce.paginationPrev&&Ce.paginationPrev.addEventListener("click",()=>{ye>1&&(ye--,Te(fe))});Ce.paginationNext&&Ce.paginationNext.addEventListener("click",()=>{const e=Math.ceil(fe.length/be);ye<e&&(ye++,Te(fe))})}(),J&&(console.log("[Main] 调用 displayStats..."),Le()),t){console.log("[Main] 调用 displayVibeCodingerAnalysis..."),Ue();try{await async function(e){const t=e||window.vibeResult||globalThis.vibeResult;try{if(!t||!J)return void console.warn("[Main] displayRealtimeStats: 缺少必要数据",{hasVibeResult:!!t,hasGlobalStats:!!J});const e=window.shareModeStats||window.shareModeVibeResult;let s;try{if(e){const e=parseInt(localStorage.getItem("totalTestUsers")||"0");s=e>0?e:1e3,console.log("[Main] 分享模式：使用缓存的 totalTestUsers:",s)}else s=await He()}catch(n){console.error("[Main] 获取测试总人数失败，使用默认值:",n),s=1e3}const o=s;let i=null,r=0;try{if(t&&t.rankData){const e=t.rankData,n=e.ranking??e.rankPercent??null;if(null!=n){const e=Number(n);isNaN(e)||(e>=0&&e<=100?i=e:e>0&&s>0&&(i=(s-e)/s*100))}if(null!==i&&!isNaN(i)&&i>=0&&i<=100){console.log("[Main] 使用后端返回的真实排名:",i);const e=i/100;r=Math.max(1,Math.round(s*(1-e)))}else console.warn("[Main] 警告：排名数据格式异常或无效，将显示为 0",{rankPercent:i,rankingValue:n,rankData:t.rankData}),i=null,r=0}else{const e=async(e=2500)=>{const n=Date.now();for(;Date.now()-n<e;){try{if(t&&t.rankData)return t.rankData}catch{}await new Promise(e=>setTimeout(e,120))}return null},n=await e();if(n){const e=n.ranking??n.rankPercent??null,t=Number(e);if(!isNaN(t)&&(t>=0&&t<=100?i=t:t>0&&s>0&&(i=(s-t)/s*100),null!=i&&!isNaN(i)&&i>=0&&i<=100)){const e=i/100;r=Math.max(1,Math.round(s*(1-e)))}console.log("[Main] displayRealtimeStats: 等待到 rankData，跳过二次上报",{hasRankData:!0})}else console.warn("[Main] displayRealtimeStats: 未拿到 rankData（已禁止二次上报），降级显示 0"),i=null,r=0}}catch(a){console.warn("[Main] 处理排名数据时发生错误，将显示为 0:",a),i=null,r=0}const l=243,c=1,d=Math.round(c/l*100),g=document.getElementById("totalTestUsers"),u=document.getElementById("techRank"),h=document.getElementById("personalityUnlock");if(g&&(o!==s?je(g,s,De):g.textContent=De(s)),u&&(null!=r&&!isNaN(r)&&r>=0?je(u,r,De):(console.warn("[Main] 排名数据无效，将显示为 0"),je(u,0,De))),h){const e=`${d}%`;h.textContent!==e?je(h,d,e=>`${e}%`):h.textContent=e}console.log("[Main] 实时统计已更新:",{totalTestUsers:s,techRank:r,unlockProgress:`${d}%`})}catch(a){console.error("[Main] displayRealtimeStats 执行失败，但不影响后续逻辑:",a)}}(t)}catch(n){console.error("[Main] 统计上传失败:",n)}try{!function(){if(!Y||!Y.dimensions)return;const e=document.getElementById("dimensionRankingList");if(!e)return;const{dimensions:t}=Y,n=ne(),a=Object.entries(t).map(([e,t])=>{var a,s,o,i;const r=null==(o=null==(s=null==(a=window.i18n)?void 0:a.getI18nText(n))?void 0:s.dimensions)?void 0:o[e];return{key:e,label:(null==r?void 0:r.label)||(null==(i=P[e])?void 0:i.label)||e,value:t,displayValue:"E"===e?t:Math.round(t)}}).sort((e,t)=>{const n="E"===e.key?10*e.value:e.value;return("E"===t.key?10*t.value:t.value)-n});e.innerHTML=a.map((e,t)=>{var a,s;const o=t+1,i=1===o?"🥇":2===o?"🥈":3===o?"🥉":`#${o}`,r="E"===e.key?10:100,l=Math.min(100,Math.round(e.value/r*100)),c="E"===e.key?(null==(a=window.i18n)?void 0:a.getText("dashboard.techUnit",n))||"种技术":(null==(s=window.i18n)?void 0:s.getText("dashboard.pointsUnit",n))||"分";return`\n      <div class="prompt-item" style="background: ${o<=3?"rgba(0, 255, 65, 0.1)":"rgba(255, 255, 255, 0.03)"}; border-color: ${o<=3?"rgba(0, 255, 65, 0.3)":"var(--card-border)"};">\n        <span class="prompt-rank" style="font-size: 20px; min-width: 50px;">${i}</span>\n        <span class="prompt-text" style="flex: 1; font-weight: 600;">${e.label}</span>\n        <div style="display: flex; align-items: center; gap: 12px;">\n          <div style="width: 120px; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">\n            <div style="width: ${l}%; height: 100%; background: var(--accent-terminal); transition: width 0.5s ease;"></div>\n          </div>\n          <span class="prompt-count" style="min-width: 80px; text-align: right; font-weight: 700; color: var(--accent-terminal);">${e.displayValue} ${c}</span>\n        </div>\n      </div>\n    `}).join(""),console.log("[Main] 维度排行榜已渲染:",a)}()}catch(n){console.error("[Main] displayDimensionRanking 调用失败:",n)}}Z.length>0&&(console.log("[Main] 渲染对话列表..."),ye=1,Te(Z)),console.log("[Main] 渲染词云..."),Ke(),console.log("[Main] renderFullDashboard 完成")};const me=async()=>(G||(console.log("[Main] 初始化解析器（模块模式）..."),G=new l,await G.init(),K=q(),console.log("[Main] 解析器初始化完成")),{parser:G,vibeAnalyzer:K});let ye=1,be=20,fe=[],ve=!1,we=!1;const Ce={uploadSection:document.getElementById("uploadSection"),loadingSection:document.getElementById("loadingSection"),dashboardSection:document.getElementById("dashboardSection"),uploadBtn:document.getElementById("uploadBtn"),selectFolderBtn:document.getElementById("selectFolderBtn"),folderInput:document.getElementById("folderInput"),fileInput:document.getElementById("fileInput"),exportBtn:document.getElementById("exportBtn"),selectFileBtn:document.getElementById("selectFileBtn"),uploadError:document.getElementById("uploadError"),loadingProgress:document.getElementById("loadingProgress"),exportArea:document.getElementById("exportArea"),searchInput:document.getElementById("searchInput"),chatList:document.getElementById("chatList"),paginationContainer:document.getElementById("paginationContainer"),paginationInfo:document.getElementById("paginationInfo"),paginationPages:document.getElementById("paginationPages"),paginationPrev:document.getElementById("paginationPrev"),paginationNext:document.getElementById("paginationNext")},Se={totalConversations:document.getElementById("totalConversations"),userMessages:document.getElementById("userMessages"),qingCount:document.getElementById("qingCount"),buCount:document.getElementById("buCount"),topChineseWordsList:document.getElementById("topChineseWordsList"),totalUserChars:document.getElementById("totalUserChars"),avgUserMessageLength:document.getElementById("avgUserMessageLength"),questionMessageCount:document.getElementById("questionMessageCount")};async function ke(){console.log("[Main] ===== 应用初始化开始 ====="),console.log("[Main] 当前时间:",(new Date).toISOString()),"loading"===document.readyState&&(console.log("[Main] 等待 DOM 加载..."),await new Promise(e=>{document.addEventListener("DOMContentLoaded",e)})),console.log("[Main] DOM 已就绪，开始获取元素..."),Ce.uploadSection=document.getElementById("uploadSection"),Ce.loadingSection=document.getElementById("loadingSection"),Ce.dashboardSection=document.getElementById("dashboardSection"),Ce.uploadBtn=document.getElementById("uploadBtn"),Ce.selectFolderBtn=document.getElementById("selectFolderBtn"),Ce.folderInput=document.getElementById("folderInput"),Ce.fileInput=document.getElementById("fileInput"),Ce.exportBtn=document.getElementById("exportBtn"),Ce.selectFileBtn=document.getElementById("selectFileBtn"),Ce.uploadError=document.getElementById("uploadError"),Ce.loadingProgress=document.getElementById("loadingProgress"),Ce.exportArea=document.getElementById("exportArea"),Ce.searchInput=document.getElementById("searchInput"),Ce.chatList=document.getElementById("chatList"),Ce.paginationContainer=document.getElementById("paginationContainer"),Ce.paginationInfo=document.getElementById("paginationInfo"),Ce.paginationPages=document.getElementById("paginationPages"),Ce.paginationPrev=document.getElementById("paginationPrev"),Ce.paginationNext=document.getElementById("paginationNext"),console.log("[Main] 初始化 CursorParser..."),G=new l,await G.init(),console.log("[Main] CursorParser 初始化完成"),console.log("[Main] 初始化 VibeCodingerAnalyzer..."),K=new z,console.log("[Main] VibeCodingerAnalyzer 初始化完成"),console.log("[Main] 初始化 VibeCodingApp..."),te=new H,te.parser=G,te.analyzer=K,console.log("[Main] VibeCodingApp 初始化完成"),console.log("[Main] 开始获取全局平均值..."),ze().then(e=>{50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?(console.warn("[Main] ⚠️ 获取到的数据是默认值，可能 API 请求失败"),X=!1):(Q=e,X=!0,console.log("[Main] ✅ 全局平均值已从 API 成功加载:",Q)),Y&&window.vibeRadarChartInstance&&(console.log("[Main] 更新已渲染的雷达图..."),We())}).catch(e=>{console.error("[Main] ❌ 获取全局平均值失败:",e),X=!1,console.log("[Main] 使用默认全局平均值:",Q)}),function(){console.log("[Main] 开始绑定事件..."),Ce.uploadBtn?(console.log("[Main] ✅ uploadBtn 元素已找到"),Ce.uploadBtn.addEventListener("click",e=>{console.log("[Main] 点击上传按钮"),e.preventDefault(),Me(Ce.folderInput)})):console.error("[Main] ❌ uploadBtn 元素未找到");Ce.selectFolderBtn?(console.log("[Main] ✅ selectFolderBtn 元素已找到"),Ce.selectFolderBtn.addEventListener("click",e=>{console.log("[Main] 点击选择文件夹按钮"),e.preventDefault(),Me(Ce.folderInput)})):console.error("[Main] ❌ selectFolderBtn 元素未找到");Ce.selectFileBtn?(console.log("[Main] ✅ selectFileBtn 元素已找到"),Ce.selectFileBtn.addEventListener("click",e=>{console.log("[Main] 点击选择文件按钮"),e.preventDefault(),Me(Ce.fileInput)})):console.error("[Main] ❌ selectFileBtn 元素未找到");Ce.folderInput?(console.log("[Main] ✅ folderInput 元素已找到"),Ce.folderInput.addEventListener("change",e=>{if(we||ve)return console.warn("[Main] ⚠️ 正在分析中，忽略重复请求"),void(e.target.value="");console.log("[Main] 文件夹选择事件触发"),xe(e,"folder")})):console.error("[Main] ❌ folderInput 元素未找到");Ce.fileInput?(console.log("[Main] ✅ fileInput 元素已找到"),Ce.fileInput.addEventListener("change",e=>{if(we||ve)return console.warn("[Main] ⚠️ 正在分析中，忽略重复请求"),void(e.target.value="");console.log("[Main] 文件选择事件触发"),xe(e,"file")})):console.error("[Main] ❌ fileInput 元素未找到");function e(e){Ce.selectFolderBtn&&(Ce.selectFolderBtn.disabled=e,e?(Ce.selectFolderBtn.style.opacity="0.5",Ce.selectFolderBtn.style.cursor="not-allowed"):(Ce.selectFolderBtn.style.opacity="1",Ce.selectFolderBtn.style.cursor="pointer")),Ce.uploadBtn&&(Ce.uploadBtn.disabled=e,e?(Ce.uploadBtn.style.opacity="0.5",Ce.uploadBtn.style.cursor="not-allowed"):(Ce.uploadBtn.style.opacity="1",Ce.uploadBtn.style.cursor="pointer"))}if(window.updateUploadButtonsState=e,Ce.searchInput){const e=Ne($e,300);Ce.searchInput.addEventListener("input",e),console.log("[Main] ✅ 搜索框事件已绑定")}else console.warn("[Main] ⚠️ searchInput 元素未找到，可能 DOM 尚未加载");Ce.paginationPrev&&Ce.paginationPrev.addEventListener("click",()=>{ye>1&&(ye--,Te(fe))});Ce.paginationNext&&Ce.paginationNext.addEventListener("click",()=>{const e=Math.ceil(fe.length/be);ye<e&&(ye++,Te(fe))});Ce.exportBtn&&Ce.exportBtn.addEventListener("click",Re);console.log("[Main] 事件绑定完成")}(),console.log("[Main] ===== 应用初始化完成 =====")}function Me(e){if(console.log("[Main] 尝试触发文件选择..."),console.log("[Main] inputElement:",e),console.log("[Main] inputElement.type:",null==e?void 0:e.type),e)try{if(e.value="",e.click)e.click();else{const t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});e.dispatchEvent(t)}console.log("[Main] ✅ 文件选择已触发")}catch(t){console.error("[Main] ❌ 触发文件选择失败:",t),alert("无法打开文件选择对话框，请检查浏览器设置或刷新页面重试。")}else console.error("[Main] ❌ inputElement 为 null")}async function xe(e,t,n={}){var a,s,o,i,r,l,c,d,g;if(ve||we)return console.warn("[Main] ⚠️ 正在处理中，忽略重复请求",{isProcessing:ve,isAnalyzing:we}),void(e&&e.target&&(e.target.value=""));window.updateUploadButtonsState&&window.updateUploadButtonsState(!0);const{onProgress:u,onLog:h,onComplete:p,onError:m}=n;console.log(`[Main] 处理文件上传，类型: ${t}`),console.log(`[Main] event.files.length: ${null==(a=e.target.files)?void 0:a.length}`);const y=Array.from(e.target.files||[]);if(n&&n.onLog||Ce.uploadError&&(Ce.uploadError.classList.add("hidden"),Ce.uploadError.textContent=""),0===y.length)return console.warn("[Main] 没有选择文件"),void((null==n?void 0:n.onError)&&n.onError(new Error("没有选择文件")));if(console.log(`[Main] 选择了 ${y.length} 个文件`),console.log("[Main] 文件列表:"),y.forEach((e,t)=>{console.log(`  [${t+1}] ${e.name} (${function(e){if(0===e)return"0 B";const t=1024,n=["B","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,a)*100)/100+" "+n[a]}(e.size)})`)}),n&&n.onLog){if(n.onLog){const e=ne(),t=(null==(s=window.i18n)?void 0:s.getText("upload.logs.startProcessing",e))||"开始处理文件...";n.onLog(`> ${t}`)}}else Ie();try{let e=[],a=[];if("folder"===t){if(e=y.filter(e=>"state.vscdb"===e.name),a=y.filter(e=>"state.vscdb"!==e.name),console.log(`[Main] 文件夹模式：找到 ${e.length} 个 state.vscdb 文件`),a.length>0&&(console.log(`[Main] 已过滤 ${a.length} 个非数据库文件`),a.length<=10&&console.log("[Main] 过滤的文件:",a.map(e=>e.name))),0===e.length){const e=a.slice(0,5).map(e=>e.name).join(", "),t=0===a.length?"未找到 state.vscdb 文件，请选择正确的 Cursor workspaceStorage 目录":`未找到 state.vscdb 文件。选中的文件包括：${e}${a.length>5?"...":""}`;throw new Error(t)}}else{const t=[".vscdb",".db",".sqlite",".sqlite3"];if(e=y.filter(e=>t.some(t=>e.name.toLowerCase().endsWith(t))),a=y.filter(e=>!t.some(t=>e.name.toLowerCase().endsWith(t))),console.log(`[Main] 单文件模式：找到 ${e.length} 个数据库文件`),a.length>0&&(console.log(`[Main] 已过滤 ${a.length} 个非数据库文件`),console.log("[Main] 过滤的文件:",a.map(e=>e.name))),0===e.length){const e=a.slice(0,3).map(e=>e.name).join(", "),t=0===a.length?"未找到有效的数据库文件（.vscdb, .db, .sqlite, .sqlite3）":`未找到有效的数据库文件。选择的是：${e}${a.length>3?"...":""}，请选择数据库文件`;throw new Error(t)}}let s=null;if(y.length>0){for(const e of y)e.lastModified&&(null===s||e.lastModified<s)&&(s=e.lastModified);console.log("[Main] 最早文件时间:",s?new Date(s).toISOString():"未找到")}J={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},chineseEmotionWords:{},englishWords:{},earliestFileTime:s,userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}},Z=[];let m=0;for(const t of e)try{console.log(`[Main] 正在处理: ${t.name}`),t.webkitRelativePath&&console.log(`[Main] 相对路径: ${t.webkitRelativePath}`);const a=await t.arrayBuffer();console.log(`[Main] 文件大小: ${a.byteLength} bytes`),await G.loadDatabase(a);const s=await G.scanDatabase();if(console.log(`[Main] 提取到 ${s.length} 条记录`),Z=Z.concat(s),Ae(J,G.stats),m++,n&&n.onLog||Ee(m,e.length),u&&u(m,e.length,t.name),h){const n=ne(),a=((null==(o=window.i18n)?void 0:o.getText("upload.logs.processed",n))||"已处理 {current}/{total}: {fileName}").replace("{current}",m).replace("{total}",e.length).replace("{fileName}",t.name);h(`> ${a}`)}console.log("[Main] 当前统计:",{totalConversations:J.totalConversations,userMessages:J.userMessages,aiMessages:J.aiMessages,topPromptsCount:Object.keys(J.topPrompts).length})}catch(f){console.error(`[Main] 处理文件失败: ${t.name}`,f)}if(console.log(`[Main] 总共提取 ${Z.length} 条对话记录`),0===Z.length)throw ve=!1,new Error("未找到任何对话数据，请检查数据库文件是否正确");if(console.log("[Main] 开始重新计算统计（包括词云数据）..."),h){const e=ne(),t=(null==(i=window.i18n)?void 0:i.getText("upload.logs.calculatingStats",e))||"计算统计数据...";h(`> ${t}`)}if(function(e){console.log("[Main] 开始计算统计...");const t=(null==J?void 0:J.earliestFileTime)||null;J={totalConversations:0,modelUsage:{},userMessages:0,aiMessages:0,hourlyActivity:new Array(24).fill(0),dailyActivity:{},topPrompts:{},qingCount:0,buCount:0,topChineseWords:{},chineseWords:{},chineseEmotionWords:{},englishWords:{},totalCodeChars:0,earliestFileTime:t,userBehaviorStats:{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,techStack:{}}},e.forEach(e=>{if("USER"===e.role?J.userMessages++:(J.aiMessages++,J.totalConversations++),e.text&&e.text.length>0&&"USER"!==e.role){const t=e.text.match(/```[\s\S]*?```/g);t&&t.forEach(e=>{const t=e.replace(/```[\w]*\n?/g,"").replace(/```/g,"").length;t>0&&(J.totalCodeChars+=t,console.log(`[Main] [AI] 代码块 +${t} 字符，总计: ${J.totalCodeChars}`))});const n=e.text.match(/`[^`\n]+`/g);if(n&&n.forEach(e=>{const t=e.replace(/`/g,"").length;t>0&&(J.totalCodeChars+=t,console.log(`[Main] [AI] 行内代码 +${t} 字符，总计: ${J.totalCodeChars}`))}),!t&&!n){const t=[/\b(function|class|const|let|var|if|else|for|while|do|switch|case|break|continue|return|import|export|from|async|await|yield|try|catch|finally|throw|new|this)\b/i,/\b(public|private|protected|static|final|abstract|interface|extends|implements|super)\b/i,/\b(def |class |import |from |if |elif |else |for |while |try |except |finally |return |yield |with |as |lambda |pass |break |continue )/];let n=0;for(const s of t)s.test(e.text)&&n++;const a=["def ","def\n","func ","func\n","fn ","#include","import ","#define","@","defclass ","class "];for(const s of a)if(e.text.includes(s)){n+=2;break}if(n>=3){const t=/\b(function|class|const|let|var|def |func |fn |import |#include|public|private)\b/i,a=e.text.match(t);if(a&&void 0!==a.index){const t=a.index,s=Math.min(t+5e3,e.text.length)-t,o=Math.round(.7*s);J.totalCodeChars+=o,console.log(`[Main] [AI] 代码段（估算） +${o} 字符（代码特征=${n}），总计: ${J.totalCodeChars}`)}}}}const t=e.model||"unknown";if(J.modelUsage[t]=(J.modelUsage[t]||0)+1,console.log(`[Main] 模型使用: ${t} = ${J.modelUsage[t]}`),e.timestamp)try{const t=new Date(e.timestamp).getHours();J.hourlyActivity[t]++}catch(n){console.error("[Main] 时段统计失败:",n)}if(e.timestamp)try{const t=new Date(e.timestamp).toISOString().split("T")[0];J.dailyActivity[t]=(J.dailyActivity[t]||0)+1}catch(n){console.error("[Main] 日期统计失败:",n)}if("USER"===e.role&&e.text){const t=e.text.length;J.userBehaviorStats.totalUserChars+=t,(e.text.includes("?")||e.text.includes("？"))&&J.userBehaviorStats.questionMessageCount++;const n=e.text.match(/请/g);n&&(J.qingCount+=n.length);const a=e.text.match(/不/g);a&&(J.buCount+=a.length),function(e){const t=new Set(["的","是","在","了","我","你","他","她","它","我们","你们","他们","和","或","但是","因为","所以","如果","就","也","都","很","非常","可以","能","会","要","有","没","不","来","去","这","那","个","请","帮","写","一个","怎么","如何","什么","哪个","哪个","吗","呢","吧","啊","哦","嗯","哈","嘿","好","the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","must","to","of","in","for","on","at","by","with","from","as","into","through","during","before","after","above","below","between","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","mine","theirs","am","is","are","was","were","be","been","being","have","has","had","can","could","will","would","should","may","might","must","please","help","write","a","one","some","any","all","both","how","what","which","who","when","where","why","whether","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front","forward"]),n=/[\u4e00-\u9fa5]+|[a-zA-Z0-9]+/g,a=e.match(n)||[];a.forEach(e=>{if(e.length<2)return;if(e.length>20)return;const n=e.toLowerCase();t.has(n)||(J.topPrompts[n]=(J.topPrompts[n]||0)+1)});const s=Object.keys(J.topPrompts).length;console.log(`[Main] 提取到 ${s} 个唯一词，${a.length} 个总词`)}(e.text),function(e){if(!e||0===e.length)return;const t=new Set(["的","是","在","了","我","你","他","她","它","我们","你们","他们","和","或","但是","因为","所以","如果","就","也","都","很","非常","可以","能","会","要","有","没","不","来","去","这","那","个","请","帮","写","一个","怎么","如何","什么","哪个","吗","呢","吧","啊","哦","嗯","哈","嘿","好"]),n=/[\u4e00-\u9fa5]{2,}/g;(e.match(n)||[]).forEach(e=>{if(e.length>10)return;const n=e.trim();t.has(n)||(J.topChineseWords=J.topChineseWords||{},J.topChineseWords[n]=(J.topChineseWords[n]||0)+1)})}(e.text),function(e){if(!e||0===e.length)return;if(!J)return void console.warn("[Main] extractWordCloudData: globalStats 未初始化");const t=new Set(["的","是","在","了","我","你","他","她","它","我们","你们","他们","和","或","但是","因为","所以","如果","就","也","都","很","非常","可以","能","会","要","有","没","不","来","去","这","那","个","请","帮","写","一个","怎么","如何","什么","哪个","吗","呢","吧","啊","哦","嗯","哈","嘿","好"]),n=new Set(["the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","to","of","in","for","on","at","by","with","from","as","into","i","you","your","he","she","it","we","they","this","that","my","his","her","its","our","your","their","can","could","will","would","should","may","might","must","please","help","write","one","some","any","all","both","how","what","which","who","when","where","why","yes","no","not","just","only","also","too","very","really","okay","ok","right","left","up","down","back","front"]);J.chineseWords=J.chineseWords||{},J.chineseEmotionWords=J.chineseEmotionWords||{},J.englishWords=J.englishWords||{};const a=e.match(/[\u4e00-\u9fa5]/g)||[];for(let l=0;l<a.length-1;l++){const e=a[l]+a[l+1];if(t.has(e)||t.has(a[l])||t.has(a[l+1])||(J.chineseWords[e]=(J.chineseWords[e]||0)+1,Je(e)&&(J.chineseEmotionWords[e]=(J.chineseEmotionWords[e]||0)+2)),l<a.length-2){const e=a[l]+a[l+1]+a[l+2];t.has(e)||t.has(a[l])||t.has(a[l+1])||t.has(a[l+2])||(J.chineseWords[e]=(J.chineseWords[e]||0)+1,Je(e)&&(J.chineseEmotionWords[e]=(J.chineseEmotionWords[e]||0)+2))}}for(let l=0;l<a.length-3;l++){const e=a[l]+a[l+1]+a[l+2]+a[l+3];t.has(e)||(J.chineseWords[e]=(J.chineseWords[e]||0)+1,Je(e)&&(J.chineseEmotionWords[e]=(J.chineseEmotionWords[e]||0)+2))}const s=/\b[a-zA-Z]{2,20}\b/g,o=e.match(s)||[];o.forEach(e=>{const t=e.toLowerCase();!n.has(t)&&e.length>=2&&e.length<=20&&(J.englishWords[t]=(J.englishWords[t]||0)+1)});const i=o.map(e=>e.toLowerCase()).filter(e=>!n.has(e)&&e.length>=2&&e.length<=20);for(let l=0;l<i.length-1;l++){const e=i[l],t=i[l+1];if(!n.has(e)&&!n.has(t)){const n=e+" "+t;J.englishWords[n]=(J.englishWords[n]||0)+1}}for(let l=0;l<i.length-2;l++){const e=i[l],t=i[l+1],a=i[l+2];if(!n.has(e)&&!n.has(t)&&!n.has(a)){const n=e+" "+t+" "+a;J.englishWords[n]=(J.englishWords[n]||0)+1}}const r=J.userMessages||0;r>0&&r%100==0&&console.log(`[Main] extractWordCloudData: 已处理 ${r} 条消息，中文词组: ${Object.keys(J.chineseWords).length}，情绪类词组: ${Object.keys(J.chineseEmotionWords).length}，英文词组: ${Object.keys(J.englishWords).length}`)}(e.text)}}),J.userMessages>0&&(J.userBehaviorStats.avgUserMessageLength=Math.round(J.userBehaviorStats.totalUserChars/J.userMessages));console.log("[Main] 统计计算完成:",{totalConversations:J.totalConversations,userMessages:J.userMessages,aiMessages:J.aiMessages,totalCodeChars:J.totalCodeChars,totalUserChars:J.userBehaviorStats.totalUserChars,avgUserMessageLength:J.userBehaviorStats.avgUserMessageLength,qingCount:J.qingCount,buCount:J.buCount,modelUsageCount:Object.keys(J.modelUsage).length,topPromptsCount:Object.keys(J.topPrompts).length,hourlyNonZero:J.hourlyActivity.filter(e=>e>0).length,dailyCount:Object.keys(J.dailyActivity).length,chineseWordsCount:Object.keys(J.chineseWords||{}).length,englishWordsCount:Object.keys(J.englishWords||{}).length})}(Z),console.log("[Main] 统计计算完成，词云数据:",{chineseWords:Object.keys(J.chineseWords||{}).length,englishWords:Object.keys(J.englishWords||{}).length}),Z.length>0){if(console.log("[Main] 开始 Vibe Codinger 人格分析（使用 VibeCodingApp）..."),h){const e=ne(),t=(null==(r=window.i18n)?void 0:r.getText("upload.logs.generatingPersonality",e))||"生成人格画像（高性能匹配中）...";h(`> ${t}`)}try{te||(te=new H,await te.init()),te.analyzer=K;let e=1;if(J&&J.earliestFileTime){const t=Date.now(),n=t-J.earliestFileTime;e=Math.max(1,Math.floor(n/864e5))}const t=J?{qingCount:J.qingCount||0,buCount:J.buCount||0,usageDays:e}:null,a=e=>{h&&h(`> ${e}`),n&&n.onLog||Ie(e)};if(ve=!0,we=!0,ve=!0,Y=await te.analyzeFile(Z,t,a),console.log("[Main] Vibe Codinger 分析完成（使用 VibeCodingApp）:",Y),we=!1,ve=!1,n&&n.onLog||_e(),h){const e=ne(),t=(null==(l=window.i18n)?void 0:l.getText("upload.logs.analysisComplete",e))||"分析完成！";h(`> ${t}`)}}catch(f){if(console.error("[Main] Vibe Codinger 分析失败，使用降级方案:",f),h){const e=ne(),t=(null==(c=window.i18n)?void 0:c.getText("upload.logs.analysisFailed",e))||"分析失败，使用降级方案...";h(`> ${t}`)}we=!1,ve=!1;try{we=!0,ve=!0,te||(te=new H,await te.init()),te.analyzer=K;let e=1;if(J&&J.earliestFileTime){const t=Date.now(),n=t-J.earliestFileTime;e=Math.max(1,Math.floor(n/864e5))}const t=J?{qingCount:J.qingCount||0,buCount:J.buCount||0,usageDays:e}:null,a=e=>{h&&h(`> ${e}`),n&&n.onLog||Ie(e)};if(Y=await te.analyzeFileSync(Z,t,a),console.log("[Main] Vibe Codinger 分析完成（使用 VibeCodingApp 同步方法）:",Y),we=!1,ve=!1,n&&n.onLog||_e(),h){const e=ne(),t=(null==(d=window.i18n)?void 0:d.getText("upload.logs.analysisComplete",e))||"分析完成！";h(`> ${t}`)}}catch(v){if(console.error("[Main] 同步方法也失败:",v),we=!1,ve=!1,h){const e=ne(),t=(null==(g=window.i18n)?void 0:g.getText("upload.logs.analysisFailed",e))||"分析失败";h(`> ${t}`)}}}}p?p({stats:J,chatData:Z,vibeResult:Y}):(!function(){console.log("[Main] 显示分析结果..."),Ce.uploadSection&&Ce.uploadSection.classList.add("hidden");Ce.loadingSection&&Ce.loadingSection.classList.add("hidden");Ce.dashboardSection&&(Ce.dashboardSection.classList.remove("hidden"),Ce.dashboardSection.style.display="block");document.querySelectorAll(".stats-grid").forEach(e=>{e.classList.remove("hidden"),e.style.display="grid"});const e=document.querySelector(".wordcloud-section");e&&(e.classList.remove("hidden"),e.style.display="grid");document.querySelectorAll(".chart-card").forEach(e=>{e.classList.contains("hidden")||"techStackSection"===e.id||(e.style.display="block")});const t=document.querySelector(".chat-list-section");t&&(t.style.display="block");console.log("[Main] ✅ 分析结果已显示")}(),Le(),Y&&Ue(),ye=1,Te(Z),Ce.searchInput&&Z&&Z.length>0&&console.log("[Main] ✅ 数据加载完成，搜索功能已就绪，共",Z.length,"条记录"))}catch(f){console.error("[Main] 处理失败:",f),we=!1,ve=!1,m?m(f):(b=f.message,console.error("[Main] 上传错误:",b),Ce.uploadError&&(Ce.uploadError.textContent=b,Ce.uploadError.classList.remove("hidden")),_e())}finally{we=!1,ve=!1,window.updateUploadButtonsState&&window.updateUploadButtonsState(!1),e&&e.target&&(e.target.value="")}var b}function Ae(e,t){e.totalConversations+=t.totalConversations,e.userMessages+=t.userMessages,e.aiMessages+=t.aiMessages,e.qingCount=(e.qingCount||0)+(t.qingCount||0),e.buCount=(e.buCount||0)+(t.buCount||0),t.userBehaviorStats&&(e.userBehaviorStats=e.userBehaviorStats||{totalUserChars:0,avgUserMessageLength:0,questionMessageCount:0,codeKeywordCount:0,modifyKeywordCount:0},e.userBehaviorStats.totalUserChars+=t.userBehaviorStats.totalUserChars||0,e.userBehaviorStats.questionMessageCount+=t.userBehaviorStats.questionMessageCount||0,e.userBehaviorStats.codeKeywordCount+=t.userBehaviorStats.codeKeywordCount||0,e.userBehaviorStats.modifyKeywordCount+=t.userBehaviorStats.modifyKeywordCount||0,t.userBehaviorStats.techStack&&(e.userBehaviorStats.techStack=e.userBehaviorStats.techStack||{},Object.entries(t.userBehaviorStats.techStack).forEach(([t,n])=>{e.userBehaviorStats.techStack[t]=(e.userBehaviorStats.techStack[t]||0)+n})),e.userMessages>0&&(e.userBehaviorStats.avgUserMessageLength=Math.round(e.userBehaviorStats.totalUserChars/e.userMessages)));for(const[n,a]of Object.entries(t.modelUsage))e.modelUsage[n]=(e.modelUsage[n]||0)+a;for(let n=0;n<24;n++)e.hourlyActivity[n]+=t.hourlyActivity[n];for(const[n,a]of Object.entries(t.dailyActivity))e.dailyActivity[n]=(e.dailyActivity[n]||0)+a;for(const[n,a]of Object.entries(t.topPrompts))e.topPrompts[n]=(e.topPrompts[n]||0)+a;for(const[n,a]of Object.entries(t.topChineseWords||{}))e.topChineseWords=e.topChineseWords||{},e.topChineseWords[n]=(e.topChineseWords[n]||0)+a;if(t.chineseWords){e.chineseWords=e.chineseWords||{};for(const[n,a]of Object.entries(t.chineseWords))e.chineseWords[n]=(e.chineseWords[n]||0)+a}if(t.englishWords){e.englishWords=e.englishWords||{};for(const[n,a]of Object.entries(t.englishWords))e.englishWords[n]=(e.englishWords[n]||0)+a}}function Ie(e=null){console.log("[Main] 显示加载状态...",e||""),Ce.uploadSection.classList.add("hidden"),Ce.loadingSection.classList.remove("hidden"),Ce.dashboardSection.classList.add("hidden"),e&&Ce.loadingProgress&&(Ce.loadingProgress.textContent=e),console.log("[Main] ✅ 加载状态已显示")}function _e(){Ce.loadingSection&&Ce.loadingSection.classList.add("hidden")}function Ee(e,t){const n=`已处理 ${e}/${t} 个文件`;Ce.loadingProgress&&(Ce.loadingProgress.textContent=n),console.log(`[Main] ${n}`)}function Le(){var e;console.log("[Main] 开始显示统计信息...");try{const t={totalConversations:J.totalConversations,totalCodeChars:J.totalCodeChars,modelUsage:J.modelUsage,userMessages:J.userMessages,qingCount:J.qingCount||0,buCount:J.buCount||0,topChineseWordsList:Pe(J.topChineseWords,10)};console.log("[Main] 统计数据:",{totalConversations:t.totalConversations,totalCodeChars:t.totalCodeChars,userMessages:t.userMessages,qingCount:t.qingCount,buCount:t.buCount,topChineseWordsList:(null==(e=t.topChineseWordsList)?void 0:e.length)||0}),console.log('[Main] ✅ "请"字次数:',t.qingCount),console.log('[Main] ✅ "不"字次数:',t.buCount);let n=0;if(J.earliestFileTime){const e=Date.now(),t=J.earliestFileTime,a=e-t;n=Math.floor(a/864e5),console.log("[Main] 使用时长计算:",{earliestTime:new Date(t).toISOString(),nowTime:new Date(e).toISOString(),diffMs:a,usageDays:n})}if(Se.totalConversations&&(Se.totalConversations.textContent=De(n)),Se.qingCount&&(Se.qingCount.textContent=De(t.qingCount)),Se.buCount&&(Se.buCount.textContent=De(t.buCount)),Se.userMessages&&(Se.userMessages.textContent=De(t.userMessages)),J.userBehaviorStats){const e=J.userBehaviorStats;Se.totalUserChars&&(Se.totalUserChars.textContent=De(e.totalUserChars||0)),Se.avgUserMessageLength&&(Se.avgUserMessageLength.textContent=De(e.avgUserMessageLength||0));const t=document.getElementById("questionCard");t&&e.questionMessageCount>0&&(t.style.display="",Se.questionMessageCount&&(Se.questionMessageCount.textContent=De(e.questionMessageCount))),function(e){const t=document.getElementById("techStackSection"),n=document.getElementById("techStackList");if(!t||!n)return;const a=Object.entries(e);if(0===a.length)return void(t.style.display="none");const s=a.sort((e,t)=>t[1]-e[1]).slice(0,10);if(0===s.length)return void(t.style.display="none");t.style.display="",n.innerHTML=s.map(([e,t],n)=>`\n    <div class="prompt-item">\n      <span class="prompt-rank">#${n+1}</span>\n      <span class="prompt-text">${Be(e)}</span>\n      <span class="prompt-count">${t} 次</span>\n    </div>\n  `).join("")}(e.techStack||{})}console.log("[Main] 准备渲染词云，数据状态:",{chineseWords:Object.keys(J.chineseWords||{}).length,englishWords:Object.keys(J.englishWords||{}).length}),Ke(),console.log("[Main] 开始渲染用户提问最多汉字词组..."),function(e){console.log("[Main] 开始渲染用户提问最多汉字词组...");const t=Se.topChineseWordsList||document.getElementById("topChineseWordsList");if(!t)return void console.warn("[Main] topChineseWordsList 容器未找到");if(!e||0===e.length)return t.innerHTML='\n      <div class="prompt-item">\n        <span class="prompt-text">暂无汉字词组数据</span>\n        <span class="prompt-count">0 次</span>\n      </div>\n    ',void console.log("[Main] 没有汉字词组数据");console.log(`[Main] 共有 ${e.length} 个汉字词组`),e.forEach((e,t)=>{console.log(`  #${t+1} "${e.word}" ${e.count} 次`)}),t.innerHTML=e.map((e,t)=>`\n    <div class="prompt-item">\n      <span class="prompt-rank">#${t+1}</span>\n      <span class="prompt-text">${Be(e.word)}</span>\n      <span class="prompt-count">${e.count} 次</span>\n    </div>\n  `).join(""),console.log("[Main] ✅ 汉字词组渲染完成")}(t.topChineseWordsList),console.log("[Main] ✅ 统计信息显示完成")}catch(t){throw console.error("[Main] ❌ 显示统计信息失败:",t),t}}function De(e,t=null){if("number"!=typeof e||isNaN(e))return"0";t||(t=ne());return"en"===t?e>=1e12?(e/1e12).toFixed(1)+"T":e>=1e9?(e/1e9).toFixed(1)+"B":e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString():e>=1e12?(e/1e12).toFixed(1)+"万亿":e>=1e11?(e/1e11).toFixed(1)+"千亿":e>=1e10?(e/1e10).toFixed(1)+"百亿":e>=1e8?(e/1e8).toFixed(1)+"亿":e>=1e7?(e/1e7).toFixed(1)+"千万":e>=1e6?(e/1e6).toFixed(1)+"百万":e>=1e4?(e/1e4).toFixed(1)+"万":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}function Pe(e,t=10){const n=Object.entries(e||{});return 0===n.length?[]:n.sort((e,t)=>t[1]-e[1]).slice(0,t).map(([e,t])=>({word:e,count:t}))}function Te(e){console.log(`[Main] 渲染对话列表，共 ${e.length} 条记录`),fe=e;const t=Ce.chatList,n=Math.ceil(e.length/be);ye>n&&n>0&&(ye=n),ye<1&&(ye=1);const a=(ye-1)*be,s=a+be,o=e.slice(a,s);if(console.log(`[Main] 显示第 ${ye}/${n} 页，共 ${o.length} 条记录`),0===o.length)return t.innerHTML='\n      <div class="chat-item-more">\n        暂无对话记录\n      </div>\n    ',void(Ce.paginationContainer&&(Ce.paginationContainer.style.display="none"));try{t.innerHTML=o.map((e,t)=>{if(!e)return console.warn(`[Main] item ${t} 为 null，跳过`),"";const n=e.text||"",a=e.role||"AI",s=e.timestamp||(new Date).toISOString();return 0===n.length?(console.warn(`[Main] item ${t} 的文本为空，跳过`),""):`\n        <div class="chat-item">\n          <div class="chat-item-header">\n            <span class="chat-role ${"USER"===a?"role-user":"role-ai"}">\n              <span style="color: var(--accent-terminal);">${"USER"===a?">":"$"}</span> ${a}\n            </span>\n            <span class="chat-time">${function(e){const t=new Date(e);return t.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}(s)}</span>\n          </div>\n          <div class="chat-item-content">\n            <p>${Be(n.substring(0,200))}${n.length>200?"...":""}</p>\n          </div>\n        </div>\n      `}).join(""),function(e,t){var n;if(!Ce.paginationContainer||!Ce.paginationInfo||!Ce.paginationPages)return;if(t<=1)return void(Ce.paginationContainer.style.display="none");Ce.paginationContainer.style.display="flex";const a=(ye-1)*be+1,s=Math.min(ye*be,e),o=ne(),i=(null==(n=window.i18n)?void 0:n.getText("chatList.paginationInfo",o))||"第 {currentPage} 页，共 {totalPages} 页（共 {totalItems} 条记录，显示 {startItem}-{endItem} 条）";Ce.paginationInfo.textContent=i.replace("{currentPage}",ye).replace("{totalPages}",t).replace("{totalItems}",e).replace("{startItem}",a).replace("{endItem}",s),Ce.paginationPrev&&(Ce.paginationPrev.disabled=1===ye);Ce.paginationNext&&(Ce.paginationNext.disabled=ye===t);const r=Ce.paginationPages;r.innerHTML="";let l=Math.max(1,ye-2),c=Math.min(t,ye+2);ye<=3&&(c=Math.min(5,t));ye>=t-2&&(l=Math.max(1,t-4));if(l>1){const e=document.createElement("button");if(e.className="pagination-page-btn",e.textContent="1",e.addEventListener("click",()=>{ye=1,Te(fe)}),r.appendChild(e),l>2){const e=document.createElement("span");e.className="pagination-ellipsis",e.textContent="...",r.appendChild(e)}}for(let d=l;d<=c;d++){const e=document.createElement("button");e.className="pagination-page-btn",d===ye&&e.classList.add("active"),e.textContent=d,e.addEventListener("click",()=>{ye=d,Te(fe)}),r.appendChild(e)}if(c<t){if(c<t-1){const e=document.createElement("span");e.className="pagination-ellipsis",e.textContent="...",r.appendChild(e)}const e=document.createElement("button");e.className="pagination-page-btn",e.textContent=t,e.addEventListener("click",()=>{ye=t,Te(fe)}),r.appendChild(e)}}(e.length,n),console.log("[Main] ✅ 对话列表渲染完成")}catch(i){console.error("[Main] ❌ 渲染对话列表失败:",i),t.innerHTML=`\n      <div class="chat-item-more">\n        对话列表加载失败：${i.message}\n      </div>\n    `,Ce.paginationContainer&&(Ce.paginationContainer.style.display="none")}}function $e(e){if(!e||!e.target)return void console.warn("[Main] ⚠️ handleSearch 事件对象无效");const t=e.target.value.trim();if(console.log("[Main] 🔍 搜索触发:",{keyword:t,allChatDataLength:(null==Z?void 0:Z.length)||0,filteredChatDataLength:(null==fe?void 0:fe.length)||0,allChatDataExists:!!Z,isArray:Array.isArray(Z)}),ye=1,!t){const e=Z&&Z.length>0?Z:fe;return console.log("[Main] 🔍 清空搜索，显示所有数据:",e.length,"条"),void Te(e)}const n=Z&&Z.length>0?Z:fe;if(!n||!Array.isArray(n)||0===n.length)return console.warn("[Main] ⚠️ 搜索数据源为空，无法执行搜索"),void Te([]);const a=t.toLowerCase();let s=0;const o=n.filter((e,t)=>{var n,o;if(!e)return!1;const i=e.text||e.content||(null==(n=e.message)?void 0:n.text)||(null==(o=e.message)?void 0:o.content)||"";if(!i||"string"!=typeof i)return!1;const r=i.toLowerCase().includes(a);return r&&s<3&&(console.log(`[Main] 🔍 匹配项 ${s+1}:`,{index:t,textPreview:i.substring(0,50)+"...",role:e.role||"unknown"}),s++),r});console.log(`[Main] 🔍 搜索关键词: "${t}", 从 ${n.length} 条记录中找到 ${o.length} 条匹配记录`),0===o.length&&(console.log("[Main] 🔍 未找到匹配记录，可能的原因："),console.log("  - 关键词拼写错误"),console.log("  - 数据源为空或格式不正确"),console.log("  - 文本字段不存在"),n.length>0&&console.log("[Main] 🔍 数据源示例（前3条）:",n.slice(0,3).map((e,t)=>({index:t,hasText:!!e.text,hasContent:!!e.content,hasMessage:!!e.message,textPreview:(e.text||e.content||"").substring(0,30),keys:Object.keys(e)})))),Te(o)}async function Re(){const e=Ce.exportArea;try{let t=document.querySelector('[data-v6-key="answer_text"]'),n=t&&t.textContent&&""!==t.textContent.trim();if(!n){console.log("[Main] ⏳ 等待后端数据（答案之书文案）...");Ce.exportBtn.innerHTML;Ce.exportBtn.innerHTML='<span class="btn-icon">⏳</span><span>等待数据中...</span>',Ce.exportBtn.disabled=!0;let e=0;const a=50;for(;!n&&e<a;)if(await new Promise(e=>setTimeout(e,100)),e++,t=document.querySelector('[data-v6-key="answer_text"]'),n=t&&t.textContent&&""!==t.textContent.trim(),n){console.log("[Main] ✅ 后端数据已就绪");break}e>=a&&console.warn("[Main] ⚠️ 等待后端数据超时，继续导出（可能缺少答案之书文案）")}const a=Ce.exportBtn.innerHTML;Ce.exportBtn.innerHTML='<span class="btn-icon">⏳</span><span>生成中...</span>',Ce.exportBtn.disabled=!0,await new Promise(e=>setTimeout(e,200)),te&&Y&&Y.stats&&("function"==typeof te.renderBehaviorTags&&te.renderBehaviorTags(Y.stats,"behavior-tags-container"),"function"==typeof te.syncGlobalStats&&te.globalStatsCache&&te.syncGlobalStats(te.globalStatsCache)),await new Promise(e=>setTimeout(e,100));const s=window.html2canvas||globalThis.html2canvas;if(!s)throw new Error("html2canvas 未加载，请确保 CDN 资源已正确加载");const o=await s(e,{backgroundColor:"#ffffff",scale:2,useCORS:!0,logging:!1}),i=document.createElement("a");i.download=`cursor-audit-${(new Date).getTime()}.png`,i.href=o.toDataURL("image/png"),i.click(),Ce.exportBtn.innerHTML=a,Ce.exportBtn.disabled=!1,console.log("[Main] 导出成功")}catch(t){console.error("[Main] 导出失败:",t),alert("导出失败: "+t.message),Ce.exportBtn.innerHTML='<span class="btn-icon">📊</span><span>晒出cursor受虐证据</span>',Ce.exportBtn.disabled=!1}}function Be(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function Ne(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...a)},t)}}function Ue(){if(fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2179",message:"displayVibeCodingerAnalysis called",data:{vibeResultExists:!!Y,vibeResultKeys:Y?Object.keys(Y):null},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),!Y)return void fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2180",message:"vibeResult is null/undefined, returning early",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"B"})}).catch(()=>{});const e=document.getElementById("vibeCodingerSection")||document.getElementById("personality-lock");if(fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2183",message:"container lookup",data:{containerFound:!!e,containerId:null==e?void 0:e.id,hasVibeCodingerSection:!!document.getElementById("vibeCodingerSection"),hasPersonalityLock:!!document.getElementById("personality-lock")},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"})}).catch(()=>{}),!e)return void fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2184",message:"container not found, returning early",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"C"})}).catch(()=>{});const{personalityType:t,dimensions:n,analysis:a,semanticFingerprint:s,statistics:o,vibeIndex:i,roastText:r,personalityName:l,stats:c}=Y;let d=Y.lpdef;if(!d&&n&&K&&"function"==typeof K.generateLPDEF)try{d=K.generateLPDEF(n),console.log("[Main] ✅ 从 analyzer.generateLPDEF 获取 LPDEF:",d)}catch(h){console.warn("[Main] generateLPDEF 调用失败:",h),d="L0P0D0E0F0"}else d||(d="L0P0D0E0F0");let g=s;if((!g||!g.codeRatio||!g.patienceLevel)&&(console.log("[Main] ⚠️ semanticFingerprint 不完整，使用前端生成"),n&&K&&"function"==typeof K.generateSemanticFingerprint))try{g=K.generateSemanticFingerprint(n),console.log("[Main] ✅ 从 analyzer.generateSemanticFingerprint 获取完整语义指纹")}catch(h){console.warn("[Main] generateSemanticFingerprint 调用失败:",h)}g||(g={codeRatio:"0%",patienceLevel:"N/A",detailLevel:"N/A",techExploration:"N/A",feedbackDensity:"0%",compositeScore:0,techDiversity:"N/A",interactionStyle:"N/A"});const u=c||o||{};u.ketao_count||u.qingCount,u.jiafang_count||u.buCount,u.work_days||u.usageDays;e.innerHTML=`\n    <div class="vibe-header">\n      <h2 class="vibe-title">${ae("vibeCodinger.title")}</h2>\n      <div class="vibe-badge" style="background: transparent; border: 2px solid var(--accent-terminal);">\n        <span class="vibe-type">${t}</span>\n        <span class="vibe-name">${l||a.name}</span>\n      </div>\n      <p class="vibe-description">${a.description}</p>\n    </div>\n\n    \x3c!-- 新增：人格头衔和吐槽区域 --\x3e\n    <div class="vibe-roast-section">\n      <div class="roast-header">\n        <h3 class="roast-title">${ae("vibeCodinger.roastTitle")}</h3>\n        <div class="personality-title">${(e=>{var t,n,a,s,o,i;const r="en"===ne()?null==(a=null==(n=null==(t=window.i18n)?void 0:t.getI18nText("en"))?void 0:n.vibeCodinger)?void 0:a.personalityTitles:null==(i=null==(o=null==(s=window.i18n)?void 0:s.getI18nText("zh-CN"))?void 0:o.vibeCodinger)?void 0:i.personalityTitles;if(!r){return`${"2"===e[0]?"硬核":"1"===e[0]?"标准":"随性"}·${"2"===e[1]?"耐心":"1"===e[1]?"平衡":"急躁"}·${"2"===e[2]?"细节控":"1"===e[2]?"适中":"极简"}·${"2"===e[3]?"探索者":"1"===e[3]?"观望":"守旧"}·${"2"===e[4]?"暖男":"1"===e[4]?"职业":"冷酷"}`}return`${"2"===e[0]?r.l[2]:"1"===e[0]?r.l[1]:r.l[0]}·${"2"===e[1]?r.p[2]:"1"===e[1]?r.p[1]:r.p[0]}·${"2"===e[2]?r.d[2]:"1"===e[2]?r.d[1]:r.d[0]}·${"2"===e[3]?r.e[2]:"1"===e[3]?r.e[1]:r.e[0]}·${"2"===e[4]?r.f[2]:"1"===e[4]?r.f[1]:r.f[0]}`})(i)}</div>\n        <div class="vibe-index">${"en"===ne()?`${ae("vibeCodinger.lpdef")}: ${d||"N/A"}`:`${ae("vibeCodinger.index")}: ${i} | ${ae("vibeCodinger.lpdef")}: ${d||"N/A"}`}</div>\n      </div>\n      <div class="roast-content">\n        <p class="roast-text">${r}</p>\n      </div>\n      <div class="dimension-tags">\n        ${(e=>{const t=[],n=ne();return Object.entries(e).forEach(([e,a])=>{var s,o,i,r,l,c,d,g,u,h;let p;const m=null==(i=null==(o=null==(s=window.i18n)?void 0:s.getI18nText(n))?void 0:o.dimensions)?void 0:i[e];p="E"===e?a<5?(null==(r=null==m?void 0:m.levels)?void 0:r.low)||"低":a<10?(null==(l=null==m?void 0:m.levels)?void 0:l.medium)||"中":(null==(c=null==m?void 0:m.levels)?void 0:c.high)||"高":a<40?(null==(d=null==m?void 0:m.levels)?void 0:d.low)||"低":a<70?(null==(g=null==m?void 0:m.levels)?void 0:g.medium)||"中":(null==(u=null==m?void 0:m.levels)?void 0:u.high)||"高";const y=(null==m?void 0:m.label)||(null==(h=window.i18n)?void 0:h.getText(`dimensions.${e}.label`,n))||P[e].label;t.push(`${y}:${p}`)}),t})(n).map(e=>`\n          <span class="dimension-tag">${e}</span>\n        `).join("")}\n      </div>\n    </div>\n\n    <div class="vibe-dimensions">\n      <h3 class="dimensions-title">${ae("vibeCodinger.dimensionsTitle")}</h3>\n      ${Object.entries(n).map(([e,t])=>{var n,s,o,i,r,l,c,d,g;const u=((null==(n=Y.personality)?void 0:n.detailedStats)||Y.detailedStats||[]).find(t=>t.dimension===e),h=u?{level:u.label||"未知",interpretation:u.roast||"暂无吐槽文案"}:a.dimensions[e]||{level:"未知",interpretation:"暂无吐槽文案"},p=t,m=(null==(r=null==(i=null==(o=null==(s=window.i18n)?void 0:s.getI18nText(ne()))?void 0:o.dimensions)?void 0:i[e])?void 0:r.label)||P[e].label,y=(null==(g=null==(d=null==(c=null==(l=window.i18n)?void 0:l.getI18nText(ne()))?void 0:c.dimensions)?void 0:d[e])?void 0:g.description)||P[e].description;return`\n          <div class="dimension-card" data-v6-dim="${e}">\n            <div class="dimension-header">\n              <span class="dimension-key">${e}</span>\n              <span class="dimension-label">${m}</span>\n              <span class="dimension-value">${t}</span>\n              <span class="dimension-level rank-label">${h.level}</span>\n            </div>\n            <div class="dimension-bar-container">\n              <div class="dimension-bar" style="width: ${p}%; background: var(--accent-terminal)"></div>\n            </div>\n            <p class="dimension-interpretation roast-text">${h.interpretation}</p>\n            <p class="dimension-desc">${y}</p>\n          </div>\n        `}).join("")}\n    </div>\n\n    <div class="vibe-traits" id="personality-traits" style="scroll-margin-top: 80px;">\n      <h3 class="traits-title">${ae("vibeCodinger.traitsTitle")}</h3>\n      <div class="traits-list">\n        ${a.traits.map(e=>`\n          <div class="trait-tag">${e}</div>\n        `).join("")}\n      </div>\n    </div>\n\n    <div class="vibe-fingerprint" id="semantic-fingerprint" style="scroll-margin-top: 80px;">\n      <h3 class="fingerprint-title">${ae("vibeCodinger.fingerprintTitle")}</h3>\n      <div class="fingerprint-grid">\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ae("fingerprint.codeRatio")}</span>\n          <span class="fingerprint-value">${g.codeRatio||"N/A"}</span>\n          ${g.codeRatioDesc?`<span class="fingerprint-desc">${g.codeRatioDesc}</span>`:""}\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ae("fingerprint.patienceLevel")}</span>\n          <span class="fingerprint-value">${g.patienceLevel||"N/A"}</span>\n          ${g.patienceLevelDesc?`<span class="fingerprint-desc">${g.patienceLevelDesc}</span>`:""}\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ae("fingerprint.detailLevel")}</span>\n          <span class="fingerprint-value">${g.detailLevel||"N/A"}</span>\n          ${g.detailLevelDesc?`<span class="fingerprint-desc">${g.detailLevelDesc}</span>`:""}\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ae("fingerprint.techExploration")}</span>\n          <span class="fingerprint-value">${g.techExploration||"N/A"}</span>\n          ${g.techExplorationDesc?`<span class="fingerprint-desc">${g.techExplorationDesc}</span>`:""}\n        </div>\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ae("fingerprint.feedbackDensity")}</span>\n          <span class="fingerprint-value">${g.feedbackDensity||"N/A"}</span>\n          ${g.feedbackDensityDesc?`<span class="fingerprint-desc">${g.feedbackDensityDesc}</span>`:""}\n        </div>\n        ${void 0!==g.compositeScore?`\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ae("fingerprint.score")}</span>\n          <span class="fingerprint-value">${g.compositeScore}</span>\n          ${g.compositeScoreDesc?`<span class="fingerprint-desc">${g.compositeScoreDesc}</span>`:""}\n        </div>\n        `:""}\n        ${g.techDiversity?`\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ae("fingerprint.diversity")}</span>\n          <span class="fingerprint-value">${g.techDiversity}</span>\n          ${g.techDiversityDesc?`<span class="fingerprint-desc">${g.techDiversityDesc}</span>`:""}\n        </div>\n        `:""}\n        ${g.interactionStyle?`\n        <div class="fingerprint-item">\n          <span class="fingerprint-label">${ae("fingerprint.style")}</span>\n          <span class="fingerprint-value">${g.interactionStyle}</span>\n          ${g.interactionStyleDesc?`<span class="fingerprint-desc">${g.interactionStyleDesc}</span>`:""}\n        </div>\n        `:""}\n      </div>\n    </div>\n\n\n    \x3c!-- 【V6 UI 渲染引擎升级】稳定性勋章 --\x3e\n    ${void 0!==(null==u?void 0:u.balance_score)?`\n    <div class="balance-score-section" id="balance-score-section" style="scroll-margin-top: 80px; margin-top: 20px;">\n      <h3 class="balance-score-title">${"en"===ne()?"Personality Stability":"人格稳定性"}</h3>\n      <div class="balance-score-progress-container">\n        <div class="balance-score-progress-bar" style="width: ${Math.min(100,Math.max(0,u.balance_score||0))}%; background: linear-gradient(90deg, var(--accent-terminal), #4CAF50); height: 30px; border-radius: 15px; transition: width 0.5s ease;">\n          <span class="balance-score-text" style="line-height: 30px; padding: 0 15px; color: white; font-weight: bold;">\n            ${Math.round(u.balance_score||0)}%\n          </span>\n        </div>\n      </div>\n    </div>\n    `:""}\n\n    <div class="vibe-chart-container" id="radar-chart" style="scroll-margin-top: 80px;">\n      <h3 class="chart-title">${ae("vibeCodinger.chartTitle")}</h3>\n      <div class="chart-wrapper">\n        <canvas id="vibeRadarChart"></canvas>\n      </div>\n    </div>\n  `,setTimeout(()=>{te&&"function"==typeof te.renderBehaviorTags&&te.renderBehaviorTags(u,"behavior-tags-container")},100),setTimeout(()=>{te&&"function"==typeof te.renderBehaviorTags&&te.renderBehaviorTags(u,"behavior-tags-container")},100),X||ee?We():(console.log("[Main] 渲染前检测到全局平均值未加载，先获取数据..."),ee=!0,ze().then(e=>{50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F||(Q=e,X=!0,console.log("[Main] ✅ 渲染前获取全局平均值成功:",Q)),ee=!1,We()}).catch(e=>{console.error("[Main] ❌ 渲染前获取全局平均值失败:",e),ee=!1,We()}))}function We(){var e,t;fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2370",message:"renderVibeRadarChart called",data:{hasVibeResult:!!Y,hasWindowChart:!!window.Chart,hasGlobalChart:!!globalThis.Chart,chartType:typeof(window.Chart||globalThis.Chart)},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{});const n=window.Chart||globalThis.Chart;if(!Y||!n)return fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2373",message:"Chart.js not loaded or vibeResult missing",data:{hasVibeResult:!!Y,hasChart:!!n},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),void console.warn("[Main] Chart.js 未加载，无法渲染雷达图");const a=document.getElementById("vibeRadarChart");if(fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2378",message:"canvas lookup",data:{canvasFound:!!a,canvasId:null==a?void 0:a.id},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{}),!a)return void fetch("http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"main.js:2379",message:"canvas not found, returning early",data:{},timestamp:Date.now(),sessionId:"debug-session",runId:"run1",hypothesisId:"A"})}).catch(()=>{});const{dimensions:s}=Y,o=a.getContext("2d");window.vibeRadarChartInstance&&window.vibeRadarChartInstance.destroy(),X||ee||(console.log("[Main] 雷达图渲染时检测到数据未加载，尝试重新获取..."),ee=!0,ze().then(e=>{50===e.L&&50===e.P&&50===e.D&&50===e.E&&50===e.F?(console.warn("[Main] ⚠️ 重新获取的数据仍是默认值"),X=!1):(Q=e,X=!0,console.log("[Main] ✅ 重新获取全局平均值成功:",Q),We()),ee=!1}).catch(e=>{console.error("[Main] ❌ 重新获取全局平均值失败:",e),X=!1,ee=!1}));50===Q.L&&50===Q.P&&50===Q.D&&50===Q.E&&50===Q.F&&!X&&(console.warn("[Main] ⚠️ 雷达图使用默认全局平均值，API 数据可能未加载成功"),console.log("[Main] 当前 globalAverageData:",Q),console.log("[Main] 当前 globalAverageDataLoaded:",X));const i=Q||Y.globalAverage||{L:50,P:50,D:50,E:50,F:50};console.log("[Main] 雷达图使用的全局平均值:",{source:X?"API":Y.globalAverage?"vibeResult":"default",data:i}),s.E,i.E;const r=ne(),l=["L","P","D","E","F"].map(e=>{var t,n,a,s;const o=null==(a=null==(n=null==(t=window.i18n)?void 0:t.getI18nText(r))?void 0:n.dimensions)?void 0:a[e];return`${(null==o?void 0:o.label)||(null==(s=P[e])?void 0:s.label)||e} (${e})`}),c=(null==(e=window.i18n)?void 0:e.getText("dashboard.radarChart.yourScore",r))||"你的得分",d=(null==(t=window.i18n)?void 0:t.getText("dashboard.radarChart.globalAverage",r))||"全网平均";window.vibeRadarChartInstance=new n(o,{type:"radar",data:{labels:l,datasets:[{label:c,data:[s.L,s.P,s.D,s.E,s.F],backgroundColor:"rgba(0, 255, 65, 0.2)",borderColor:"rgba(0, 255, 65, 1)",borderWidth:2,pointBackgroundColor:"rgba(0, 255, 65, 1)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgba(0, 255, 65, 1)",pointRadius:5,pointHoverRadius:7},{label:d,data:[i.L,i.P,i.D,i.E,i.F],backgroundColor:"rgba(113, 113, 122, 0.1)",borderColor:"rgba(113, 113, 122, 0.5)",borderWidth:1.5,borderDash:[5,5],pointBackgroundColor:"rgba(113, 113, 122, 0.5)",pointBorderColor:"rgba(113, 113, 122, 0.8)",pointHoverBackgroundColor:"rgba(113, 113, 122, 0.8)",pointHoverBorderColor:"rgba(113, 113, 122, 1)",pointRadius:3,pointHoverRadius:5}]},options:{responsive:!0,maintainAspectRatio:!0,layout:{padding:{top:20,bottom:20,left:20,right:20}},scales:{r:{beginAtZero:!0,max:100,ticks:{stepSize:20,display:!1},grid:{color:"rgba(0, 255, 65, 0.1)"},pointLabels:{font:{size:12},color:"#ffffff"}}},plugins:{legend:{display:!0,position:"top",labels:{color:"#ffffff",font:{family:"'JetBrains Mono', monospace"}}},tooltip:{callbacks:{label:function(e){return`${e.label}: ${e.parsed.r}分`}}}}}})}function je(e,t,n=e=>e.toString()){if(!e)return;let a=Number(t);(isNaN(a)||null==t)&&(console.warn("[Main] 检测到无效数值，重置为 0"),a=0);const s=parseInt(e.textContent.replace(/[^0-9]/g,""))||0,o=performance.now(),i=t=>{const r=t-o,l=Math.min(r/1500,1),c=Math.floor(s+(a-s)*((d=l)*(2-d)));var d;try{e.textContent=n(c)}catch(g){e.textContent=c.toString()}l<1&&requestAnimationFrame(i)};requestAnimationFrame(i)}const Fe="https://cursor-clinical-analysis.psterman.workers.dev/";function Oe(){if("undefined"!=typeof window){const e=window.__API_ENDPOINT__||window.API_ENDPOINT;if(e)return console.log("[Main] 从 window 对象获取 API 端点:",e),e;const t=document.querySelector('meta[name="api-endpoint"]');if(t&&t.content){const e=t.content.trim(),n=e.endsWith("/")?e:e+"/";return console.log("[Main] 从 meta 标签获取 API 端点:",n),n}}return console.log("[Main] 使用默认 API 端点:",Fe),Fe}async function ze(){const e={L:50,P:50,D:50,E:50,F:50};try{const n=Oe();let a=n.endsWith("/")?`${n}api/global-average`:`${n}/api/global-average`;try{const e=String(localStorage.getItem("anchored_country")||"").trim().toUpperCase()||String(localStorage.getItem("selected_country")||"").trim().toUpperCase();/^[A-Z]{2}$/.test(e)&&(a+=`?country_code=${encodeURIComponent(e)}`)}catch(t){}console.log("[Main] 开始获取全局平均值，URL:",a);const s=await fetch(a,{method:"GET",headers:{"Content-Type":"application/json"},mode:"cors",credentials:"omit"});if(!s.ok){const t=await s.text().catch(()=>"无法读取错误信息");return console.error("[Main] ❌ API 请求失败:",{status:s.status,statusText:s.statusText,error:t}),e}const o=await s.json();if(console.log("[Main] API 返回数据:",o),"success"===o.status&&o.globalAverage){const e=o.globalAverage;if("number"==typeof e.L&&"number"==typeof e.P&&"number"==typeof e.D&&"number"==typeof e.E&&"number"==typeof e.F)return Q=e,X=!0,console.log("[Main] ✅ 成功获取全局平均值:",e),e;console.warn("[Main] ⚠️ 全局平均值数据格式不正确:",e)}else console.warn("[Main] ⚠️ API 返回状态不是 success 或缺少 globalAverage:",o)}catch(n){console.error("[Main] ❌ 获取全局平均值异常:",{message:n.message,stack:n.stack,name:n.name})}return console.warn("[Main] ⚠️ 使用默认全局平均值"),e}function Ve(e){const t=new AbortController,n=setTimeout(()=>t.abort(),e);return"undefined"!=typeof AbortSignal&&AbortSignal.timeout?(clearTimeout(n),AbortSignal.timeout(e)):t.signal}async function qe(e=!1){const t=Oe();try{const n=await async function(e,t={}){const n={...t,mode:"cors",credentials:"omit",headers:{"Content-Type":"application/json",...t.headers}};console.log("[Main] 发起 CORS 请求:",{url:e,method:n.method||"GET"});try{const t=await fetch(e,n);if(!t.ok&&0===t.status)throw new Error("CORS 错误：无法访问远程 API。请检查 API 端点的 CORS 配置。");return t}catch(a){throw console.error("[Main] CORS 请求失败:",a),a}}(t,{method:e?"POST":"GET",body:e?JSON.stringify({action:"increment",timestamp:Date.now()}):void 0,signal:Ve(5e3)});if(n.ok){const t=await n.json(),a=t.value||t.totalUsers||t.total||t.count||null;if(null!==a&&a>=0){console.log(`[Main] ${e?"POST":"GET"} 请求成功，数字:`,a),localStorage.setItem("totalTestUsers",a.toString());const t=document.getElementById("totalTestUsers");return t&&(e?je(t,a,De):t.textContent=De(a)),a}}else console.warn(`[Main] ${e?"POST":"GET"} 请求响应状态码异常:`,n.status)}catch(s){console.warn(`[Main] ${e?"POST":"GET"} 请求失败，使用降级方案:`,s.message)}const n=parseInt(localStorage.getItem("totalTestUsers")||"0"),a=document.getElementById("totalTestUsers");return a&&(a.textContent=De(n)),console.log("[Main] 使用降级值:",n),n}async function He(){return await qe(!1)}async function Ge(){return await qe(!0)}const Ze={positive:new Set(["开心","高兴","快乐","愉快","兴奋","满意","满足","喜欢","爱","感谢","谢谢","太好了","完美","优秀","很棒","不错","很好","厉害","赞","棒","赞","成功","顺利","正确","准确","清晰","明白","理解","懂了","好的","可以","惊喜","惊喜","感动","温暖","舒服","轻松","舒服","爽","爽快","太好了","完美","优秀","很棒","不错","很好","厉害","赞","棒"]),negative:new Set(["生气","愤怒","烦躁","焦虑","担心","害怕","恐惧","紧张","压力","累","失望","沮丧","难过","伤心","痛苦","难受","不舒服","不爽","烦","烦人","错误","不对","不对","错了","失败","失败","不行","不能","不可以","不行","困惑","迷茫","不懂","不明白","不清楚","模糊","混乱","乱","糟糕","糟糕","麻烦","困难","难","复杂","复杂","慢","慢","卡","卡顿","崩溃","崩溃","垃圾","差","差劲","烂","烂","破","破","坏","坏","差","差"]),neutral:new Set(["思考","考虑","想","想想","看看","试试","试试","尝试","尝试","疑问","疑问","问题","问题","为什么","怎么","如何","什么","哪个","可能","也许","大概","应该","需要","想要","希望","期待","注意","注意","小心","小心","提醒","提醒","记得","记得"]),intensity:new Set(["非常","很","特别","极其","超级","超","太","太","最","最","一点","稍微","有点","有点","稍微","稍微","不太","不太"])};function Je(e){if(Ze.positive.has(e)||Ze.negative.has(e)||Ze.neutral.has(e)||Ze.intensity.has(e))return!0;for(const t of Object.values(Ze))for(const n of t)if(e.includes(n)&&e.length<=4)return!0;return!1}function Ke(){var e;if("undefined"==typeof WordCloud)return void console.warn("[Main] WordCloud库未加载");console.log("[Main] 开始渲染词云...");const t=Object.keys(J.chineseEmotionWords||{}).length,n=Object.keys(J.chineseWords||{}).length,a=Object.keys(J.englishWords||{}).length;console.log("[Main] 情绪类词组数据:",t),console.log("[Main] 中文词组数据:",n),console.log("[Main] 英文词组数据:",a);const s=document.getElementById("chineseWordCloud");if(s)if(J.chineseEmotionWords&&0!==t){const e=50,t=120,n=Object.entries(J.chineseEmotionWords).filter(([e,t])=>t>0&&e.length>=2).sort((e,t)=>t[1]-e[1]),a=Math.max(e,Math.min(t,n.length)),o=n.slice(0,a).map(([e,t])=>[e,t]);if(console.log("[Main] AI情绪词云数据（已排序）:",o.length),o.length>0&&console.log("[Main] AI情绪词云Top 10:",o.slice(0,10).map(([e,t])=>`${e}(${t})`).join(", ")),o.length>0)try{const e=s.parentElement,t=e?e.offsetWidth:400,n=e?e.offsetHeight:400;s.width=t,s.height=n;const a=s.getContext("2d");a&&a.clearRect(0,0,t,n);const i=Math.max(...o.map(([e,t])=>t)),r=["#e74c3c","#f39c12","#e67e22","#c0392b","#d35400","#e74c3c","#f39c12","#9b59b6","#1abc9c","#16a085"],l=function(e,t,n,a,s){const o=Math.floor(Math.random()*r.length);return r[o]};WordCloud(s,{list:o,gridSize:Math.round(Math.max(8,Math.min(12,t/40))),weightFactor:function(e){return 10+Math.sqrt(e)/Math.sqrt(i)*(Math.min(45,t/10)-10)},fontFamily:'"Microsoft YaHei", "微软雅黑", "SimHei", "黑体", sans-serif',color:l,rotateRatio:.6,backgroundColor:"transparent",minSize:10,drawOutOfBound:!1,shrinkToFit:!1,ellipticity:.8}),console.log("[Main] ✅ AI情绪词云渲染完成")}catch(i){console.error("[Main] AI情绪词云渲染失败:",i),console.error("[Main] 错误详情:",i.stack)}else console.warn("[Main] AI情绪词云数据为空（过滤后）")}else{console.warn("[Main] AI情绪词云数据为空");const e=s.parentElement;e&&(e.innerHTML='<div style="padding: 20px; text-align: center; color: #999;">暂无AI情绪数据</div>')}else console.warn("[Main] AI情绪词云canvas未找到");const o=document.getElementById("englishWordCloud");if(o){const t={};try{const e=Y||window.vibeResult||globalThis.vibeResult;if(e&&e.stats){const n=e.stats.blackword_hits||{},a=n.chinese_slang||{},s=n.english_slang||{},o=[...Object.entries(a).map(([e,t])=>({word:e,count:t,type:"chinese"})),...Object.entries(s).map(([e,t])=>({word:e,count:t,type:"english"}))].reduce((e,{word:t,count:n,type:a})=>(t&&"number"==typeof n&&n>0&&(e[t]=(e[t]||0)+2*n),e),{});Object.entries(o).forEach(([e,n])=>{t[e]=(t[e]||0)+n}),(Object.keys(a).length>0||Object.keys(s).length>0)&&console.log("[Main] ✅ 已合并黑话数据到词云（显式合并）:",{chineseSlang:Object.keys(a).length,englishSlang:Object.keys(s).length,mergedCount:Object.keys(o).length})}}catch(i){console.warn("[Main] 黑话合并失败（已降级）:",i)}try{const e=Y||window.vibeResult||globalThis.vibeResult;if(e&&e.stats){const n=e.stats.tech_stack;if(n){let e=n;if("string"==typeof n)try{e=JSON.parse(n)}catch(r){console.warn("[Main] tech_stack JSON 解析失败:",r),e={}}"object"!=typeof e||null===e||Array.isArray(e)||(Object.entries(e).forEach(([e,n])=>{e&&"number"==typeof n&&n>0&&(t[e]=(t[e]||0)+8*n)}),console.log("[Main] ✅ 已添加 tech_stack 数据到词云，共",Object.keys(e).length,"项技术"))}}}catch(i){console.warn("[Main] 获取 tech_stack 数据时出错（已降级）:",i)}if(G&&"function"==typeof G.getTopChineseWords)try{const e=G.getTopChineseWords(50);e.forEach(({word:e,count:n})=>{e&&n>0&&(J.chineseEmotionWords&&J.chineseEmotionWords[e]||(t[e]=(t[e]||0)+5*n))}),console.log("[Main] ✅ 已添加 parser.getTopChineseWords() 数据到词云（权重*5），共",e.length,"个词组")}catch(i){console.warn("[Main] parser.getTopChineseWords() 调用失败:",i),J.chineseWords&&Object.entries(J.chineseWords).forEach(([e,n])=>{J.chineseEmotionWords&&J.chineseEmotionWords[e]||(t[e]=(t[e]||0)+5*n)})}else J.chineseWords&&Object.entries(J.chineseWords).forEach(([e,n])=>{J.chineseEmotionWords&&J.chineseEmotionWords[e]||(t[e]=(t[e]||0)+5*n)});J.englishWords&&Object.entries(J.englishWords).forEach(([e,n])=>{t[e]=(t[e]||0)+n});if(0===Object.keys(t).length){console.warn("[Main] 合并词云数据为空");const e=o.parentElement;e&&(e.innerHTML='<div style="padding: 20px; text-align: center; color: #999;">暂无词云数据</div>')}else{const n=100,a=200,s=Object.entries(t).filter(([e,t])=>t>0&&e.length>=2).sort((e,t)=>t[1]-e[1]),l=Math.max(n,Math.min(a,s.length)),c=s.slice(0,l).map(([e,t])=>[e,t]);if(console.log("[Main] 合并词云数据（已排序）:",c.length),c.length>0&&console.log("[Main] 合并词云Top 10:",c.slice(0,10).map(([e,t])=>`${e}(${t})`).join(", ")),c.length>0)try{const t=o.parentElement,n=t?t.offsetWidth:400,a=t?t.offsetHeight:400;o.width=n,o.height=a;const s=o.getContext("2d");s&&s.clearRect(0,0,n,a);const i=Math.max(...c.map(([e,t])=>t)),l={};try{const t=Y||window.vibeResult||globalThis.vibeResult;(null==(e=null==t?void 0:t.stats)?void 0:e.tech_stack)&&"object"==typeof t.stats.tech_stack&&Object.keys(t.stats.tech_stack).forEach(e=>{l[e]=!0})}catch(r){console.warn("[Main] 构建 techStackMap 失败:",r)}const d=function(e,t,n,a,s){if(l[e])return"#00D4FF";const o=["#2c3e50","#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#34495e","#16a085"];return o[Math.floor(Math.random()*o.length)]};WordCloud(o,{list:c,gridSize:Math.round(Math.max(6,Math.min(10,n/50))),weightFactor:function(e){return 8+Math.sqrt(e)/Math.sqrt(i)*(Math.min(35,n/12)-8)},fontFamily:'Arial, "Microsoft YaHei", "微软雅黑", sans-serif',color:d,rotateRatio:.6,backgroundColor:"transparent",minSize:8,drawOutOfBound:!1,shrinkToFit:!1,ellipticity:.8}),console.log("[Main] ✅ 合并词云渲染完成")}catch(i){console.error("[Main] 合并词云渲染失败:",i),console.error("[Main] 错误详情:",i.stack)}else console.warn("[Main] 合并词云数据为空（过滤后）")}}else console.warn("[Main] 英文词云canvas未找到")}"undefined"==typeof window||window.__ANALYSIS_MODULE_LOADED__||(window.__ANALYSIS_MODULE_LOADED__=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{console.log("[Main] DOMContentLoaded 事件触发"),ke()}):(console.log("[Main] DOM 已加载，直接初始化"),ke()));export{He as fetchTotalTestUsers,De as formatNumber,oe as getAllChatData,se as getGlobalStats,re as getParser,le as getVibeAnalyzer,ie as getVibeResult,me as initializeParser,ue as processFiles,he as reanalyzeWithLanguage,pe as renderFullDashboard,Ge as reportNewUser,ge as setAllChatData,ce as setGlobalStats,de as setVibeResult,qe as updateGlobalStats,je as updateNumberWithAnimation};

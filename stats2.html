<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Statistics Dashboard - Vibe Coding</title>
    <!-- API Endpoint -->
    <meta name="api-endpoint" content="https://cursor-clinical-analysis.psterman.workers.dev/">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/map/js/world.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --bg-color: #050505;
            --card-bg: rgba(24, 24, 27, 0.7);
            --card-border: #27272a;
            --text-main: #ffffff;
            --text-dim: #71717a;
            --accent-terminal: #00ff41;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 65, 0.02) 2px,
                    rgba(0, 255, 65, 0.02) 4px
                ),
                radial-gradient(
                    circle,
                    rgba(0, 255, 65, 0.03) 1px,
                    transparent 1px
                );
            background-size: 100% 4px, 20px 20px;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(0, 255, 65, 0.05) 50%,
                transparent 100%
            );
            animation: scanline 8s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .hacker-border {
            border: 1px solid var(--card-border);
            position: relative;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
        }

        .hacker-border::before {
            content: '';
            position: absolute;
            top: -1px; left: 0; width: 60px; height: 1px;
            background: var(--accent-terminal);
            box-shadow: 0 0 10px var(--accent-terminal);
        }

        #map-container {
            width: 100%;
            height: 600px;
        }

        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            border-color: var(--accent-terminal);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
        }

        /* =========================
           Language Switch (Flags)
           ========================= */
        .lang-flag-btn {
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            opacity: 0.6;
            transform: scale(1);
            box-shadow: none;
            overflow: hidden;
        }

        .lang-flag-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
            transition: all 0.4s ease;
            padding: 2px;
            outline: none;
            border: none;
            box-shadow: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .lang-flag-btn.active {
            opacity: 1;
            border: 3px solid var(--accent-terminal);
            box-shadow: 0 0 16px rgba(0, 255, 65, 0.6), 0 0 32px rgba(0, 255, 65, 0.3), inset 0 0 20px rgba(0, 255, 65, 0.1);
            transform: scale(1.1);
        }

        .lang-flag-btn:hover:not(.active) {
            opacity: 0.9;
            transform: scale(1.15);
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .lang-flag-btn:hover.active {
            /* é€‰ä¸­çŠ¶æ€ï¼šä¿æŒ 3px ç²—è¾¹æ¡†ï¼Œåªæ”¹å˜ç¼©æ”¾å’Œé˜´å½± */
            border: 3px solid var(--accent-terminal);
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.8), 0 0 40px rgba(0, 255, 65, 0.4), inset 0 0 25px rgba(0, 255, 65, 0.15);
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.25s ease;
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse { animation: pulse-soft 2s infinite; }

        /* =========================
           Cyberpunk Loading Effects
           ========================= */
        @keyframes skeleton-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* æµå…‰éª¨æ¶å±ï¼šç”¨äºæ•°å­—å ä½ï¼ˆä¸»é¢˜è‰²ç»¿+è“ï¼‰ */
        .skeleton {
            position: relative;
            color: transparent !important;
            user-select: none;
            border-radius: 2px;
            background: linear-gradient(
                90deg,
                rgba(39, 39, 42, 0.25) 0%,
                rgba(0, 255, 65, 0.18) 40%,
                rgba(59, 130, 246, 0.14) 55%,
                rgba(39, 39, 42, 0.25) 100%
            );
            background-size: 240% 100%;
            animation: skeleton-shimmer 1.2s ease-in-out infinite;
            box-shadow: 0 0 18px rgba(0, 255, 65, 0.06);
        }

        /* éª¨æ¶å±æœŸé—´ä¿æŒå¸ƒå±€é«˜åº¦ç¨³å®š */
        #totalUsers.skeleton,
        #totalAnalysis.skeleton,
        #totalChars.skeleton {
            min-height: 2.5rem;
        }
        #avgPerUser.skeleton,
        #avgPerScan.skeleton,
        #systemDays.skeleton,
        #cityCount.skeleton {
            min-height: 1.6rem;
        }

        @keyframes scan-sweep {
            0% { transform: translateY(-120%); opacity: 0; }
            10% { opacity: 0.9; }
            90% { opacity: 0.9; }
            100% { transform: translateY(120%); opacity: 0; }
        }

        /* å…¨å±æ‰«æçº¿ï¼šåŠ è½½æœŸé—´å åŠ  */
        .scan-line {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 40;
            opacity: 0;
            mix-blend-mode: screen;
        }
        .scan-line::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 18vh;
            top: -20vh;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(0, 255, 65, 0.14) 45%,
                rgba(59, 130, 246, 0.10) 60%,
                transparent 100%
            );
            filter: blur(1px);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.12);
            animation: scan-sweep 1.6s linear infinite;
        }
        .scan-line.active {
            opacity: 1;
        }
        
        /* ç¡®ä¿å†…å®¹åœ¨èƒŒæ™¯åŠ¨ç”»ä¹‹ä¸Š */
        body > div {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="scanLine" class="scan-line" aria-hidden="true"></div>
    <div class="max-w-[1600px] mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black tracking-tighter italic flex items-center gap-2">
                    <span class="text-white">GLOBAL</span>
                    <span class="text-[var(--accent-terminal)]">DATA_STATION</span>
                </h1>
                <p id="sub-title" class="text-[10px] text-zinc-500 tracking-[0.3em] font-bold uppercase mt-1">Telemetry Uplink: Active // Source: Central_Pacific</p>
            </div>
            
            <div class="flex gap-3 items-center">
                <button onclick="switchLang('zh')" id="btn-zh" class="lang-flag-btn active" title="ä¸­æ–‡">
                    <img src="images/zh.png" alt="ä¸­æ–‡" />
                </button>
                <button onclick="switchLang('en')" id="btn-en" class="lang-flag-btn" title="English">
                    <img src="images/us.png" alt="English" />
                </button>
            </div>
        </div>

        <!-- Main Dashboard Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            
            <!-- Side Panel: Core Metrics -->
            <div class="xl:col-span-1 flex flex-col gap-4 order-2 xl:order-1">
                <div class="hacker-border p-6 rounded-sm stat-card">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-victims">å·²è¯Šæ–­å¼€å‘è€…</div>
                    <div id="totalUsers" class="text-4xl font-bold text-[var(--accent-terminal)]">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">USERS_RECOGNIZED_SUCCESSFULLY</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-analysis">å…¨ç½‘æ‰«ææ¬¡æ•°</div>
                    <div id="totalAnalysis" class="text-4xl font-bold">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">TOTAL_SCAN_COUNT</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-roast">ç´¯è®¡åæ§½å­—æ•°</div>
                    <div id="totalChars" class="text-4xl font-bold">0</div>
                    <div class="mt-4 h-1 bg-zinc-800 w-full overflow-hidden">
                        <div class="bg-[var(--accent-terminal)] h-full w-[65%]"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 stat-card">
                    <div class="hacker-border p-4 rounded-sm bg-zinc-900/50">
                        <div class="text-zinc-500 text-[10px] uppercase tracking-tighter mb-1">Avg Words / äººå‡å¹³å‡ç¯‡å¹…</div>
                        <div id="avgPerUser" class="text-2xl font-bold font-mono text-[var(--accent-terminal)]">0</div>
                        <div class="text-[9px] text-zinc-600 mt-1 uppercase">Per Developer Basis</div>
                    </div>
                    
                    <div class="hacker-border p-4 rounded-sm bg-zinc-900/50">
                        <div class="text-zinc-500 text-[10px] uppercase tracking-tighter mb-1">Scan Words / å•æ¬¡å¹³å‡ç¯‡å¹…</div>
                        <div id="avgPerScan" class="text-2xl font-bold font-mono text-blue-400">0</div>
                        <div class="text-[9px] text-zinc-600 mt-1 uppercase">Per Analysis Basis</div>
                    </div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card bg-zinc-900/40">
                    <div class="text-[10px] text-zinc-500 mb-4 uppercase tracking-widest lang-key" data-key="radar-title">å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒ</div>
                    <div class="aspect-square">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Central Map Area -->
            <div class="xl:col-span-3 order-1 xl:order-2">
                <div class="hacker-border rounded-sm overflow-hidden relative group">
                    <div id="map-container"></div>
                    
                    <!-- Top Overlay Indicators -->
                    <div class="absolute top-4 left-4 pointer-events-none">
                        <div class="flex gap-4">
                            <div class="bg-black/60 border border-zinc-800 px-3 py-2 rounded">
                                <span class="text-[9px] block text-zinc-500 lang-key" data-key="active-nodes">æ´»è·ƒèŠ‚ç‚¹</span>
                                <span class="text-xs font-bold text-emerald-400 flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full pulse"></span>
                                    242 CONNECTED
                                </span>
                            </div>
                            <div class="bg-black/60 border border-zinc-800 px-3 py-2 rounded">
                                <span class="text-[9px] block text-zinc-500 lang-key" data-key="threat-level">é£é™©è¯„çº§</span>
                                <span class="text-xs font-bold text-red-500">LEVEL_CRITICAL</span>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Horizontal Stats -->
                    <div class="absolute bottom-4 left-4 right-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="top-hotspot">æœ€å¯†é›†çƒ­åŒº</div>
                            <div id="top-country" class="text-sm font-bold truncate">...</div>
                        </div>
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="sys-days">è¿è¡Œå¤©æ•°</div>
                            <div id="systemDays" class="text-xl font-bold">0</div>
                        </div>
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="city-coverage">åŸå¸‚è¦†ç›–</div>
                            <div id="cityCount" class="text-xl font-bold">0</div>
                        </div>
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="sync-rate">åŒæ­¥é€Ÿç‡</div>
                            <div class="text-xl font-bold text-[var(--accent-terminal)]">99.8%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Charts & Logs -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mt-6">
            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="hot-list">åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ</h3>
                <div id="locationList" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="personality-dist">äººæ ¼åˆ†å¸ƒæ’è¡Œ</h3>
                <div id="personalityDistribution" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm flex flex-col">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="recent-activity">å®æ—¶è¯Šæ–­æ´»åŠ¨</h3>
                <div id="recentActivity" class="flex-1 overflow-y-auto max-h-[300px] text-[10px] font-mono space-y-4 pr-2">
                    <!-- Logs here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // =========================
        // å…¨å±€å˜é‡å£°æ˜ï¼ˆç¡®ä¿åœ¨å…¨å±€ä½œç”¨åŸŸï¼Œä¸åœ¨é—­åŒ…å†…ï¼‰
        // =========================
        const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content;
        let currentLang = 'zh';
        
        // Supabase ç›¸å…³å˜é‡ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼Œä¸åœ¨ä»»ä½•å‡½æ•°å†…ï¼‰
        let supabaseClient = null;
        let realtimeChannel = null;
        const SUPABASE_URL = 'https://dtcplfhcgnxdzpigmotb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_-rrlujgXDNxqb-UsMJckNw_G2rn2e8x';

        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ï¼ˆå…¨å±€ä½œç”¨åŸŸç›´æ¥æ‰§è¡Œï¼‰
        // ä½¿ç”¨è½®è¯¢æ–¹å¼ç­‰å¾… SDK åŠ è½½å®Œæˆ
        let initAttempts = 0;
        const maxAttempts = 50; // æœ€å¤šå°è¯• 5 ç§’ï¼ˆ50 * 100msï¼‰

        const initInterval = setInterval(() => {
            initAttempts++;
            
            // æ£€æŸ¥ supabase æ˜¯å¦å·²åŠ è½½
            if (typeof supabase !== 'undefined') {
                clearInterval(initInterval);
                
                try {
                    // å®ä¾‹åŒ–å®¢æˆ·ç«¯ï¼ˆç›´æ¥èµ‹å€¼ç»™å…¨å±€å˜é‡ï¼‰
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    
                    // æŒ‚è½½åˆ°å…¨å±€ windowï¼Œä¾›æ§åˆ¶å°è„šæœ¬ä½¿ç”¨
                    window.supabaseClient = supabaseClient;
                    
                    console.log('[Init] âœ… Supabase å®¢æˆ·ç«¯å·²æˆåŠŸæŒ‚è½½è‡³ window.supabaseClient');
                    console.log('[Init] ğŸ’¡ å¯åœ¨æ§åˆ¶å°ä½¿ç”¨ window.supabaseClient è®¿é—®å®¢æˆ·ç«¯');
                } catch (err) {
                    console.error('[Init] âŒ åˆå§‹åŒ–å¤±è´¥:', err);
                }
            } else if (initAttempts >= maxAttempts) {
                clearInterval(initInterval);
                console.error('[Init] âŒ Supabase SDK åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CDN æ˜¯å¦å¯è®¿é—®');
            }
        }, 100);
        const i18n = {
            zh: {
                'sub-title': 'å®æ—¶è¿œç¨‹ç›‘æµ‹çŠ¶æ€ // èŠ‚ç‚¹ï¼šå¤ªå¹³æ´‹ä¸­éƒ¨',
                'total-victims': 'å·²è¯Šæ–­å¼€å‘è€…',
                'total-analysis': 'å…¨ç½‘æ‰«ææ¬¡æ•°',
                'total-roast': 'ç´¯è®¡åæ§½å­—æ•°',
                'avg-chars': 'äººå‡åæ§½é‡',
                'radar-title': 'å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒ',
                'personality-dist': 'äººæ ¼åˆ†å¸ƒæ’è¡Œ',
                'active-nodes': 'æ´»è·ƒèŠ‚ç‚¹',
                'threat-level': 'é£é™©è¯„çº§',
                'top-hotspot': 'æœ€å¯†é›†çƒ­åŒº',
                'sys-days': 'è¿è¡Œå¤©æ•°',
                'city-coverage': 'åŸå¸‚è¦†ç›–',
                'sync-rate': 'åŒæ­¥é€Ÿç‡',
                'hot-list': 'åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ',
                'recent-activity': 'å®æ—¶è¯Šæ–­æ´»åŠ¨',
                'victim': 'å—å®³è€…',
                'loading': 'åˆå§‹åŒ–ä¸­...',
                'rank': 'æ’å'
            },
            en: {
                'sub-title': 'Telemetry Status // Node: Central_Pacific',
                'total-victims': 'Total Developers',
                'total-analysis': 'Total Scans',
                'total-roast': 'Total Roast Words',
                'avg-chars': 'Avg Roast Per User',
                'radar-title': 'Global Developer Persona',
                'personality-dist': 'Personality Distribution',
                'active-nodes': 'Active Nodes',
                'threat-level': 'Threat Level',
                'top-hotspot': 'Primary Hotspot',
                'sys-days': 'Days Online',
                'city-coverage': 'City Coverage',
                'sync-rate': 'Sync Rate',
                'hot-list': 'Geographic Hotspots',
                'recent-activity': 'Live Activity Feed',
                'victim': 'Victim',
                'loading': 'Initializing...',
                'rank': 'Rank'
            }
        };

        const countryNameMap = {
            'CN': { zh: 'ä¸­å›½', en: 'China' },
            'US': { zh: 'ç¾å›½', en: 'USA' },
            'JP': { zh: 'æ—¥æœ¬', en: 'Japan' },
            'GB': { zh: 'è‹±å›½', en: 'UK' },
            'DE': { zh: 'å¾·å›½', en: 'Germany' },
            'SG': { zh: 'æ–°åŠ å¡', en: 'Singapore' },
            'HK': { zh: 'ä¸­å›½é¦™æ¸¯', en: 'Hong Kong' },
            'TW': { zh: 'ä¸­å›½å°æ¹¾', en: 'Taiwan' }
        };

        let mapChart, radarChart;
        // åœ°å›¾æ¸²æŸ“ä»¤ç‰Œï¼šé˜²æ­¢å¹¶å‘ init / dispose å¯¼è‡´ getZr ä¸ºç©º
        let mapRenderSeq = 0;
        
        // å…¨å±€æ•°æ®å­˜å‚¨ï¼šç”¨äº Realtime æ›´æ–°
        let latestRecords = [];

        /**
         * æ•°å­—æ ¼å¼åŒ–å‡½æ•°ï¼ˆæ™ºèƒ½å¤„ç†å¤§æ•°å­—ï¼‰
         * @param {number} num - è¦æ ¼å¼åŒ–çš„æ•°å­—
         * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼ˆå¦‚ 1.2M, 3.5Kï¼‰
         */
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) {
                return '0';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        /**
         * æ•°å­—æ»šåŠ¨åŠ¨ç”»ï¼ˆrequestAnimationFrameï¼‰
         * éœ€æ±‚ï¼šanimateValue(id, end, duration) + åƒåˆ†ä½æ ¼å¼åŒ–
         * @param {string} id - ç›®æ ‡å…ƒç´  id
         * @param {number} end - ç»“æŸå€¼
         * @param {number} duration - åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
         * @param {Object} options - å¯é€‰é¡¹
         */
        function animateValue(id, end, duration = 1200, options = {}) {
            const el = document.getElementById(id);
            if (!el) return;

            const { start = 0, decimals = 0, useThousands = true } = options;
            const s = Number(start) || 0;
            const e = Number(end) || 0;
            const startTime = performance.now();

            const format = (val) => {
                const n = Number(val) || 0;
                if (useThousands) {
                    return n.toLocaleString(undefined, {
                        minimumFractionDigits: decimals,
                        maximumFractionDigits: decimals
                    });
                }
                return decimals > 0 ? n.toFixed(decimals) : String(Math.round(n));
            };

            const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

            function tick(now) {
                const t = Math.min((now - startTime) / duration, 1);
                const eased = easeOutCubic(t);
                const current = s + (e - s) * eased;
                el.textContent = format(decimals > 0 ? current : Math.floor(current));
                if (t < 1) requestAnimationFrame(tick);
                else el.textContent = format(e);
            }

            requestAnimationFrame(tick);
        }

        /**
         * åŠ è½½æ€éª¨æ¶å±æ³¨å…¥/ç§»é™¤
         */
        const numericIds = [
            'totalUsers',
            'totalAnalysis',
            'totalChars',
            'avgPerUser',
            'avgPerScan',
            'systemDays',
            'cityCount',
        ];

        function setLoadingState(isLoading) {
            const scan = document.getElementById('scanLine');
            if (scan) scan.classList.toggle('active', !!isLoading);

            numericIds.forEach((id) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('skeleton', !!isLoading);
                if (isLoading) {
                    el.textContent = '000000';
                }
            });
        }

        function switchLang(lang) {
            currentLang = lang;
            document.getElementById('btn-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('btn-en').classList.toggle('active', lang === 'en');
            
            // æ›´æ–°é™æ€æ–‡æ¡ˆ
            document.getElementById('sub-title').innerText = i18n[lang]['sub-title'];
            document.querySelectorAll('.lang-key').forEach(el => {
                const key = el.getAttribute('data-key');
                el.innerText = i18n[lang][key];
            });

            // é‡æ–°æ¸²æŸ“æ•°æ®ä¾èµ–å‹ç»„ä»¶
            if (window.lastData) {
                renderLocationList(window.lastData.locationRank);
                const activityData = window.lastData.latestRecords || window.lastData.recentVictims || [];
                renderRecentActivity(activityData);
                renderPersonalityDistribution(window.lastData.personalityDistribution);
                // å¼‚æ­¥æ¸²æŸ“åœ°å›¾ï¼Œç¡®ä¿åœ°å›¾æ•°æ®å·²åŠ è½½
                initGlobalMap(window.lastData.locationRank).catch(err => {
                    console.warn('[Dashboard] è¯­è¨€åˆ‡æ¢æ—¶åœ°å›¾æ¸²æŸ“å¤±è´¥:', err);
                });
            }
        }

        /**
         * æ£€æŸ¥åœ°å›¾æ•°æ®æ˜¯å¦å·²åŠ è½½
         * world.js åŠ è½½åä¼šåœ¨ echarts ä¸­æ³¨å†Œ 'world' åœ°å›¾
         */
        async function checkMapLoaded() {
            if (typeof echarts === 'undefined') {
                return false;
            }
            
            // æ£€æŸ¥åœ°å›¾æ˜¯å¦å·²æ³¨å†Œ
            // ECharts 5.x ä½¿ç”¨ getMap æ–¹æ³•æ£€æŸ¥
            try {
                if (typeof echarts.getMap === 'function') {
                    const mapData = echarts.getMap('world');
                    if (mapData) {
                        console.log('[Map] âœ… åœ°å›¾æ•°æ®å·²æ³¨å†Œ');
                        return true;
                    }
                }
                
                // é™çº§æ£€æŸ¥ï¼šå°è¯•æ³¨å†Œåœ°å›¾ï¼ˆå¦‚æœ world.js å·²åŠ è½½ï¼Œåœ°å›¾æ•°æ®ä¼šåœ¨å…¨å±€å˜é‡ä¸­ï¼‰
                // world.js é€šå¸¸ä¼šå°†åœ°å›¾æ•°æ®å­˜å‚¨åœ¨æŸä¸ªå…¨å±€å˜é‡ä¸­
                // å¦‚æœå­˜åœ¨ï¼Œæ‰‹åŠ¨æ³¨å†Œ
                if (typeof window !== 'undefined' && window.worldMapData) {
                    echarts.registerMap('world', window.worldMapData);
                    console.log('[Map] âœ… ä»å…¨å±€å˜é‡æ³¨å†Œåœ°å›¾');
                    return true;
                }
                
                // æ£€æŸ¥è„šæœ¬æ ‡ç­¾æ˜¯å¦å·²åŠ è½½
                const worldScript = document.querySelector('script[src*="world.js"]');
                if (worldScript && worldScript.getAttribute('data-loaded') === 'true') {
                    console.log('[Map] âœ… world.js è„šæœ¬å·²æ ‡è®°ä¸ºåŠ è½½');
                    return true;
                }
                
                console.warn('[Map] âš ï¸ åœ°å›¾æ•°æ®æœªæ‰¾åˆ°ï¼Œç­‰å¾… world.js åŠ è½½...');
                return false;
            } catch (error) {
                console.warn('[Map] âš ï¸ æ£€æŸ¥åœ°å›¾æ•°æ®æ—¶å‡ºé”™:', error);
                return false;
            }
        }

        /**
         * ç­‰å¾…åœ°å›¾æ•°æ®åŠ è½½å®Œæˆ
         */
        async function waitForMapData(maxWait = 10000) {
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWait) {
                if (await checkMapLoaded()) {
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.warn('[Map] âš ï¸ ç­‰å¾…åœ°å›¾æ•°æ®è¶…æ—¶');
            return false;
        }

        /**
         * åˆå§‹åŒ–å…¨çƒ 2D åœ°å›¾ï¼ˆæ”¯æŒç¼©æ”¾ä¸æ‹–åŠ¨ï¼‰
         * @param {Array} locationData - åœ°ç†ä½ç½®æ•°æ® [{name: string, value: number}]
         */
        async function initGlobalMap(locationData) {
            const chartDom = document.getElementById('map-container');
            if (!chartDom) {
                console.warn('[Map] âš ï¸ æ‰¾ä¸åˆ°åœ°å›¾å®¹å™¨å…ƒç´ ');
                return;
            }
            
            // æ£€æŸ¥ ECharts å’Œ ECharts GL æ˜¯å¦å·²åŠ è½½
            if (typeof echarts === 'undefined') {
                console.warn('[Map] âš ï¸ ECharts æœªåŠ è½½ï¼Œæ— æ³•æ¸²æŸ“åœ°å›¾');
                return;
            }
            
            // æ¸²æŸ“ä»¤ç‰Œï¼ˆåªå…è®¸æœ€åä¸€æ¬¡è°ƒç”¨ç»§ç»­æ‰§è¡Œï¼‰
            const seq = ++mapRenderSeq;

            try {
                // å¦‚æœè¿™æ¬¡è°ƒç”¨å·²ç»è¿‡æœŸï¼Œç›´æ¥é€€å‡ºï¼ˆé¿å… dispose åè¿˜ç»§ç»­ setOptionï¼‰
                if (seq !== mapRenderSeq) return;

                // ç­‰å¾…åœ°å›¾æ•°æ®åŠ è½½å®Œæˆï¼ˆå°½é‡ç­‰å¾…ï¼Œä½†ä¸å¼ºåˆ¶é˜»æ–­æ¸²æŸ“ï¼‰
                try {
                    await waitForMapData(5000);
                } catch (e) {
                    console.warn('[Map] âš ï¸ åœ°å›¾æ•°æ®æ£€æŸ¥è¶…æ—¶ï¼Œç»§ç»­å°è¯•æ¸²æŸ“');
                }

                // å¤ç”¨å®ä¾‹ï¼šä¸å­˜åœ¨åˆ™ initï¼Œå­˜åœ¨åˆ™ clearï¼ˆé¿å… dispose å¹¶å‘é—®é¢˜ï¼‰
                try {
                    if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                        mapChart = echarts.init(chartDom, null, { renderer: 'canvas' });
                    } else {
                        mapChart.clear();
                    }
                } catch (e) {
                    // å…œåº•ï¼šå¦‚æœå®ä¾‹å¼‚å¸¸ï¼Œå°è¯•é‡æ–°åˆ›å»º
                    mapChart = echarts.init(chartDom, null, { renderer: 'canvas' });
                }
                
                // åœ°å›¾æ•°æ®å¿…é¡»å·²æ³¨å†Œï¼Œå¦åˆ™ç›´æ¥æç¤ºï¼ˆé¿å… setOption ç»§ç»­æŠ›é”™ï¼‰
                if (!echarts.getMap || !echarts.getMap('world')) {
                    console.warn('[Map] âš ï¸ world åœ°å›¾æ•°æ®æœªæ³¨å†Œï¼ˆworld.js æœªåŠ è½½å®Œæˆï¼‰');
                    chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">åœ°å›¾æ•°æ®æœªåŠ è½½å®Œæˆ</div>';
                    return;
                }

                // å¤„ç†åœ°ç†ä½ç½®æ•°æ®ï¼ˆ2D ä¸–ç•Œåœ°å›¾åç§°éœ€ä¸ world.js çš„è‹±æ–‡å›½å®¶ååŒ¹é…ï¼‰
                const processedData = (locationData || []).map(item => ({
                    name: (countryNameMap[item.name]
                        ? countryNameMap[item.name].en
                        : (item.name === 'USA' ? 'United States' : item.name)),
                    value: item.value || 0
                }));

                const maxVal = Math.max(20, ...processedData.map(d => d.value || 0));

                const option2D = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: '#18181b',
                        borderColor: '#27272a',
                        textStyle: { color: '#00ff41', fontFamily: 'JetBrains Mono' },
                        formatter: (params) => {
                            const label = countryNameMap[params.data?.name]?.zh || params.name;
                            return `${label}: ${params.value || 0} Victims`;
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: maxVal,
                        show: false,
                        inRange: {
                            color: ['#064e3b', '#065f46', '#00ff41', '#34d399']
                        }
                    },
                    geo: {
                        map: 'world',
                        roam: true,
                        scaleLimit: { min: 1, max: 8 },
                        zoom: 1.2,
                        top: '20%',
                        itemStyle: {
                            areaColor: 'transparent',
                            borderColor: 'transparent',
                            borderWidth: 0
                        },
                        silent: true // é™é»˜æ¨¡å¼ï¼Œä¸å“åº”é¼ æ ‡äº‹ä»¶ï¼Œè®© map ç³»åˆ—å¤„ç†
                    },
                    series: [{
                        type: 'map',
                        map: 'world',
                        // å…³é”®ï¼šå¼€å¯ roam => æ”¯æŒæ‹–åŠ¨å¹³ç§» + æ»šè½®ç¼©æ”¾
                        roam: true,
                        // é™åˆ¶ç¼©æ”¾èŒƒå›´ï¼Œé¿å…æ— é™æ”¾å¤§/ç¼©å°
                        scaleLimit: { min: 1, max: 8 },
                        zoom: 1.2,
                        top: '20%',
                        itemStyle: {
                            areaColor: 'rgba(39, 39, 42, 0.4)',
                            borderColor: 'rgba(0, 255, 65, 0.2)',
                            borderWidth: 1
                        },
                        emphasis: {
                            itemStyle: { areaColor: '#00ff41' },
                            label: { show: false }
                        },
                        data: processedData
                    }]
                };

                // notMerge: true å½»åº•æ›¿æ¢ï¼Œé¿å…æ®‹ç•™æ—§é…ç½®
                mapChart.setOption(option2D, { notMerge: true, lazyUpdate: false });
                
                // å“åº”å¼è°ƒæ•´ï¼ˆç§»é™¤æ—§ handlerï¼Œé¿å…å¤šæ¬¡ç»‘å®š + å¹¶å‘ resizeï¼‰
                try {
                    if (window.mapResizeHandler) {
                        window.removeEventListener('resize', window.mapResizeHandler);
                    }
                } catch (e) {
                    // ignore
                }
                const resizeHandler = () => {
                    if (mapChart && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                        mapChart.resize();
                    }
                };
                window.mapResizeHandler = resizeHandler;
                window.addEventListener('resize', resizeHandler);

                // é˜²æ­¢æ»šè½®ç¼©æ”¾åœ°å›¾æ—¶é¡µé¢è·Ÿç€æ»šåŠ¨ï¼ˆä»…åœ¨æŒ‡é’ˆåœç•™åœ°å›¾åŒºåŸŸæ—¶ç”Ÿæ•ˆï¼‰
                if (!chartDom.dataset.wheelLocked) {
                    chartDom.addEventListener('wheel', (e) => {
                        // ECharts è‡ªå·±ä¼šæ¶ˆè´¹æ»šè½®ç”¨äºç¼©æ”¾ï¼Œè¿™é‡Œé˜»æ­¢é¡µé¢æ»šåŠ¨
                        e.preventDefault();
                    }, { passive: false });
                    chartDom.dataset.wheelLocked = 'true';
                }

                console.log('[Map] âœ… 2D åœ°å›¾æ¸²æŸ“å®Œæˆï¼ˆå·²å¯ç”¨ç¼©æ”¾/æ‹–åŠ¨ï¼‰');
            } catch (error) {
                console.error('[Map] âŒ 2D åœ°å›¾æ¸²æŸ“å¤±è´¥:', error);
                chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">åœ°å›¾æ¸²æŸ“å¤±è´¥</div>';
            }
        }

        /**
         * åœ°å›¾è„‰å†²ç‰¹æ•ˆï¼šåœ¨åœ°å›¾ä¸ŠåŠ¨æ€æ·»åŠ æ¶Ÿæ¼ªç‰¹æ•ˆç‚¹ï¼ˆæ”¯æŒåŠ¨æ€é¢œè‰²ï¼‰
         * @param {number} lng - ç»åº¦
         * @param {number} lat - çº¬åº¦
         * @param {string} label - æ˜¾ç¤ºçš„æ ‡ç­¾æ–‡å­—
         * @param {string} color - é¢œè‰²å€¼ï¼ˆåå…­è¿›åˆ¶ï¼Œå¦‚ '#00ff41' æˆ– '#ffffff'ï¼‰
         */
        function triggerMapPulse(lng, lat, label = '', color = '#00ff41') {
            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ ECharts å®ä¾‹å·²åˆå§‹åŒ–ä¸”æœªé”€æ¯
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                console.warn('[MapPulse] âš ï¸ åœ°å›¾å®ä¾‹æœªåˆå§‹åŒ–ï¼Œè·³è¿‡è„‰å†²ç‰¹æ•ˆ');
                return;
            }

            // æ•°æ®æ ¼å¼éªŒè¯
            if (typeof lng !== 'number' || typeof lat !== 'number' || isNaN(lng) || isNaN(lat)) {
                console.warn('[MapPulse] âš ï¸ ç»çº¬åº¦æ•°æ®æ ¼å¼æ— æ•ˆï¼Œè·³è¿‡è„‰å†²ç‰¹æ•ˆ');
                return;
            }

            // é¢œè‰²éªŒè¯å’Œé»˜è®¤å€¼
            if (!color || typeof color !== 'string') {
                color = '#00ff41'; // é»˜è®¤ç»ˆç«¯ç»¿
            }

            try {
                // è·å–å½“å‰åœ°å›¾é…ç½®
                const currentOption = mapChart.getOption();
                if (!currentOption || !currentOption.series || !Array.isArray(currentOption.series)) {
                    console.warn('[MapPulse] âš ï¸ æ— æ³•è·å–åœ°å›¾é…ç½®ï¼Œè·³è¿‡è„‰å†²ç‰¹æ•ˆ');
                    return;
                }

                // åˆ›å»ºä¸´æ—¶æ¶Ÿæ¼ªç‰¹æ•ˆç³»åˆ—ï¼ˆæ‰€æœ‰é¢œè‰²ç»‘å®šåˆ° color å‚æ•°ï¼‰
                const pulseSeries = {
                    type: 'effectScatter',
                    coordinateSystem: 'geo',
                    data: [[lng, lat]],
                    symbolSize: 20,
                    showEffectOn: 'render',
                    rippleEffect: {
                        brushType: 'stroke',
                        scale: 5, // å¢å¼ºè§†è§‰æ‰©æ•£æ„Ÿ
                        period: 4, // ä¼˜åŒ–æ¶Ÿæ¼ªå‘¨æœŸ
                        color: color // æ¶Ÿæ¼ªé¢œè‰²ç»‘å®šåˆ° color å‚æ•°
                    },
                    itemStyle: {
                        color: color, // ç‚¹é¢œè‰²ç»‘å®šåˆ° color å‚æ•°
                        shadowBlur: 20,
                        shadowColor: color // é˜´å½±é¢œè‰²ç»‘å®šåˆ° color å‚æ•°
                    },
                    label: {
                        show: !!label,
                        formatter: label || '',
                        position: 'top',
                        color: color, // æ ‡ç­¾é¢œè‰²ç»‘å®šåˆ° color å‚æ•°
                        fontSize: 10,
                        fontFamily: 'JetBrains Mono'
                    },
                    zlevel: 10,
                    z: 10
                };

                // å°†è„‰å†²ç³»åˆ—æ·»åŠ åˆ°ç°æœ‰ç³»åˆ—æ•°ç»„ä¸­
                const updatedSeries = [...currentOption.series, pulseSeries];
                
                // æ›´æ–°åœ°å›¾é…ç½®ï¼ˆä½¿ç”¨ merge æ¨¡å¼ï¼Œä¿ç•™åŸæœ‰é…ç½®ï¼‰
                mapChart.setOption({
                    series: updatedSeries
                }, { notMerge: false, lazyUpdate: false });

                console.log(`[MapPulse] âœ… è„‰å†²ç‰¹æ•ˆå·²æ·»åŠ : [${lng}, ${lat}] ${label || ''} (é¢œè‰²: ${color})`);

                // 5 ç§’åè‡ªåŠ¨ç§»é™¤è„‰å†²ç‰¹æ•ˆï¼ˆä¿è¯æ€§èƒ½ï¼Œé¿å… Canvas å †ç§¯è¿‡å¤šç‚¹ï¼‰
                setTimeout(() => {
                    try {
                        // å†æ¬¡æ£€æŸ¥åœ°å›¾å®ä¾‹æœ‰æ•ˆæ€§
                        if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                            return;
                        }

                        // è·å–å½“å‰é…ç½®å¹¶ç§»é™¤è„‰å†²ç³»åˆ—
                        const currentOpt = mapChart.getOption();
                        if (currentOpt && currentOpt.series && Array.isArray(currentOpt.series)) {
                            // æ‰¾åˆ°å¹¶ç§»é™¤æˆ‘ä»¬åˆšæ·»åŠ çš„ effectScatter ç³»åˆ—
                            // é€šè¿‡æ¯”è¾ƒæ•°æ®ç‚¹æ¥è¯†åˆ«ï¼ˆæ›´ç²¾ç¡®çš„åŒ¹é…ï¼‰
                            const filteredSeries = currentOpt.series.filter((s) => {
                                // ä¿ç•™åŸå§‹ç³»åˆ—ï¼Œç§»é™¤æˆ‘ä»¬æ·»åŠ çš„ effectScatter ç³»åˆ—
                                if (s.type === 'effectScatter' && s.data && s.data.length > 0) {
                                    const point = s.data[0];
                                    // å¦‚æœæ•°æ®ç‚¹åŒ¹é…ï¼Œè¯´æ˜æ˜¯æˆ‘ä»¬åˆšæ·»åŠ çš„ï¼Œéœ€è¦ç§»é™¤
                                    if (Array.isArray(point) && point.length >= 2) {
                                        const pointLng = point[0];
                                        const pointLat = point[1];
                                        // å…è®¸å°çš„æµ®ç‚¹æ•°è¯¯å·®
                                        if (Math.abs(pointLng - lng) < 0.0001 && Math.abs(pointLat - lat) < 0.0001) {
                                            return false; // ç§»é™¤è¿™ä¸ªç³»åˆ—
                                        }
                                    }
                                }
                                return true; // ä¿ç•™å…¶ä»–ç³»åˆ—
                            });
                            
                            mapChart.setOption({
                                series: filteredSeries
                            }, { notMerge: false, lazyUpdate: false });
                            
                            console.log('[MapPulse] âœ… è„‰å†²ç‰¹æ•ˆå·²è‡ªåŠ¨ç§»é™¤');
                        }
                    } catch (error) {
                        console.warn('[MapPulse] âš ï¸ ç§»é™¤è„‰å†²ç‰¹æ•ˆæ—¶å‡ºé”™:', error);
                    }
                }, 5000);

            } catch (error) {
                console.error('[MapPulse] âŒ æ·»åŠ è„‰å†²ç‰¹æ•ˆå¤±è´¥:', error);
            }
        }

        function renderRadarChart(averages) {
            // ã€ID å­˜åœ¨æ€§æ£€æŸ¥ã€‘åœ¨æ‰§è¡Œå‰ï¼Œå¿…é¡»æ£€æŸ¥ document.getElementById æ˜¯å¦éç©º
            const radarCanvas = document.getElementById('radarChart');
            if (!radarCanvas) {
                console.warn('[é›·è¾¾å›¾] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            const ctx = radarCanvas.getContext('2d');
            if (!ctx) {
                console.warn('[é›·è¾¾å›¾] âŒ æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡');
                return;
            }
            
            if (radarChart) radarChart.destroy();

            const labels = currentLang === 'zh' ? ['è¯­è¨€', 'æ¨¡å¼', 'æ·±åº¦', 'æ•ˆç‡', 'é¢‘ç‡'] : ['Lang', 'Pattern', 'Depth', 'Effi', 'Freq'];
            const targetData = [
                Number(averages.L || 50),
                Number(averages.P || 50),
                Number(averages.D || 50),
                Number(averages.E || 50),
                Number(averages.F || 50)
            ];
            const zeroData = [0, 0, 0, 0, 0];

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: zeroData,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        borderWidth: 1,
                        pointRadius: 2
                    }]
                },
                options: {
                    animation: {
                        duration: 900,
                        easing: 'easeOutQuart',
                        animateScale: true,
                        animateRotate: true
                    },
                    scales: {
                        r: {
                            angleLines: { color: '#27272a' },
                            grid: { color: '#27272a' },
                            pointLabels: { color: '#71717a', font: { size: 9 } },
                            ticks: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // è§¦å‘ä¸€æ¬¡ updateï¼Œè®©é›·è¾¾å›¾ä»ä¸­å¿ƒæ‰©å¼ åˆ°çœŸå®å€¼
            try {
                radarChart.data.datasets[0].data = targetData;
                radarChart.update();
            } catch (e) {
                console.warn('[é›·è¾¾å›¾] âš ï¸ update åŠ¨ç”»è§¦å‘å¤±è´¥:', e);
            }
        }

        function renderLocationList(data) {
            const list = document.getElementById('locationList');
            if (!data || data.length === 0) return;
            
            list.innerHTML = data.slice(0, 5).map((item, i) => {
                const name = countryNameMap[item.name] ? countryNameMap[item.name][currentLang] : item.name;
                return `
                <div class="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2">
                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                    <span class="font-bold uppercase tracking-tighter">${name}</span>
                    <span class="text-[var(--accent-terminal)] font-bold">${item.value}</span>
                </div>`;
            }).join('');

            const top = data[0];
            document.getElementById('top-country').innerText = countryNameMap[top.name] ? countryNameMap[top.name][currentLang] : top.name;
        }

        function renderRecentActivity(victims) {
            const box = document.getElementById('recentActivity');
            if (!box) return;
            
            // ä¼˜å…ˆä½¿ç”¨ latestRecordsï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ recentVictims
            const records = victims || [];
            
            if (records.length === 0) {
                box.innerHTML = '<div class="text-zinc-500 text-center py-4">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            box.innerHTML = records.map((v, index) => {
                // å…¼å®¹ä¸¤ç§æ•°æ®æ ¼å¼ï¼šlatestRecords å’Œ recentVictims
                const time = v.time || v.created_at || new Date().toISOString();
                const type = v.type || v.personality_type || 'UNKNOWN';
                const location = v.location || v.ip_location || 'æœªçŸ¥';
                const name = v.name || `è®°å½•${index + 1}`;
                
                return `
                <div class="border-l-2 border-zinc-800 pl-3 py-1">
                    <div class="text-zinc-500">${new Date(time).toLocaleTimeString()}</div>
                    <div class="text-white">${name.length > 6 ? name.slice(0,6) + '...' : name}</div>
                    <div class="text-[var(--accent-terminal)]">${type} @ ${location}</div>
                </div>
            `;
            }).join('');
        }

        /**
         * æ¸²æŸ“äººæ ¼åˆ†å¸ƒæ’è¡Œ
         * @param {Array} distribution - äººæ ¼åˆ†å¸ƒæ•°æ® [{type: string, count: number}]
         */
        function renderPersonalityDistribution(distribution) {
            const list = document.getElementById('personalityDistribution');
            if (!list) return;
            
            if (!distribution || !Array.isArray(distribution) || distribution.length === 0) {
                list.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            list.innerHTML = distribution.map((item, i) => {
                const type = item.type || 'UNKNOWN';
                const count = Number(item.count) || 0;
                return `
                <div class="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2">
                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                    <span class="font-bold uppercase tracking-tighter">${type}</span>
                    <span class="text-[var(--accent-terminal)] font-bold">${count}</span>
                </div>`;
            }).join('');
        }

        /**
         * ã€é€‚é…å±‚é‡å†™ã€‘å¼ºåˆ¶æ˜ å°„å±‚ï¼šä»å¤šä¸ªå¯èƒ½çš„å­—æ®µè·¯å¾„æå–æ•°æ®
         * @param {Object} result - API è¿”å›çš„åŸå§‹æ•°æ®
         * @returns {Object} æ ‡å‡†åŒ–åçš„æ•°æ®å¯¹è±¡
         */
        function normalizeData(result) {
            const data = result || {};
            
            // ã€å¼ºåˆ¶æ˜ å°„å±‚ã€‘totalAnalysisï¼šä¾æ¬¡å°è¯• result.totalAnalysis, result.data.totalAnalysis, è‹¥éƒ½ç¼ºå¤±åˆ™å– result.recentVictims.length
            let totalAnalysis = data.totalAnalysis;
            if (totalAnalysis === undefined || totalAnalysis === null) {
                totalAnalysis = data.data?.totalAnalysis;
            }
            if (totalAnalysis === undefined || totalAnalysis === null) {
                const recentVictims = data.recentVictims || data.latestRecords || [];
                totalAnalysis = recentVictims.length;
            }
            
            // ã€å¼ºåˆ¶æ˜ å°„å±‚ã€‘totalRoastWordsï¼šä¾æ¬¡å°è¯• result.totalRoastWords, result.totalChars, result.data.total_roast_words
            let totalRoastWords = data.totalRoastWords;
            if (totalRoastWords === undefined || totalRoastWords === null) {
                totalRoastWords = data.totalChars;
            }
            if (totalRoastWords === undefined || totalRoastWords === null) {
                totalRoastWords = data.data?.total_roast_words;
            }
            
            // ã€å¼ºåˆ¶æ˜ å°„å±‚ã€‘avgPerUser å’Œ avgPerScanï¼šä¾æ¬¡å°è¯• result.avgPerUser/avgPerScan, result.data.avgPerUser/avgPerScan
            let avgPerUser = data.avgPerUser;
            if (avgPerUser === undefined || avgPerUser === null) {
                avgPerUser = data.data?.avgPerUser;
            }
            // å…¼å®¹æ—§å­—æ®µå
            if (avgPerUser === undefined || avgPerUser === null) {
                avgPerUser = data.avgChars;
            }
            
            let avgPerScan = data.avgPerScan;
            if (avgPerScan === undefined || avgPerScan === null) {
                avgPerScan = data.data?.avgPerScan;
            }
            
            return {
                totalUsers: data.totalUsers || 0,
                totalAnalysis: totalAnalysis || 0,
                totalRoastWords: totalRoastWords || 0,
                avgPerUser: avgPerUser || 0,
                avgPerScan: avgPerScan || 0,
                cityCount: data.cityCount || 0,
                systemDays: data.systemDays || 1,
                personalityRank: data.personalityRank || data.personalityDistribution || [],
                personalityDistribution: data.personalityDistribution || data.personalityRank || [],
                globalAverage: data.globalAverage || data.averages || { L: 50, P: 50, D: 50, E: 50, F: 50 },
                averages: data.averages || data.globalAverage || { L: 50, P: 50, D: 50, E: 50, F: 50 },
                locationRank: data.locationRank || [],
                recentVictims: data.recentVictims || data.latestRecords || [],
                latestRecords: data.latestRecords || data.recentVictims || [],
            };
        }

        /**
         * ã€åŠ¨ç”»å®¹é”™ã€‘å®‰å…¨çš„åŠ¨ç”»å‡½æ•°ï¼Œé˜²æ­¢ NaN æˆ– undefined å¯¼è‡´å´©æºƒ
         * @param {HTMLElement} element - ç›®æ ‡å…ƒç´ 
         * @param {number} start - èµ·å§‹å€¼
         * @param {number} end - ç»“æŸå€¼
         * @param {number} duration - åŠ¨ç”»æŒç»­æ—¶é—´
         * @param {boolean} useFormat - æ˜¯å¦ä½¿ç”¨æ ¼å¼åŒ–
         */
        function safeAnimateValue(element, start, end, duration = 1500, useFormat = true) {
            if (!element) {
                console.warn('[åŠ¨ç”»] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // ã€åŠ¨ç”»å®¹é”™ã€‘åœ¨è°ƒç”¨ animateValue ä¹‹å‰ï¼Œæ·»åŠ  if (isNaN(value)) value = 0; çš„åˆ¤æ–­
            if (isNaN(start)) start = 0;
            if (isNaN(end)) end = 0;
            
            start = Number(start) || 0;
            end = Number(end) || 0;
            
            animateValue(element, start, end, duration, useFormat);
        }

        /**
         * ã€äººæ ¼æ’è¡Œæ¸²æŸ“å‡½æ•°ã€‘ç‹¬ç«‹çš„ renderPersonalityRank å‡½æ•°ï¼ŒåŒ…å«å‰ç«¯è‡ªè®¡ç®—é™çº§é€»è¾‘
         * @param {Array} rankData - äººæ ¼æ’è¡Œæ•°æ® [{type, count, percentage}]
         * @param {Array} recentVictims - æœ€è¿‘å—å®³è€…æ•°æ®ï¼ˆç”¨äºé™çº§è®¡ç®—ï¼‰
         */
        function renderPersonalityRank(rankData, recentVictims = []) {
            const personalityEl = document.getElementById('personalityDistribution');
            if (!personalityEl) {
                console.warn('[äººæ ¼æ’è¡Œ] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // å¦‚æœåç«¯ personalityRank å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œç›´æ¥æ¸²æŸ“
            if (rankData && Array.isArray(rankData) && rankData.length > 0) {
                personalityEl.innerHTML = rankData.map((item, i) => {
                    const type = item.type || 'æœªçŸ¥';
                    const count = Number(item.count || 0);
                    const percentage = Number(item.percentage || 0);
                    return `
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                <span class="text-zinc-400">${i+1}. ${type}</span>
                                <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                            </div>
                            <div class="w-full bg-zinc-800/50 h-1">
                                <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                console.log(`[äººæ ¼æ’è¡Œ] âœ… æ¸²æŸ“æˆåŠŸ (${rankData.length} æ¡)`);
                return;
            }
            
            // ã€å‰ç«¯è‡ªè®¡ç®—é™çº§é€»è¾‘ã€‘è‹¥åç«¯ personalityRank ä¸ºç©ºï¼Œåˆ™æ ¹æ® recentVictims å®æ—¶è®¡ç®—å æ¯”å¹¶æ¸²æŸ“è¿›åº¦æ¡
            if (recentVictims && recentVictims.length > 0) {
                console.log('[äººæ ¼æ’è¡Œ] âš ï¸ personalityRank ä¸ºç©ºï¼Œä½¿ç”¨ recentVictims é™çº§æ–¹æ¡ˆ');
                const typeMap = new Map();
                recentVictims.forEach((v) => {
                    const type = v.type || v.personality_type || 'UNKNOWN';
                    typeMap.set(type, (typeMap.get(type) || 0) + 1);
                });
                
                const total = recentVictims.length;
                const personalityRank = Array.from(typeMap.entries())
                    .map(([type, count]) => ({
                        type: type,
                        count: Number(count) || 0,
                        percentage: Math.round((Number(count) / total) * 100) || 0,
                    }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                personalityEl.innerHTML = personalityRank.map((item, i) => {
                    const type = item.type || 'æœªçŸ¥';
                    const count = Number(item.count || 0);
                    const percentage = Number(item.percentage || 0);
                    return `
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                <span class="text-zinc-400">${i+1}. ${type}</span>
                                <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                            </div>
                            <div class="w-full bg-zinc-800/50 h-1">
                                <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                console.log(`[äººæ ¼æ’è¡Œ] âœ… é™çº§æ–¹æ¡ˆæ¸²æŸ“æˆåŠŸ (${personalityRank.length} æ¡)`);
                return;
            }
            
            // å¦‚æœéƒ½æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            personalityEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
            console.warn('[äººæ ¼æ’è¡Œ] âŒ æ— å¯ç”¨æ•°æ®');
        }

        /**
         * å¯åŠ¨ Supabase Realtime ç›‘å¬
         * ç›‘å¬ user_analysis è¡¨çš„ INSERT äº‹ä»¶
         */
        function startRealtimeListener() {
            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                console.warn('[Realtime] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè·³è¿‡ Realtime ç›‘å¬');
                return;
            }

            // å¦‚æœå·²æœ‰ç›‘å¬é€šé“ï¼Œå…ˆå–æ¶ˆè®¢é˜…
            if (realtimeChannel) {
                try {
                    supabaseClient.removeChannel(realtimeChannel);
                    console.log('[Realtime] âœ… å·²å–æ¶ˆæ—§çš„ç›‘å¬é€šé“');
                } catch (error) {
                    console.warn('[Realtime] âš ï¸ å–æ¶ˆæ—§é€šé“æ—¶å‡ºé”™:', error);
                }
            }

            try {
                // åˆ›å»ºæ–°çš„ç›‘å¬é€šé“
                realtimeChannel = supabaseClient
                    .channel('user_analysis_changes')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'user_analysis'
                        },
                        (payload) => {
                            console.log('[Realtime] ğŸ“¨ æ”¶åˆ°æ–°æ•°æ®:', payload);
                            
                            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ payload å’Œ payload.new å­˜åœ¨
                            if (!payload || !payload.new) {
                                console.warn('[Realtime] âš ï¸ æ•°æ®æ ¼å¼ä¸å®Œæ•´ï¼Œè·³è¿‡å¤„ç†');
                                return;
                            }

                            const newRecord = payload.new;
                            
                            // å±€éƒ¨æ›´æ–°ï¼šå°†æ–°æ•°æ®æ’å…¥åˆ° latestRecords æœ€å‰é¢
                            if (!Array.isArray(latestRecords)) {
                                latestRecords = [];
                            }
                            
                            latestRecords.unshift(newRecord);
                            
                            // é•¿åº¦æ§åˆ¶ï¼šä¿æŒæ•°ç»„é•¿åº¦ä¸è¶…è¿‡ 10
                            if (latestRecords.length > 10) {
                                latestRecords = latestRecords.slice(0, 10);
                            }

                            console.log(`[Realtime] âœ… å·²æ›´æ–° latestRecords (å½“å‰é•¿åº¦: ${latestRecords.length})`);

                            // é‡æ–°æ¸²æŸ“å³ä¾§å¡ç‰‡åˆ—è¡¨
                            try {
                                renderRecentActivity(latestRecords);
                                console.log('[Realtime] âœ… å·²åˆ·æ–°å®æ—¶è¯Šæ–­æ´»åŠ¨åˆ—è¡¨');
                            } catch (error) {
                                console.error('[Realtime] âŒ æ¸²æŸ“æ´»åŠ¨åˆ—è¡¨å¤±è´¥:', error);
                            }

                            // åœ°å›¾è”åŠ¨ç‰¹æ•ˆï¼šå¦‚æœæ–°æ•°æ®åŒ…å«åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œè§¦å‘åœ°å›¾è„‰å†²
                            try {
                                // å°è¯•ä»æ–°æ•°æ®ä¸­æå–ç»çº¬åº¦ä¿¡æ¯
                                // æ ¹æ®å®é™…æ•°æ®å­—æ®µè°ƒæ•´ï¼ˆå¯èƒ½æ˜¯ lng/lat, longitude/latitude, location ç­‰ï¼‰
                                let lng = null;
                                let lat = null;
                                let vibeName = '';

                                // æ–¹å¼1ï¼šç›´æ¥å­—æ®µï¼ˆä¼˜å…ˆæ£€æŸ¥ç»çº¬åº¦å­—æ®µï¼‰
                                if (newRecord.lng !== undefined && newRecord.lat !== undefined) {
                                    lng = Number(newRecord.lng);
                                    lat = Number(newRecord.lat);
                                } else if (newRecord.longitude !== undefined && newRecord.latitude !== undefined) {
                                    lng = Number(newRecord.longitude);
                                    lat = Number(newRecord.latitude);
                                }
                                // æ–¹å¼2ï¼šä» location æˆ– ip_location å­—æ®µè§£æï¼ˆå¦‚æœåŒ…å«åæ ‡ï¼‰
                                else {
                                    const locationSource = newRecord.location || newRecord.ip_location;
                                    if (locationSource) {
                                        // å°è¯•è§£æ "lng,lat" æ ¼å¼çš„åæ ‡å­—ç¬¦ä¸²
                                        const locationStr = String(locationSource);
                                        const coords = locationStr.split(',');
                                        if (coords.length >= 2) {
                                            const parsedLng = Number(coords[0].trim());
                                            const parsedLat = Number(coords[1].trim());
                                            if (!isNaN(parsedLng) && !isNaN(parsedLat)) {
                                                lng = parsedLng;
                                                lat = parsedLat;
                                            }
                                        }
                                    }
                                }

                                // æå–åç§°ï¼ˆå¯èƒ½æ˜¯ name, vibe_name, personality_type ç­‰ï¼‰
                                const baseName = newRecord.name || newRecord.vibe_name || newRecord.personality_type || '';

                                // =========================
                                // VPN ç©¿é€æ£€æµ‹åˆ¤å®šé€»è¾‘ï¼ˆç›‘å¬ç«¯ï¼‰
                                // =========================
                                let isVpn = false;
                                let pulseColor = '#ffffff'; // é»˜è®¤ç™½è‰²ï¼ˆæ­£å¸¸ç”¨æˆ·ï¼‰
                                let pulseLabel = baseName ? `${baseName} [DIRECT]` : '[DIRECT]';

                                // è·å–åˆ¤å®šæ‰€éœ€å­—æ®µ
                                const ipLocation = String(newRecord.ip_location || '').toUpperCase().trim();
                                const timezone = String(newRecord.timezone || '').trim();

                                // åˆ¤å®šæ¡ä»¶ï¼šå¦‚æœ ip_location ä¸å±äº 'CN'ï¼Œä½† timezone æ˜¯ 'Asia/Shanghai'ï¼Œåˆ™æ ‡è®° isVpn = true
                                const isNotChina = ipLocation !== 'CN' && ipLocation !== '';
                                const isShanghaiTimezone = timezone === 'Asia/Shanghai';

                                if (isNotChina && isShanghaiTimezone) {
                                    // VPN ç”¨æˆ·ï¼šæµ·å¤– IP + ä¸Šæµ·æ—¶åŒº = VPN ç©¿é€
                                    isVpn = true;
                                    pulseColor = '#00ff41'; // VPN ç”¨æˆ·ï¼šç»ˆç«¯ç»¿
                                    pulseLabel = baseName ? `${baseName} [VPN PROXY]` : '[VPN PROXY]';
                                    console.log('[Realtime] ğŸ” VPN åˆ¤å®š: æ£€æµ‹åˆ° VPN ç©¿é€ç”¨æˆ·', {
                                        ipLocation,
                                        timezone,
                                        isVpn: true,
                                        reason: 'æµ·å¤–IPä½†æ—¶åŒºä¸ºAsia/Shanghai'
                                    });
                                } else {
                                    // æ­£å¸¸ç”¨æˆ·ï¼šç›´æ¥è¿æ¥
                                    pulseColor = '#ffffff'; // æ­£å¸¸ç”¨æˆ·ï¼šçº¯ç™½è‰²
                                    pulseLabel = baseName ? `${baseName} [DIRECT]` : '[DIRECT]';
                                    console.log('[Realtime] ğŸ” VPN åˆ¤å®š: æ­£å¸¸ç”¨æˆ·', {
                                        ipLocation,
                                        timezone,
                                        isVpn: false,
                                        reason: isNotChina ? 'æ—¶åŒºä¸åŒ¹é…' : 'IPä½ç½®æ­£å¸¸'
                                    });
                                }

                                // å¦‚æœæˆåŠŸæå–åˆ°ç»çº¬åº¦ï¼Œè§¦å‘åœ°å›¾è„‰å†²ï¼ˆä½¿ç”¨åˆ¤å®šåçš„é¢œè‰²å’Œæ ‡ç­¾ï¼‰
                                if (lng !== null && lat !== null && !isNaN(lng) && !isNaN(lat)) {
                                    triggerMapPulse(lng, lat, pulseLabel, pulseColor);
                                    console.log(`[Realtime] âœ… å·²è§¦å‘åœ°å›¾è„‰å†²: [${lng}, ${lat}] ${pulseLabel} (é¢œè‰²: ${pulseColor}, VPN: ${isVpn})`);
                                } else {
                                    console.log('[Realtime] â„¹ï¸ æ–°æ•°æ®æœªåŒ…å«æœ‰æ•ˆçš„åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œè·³è¿‡åœ°å›¾è„‰å†²');
                                }
                            } catch (error) {
                                console.warn('[Realtime] âš ï¸ å¤„ç†åœ°å›¾è”åŠ¨ç‰¹æ•ˆæ—¶å‡ºé”™:', error);
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('[Realtime] âœ… å·²æˆåŠŸè®¢é˜… user_analysis è¡¨çš„ INSERT äº‹ä»¶');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('[Realtime] âŒ è®¢é˜…é€šé“é”™è¯¯');
                        } else {
                            console.log(`[Realtime] â„¹ï¸ è®¢é˜…çŠ¶æ€: ${status}`);
                        }
                    });

                console.log('[Realtime] ğŸš€ Realtime ç›‘å¬å·²å¯åŠ¨');
            } catch (error) {
                console.error('[Realtime] âŒ å¯åŠ¨ Realtime ç›‘å¬å¤±è´¥:', error);
            }
        }

        /**
         * åœæ­¢ Supabase Realtime ç›‘å¬
         */
        function stopRealtimeListener() {
            if (realtimeChannel && supabaseClient) {
                try {
                    supabaseClient.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                    console.log('[Realtime] âœ… å·²åœæ­¢ Realtime ç›‘å¬');
                } catch (error) {
                    console.warn('[Realtime] âš ï¸ åœæ­¢ç›‘å¬æ—¶å‡ºé”™:', error);
                }
            }
        }

        /**
         * è·å–ç”¨æˆ·ç³»ç»Ÿç‰¹å¾ï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰
         * ç”¨äºæ•°æ®é‡‡é›†ç«¯ï¼Œè·å– timezone å’Œ browser_lang
         * @returns {Promise<Object>} åŒ…å« timezone, browser_lang çš„å¯¹è±¡
         */
        async function getUserSystemFeatures() {
            try {
                // ä½¿ç”¨ requestIdleCallback ç¡®ä¿éé˜»å¡ï¼Œä¸å½±å“é¡µé¢åŠ è½½é€Ÿåº¦
                return new Promise((resolve) => {
                    const schedule = window.requestIdleCallback || ((cb) => setTimeout(cb, 0));
                    
                    schedule(() => {
                        // è·å–æ—¶åŒºï¼šä½¿ç”¨ Intl.DateTimeFormat().resolvedOptions().timeZone
                        let timezone = 'Unknown';
                        try {
                            const formatter = new Intl.DateTimeFormat();
                            const resolvedOptions = formatter.resolvedOptions();
                            timezone = resolvedOptions.timeZone || 'Unknown';
                        } catch (err) {
                            console.warn('[SystemFeatures] âš ï¸ è·å–æ—¶åŒºå¤±è´¥:', err);
                            timezone = 'Unknown';
                        }

                        // è·å–æµè§ˆå™¨è¯­è¨€ï¼šä½¿ç”¨ navigator.language
                        const browser_lang = navigator.language || navigator.userLanguage || 'Unknown';

                        resolve({
                            timezone,
                            browser_lang
                        });
                    });
                });
            } catch (error) {
                console.error('[SystemFeatures] âŒ è·å–ç³»ç»Ÿç‰¹å¾å¤±è´¥:', error);
                // è¿”å›é»˜è®¤å€¼ï¼Œç¡®ä¿å‡½æ•°ä¸ä¼šé˜»å¡
                return {
                    timezone: 'Unknown',
                    browser_lang: navigator.language || 'Unknown'
                };
            }
        }

        /**
         * è‡ªåŠ¨ä¸ŠæŠ¥å½“å‰ç”¨æˆ·ä¿¡æ¯åˆ° user_analysis è¡¨
         * åœ¨ fetchData æ‰§è¡ŒæˆåŠŸåè‡ªåŠ¨è°ƒç”¨
         * @returns {Promise<Object>} ä¸ŠæŠ¥ç»“æœ
         */
        async function autoReportSelf() {
            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                console.warn('[AutoReport] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè·³è¿‡è‡ªåŠ¨ä¸ŠæŠ¥');
                return { success: false, error: 'Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–' };
            }

            try {
                console.log('[AutoReport] ğŸš€ å¼€å§‹è‡ªåŠ¨ä¸ŠæŠ¥ç”¨æˆ·ä¿¡æ¯...');

                // 1. è·å–ç³»ç»Ÿç‰¹å¾ï¼ˆæ—¶åŒºå’Œè¯­è¨€ï¼‰
                const systemFeatures = await getUserSystemFeatures();
                console.log('[AutoReport] ğŸ“Š ç³»ç»Ÿç‰¹å¾å·²è·å–:', systemFeatures);

                // 2. è·å– IP å’Œå½’å±åœ°ä¿¡æ¯
                let ipInfo = null;
                let ipLocation = 'Unknown';
                let lat = null;
                let lng = null;
                let countryCode = 'Unknown';

                try {
                    // ä½¿ç”¨ ip-api.com API è·å– IP å½’å±åœ°ä¿¡æ¯ï¼ˆæ›´ç¨³å®šçš„å…è´¹ APIï¼‰
                    // è¿”å›å­—æ®µï¼šcountry, countryCode, city, lat, lon ç­‰
                    const ipResponse = await fetch('http://ip-api.com/json/', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (ipResponse.ok) {
                        ipInfo = await ipResponse.json();
                        console.log('[AutoReport] ğŸŒ IP ä¿¡æ¯å·²è·å–:', ipInfo);

                        // ip-api.com è¿”å›æ ¼å¼ï¼š{ country, countryCode, city, lat, lon, ... }
                        // æå–å…³é”®ä¿¡æ¯
                        countryCode = ipInfo.countryCode || ipInfo.country_code || 'Unknown';
                        
                        // æ„å»º ip_location å­—ç¬¦ä¸²ï¼ˆä½¿ç”¨å›½å®¶ä»£ç ï¼‰
                        if (countryCode && countryCode !== 'Unknown') {
                            ipLocation = countryCode;
                        } else {
                            ipLocation = 'Unknown';
                        }
                        
                        // æå–ç»çº¬åº¦ï¼ˆæ³¨æ„ï¼šip-api.com ä½¿ç”¨ lon è€Œä¸æ˜¯ longitudeï¼‰
                        if (ipInfo.lat && ipInfo.lon) {
                            lat = Number(ipInfo.lat);
                            lng = Number(ipInfo.lon);
                        } else if (ipInfo.latitude && ipInfo.longitude) {
                            // å…¼å®¹å…¶ä»–å¯èƒ½çš„å­—æ®µå
                            lat = Number(ipInfo.latitude);
                            lng = Number(ipInfo.longitude);
                        }
                    } else {
                        console.warn('[AutoReport] âš ï¸ IP API è¯·æ±‚å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ...');
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ ipify è·å– IP
                        try {
                            const ipifyResponse = await fetch('https://api.ipify.org?format=json');
                            if (ipifyResponse.ok) {
                                const ipifyData = await ipifyResponse.json();
                                console.log('[AutoReport] ğŸ“ ä» ipify è·å–åˆ° IP:', ipifyData.ip);
                                ipLocation = 'Unknown';
                            }
                        } catch (err) {
                            console.warn('[AutoReport] âš ï¸ å¤‡ç”¨ IP API ä¹Ÿå¤±è´¥:', err);
                        }
                    }
                } catch (error) {
                    console.warn('[AutoReport] âš ï¸ è·å– IP ä¿¡æ¯å¤±è´¥:', error);
                    // ç»§ç»­æ‰§è¡Œï¼Œä½¿ç”¨é»˜è®¤å€¼
                }

                // 3. VPN åˆ¤å®šé€»è¾‘
                // åˆ¤å®šæ¡ä»¶ï¼šå¦‚æœ timezone æ˜¯ 'Asia/Shanghai' ä¸” IP ä½ç½®ä¸åœ¨ä¸­å›½ï¼Œæ ‡è®°ä¸º VPN
                const timezone = systemFeatures.timezone || 'Unknown';
                const isShanghaiTimezone = timezone === 'Asia/Shanghai';
                // åªæœ‰å½“ countryCode æ˜ç¡®ä¸æ˜¯ 'CN' ä¸”ä¸æ˜¯ 'Unknown' æ—¶ï¼Œæ‰åˆ¤å®šä¸ºä¸åœ¨ä¸­å›½
                const isNotChina = countryCode !== 'CN' && countryCode !== 'Unknown' && countryCode !== null;

                let is_vpn = false;
                // åªæœ‰åœ¨æ—¶åŒºæ˜¯ Asia/Shanghai ä¸” IP æ˜ç¡®ä¸åœ¨ä¸­å›½æ—¶ï¼Œæ‰åˆ¤å®šä¸º VPN
                if (isShanghaiTimezone && isNotChina) {
                    is_vpn = true;
                    console.log('[AutoReport] ğŸ” VPN åˆ¤å®š: æ£€æµ‹åˆ° VPN ç”¨æˆ·', {
                        timezone,
                        countryCode,
                        is_vpn: true,
                        reason: 'æ—¶åŒºä¸ºAsia/Shanghaiä½†IPä¸åœ¨ä¸­å›½'
                    });
                } else {
                    // å¦‚æœä¿¡æ¯ä¸è¶³ï¼ˆcountryCode ä¸º Unknownï¼‰ï¼Œä¸åˆ¤å®šä¸º VPN
                    const reason = countryCode === 'Unknown' || countryCode === null 
                        ? 'IPä½ç½®ä¿¡æ¯ä¸è¶³ï¼Œæ— æ³•åˆ¤å®š' 
                        : (isShanghaiTimezone ? 'IPä½ç½®æ­£å¸¸ï¼ˆåœ¨ä¸­å›½ï¼‰' : 'æ—¶åŒºä¸åŒ¹é…');
                    
                    console.log('[AutoReport] ğŸ” VPN åˆ¤å®š: æ­£å¸¸ç”¨æˆ·æˆ–ä¿¡æ¯ä¸è¶³', {
                        timezone,
                        countryCode,
                        is_vpn: false,
                        reason
                    });
                }

                // 4. æ„å»ºæäº¤æ•°æ®
                const payload = {
                    user_name: 'è‡ªåŠ¨ä¸ŠæŠ¥ç”¨æˆ·',
                    personality_type: 'AUTO_REPORT',
                    lat: lat,
                    lng: lng,
                    timezone: systemFeatures.timezone,
                    browser_lang: systemFeatures.browser_lang,
                    ip_location: ipLocation,
                    is_vpn: is_vpn
                };

                console.log('[AutoReport] ğŸ“¤ å‡†å¤‡æäº¤æ•°æ®åˆ° user_analysis è¡¨:', payload);

                // 5. æ’å…¥åˆ° Supabase
                const { data, error } = await supabaseClient
                    .from('user_analysis')
                    .insert([payload])
                    .select();

                if (error) {
                    console.error('[AutoReport] âŒ æäº¤å¤±è´¥:', error);
                    return { success: false, error: error.message };
                }

                console.log('[AutoReport] âœ… è‡ªåŠ¨ä¸ŠæŠ¥æˆåŠŸ:', data);

                // 6. ç«‹å³åé¦ˆï¼šä¸ŠæŠ¥æˆåŠŸåç«‹å³åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºè‡ªå·±çš„ä½ç½®ï¼ˆä¸ç­‰å¾… Realtime ç›‘å¬ï¼‰
                if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
                    // æ€§èƒ½ä¿æŠ¤ï¼šæ£€æŸ¥ triggerMapPulse å‡½æ•°æ˜¯å¦å·²å®šä¹‰
                    if (typeof triggerMapPulse === 'function') {
                        // æ ¹æ® VPN åˆ¤å®šç»“æœè®¾ç½®æ ‡ç­¾å’Œé¢œè‰²
                        const pulseLabel = is_vpn ? 'YOU [VPN PROXY]' : 'YOU [DIRECT]';
                        const pulseColor = is_vpn ? '#00ff41' : '#ffffff'; // VPN ç”¨æˆ·ç»¿è‰²ï¼Œæ­£å¸¸ç”¨æˆ·ç™½è‰²

                        // ç«‹å³è°ƒç”¨ triggerMapPulse æ˜¾ç¤ºè‡ªå·±çš„ä½ç½®
                        try {
                            triggerMapPulse(lng, lat, pulseLabel, pulseColor);
                            console.log('[AutoReport] ğŸ—ºï¸ å·²åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºè‡ªå·±çš„ä½ç½®:', {
                                lng,
                                lat,
                                label: pulseLabel,
                                color: pulseColor,
                                is_vpn
                            });
                        } catch (pulseError) {
                            console.warn('[AutoReport] âš ï¸ è°ƒç”¨ triggerMapPulse å¤±è´¥:', pulseError);
                        }
                    } else {
                        console.warn('[AutoReport] âš ï¸ triggerMapPulse å‡½æ•°æœªå®šä¹‰ï¼Œè·³è¿‡åœ°å›¾æ˜¾ç¤º');
                    }
                } else {
                    console.log('[AutoReport] â„¹ï¸ ç»çº¬åº¦ä¿¡æ¯ä¸å®Œæ•´ï¼Œè·³è¿‡åœ°å›¾æ˜¾ç¤º');
                }

                return { success: true, data };

            } catch (error) {
                console.error('[AutoReport] âŒ è‡ªåŠ¨ä¸ŠæŠ¥è¿‡ç¨‹å‡ºé”™:', error);
                return { success: false, error: error.message };
            }
        }

        /**
         * æäº¤ç”¨æˆ·åˆ†ææ•°æ®åˆ° user_analysis è¡¨ï¼ˆé‡‡é›†ç«¯å¢å¼ºï¼‰
         * åœ¨ insert æ—¶è‡ªåŠ¨å¢åŠ  timezone å’Œ browser_lang å­—æ®µ
         * @param {string} user_name - ç”¨æˆ·å
         * @param {string} personality_type - äººæ ¼ç±»å‹
         * @param {number} lat - çº¬åº¦
         * @param {number} lng - ç»åº¦
         * @returns {Promise<Object>} æäº¤ç»“æœ
         */
        async function submitUserAnalysis(user_name, personality_type, lat, lng) {
            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                console.warn('[Submit] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•æäº¤æ•°æ®');
                return { success: false, error: 'Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–' };
            }

            try {
                // å¼‚æ­¥è·å–ç³»ç»Ÿç‰¹å¾ï¼ˆéé˜»å¡ï¼Œä¸å½±å“é¡µé¢åŠ è½½é€Ÿåº¦ï¼‰
                const systemFeatures = await getUserSystemFeatures();
                console.log('[Submit] ğŸ“Š ç³»ç»Ÿç‰¹å¾å·²è·å–:', systemFeatures);

                // æ„å»ºæäº¤æ•°æ®ï¼ˆåŒ…å« timezone å’Œ browser_lang å­—æ®µï¼‰
                const payload = {
                    user_name: user_name || 'åŒ¿åç”¨æˆ·',
                    personality_type: personality_type || 'UNKNOWN',
                    lat: lat || null,
                    lng: lng || null,
                    timezone: systemFeatures.timezone, // ä½¿ç”¨ Intl.DateTimeFormat().resolvedOptions().timeZone
                    browser_lang: systemFeatures.browser_lang // ä½¿ç”¨ navigator.language
                };

                console.log('[Submit] ğŸ“¤ å‡†å¤‡æäº¤æ•°æ®åˆ° user_analysis è¡¨:', payload);

                // ä½¿ç”¨ Supabase å®¢æˆ·ç«¯æ’å…¥æ•°æ®
                const { data, error } = await supabaseClient
                    .from('user_analysis')
                    .insert([payload])
                    .select();

                if (error) {
                    console.error('[Submit] âŒ æäº¤å¤±è´¥:', error);
                    return { success: false, error: error.message };
                }

                console.log('[Submit] âœ… æ•°æ®å·²æˆåŠŸæäº¤ï¼ˆåŒ…å« timezone å’Œ browser_langï¼‰:', data);
                return { success: true, data };

            } catch (error) {
                console.error('[Submit] âŒ æäº¤è¿‡ç¨‹å‡ºé”™:', error);
                return { success: false, error: error.message };
            }
        }

        /**
         * è·å–å¹¶æ¸²æŸ“å¤§ç›˜æ•°æ®
         * åŸºäº index.ts çš„æ¥å£è¿”å›æ ¼å¼ï¼ˆæ•°æ®ç›´æ¥è¿”å›ï¼Œä¸åŒ…è£¹åœ¨ data å­—æ®µä¸­ï¼‰
         */
        async function fetchData() {
            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content;
            console.group('%c ğŸš€ Dashboard Data Sync Starting ', 'background: #222; color: #bada55; font-size: 12px;');
            
            try {
                // åŠ è½½è¿‡åœºï¼šéª¨æ¶å± + æ‰«æçº¿
                setLoadingState(true);

                console.log(`[1/5] æ­£åœ¨è¯·æ±‚: ${apiEndpoint}api/global-average`);
                const response = await fetch(`${apiEndpoint}api/global-average`);
                
                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
                
                const result = await response.json();
                console.log('[2/5] æ”¶åˆ°åŸå§‹å“åº”:', result);

                // ã€é€‚é…å±‚é‡å†™ã€‘ä½¿ç”¨å¼ºåˆ¶æ˜ å°„å±‚æ ‡å‡†åŒ–æ•°æ®
                const data = normalizeData(result);
                console.log('[3/5] æ•°æ®é€‚é…å®Œæˆ:', data);

                // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›è¯­è¨€åˆ‡æ¢æ—¶ä½¿ç”¨
                window.lastData = data;

                // --- æ¸²æŸ“æ•°å­—å¡ç‰‡ ---
                // ã€ID å­˜åœ¨æ€§æ£€æŸ¥ã€‘åœ¨æ‰§è¡Œ animateValue å‰ï¼Œå¿…é¡»æ£€æŸ¥ document.getElementById æ˜¯å¦éç©º
                // ã€åŠ¨ç”»å®¹é”™ã€‘é˜²æ­¢ NaN æˆ– undefined å¯¼è‡´å´©æºƒ
                
                // æ•°æ®è¿”å›ï¼šç§»é™¤éª¨æ¶å±å¹¶å¼€å§‹æ•°å­—æ»šåŠ¨
                setLoadingState(false);

                // 1. å·²è¯Šæ–­å¼€å‘è€…ï¼ˆåƒåˆ†ä½ï¼‰
                const totalUsers = Number(data.totalUsers) || 0;
                animateValue('totalUsers', totalUsers, 1400, { decimals: 0, useThousands: true });

                // 2. æ‰«ææ¬¡æ•° (totalAnalysis)
                const totalAnalysis = Number(data.totalAnalysis) || 0;
                animateValue('totalAnalysis', totalAnalysis, 1400, { decimals: 0, useThousands: true });

                // 3. ç´¯è®¡å­—æ•° (totalRoastWords)
                const totalRoastWords = Number(data.totalRoastWords) || 0;
                animateValue('totalChars', totalRoastWords, 1400, { decimals: 0, useThousands: true });

                // 4. äººå‡å¹³å‡ç¯‡å¹… (avgPerUser)
                const avgPerUser = Number(data.avgPerUser || 0);
                animateValue('avgPerUser', avgPerUser, 900, { decimals: 1, useThousands: true });

                // 5. å•æ¬¡å¹³å‡ç¯‡å¹… (avgPerScan)
                const avgPerScan = Number(data.avgPerScan || 0);
                animateValue('avgPerScan', avgPerScan, 900, { decimals: 1, useThousands: true });

                // 6. è¿è¡Œå¤©æ•°
                const systemDays = Number(data.systemDays) || 1;
                animateValue('systemDays', systemDays, 900, { decimals: 0, useThousands: true });

                // 7. è¦†ç›–åŸå¸‚
                const cityCount = Number(data.cityCount) || 0;
                animateValue('cityCount', cityCount, 900, { decimals: 0, useThousands: true });

                // --- æ¸²æŸ“äººæ ¼åˆ†å¸ƒæ’è¡Œ ---
                // ã€äººæ ¼æ’è¡Œæ¸²æŸ“å‡½æ•°ã€‘ä½¿ç”¨ç‹¬ç«‹çš„ renderPersonalityRank å‡½æ•°
                renderPersonalityRank(data.personalityRank, data.recentVictims);

                // --- æ¸²æŸ“å›¾è¡¨ç»„ä»¶ ---
                // æ¸²æŸ“åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œå’Œåœ°å›¾
                if (data.locationRank && Array.isArray(data.locationRank) && data.locationRank.length > 0) {
                    if (typeof echarts !== 'undefined') {
                        await initGlobalMap(data.locationRank);
                    }
                    renderLocationList(data.locationRank);
                } else {
                    const locationListEl = document.getElementById('locationList');
                    if (locationListEl) {
                        locationListEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
                    }
                }
                
                // æ¸²æŸ“é›·è¾¾å›¾ï¼ˆä¼˜å…ˆä½¿ç”¨ globalAverageï¼Œå¦åˆ™ä½¿ç”¨ averagesï¼‰
                // ã€ç¯å¢ƒå¯¹é½ã€‘ç¡®ä¿æ‰€æœ‰çš„ Number() è½¬æ¢é€»è¾‘åœ¨èµ‹å€¼å‰å®Œæˆ
                const radarData = data.globalAverage || data.averages || { L: 50, P: 50, D: 50, E: 50, F: 50 };
                if (typeof radarData === 'object' && typeof Chart !== 'undefined') {
                    // ç¡®ä¿æ‰€æœ‰å€¼éƒ½æ˜¯æ•°å­—ç±»å‹
                    const normalizedRadarData = {
                        L: Number(radarData.L || 50),
                        P: Number(radarData.P || 50),
                        D: Number(radarData.D || 50),
                        E: Number(radarData.E || 50),
                        F: Number(radarData.F || 50),
                    };
                    console.log(`[é›·è¾¾å›¾] æ•°æ®: L=${normalizedRadarData.L}, P=${normalizedRadarData.P}, D=${normalizedRadarData.D}, E=${normalizedRadarData.E}, F=${normalizedRadarData.F}`);
                    renderRadarChart(normalizedRadarData);
                } else {
                    console.warn('[é›·è¾¾å›¾] âŒ æ•°æ®æ ¼å¼é”™è¯¯æˆ– Chart.js æœªåŠ è½½');
                }
                
                // æ¸²æŸ“å®æ—¶è¯Šæ–­æ´»åŠ¨ï¼ˆä¼˜å…ˆä½¿ç”¨ latestRecordsï¼‰
                const activityData = data.latestRecords && data.latestRecords.length > 0 
                    ? data.latestRecords 
                    : (data.recentVictims || []);
                
                // åˆå§‹åŒ–å…¨å±€ latestRecords æ•°ç»„ï¼ˆç”¨äº Realtime æ›´æ–°ï¼‰
                latestRecords = Array.isArray(activityData) ? [...activityData] : [];
                // ç¡®ä¿é•¿åº¦ä¸è¶…è¿‡ 10
                if (latestRecords.length > 10) {
                    latestRecords = latestRecords.slice(0, 10);
                }
                
                renderRecentActivity(latestRecords);

                console.log('%c [5/5] âœ… æ¸²æŸ“é€»è¾‘åŒæ­¥å®Œæ¯• ', 'color: #00ff41');

                // æ‰§è¡Œè‡ªåŠ¨ä¸ŠæŠ¥ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                autoReportSelf().catch(err => {
                    console.warn('[AutoReport] âš ï¸ è‡ªåŠ¨ä¸ŠæŠ¥å¤±è´¥ï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰:', err);
                });

            } catch (err) {
                console.error('[ERROR] Dashboard æ¸²æŸ“å´©æºƒ:', err);
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                const container = document.querySelector('.max-w-\\[1600px\\]');
                if (container) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed top-4 right-4 bg-red-900/80 text-white px-4 py-2 rounded border border-red-500 z-50';
                    errorDiv.textContent = `é”™è¯¯: ${err.message || 'æ•°æ®åŠ è½½å¤±è´¥'}`;
                    container.appendChild(errorDiv);
                    
                    setTimeout(() => {
                        errorDiv.remove();
                    }, 5000);
                }
            } finally {
                // ç¡®ä¿å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿå…³é—­åŠ è½½è¿‡åœº
                setLoadingState(false);
                console.groupEnd();
            }
        }


        window.onload = async () => {
            // å…ˆæ‰§è¡Œåˆå§‹æ•°æ®åŠ è½½
            await fetchData();
            
            // åˆå§‹åŠ è½½å®Œæˆåï¼Œå¯åŠ¨ Realtime ç›‘å¬
            // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿æ‰€æœ‰æ¸²æŸ“å·²å®Œæˆ
            setTimeout(() => {
                startRealtimeListener();
            }, 500);
        };

        // é¡µé¢å¸è½½æ—¶æ¸…ç† Realtime ç›‘å¬
        window.addEventListener('beforeunload', () => {
            stopRealtimeListener();
        });
    </script>
</body>
</html>
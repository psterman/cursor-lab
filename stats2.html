<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Statistics Dashboard - Vibe Coding</title>
    <!-- API Endpoint -->
    <meta name="api-endpoint" content="https://cursor-clinical-analysis.psterman.workers.dev/">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/map/js/world.js" onload="this.setAttribute('data-loaded', 'true')"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --bg-color: #050505;
            --card-bg: rgba(24, 24, 27, 0.7);
            --card-border: #27272a;
            --text-main: #ffffff;
            --text-dim: #71717a;
            --accent-terminal: #00ff41;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 65, 0.02) 2px,
                    rgba(0, 255, 65, 0.02) 4px
                ),
                radial-gradient(
                    circle,
                    rgba(0, 255, 65, 0.03) 1px,
                    transparent 1px
                );
            background-size: 100% 4px, 20px 20px;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(0, 255, 65, 0.05) 50%,
                transparent 100%
            );
            animation: scanline 8s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .hacker-border {
            border: 1px solid var(--card-border);
            position: relative;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
        }

        .hacker-border::before {
            content: '';
            position: absolute;
            top: -1px; left: 0; width: 60px; height: 1px;
            background: var(--accent-terminal);
            box-shadow: 0 0 10px var(--accent-terminal);
        }

        #map-container {
            width: 100%;
            height: 600px;
        }

        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            border-color: var(--accent-terminal);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
        }

        .lang-btn {
            border: 1px solid var(--card-border);
            color: var(--text-dim);
            transition: all 0.2s;
        }

        .lang-btn.active {
            border-color: var(--accent-terminal);
            color: var(--accent-terminal);
            background: rgba(0, 255, 65, 0.05);
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse { animation: pulse-soft 2s infinite; }
        
        /* ç¡®ä¿å†…å®¹åœ¨èƒŒæ™¯åŠ¨ç”»ä¹‹ä¸Š */
        body > div {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-[1600px] mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black tracking-tighter italic flex items-center gap-2">
                    <span class="text-white">GLOBAL</span>
                    <span class="text-[var(--accent-terminal)]">DATA_STATION</span>
                </h1>
                <p id="sub-title" class="text-[10px] text-zinc-500 tracking-[0.3em] font-bold uppercase mt-1">Telemetry Uplink: Active // Source: Central_Pacific</p>
            </div>
            
            <div class="flex gap-2">
                <button onclick="switchLang('zh')" id="btn-zh" class="lang-btn active px-4 py-1 text-[10px] font-bold uppercase">ZH</button>
                <button onclick="switchLang('en')" id="btn-en" class="lang-btn px-4 py-1 text-[10px] font-bold uppercase">EN</button>
            </div>
        </div>

        <!-- Main Dashboard Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            
            <!-- Side Panel: Core Metrics -->
            <div class="xl:col-span-1 flex flex-col gap-4 order-2 xl:order-1">
                <div class="hacker-border p-6 rounded-sm stat-card">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-victims">å·²è¯Šæ–­å¼€å‘è€…</div>
                    <div id="totalUsers" class="text-4xl font-bold text-[var(--accent-terminal)]">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">USERS_RECOGNIZED_SUCCESSFULLY</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-analysis">å…¨ç½‘æ‰«ææ¬¡æ•°</div>
                    <div id="totalAnalysis" class="text-4xl font-bold">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">TOTAL_SCAN_COUNT</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-roast">ç´¯è®¡åæ§½å­—æ•°</div>
                    <div id="totalChars" class="text-4xl font-bold">0</div>
                    <div class="mt-4 h-1 bg-zinc-800 w-full overflow-hidden">
                        <div class="bg-[var(--accent-terminal)] h-full w-[65%]"></div>
                    </div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="avg-chars">å¹³å‡åæ§½å­—æ•°</div>
                    <div id="avgChars" class="text-4xl font-bold">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">AVG_ROAST_WORDS</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card bg-zinc-900/40">
                    <div class="text-[10px] text-zinc-500 mb-4 uppercase tracking-widest lang-key" data-key="radar-title">å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒ</div>
                    <div class="aspect-square">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Central Map Area -->
            <div class="xl:col-span-3 order-1 xl:order-2">
                <div class="hacker-border rounded-sm overflow-hidden relative group">
                    <div id="map-container"></div>
                    
                    <!-- Top Overlay Indicators -->
                    <div class="absolute top-4 left-4 pointer-events-none">
                        <div class="flex gap-4">
                            <div class="bg-black/60 border border-zinc-800 px-3 py-2 rounded">
                                <span class="text-[9px] block text-zinc-500 lang-key" data-key="active-nodes">æ´»è·ƒèŠ‚ç‚¹</span>
                                <span class="text-xs font-bold text-emerald-400 flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full pulse"></span>
                                    242 CONNECTED
                                </span>
                            </div>
                            <div class="bg-black/60 border border-zinc-800 px-3 py-2 rounded">
                                <span class="text-[9px] block text-zinc-500 lang-key" data-key="threat-level">é£é™©è¯„çº§</span>
                                <span class="text-xs font-bold text-red-500">LEVEL_CRITICAL</span>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Horizontal Stats -->
                    <div class="absolute bottom-4 left-4 right-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="top-hotspot">æœ€å¯†é›†çƒ­åŒº</div>
                            <div id="top-country" class="text-sm font-bold truncate">...</div>
                        </div>
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="sys-days">è¿è¡Œå¤©æ•°</div>
                            <div id="systemDays" class="text-xl font-bold">0</div>
                        </div>
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="city-coverage">åŸå¸‚è¦†ç›–</div>
                            <div id="cityCount" class="text-xl font-bold">0</div>
                        </div>
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="sync-rate">åŒæ­¥é€Ÿç‡</div>
                            <div class="text-xl font-bold text-[var(--accent-terminal)]">99.8%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Charts & Logs -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mt-6">
            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="hot-list">åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ</h3>
                <div id="locationList" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="personality-dist">äººæ ¼åˆ†å¸ƒæ’è¡Œ</h3>
                <div id="personalityDistribution" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm flex flex-col">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="recent-activity">å®æ—¶è¯Šæ–­æ´»åŠ¨</h3>
                <div id="recentActivity" class="flex-1 overflow-y-auto max-h-[300px] text-[10px] font-mono space-y-4 pr-2">
                    <!-- Logs here -->
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm bg-zinc-900/20">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="system-logs">æ ¸å¿ƒç³»ç»Ÿæ—¥å¿—</h3>
                <div id="log-console" class="text-[9px] font-mono text-emerald-900/80 leading-relaxed overflow-hidden">
                    <div>[SYS] Handshake with Cloudflare... OK</div>
                    <div>[DB] Querying Supabase v_global_stats...</div>
                    <div>[MAP] World mesh topology built</div>
                    <div>[AUTH] AES-256 encrypted channel active</div>
                    <div id="dynamic-log"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content;
        let currentLang = 'zh';

        const i18n = {
            zh: {
                'sub-title': 'å®æ—¶è¿œç¨‹ç›‘æµ‹çŠ¶æ€ // èŠ‚ç‚¹ï¼šå¤ªå¹³æ´‹ä¸­éƒ¨',
                'total-victims': 'å·²è¯Šæ–­å¼€å‘è€…',
                'total-analysis': 'å…¨ç½‘æ‰«ææ¬¡æ•°',
                'total-roast': 'ç´¯è®¡åæ§½å­—æ•°',
                'avg-chars': 'å¹³å‡åæ§½å­—æ•°',
                'radar-title': 'å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒ',
                'personality-dist': 'äººæ ¼åˆ†å¸ƒæ’è¡Œ',
                'active-nodes': 'æ´»è·ƒèŠ‚ç‚¹',
                'threat-level': 'é£é™©è¯„çº§',
                'top-hotspot': 'æœ€å¯†é›†çƒ­åŒº',
                'sys-days': 'è¿è¡Œå¤©æ•°',
                'city-coverage': 'åŸå¸‚è¦†ç›–',
                'sync-rate': 'åŒæ­¥é€Ÿç‡',
                'hot-list': 'åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ',
                'recent-activity': 'å®æ—¶è¯Šæ–­æ´»åŠ¨',
                'system-logs': 'æ ¸å¿ƒç³»ç»Ÿæ—¥å¿—',
                'victim': 'å—å®³è€…',
                'loading': 'åˆå§‹åŒ–ä¸­...',
                'rank': 'æ’å'
            },
            en: {
                'sub-title': 'Telemetry Status // Node: Central_Pacific',
                'total-victims': 'Total Developers',
                'total-analysis': 'Total Scans',
                'total-roast': 'Total Roast Words',
                'avg-chars': 'Avg Roast Words',
                'radar-title': 'Global Developer Persona',
                'personality-dist': 'Personality Distribution',
                'active-nodes': 'Active Nodes',
                'threat-level': 'Threat Level',
                'top-hotspot': 'Primary Hotspot',
                'sys-days': 'Days Online',
                'city-coverage': 'City Coverage',
                'sync-rate': 'Sync Rate',
                'hot-list': 'Geographic Hotspots',
                'recent-activity': 'Live Activity Feed',
                'system-logs': 'Core System Logs',
                'victim': 'Victim',
                'loading': 'Initializing...',
                'rank': 'Rank'
            }
        };

        const countryNameMap = {
            'CN': { zh: 'ä¸­å›½', en: 'China' },
            'US': { zh: 'ç¾å›½', en: 'USA' },
            'JP': { zh: 'æ—¥æœ¬', en: 'Japan' },
            'GB': { zh: 'è‹±å›½', en: 'UK' },
            'DE': { zh: 'å¾·å›½', en: 'Germany' },
            'SG': { zh: 'æ–°åŠ å¡', en: 'Singapore' },
            'HK': { zh: 'ä¸­å›½é¦™æ¸¯', en: 'Hong Kong' },
            'TW': { zh: 'ä¸­å›½å°æ¹¾', en: 'Taiwan' }
        };

        let mapChart, radarChart;

        /**
         * æ•°å­—æ ¼å¼åŒ–å‡½æ•°ï¼ˆæ™ºèƒ½å¤„ç†å¤§æ•°å­—ï¼‰
         * @param {number} num - è¦æ ¼å¼åŒ–çš„æ•°å­—
         * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼ˆå¦‚ 1.2M, 3.5Kï¼‰
         */
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) {
                return '0';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        /**
         * æ•°å­—æ»šåŠ¨åŠ¨ç”»å‡½æ•°
         * @param {HTMLElement} element - ç›®æ ‡å…ƒç´ 
         * @param {number} start - èµ·å§‹å€¼
         * @param {number} end - ç»“æŸå€¼
         * @param {number} duration - åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
         * @param {boolean} useFormat - æ˜¯å¦ä½¿ç”¨ formatNumber æ ¼å¼åŒ–ï¼ˆé»˜è®¤ trueï¼‰
         */
        function animateValue(element, start, end, duration = 1500, useFormat = true) {
            if (!element) return;
            
            // ç¡®ä¿ start å’Œ end éƒ½æ˜¯æ•°å­—ç±»å‹
            start = Number(start) || 0;
            end = Number(end) || 0;
            
            const startTime = performance.now();
            const isInteger = Number.isInteger(start) && Number.isInteger(end);
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°ï¼ˆeaseOutCubicï¼‰
                const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                const current = start + (end - start) * easeOutCubic;
                
                // æ ¹æ®æ˜¯å¦ä½¿ç”¨æ ¼å¼åŒ–æ¥å†³å®šæ˜¾ç¤ºæ–¹å¼
                if (useFormat) {
                    // ä½¿ç”¨ formatNumber æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆæ™ºèƒ½å¤„ç†å¤§æ•°å­—ï¼‰
                    element.textContent = formatNumber(Math.floor(current));
                } else {
                    // ä½¿ç”¨åŸå§‹æ•°å­—æ˜¾ç¤º
                    if (isInteger) {
                        element.textContent = Math.floor(current).toLocaleString();
                    } else {
                        element.textContent = current.toFixed(1).toLocaleString();
                    }
                }
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    // ç¡®ä¿æœ€ç»ˆå€¼å‡†ç¡®
                    if (useFormat) {
                        element.textContent = formatNumber(end);
                    } else {
                        if (isInteger) {
                            element.textContent = end.toLocaleString();
                        } else {
                            element.textContent = end.toFixed(1).toLocaleString();
                        }
                    }
                }
            }
            
            requestAnimationFrame(update);
        }

        function switchLang(lang) {
            currentLang = lang;
            document.getElementById('btn-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('btn-en').classList.toggle('active', lang === 'en');
            
            // æ›´æ–°é™æ€æ–‡æ¡ˆ
            document.getElementById('sub-title').innerText = i18n[lang]['sub-title'];
            document.querySelectorAll('.lang-key').forEach(el => {
                const key = el.getAttribute('data-key');
                el.innerText = i18n[lang][key];
            });

            // é‡æ–°æ¸²æŸ“æ•°æ®ä¾èµ–å‹ç»„ä»¶
            if (window.lastData) {
                renderLocationList(window.lastData.locationRank);
                const activityData = window.lastData.latestRecords || window.lastData.recentVictims || [];
                renderRecentActivity(activityData);
                renderPersonalityDistribution(window.lastData.personalityDistribution);
                // å¼‚æ­¥æ¸²æŸ“åœ°å›¾ï¼Œç¡®ä¿åœ°å›¾æ•°æ®å·²åŠ è½½
                initGlobalMap(window.lastData.locationRank).catch(err => {
                    console.warn('[Dashboard] è¯­è¨€åˆ‡æ¢æ—¶åœ°å›¾æ¸²æŸ“å¤±è´¥:', err);
                });
            }
        }

        /**
         * æ£€æŸ¥åœ°å›¾æ•°æ®æ˜¯å¦å·²åŠ è½½
         * world.js åŠ è½½åä¼šåœ¨ echarts ä¸­æ³¨å†Œ 'world' åœ°å›¾
         */
        async function checkMapLoaded() {
            if (typeof echarts === 'undefined') {
                return false;
            }
            
            // æ£€æŸ¥åœ°å›¾æ˜¯å¦å·²æ³¨å†Œ
            // ECharts 5.x ä½¿ç”¨ getMap æ–¹æ³•æ£€æŸ¥
            try {
                if (typeof echarts.getMap === 'function') {
                    const mapData = echarts.getMap('world');
                    if (mapData) {
                        console.log('[Map] âœ… åœ°å›¾æ•°æ®å·²æ³¨å†Œ');
                        return true;
                    }
                }
                
                // é™çº§æ£€æŸ¥ï¼šå°è¯•æ³¨å†Œåœ°å›¾ï¼ˆå¦‚æœ world.js å·²åŠ è½½ï¼Œåœ°å›¾æ•°æ®ä¼šåœ¨å…¨å±€å˜é‡ä¸­ï¼‰
                // world.js é€šå¸¸ä¼šå°†åœ°å›¾æ•°æ®å­˜å‚¨åœ¨æŸä¸ªå…¨å±€å˜é‡ä¸­
                // å¦‚æœå­˜åœ¨ï¼Œæ‰‹åŠ¨æ³¨å†Œ
                if (typeof window !== 'undefined' && window.worldMapData) {
                    echarts.registerMap('world', window.worldMapData);
                    console.log('[Map] âœ… ä»å…¨å±€å˜é‡æ³¨å†Œåœ°å›¾');
                    return true;
                }
                
                // æ£€æŸ¥è„šæœ¬æ ‡ç­¾æ˜¯å¦å·²åŠ è½½
                const worldScript = document.querySelector('script[src*="world.js"]');
                if (worldScript && worldScript.getAttribute('data-loaded') === 'true') {
                    console.log('[Map] âœ… world.js è„šæœ¬å·²æ ‡è®°ä¸ºåŠ è½½');
                    return true;
                }
                
                console.warn('[Map] âš ï¸ åœ°å›¾æ•°æ®æœªæ‰¾åˆ°ï¼Œç­‰å¾… world.js åŠ è½½...');
                return false;
            } catch (error) {
                console.warn('[Map] âš ï¸ æ£€æŸ¥åœ°å›¾æ•°æ®æ—¶å‡ºé”™:', error);
                return false;
            }
        }

        /**
         * ç­‰å¾…åœ°å›¾æ•°æ®åŠ è½½å®Œæˆ
         */
        async function waitForMapData(maxWait = 10000) {
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWait) {
                if (await checkMapLoaded()) {
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.warn('[Map] âš ï¸ ç­‰å¾…åœ°å›¾æ•°æ®è¶…æ—¶');
            return false;
        }

        /**
         * åˆå§‹åŒ–ä¸–ç•Œåœ°å›¾
         * @param {Array} locationData - åœ°ç†ä½ç½®æ•°æ® [{name: string, value: number}]
         */
        async function initGlobalMap(locationData) {
            const chartDom = document.getElementById('map-container');
            if (!chartDom) {
                console.warn('[Map] âš ï¸ æ‰¾ä¸åˆ°åœ°å›¾å®¹å™¨å…ƒç´ ');
                return;
            }
            
            // æ£€æŸ¥ ECharts æ˜¯å¦å·²åŠ è½½
            if (typeof echarts === 'undefined') {
                console.warn('[Map] âš ï¸ ECharts æœªåŠ è½½ï¼Œæ— æ³•æ¸²æŸ“åœ°å›¾');
                return;
            }
            
            // ç­‰å¾…åœ°å›¾æ•°æ®åŠ è½½å®Œæˆ
            const mapLoaded = await waitForMapData(10000);
            if (!mapLoaded) {
                console.error('[Map] âŒ åœ°å›¾æ•°æ®åŠ è½½å¤±è´¥ï¼Œæ— æ³•æ¸²æŸ“åœ°å›¾');
                chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">åœ°å›¾æ•°æ®åŠ è½½ä¸­...</div>';
                return;
            }
            
            // ã€åœ°å›¾æ³¨å†Œæ£€æŸ¥ã€‘ç¡®ä¿åœ°å›¾å·²æ³¨å†Œï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•æ‰‹åŠ¨æ³¨å†Œ
            try {
                // æ£€æŸ¥åœ°å›¾æ˜¯å¦å·²æ³¨å†Œ
                if (typeof echarts.getMap === 'function') {
                    const existingMap = echarts.getMap('world');
                    if (!existingMap) {
                        console.warn('[Map] âš ï¸ åœ°å›¾æœªæ³¨å†Œï¼Œå°è¯•ä»å…¨å±€å˜é‡æ³¨å†Œ...');
                        // world.js åŠ è½½åï¼Œåœ°å›¾æ•°æ®å¯èƒ½åœ¨å…¨å±€å˜é‡ä¸­
                        // å°è¯•ä»å¸¸è§çš„å…¨å±€å˜é‡åè·å–
                        if (typeof window !== 'undefined') {
                            // world.js å¯èƒ½å°†æ•°æ®å­˜å‚¨åœ¨ window å¯¹è±¡ä¸Š
                            const possibleMapData = window.worldMapData || window.world || window.worldGeoJSON;
                            if (possibleMapData) {
                                echarts.registerMap('world', possibleMapData);
                                console.log('[Map] âœ… ä»å…¨å±€å˜é‡æ‰‹åŠ¨æ³¨å†Œåœ°å›¾æˆåŠŸ');
                            } else {
                                console.warn('[Map] âš ï¸ æ— æ³•æ‰¾åˆ°åœ°å›¾æ•°æ®ï¼Œåœ°å›¾å¯èƒ½æ— æ³•æ­£å¸¸æ˜¾ç¤º');
                            }
                        }
                    } else {
                        console.log('[Map] âœ… åœ°å›¾å·²æ³¨å†Œï¼Œå¯ä»¥æ­£å¸¸æ¸²æŸ“');
                    }
                }
            } catch (registerError) {
                console.warn('[Map] âš ï¸ åœ°å›¾æ³¨å†Œæ£€æŸ¥å¤±è´¥:', registerError);
            }
            
            try {
                // é”€æ¯æ—§å›¾è¡¨
                if (mapChart) {
                    mapChart.dispose();
                    mapChart = null;
                }
                
                // åˆå§‹åŒ–å›¾è¡¨
                mapChart = echarts.init(chartDom);
                
                // å¤„ç†åœ°ç†ä½ç½®æ•°æ®
                const processedData = (locationData || []).map(item => ({
                    name: (countryNameMap[item.name] ? countryNameMap[item.name].en : item.name),
                    value: item.value || 0
                }));
                
                console.log('[Map] å¤„ç†åçš„æ•°æ®:', processedData);
                
                // é…ç½®åœ°å›¾é€‰é¡¹
                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: '#18181b',
                        borderColor: '#27272a',
                        textStyle: { color: '#00ff41', fontFamily: 'JetBrains Mono' },
                        formatter: (params) => {
                            const label = countryNameMap[params.data?.name]?.zh || params.name;
                            return `${label}: ${params.value || 0}`;
                        }
                    },
                    visualMap: {
                        min: 0,
                        max: Math.max(20, ...processedData.map(d => d.value || 0)),
                        show: false,
                        inRange: { color: ['#064e3b', '#065f46', '#00ff41'] }
                    },
                    series: [{
                        type: 'map',
                        map: 'world', // ä½¿ç”¨å·²æ³¨å†Œçš„ 'world' åœ°å›¾
                        roam: true,
                        zoom: 1.2,
                        itemStyle: {
                            areaColor: 'rgba(39, 39, 42, 0.4)',
                            borderColor: 'rgba(0, 255, 65, 0.2)',
                            borderWidth: 0.5
                        },
                        emphasis: {
                            itemStyle: { areaColor: '#00ff41' },
                            label: { show: false }
                        },
                        data: processedData
                    }]
                };
                
                // è®¾ç½®åœ°å›¾é€‰é¡¹
                mapChart.setOption(option);
                
                // å“åº”å¼è°ƒæ•´
                const resizeHandler = () => {
                    if (mapChart) {
                        mapChart.resize();
                    }
                };
                window.addEventListener('resize', resizeHandler);
                
                // ä¿å­˜ resize handlerï¼Œä»¥ä¾¿åç»­æ¸…ç†
                if (!window.mapResizeHandler) {
                    window.mapResizeHandler = resizeHandler;
                }
                
                console.log('[Map] âœ… åœ°å›¾æ¸²æŸ“å®Œæˆ');
            } catch (error) {
                console.error('[Map] âŒ åœ°å›¾æ¸²æŸ“å¤±è´¥:', error);
                chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">åœ°å›¾æ¸²æŸ“å¤±è´¥</div>';
            }
        }

        function renderRadarChart(averages) {
            // ã€ID å­˜åœ¨æ€§æ£€æŸ¥ã€‘åœ¨æ‰§è¡Œå‰ï¼Œå¿…é¡»æ£€æŸ¥ document.getElementById æ˜¯å¦éç©º
            const radarCanvas = document.getElementById('radarChart');
            if (!radarCanvas) {
                console.warn('[é›·è¾¾å›¾] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            const ctx = radarCanvas.getContext('2d');
            if (!ctx) {
                console.warn('[é›·è¾¾å›¾] âŒ æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡');
                return;
            }
            
            if (radarChart) radarChart.destroy();

            const labels = currentLang === 'zh' ? ['è¯­è¨€', 'æ¨¡å¼', 'æ·±åº¦', 'æ•ˆç‡', 'é¢‘ç‡'] : ['Lang', 'Pattern', 'Depth', 'Effi', 'Freq'];
            // ã€ç¯å¢ƒå¯¹é½ã€‘ç¡®ä¿æ‰€æœ‰çš„ Number() è½¬æ¢é€»è¾‘åœ¨èµ‹å€¼å‰å®Œæˆ
            const data = [
                Number(averages.L || 50),
                Number(averages.P || 50),
                Number(averages.D || 50),
                Number(averages.E || 50),
                Number(averages.F || 50)
            ];

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        borderWidth: 1,
                        pointRadius: 2
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: '#27272a' },
                            grid: { color: '#27272a' },
                            pointLabels: { color: '#71717a', font: { size: 9 } },
                            ticks: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderLocationList(data) {
            const list = document.getElementById('locationList');
            if (!data || data.length === 0) return;
            
            list.innerHTML = data.slice(0, 5).map((item, i) => {
                const name = countryNameMap[item.name] ? countryNameMap[item.name][currentLang] : item.name;
                return `
                <div class="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2">
                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                    <span class="font-bold uppercase tracking-tighter">${name}</span>
                    <span class="text-[var(--accent-terminal)] font-bold">${item.value}</span>
                </div>`;
            }).join('');

            const top = data[0];
            document.getElementById('top-country').innerText = countryNameMap[top.name] ? countryNameMap[top.name][currentLang] : top.name;
        }

        function renderRecentActivity(victims) {
            const box = document.getElementById('recentActivity');
            if (!box) return;
            
            // ä¼˜å…ˆä½¿ç”¨ latestRecordsï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ recentVictims
            const records = victims || [];
            
            if (records.length === 0) {
                box.innerHTML = '<div class="text-zinc-500 text-center py-4">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            box.innerHTML = records.map((v, index) => {
                // å…¼å®¹ä¸¤ç§æ•°æ®æ ¼å¼ï¼šlatestRecords å’Œ recentVictims
                const time = v.time || v.created_at || new Date().toISOString();
                const type = v.type || v.personality_type || 'UNKNOWN';
                const location = v.location || v.ip_location || 'æœªçŸ¥';
                const name = v.name || `è®°å½•${index + 1}`;
                
                return `
                <div class="border-l-2 border-zinc-800 pl-3 py-1">
                    <div class="text-zinc-500">${new Date(time).toLocaleTimeString()}</div>
                    <div class="text-white">${name.length > 6 ? name.slice(0,6) + '...' : name}</div>
                    <div class="text-[var(--accent-terminal)]">${type} @ ${location}</div>
                </div>
            `;
            }).join('');
        }

        /**
         * æ¸²æŸ“äººæ ¼åˆ†å¸ƒæ’è¡Œ
         * @param {Array} distribution - äººæ ¼åˆ†å¸ƒæ•°æ® [{type: string, count: number}]
         */
        function renderPersonalityDistribution(distribution) {
            const list = document.getElementById('personalityDistribution');
            if (!list) return;
            
            if (!distribution || !Array.isArray(distribution) || distribution.length === 0) {
                list.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            list.innerHTML = distribution.map((item, i) => {
                const type = item.type || 'UNKNOWN';
                const count = Number(item.count) || 0;
                return `
                <div class="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2">
                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                    <span class="font-bold uppercase tracking-tighter">${type}</span>
                    <span class="text-[var(--accent-terminal)] font-bold">${count}</span>
                </div>`;
            }).join('');
        }

        /**
         * è·å–å¹¶æ¸²æŸ“å¤§ç›˜æ•°æ®
         * åŸºäº index.ts çš„æ¥å£è¿”å›æ ¼å¼ï¼ˆæ•°æ®ç›´æ¥è¿”å›ï¼Œä¸åŒ…è£¹åœ¨ data å­—æ®µä¸­ï¼‰
         */
        async function fetchData() {
            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content;
            console.group('%c ğŸš€ Dashboard Data Sync Starting ', 'background: #222; color: #bada55; font-size: 12px;');
            
            try {
                console.log(`[1/5] æ­£åœ¨è¯·æ±‚: ${apiEndpoint}api/global-average`);
                const response = await fetch(`${apiEndpoint}api/global-average`);
                
                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
                
                const result = await response.json();
                console.log('[2/5] æ”¶åˆ°åŸå§‹å“åº”:', result);

                // --- ã€ç»Ÿä¸€è§£æ„é€»è¾‘ã€‘ä½¿ç”¨ const data = result å…¼å®¹ç›´æ¥è¿”å›çš„å¯¹è±¡ç»“æ„ ---
                const data = result;

                // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›è¯­è¨€åˆ‡æ¢æ—¶ä½¿ç”¨
                window.lastData = data;

                console.log('[3/5] æ•°æ®é€‚é…å®Œæˆ:', data);

                // --- æ¸²æŸ“æ•°å­—å¡ç‰‡ ---
                // ã€ID å­˜åœ¨æ€§æ£€æŸ¥ã€‘åœ¨æ‰§è¡Œ animateValue å‰ï¼Œå¿…é¡»æ£€æŸ¥ document.getElementById æ˜¯å¦éç©º
                // ã€å¢å¼ºæ—¥å¿—ã€‘æ˜ç¡®è¾“å‡ºæ¯ä¸ªå¡ç‰‡è·å–åˆ°çš„å…·ä½“æ•°å€¼
                
                // 1. å·²è¯Šæ–­å¼€å‘è€…
                const totalUsers = Number(data.totalUsers) || 0;
                const totalUsersEl = document.getElementById('totalUsers');
                console.log(`[å¡ç‰‡: å·²è¯Šæ–­å¼€å‘è€…] æ•°æ®: ${totalUsers} | DOM: ${totalUsersEl ? 'âœ…' : 'âŒ'}`);
                if (totalUsersEl) {
                    animateValue(totalUsersEl, 0, totalUsers, 1500, true);
                } else {
                    console.warn('[å¡ç‰‡: å·²è¯Šæ–­å¼€å‘è€…] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                }

                // 2. æ‰«ææ¬¡æ•° (è§£å†³"å…¨ç½‘æ‰«ææ¬¡æ•°æœªåŠ è½½")
                const totalAnalysis = Number(data.totalAnalysis) || 0;
                const totalAnalysisEl = document.getElementById('totalAnalysis');
                console.log(`[å¡ç‰‡: æ‰«ææ¬¡æ•°] æ•°æ®: ${totalAnalysis} | DOM: ${totalAnalysisEl ? 'âœ…' : 'âŒ'}`);
                if (totalAnalysisEl) {
                    animateValue(totalAnalysisEl, 0, totalAnalysis, 1500, true);
                } else {
                    console.warn('[å¡ç‰‡: æ‰«ææ¬¡æ•°] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                }

                // 3. ç´¯è®¡å­—æ•° (è§£å†³"ç´¯è®¡åæ§½å­—æ•°æœªè·å–")
                const totalChars = Number(data.totalRoastWords || data.totalChars) || 0;
                const totalCharsEl = document.getElementById('totalChars');
                console.log(`[å¡ç‰‡: ç´¯è®¡å­—æ•°] æ•°æ®: ${totalChars} | DOM: ${totalCharsEl ? 'âœ…' : 'âŒ'}`);
                if (totalCharsEl) {
                    animateValue(totalCharsEl, 0, totalChars, 1500, true);
                } else {
                    console.warn('[å¡ç‰‡: ç´¯è®¡å­—æ•°] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                }

                // 4. å¹³å‡å­—æ•° (è§£å†³"å¹³å‡åæ§½å­—æ•°æœªåŠ è½½")
                // ã€ID å­˜åœ¨æ€§æ£€æŸ¥ã€‘avgChars å¿…é¡»æ£€æŸ¥
                const avgChars = Number(data.avgChars) || 0;
                const avgCharsEl = document.getElementById('avgChars');
                console.log(`[å¡ç‰‡: å¹³å‡å­—æ•°] æ•°æ®: ${avgChars} | DOM: ${avgCharsEl ? 'âœ…' : 'âŒ'}`);
                if (avgCharsEl) {
                    animateValue(avgCharsEl, 0, avgChars, 1000, false);
                } else {
                    console.warn('[å¡ç‰‡: å¹³å‡å­—æ•°] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                }

                // 5. è¿è¡Œå¤©æ•°
                const systemDays = Number(data.systemDays) || 1;
                const systemDaysEl = document.getElementById('systemDays');
                console.log(`[å¡ç‰‡: è¿è¡Œå¤©æ•°] æ•°æ®: ${systemDays} | DOM: ${systemDaysEl ? 'âœ…' : 'âŒ'}`);
                if (systemDaysEl) {
                    animateValue(systemDaysEl, 0, systemDays, 1000, false);
                } else {
                    console.warn('[å¡ç‰‡: è¿è¡Œå¤©æ•°] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                }

                // 6. è¦†ç›–åŸå¸‚
                const cityCount = Number(data.cityCount) || 0;
                const cityCountEl = document.getElementById('cityCount');
                console.log(`[å¡ç‰‡: è¦†ç›–åŸå¸‚] æ•°æ®: ${cityCount} | DOM: ${cityCountEl ? 'âœ…' : 'âŒ'}`);
                if (cityCountEl) {
                    animateValue(cityCountEl, 0, cityCount, 1000, false);
                } else {
                    console.warn('[å¡ç‰‡: è¦†ç›–åŸå¸‚] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                }

                // --- æ¸²æŸ“äººæ ¼åˆ†å¸ƒæ’è¡Œ (è§£å†³"äººæ ¼åˆ†å¸ƒæœªåŠ è½½") ---
                // ã€ID å­˜åœ¨æ€§æ£€æŸ¥ã€‘personalityChart å¿…é¡»æ£€æŸ¥
                const personalityEl = document.getElementById('personalityDistribution');
                console.log(`[å¡ç‰‡: äººæ ¼åˆ†å¸ƒ] DOM: ${personalityEl ? 'âœ…' : 'âŒ'}`);
                
                if (personalityEl) {
                    // ä¼˜å…ˆä½¿ç”¨ personalityRankï¼ˆä» v_personality_rank è§†å›¾è·å–ï¼‰
                    if (data.personalityRank && Array.isArray(data.personalityRank) && data.personalityRank.length > 0) {
                        // å¦‚æœ data.personalityRank å­˜åœ¨ï¼Œéå†å¹¶æ¸²æŸ“å¸¦æœ‰ percentage å®½åº¦çš„è¿›åº¦æ¡
                        personalityEl.innerHTML = data.personalityRank.map((item, i) => {
                            const type = item.type || 'æœªçŸ¥';
                            const count = Number(item.count || 0);
                            const percentage = Number(item.percentage || 0);
                            return `
                                <div class="mb-3">
                                    <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                        <span class="text-zinc-400">${i+1}. ${type}</span>
                                        <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                                    </div>
                                    <div class="w-full bg-zinc-800/50 h-1">
                                        <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                             style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        console.log(`[å¡ç‰‡: äººæ ¼åˆ†å¸ƒ] âœ… æ¸²æŸ“æˆåŠŸ (${data.personalityRank.length} æ¡)`);
                    } else if (data.personalityDistribution && Array.isArray(data.personalityDistribution) && data.personalityDistribution.length > 0) {
                        // å…¼å®¹æ—§æ ¼å¼
                        renderPersonalityDistribution(data.personalityDistribution);
                        console.log('[å¡ç‰‡: äººæ ¼åˆ†å¸ƒ] âœ… ä½¿ç”¨å…¼å®¹æ ¼å¼æ¸²æŸ“æˆåŠŸ');
                    } else {
                        // ã€äººæ ¼æ’è¡Œé™çº§æ–¹æ¡ˆã€‘å¦‚æœä¸å­˜åœ¨ï¼Œæ ¹æ® recentVictims æ•°ç»„ä¸­çš„ type å­—æ®µï¼Œå‰ç«¯å®æ—¶è®¡ç®—ä¸€ä¸ªåˆ†å¸ƒæ¯”ä¾‹ä½œä¸ºå¤‡ä»½å±•ç¤º
                        const recentVictims = data.recentVictims || data.latestRecords || [];
                        if (recentVictims.length > 0) {
                            console.log('[å¡ç‰‡: äººæ ¼åˆ†å¸ƒ] âš ï¸ personalityRank ä¸å­˜åœ¨ï¼Œä½¿ç”¨ recentVictims é™çº§æ–¹æ¡ˆ');
                            // ç»Ÿè®¡æ¯ä¸ªäººæ ¼ç±»å‹çš„å‡ºç°æ¬¡æ•°
                            const typeMap = new Map();
                            recentVictims.forEach((v) => {
                                const type = v.type || v.personality_type || 'UNKNOWN';
                                typeMap.set(type, (typeMap.get(type) || 0) + 1);
                            });
                            
                            // è®¡ç®—ç™¾åˆ†æ¯”
                            const total = recentVictims.length;
                            const personalityRank = Array.from(typeMap.entries())
                                .map(([type, count]) => ({
                                    type: type,
                                    count: Number(count) || 0,
                                    percentage: Math.round((Number(count) / total) * 100) || 0,
                                }))
                                .sort((a, b) => b.count - a.count)
                                .slice(0, 5); // å–å‰ 5 ä¸ª
                            
                            // æ¸²æŸ“é™çº§æ•°æ®
                            personalityEl.innerHTML = personalityRank.map((item, i) => {
                                const type = item.type || 'æœªçŸ¥';
                                const count = Number(item.count || 0);
                                const percentage = Number(item.percentage || 0);
                                return `
                                    <div class="mb-3">
                                        <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                            <span class="text-zinc-400">${i+1}. ${type}</span>
                                            <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                                        </div>
                                        <div class="w-full bg-zinc-800/50 h-1">
                                            <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                                 style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                            console.log(`[å¡ç‰‡: äººæ ¼åˆ†å¸ƒ] âœ… é™çº§æ–¹æ¡ˆæ¸²æŸ“æˆåŠŸ (${personalityRank.length} æ¡)`);
                        } else {
                            personalityEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
                            console.warn('[å¡ç‰‡: äººæ ¼åˆ†å¸ƒ] âŒ æ•°æ®ç¼ºå¤±');
                        }
                    }
                } else {
                    console.warn('[å¡ç‰‡: äººæ ¼åˆ†å¸ƒ] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                }

                // --- æ¸²æŸ“å›¾è¡¨ç»„ä»¶ ---
                // æ¸²æŸ“åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œå’Œåœ°å›¾
                if (data.locationRank && Array.isArray(data.locationRank) && data.locationRank.length > 0) {
                    if (typeof echarts !== 'undefined') {
                        await initGlobalMap(data.locationRank);
                    }
                    renderLocationList(data.locationRank);
                } else {
                    const locationListEl = document.getElementById('locationList');
                    if (locationListEl) {
                        locationListEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
                    }
                }
                
                // æ¸²æŸ“é›·è¾¾å›¾ï¼ˆä¼˜å…ˆä½¿ç”¨ globalAverageï¼Œå¦åˆ™ä½¿ç”¨ averagesï¼‰
                // ã€ç¯å¢ƒå¯¹é½ã€‘ç¡®ä¿æ‰€æœ‰çš„ Number() è½¬æ¢é€»è¾‘åœ¨èµ‹å€¼å‰å®Œæˆ
                const radarData = data.globalAverage || data.averages || { L: 50, P: 50, D: 50, E: 50, F: 50 };
                if (typeof radarData === 'object' && typeof Chart !== 'undefined') {
                    // ç¡®ä¿æ‰€æœ‰å€¼éƒ½æ˜¯æ•°å­—ç±»å‹
                    const normalizedRadarData = {
                        L: Number(radarData.L || 50),
                        P: Number(radarData.P || 50),
                        D: Number(radarData.D || 50),
                        E: Number(radarData.E || 50),
                        F: Number(radarData.F || 50),
                    };
                    console.log(`[é›·è¾¾å›¾] æ•°æ®: L=${normalizedRadarData.L}, P=${normalizedRadarData.P}, D=${normalizedRadarData.D}, E=${normalizedRadarData.E}, F=${normalizedRadarData.F}`);
                    renderRadarChart(normalizedRadarData);
                } else {
                    console.warn('[é›·è¾¾å›¾] âŒ æ•°æ®æ ¼å¼é”™è¯¯æˆ– Chart.js æœªåŠ è½½');
                }
                
                // æ¸²æŸ“å®æ—¶è¯Šæ–­æ´»åŠ¨ï¼ˆä¼˜å…ˆä½¿ç”¨ latestRecordsï¼‰
                const activityData = data.latestRecords && data.latestRecords.length > 0 
                    ? data.latestRecords 
                    : (data.recentVictims || []);
                renderRecentActivity(activityData);

                console.log('%c [5/5] âœ… æ¸²æŸ“é€»è¾‘åŒæ­¥å®Œæ¯• ', 'color: #00ff41');

            } catch (err) {
                console.error('[ERROR] Dashboard æ¸²æŸ“å´©æºƒ:', err);
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                const container = document.querySelector('.max-w-\\[1600px\\]');
                if (container) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed top-4 right-4 bg-red-900/80 text-white px-4 py-2 rounded border border-red-500 z-50';
                    errorDiv.textContent = `é”™è¯¯: ${err.message || 'æ•°æ®åŠ è½½å¤±è´¥'}`;
                    container.appendChild(errorDiv);
                    
                    setTimeout(() => {
                        errorDiv.remove();
                    }, 5000);
                }
            } finally {
                console.groupEnd();
            }
        }

        // æ¨¡æ‹Ÿå®æ—¶æ—¥å¿—
        setInterval(() => {
            const log = document.getElementById('dynamic-log');
            const msgs = ["[DB] Snapshot saved", "[NET] Syncing node " + Math.floor(Math.random()*100), "[SYS] Health check passing"];
            const p = document.createElement('div');
            p.innerText = `> ${msgs[Math.floor(Math.random()*msgs.length)]}`;
            log.prepend(p);
            if(log.children.length > 5) log.lastChild.remove();
        }, 4000);

        window.onload = fetchData;
    </script>
</body>
</html>
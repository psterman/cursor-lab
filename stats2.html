<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Statistics Dashboard - Vibe Coding</title>
    <!-- API Endpoint -->
    <meta name="api-endpoint" content="https://cursor-clinical-analysis.psterman.workers.dev/">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- ECharts WordCloud plugin (required for wordCloud series) -->
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2/dist/echarts-wordcloud.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/map/js/world.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --bg-color: #050505;
            --card-bg: rgba(24, 24, 27, 0.7);
            --card-border: #27272a;
            --text-main: #ffffff;
            --text-dim: #71717a;
            --accent-terminal: #00ff41;
        }

        /* Êï∞ÊçÆÂà∑Êñ∞ÊèêÁ§∫ÔºöÁü≠ÊöÇ‚ÄúÂëºÂê∏Èó™ÁÉÅ‚Äù */
        @keyframes breathe-flash {
            0% {
                transform: translateZ(0) scale(1);
                box-shadow: 0 0 0 rgba(0, 255, 65, 0);
                background-color: rgba(0, 255, 65, 0.02);
            }
            50% {
                transform: translateZ(0) scale(1.01);
                box-shadow: 0 0 18px rgba(0, 255, 65, 0.35);
                background-color: rgba(0, 255, 65, 0.06);
            }
            100% {
                transform: translateZ(0) scale(1);
                box-shadow: 0 0 0 rgba(0, 255, 65, 0);
                background-color: rgba(0, 255, 65, 0.02);
            }
        }
        .breathe-flash {
            animation: breathe-flash 0.9s ease-in-out 1;
        }

        /* ËØ≠‰πâÁàÜÂèë Tag Âä®ÁîªÔºöfade-in-up */
        @keyframes fade-in-up {
            0% { opacity: 0; transform: translateY(8px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .semantic-burst-tag {
            animation-name: fade-in-up;
            animation-duration: 520ms;
            animation-timing-function: ease-out;
            animation-fill-mode: both;
            will-change: transform, opacity;
        }

        /* WordCloud loader (pulse) */
        @keyframes wc-pulse {
            0%, 100% { opacity: 0.35; transform: scale(0.98); }
            50% { opacity: 1; transform: scale(1); }
        }
        .vibe-cloud-loader {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 220px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.02);
        }
        .vibe-cloud-loader .dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: rgba(168, 85, 247, 0.85);
            animation: wc-pulse 900ms ease-in-out infinite;
            margin: 0 6px;
        }
        .vibe-cloud-loader .dot:nth-child(2) { animation-delay: 120ms; opacity: 0.7; }
        .vibe-cloud-loader .dot:nth-child(3) { animation-delay: 240ms; opacity: 0.55; }
        .vibe-cloud-loader .label {
            margin-left: 12px;
            font-size: 12px;
            color: rgba(148, 163, 184, 0.9);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 65, 0.02) 2px,
                    rgba(0, 255, 65, 0.02) 4px
                ),
                radial-gradient(
                    circle,
                    rgba(0, 255, 65, 0.03) 1px,
                    transparent 1px
                );
            background-size: 100% 4px, 20px 20px;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(0, 255, 65, 0.05) 50%,
                transparent 100%
            );
            animation: scanline 8s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .hacker-border {
            border: 1px solid var(--card-border);
            position: relative;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
        }

        .hacker-border::before {
            content: '';
            position: absolute;
            top: -1px; left: 0; width: 60px; height: 1px;
            background: var(--accent-terminal);
            box-shadow: 0 0 10px var(--accent-terminal);
        }

        #map-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: auto;
            background: transparent;
        }

        /* Á°Æ‰øù‰∏ªÂÆπÂô®ÂÖÅËÆ∏Á©øÈÄèÔºå‰ΩÜ‰∫§‰∫íÂÖÉÁ¥†ÂèØÁÇπÂáª */
        .max-w-\[1600px\] {
            pointer-events: none;
        }

        /* ÊâÄÊúâÂèØ‰∫§‰∫íÂÖÉÁ¥†ÊÅ¢Â§ç pointer-events */
        .max-w-\[1600px\] button,
        .max-w-\[1600px\] input,
        .max-w-\[1600px\] select,
        .max-w-\[1600px\] textarea,
        .max-w-\[1600px\] a,
        .max-w-\[1600px\] [onclick],
        .max-w-\[1600px\] .stat-card,
        .max-w-\[1600px\] .hacker-border,
        .max-w-\[1600px\] canvas,
        .max-w-\[1600px\] #rank-cards-container,
        .max-w-\[1600px\] #rank-cards-container > *,
        .max-w-\[1600px\] .lang-flag-btn,
        .max-w-\[1600px\] img[onerror] {
            pointer-events: auto;
        }

        /* =========================
           È°∂ÈÉ®Âõ∫ÂÆö Header Ê†∑Âºè
           ========================= */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50; /* Âú®Âú∞Âõæ(z-index: 0)‰πã‰∏äÔºå‰ΩÜ‰Ωé‰∫éÊäΩÂ±â(z-index: 100) */
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
            pointer-events: auto; /* Á°Æ‰øùÂèØ‰ª•ÁÇπÂáª */
        }

        .top-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .top-header-title {
            display: flex;
            flex-direction: column;
        }

        .top-header-title h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 900;
            letter-spacing: -0.02em;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .top-header-title p {
            margin: 4px 0 0 0;
            font-size: 9px;
            color: #71717a;
            letter-spacing: 0.3em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .top-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .top-header-cards {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 768px) {
            .top-header {
                padding: 8px 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .top-header-left {
                width: 100%;
            }

            .top-header-right {
                width: 100%;
                justify-content: space-between;
            }

            .top-header-title h1 {
                font-size: 18px;
            }

            .top-header-title p {
                font-size: 8px;
            }

            .top-header-card {
                padding: 6px 10px;
            }

            .top-header-card-label {
                font-size: 8px;
            }

            .top-header-card-value {
                font-size: 10px;
            }

            body.p-4 {
                padding-top: 140px !important;
            }
        }

        .top-header-card {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 65, 0.2);
            border-radius: 4px;
            padding: 8px 12px;
            backdrop-filter: blur(10px);
        }

        .top-header-card-label {
            font-size: 9px;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .top-header-card-value {
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ‰∏∫ body Ê∑ªÂä†È°∂ÈÉ® paddingÔºåÈÅøÂÖçÂÜÖÂÆπË¢´ header ÈÅÆÊå° */
        body.p-4 {
            padding-top: 100px !important;
        }
        
        @media (min-width: 768px) {
            body.md\:p-8 {
                padding-top: 120px !important;
            }
        }

        /* =========================
           ËµõÂçöÊúãÂÖãÊäΩÂ±âÊ†∑Âºè
           ========================= */
        .cyber-drawer {
            position: fixed;
            top: 60px; /* Âú®È°∂ÈÉ® header ‰∏ãÊñπÔºå‰∏çÈÅÆÁõñ header */
            width: 400px;
            height: calc(100vh - 60px); /* ÂáèÂéª header È´òÂ∫¶ */
            z-index: 100; /* È´ò‰∫éÈ°∂ÈÉ® header (z-index: 50) */
            pointer-events: none;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .left-drawer {
            left: 0;
            transform: translateX(-100%);
        }

        .right-drawer {
            right: 0;
            transform: translateX(100%);
        }

        @media (max-width: 768px) {
            .cyber-drawer {
                top: 140px; /* ÁßªÂä®Á´Ø header Êõ¥È´ò */
                height: calc(100vh - 140px);
            }
        }

        .left-drawer.active {
            transform: translateX(0);
            pointer-events: auto;
        }

        .right-drawer.active {
            transform: translateX(0);
            pointer-events: auto;
        }

        .drawer-content {
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 5, 0.85);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0, 255, 65, 0.3);
            border-left: 1px solid rgba(0, 255, 65, 0.3);
            box-shadow: 
                0 0 30px rgba(0, 255, 65, 0.2),
                inset 0 0 50px rgba(0, 255, 65, 0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .right-drawer .drawer-content {
            border-right: none;
            border-left: 1px solid rgba(0, 255, 65, 0.3);
        }

        .left-drawer .drawer-content {
            border-left: none;
            border-right: 1px solid rgba(0, 255, 65, 0.3);
        }

        /* ËµõÂçöÊúãÂÖãÊâ´ÊèèÁ∫øÊïàÊûú */
        .drawer-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(0, 255, 65, 0.8),
                transparent
            );
            animation: drawer-scanline 3s linear infinite;
            z-index: 1;
        }

        @keyframes drawer-scanline {
            0% { transform: translateY(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }

        /* ÊäΩÂ±âÂ§¥ÈÉ® */
        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 255, 65, 0.05);
            position: relative;
            z-index: 2;
        }

        .drawer-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .drawer-icon {
            font-size: 20px;
            filter: drop-shadow(0 0 5px rgba(0, 255, 65, 0.8));
        }

        .drawer-title-text {
            font-size: 16px;
            font-weight: bold;
            color: #00ff41;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .drawer-close-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0, 255, 65, 0.3);
            color: #00ff41;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            font-weight: bold;
            background: rgba(0, 255, 65, 0.1);
        }

        .drawer-close-btn:hover {
            background: rgba(0, 255, 65, 0.3);
            border-color: #00ff41;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
            transform: scale(1.1);
        }

        /* ÊäΩÂ±âÂÜÖÂÆπÂå∫Âüü */
        .drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .drawer-body::-webkit-scrollbar {
            width: 6px;
        }

        .drawer-body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        .drawer-body::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.3);
            border-radius: 3px;
        }

        .drawer-body::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 65, 0.5);
        }

        /* ÊäΩÂ±âÂÜÖÂÆπÈ°πÊ†∑Âºè */
        .drawer-item {
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid rgba(0, 255, 65, 0.2);
            border-radius: 4px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .drawer-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(0, 255, 65, 0.1),
                transparent
            );
            transition: left 0.5s;
        }

        .drawer-item:hover {
            border-color: rgba(0, 255, 65, 0.5);
            background: rgba(0, 255, 65, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }

        .drawer-item:hover::before {
            left: 100%;
        }

        .drawer-item-label {
            font-size: 11px;
            color: rgba(0, 255, 65, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .drawer-item-value {
            font-size: 18px;
            color: #00ff41;
            font-weight: bold;
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .drawer-item-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 768px) {
            .cyber-drawer {
                width: 100%;
            }
        }

        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            border-color: var(--accent-terminal);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
        }

        /* =========================
           Language Switch (Flags)
           ========================= */
        .lang-flag-btn {
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            opacity: 0.6;
            transform: scale(1);
            box-shadow: none;
            overflow: hidden;
        }

        .lang-flag-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
            transition: all 0.4s ease;
            padding: 2px;
            outline: none;
            border: none;
            box-shadow: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .lang-flag-btn.active {
            opacity: 1;
            border: 3px solid var(--accent-terminal);
            box-shadow: 0 0 16px rgba(0, 255, 65, 0.6), 0 0 32px rgba(0, 255, 65, 0.3), inset 0 0 20px rgba(0, 255, 65, 0.1);
            transform: scale(1.1);
        }

        .lang-flag-btn:hover:not(.active) {
            opacity: 0.9;
            transform: scale(1.15);
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .lang-flag-btn:hover.active {
            /* ÈÄâ‰∏≠Áä∂ÊÄÅÔºö‰øùÊåÅ 3px Á≤óËæπÊ°ÜÔºåÂè™ÊîπÂèòÁº©ÊîæÂíåÈò¥ÂΩ± */
            border: 3px solid var(--accent-terminal);
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.8), 0 0 40px rgba(0, 255, 65, 0.4), inset 0 0 25px rgba(0, 255, 65, 0.15);
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.25s ease;
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse { animation: pulse-soft 2s infinite; }

        /* Âú®Á∫ø‰∫∫Êï∞Êï∞Â≠óÊõ¥Êñ∞Êó∂ÁöÑÁº©ÊîæÂä®Áîª */
        @keyframes scale-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .online-count-update {
            animation: scale-bounce 0.4s ease-out;
        }

        /* =========================
           Cyberpunk Loading Effects
           ========================= */
        @keyframes skeleton-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* ÊµÅÂÖâÈ™®Êû∂Â±èÔºöÁî®‰∫éÊï∞Â≠óÂç†‰ΩçÔºà‰∏ªÈ¢òËâ≤Áªø+ËìùÔºâ */
        .skeleton {
            position: relative;
            color: transparent !important;
            user-select: none;
            border-radius: 2px;
            background: linear-gradient(
                90deg,
                rgba(39, 39, 42, 0.25) 0%,
                rgba(0, 255, 65, 0.18) 40%,
                rgba(59, 130, 246, 0.14) 55%,
                rgba(39, 39, 42, 0.25) 100%
            );
            background-size: 240% 100%;
            animation: skeleton-shimmer 1.2s ease-in-out infinite;
            box-shadow: 0 0 18px rgba(0, 255, 65, 0.06);
        }

        /* È™®Êû∂Â±èÊúüÈó¥‰øùÊåÅÂ∏ÉÂ±ÄÈ´òÂ∫¶Á®≥ÂÆö */
        #totalUsers.skeleton,
        #totalAnalysis.skeleton,
        #totalChars.skeleton {
            min-height: 2.5rem;
        }
        #avgPerUser.skeleton,
        #avgPerScan.skeleton,
        #systemDays.skeleton,
        #cityCount.skeleton {
            min-height: 1.6rem;
        }

        @keyframes scan-sweep {
            0% { transform: translateY(-120%); opacity: 0; }
            10% { opacity: 0.9; }
            90% { opacity: 0.9; }
            100% { transform: translateY(120%); opacity: 0; }
        }

        /* ÂÖ®Â±èÊâ´ÊèèÁ∫øÔºöÂä†ËΩΩÊúüÈó¥Âè†Âä† */
        .scan-line {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 40;
            opacity: 0;
            mix-blend-mode: screen;
        }
        .scan-line::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 18vh;
            top: -20vh;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(0, 255, 65, 0.14) 45%,
                rgba(59, 130, 246, 0.10) 60%,
                transparent 100%
            );
            filter: blur(1px);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.12);
            animation: scan-sweep 1.6s linear infinite;
        }
        .scan-line.active {
            opacity: 1;
        }
        
        /* Á°Æ‰øùÂÜÖÂÆπÂú®ËÉåÊôØÂä®Áîª‰πã‰∏ä */
        body > div {
            position: relative;
            z-index: 10;
        }
        
        /* Áä∂ÊÄÅÊåâÈíÆÊøÄÊ¥ªÊ†∑Âºè */
        .status-btn.active {
            border-width: 2px;
            box-shadow: 0 0 10px currentColor;
        }
        
        /* Áî®Êà∑ÂàóË°®È°πÊ†∑Âºè */
        .user-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .user-item:hover {
            background: rgba(39, 39, 42, 0.5);
            border-color: var(--card-border);
        }
        
        /* Â§¥ÂÉèÂëºÂê∏ÁÅØËæπÊ°Ü */
        .avatar-pulse {
            position: relative;
            border-radius: 50%;
            padding: 2px;
        }
        
        .avatar-pulse::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            border: 2px solid currentColor;
            opacity: 0.6;
            animation: pulse-border 2s ease-in-out infinite;
        }
        
        @keyframes pulse-border {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        /* ÁßÅ‰ø°ÊµÆÁ™óÊ†∑Âºè */
        .message-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border: 2px solid var(--accent-terminal);
            border-radius: 8px;
            padding: 20px;
            min-width: 300px;
            max-width: 500px;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
            animation: popup-appear 0.3s ease-out;
        }
        
        @keyframes popup-appear {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .message-popup.destroying {
            animation: popup-destroy 0.5s ease-out forwards;
        }
        
        @keyframes popup-destroy {
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }
        
        /* ÁßÅ‰ø°ËæìÂÖ•Ê°ÜÊ†∑Âºè */
        .message-input-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .message-input-box {
            background: var(--card-bg);
            border: 2px solid var(--accent-terminal);
            border-radius: 8px;
            padding: 20px;
            min-width: 400px;
            z-index: 1000;
        }
        
        /* ÊÇ¨ÊµÆÊäΩÂ±âÂºèÂàóË°®Ê†∑Âºè */
        .live-nodes-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .live-nodes-drawer.collapsed {
            transform: translateY(calc(100% - 48px));
        }
        
        .live-nodes-drawer.expanded {
            transform: translateY(0);
        }
        
        .live-nodes-header {
            background: rgba(24, 24, 27, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 2px solid var(--accent-terminal);
            box-shadow: 0 -4px 20px rgba(0, 255, 65, 0.2);
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        
        .live-nodes-header:hover {
            background: rgba(24, 24, 27, 0.95);
            box-shadow: 0 -4px 30px rgba(0, 255, 65, 0.3);
        }
        
        .live-nodes-content {
            background: rgba(24, 24, 27, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(0, 255, 65, 0.2);
            max-height: 400px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        #online-users-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .live-nodes-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .live-nodes-content::-webkit-scrollbar-track {
            background: rgba(39, 39, 42, 0.5);
        }
        
        .live-nodes-content::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.3);
            border-radius: 3px;
        }
        
        .live-nodes-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 65, 0.5);
        }
        
        .chevron-icon {
            transition: transform 0.3s ease;
        }
        
        .live-nodes-drawer.expanded .chevron-icon {
            transform: rotate(180deg);
        }
        
        .user-item-verified {
            border-left: 2px solid var(--accent-terminal);
        }
        
        .user-item-anonymous {
            opacity: 0.7;
        }
        
        .github-link-icon {
            width: 14px;
            height: 14px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        
        .user-item:hover .github-link-icon {
            opacity: 1;
        }

        /* LPDEF Âç°ÁâáÂä®Áîª */
        @keyframes lpdef-scan {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
            50% {
                box-shadow: 0 0 20px 5px rgba(0, 255, 65, 0.5);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
        }

        @keyframes lpdef-flash {
            0%, 100% { opacity: 1; }
            25% { opacity: 0.3; }
            50% { opacity: 0.6; }
            75% { opacity: 0.3; }
        }

        .lpdef-card.scanning {
            animation: lpdef-scan 1.5s ease-in-out;
        }

        .lpdef-card.recalculating {
            animation: lpdef-flash 0.8s ease-in-out;
        }

        .lpdef-card.recalculating::after {
            content: 'Êï∞ÊçÆÈáçÁÆó...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: var(--accent-terminal);
            padding: 8px 16px;
            border: 1px solid var(--accent-terminal);
            font-size: 10px;
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
        }

        /* LPDEF ÂÆπÂô®Êâ´ÊèèÂä®Áîª */
        @keyframes lpdef-container-scan {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
            50% {
                box-shadow: 0 0 30px 10px rgba(0, 255, 65, 0.6);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
        }

        #lpdef-container.lpdef-scan {
            animation: lpdef-container-scan 1.5s ease-in-out;
        }

        /* ÂÖâÊù°Êâ´ÊèèÊïàÊûú */
        @keyframes lpdef-light-sweep {
            0% {
                background-position: -100% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        #lpdef-container.lpdef-scan::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(0, 255, 65, 0.3) 50%,
                transparent 100%
            );
            background-size: 200% 100%;
            animation: lpdef-light-sweep 1.5s ease-in-out;
            pointer-events: none;
            z-index: 1;
        }
        /* =========================
           Right Drawer Template (right.html) - namespaced
           ========================= */
        .country-panel-template {
            color: #ffffff;
            font-family: 'JetBrains Mono', monospace;
        }

        .country-panel-template .report-container {
            width: 100%;
            max-width: 100%;
            padding: 0 2px;
            position: relative;
        }

        .country-panel-template .clinic-card {
            border: 1px solid rgba(0, 255, 65, 0.22);
            background: rgba(5, 5, 5, 0.92);
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.03);
        }

        .country-panel-template .clinic-card::before {
            content: ">>";
            position: absolute;
            top: -2px;
            left: 12px;
            background: var(--bg-color);
            padding: 0 6px;
            color: #00ff41;
            font-size: 12px;
            font-weight: 700;
        }

        .country-panel-template .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.22);
            padding-bottom: 10px;
            margin-bottom: 14px;
        }

        .country-panel-template .card-header i {
            width: 18px;
            height: 18px;
            color: #00ff41;
        }

        .country-panel-template .card-title {
            font-size: 13px;
            color: #00ff41;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 700;
        }

        .country-panel-template .metric-label {
            font-size: 11px;
            color: rgba(0, 255, 65, 0.8);
            text-transform: uppercase;
            opacity: 0.9;
        }

        .country-panel-template .metric-value {
            font-size: 18px;
            font-weight: 800;
            color: #ffffff;
            letter-spacing: -0.5px;
        }

        .country-panel-template .stat-bar-container {
            height: 6px;
            background: #111;
            margin-top: 6px;
            position: relative;
            border: 1px solid rgba(0, 255, 65, 0.18);
        }

        .country-panel-template .stat-bar-fill {
            height: 100%;
            background: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.55);
        }

        .country-panel-template .pk-track {
            height: 14px;
            background: #111;
            display: flex;
            position: relative;
            border: 1px solid rgba(0, 255, 65, 0.22);
        }

        .country-panel-template .pk-left {
            background: #ffffff;
            height: 100%;
        }

        .country-panel-template .pk-right {
            background: #00ff41;
            height: 100%;
        }

        .country-panel-template .pk-divider {
            position: absolute;
            left: 50%;
            top: -4px;
            bottom: -4px;
            width: 2px;
            background: #ffffff;
            z-index: 10;
        }

        .country-panel-template .scrolling-wrapper {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 12px;
            padding-bottom: 10px;
            scrollbar-width: none;
        }

        .country-panel-template .scrolling-wrapper::-webkit-scrollbar {
            display: none;
        }

        .country-panel-template .user-avatar-card {
            flex: 0 0 108px;
            text-align: center;
            background: rgba(13, 13, 13, 0.95);
            border: 1px solid rgba(0, 255, 65, 0.18);
            padding: 10px;
        }

        .country-panel-template .avatar-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin: 0 auto 8px;
            border: 2px solid #00ff41;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #00ff41;
            font-size: 12px;
        }

        .country-panel-template .cloud-tag {
            display: inline-block;
            margin: 4px;
            padding: 2px 8px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: all 0.2s;
        }

        .country-panel-template .cloud-tag:hover {
            border-color: #00ff41;
            color: #00ff41;
        }

        /* ËØ≠‰πâÁàÜÂèëËØç‰∫ëÔºöÊåâÁ±ªÂà´‰∏äËâ≤Ôºàslang/merit/sv_slangÔºâ */
        .country-panel-template .cloud-tag.slang {
            border-color: rgba(168, 85, 247, 0.65); /* #A855F7 */
            background: rgba(168, 85, 247, 0.12);
            color: #d8b4fe;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.16);
        }
        .country-panel-template .cloud-tag.merit {
            border-color: rgba(16, 185, 129, 0.65); /* #10B981 */
            background: rgba(16, 185, 129, 0.12);
            color: #6ee7b7;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.14);
        }
        .country-panel-template .cloud-tag.sv_slang {
            border-color: rgba(249, 115, 22, 0.65); /* #F97316 */
            background: rgba(249, 115, 22, 0.12);
            color: #fdba74;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.14);
        }
        .country-panel-template .cloud-tag.slang:hover,
        .country-panel-template .cloud-tag.merit:hover,
        .country-panel-template .cloud-tag.sv_slang:hover {
            filter: brightness(1.08);
        }

        /* ËØ≠‰πâÁàÜÂèëËØç‰∫ëÔºöÊó†È¢ùÂ§ñÂàáÊç¢Êéß‰ª∂ */

        .country-panel-template .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px 0;
        }

        .country-panel-template .status-tag {
            font-size: 10px;
            padding: 3px 8px;
            border: 1px solid #00ff41;
            color: #00ff41;
            font-weight: 800;
        }

        .country-panel-template .status-tag.invert {
            background: #00ff41;
            color: #050505;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- È°∂ÈÉ®Âõ∫ÂÆö Header -->
    <div class="top-header">
        <div class="top-header-left">
            <div class="top-header-title">
                <h1>
                    <span class="text-white">GLOBAL</span>
                    <span class="text-[var(--accent-terminal)]">DATA_STATION</span>
                </h1>
                <p id="sub-title">Telemetry Uplink: Active // Source: Central_Pacific</p>
            </div>
        </div>
        
        <div class="top-header-right">
            <!-- Ê¥ªË∑ÉËäÇÁÇπÂç°Áâá -->
            <div class="top-header-card">
                <div class="top-header-card-label lang-key" data-key="active-nodes">Ê¥ªË∑ÉËäÇÁÇπ</div>
                <div class="top-header-card-value text-emerald-400">
                    <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full pulse"></span>
                    <span id="online-count-value">0</span> CONNECTED
                </div>
            </div>
            
            <!-- È£éÈô©ËØÑÁ∫ßÂç°Áâá -->
            <div class="top-header-card">
                <div class="top-header-card-label lang-key" data-key="threat-level">È£éÈô©ËØÑÁ∫ß</div>
                <div class="top-header-card-value text-red-500">LEVEL_CRITICAL</div>
            </div>
            
            <!-- ËØ≠Ë®ÄÂàáÊç¢ÊåâÈíÆ -->
            <div class="flex gap-2 items-center">
                <button onclick="switchLang('zh')" id="btn-zh" class="lang-flag-btn active" title="‰∏≠Êñá">
                    <img src="images/zh.png" alt="‰∏≠Êñá" />
                </button>
                <button onclick="switchLang('en')" id="btn-en" class="lang-flag-btn" title="English">
                    <img src="images/us.png" alt="English" />
                </button>
            </div>
        </div>
    </div>
    
    <!-- ÂÖ®Â±èÂú∞ÂõæËÉåÊôØ -->
    <div id="map-container"></div>
    
    <!-- Â∑¶Âè≥ËµõÂçöÊúãÂÖãÊäΩÂ±â -->
    <div id="left-drawer" class="cyber-drawer left-drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <div class="drawer-title">
                    <span class="drawer-icon">‚ö°</span>
                    <span class="drawer-title-text" id="left-drawer-title">ÂõΩÂÆ∂Êï∞ÊçÆ</span>
                </div>
                <div class="drawer-close-btn" onclick="closeDrawers()">‚úï</div>
            </div>
            <div class="drawer-body" id="left-drawer-body">
                <!-- ÂÜÖÂÆπÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÂ°´ÂÖÖ -->
            </div>
        </div>
    </div>
    
    <div id="right-drawer" class="cyber-drawer right-drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <div class="drawer-title">
                    <span class="drawer-icon">üîç</span>
                    <span class="drawer-title-text" id="right-drawer-title">ËØ¶ÁªÜ‰ø°ÊÅØ</span>
                </div>
                <div class="drawer-close-btn" onclick="closeDrawers()">‚úï</div>
            </div>
            <div class="drawer-body" id="right-drawer-body">
                <div id="globalFlowPanel">
                    <!-- ÂÆûÊó∂Âä®ÊÄÅÊµÅÔºöÂÜÖÂÆπÂ∞ÜÈÄöËøá JavaScript Âä®ÊÄÅÂ°´ÂÖÖ -->
                </div>
                <div id="countryPanel" style="display: none;">
                    <div class="flex items-center gap-2 mb-3">
                        <button type="button" id="backToGlobalBtn" onclick="switchBackToGlobalView()" class="px-3 py-1.5 text-xs border border-[#00ff41]/50 text-[#00ff41] hover:bg-[#00ff41]/10 transition-colors">[Back to Global]</button>
                        <button type="button" id="refreshDiagnosticsBtn" onclick="refreshCountryRightPanel()" class="px-3 py-1.5 text-xs border border-sky-300/50 text-sky-300 hover:bg-sky-300/10 transition-colors">[REFRESH]</button>
                    </div>
                    <div id="countryTemplateMount" style="font-family: 'JetBrains Mono', monospace;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="scanLine" class="scan-line" aria-hidden="true"></div>
    <!-- right.html Ê®°ÊùøÔºöÁî®‰∫éÂõΩÂÆ∂ÈÄèËßÜÂè≥‰æßÊäΩÂ±âÔºàÁæéÂõΩÔºâ -->
    <template id="rightDrawerTemplate">
        <div class="country-panel-template">
            <div class="report-container">
                <!-- HEADER -->
                <div class="mb-8 border-b-2 border-white pb-4">
                    <div class="flex justify-between items-start">
                        <h1 class="text-2xl font-black italic tracking-tighter">NAT_CLINIC <span class="text-green-500">v2.6</span></h1>
                        <div class="status-tag invert" id="rtStatusTag">LIVE_FEED</div>
                    </div>
                    <div class="mt-3">
                        <span id="rtMeritBoard" class="inline-block text-[11px] text-indigo-200 border border-indigo-400/40 bg-indigo-500/5 px-2 py-1">
                            Â∑≤Á¥ØËÆ°ÂàÜÊûê -- ‰∏áÂ≠ó
                        </span>
                    </div>
                    <div class="text-[11px] mt-3 text-zinc-500 flex justify-between uppercase">
                        <span id="rtCoord">COORD: --</span>
                        <span id="rtDataStatus">DATA: STABLE</span>
                    </div>
                </div>

                <!-- [01] MACRO SCALE -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="globe"></i>
                        <span class="card-title">ÂÆèËßÇ‰ΩìÈáè / Macro Scale</span>
                    </div>
                    <div class="flex justify-between items-center mb-8">
                        <div class="text-5xl" id="rtFlag">üè≥Ô∏è</div>
                        <div class="text-right">
                            <div class="metric-value" id="rtNodeName">REGION_NODE</div>
                            <div class="metric-label">ÂõΩÂÆ∂ËØÜÂà´Á†Å</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div id="rtUsersCard">
                            <div class="metric-label">ÂºÄÂèëËÄÖËßÑÊ®°</div>
                            <div class="metric-value" id="rtDiagnosedTotal">--</div>
                        </div>
                        <div id="rtAnalysisCard">
                            <div class="metric-label">ËØäÊñ≠Ê¨°Êï∞</div>
                            <div class="metric-value" id="rtScanTotal">--</div>
                        </div>
                    </div>
                </div>

                <!-- [01.5] RADAR -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="target"></i>
                        <span class="card-title">ÂºÄÂèëËÄÖÁîªÂÉè / Radar</span>
                    </div>
                    <div id="rtRadar" style="height: 260px; width: 100%;"></div>
                </div>

                <!-- [01.6] LIVE FEED -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="radio"></i>
                        <span class="card-title">ÂÆûÊó∂Âä®ÊÄÅ / Live Feed</span>
                    </div>
                    <div id="rtRealtimeList" class="space-y-3 text-[11px] leading-snug"></div>
                </div>

                <!-- [02] POWER STRUGGLE (PK) -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="swords"></i>
                        <span class="card-title">ÊùÉÂäõÂçöÂºà / Power Struggle</span>
                    </div>
                    <div class="space-y-5">
                        <div class="flex justify-between text-[11px] font-bold uppercase">
                            <span class="text-white" id="rtPkLeftLabel">Áî≤Êñπ Dominance</span>
                            <span class="text-green-500" id="rtPkRightLabel">Á£ïÂ§¥ Kowtow</span>
                        </div>
                        <div class="pk-track">
                            <div class="pk-divider"></div>
                            <div class="pk-left" id="rtPkLeftFill" style="width: 50%;"></div>
                            <div class="pk-right" id="rtPkRightFill" style="width: 50%;"></div>
                        </div>
                        <div class="flex justify-between text-[16px] font-bold">
                            <span id="rtPkLeftPct">50.0%</span>
                            <span class="text-green-500" id="rtPkRightPct">50.0%</span>
                        </div>
                        <div>
                            <div class="flex justify-between items-center text-[11px]">
                                <span class="text-zinc-500 uppercase tracking-widest">POWER</span>
                                <span class="text-white font-bold" id="rtPowerScore">--</span>
                            </div>
                            <div class="mt-2 h-1 bg-zinc-800 w-full overflow-hidden">
                                <div id="power-bar" class="h-full bg-white" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="p-3 bg-zinc-900 border-l-2 border-white text-xs leading-relaxed italic text-zinc-300" id="rtPkQuote">
                            "..."
                        </div>
                    </div>
                </div>

                <!-- [03] EMOTIONAL AUDIT -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="activity"></i>
                        <span class="card-title">Á†¥Èò≤ÁõëÊµã / Meltdown Audit</span>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <div class="flex justify-between items-end">
                                <div class="metric-label">Á†¥Èò≤ÊåáÊï∞</div>
                                <div class="text-sm font-bold" id="rtBreakdownRate">--</div>
                            </div>
                            <div class="stat-bar-container">
                                <div class="stat-bar-fill" id="breakdown-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-6">
                            <div class="bg-zinc-900 p-3 border border-zinc-800">
                                <div class="metric-label">Á†¥Èò≤Á≠âÁ∫ß</div>
                                <div class="text-white font-bold text-lg" id="rtMeltdownLevel">--</div>
                            </div>
                            <div class="bg-zinc-900 p-3 border border-zinc-800">
                                <div class="metric-label">ÂèóËôê‰∫∫Êï∞</div>
                                <div class="text-green-500 font-bold text-lg" id="rtMeltdownVictims">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- [04] SEMANTIC BURST -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="cloud"></i>
                        <span class="card-title">ËØ≠‰πâÁàÜÂèë / Semantic Burst</span>
                    </div>
                    <div class="p-2" id="rtSemanticTags">
                        <div id="wordcloud-container" style="height: 400px; width: 100%;" class="mb-4"></div>
                        <div class="text-xs text-zinc-300 mb-3" id="rtCoreTrait">ËØ•Âú∞Âå∫Ê†∏ÂøÉÁâπË¥®Ôºö--</div>
                        <div class="flex justify-between items-center text-[11px]">
                            <span class="text-zinc-500 uppercase tracking-widest">SEMANTIC</span>
                            <span class="text-green-500 font-bold" id="rtSemanticScore">--</span>
                        </div>
                        <div class="mt-2 h-1 bg-zinc-800 w-full overflow-hidden">
                            <div id="semantic-bar" class="h-full bg-[#00ff41]" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-zinc-800 flex justify-between text-[11px]">
                        <span class="text-zinc-500" id="rtSemanticMostUsed">MOST_USED: --</span>
                        <span class="text-green-500" id="rtSemanticFreq">FREQ: --</span>
                    </div>
                </div>

                <!-- [05] ELITE RANKING -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="users"></i>
                        <span class="card-title">È´òÂàÜÂõæË∞± / LPDEF Ranking</span>
                    </div>
                    <div class="scrolling-wrapper" id="rtEliteList">
                        <div id="rtTopTalentsList" class="space-y-2"></div>
                    </div>
                    <div class="text-[10px] text-zinc-500 mt-2 text-center uppercase tracking-tighter" id="rtEliteHint">
                        &lt;--- Swipe to view Top Agents ---&gt;
                    </div>
                </div>

                <!-- [06] GLOBAL SHARE -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="pie-chart"></i>
                        <span class="card-title">ÂÖ®ÁêÉÂç†ÊØî / Global Ratio</span>
                    </div>
                    <div class="chart-container">
                        <svg width="150" height="150" viewBox="0 0 32 32">
                            <circle r="16" cx="16" cy="16" fill="#111" />
                            <circle r="16" cx="16" cy="16" fill="transparent"
                                    stroke="#00ff41" stroke-width="32"
                                    stroke-dasharray="45 100" transform="rotate(-90 16 16)" />
                            <circle r="16" cx="16" cy="16" fill="transparent"
                                    stroke="#ffffff" stroke-width="32"
                                    stroke-dasharray="25 100" transform="rotate(72 16 16)" />
                            <circle r="16" cx="16" cy="16" fill="transparent"
                                    stroke="#008f11" stroke-width="32"
                                    stroke-dasharray="15 100" transform="rotate(162 16 16)" />
                            <circle r="8" cx="16" cy="16" fill="#050505" />
                        </svg>
                    </div>
                    <div class="mt-3">
                        <div class="flex justify-between items-center text-[11px]">
                            <span class="text-zinc-500 uppercase tracking-widest">RATIO</span>
                            <span class="text-green-500 font-bold" id="rtRatioPct">--</span>
                        </div>
                        <div class="mt-2 h-1 bg-zinc-800 w-full overflow-hidden">
                            <div id="ratio-bar" class="h-full bg-white" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="mt-2 text-[11px] text-zinc-400">
                        <span class="text-zinc-500">GLOBAL_RATIO:</span>
                        <span id="rtGlobalRatio" class="text-green-500 font-bold">--</span>
                    </div>
                    <div class="space-y-2 mt-2" id="rtRatioList"></div>
                </div>
            </div>
        </div>
    </template>
    <div class="max-w-[1600px] mx-auto relative z-10">
        <!-- Main Dashboard Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
            
            <!-- Side Panel: Core Metrics (Â∑¶‰æß) - Â∑≤ÁßªËá≥ÊäΩÂ±âÔºåÈöêËóè -->
            <div class="xl:col-span-3 flex flex-col gap-4 order-2 xl:order-1 items-start" style="display: none;">
                <!-- ÁªüËÆ°Âç°ÁâáÂ∑≤ÁßªËá≥Âè≥ËæπÊäΩÂ±âÔºåÈöêËóèÂéüÂÆπÂô® -->
                <div class="hacker-border p-6 rounded-sm stat-card" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-victims">Â∑≤ËØäÊñ≠ÂºÄÂèëËÄÖ</div>
                    <div id="totalUsers" class="text-4xl font-bold text-[var(--accent-terminal)]">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">USERS_RECOGNIZED_SUCCESSFULLY</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-analysis">ÂÖ®ÁΩëÊâ´ÊèèÊ¨°Êï∞</div>
                    <div id="totalAnalysis" class="text-4xl font-bold">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">TOTAL_SCAN_COUNT</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-roast">Á¥ØËÆ°ÂêêÊßΩÂ≠óÊï∞</div>
                    <div id="totalChars" class="text-4xl font-bold">0</div>
                    <div class="mt-4 h-1 bg-zinc-800 w-full overflow-hidden">
                        <div class="bg-[var(--accent-terminal)] h-full w-[65%]"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 stat-card" style="display: none;">
                    <div class="hacker-border p-4 rounded-sm bg-zinc-900/50">
                        <div class="text-zinc-500 text-[10px] uppercase tracking-tighter mb-1">Avg Words / ‰∫∫ÂùáÂπ≥ÂùáÁØáÂπÖ</div>
                        <div id="avgPerUser" class="text-2xl font-bold font-mono text-[var(--accent-terminal)]">0</div>
                        <div class="text-[9px] text-zinc-600 mt-1 uppercase">Per Developer Basis</div>
                    </div>
                    
                    <div class="hacker-border p-4 rounded-sm bg-zinc-900/50">
                        <div class="text-zinc-500 text-[10px] uppercase tracking-tighter mb-1">Scan Words / ÂçïÊ¨°Âπ≥ÂùáÁØáÂπÖ</div>
                        <div id="avgPerScan" class="text-2xl font-bold font-mono text-blue-400">0</div>
                        <div class="text-[9px] text-zinc-600 mt-1 uppercase">Per Analysis Basis</div>
                    </div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card bg-zinc-900/40" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-4 uppercase tracking-widest lang-key" data-key="radar-title">ÂÖ®ÁΩëÂπ≥ÂùáÂºÄÂèëËÄÖÁîªÂÉè</div>
                    <div class="aspect-square">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Central Map Area (‰∏≠Èó¥) - Âú∞ÂõæÂ∑≤ÁßªËá≥ÂÖ®Â±èËÉåÊôØÔºåÊ≠§Âå∫ÂüüÂ∑≤ÁßªÈô§ -->
            <!-- Áª¥Â∫¶ÊéíÂêçÂç°ÁâáÂÆπÂô®ÔºöÂ∑≤ÁßªËá≥ÊäΩÂ±âÊòæÁ§∫ -->
            <div id="rank-cards-container" style="display: none;">
                <!-- Âç°ÁâáÂ∑≤ÁßªËá≥ÊäΩÂ±âÊòæÁ§∫ -->
            </div>
        </div>

        <!-- Secondary Charts & Logs (Âè≥‰æß) - Â∑≤ÁßªËá≥ÊäΩÂ±âÔºåÈöêËóèÂéüÂÆπÂô® -->
        <div class="xl:col-span-3 grid grid-cols-1 gap-6 mt-6 items-start" style="display: none;">
            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="hot-list">Âú∞ÁêÜ‰ΩçÁΩÆÁÉ≠ÂäõÊéíË°å</h3>
                <div id="locationList" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="personality-dist">‰∫∫Ê†ºÂàÜÂ∏ÉÊéíË°å</h3>
                <div id="personalityDistribution" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm flex flex-col">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="recent-activity">ÂÆûÊó∂ËØäÊñ≠Ê¥ªÂä®</h3>
                <div id="recentActivity" class="flex-1 overflow-y-auto max-h-[300px] text-[10px] font-mono space-y-4 pr-2">
                    <!-- Logs here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÊÇ¨ÊµÆÊäΩÂ±âÂºèÂú®Á∫øÁî®Êà∑ÂàóË°® -->
    <div id="live-nodes-drawer" class="live-nodes-drawer expanded">
        <div class="live-nodes-header" onclick="toggleDrawer()">
            <div class="flex items-center gap-3">
                <span class="text-[10px] text-zinc-500 uppercase tracking-widest lang-key" data-key="active-nodes">Live Nodes</span>
                <span id="online-count-badge" class="w-2 h-2 bg-[var(--accent-terminal)] rounded-full pulse"></span>
                <span id="online-count-text" class="text-xs font-bold text-[var(--accent-terminal)]">0</span>
            </div>
            <svg class="chevron-icon w-4 h-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
        <div class="live-nodes-content">
            <div id="online-users-list" class="p-4 space-y-2">
                <div class="text-zinc-500 text-center py-4 text-[10px]">Scanning for nearby nodes...</div>
            </div>
        </div>
    </div>

    <script>
        let calibrationDebounceTimer = null; // ËÑöÊú¨ÊúÄÈ°∂ÈÉ®Â£∞ÊòéÔºåÂΩªÂ∫ïÊã¶Êà™ÂÆö‰ΩçÊºÇÁßªÔºåÈÅøÂÖç ReferenceError

        // ==========================================
        // ==========================================
        // „Äêv4.0 Á§∫‰æã„ÄëVibeCodingerAnalyzer ÂÖ®ÁêÉÂêÑÂõΩÊï∞ÊçÆÂàáÊç¢Á§∫‰æã
        // ==========================================
        /**
         * Á§∫‰æãÔºöÂ¶Ç‰Ωï‰ΩøÁî®ÈáçÊûÑÂêéÁöÑ VibeCodingerAnalyzer Â§ÑÁêÜÂÖ®ÁêÉ260ÂõΩÊï∞ÊçÆ
         * 
         * Ê†∏ÂøÉÂäüËÉΩÔºö
         * 1. ÂÖÉÊï∞ÊçÆÈ©±Âä®ÔºöÂä®ÊÄÅÁª¥Â∫¶ËØÜÂà´ÔºåÊîØÊåÅ40+Áª¥Â∫¶
         * 2. ÂÆπÂ∑ÆÂØπÊØîÔºöÂΩ±Â≠êË∞ÉÁî®‰ΩøÁî®¬±5%ÂÆπÂ∑Æ
         * 3. ÂõΩÂÆ∂‰∏ä‰∏ãÊñáÔºöËá™Âä®ËÆ°ÁÆó‰∏™‰∫∫ÂæóÂàÜ‰∏éÂõΩÂÆ∂Âπ≥ÂùáÂàÜÁöÑÂÅèÁ¶ªÂ∫¶
         * 4. ÊÄßËÉΩ‰ºòÂåñÔºöÂπ∂ÂèëÈîÅ„ÄÅ5ÁßíË∂ÖÊó∂‰øùÊä§
         * 5. V6 StatsÂØπÊé•ÔºöÂÆåÊï¥Ëß£Êûêtech_stack„ÄÅketao_countÁ≠â
         */
        
        // Á§∫‰æãÔºöÂàùÂßãÂåñÂàÜÊûêÂô®Âπ∂ÂàáÊç¢ÂõΩÂÆ∂‰∏ä‰∏ãÊñá
        async function exampleGlobalCountrySwitching() {
            // 1. ÂØºÂÖ•ÂàÜÊûêÂô®ÔºàÂÅáËÆæÂ∑≤ÈÄöËøáESÊ®°ÂùóÂØºÂÖ•Ôºâ
            // import { VibeCodingerAnalyzer } from './src/VibeCodingerAnalyzer.js';
            
            // 2. ÂàõÂª∫ÂàÜÊûêÂô®ÂÆû‰æãÔºàÊîØÊåÅÂä®ÊÄÅÁª¥Â∫¶ÈÖçÁΩÆÔºâ
            const analyzer = new VibeCodingerAnalyzer('zh-CN', {
                // ÂèØÈÄâÔºöÂ¶ÇÊûúÂ∑≤Áü•Áª¥Â∫¶ÈÖçÁΩÆÔºåÂèØ‰ª•È¢ÑÂÖà‰º†ÂÖ•
                // keys: ['L', 'P', 'D', 'E', 'F', 'G', 'H', ...], // 40+Áª¥Â∫¶
                // metadata: { ... }
            });
            
            // 3. Ê®°ÊãüËÅäÂ§©Êï∞ÊçÆ
            const chatData = [
                { role: 'USER', text: 'Â∏ÆÊàëÂÜô‰∏Ä‰∏™ReactÁªÑ‰ª∂Ôºå‰ΩøÁî®TypeScriptÂíåTailwind CSS' },
                { role: 'ASSISTANT', text: 'Â•ΩÁöÑÔºåÊàëÊù•Â∏Æ‰Ω†...' },
                { role: 'USER', text: 'Ë∞¢Ë∞¢ÔºåËøô‰∏™ÂÆûÁé∞ÂæàÊ£íÔºÅ' }
            ];
            
            // 4. ÂÖ®ÁêÉ260ÂõΩÊï∞ÊçÆÂàáÊç¢Á§∫‰æã
            const countries = [
                { code: 'US', name: 'United States' },
                { code: 'CN', name: 'China' },
                { code: 'JP', name: 'Japan' },
                { code: 'GB', name: 'United Kingdom' },
                { code: 'DE', name: 'Germany' },
                // ... Êõ¥Â§öÂõΩÂÆ∂
            ];
            
            // ÈÅçÂéÜÂêÑÂõΩËøõË°åÂàÜÊûê
            for (const country of countries) {
                try {
                    console.log(`[Example] ÂàÜÊûê ${country.name} (${country.code}) ÁöÑÊï∞ÊçÆ...`);
                    
                    // 4.1 ËÆæÁΩÆÂõΩÂÆ∂‰∏ä‰∏ãÊñáÔºà‰ªéÂêéÁ´ØAPIËé∑ÂèñÂõΩÂÆ∂Âπ≥ÂùáÂÄºÔºâ
                    const countryAverage = await fetchCountryAverage(country.code);
                    analyzer.setCountryContext(country.code, countryAverage, {
                        countryName: country.name,
                        region: getRegionByCountryCode(country.code)
                    });
                    
                    // 4.2 ÊâßË°åÂàÜÊûêÔºàËá™Âä®ËÆ°ÁÆóÂÅèÁ¶ªÂ∫¶Ôºâ
                    const result = await analyzer.analyze(chatData, 'zh-CN');
                    
                    // 4.3 Â§ÑÁêÜÂàÜÊûêÁªìÊûú
                    console.log(`[Example] ${country.name} ÂàÜÊûêÁªìÊûú:`, {
                        dimensions: result.dimensions,
                        personalityType: result.personalityType,
                        deviationFromCountry: result.deviationFromCountry, // „Äêv4.0Êñ∞Â¢û„ÄëÂÅèÁ¶ªÂ∫¶
                        countryAverage: result.countryAverage, // „Äêv4.0Êñ∞Â¢û„ÄëÂõΩÂÆ∂Âπ≥ÂùáÂàÜ
                        stats: result.statistics, // „Äêv4.0 V6 Stats„ÄëÂåÖÂê´tech_stack„ÄÅketao_countÁ≠â
                        hasRageWord: result.metadata?.hasRageWord // „Äêv4.0Êñ∞Â¢û„ÄëÂíÜÂìÆËØçÊ£ÄÊµã
                    });
                    
                    // 4.4 ‰∏ä‰º†ÊéíÂêçÂπ∂Ëé∑ÂèñÂÖ®ÁêÉÊéíÂêç
                    const rankData = await analyzer.uploadToSupabase(result, chatData, (progress) => {
                        console.log(`[Example] ${country.name} ‰∏ä‰º†ËøõÂ∫¶:`, progress);
                    });
                    
                    console.log(`[Example] ${country.name} ÊéíÂêçÊï∞ÊçÆ:`, {
                        rankPercent: rankData.rankPercent,
                        totalUsers: rankData.totalUsers,
                        countryRank: rankData.countryRank // Â¶ÇÊûúÂêéÁ´ØËøîÂõû
                    });
                    
                    // 4.5 Êõ¥Êñ∞UIÔºàÁ§∫‰æãÔºâ
                    updateCountryDashboard(country.code, {
                        result,
                        rankData,
                        deviation: result.deviationFromCountry
                    });
                    
                } catch (error) {
                    console.error(`[Example] ${country.name} ÂàÜÊûêÂ§±Ë¥•:`, error);
                    // „Äêv4.0 Ë∂ÖÊó∂‰øùÊä§„ÄëÂ¶ÇÊûúË∂ÖÊó∂Ôºå‰ºöËá™Âä®ÈôçÁ∫ßÂà∞Êú¨Âú∞ÁÆÄÂçïÂåπÈÖç
                    if (error.message.includes('timeout')) {
                        console.warn(`[Example] ${country.name} ÂàÜÊûêË∂ÖÊó∂Ôºå‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à`);
                    }
                }
                
                // ÈÅøÂÖçËøáÂø´ÂàáÊç¢ÂØºËá¥Âπ∂ÂèëÂÜ≤Á™ÅÔºà„Äêv4.0 Âπ∂ÂèëÈîÅ„Äë‰ºöËá™Âä®Â§ÑÁêÜÔºâ
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        // ËæÖÂä©ÂáΩÊï∞Ôºö‰ªéÂêéÁ´ØËé∑ÂèñÂõΩÂÆ∂Âπ≥ÂùáÂÄº
        async function fetchCountryAverage(countryCode) {
            try {
                const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || 
                                   'https://cursor-clinical-analysis.psterman.workers.dev/';
                const url = `${apiEndpoint}api/v2/country-average?countryCode=${countryCode}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.average || null; // Ê†ºÂºèÔºö{L: 65, P: 70, D: 60, E: 8, F: 55}
            } catch (error) {
                console.warn(`[Example] Ëé∑Âèñ ${countryCode} ÂõΩÂÆ∂Âπ≥ÂùáÂÄºÂ§±Ë¥•:`, error);
                return null;
            }
        }
        
        // ËæÖÂä©ÂáΩÊï∞ÔºöÊ†πÊçÆÂõΩÂÆ∂‰ª£Á†ÅËé∑ÂèñÂú∞Âå∫
        function getRegionByCountryCode(code) {
            const regionMap = {
                'US': 'North America',
                'CN': 'Asia',
                'JP': 'Asia',
                'GB': 'Europe',
                'DE': 'Europe',
                // ... Êõ¥Â§öÊò†Â∞Ñ
            };
            return regionMap[code] || 'Unknown';
        }
        
        // ËæÖÂä©ÂáΩÊï∞ÔºöÊõ¥Êñ∞ÂõΩÂÆ∂‰ª™Ë°®ÊùøUI
        async function updateCountryDashboard(countryNameOrCode, maybeData) {
            // ÂÖºÂÆπÊóßÁ§∫‰æãË∞ÉÁî®ÔºöupdateCountryDashboard(countryCode, { result, ... })
            if (maybeData && typeof maybeData === 'object' && maybeData.result) {
                const countryCode = countryNameOrCode;
                const data = maybeData;
                const dashboard = document.getElementById(`country-dashboard-${countryCode}`);
                if (dashboard) {
                    dashboard.innerHTML = `
                        <div class="country-stats">
                            <h3>${countryCode} ÂàÜÊûêÁªìÊûú</h3>
                            <div class="dimensions">
                                ${Object.entries(data.result.dimensions).map(([key, value]) =>
                                    `<div class="dimension">
                                        <span>${key}:</span>
                                        <span>${value}</span>
                                        ${data.deviation ? `<span class="deviation">${data.deviation.deviations[key]?.deviationPercent || ''}</span>` : ''}
                                    </div>`
                                ).join('')}
                            </div>
                            <div class="deviation-summary">
                                ${data.deviation ? `
                                    <p>Êï¥‰ΩìÂÅèÁ¶ªÂ∫¶: ${data.deviation.overallDeviation}%</p>
                                    <p>${data.deviation.interpretation}</p>
                                ` : ''}
                            </div>
                            <div class="stats">
                                <p>ÊäÄÊúØÊ†à: ${JSON.stringify(data.result.statistics?.tech_stack || {})}</p>
                                <p>ÂÆ¢Â•óËØçÊï∞: ${data.result.statistics?.ketao_count || 0}</p>
                                <p>Âä†ÊñπËØçÊï∞: ${data.result.statistics?.jiafang_count || 0}</p>
                                <p>Â∑•‰ΩúÂ§©Êï∞: ${data.result.statistics?.work_days || 0}</p>
                            </div>
                            ${data.result.metadata?.hasRageWord ? '<div class="rage-warning">‚ö†Ô∏è Ê£ÄÊµãÂà∞ÂíÜÂìÆËØç</div>' : ''}
                        </div>
                    `;
                }
                return;
            }

            // Êñ∞ÈÄªËæëÔºöÁî®‰∫éÂè≥‰æßÊäΩÂ±âÂõΩÂÆ∂ÈÄèËßÜÔºàÊîØÊåÅ‰ªªÊÑèÂõΩÂÆ∂‰ª£Á†ÅÔºâ
            const rawCountry = String(countryNameOrCode || '').trim();
            const isGlobal =
                !rawCountry ||
                rawCountry.toUpperCase() === 'GLOBAL' ||
                rawCountry === 'ÂÖ®ÁΩë' ||
                rawCountry === '‰∏ñÁïå' ||
                rawCountry.toUpperCase() === 'WORLD';

            let countryCode = '';
            if (!isGlobal) {
                if (rawCountry.length === 2) {
                    countryCode = rawCountry.toUpperCase();
                } else if (rawCountry === 'United States' || rawCountry === 'ÁæéÂõΩ') {
                    countryCode = 'US';
                } else if (rawCountry.toUpperCase() === 'US') {
                    countryCode = 'US';
                } else {
                    // Êó†Ê≥ï‰ªéÂêçÁß∞ÂèØÈù†Êé®Êñ≠ÂõΩÂÆ∂‰ª£Á†ÅÊó∂ÔºåÈÄÄÂõû GlobalÔºàÈÅøÂÖçÈîôËØØÂÜôÂÖ•/Êü•ËØ¢Ôºâ
                    countryCode = 'Global';
                }
            }
            const isUS = countryCode === 'US';

            const base = (document.querySelector('meta[name="api-endpoint"]')?.content || '').trim();
            const API_ENDPOINT = base.endsWith('/') ? base : `${base}/`;
            const url = isGlobal
                ? `${API_ENDPOINT}api/global-average`
                : `${API_ENDPOINT}api/global-average?country_code=${encodeURIComponent(countryCode)}`;

            // DOM ÁªëÂÆöÁÇπ
            const usersValEl = document.getElementById('rtDiagnosedTotal');
            const analysisValEl = document.getElementById('rtScanTotal');
            const usersCardEl = document.getElementById('rtUsersCard');
            const analysisCardEl = document.getElementById('rtAnalysisCard');
            const statusEl = document.getElementById('rtDataStatus');
            const radarDom = document.getElementById('rtRadar');
            const realtimeDom = document.getElementById('rtRealtimeList');

            const flash = (el) => {
                if (!el) return;
                el.classList.remove('breathe-flash');
                // Âº∫Âà∂ÈáçÊéí‰ª•ÈáçÂêØÂä®Áîª
                void el.offsetWidth; // eslint-disable-line no-unused-expressions
                el.classList.add('breathe-flash');
                window.setTimeout(() => el.classList.remove('breathe-flash'), 950);
            };

            const stopFlash = (el) => {
                if (!el) return;
                el.classList.remove('breathe-flash');
            };

            const escapeHtml = (s) =>
                String(s ?? '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');

            const setValueOrNA = (el, rawValue) => {
                if (!el) return;
                const n = Number(rawValue);
                // UI ÈôçÁ∫ßÔºö0 / null / undefined / NaN ÈÉΩËßÜ‰∏∫Áº∫Â§±Ôºå‰∏çÈó™ÁÉÅ
                if (rawValue === null || rawValue === undefined || !Number.isFinite(n) || n === 0) {
                    el.textContent = 'N/A';
                    stopFlash(el);
                    return;
                }
                el.textContent = new Intl.NumberFormat('zh-CN').format(n);
            };

            // Èõ∑ËææÂõæÔºàEChartsÔºâ
            if (!window.__countryRadarChart) window.__countryRadarChart = null;
            const disposeRadar = () => {
                try {
                    if (window.__countryRadarChart && typeof window.__countryRadarChart.dispose === 'function') {
                        window.__countryRadarChart.dispose();
                    }
                } catch (e) {
                    // ignore
                } finally {
                    window.__countryRadarChart = null;
                }
            };

            const renderRadarMessage = (msg) => {
                if (!radarDom) return;
                disposeRadar();
                radarDom.innerHTML = `
                    <div class="flex items-center justify-center h-full w-full text-center text-zinc-500 text-sm border border-white/10 bg-zinc-950/30">
                        ${escapeHtml(msg)}
                    </div>
                `;
            };

            const renderRadar = (values) => {
                const dom = document.getElementById('rtRadar');
                if (!dom || typeof echarts === 'undefined') return;
                try {
                    if (window.__countryRadarChart && typeof window.__countryRadarChart.dispose === 'function') {
                        window.__countryRadarChart.dispose();
                    }
                } catch (e) {
                    // ignore
                }
                dom.innerHTML = '';
                window.__countryRadarChart = echarts.init(dom, null, { renderer: 'canvas' });
                const option = {
                    backgroundColor: 'transparent',
                    radar: {
                        indicator: [
                            { name: 'L', max: 100 },
                            { name: 'P', max: 100 },
                            { name: 'D', max: 100 },
                            { name: 'E', max: 100 },
                            { name: 'F', max: 100 },
                        ],
                        axisName: { color: '#e5e7eb', fontFamily: 'JetBrains Mono', fontSize: 11 },
                        splitLine: { lineStyle: { color: 'rgba(0,255,65,0.18)' } },
                        splitArea: { areaStyle: { color: ['rgba(0,255,65,0.02)', 'rgba(0,255,65,0.01)'] } },
                        axisLine: { lineStyle: { color: 'rgba(0,255,65,0.22)' } },
                    },
                    series: [
                        {
                            type: 'radar',
                            data: [
                                {
                                    value: values,
                                    name: 'US_AVG',
                                    areaStyle: { color: 'rgba(0,255,65,0.15)' },
                                    backgroundStyle: { color: 'transparent' },
                                    lineStyle: { color: '#00ff41', width: 2 },
                                    itemStyle: { color: '#00ff41' },
                                },
                            ],
                        },
                    ],
                    tooltip: { show: true },
                };
                window.__countryRadarChart.setOption(option, true);
                try {
                    window.__countryRadarChart.resize();
                } catch (e) {
                    // ignore
                }
            };

            // ÂÆûÊó∂Âä®ÊÄÅ
            const renderRealtime = (records) => {
                const box = document.getElementById('rtRealtimeList');
                if (!box) return;
                if (!Array.isArray(records) || records.length === 0) {
                    box.innerHTML = '<div class="text-zinc-500 text-xs">ÊöÇÊó†ÂÆûÊó∂Âä®ÊÄÅ</div>';
                    return;
                }
                box.innerHTML = records
                    .map((r) => {
                        const user = r.user_name ?? r.userName ?? r.username ?? 'Anonymous';
                        const type =
                            r.personality_type ??
                            r.p_type ??
                            r.type ??
                            (r.personality && (r.personality.type || r.personality['type'])) ??
                            'UNKNOWN';
                        const loc = r.ip_location ?? r.location ?? r.ipLocation ?? 'Êú™Áü•';
                        return `
                            <div class="border border-white/10 bg-zinc-950/40 p-3">
                                <div class="flex justify-between gap-3">
                                    <div class="text-white font-bold truncate">${escapeHtml(String(type).toUpperCase())}</div>
                                    <div class="text-[10px] text-zinc-500 truncate">${escapeHtml(loc)}</div>
                                </div>
                                <div class="text-[10px] text-green-400/90 mt-1 truncate">@${escapeHtml(user)}</div>
                            </div>
                        `;
                    })
                    .join('');
            };

            const renderErrorState = (message) => {
                if (statusEl) statusEl.textContent = 'DATA: ERROR';
                if (usersValEl) usersValEl.textContent = 'N/A';
                if (analysisValEl) analysisValEl.textContent = 'N/A';
                stopFlash(usersCardEl || usersValEl);
                stopFlash(analysisCardEl || analysisValEl);

                renderRadarMessage(message);
                const topTalentsEl = document.getElementById('rtTopTalentsList');
                if (topTalentsEl) topTalentsEl.innerHTML = '';
                const globalRatioEl = document.getElementById('rtGlobalRatio');
                if (globalRatioEl) globalRatioEl.textContent = 'N/A';
                const meritEl = document.getElementById('rtMeritBoard');
                if (meritEl) meritEl.textContent = 'Â∑≤Á¥ØËÆ°ÂàÜÊûê -- ‰∏áÂ≠ó';
                if (realtimeDom) {
                    const retryArg = escapeHtml(JSON.stringify(countryName));
                    realtimeDom.innerHTML = `
                        <div class="border border-red-500/30 bg-red-950/20 p-4">
                            <div class="text-red-300 text-sm font-bold mb-2">Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•</div>
                            <div class="text-zinc-400 text-xs mb-3">${escapeHtml(message || '')}</div>
                            <button
                                type="button"
                                class="px-3 py-1.5 text-xs border border-red-400/60 text-red-200 hover:bg-red-400/10 transition-colors"
                                onclick="updateCountryDashboard(${retryArg})"
                            >[RETRY]</button>
                        </div>
                    `;
                }
            };

            // ÈùûÂÖ®ÁΩëÔºö‰ªÖÊõ¥Êñ∞Áä∂ÊÄÅÔºàËØç‰∫ëÁî± loadWordCloud() Ë¥üË¥£Ê∏≤ÊüìÔºâ
            if (!isGlobal) {
                if (statusEl) statusEl.textContent = 'DATA: FETCHING';
            }

            try {
                if (statusEl) statusEl.textContent = 'DATA: FETCHING';
                // ËØ∑Ê±ÇÂèëËµ∑ÂâçÂÖàÁªôÂá∫Âä†ËΩΩÊÄÅÔºåÈÅøÂÖçÊóßÊï∞ÊçÆËØØÂØº
                renderRadarMessage('Êï∞ÊçÆÂä†ËΩΩ‰∏≠...');
                if (realtimeDom) realtimeDom.innerHTML = '<div class="text-zinc-500 text-xs">Âä†ËΩΩ‰∏≠...</div>';

                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const payload = await resp.json();
                const data = payload?.data ?? payload ?? {};

                // Â≠óÊÆµÊò†Â∞ÑÔºàÂÖºÂÆπ total_users/totalUsers Á≠âÔºâ
                const globalTotalUsersRaw =
                    data.totalUsers ??
                    data.total_users ??
                    data.us_stats?.totalUsers ??
                    data.us_stats?.total_users ??
                    null;
                const globalTotalAnalysisRaw =
                    data.totalAnalysis ??
                    data.total_analysis ??
                    data.us_stats?.totalAnalysis ??
                    data.us_stats?.total_analysis ??
                    null;

                const avg_l = data.avg_l ?? data.avgL ?? data.us_stats?.avg_l ?? null;
                const avg_p = data.avg_p ?? data.avgP ?? data.us_stats?.avg_p ?? null;
                const avg_d = data.avg_d ?? data.avgD ?? data.us_stats?.avg_d ?? null;
                const avg_e = data.avg_e ?? data.avgE ?? data.us_stats?.avg_e ?? null;
                const avg_f = data.avg_f ?? data.avgF ?? data.us_stats?.avg_f ?? null;

                // Èõ∑ËææÂõæÊï∞ÊçÆÂº∫Âà∂ËΩ¨Êç¢ÔºöÈÅøÂÖç "55.0" ËøôÁ±ªÂ≠óÁ¨¶‰∏≤ÂØºËá¥ ECharts ÂºÇÂ∏∏
                const radarData = [
                    Number(avg_l || 0),
                    Number(avg_p || 0),
                    Number(avg_d || 0),
                    Number(avg_e || 0),
                    Number(avg_f || 0),
                ];

                // AI ÂäüÂæ∑Á∞øÔºöÁ¥ØËÆ°Â≠óÊï∞Ôºà‰∏áÂ≠óÔºâ
                const meritEl = document.getElementById('rtMeritBoard');
                const totalCharsSumRaw =
                    data.totalCharsSum ??
                    data.total_chars_sum ??
                    data.totalChars ??
                    data.total_chars ??
                    data.us_stats?.totalCharsSum ??
                    data.us_stats?.total_chars_sum ??
                    null;
                const totalCharsSum = Number(totalCharsSumRaw);
                if (meritEl) {
                    if (Number.isFinite(totalCharsSum) && totalCharsSum > 0) {
                        meritEl.textContent = `Â∑≤Á¥ØËÆ°ÂàÜÊûê ${(totalCharsSum / 10000).toFixed(1)} ‰∏áÂ≠ó`;
                    } else {
                        meritEl.textContent = 'Â∑≤Á¥ØËÆ°ÂàÜÊûê -- ‰∏áÂ≠ó';
                    }
                }

                // Â¶ÇÊûúÊòØÁæéÂõΩÔºåÈúÄË¶ÅÂêåÊó∂ÊãøÂà∞ÔºöÊú¨Âú∞Âå∫ totalUsers / totalAnalysis ÂíåÂÖ®ÁêÉ totalUsersÔºàÁî®‰∫é RatioÔºâ
                let globalTotalUsers = Number(
                    data.totalUsers ?? data.total_users ?? null
                );
                let globalTotalAnalysis = Number(
                    data.totalAnalysis ?? data.total_analysis ?? null
                );
                let localTotalUsers = Number(
                    data.us_stats?.totalUsers ??
                    data.us_stats?.total_users ??
                    (isGlobal ? (data.totalUsers ?? data.total_users ?? null) : null) ??
                    (isUS ? (data.totalUsers ?? data.total_users ?? null) : null) ??
                    null
                );
                let localTotalAnalysis = Number(
                    data.us_stats?.totalAnalysis ??
                    data.us_stats?.total_analysis ??
                    (isGlobal ? (data.totalAnalysis ?? data.total_analysis ?? null) : null) ??
                    (isUS ? (data.totalAnalysis ?? data.total_analysis ?? null) : null) ??
                    null
                );

                // Êüê‰∫õÊé•Âè£ÂèØËÉΩÂè™ËøîÂõûÂú∞Âå∫Âè£ÂæÑÔºåËøôÈáåÂÖúÂ∫ïÂÜçÊãâ‰∏ÄÊ¨°ÂÖ®ÁΩë totalUsers
                if (isUS && (!Number.isFinite(globalTotalUsers) || globalTotalUsers <= 0)) {
                    try {
                        const gResp = await fetch(`${API_ENDPOINT}api/global-average`);
                        if (gResp.ok) {
                            const gPayload = await gResp.json();
                            const gData = gPayload?.data ?? gPayload ?? {};
                            globalTotalUsers = Number(gData.totalUsers ?? gData.total_users ?? 0);
                            globalTotalAnalysis = Number(gData.totalAnalysis ?? gData.total_analysis ?? 0);
                        }
                    } catch (e) {
                        // ignore
                    }
                }

                // ÂÖúÂ∫ïÔºöÁ°Æ‰øù finite number
                if (!Number.isFinite(globalTotalUsers)) globalTotalUsers = 0;
                if (!Number.isFinite(globalTotalAnalysis)) globalTotalAnalysis = 0;
                if (!Number.isFinite(localTotalUsers)) localTotalUsers = 0;
                if (!Number.isFinite(localTotalAnalysis)) localTotalAnalysis = 0;

                const latest =
                    data.latest_records ??
                    data.latestRecords ??
                    data.latest_records_v6 ??
                    data.latest ??
                    data.latestRecordsV6 ??
                    [];

                // Êï∞ÂÄºÂ°´ÂÖÖ + UI ÈôçÁ∫ßÔºö0/Á©∫‰∏çÈó™ÁÉÅ
                // ËßÑÂàôÔºöÂú∞Âå∫Âç°ÁâáÂ±ïÁ§∫‚ÄúÂΩìÂâçÂú∞Âå∫‚ÄùÂè£ÂæÑÔºõÂÖ®ÁΩëÊ®°ÂºèÂ±ïÁ§∫ÂÖ®ÁΩë
                setValueOrNA(usersValEl, isUS ? localTotalUsers : (isGlobal ? globalTotalUsers : localTotalUsers));
                setValueOrNA(analysisValEl, isUS ? localTotalAnalysis : (isGlobal ? globalTotalAnalysis : localTotalAnalysis));
                if (usersValEl && usersValEl.textContent !== 'N/A') flash(usersCardEl || usersValEl);
                if (analysisValEl && analysisValEl.textContent !== 'N/A') flash(analysisCardEl || analysisValEl);

                // Èõ∑ËææÂõæÁ©∫Áä∂ÊÄÅÔºöÂÖ®ÈÉ®‰∏∫ 0 Êó∂ÊòæÁ§∫ÊèêÁ§∫ËÄå‰∏çÊòØÊ∏≤ÊüìÁ©∫Âõæ
                if (radarData.every((v) => Number(v) === 0)) {
                    renderRadarMessage('ËØ•Âú∞Âå∫ÁîªÂÉèÊï∞ÊçÆ‰∏çË∂≥ÔºåÊ≠£Âú®Ê±áÊÄª‰∏≠...');
                } else {
                    renderRadar(radarData);
                }

                // =========================
                // Ê¥æÁîüÊåáÊ†áËÆ°ÁÆó‰∏éÊ∏≤Êüì
                // =========================
                const clampPct = (n) => {
                    const x = Number(n);
                    if (!Number.isFinite(x)) return 0;
                    return Math.max(0, Math.min(100, x));
                };
                const avgL = radarData[0];
                const avgP = radarData[1];
                const avgD = radarData[2];
                const avgE = radarData[3];
                const avgF = radarData[4];

                const metrics = {
                    power: clampPct(avgD * 0.7 + avgP * 0.3),
                    breakdown: clampPct((100 - avgE) * 0.8),
                    semantic: clampPct(avgL * 0.6 + avgF * 0.4),
                    ratio: clampPct(globalTotalUsers > 0 ? (localTotalUsers / globalTotalUsers) * 100 : 0),
                };
                if (isGlobal) metrics.ratio = 100;

                // Êï∞ÂÄºÂ°´ÂÖÖ
                const powerScoreEl = document.getElementById('rtPowerScore');
                const breakdownRateEl = document.getElementById('rtBreakdownRate');
                const semanticScoreEl = document.getElementById('rtSemanticScore');
                const ratioPctEl = document.getElementById('rtRatioPct');
                if (powerScoreEl) powerScoreEl.textContent = metrics.power > 0 ? metrics.power.toFixed(1) : 'N/A';
                if (breakdownRateEl) breakdownRateEl.textContent = metrics.breakdown > 0 ? `${metrics.breakdown.toFixed(1)}%` : 'N/A';
                if (semanticScoreEl) semanticScoreEl.textContent = metrics.semantic > 0 ? metrics.semantic.toFixed(1) : 'N/A';
                if (ratioPctEl) ratioPctEl.textContent = `${metrics.ratio.toFixed(2)}%`;

                // ËøõÂ∫¶Êù°ËÅîÂä®
                const setBar = (id, v) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const pct = clampPct(v);
                    el.style.width = `${pct.toFixed(1)}%`;
                };
                setBar('power-bar', metrics.power);
                setBar('breakdown-bar', metrics.breakdown);
                setBar('semantic-bar', metrics.semantic);
                setBar('ratio-bar', metrics.ratio);

                // =========================
                // ÈúÄÊ±ÇÔºöÈ´òÂàÜÂõæË∞± (#rtTopTalentsList)
                // Êï∞ÊçÆÊ∫êÔºödata.top_talents [{dim,user_name,score}]
                // =========================
                const topTalentsEl = document.getElementById('rtTopTalentsList');
                const topTalents = Array.isArray(data.top_talents) ? data.top_talents : [];
                const dimTitleMap = {
                    L: 'ÈÄªËæë‰πãÁ•û',
                    P: 'ÊâßË°åÊú∫Âô®',
                    D: 'ÁªüÊ≤ªÈ¢Ü‰∏ª',
                    E: 'ÂÆöÊµ∑Á•ûÈíà',
                    F: 'ÁªÜËäÇÁãÇÈ≠î',
                };
                if (topTalentsEl) {
                    const dims = ['L', 'P', 'D', 'E', 'F'];
                    topTalentsEl.innerHTML = dims.map((dim) => {
                        const found = topTalents.find((t) => String(t?.dim || '').toUpperCase() === dim) || null;
                        const userName = found?.user_name ?? found?.userName ?? '--';
                        const scoreNum = Number(found?.score);
                        const scoreText = Number.isFinite(scoreNum) ? scoreNum.toFixed(1) : '--';
                        return `
                            <div class="flex items-center justify-between gap-3 border-b border-white/10 pb-2">
                                <div class="flex items-center gap-2 min-w-0">
                                    <span class="text-[10px] px-2 py-0.5 border border-[#00ff41]/30 text-[#00ff41] bg-[#00ff41]/5">${dim}</span>
                                    <span class="text-xs text-white font-bold">${escapeHtml(dimTitleMap[dim] || dim)}</span>
                                </div>
                                <div class="flex items-center gap-3 min-w-0">
                                    <span class="text-[10px] text-zinc-400 truncate">@${escapeHtml(userName)}</span>
                                    <span class="text-xs text-green-500 font-bold tabular-nums">${escapeHtml(scoreText)}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // ËØ≠‰πâÁàÜÂèëËØç‰∫ëÂç°ÁâáÔºö‰ªÖ‰øùÁïôËØç‰∫ëÂΩ¢ÊÄÅÔºàECharts wordCloudÔºâÔºå‰∏çÂÜçÊ∏≤Êüì slang/merit/sv_slang ÊñáÊú¨Âå∫
                // ËØç‰∫ëÊï∞ÊçÆÁî± loadWordCloud() ÈÄöËøá /api/v2/wordcloud-data Âä®ÊÄÅÊãâÂèñ

                // =========================
                // ÈúÄÊ±ÇÔºöÂÖ®ÁêÉÂç†ÊØî (#rtGlobalRatio)
                // ÂÖ¨ÂºèÔºö(data.totalUsers / data.globalTotalUsers * 100).toFixed(1) + '%'
                // ÂêåÊ≠•Êõ¥Êñ∞ÊñáÂ≠ó‰∏éËøõÂ∫¶Êù°
                // =========================
                const globalRatioEl = document.getElementById('rtGlobalRatio');
                const totalUsersForRatio = Number(data.totalUsers ?? data.total_users ?? 0);
                const globalTotalUsersForRatio = Number(data.globalTotalUsers ?? data.global_total_users ?? globalTotalUsers ?? 0);
                const ratioPct = (globalTotalUsersForRatio > 0)
                    ? (totalUsersForRatio / globalTotalUsersForRatio) * 100
                    : (isGlobal ? 100 : metrics.ratio);
                const ratioText = `${(Number.isFinite(ratioPct) ? ratioPct : 0).toFixed(1)}%`;
                if (globalRatioEl) globalRatioEl.textContent = ratioText;
                if (ratioPctEl) ratioPctEl.textContent = ratioText;
                setBar('ratio-bar', Number.isFinite(ratioPct) ? ratioPct : 0);

                // Â§çÁî®Áé∞Êúâ PK Êù°ÔºàÂ∑¶=PowerÔºåÂè≥=100-PowerÔºâ
                const pkLeftFill = document.getElementById('rtPkLeftFill');
                const pkRightFill = document.getElementById('rtPkRightFill');
                const pkLeftPct = document.getElementById('rtPkLeftPct');
                const pkRightPct = document.getElementById('rtPkRightPct');
                if (pkLeftFill) pkLeftFill.style.width = `${metrics.power.toFixed(1)}%`;
                if (pkRightFill) pkRightFill.style.width = `${(100 - metrics.power).toFixed(1)}%`;
                if (pkLeftPct) pkLeftPct.textContent = `${metrics.power.toFixed(1)}%`;
                if (pkRightPct) pkRightPct.textContent = `${(100 - metrics.power).toFixed(1)}%`;

                // Á†¥Èò≤Á≠âÁ∫ß / ÂèóËôê‰∫∫Êï∞ÔºàÊ¥æÁîüÂ±ïÁ§∫Ôºâ
                const meltdownLevelEl = document.getElementById('rtMeltdownLevel');
                const meltdownVictimsEl = document.getElementById('rtMeltdownVictims');
                if (meltdownLevelEl) {
                    meltdownLevelEl.textContent =
                        metrics.breakdown >= 70 ? 'ELEVATED' :
                        metrics.breakdown >= 40 ? 'WARNING' :
                        'STABLE';
                }
                if (meltdownVictimsEl) {
                    meltdownVictimsEl.textContent = localTotalUsers > 0
                        ? new Intl.NumberFormat('zh-CN').format(localTotalUsers)
                        : 'N/A';
                }

                // ËØ≠‰πâÁàÜÂèëË°•ÂÖÖÊñáÊ°àÔºöÊ†∏ÂøÉÁâπË¥® + ÊåáÊ†á
                const dimKeys = ['L', 'P', 'D', 'E', 'F'];
                let maxIdx = 0;
                for (let i = 1; i < radarData.length; i++) {
                    if (Number(radarData[i]) > Number(radarData[maxIdx])) maxIdx = i;
                }
                const coreTrait = dimKeys[maxIdx] || 'L';
                const coreTraitEl = document.getElementById('rtCoreTrait');
                if (coreTraitEl) coreTraitEl.textContent = `ËØ•Âú∞Âå∫Ê†∏ÂøÉÁâπË¥®Ôºö${coreTrait}`;

                const semanticMostUsedEl = document.getElementById('rtSemanticMostUsed');
                const semanticFreqEl = document.getElementById('rtSemanticFreq');
                if (semanticMostUsedEl) semanticMostUsedEl.textContent = `CORE_TRAIT: ${coreTrait}`;
                if (semanticFreqEl) semanticFreqEl.textContent = `SEMANTIC: ${metrics.semantic.toFixed(1)}`;

                // ÂÖ®ÁêÉÂç†ÊØîÂàóË°®ÔºàÁÆÄÂçï‰∏§È°πÔºâ
                const ratioListEl = document.getElementById('rtRatioList');
                if (ratioListEl) {
                    const label = isGlobal ? 'GLOBAL' : (isUS ? 'US' : 'REGION');
                    const rest = clampPct(100 - metrics.ratio);
                    ratioListEl.innerHTML = `
                        <div class="flex justify-between text-xs">
                            <span class="flex items-center gap-2"><div class="w-2 h-2 bg-[#00ff41]"></div> ${label}</span>
                            <span class="font-bold">${metrics.ratio.toFixed(2)}%</span>
                        </div>
                        <div class="flex justify-between text-xs text-zinc-500">
                            <span class="flex items-center gap-2"><div class="w-2 h-2 bg-zinc-700"></div> OTHERS</span>
                            <span class="font-bold">${rest.toFixed(2)}%</span>
                        </div>
                    `;
                }

                // NOTE: Â∑≤Âú®‰∏äÊñπ‚ÄúÊ¥æÁîüÊåáÊ†áËÆ°ÁÆó‰∏éÊ∏≤Êüì / ËØ≠‰πâÁàÜÂèëÔºàÁúüÂÆûÂä®ÊÄÅÂåñÔºâ‚ÄùÂÆåÊàêÊ∏≤ÊüìÔºå
                // ËøôÈáå‰∏çÂÜçÈáçÂ§çË¶ÜÁõñ powerScore / semanticBurstÔºåÈÅøÂÖç UI ÊäñÂä®‰∏éÈÄªËæëÂàÜÂèâ„ÄÇ

                renderRealtime(latest);

                if (statusEl) statusEl.textContent = 'DATA: STABLE';
            } catch (err) {
                console.error('[CountryDashboard] ‚ùå Êõ¥Êñ∞Â§±Ë¥•:', err);
                renderErrorState(err && err.message ? String(err.message) : 'ÁΩëÁªúÂºÇÂ∏∏ÊàñÊúçÂä°Âô®ÈîôËØØ');
            }
        }
        
        // ==========================================
        // ÂéüÊúâ‰ª£Á†ÅÁªßÁª≠...
        // ==========================================
        
        // =========================
        // ÂÖ®Â±ÄÂèòÈáèÂ£∞ÊòéÔºàÁ°Æ‰øùÂú®ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºå‰∏çÂú®Èó≠ÂåÖÂÜÖÔºâ
        // =========================
        const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content;
        let currentLang = 'zh';
        
        // Supabase Áõ∏ÂÖ≥ÂèòÈáèÔºàÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºå‰∏çÂú®‰ªª‰ΩïÂáΩÊï∞ÂÜÖÔºâ
        let supabaseClient = null;
        let realtimeChannel = null;
        let presenceChannel = null; // Presence È¢ëÈÅìÔºåÁî®‰∫éÁªüËÆ°Âú®Á∫ø‰∫∫Êï∞
        const SUPABASE_URL = 'https://dtcplfhcgnxdzpigmotb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_-rrlujgXDNxqb-UsMJckNw_G2rn2e8x';
        
        // ÈªòËÆ§Â§¥ÂÉèÂ∏∏Èáè
        const DEFAULT_AVATAR = 'https://github.com/identicons/guest.png';
        
        // Êó†ÊïàÁî®Êà∑ÂêçÁöÑÈªòËÆ§ÂÄºÂàóË°®ÔºàËøô‰∫õÂÄº‰∏çÂ∫îËØ•ËØ∑Ê±ÇGitHubÂ§¥ÂÉèÔºâ
        const INVALID_USERNAME_VALUES = ['Ëá™Âä®‰∏äÊä•Áî®Êà∑', 'Anonymous', 'Guest', 'guest', 'anonymous', ''];
        
        // Áî®Êà∑Áä∂ÊÄÅÈÖçÁΩÆ
        const USER_STATUSES = {
            idle: { 
                label: 'ÊûÅÈÄü', 
                emoji: 'üü¢', 
                color: '#00ff41',
                status_color: '#00ff41',
                status: 'idle'
            },
            busy: { 
                label: 'ÂøôÁ¢å', 
                emoji: 'üü†', 
                color: '#ff8c00',
                status_color: '#ff8c00',
                status: 'busy'
            },
            sprint: { 
                label: 'ÂÜ≤Âà∫', 
                emoji: 'üöÄ', 
                color: '#ff006e',
                status_color: '#ff006e',
                status: 'sprint'
            }
        };
        
        // ÂΩìÂâçÁî®Êà∑Áä∂ÊÄÅÔºà‰ªélocalStorageÂä†ËΩΩÔºâ
        let currentUserStatus = localStorage.getItem('user_status') || 'idle';
        
        // ÊäΩÂ±âÂ±ïÂºÄ/ÊäòÂè†Áä∂ÊÄÅÔºà‰ªélocalStorageÂä†ËΩΩÔºâ
        let drawerExpanded = localStorage.getItem('drawer_expanded') !== 'false'; // ÈªòËÆ§Â±ïÂºÄ

        // Áª¥Â∫¶ÊéíÂêçÊï∞ÊçÆËµÑÊ∫êÔºà‰ªé rank-content.ts Âä†ËΩΩÔºâ
        let RANK_RESOURCES = null;

        // ============================================
        // „ÄêÂÖ®Â±ÄÈîôËØØÊçïËé∑„ÄëÈò≤Ê≠¢Âçï‰∏™Ê®°ÂùóÂ¥©Ê∫ÉÂØºËá¥Êï¥‰∏™È°µÈù¢Êó†Ê≥ïÂä†ËΩΩ
        // ============================================
        window.addEventListener('error', (event) => {
            console.error('[Global Error Handler] ‚ùå ÊçïËé∑Âà∞ÂÖ®Â±ÄÈîôËØØ:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
            
            // Â¶ÇÊûúÊòØËØ≠Ê≥ïÈîôËØØÔºåÂ∞ùËØïÁªßÁª≠ÊâßË°åÂÖ≥ÈîÆÂàùÂßãÂåñ
            if (event.error && event.error.name === 'SyntaxError') {
                console.warn('[Global Error Handler] ‚ö†Ô∏è Ê£ÄÊµãÂà∞ËØ≠Ê≥ïÈîôËØØÔºåÂ∞ùËØïÁªßÁª≠ÂàùÂßãÂåñÂÖ≥ÈîÆÂäüËÉΩ...');
                // ‰∏çÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫Ôºå‰ΩÜËÆ∞ÂΩïÈîôËØØ
            }
        });
        
        // ÊçïËé∑Êú™Â§ÑÁêÜÁöÑ Promise ÊãíÁªù
        window.addEventListener('unhandledrejection', (event) => {
            console.error('[Global Error Handler] ‚ùå ÊçïËé∑Âà∞Êú™Â§ÑÁêÜÁöÑ Promise ÊãíÁªù:', event.reason);
            // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫ÔºàÊéßÂà∂Âè∞Êä•ÈîôÔºâÔºå‰ΩÜËÆ∞ÂΩïÈîôËØØ
            event.preventDefault();
        });
        
        // ============================================
        // ÂàùÂßãÂåñ Supabase ÂÆ¢Êà∑Á´ØÔºàÂÖ®Â±Ä‰ΩúÁî®ÂüüÁõ¥Êé•ÊâßË°åÔºâ
        // ============================================
        // ‰ΩøÁî®ËΩÆËØ¢ÊñπÂºèÁ≠âÂæÖ SDK Âä†ËΩΩÂÆåÊàê
        let initAttempts = 0;
        const maxAttempts = 50; // ÊúÄÂ§öÂ∞ùËØï 5 ÁßíÔºà50 * 100msÔºâ

        const initInterval = setInterval(() => {
            initAttempts++;
            
            // Ê£ÄÊü• supabase ÊòØÂê¶Â∑≤Âä†ËΩΩ
            if (typeof supabase !== 'undefined') {
                clearInterval(initInterval);
                
                try {
                    // ÂÆû‰æãÂåñÂÆ¢Êà∑Á´ØÔºàÁõ¥Êé•ËµãÂÄºÁªôÂÖ®Â±ÄÂèòÈáèÔºâ
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    
                    // ÊåÇËΩΩÂà∞ÂÖ®Â±Ä windowÔºå‰æõÊéßÂà∂Âè∞ËÑöÊú¨‰ΩøÁî®
                    window.supabaseClient = supabaseClient;
                    
                    console.log('[Init] ‚úÖ Supabase ÂÆ¢Êà∑Á´ØÂ∑≤ÊàêÂäüÊåÇËΩΩËá≥ window.supabaseClient');
                    console.log('[Init] üí° ÂèØÂú®ÊéßÂà∂Âè∞‰ΩøÁî® window.supabaseClient ËÆøÈóÆÂÆ¢Êà∑Á´Ø');
                } catch (err) {
                    console.error('[Init] ‚ùå ÂàùÂßãÂåñÂ§±Ë¥•:', err);
                }
            } else if (initAttempts >= maxAttempts) {
                clearInterval(initInterval);
                console.error('[Init] ‚ùå Supabase SDK Âä†ËΩΩË∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•Êàñ CDN ÊòØÂê¶ÂèØËÆøÈóÆ');
            }
        }, 100);
        const i18n = {
            zh: {
                'sub-title': 'ÂÆûÊó∂ËøúÁ®ãÁõëÊµãÁä∂ÊÄÅ // ËäÇÁÇπÔºöÂ§™Âπ≥Ê¥ã‰∏≠ÈÉ®',
                'total-victims': 'Â∑≤ËØäÊñ≠ÂºÄÂèëËÄÖ',
                'total-analysis': 'ÂÖ®ÁΩëÊâ´ÊèèÊ¨°Êï∞',
                'total-roast': 'Á¥ØËÆ°ÂêêÊßΩÂ≠óÊï∞',
                'avg-chars': '‰∫∫ÂùáÂêêÊßΩÈáè',
                'radar-title': 'ÂÖ®ÁΩëÂπ≥ÂùáÂºÄÂèëËÄÖÁîªÂÉè',
                'personality-dist': '‰∫∫Ê†ºÂàÜÂ∏ÉÊéíË°å',
                'active-nodes': 'Ê¥ªË∑ÉËäÇÁÇπ',
                'threat-level': 'È£éÈô©ËØÑÁ∫ß',
                'top-hotspot': 'ÊúÄÂØÜÈõÜÁÉ≠Âå∫',
                'sys-days': 'ËøêË°åÂ§©Êï∞',
                'city-coverage': 'ÂüéÂ∏ÇË¶ÜÁõñ',
                'sync-rate': 'ÂêåÊ≠•ÈÄüÁéá',
                'hot-list': 'Âú∞ÁêÜ‰ΩçÁΩÆÁÉ≠ÂäõÊéíË°å',
                'recent-activity': 'ÂÆûÊó∂ËØäÊñ≠Ê¥ªÂä®',
                'victim': 'ÂèóÂÆ≥ËÄÖ',
                'loading': 'ÂàùÂßãÂåñ‰∏≠...',
                'rank': 'ÊéíÂêç'
            },
            en: {
                'sub-title': 'Telemetry Status // Node: Central_Pacific',
                'total-victims': 'Total Developers',
                'total-analysis': 'Total Scans',
                'total-roast': 'Total Roast Words',
                'avg-chars': 'Avg Roast Per User',
                'radar-title': 'Global Developer Persona',
                'personality-dist': 'Personality Distribution',
                'active-nodes': 'Active Nodes',
                'threat-level': 'Threat Level',
                'top-hotspot': 'Primary Hotspot',
                'sys-days': 'Days Online',
                'city-coverage': 'City Coverage',
                'sync-rate': 'Sync Rate',
                'hot-list': 'Geographic Hotspots',
                'recent-activity': 'Live Activity Feed',
                'victim': 'Victim',
                'loading': 'Initializing...',
                'rank': 'Rank'
            }
        };

        const countryNameMap = {
            'CN': { zh: '‰∏≠ÂõΩ', en: 'China' },
            // Ê≥®ÊÑèÔºöECharts world Âú∞ÂõæÂØπÁæéÂõΩÁöÑÊ†áÂáÜÂêçÁß∞ÈÄöÂ∏∏ÊòØ 'United States' / 'United States of America'
            // ËøôÈáåÁî® 'United States' ‰Ωú‰∏∫ enÔºå‰æø‰∫éÂú∞Âõæ name ÂåπÈÖç‰∏éÁÇπÂáªËß£Êûê
            'US': { zh: 'ÁæéÂõΩ', en: 'United States' },
            'JP': { zh: 'Êó•Êú¨', en: 'Japan' },
            'GB': { zh: 'Ëã±ÂõΩ', en: 'UK' },
            'DE': { zh: 'Âæ∑ÂõΩ', en: 'Germany' },
            'SG': { zh: 'Êñ∞Âä†Âù°', en: 'Singapore' },
            'HK': { zh: '‰∏≠ÂõΩÈ¶ôÊ∏Ø', en: 'Hong Kong' },
            'TW': { zh: '‰∏≠ÂõΩÂè∞Êπæ', en: 'Taiwan' }
        };

        /**
         * Â∞Ü ECharts world Âú∞ÂõæÁöÑÂõΩÂÆ∂ÂêçÁß∞Ëß£Êûê‰∏∫ ISO2 ÂõΩÂÆ∂Á†ÅÔºàÂ¶Ç 'United States of America' -> 'US'Ôºâ
         * ‰ªÖÂÅö UI Â±ÇË∑ØÁî±Áî®ÔºàÊäΩÂ±â/ÂõΩÂÆ∂ÈÄèËßÜÔºâÔºåÂ§±Ë¥•Êó∂ËøîÂõû null„ÄÇ
         */
        function resolveCountryCodeFromMapName(name) {
            const raw = String(name || '').trim();
            if (!raw) return null;
            // Áõ¥Êé•ÊòØ ISO2
            if (/^[A-Za-z]{2}$/.test(raw)) return raw.toUpperCase();

            const n = raw.toLowerCase();

            // È´ò‰ºòÂÖàÁ∫ßÂà´ÂêçÔºöÁæéÂõΩ/Ëã±ÂõΩÔºàECharts world Â∏∏ËßÅÂëΩÂêçÂ∑ÆÂºÇÔºâ
            if (n === 'usa' || n === 'u.s.a' || n === 'u.s.' || n.includes('united states')) return 'US';
            if (n === 'uk' || n.includes('united kingdom')) return 'GB';

            // ‰ªé countryNameMap ÂèçÊü•Ôºàen/zh ÈÉΩÊîØÊåÅÔºâ
            try {
                for (const [code, names] of Object.entries(countryNameMap || {})) {
                    if (!names) continue;
                    const en = String(names.en || '').trim().toLowerCase();
                    const zh = String(names.zh || '').trim().toLowerCase();
                    if (en && en === n) return String(code).toUpperCase();
                    if (zh && zh === n) return String(code).toUpperCase();
                }
            } catch (e) {
                // ignore
            }
            return null;
        }

        let mapChart, radarChart;
        let currentViewState = 'GLOBAL'; // GLOBAL Êàñ COUNTRYÔºàÂè≥‰æßÊäΩÂ±âÔºöÂÆûÊó∂Âä®ÊÄÅÊµÅ / ÂõΩÂÆ∂ÈÄèËßÜÔºâ
        let selectedCountry = null; // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂõΩÂÆ∂
        let currentChampionInfo = null; // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂÜ†ÂÜõ‰ø°ÊÅØÔºàÁî®‰∫éÂú∞Âõæ tooltip Â±ïÁ§∫Ôºâ
        /** Ê†°ÂáÜÊ®°ÂºèÔºöÁÇπÂáª„ÄåCurrent Location„ÄçÂÖâÊ†áÂêé‰∏∫ trueÔºåÂÅúÊ≠¢Êìç‰Ωú 1.5 ÁßíÂêéÊÅ¢Â§ç false */
        let isCalibrating = false;
        /** ÂæÖÁ°ÆËÆ§ÁöÑÊ†°ÂáÜÊï∞ÊçÆÔºàlng, lat, countryCode, countryNameÔºâ */
        let pendingCalibration = { lng: null, lat: null, countryCode: null, countryName: null };
        /** ÂõΩÂÆ∂Ëã±ÊñáÂêç -> Ëøë‰ºº‰∏≠ÂøÉ [lng, lat]ÔºàÁî®‰∫éÊ†°ÂáÜÊó∂ÂÖâÊ†áÁßªÂä®Ôºâ */
        const countryCenterMap = {
            'China': [105, 35], 'United States': [-95, 38], 'United States of America': [-95, 38],
            'Japan': [138, 36], 'United Kingdom': [-2, 54], 'Germany': [10, 51], 'France': [2, 46],
            'Singapore': [104, 1.3], 'Hong Kong': [114, 22.3], 'Taiwan': [121, 24],
            'Canada': [-106, 56], 'Australia': [134, -25], 'India': [78, 21], 'Brazil': [-55, -10],
            'South Korea': [128, 36], 'Russia': [100, 60], 'Italy': [12, 43], 'Spain': [-3, 40],
            'Netherlands': [5, 52], 'Sweden': [15, 62], 'Poland': [20, 52], 'Indonesia': [118, -5],
            'Mexico': [-102, 23], 'South Africa': [25, -29], 'Turkey': [35, 39], 'Vietnam': [108, 16],
            'Thailand': [100, 15], 'Malaysia': [112, 4], 'Philippines': [122, 13], 'Pakistan': [68, 30],
            'Egypt': [30, 27], 'Nigeria': [8, 10], 'Argentina': [-64, -34], 'Colombia': [-72, 4],
            'USA': [-95, 38], 'UK': [-2, 54], 'Korea': [128, 36]
        };
        // üîç Áß∞Âè∑‰∏éËØ¥ÊòéÊò†Â∞ÑÔºàÂÆåÂÖ®ÂêåÊ≠• content.ts ÁöÑ‰∏öÂä°ËØ≠‰πâÔºâ
        const DIMENSION_TITLES = {
            L: { title: 'Êû∂ÊûÑÂ∏àÁöÑÁõ¥Ëßâ', description: 'Âú®ÈÄªËæëËø∑ÂÆ´‰∏≠‰∏ÄÁúºÁúãÁ©øÊú¨Ë¥®' },
            P: { title: 'Ê∑±Êµ∑ÊΩúËà™ËÄÖ', description: 'Èù¢ÂØπÂ§çÊùÇÈÄªËæëÊã•ÊúâÊûÅËá¥ÁöÑÈùôÊ∞î' },
            D: { title: 'ÂÉèÁ¥†Á∫ß‰æ¶Êé¢', description: '‰ªª‰ΩïÂæÆÂ∞èÁöÑ‰ª£Á†ÅÁëïÁñµÈÉΩÊó†ÊâÄÈÅÅÂΩ¢' },
            E: { title: 'ÂÖ±ÊÉÖÊû∂ÊûÑÂ∏à', description: '‰ª£Á†Å‰∏≠ÊµÅÊ∑åÁùÄÂØπÁî®Êà∑‰ΩìÈ™åÁöÑÊûÅËá¥ÁêÜËß£' },
            F: { title: 'ÊåáÂ∞ñÊâìÂáª‰πêÊâã', description: 'ÊûÅËá¥ÁöÑËæìÂÖ•È¢ëÁéá‰∏ã‰øùÊåÅÁùÄÊÉä‰∫∫ÁöÑÂáÜÁ°ÆÁéá' }
        };
        
        let lpdefExperts = { L: null, P: null, D: null, E: null, F: null }; // Â≠òÂÇ®ÂΩìÂâç‰∫î‰∏™Áª¥Â∫¶ÁöÑ‰∏ìÂÆ∂‰ø°ÊÅØ
        // Âú∞ÂõæÊ∏≤Êüì‰ª§ÁâåÔºöÈò≤Ê≠¢Âπ∂Âèë init / dispose ÂØºËá¥ getZr ‰∏∫Á©∫
        let mapRenderSeq = 0;
        
        // ÂÖ®Â±ÄÊï∞ÊçÆÂ≠òÂÇ®ÔºöÁî®‰∫é Realtime Êõ¥Êñ∞
        let latestRecords = [];

        /**
         * Êï∞Â≠óÊ†ºÂºèÂåñÂáΩÊï∞ÔºàÊô∫ËÉΩÂ§ÑÁêÜÂ§ßÊï∞Â≠óÔºâ
         * @param {number} num - Ë¶ÅÊ†ºÂºèÂåñÁöÑÊï∞Â≠ó
         * @returns {string} Ê†ºÂºèÂåñÂêéÁöÑÂ≠óÁ¨¶‰∏≤ÔºàÂ¶Ç 1.2M, 3.5KÔºâ
         */
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) {
                return '0';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        /**
         * Êï∞Â≠óÊªöÂä®Âä®ÁîªÔºàrequestAnimationFrameÔºâ
         * ÈúÄÊ±ÇÔºöanimateValue(id, end, duration) + ÂçÉÂàÜ‰ΩçÊ†ºÂºèÂåñ
         * @param {string} id - ÁõÆÊ†áÂÖÉÁ¥† id
         * @param {number} end - ÁªìÊùüÂÄº
         * @param {number} duration - Âä®ÁîªÊåÅÁª≠Êó∂Èó¥ÔºàÊØ´ÁßíÔºâ
         * @param {Object} options - ÂèØÈÄâÈ°π
         */
        function animateValue(id, end, duration = 1200, options = {}) {
            const el = document.getElementById(id);
            if (!el) return;

            const { start = 0, decimals = 0, useThousands = true } = options;
            const s = Number(start) || 0;
            const e = Number(end) || 0;
            const startTime = performance.now();

            const format = (val) => {
                const n = Number(val) || 0;
                if (useThousands) {
                    return n.toLocaleString(undefined, {
                        minimumFractionDigits: decimals,
                        maximumFractionDigits: decimals
                    });
                }
                return decimals > 0 ? n.toFixed(decimals) : String(Math.round(n));
            };

            const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

            function tick(now) {
                const t = Math.min((now - startTime) / duration, 1);
                const eased = easeOutCubic(t);
                const current = s + (e - s) * eased;
                el.textContent = format(decimals > 0 ? current : Math.floor(current));
                if (t < 1) requestAnimationFrame(tick);
                else el.textContent = format(e);
            }

            requestAnimationFrame(tick);
        }

        /**
         * Âä†ËΩΩÊÄÅÈ™®Êû∂Â±èÊ≥®ÂÖ•/ÁßªÈô§
         */
        const numericIds = [
            'totalUsers',
            'totalAnalysis',
            'totalChars',
            'avgPerUser',
            'avgPerScan',
            'systemDays',
            'cityCount',
        ];

        function setLoadingState(isLoading) {
            const scan = document.getElementById('scanLine');
            if (scan) scan.classList.toggle('active', !!isLoading);

            numericIds.forEach((id) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('skeleton', !!isLoading);
                if (isLoading) {
                    el.textContent = '000000';
                }
            });
        }

        function switchLang(lang) {
            currentLang = lang;
            document.getElementById('btn-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('btn-en').classList.toggle('active', lang === 'en');
            
            // Êõ¥Êñ∞ÈùôÊÄÅÊñáÊ°à
            document.getElementById('sub-title').innerText = i18n[lang]['sub-title'];
            document.querySelectorAll('.lang-key').forEach(el => {
                const key = el.getAttribute('data-key');
                el.innerText = i18n[lang][key];
            });

            // ÈáçÊñ∞Ê∏≤ÊüìÊï∞ÊçÆ‰æùËµñÂûãÁªÑ‰ª∂
            if (window.lastData) {
                renderLocationList(window.lastData.locationRank);
                const activityData = window.lastData.latestRecords || window.lastData.recentVictims || [];
                renderRecentActivity(activityData);
                renderPersonalityDistribution(window.lastData.personalityDistribution);
                // ÂºÇÊ≠•Ê∏≤ÊüìÂú∞ÂõæÔºåÁ°Æ‰øùÂú∞ÂõæÊï∞ÊçÆÂ∑≤Âä†ËΩΩ
                initGlobalMap(window.lastData.locationRank).catch(err => {
                    console.warn('[Dashboard] ËØ≠Ë®ÄÂàáÊç¢Êó∂Âú∞ÂõæÊ∏≤ÊüìÂ§±Ë¥•:', err);
                });
            }
        }

        /**
         * Ê£ÄÊü•Âú∞ÂõæÊï∞ÊçÆÊòØÂê¶Â∑≤Âä†ËΩΩ
         * world.js Âä†ËΩΩÂêé‰ºöÂú® echarts ‰∏≠Ê≥®ÂÜå 'world' Âú∞Âõæ
         */
        async function checkMapLoaded() {
            if (typeof echarts === 'undefined') {
                return false;
            }
            
            // Ê£ÄÊü•Âú∞ÂõæÊòØÂê¶Â∑≤Ê≥®ÂÜå
            // ECharts 5.x ‰ΩøÁî® getMap ÊñπÊ≥ïÊ£ÄÊü•
            try {
                if (typeof echarts.getMap === 'function') {
                    const mapData = echarts.getMap('world');
                    if (mapData) {
                        console.log('[Map] ‚úÖ Âú∞ÂõæÊï∞ÊçÆÂ∑≤Ê≥®ÂÜå');
                        return true;
                    }
                }
                
                // ÈôçÁ∫ßÊ£ÄÊü•ÔºöÂ∞ùËØïÊ≥®ÂÜåÂú∞ÂõæÔºàÂ¶ÇÊûú world.js Â∑≤Âä†ËΩΩÔºåÂú∞ÂõæÊï∞ÊçÆ‰ºöÂú®ÂÖ®Â±ÄÂèòÈáè‰∏≠Ôºâ
                // world.js ÈÄöÂ∏∏‰ºöÂ∞ÜÂú∞ÂõæÊï∞ÊçÆÂ≠òÂÇ®Âú®Êüê‰∏™ÂÖ®Â±ÄÂèòÈáè‰∏≠
                // Â¶ÇÊûúÂ≠òÂú®ÔºåÊâãÂä®Ê≥®ÂÜå
                if (typeof window !== 'undefined' && window.worldMapData) {
                    echarts.registerMap('world', window.worldMapData);
                    console.log('[Map] ‚úÖ ‰ªéÂÖ®Â±ÄÂèòÈáèÊ≥®ÂÜåÂú∞Âõæ');
                    return true;
                }
                
                // Ê£ÄÊü•ËÑöÊú¨Ê†áÁ≠æÊòØÂê¶Â∑≤Âä†ËΩΩ
                const worldScript = document.querySelector('script[src*="world.js"]');
                if (worldScript && worldScript.getAttribute('data-loaded') === 'true') {
                    console.log('[Map] ‚úÖ world.js ËÑöÊú¨Â∑≤Ê†áËÆ∞‰∏∫Âä†ËΩΩ');
                    return true;
                }
                
                console.warn('[Map] ‚ö†Ô∏è Âú∞ÂõæÊï∞ÊçÆÊú™ÊâæÂà∞ÔºåÁ≠âÂæÖ world.js Âä†ËΩΩ...');
                return false;
            } catch (error) {
                console.warn('[Map] ‚ö†Ô∏è Ê£ÄÊü•Âú∞ÂõæÊï∞ÊçÆÊó∂Âá∫Èîô:', error);
                return false;
            }
        }

        /**
         * ÂàõÂª∫Âçï‰∏™Áª¥Â∫¶Âç°ÁâáÔºàÁî®‰∫éÊäΩÂ±âÊòæÁ§∫Ôºâ
         * @param {string} dimId - Áª¥Â∫¶ID
         * @param {Object} config - Áª¥Â∫¶ÈÖçÁΩÆ
         * @param {number} maxValue - ÊúÄÂ§ßÂÄº
         * @param {string} targetUserName - Áî®Êà∑Âêç
         * @param {string|null} targetIpLocation - IP‰ΩçÁΩÆ
         * @param {Object|null} feedback - ÂèçÈ¶à‰ø°ÊÅØ
         * @param {boolean} isGlobalTopMode - ÊòØÂê¶‰∏∫ÂÖ®ÁêÉÊúÄÂº∫Ê®°Âºè
         * @returns {HTMLElement} Âç°ÁâáÂÖÉÁ¥†
         */
        function createDimensionCard(dimId, config, maxValue, targetUserName, targetIpLocation, feedback, isGlobalTopMode) {
            const displayVal = new Intl.NumberFormat('zh-CN').format(maxValue);
            const unit = config.suffix || '';

            const card = document.createElement('div');
            card.className = `drawer-item cursor-pointer`;
            card.setAttribute('data-dim-id', dimId);
            if (targetIpLocation) {
                card.setAttribute('data-ip-location', targetIpLocation);
            }
            card.setAttribute('data-champion-name', targetUserName);
            card.setAttribute('data-champion-value', maxValue);
            card.setAttribute('data-champion-feedback', feedback ? JSON.stringify(feedback) : '');

            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">${config.icon}</span>
                    <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                        ${isGlobalTopMode ? 'TOP' : 'MINE'}
                    </span>
                </div>
                <div class="drawer-item-label">${config.name}</div>
                <div class="drawer-item-value text-2xl">${displayVal}<span class="text-[10px] ml-1 font-normal opacity-70">${unit}</span></div>
                <div class="drawer-item-desc mt-2 pt-2 border-t border-[#00ff41]/10">
                    <div class="text-[10px] text-white font-bold truncate">${feedback ? feedback.label : 'RANKED'}</div>
                    <div class="text-[8px] text-[#00ff41]/60 truncate italic">@${targetUserName || 'ANONYMOUS'}</div>
                </div>
            `;

            // Ê∑ªÂä†Âú∞ÂõæËÅîÂä®‰∫§‰∫í
            card.addEventListener('click', () => {
                const ipLocation = card.getAttribute('data-ip-location');
                if (ipLocation && mapChart && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                    let countryName = null;
                    if (countryNameMap && countryNameMap[ipLocation]) {
                        countryName = countryNameMap[ipLocation].en;
                    } else {
                        countryName = ipLocation;
                    }
                    
                    if (countryName) {
                        const championName = card.getAttribute('data-champion-name');
                        const championValue = card.getAttribute('data-champion-value');
                        const championFeedback = card.getAttribute('data-champion-feedback');
                        const dimId = card.getAttribute('data-dim-id');
                        
                        currentChampionInfo = {
                            countryName: countryName,
                            championName: championName,
                            championValue: championValue,
                            feedback: championFeedback,
                            dimId: dimId
                        };
                        
                        try {
                            mapChart.dispatchAction({
                                type: 'highlight',
                                name: countryName
                            });
                            mapChart.dispatchAction({
                                type: 'showTip',
                                name: countryName
                            });
                            console.log(`[Drawer] ‚úÖ ÁÇπÂáªÂç°ÁâáÔºåÈ´ò‰∫ÆÂõΩÂÆ∂: ${countryName}`);
                        } catch (error) {
                            console.error('[Drawer] ‚ùå È´ò‰∫ÆÂõΩÂÆ∂Â§±Ë¥•:', error);
                        }
                    }
                }
            });

            return card;
        }

        // ‰øùÂ≠òÂΩìÂâçÊâìÂºÄÊäΩÂ±âÁöÑÂõΩÂÆ∂‰ø°ÊÅØÔºåÁî®‰∫éÂà∑Êñ∞
        let currentDrawerCountry = { code: null, name: null };

        /**
         * ÊòæÁ§∫ÊäΩÂ±âÂπ∂Â°´ÂÖÖÂõΩÂÆ∂Êï∞ÊçÆÂíåÁª¥Â∫¶Âç°Áâá
         * @param {string} countryCode - ÂõΩÂÆ∂‰ª£Á†Å
         * @param {string} countryName - ÂõΩÂÆ∂ÂêçÁß∞
         * @param {Object} [overrideRightData] - ÂèØÈÄâÔºåÊ†°ÂáÜÂêéÊãâÂèñÁöÑÂõΩÂÆ∂ÊëòË¶ÅÔºåÁî®‰∫éÂè≥‰æßÊäΩÂ±â 10 È°πÊ†∏ÂøÉÊåáÊ†á
         */
        function showDrawersWithCountryData(countryCode, countryName, overrideRightData) {
            // ‰øùÂ≠òÂΩìÂâçÂõΩÂÆ∂‰ø°ÊÅØ
            currentDrawerCountry.code = countryCode;
            currentDrawerCountry.name = countryName;
            const leftDrawer = document.getElementById('left-drawer');
            const rightDrawer = document.getElementById('right-drawer');
            const leftTitle = document.getElementById('left-drawer-title');
            const rightTitle = document.getElementById('right-drawer-title');
            const leftBody = document.getElementById('left-drawer-body');
            const globalFlowPanel = document.getElementById('globalFlowPanel');
            const countryPanelEl = document.getElementById('countryPanel');
            const rightBody = globalFlowPanel || document.getElementById('right-drawer-body');

            if (!leftDrawer || !rightDrawer) return;
            if (globalFlowPanel) globalFlowPanel.style.display = '';
            if (countryPanelEl) countryPanelEl.style.display = 'none';

            // Ëé∑ÂèñÂõΩÂÆ∂ÊòæÁ§∫ÂêçÁß∞
            const countryDisplayName = countryNameMap[countryCode] 
                ? (currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en)
                : countryName;

            // Êõ¥Êñ∞Ê†áÈ¢ò
            if (rightTitle) rightTitle.textContent = countryDisplayName;

            // Ê∏ÖÁ©∫ÊäΩÂ±âÂÜÖÂÆπ
            if (leftBody) leftBody.innerHTML = '';
            if (rightBody) rightBody.innerHTML = '';

            // Âè≥‰æßÊäΩÂ±âÊï∞ÊçÆÊ∫êÔºöÊ†°ÂáÜÂêé‰º†ÂÖ•ÁöÑÂõΩÂÆ∂ÊëòË¶Å‰ºòÂÖàÔºåÂê¶ÂàôÁî®ÂÖ®Â±Ä lastData
            const rightDrawerData = overrideRightData != null ? overrideRightData : (window.lastData || {});
            
            // Ëã•Ê≤°Êúâ‰º†ÂÖ•ÂõΩÂÆ∂ÊëòË¶ÅÔºåÂàôÂºÇÊ≠•ÊãâÂèñ‚ÄúÂõΩÂÆ∂Ê±áÊÄª(10È°πÊ†∏ÂøÉÊåáÊ†á)‚ÄùÁî®‰∫éÂè≥‰æßÊäΩÂ±âÊ±áÊÄªÂç°Áâá
            // ‰∏çÈòªÂ°ûÂΩìÂâçÊäΩÂ±âÊ∏≤ÊüìÔºöÂÖàÁî®ÂÖ®Â±Ä lastData ÂÖúÂ∫ïÂ±ïÁ§∫ÔºåÊãâÂèñÂÆåÊàêÂêéËá™Âä®Âà∑Êñ∞‰∏∫ÂõΩÂÆ∂Âè£ÂæÑ
            try {
                const cc = String(countryCode || '').trim().toUpperCase();
                const shouldFetchSummary =
                    overrideRightData == null &&
                    cc.length === 2 &&
                    typeof fetchCountrySummaryV3 === 'function';
                if (shouldFetchSummary) {
                    fetchCountrySummaryV3(cc)
                        .then((summary) => {
                            // ÈÅøÂÖçÁ´ûÊÄÅÔºöÂè™Âú®Áî®Êà∑‰ªçÂÅúÁïôÂú®Âêå‰∏ÄÂõΩÂÆ∂Êó∂Âà∑Êñ∞
                            if (!summary) return;
                            if (!currentDrawerCountry || String(currentDrawerCountry.code || '').toUpperCase() !== cc) return;
                            // ÂÖ≥ÈîÆ‰øùÊä§ÔºöËã•ÂΩìÂâçÂ§Ñ‰∫éÂõΩÂÆ∂ÈÄèËßÜÔºàCOUNTRYÔºâÊ®°ÂºèÔºå‰∏çÂÖÅËÆ∏ËøôÊù°‚ÄúÂÖ®ÁêÉÊµÅÈù¢Êùø‚ÄùÁöÑÂà∑Êñ∞Ë¶ÜÁõñÂè≥ÊäΩÂ±â
                            // Âê¶Âàô‰ºöÂá∫Áé∞‚ÄúÁæéÂå∫ÁªüËÆ°Èó™‰∏Ä‰∏ãÂèàË¢´ÂàáÂõûÂÖ®ÁêÉ‚ÄùÁöÑÁé∞Ë±°
                            if (typeof currentViewState === 'string' && currentViewState === 'COUNTRY') return;
                            showDrawersWithCountryData(cc, countryName, summary);
                        })
                        .catch(() => {});
                }
            } catch (e) {
                // ignore
            }

            // ÂÆö‰πâÁª¥Â∫¶ÈÖçÁΩÆ
            const dimensionConfig = {
                ai: { name: 'ÂØπËØùAIÊ¨°Êï∞', icon: 'üí¨', suffix: 'Ê¨°' },
                word: { name: 'Âπ≥ÂùáÈïøÂ∫¶', icon: 'üìè', suffix: 'Â≠ó/Êù°' },
                day: { name: '‰∏äÂ≤óÂ§©Êï∞', icon: 'üìÖ', suffix: 'Â§©' },
                no: { name: 'Áî≤Êñπ‰∏äË∫´', icon: 'üö´', suffix: 'Ê¨°' },
                say: { name: 'Â∫üËØùËæìÂá∫', icon: 'üí≠', suffix: 'Â≠ó' },
                please: { name: 'ËµõÂçöÁ£ïÂ§¥', icon: 'üôè', suffix: 'Ê¨°' }
            };

            // ÂÆö‰πâÂ∑¶Âè≥ÊäΩÂ±âÁöÑÁª¥Â∫¶ÂàÜÈÖç
            // Â∑¶ËæπÊäΩÂ±âÔºöuser_identity_config Âç°Áâá
            // Âè≥ËæπÊäΩÂ±âÔºöÊâÄÊúâÁª¥Â∫¶Âç°ÁâáÔºàai, word, day, no, say, pleaseÔºâ
            const leftDrawerDimensions = []; // Â∑¶ËæπÂè™ÊòæÁ§∫ user_identity_config
            const rightDrawerDimensions = ['ai', 'word', 'day', 'no', 'say', 'please']; // ÊâÄÊúâÁª¥Â∫¶Âç°Áâá

            // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑Êï∞ÊçÆÔºàÁî®‰∫éÂà§Êñ≠ÊòØÂê¶‰∏∫ÂÖ®ÁêÉÊúÄÂº∫Ê®°ÂºèÔºâ
            // Â∞ùËØï‰ªéÂ§ö‰∏™Êù•Ê∫êËé∑ÂèñÁî®Êà∑Êï∞ÊçÆÔºà‰∏é window.onload ÈÄªËæë‰∏ÄËá¥Ôºâ
            let currentUser = null;
            try {
                // ÊñπÊ≥ï1: ‰ªéÂÖ®Â±ÄÂèòÈáèËé∑Âèñ
                if (window.currentUser) {
                    currentUser = window.currentUser;
                    console.log('[Drawer] ‚úÖ ‰ªéÂÖ®Â±ÄÂèòÈáèËé∑ÂèñÂà∞Áî®Êà∑Êï∞ÊçÆ:', currentUser.user_name || currentUser.name);
                } else {
                    // ÊñπÊ≥ï2: ‰ªé localStorage Âíå URL ÂèÇÊï∞Ëé∑ÂèñÔºå‰∏é renderRankCards ÈÄªËæë‰∏ÄËá¥
                    // ËæÖÂä©ÂáΩÊï∞ÔºöËßÑËåÉÂåñÊåáÁ∫πÂ≠óÁ¨¶‰∏≤ÔºàÂøΩÁï•Â§ßÂ∞èÂÜôÂπ∂ÂâîÈô§È¶ñÂ∞æÁ©∫Ê†ºÔºâ
                    const normalizeFingerprint = (fp) => {
                        if (!fp) return '';
                        return String(fp).trim().toLowerCase();
                    };
                    
                    let localGitHubName = null;
                    let currentFingerprint = null;
                    try {
                        localGitHubName = localStorage.getItem('github_username');
                        currentFingerprint = localStorage.getItem('user_fingerprint');
                        console.log('[Drawer] üîç ‰ªé localStorage ËØªÂèñ:', {
                            hasFingerprint: !!currentFingerprint,
                            fingerprintPrefix: currentFingerprint ? currentFingerprint.substring(0, 8) : null,
                            hasGitHub: !!localGitHubName
                        });
                    } catch (e) {
                        console.warn('[Drawer] ‚ö†Ô∏è ËØªÂèñ localStorage Â§±Ë¥•:', e);
                    }
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlFingerprint = urlParams.get('fingerprint');
                    const urlGitHubName = urlParams.get('github');
                    
                    // ËßÑËåÉÂåñÂΩìÂâçÊåáÁ∫π
                    const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                    const normalizedUrlFingerprint = normalizeFingerprint(urlFingerprint);
                    
                    // Êü•ÊâæÂåπÈÖçÁöÑÁî®Êà∑Êï∞ÊçÆÔºà‰ºòÂÖàÁ∫ßÔºöÊåáÁ∫π‰ºòÂÖà > GitHub IDÔºâ
                    let allData = window.allData || [];
                    console.log('[Drawer] üìä allData Êï∞ÊçÆÈáè:', allData.length);
                    
                    // Â¶ÇÊûú allData ‰∏∫Á©∫ÊàñÂæàÂ∞ëÔºåÂ∞ùËØïÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
                    if (allData.length === 0 && normalizedCurrentFingerprint) {
                        console.log('[Drawer] ‚ö†Ô∏è allData ‰∏∫Á©∫ÔºåÂ∞ùËØïÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ...');
                        // ÂºÇÊ≠•ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆÔºà‰∏çÈòªÂ°ûÊäΩÂ±âÊòæÁ§∫Ôºâ
                        fetchData().then(() => {
                            allData = window.allData || [];
                            console.log('[Drawer] ‚úÖ ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆÂÆåÊàêÔºåallData Êï∞ÊçÆÈáè:', allData.length);
                            
                            // ÈáçÊñ∞Â∞ùËØïÂåπÈÖçÁî®Êà∑
                            const matchedUser = allData.find(item => {
                                const itemFingerprint = normalizeFingerprint(item.fingerprint || item.user_fingerprint);
                                const itemIdentity = normalizeFingerprint(item.user_identity);
                                return (itemFingerprint && itemFingerprint === normalizedCurrentFingerprint) ||
                                       (itemIdentity && itemIdentity === normalizedCurrentFingerprint);
                            });
                            
                            if (matchedUser) {
                                console.log('[Drawer] ‚úÖ ÈáçÊñ∞ÂåπÈÖçÂà∞Áî®Êà∑:', matchedUser.user_name || matchedUser.name);
                                // Êõ¥Êñ∞ÂÖ®Â±ÄÂèòÈáè
                                window.currentUser = matchedUser;
                                // ÈáçÊñ∞Ê∏≤ÊüìÁªüËÆ°Âç°Áâá
                                const leftBody = document.getElementById('left-drawer-body');
                                if (leftBody) {
                                    renderUserStatsCards(leftBody, matchedUser);
                                }
                            }
                        }).catch(err => {
                            console.error('[Drawer] ‚ùå ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•:', err);
                        });
                    }

                    // ‚úÖ GitHub ÂÖúÂ∫ïÔºöÂ¶ÇÊûú allData ‰∏∫Á©∫‰ΩÜÊú¨Êú∫Êúâ GitHub IDÔºå‰πüÂ∫îÂ∞ùËØï fetchData() ÂÜçÂåπÈÖç
                    if (allData.length === 0 && !currentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                        console.log('[Drawer] ‚ö†Ô∏è allData ‰∏∫Á©∫ÔºàGitHub Áî®Êà∑ÔºâÔºåÂ∞ùËØïÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ...');
                        fetchData().then(() => {
                            allData = window.allData || [];
                            console.log('[Drawer] ‚úÖ ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆÂÆåÊàêÔºàGitHub ÂÖúÂ∫ïÔºâÔºåallData Êï∞ÊçÆÈáè:', allData.length);

                            const normalizedLocalGitHub = normalizeFingerprint(localGitHubName);
                            const normalizedUrlGitHub = normalizeFingerprint(urlGitHubName);
                            const matchedUser = allData.find(item => {
                                const itemGitHub = normalizeFingerprint(item.github_username || item.github_id || item.user_name || item.name);
                                return itemGitHub && (itemGitHub === normalizedLocalGitHub || itemGitHub === normalizedUrlGitHub);
                            });

                            if (matchedUser) {
                                console.log('[Drawer] ‚úÖ ÈáçÊñ∞ÂåπÈÖçÂà∞ GitHub Áî®Êà∑:', matchedUser.user_name || matchedUser.name);
                                window.currentUser = matchedUser;
                                const leftBody = document.getElementById('left-drawer-body');
                                if (leftBody) {
                                    renderUserStatsCards(leftBody, getBestUserRecordForStats(matchedUser));
                                }
                                return;
                            }

                            // ‰∫åÁ∫ßÂÖúÂ∫ïÔºöÁõ¥Êé•‰ªé Supabase Êü•ËØ¢ GitHub Áî®Êà∑ÔºàÈÅøÂÖç‰∏çÂú® latestRecords Êó∂‰∏ÄÁõ¥ WAITÔºâ
                            try {
                                if (typeof supabaseClient !== 'undefined' && supabaseClient && typeof supabaseClient.from === 'function') {
                                    supabaseClient
                                        .from('v_unified_analysis_v2')
                                        .select('*')
                                        // GitHub Áî®Êà∑ÂêçÂ§ßÂ∞èÂÜô‰∏çÊïèÊÑüÔºöÈÅøÂÖç user_name Â§ßÂ∞èÂÜô‰∏ç‰∏ÄËá¥ÂØºËá¥Êü•‰∏çÂà∞
                                        .ilike('user_name', String(localGitHubName).trim())
                                        .maybeSingle()
                                        .then(({ data: dbUser }) => {
                                            if (!dbUser) return;
                                            console.log('[Drawer] ‚úÖ Supabase ÂÖúÂ∫ïÊâæÂà∞ GitHub Áî®Êà∑:', dbUser.user_name || dbUser.name);
                                            window.currentUser = dbUser;
                                            const leftBody2 = document.getElementById('left-drawer-body');
                                            if (leftBody2) {
                                                renderUserStatsCards(leftBody2, getBestUserRecordForStats(dbUser));
                                            }
                                        })
                                        .catch(() => {});
                                }
                            } catch (e) { /* ignore */ }
                        }).catch(err => {
                            console.error('[Drawer] ‚ùå ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•ÔºàGitHub ÂÖúÂ∫ïÔºâ:', err);
                        });
                    }
                    
                    // ‰ºòÂÖàÈÄöËøáÊåáÁ∫πÂåπÈÖç
                    if (normalizedCurrentFingerprint || normalizedUrlFingerprint) {
                        console.log('[Drawer] üîç ÂºÄÂßãÊåáÁ∫πÂåπÈÖçÔºåÁõÆÊ†áÊåáÁ∫π:', normalizedCurrentFingerprint || normalizedUrlFingerprint);
                        currentUser = allData.find(item => {
                            const itemFingerprint = normalizeFingerprint(item.fingerprint || item.user_fingerprint);
                            const itemIdentity = normalizeFingerprint(item.user_identity);
                            
                            const matchFingerprint = itemFingerprint && (itemFingerprint === normalizedCurrentFingerprint || itemFingerprint === normalizedUrlFingerprint);
                            const matchIdentity = itemIdentity && (itemIdentity === normalizedCurrentFingerprint || itemIdentity === normalizedUrlFingerprint);
                            
                            if (matchFingerprint || matchIdentity) {
                                console.log('[Drawer] ‚úÖ ÊåáÁ∫πÂåπÈÖçÊàêÂäü:', {
                                    itemFingerprint: itemFingerprint ? itemFingerprint.substring(0, 8) : null,
                                    itemIdentity: itemIdentity ? itemIdentity.substring(0, 8) : null,
                                    userName: item.user_name || item.name
                                });
                            }
                            
                            return matchFingerprint || matchIdentity;
                        });
                        
                        if (!currentUser) {
                            console.log('[Drawer] ‚ö†Ô∏è ÊåáÁ∫πÂåπÈÖçÂ§±Ë¥•ÔºåallData ‰∏≠ÁöÑÊåáÁ∫πÊ†∑Êú¨:', 
                                allData.slice(0, 3).map(item => ({
                                    fingerprint: item.fingerprint ? item.fingerprint.substring(0, 8) : null,
                                    user_identity: item.user_identity ? item.user_identity.substring(0, 8) : null,
                                    user_name: item.user_name || item.name
                                }))
                            );
                        }
                    }
                    
                    // Â¶ÇÊûúÊåáÁ∫πÊú™ÂåπÈÖçÔºåÂÜçÈÄÄËÄåÊ±ÇÂÖ∂Ê¨°ÂØªÊâæ github_username
                    if (!currentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                        console.log('[Drawer] üîç ÂºÄÂßã GitHub ID ÂåπÈÖç:', localGitHubName);
                        const normalizedLocalGitHub = normalizeFingerprint(localGitHubName);
                        const normalizedUrlGitHub = normalizeFingerprint(urlGitHubName);
                        
                        currentUser = allData.find(item => {
                            const itemGitHub = normalizeFingerprint(item.github_username || item.user_name || item.name);
                            return itemGitHub && (itemGitHub === normalizedLocalGitHub || itemGitHub === normalizedUrlGitHub);
                        });
                        
                        if (currentUser) {
                            console.log('[Drawer] ‚úÖ ÈÄöËøá GitHub ID ÊâæÂà∞Áî®Êà∑:', currentUser.user_name || currentUser.name);
                        }
                    }

                    // ‚úÖ ÊúÄÁªàÂÖúÂ∫ïÔºöallData ÈáåÊ≤°Êúâ‰ΩÜÊú¨Êú∫Êúâ GitHub ID Êó∂ÔºåÁõ¥Êé•Êü•Áªü‰∏ÄËßÜÂõæ
                    if (!currentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                        try {
                            if (typeof supabaseClient !== 'undefined' && supabaseClient && typeof supabaseClient.from === 'function') {
                                supabaseClient
                                    .from('v_unified_analysis_v2')
                                    .select('*')
                                    // GitHub Áî®Êà∑ÂêçÂ§ßÂ∞èÂÜô‰∏çÊïèÊÑüÔºöÈÅøÂÖç user_name Â§ßÂ∞èÂÜô‰∏ç‰∏ÄËá¥ÂØºËá¥Êü•‰∏çÂà∞
                                    .ilike('user_name', String(localGitHubName).trim())
                                    .maybeSingle()
                                    .then(({ data: dbUser }) => {
                                        if (!dbUser) return;
                                        console.log('[Drawer] ‚úÖ Supabase ÊúÄÁªàÂÖúÂ∫ïÊâæÂà∞ GitHub Áî®Êà∑:', dbUser.user_name || dbUser.name);
                                        window.currentUser = dbUser;
                                        const leftBody = document.getElementById('left-drawer-body');
                                        if (leftBody) {
                                            renderUserStatsCards(leftBody, getBestUserRecordForStats(dbUser));
                                        }
                                    })
                                    .catch(() => {});
                            }
                        } catch (e) { /* ignore */ }
                    }
                }
            } catch (e) {
                console.error('[Drawer] ‚ùå Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:', e);
            }
            
            const isGlobalTopMode = !currentUser;
            const userData = currentUser;
            
            if (!currentUser) {
                console.log('[Drawer] ‚ö†Ô∏è Êú™ÊâæÂà∞ÂΩìÂâçÁî®Êà∑Êï∞ÊçÆÔºåÂ∞ÜÊòæÁ§∫ÂÖ®ÁêÉÊúÄÂº∫Ê®°Âºè');
            } else {
                console.log('[Drawer] ‚úÖ ÊâæÂà∞ÂΩìÂâçÁî®Êà∑Êï∞ÊçÆÔºåÂ∞ÜÊòæÁ§∫‰∏™‰∫∫ÁªüËÆ°:', userData.user_name || userData.name);
            }

            // Â°´ÂÖÖÂ∑¶‰æßÊäΩÂ±â - user_identity_config Âç°Áâá
            if (leftBody) {
                // Ëé∑Âèñ GitHub Áî®Êà∑ÂêçÂíåÊåáÁ∫πÔºàÂ¢ûÂä†ÂºÇÂ∏∏Â§ÑÁêÜÔºâ
                let githubUsername = '';
                let currentFingerprint = null;
                try {
                    githubUsername = localStorage.getItem('github_username') || '';
                    currentFingerprint = localStorage.getItem('user_fingerprint');
                } catch (e) {
                    console.warn('[Drawer] ‚ö†Ô∏è ËØªÂèñ localStorage Â§±Ë¥•:', e);
                }
                
                // Âà§Êñ≠ÊòØÂê¶‰∏∫Á∫ØÊåáÁ∫πÁî®Êà∑ÔºàÊó† GitHub IDÔºâ
                // „ÄêTask 3„Äë‰º†ÂÖ• user_identity ÂèÇÊï∞ÔºåÂØπ fingerprint Áî®Êà∑Ë∑≥Ëøá‰∏•Ê†ºÊ†°È™å
                const userIdentity = currentUser?.user_identity || null;
                const isFingerprintOnlyUser = !githubUsername || !isValidGitHubUsername(githubUsername, userIdentity);
                const fingerprintPrefix = currentFingerprint ? currentFingerprint.substring(0, 6).toUpperCase() : '';
                
                // Á°ÆÂÆöÊòæÁ§∫ÁöÑÁî®Êà∑ÂêçÂíåÂ§¥ÂÉè
                let displayName = '';
                let displayLabel = '';
                let avatarUrl = DEFAULT_AVATAR;
                
                if (isFingerprintOnlyUser && currentFingerprint) {
                    // Á∫ØÊåáÁ∫πÁî®Êà∑ÔºöÊòæÁ§∫"ÂåøÂêç‰∏ìÂÆ∂ [ÊåáÁ∫πÂâç6‰Ωç]"
                    displayName = `ÂåøÂêç‰∏ìÂÆ∂ ${fingerprintPrefix}`;
                    displayLabel = 'ËÆæÂ§áÊåáÁ∫π';
                    // ‰ΩøÁî®Âü∫‰∫éÊåáÁ∫πÁöÑ Identicon
                    avatarUrl = `https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(currentFingerprint)}`;
                } else if (githubUsername && isValidGitHubUsername(githubUsername, userIdentity)) {
                    // Êúâ GitHub ID ÁöÑÁî®Êà∑
                    displayName = githubUsername;
                    displayLabel = 'GitHub ID';
                    avatarUrl = getGitHubAvatarUrl(githubUsername);
                } else {
                    // ÈªòËÆ§Áä∂ÊÄÅ
                    displayName = 'Êú™ËÆæÁΩÆ';
                    displayLabel = 'GitHub ID';
                    avatarUrl = DEFAULT_AVATAR;
                }

                // Â∑¶‰æßÊäΩÂ±âÊ†áÈ¢òÔºöÂßãÁªàÊòæÁ§∫‚ÄúÂΩìÂâçÁî®Êà∑‚ÄùÔºåÈÅøÂÖçÂú∞ÂõæÁÇπÂáªÂêéÂ∑¶‰æßÁúãËµ∑Êù•ÂÉè‰∏¢‰∫Ü‰∏™‰∫∫Êï∞ÊçÆ
                try {
                    if (leftTitle) leftTitle.textContent = displayName || 'ÊàëÁöÑÊï∞ÊçÆ';
                } catch (e) { /* ignore */ }
                
                // Ëé∑ÂèñÂΩìÂâçÁä∂ÊÄÅ
                const currentStatus = localStorage.getItem('user_status') || 'idle';
                const statusConfig = USER_STATUSES[currentStatus] || USER_STATUSES.idle;
                
                // ÂàõÂª∫ user_identity_config Âç°Áâá
                const identityCard = document.createElement('div');
                identityCard.className = 'drawer-item';
                identityCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">üï∂Ô∏è</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                            CONFIG
                        </span>
                    </div>
                    
                    <div class="drawer-item-label mb-2">Áî®Êà∑Ë∫´‰ªΩÈÖçÁΩÆ</div>
                    
                    <!-- Áî®Êà∑‰ø°ÊÅØÔºàGitHub ÊàñÊåáÁ∫πÔºâ -->
                    <div class="mb-3 pb-3 border-b border-[#00ff41]/10">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 rounded-full overflow-hidden border border-[#00ff41]/30 flex-shrink-0">
                                <img 
                                    src="${avatarUrl}" 
                                    alt="Avatar" 
                                    class="w-full h-full object-cover"
                                    onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                />
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="drawer-item-value text-sm truncate">${displayName}</div>
                                <div class="drawer-item-desc text-[8px]">${displayLabel}</div>
                            </div>
                        </div>
                        <!-- Áî®Êà∑ÂõΩÂÆ∂/Âú∞Âå∫ÔºöÂõΩÊóó + Ëá™Âä®ËØÜÂà´ / Áî®Êà∑Ê†°ÂáÜ -->
                        <div id="user-country-flag" class="flex items-center gap-2 mt-2 text-[10px]"></div>
                    </div>
                    
                    <!-- Áä∂ÊÄÅ‰ø°ÊÅØ -->
                    <div class="mb-2">
                        <div class="drawer-item-label mb-1">ÂΩìÂâçÁä∂ÊÄÅ</div>
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${statusConfig.emoji}</span>
                            <div>
                                <div class="drawer-item-value text-sm" style="color: ${statusConfig.color}">${statusConfig.label}</div>
                                <div class="drawer-item-desc text-[8px]">${currentLang === 'zh' ? 'Â∑•‰ΩúÁä∂ÊÄÅ' : 'Status'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Áä∂ÊÄÅÂàáÊç¢ÊåâÈíÆ -->
                    <div class="flex gap-1.5 mt-3 pt-3 border-t border-[#00ff41]/10">
                        <button 
                            onclick="setUserStatus('idle'); if(currentDrawerCountry.code) showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);"
                            class="flex-1 px-2 py-1.5 bg-zinc-900/50 border ${currentStatus === 'idle' ? 'border-[#00ff41]' : 'border-zinc-800'} text-[10px] font-bold uppercase tracking-wider hover:border-[#00ff41] transition-colors"
                            style="color: ${currentStatus === 'idle' ? '#00ff41' : '#71717a'};"
                        >
                            üü¢ ÊûÅÈÄü
                        </button>
                        <button 
                            onclick="setUserStatus('busy'); if(currentDrawerCountry.code) showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);"
                            class="flex-1 px-2 py-1.5 bg-zinc-900/50 border ${currentStatus === 'busy' ? 'border-[#ff8c00]' : 'border-zinc-800'} text-[10px] font-bold uppercase tracking-wider hover:border-[#ff8c00] transition-colors"
                            style="color: ${currentStatus === 'busy' ? '#ff8c00' : '#71717a'};"
                        >
                            üü† ÂøôÁ¢å
                        </button>
                        <button 
                            onclick="setUserStatus('sprint'); if(currentDrawerCountry.code) showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);"
                            class="flex-1 px-2 py-1.5 bg-zinc-900/50 border ${currentStatus === 'sprint' ? 'border-[#ff006e]' : 'border-zinc-800'} text-[10px] font-bold uppercase tracking-wider hover:border-[#ff006e] transition-colors"
                            style="color: ${currentStatus === 'sprint' ? '#ff006e' : '#71717a'};"
                        >
                            üöÄ ÂÜ≤Âà∫
                        </button>
                    </div>
                    
                    <!-- GitHub OAuth ÁôªÂΩïÂå∫Âüü -->
                    <div class="mt-3 pt-3 border-t border-[#00ff41]/10" id="auth-login-section">
                        ${githubUsername && isValidGitHubUsername(githubUsername, userIdentity) 
                            ? `
                            <!-- Â∑≤ÁôªÂΩïÁä∂ÊÄÅÔºöÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØÂíåÈÄÄÂá∫ÊåâÈíÆ -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <img 
                                        src="${getGitHubAvatarUrl(githubUsername)}" 
                                        alt="${githubUsername}"
                                        class="w-6 h-6 rounded-full border border-[#00ff41]/30"
                                        onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                    />
                                    <div>
                                        <div class="text-[10px] text-white font-bold">${githubUsername}</div>
                                        <a 
                                            href="https://github.com/${githubUsername}" 
                                            target="_blank"
                                            class="text-[8px] text-[#00ff41]/60 hover:text-[#00ff41] transition-colors"
                                        >
                                            Êü•Áúã GitHub
                                        </a>
                                    </div>
                                </div>
                                <button 
                                    onclick="logout()"
                                    class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-[8px] text-zinc-400 hover:text-white transition-colors rounded"
                                >
                                    ÈÄÄÂá∫
                                </button>
                            </div>
                            `
                            : `
                            <!-- Êú™ÁôªÂΩïÁä∂ÊÄÅÔºöÊòæÁ§∫ GitHub ÁôªÂΩïÊåâÈíÆ -->
                            <div class="drawer-item-label mb-2">GitHub ÁôªÂΩï</div>
                            <button 
                                onclick="loginWithGitHub()"
                                class="w-full px-4 py-3 bg-[#24292e] hover:bg-[#2f363d] border border-[#444d56] rounded-md text-white text-sm font-semibold flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl"
                            >
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path>
                                </svg>
                                <span>‰ΩøÁî® GitHub ÁôªÂΩï</span>
                            </button>
                            <div class="text-[8px] text-[#00ff41]/40 mt-2 text-center">
                                ÂÆâÂÖ®„ÄÅÂø´ÈÄü„ÄÅ‰∏ÄÈîÆÁôªÂΩï
                            </div>
                            `
                        }
                    </div>
                `;
                
                leftBody.appendChild(identityCard);

                // Â°´ÂÖÖÁî®Êà∑ÂõΩÂÆ∂/Âú∞Âå∫Ôºö‰ΩøÁî® v_unified_analysis_v2 ÁöÑ country_codeÔºåËΩ¨ÂõΩÊóó Emoji
                if (typeof updateUserCountryFlag === 'function' && currentUser) {
                    const countryCode = currentUser.country_code || currentUser.manual_location || currentUser.ip_location || '';
                    const countryName = (countryNameMap[countryCode] ? countryNameMap[countryCode].en : countryCode) || '';
                    const isManual = !!(currentUser.manual_location || currentUser.manual_lat != null);
                    updateUserCountryFlag(countryCode, countryName, isManual);
                }

                // Ê∑ªÂä†ÂÆûÊó∂ËØäÊñ≠Ê¥ªÂä®Âç°Áâá
                const activityCard = document.createElement('div');
                activityCard.className = 'drawer-item';
                activityCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">üì°</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                            LIVE
                        </span>
                    </div>
                    <div class="drawer-item-label mb-3">ÂÆûÊó∂ËØäÊñ≠Ê¥ªÂä®</div>
                    <div id="drawer-recentActivity" class="flex-1 overflow-y-auto max-h-[400px] text-[10px] font-mono space-y-3 pr-2"></div>
                `;
                leftBody.appendChild(activityCard);
                
                // Ê∏≤ÊüìÂÆûÊó∂ËØäÊñ≠Ê¥ªÂä®
                const data = window.lastData || {};
                const activityData = data.latestRecords || data.recentVictims || [];
                const drawerActivityList = document.getElementById('drawer-recentActivity');
                if (drawerActivityList) {
                    if (activityData.length === 0) {
                        drawerActivityList.innerHTML = '<div class="text-zinc-500 text-center py-4 text-[10px]">ÊöÇÊó†Êï∞ÊçÆ</div>';
                    } else {
                        drawerActivityList.innerHTML = activityData.map((v, index) => {
                            const time = v.time || v.created_at || new Date().toISOString();
                            const type = v.type || v.personality_type || 'UNKNOWN';
                            const location = v.location || v.ip_location || 'Êú™Áü•';
                            const name = v.name || `ËÆ∞ÂΩï${index + 1}`;
                            
                            const avatarUrl = v.avatar_url || null;
                            const githubUsername = v.github_username || null;
                            
                            // „Äê‰øÆÂ§ç„ÄëÂ∞Ü recordUserIdentity ÂÆö‰πâÁßªÂà∞ if ÂùóÂ§ñÔºåÁ°Æ‰øùÂú®ÊâÄÊúâÊÉÖÂÜµ‰∏ãÈÉΩËÉΩËÆøÈóÆ
                            const recordUserIdentity = v.user_identity || null;
                            
                            let finalAvatarUrl = avatarUrl;
                            if (!finalAvatarUrl && githubUsername) {
                                // „ÄêTask 3„Äë‰º†ÂÖ• user_identityÔºåÂØπ fingerprint Áî®Êà∑Ë∑≥Ëøá‰∏•Ê†ºÊ†°È™å
                                if (isValidGitHubUsername(githubUsername, recordUserIdentity)) {
                                    finalAvatarUrl = getGitHubAvatarUrl(githubUsername);
                                } else {
                                    finalAvatarUrl = DEFAULT_AVATAR;
                                }
                            }
                            if (!finalAvatarUrl) {
                                finalAvatarUrl = DEFAULT_AVATAR;
                            }
                            
                            const finalUsername = githubUsername || name;
                            // „Äê‰øÆÂ§ç„Äë‰º†ÂÖ• user_identityÔºåÂØπ fingerprint Áî®Êà∑Ë∑≥Ëøá‰∏•Ê†ºÊ†°È™å
                            // Âè™‰º†ÊúâÊïàÁöÑ GitHub Áî®Êà∑ÂêçÔºåÈÅøÂÖç"ËÆ∞ÂΩï1"ËøôÊ†∑ÁöÑÂÄºËß¶ÂèëÊ†°È™åË≠¶Âëä
                            const usernameForAvatar = githubUsername && isValidGitHubUsername(githubUsername, recordUserIdentity) 
                                ? githubUsername 
                                : null;
                            const avatarHtml = createAvatarHtml(finalAvatarUrl, usernameForAvatar, 24, recordUserIdentity);
                            
                            return `
                                <div class="border-l-2 border-[#00ff41]/20 pl-2 py-1.5 flex items-start gap-2">
                                    <div class="flex-shrink-0 mt-0.5">
                                        ${avatarHtml}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-zinc-500 text-[9px]">${new Date(time).toLocaleTimeString()}</div>
                                        <div class="text-white text-[10px] font-bold">${name.length > 8 ? name.slice(0,8) + '...' : name}</div>
                                        <div class="text-[#00ff41] text-[9px]">${type} @ ${location}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
                // Â¶ÇÊûúÊ£ÄÊµãÂà∞ÂΩìÂâçÁî®Êà∑Êï∞ÊçÆÔºåËá™Âä®Âä†ËΩΩÁî®Êà∑ÁªüËÆ°Âç°ÁâáÔºà‰ºòÂÖà‰ΩøÁî® allData ‰∏≠Âêå‰∫∫ÁöÑÂÆåÊï¥ËÆ∞ÂΩïÔºå‰ª•ÊòæÁ§∫Êèê‰∫§ËÅäÂ§©ËÆ∞ÂΩïÂØπÂ∫îÁöÑÊï∞ÂÄºÔºâ
                if (currentUser) {
                    const userForStats = getBestUserRecordForStats(currentUser);
                    console.log('[Drawer] üìä ÂºÄÂßãÊ∏≤ÊüìÁî®Êà∑ÁªüËÆ°Âç°ÁâáÔºå‰ΩøÁî®', userForStats !== currentUser ? 'allData ‰∏≠ÁöÑÂÆåÊï¥ËÆ∞ÂΩï' : 'ÂΩìÂâçÁî®Êà∑ËÆ∞ÂΩï');
                    renderUserStatsCards(leftBody, userForStats);
                } else {
                    console.log('[Drawer] ‚ö†Ô∏è Êú™ÊâæÂà∞Áî®Êà∑Êï∞ÊçÆÔºåË∑≥ËøáÁªüËÆ°Âç°ÁâáÊ∏≤Êüì');
                    // Âç≥‰ΩøÊ≤°ÊúâÂåπÈÖçÂà∞Áî®Êà∑ÔºåÂ¶ÇÊûú localStorage ‰∏≠Êúâ fingerprintÔºå‰πüÊòæÁ§∫‰∏Ä‰∏™ÊèêÁ§∫
                    try {
                        const currentFingerprint = localStorage.getItem('user_fingerprint');
                        if (currentFingerprint) {
                            const waitingCard = document.createElement('div');
                            waitingCard.className = 'drawer-item';
                            waitingCard.innerHTML = `
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">‚è≥</span>
                                    <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                                        WAIT
                                    </span>
                                </div>
                                <div class="drawer-item-label mb-2">Êï∞ÊçÆÂä†ËΩΩ‰∏≠</div>
                                <div class="text-[10px] text-[#00ff41]/60">
                                    ÊÇ®ÁöÑÊï∞ÊçÆÊ≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂÄô...
                                </div>
                                <div class="text-[8px] text-[#00ff41]/40 mt-2">
                                    ÊåáÁ∫π: ${currentFingerprint.substring(0, 8)}...
                                </div>
                            `;
                            leftBody.appendChild(waitingCard);
                        }
                    } catch (e) {
                        console.warn('[Drawer] ‚ö†Ô∏è ÊòæÁ§∫Á≠âÂæÖÂç°ÁâáÂ§±Ë¥•:', e);
                    }
                }
            }

            // Â°´ÂÖÖÂè≥‰æßÊäΩÂ±â - Áª¥Â∫¶Âç°ÁâáÂíåÁªüËÆ°Âç°Áâá
            if (rightBody) {
                // ÂÖàÊ∑ªÂä†Áª¥Â∫¶Âç°Áâá
                if (RANK_RESOURCES) {
                    rightDrawerDimensions.forEach((dimId) => {
                        const config = dimensionConfig[dimId];
                        if (!config) return;

                        // Ëé∑ÂèñÁª¥Â∫¶Êï∞ÊçÆ
                        let targetData = null;
                        let maxValue = 0;
                        let targetUserName = '';
                        let targetIpLocation = null;

                        if (isGlobalTopMode) {
                            const allData = window.allData || [];
                            if (allData.length > 0) {
                                targetData = allData.reduce((maxUser, currentUser) => {
                                    const currentValues = extractDimensionValues(currentUser);
                                    const maxValues = extractDimensionValues(maxUser);
                                    const currentValue = currentValues[dimId] || 0;
                                    const maxValue = maxValues[dimId] || 0;
                                    return currentValue > maxValue ? currentUser : maxUser;
                                }, allData[0]);
                                
                                const targetValues = extractDimensionValues(targetData);
                                maxValue = targetValues[dimId] || 0;
                                targetUserName = targetData.user_name || targetData.name || targetData.github_username || 'Êú™Áü•Áî®Êà∑';
                                targetIpLocation = targetData.ip_location || null;
                            } else {
                                maxValue = 0;
                                targetUserName = 'ÊöÇÊó†Êï∞ÊçÆ';
                                targetIpLocation = null;
                            }
                        } else {
                            targetData = userData;
                            const values = extractDimensionValues(userData);
                            maxValue = values[dimId] || 0;
                            targetUserName = userData.user_name || userData.name || userData.github_username || 'ÊàëÁöÑÊï∞ÊçÆ';
                            targetIpLocation = userData.ip_location || null;
                        }

                        const feedback = getRankFeedback(dimId, maxValue);
                        const card = createDimensionCard(dimId, config, maxValue, targetUserName, targetIpLocation, feedback, isGlobalTopMode);
                        rightBody.appendChild(card);
                    });
                }

                // Ê∑ªÂä†ÁªüËÆ°Âç°ÁâáÔºà‰ΩøÁî® rightDrawerDataÔºöÊ†°ÂáÜÂêéÂõΩÂÆ∂ÊëòË¶ÅÊàñÂÖ®Â±Ä lastDataÔºâ
                const data = rightDrawerData;
                
                // Â∑≤ËØäÊñ≠ÂºÄÂèëËÄÖ
                const totalUsersCard = document.createElement('div');
                totalUsersCard.className = 'drawer-item';
                const totalUsers = data.totalUsers !== undefined && data.totalUsers !== null ? Number(data.totalUsers) : undefined;
                totalUsersCard.innerHTML = `
                    <div class="drawer-item-label">Â∑≤ËØäÊñ≠ÂºÄÂèëËÄÖ</div>
                    <div class="drawer-item-value text-3xl">${totalUsers !== undefined ? new Intl.NumberFormat('zh-CN').format(totalUsers) : 'N/A'}</div>
                    <div class="drawer-item-desc">USERS_RECOGNIZED_SUCCESSFULLY</div>
                `;
                rightBody.appendChild(totalUsersCard);

                // ÂÖ®ÁΩëÊâ´ÊèèÊ¨°Êï∞
                const totalAnalysisCard = document.createElement('div');
                totalAnalysisCard.className = 'drawer-item';
                const totalAnalysis = data.totalAnalysis !== undefined && data.totalAnalysis !== null ? Number(data.totalAnalysis) : undefined;
                totalAnalysisCard.innerHTML = `
                    <div class="drawer-item-label">ÂÖ®ÁΩëÊâ´ÊèèÊ¨°Êï∞</div>
                    <div class="drawer-item-value text-3xl">${totalAnalysis !== undefined ? new Intl.NumberFormat('zh-CN').format(totalAnalysis) : 'N/A'}</div>
                    <div class="drawer-item-desc">TOTAL_SCAN_COUNT</div>
                `;
                rightBody.appendChild(totalAnalysisCard);

                // Á¥ØËÆ°ÂêêÊßΩÂ≠óÊï∞ÔºöÁªëÂÆöÂà∞ json.totalChars (276355)
                const totalCharsCard = document.createElement('div');
                totalCharsCard.className = 'drawer-item';
                const totalChars = data.totalChars !== undefined && data.totalChars !== null ? Number(data.totalChars) : (data.totalRoastWords !== undefined && data.totalRoastWords !== null ? Number(data.totalRoastWords) : undefined);
                totalCharsCard.innerHTML = `
                    <div class="drawer-item-label">Á¥ØËÆ°ÂêêÊßΩÂ≠óÊï∞</div>
                    <div class="drawer-item-value text-3xl">${totalChars !== undefined ? new Intl.NumberFormat('zh-CN').format(totalChars) : 'N/A'}</div>
                    <div class="drawer-item-desc">Á¥ØËÆ°ÊÄªÂ≠óÊï∞ÁªüËÆ°</div>
                `;
                rightBody.appendChild(totalCharsCard);

                // ‰∫∫ÂùáÂπ≥ÂùáÁØáÂπÖÂíåÂçïÊ¨°Âπ≥ÂùáÁØáÂπÖÔºàÂπ∂ÊéíÊòæÁ§∫Ôºâ
                const avgCard = document.createElement('div');
                avgCard.className = 'drawer-item';
                
                // ‰∫∫ÂùáÂπ≥ÂùáÁØáÂπÖÔºötotalChars / totalUsers
                let avgPerUser = data.avgPerUser !== undefined && data.avgPerUser !== null ? Number(data.avgPerUser) : undefined;
                if ((avgPerUser === undefined || avgPerUser === 0) && totalChars !== undefined && totalUsers !== undefined && totalUsers > 0) {
                    avgPerUser = Number(totalChars) / Number(totalUsers);
                }
                
                // ÂçïÊ¨°Âπ≥ÂùáÁØáÂπÖÔºötotalChars / totalAnalysis
                let avgPerScan = data.avgPerScan !== undefined && data.avgPerScan !== null ? Number(data.avgPerScan) : undefined;
                if ((avgPerScan === undefined || avgPerScan === 0) && totalChars !== undefined && data.totalAnalysis !== undefined && data.totalAnalysis !== null && data.totalAnalysis > 0) {
                    avgPerScan = Number(totalChars) / Number(data.totalAnalysis);
                }
                avgCard.innerHTML = `
                    <div class="drawer-item-label mb-2">Âπ≥ÂùáÁØáÂπÖÁªüËÆ°</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <div class="drawer-item-value text-xl">${avgPerUser !== undefined ? avgPerUser.toFixed(1) : 'N/A'}</div>
                            <div class="drawer-item-desc text-[8px]">‰∫∫ÂùáÂπ≥ÂùáÁØáÂπÖ</div>
                        </div>
                        <div>
                            <div class="drawer-item-value text-xl" style="color: #60a5fa;">${avgPerScan !== undefined ? avgPerScan.toFixed(1) : 'N/A'}</div>
                            <div class="drawer-item-desc text-[8px]">ÂçïÊ¨°Âπ≥ÂùáÁØáÂπÖ</div>
                        </div>
                    </div>
                `;
                rightBody.appendChild(avgCard);

                // ÂÖ®ÁΩëÂπ≥ÂùáÂºÄÂèëËÄÖÁîªÂÉèÔºàÈõ∑ËææÂõæÔºâ
                const radarCard = document.createElement('div');
                radarCard.className = 'drawer-item';
                const radarData = data.globalAverage || data.averages;
                radarCard.innerHTML = `
                    <div class="drawer-item-label mb-3">ÂÖ®ÁΩëÂπ≥ÂùáÂºÄÂèëËÄÖÁîªÂÉè</div>
                    <div class="aspect-square">
                        <canvas id="drawer-radarChart"></canvas>
                    </div>
                `;
                rightBody.appendChild(radarCard);
                
                // Ê∏≤ÊüìÈõ∑ËææÂõæ
                setTimeout(() => {
                    const drawerRadarCanvas = document.getElementById('drawer-radarChart');
                    if (drawerRadarCanvas && typeof Chart !== 'undefined' && radarData) {
                        const normalizedRadarData = {
                            L: radarData.L !== undefined && radarData.L !== null ? Number(radarData.L) : undefined,
                            P: radarData.P !== undefined && radarData.P !== null ? Number(radarData.P) : undefined,
                            D: radarData.D !== undefined && radarData.D !== null ? Number(radarData.D) : undefined,
                            E: radarData.E !== undefined && radarData.E !== null ? Number(radarData.E) : undefined,
                            F: radarData.F !== undefined && radarData.F !== null ? Number(radarData.F) : undefined,
                        };
                        renderRadarChartToCanvas(drawerRadarCanvas, normalizedRadarData);
                    }
                }, 100);

                // Âú∞ÁêÜ‰ΩçÁΩÆÁÉ≠ÂäõÊéíË°å
                const locationCard = document.createElement('div');
                locationCard.className = 'drawer-item';
                locationCard.innerHTML = `
                    <div class="drawer-item-label mb-3">Âú∞ÁêÜ‰ΩçÁΩÆÁÉ≠ÂäõÊéíË°å</div>
                    <div id="drawer-locationList" class="space-y-2"></div>
                `;
                rightBody.appendChild(locationCard);
                
                // Ê∏≤ÊüìÂú∞ÁêÜ‰ΩçÁΩÆÂàóË°®
                if (data.locationRank && Array.isArray(data.locationRank)) {
                    const drawerLocationList = document.getElementById('drawer-locationList');
                    if (drawerLocationList) {
                        drawerLocationList.innerHTML = data.locationRank.slice(0, 5).map((item, i) => {
                            const name = countryNameMap[item.name] ? countryNameMap[item.name][currentLang] : item.name;
                            return `
                                <div class="flex justify-between items-center text-[10px] border-b border-[#00ff41]/10 pb-2">
                                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                                    <span class="font-bold uppercase tracking-tighter text-white">${name}</span>
                                    <span class="text-[#00ff41] font-bold">${item.value}</span>
                                </div>`;
                        }).join('');
                    }
                }

                // ‰∫∫Ê†ºÂàÜÂ∏ÉÊéíË°å
                const personalityCard = document.createElement('div');
                personalityCard.className = 'drawer-item';
                personalityCard.innerHTML = `
                    <div class="drawer-item-label mb-3">‰∫∫Ê†ºÂàÜÂ∏ÉÊéíË°å</div>
                    <div id="drawer-personalityDistribution" class="space-y-2"></div>
                `;
                rightBody.appendChild(personalityCard);
                
                // Ê∏≤Êüì‰∫∫Ê†ºÂàÜÂ∏É
                if (data.personalityRank && Array.isArray(data.personalityRank)) {
                    const drawerPersonalityList = document.getElementById('drawer-personalityDistribution');
                    if (drawerPersonalityList) {
                        drawerPersonalityList.innerHTML = data.personalityRank.map((item, i) => {
                            const type = item.type || 'UNKNOWN';
                            const count = Number(item.count) || 0;
                            return `
                                <div class="flex justify-between items-center text-[10px] border-b border-[#00ff41]/10 pb-2">
                                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                                    <span class="font-bold uppercase tracking-tighter text-white">${type}</span>
                                    <span class="text-[#00ff41] font-bold">${count}</span>
                                </div>`;
                        }).join('');
                    }
                }
            }

            // ÊòæÁ§∫ÊäΩÂ±â
            leftDrawer.classList.add('active');
            rightDrawer.classList.add('active');
            console.log('[Drawer] ÊäΩÂ±âÂ∑≤ÊâìÂºÄ:', countryDisplayName);
        }

        /**
         * ÂàáÊç¢Âà∞„ÄåÂõΩÂÆ∂Êï∞ÊçÆÈÄèËßÜ„ÄçÊ®°ÂºèÔºàÂè≥‰æßÊäΩÂ±âÊòæÁ§∫ËØ•ÂõΩÈõ∑ËææÂõæ + ÊàòÁ•ûÊ¶úÔºâ
         * ÂÖàË∞ÉÁî® showDrawersWithCountryData Â°´ÂÖÖÂ∑¶‰æß‰∏™‰∫∫Êï∞ÊçÆÔºåÂÜçÊääÂè≥‰æßÂàá‰∏∫ÂõΩÂÆ∂ÈÄèËßÜ„ÄÇ
         * @param {string} code - ÂõΩÂÆ∂‰ª£Á†ÅÔºåÂ¶Ç 'US'
         * @param {string} name - ÂõΩÂÆ∂ÂêçÁß∞ÔºåÂ¶Ç 'United States'
         */
        function switchToCountryView(code, name) {
            showDrawersWithCountryData(code, name);
            currentViewState = 'COUNTRY';
            const rightDrawer = document.getElementById('right-drawer');
            const globalFlowPanel = document.getElementById('globalFlowPanel');
            const countryPanelEl = document.getElementById('countryPanel');
            if (!rightDrawer || !countryPanelEl) return;
            if (globalFlowPanel) globalFlowPanel.style.display = 'none';
            countryPanelEl.style.display = '';

            const leftTitle = document.getElementById('left-drawer-title');
            const rightTitle = document.getElementById('right-drawer-title');
            if (leftTitle) leftTitle.textContent = name;
            if (rightTitle) rightTitle.textContent = name;

            renderCountryRightPanel(code, name);
            // Ëß¶ÂèëÂõΩÂÆ∂ÊäΩÂ±âÊï∞ÊçÆÊãâÂèñÔºàÊåâÈúÄÊ±ÇÔºöupdateCountryDashboard(countryName)Ôºâ
            try { updateCountryDashboard(code); } catch (e) { /* ignore */ }

            selectedCountry = code === 'US' ? 'US' : code;
            currentDrawerCountry.code = code;
            currentDrawerCountry.name = name;
            console.log('[Drawer] ÂõΩÂÆ∂ÈÄèËßÜÂ∑≤ÊâìÂºÄ:', name);
        }

        // ============================
        // ÂõΩÂÆ∂ÈÄèËßÜÔºàright.html Ê®°ÊùøÊ∏≤ÊüìÔºåÊó†ÊâìÂ≠óÊú∫Ôºâ
        // ============================
        function clamp(n, min, max) {
            const x = Number(n);
            if (isNaN(x)) return min;
            return Math.max(min, Math.min(max, x));
        }

        function pct(n) {
            const x = clamp(n, 0, 100);
            return `${x.toFixed(1)}%`;
        }

        function renderCountryRightPanel(code, name) {
            const mount = document.getElementById('countryTemplateMount');
            const tpl = document.getElementById('rightDrawerTemplate');
            if (!mount || !tpl) return;

            mount.innerHTML = '';
            const node = tpl.content.cloneNode(true);
            mount.appendChild(node);

            // ÂÖàÊ∏≤ÊüìÂü∫Á°ÄÈ™®Êû∂Ôºà‰∏çÂÜçÁ°¨ÁºñÁ†ÅÁæéÂõΩÊï∞ÊçÆÔºõÊï∞ÊçÆÁî± updateCountryDashboard(countryName) ÊãâÂèñÔºâ
            const model = {
                coord: (code === 'US' || name === 'United States') ? 'COORD: 37.0902¬∞ N, 95.7129¬∞ W' : 'COORD: --',
                dataStatus: 'DATA: READY',
                flag: (code === 'US' || name === 'United States') ? 'üá∫üá∏' : (countryCodeToFlagEmoji(code) || 'üè≥Ô∏è'),
                nodeName: `${String(name || 'REGION').toUpperCase()}_NODE`,
                diagnosedTotal: '--',
                scanTotal: '--',
                pk: { leftLabel: 'Dominance', rightLabel: 'Kowtow', leftPct: 50, rightPct: 50, quote: '"Coming soon..."' },
                meltdown: { words: '-- WORDS', fillPct: 0, level: 'PENDING', victims: '--' },
                semantic: { tags: [], mostUsed: 'MOST_USED: --', freq: 'FREQ: --' },
                elite: [],
                ratio: []
            };

            const q = (sel) => mount.querySelector(sel);
            const setText = (sel, v) => { const el = q(sel); if (el) el.textContent = String(v); };

            setText('#rtCoord', model.coord);
            setText('#rtDataStatus', model.dataStatus);
            setText('#rtFlag', model.flag);
            setText('#rtNodeName', model.nodeName);
            setText('#rtDiagnosedTotal', model.diagnosedTotal);
            setText('#rtScanTotal', model.scanTotal);

            setText('#rtPkLeftLabel', `${model.pk.leftLabel}`);
            setText('#rtPkRightLabel', `${model.pk.rightLabel}`);
            setText('#rtPkLeftPct', pct(model.pk.leftPct));
            setText('#rtPkRightPct', pct(model.pk.rightPct));
            setText('#rtPkQuote', model.pk.quote);
            const pkLeftFill = q('#rtPkLeftFill');
            const pkRightFill = q('#rtPkRightFill');
            if (pkLeftFill) pkLeftFill.style.width = `${clamp(model.pk.leftPct, 0, 100)}%`;
            if (pkRightFill) pkRightFill.style.width = `${clamp(model.pk.rightPct, 0, 100)}%`;

            setText('#rtMeltdownWords', model.meltdown.words);
            setText('#rtMeltdownLevel', model.meltdown.level);
            setText('#rtMeltdownVictims', model.meltdown.victims);
            const meltdownFill = q('#rtMeltdownFill');
            if (meltdownFill) meltdownFill.style.width = `${clamp(model.meltdown.fillPct, 0, 100)}%`;

            // Ê≥®ÊÑèÔºö#rtSemanticTags Áé∞Âú®ÂåÖÂê´ÂÆåÊï¥ÁöÑ‚ÄúËØ≠‰πâÁàÜÂèë‚ÄùÊ®°ÊùøÔºàÂê´ËØç‰∫ëÂÆπÂô®ÔºâÔºå‰∏çË¶ÅÂú®ËøôÈáåË¶ÜÁõñ innerHTML
            setText('#rtSemanticMostUsed', model.semantic.mostUsed);
            setText('#rtSemanticFreq', model.semantic.freq);

            const eliteEl = q('#rtEliteList');
            if (eliteEl) {
                eliteEl.innerHTML = (model.elite || []).map((u) => `
                    <div class="user-avatar-card">
                        <div class="avatar-circle">${String(u.id || '').slice(0, 3).toUpperCase()}</div>
                        <div class="text-[10px] font-bold text-white truncate">${String(u.name || '')}</div>
                        <div class="text-[9px] text-green-500 mt-1">LPDEF: ${Number(u.lpdef) || 0}</div>
                    </div>
                `).join('');
            }

            const ratioEl = q('#rtRatioList');
            if (ratioEl) {
                ratioEl.innerHTML = (model.ratio || []).map((r) => `
                    <div class="flex justify-between text-xs ${r.dim ? 'text-zinc-500' : ''}">
                        <span class="flex items-center gap-2"><div class="w-2 h-2 ${r.dotClass}"></div> ${String(r.label)}</span>
                        <span class="font-bold">${Number(r.pct).toFixed(1)}%</span>
                    </div>
                `).join('');
            }

            // ÂàùÂßãÂåñ Lucide ÂõæÊ†áÔºàÂè™Ë¶ÅÂ∫ìÂä†ËΩΩÂÆåÊàêÂç≥ÂèØÔºâ
            try {
                if (typeof lucide !== 'undefined' && lucide && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }
            } catch (e) {
                // ignore
            }

            // ÂàùÂßãÂåñËØç‰∫ëÔºöÈùûÊ†∏ÂøÉÂõæË°®‰ΩøÁî® requestIdleCallbackÔºåÈÅøÂÖçÊªöÂä®Âç°È°ø
            try {
                const ric = window.requestIdleCallback || ((cb) => setTimeout(() => cb({ timeRemaining: () => 0 }), 0));
                ric(() => { try { loadWordCloud(); } catch (e) { /* ignore */ } }, { timeout: 1500 });
            } catch (e) {
                try { setTimeout(() => { loadWordCloud(); }, 50); } catch (e2) { /* ignore */ }
            }

            // Â∞Ü‚ÄúÊöÇÊó†Êï∞ÊçÆ‚ÄùÁöÑÂç†‰ΩçÊ∏≤ÊüìÂá∫Êù•ÔºåÈÅøÂÖçÁ©∫ÁôΩ
            const realtimeBox = q('#rtRealtimeList');
            if (realtimeBox && !realtimeBox.innerHTML.trim()) {
                realtimeBox.innerHTML = '<div class="text-zinc-500 text-xs">ÊöÇÊó†ÂÆûÊó∂Âä®ÊÄÅ</div>';
            }
        }

        function refreshCountryRightPanel() {
            if (currentViewState !== 'COUNTRY') return;
            if (!currentDrawerCountry || !currentDrawerCountry.code) return;
            renderCountryRightPanel(currentDrawerCountry.code, currentDrawerCountry.name);
            try { updateCountryDashboard(currentDrawerCountry.code); } catch (e) { /* ignore */ }
        }

        /**
         * ‰ªéÂõΩÂÆ∂ÈÄèËßÜÂàáÂõû„ÄåÂÆûÊó∂Âä®ÊÄÅÊµÅ„ÄçËßÜÂõæ
         */
        function switchBackToGlobalView() {
            currentViewState = 'GLOBAL';
            const globalFlowPanel = document.getElementById('globalFlowPanel');
            const countryPanelEl = document.getElementById('countryPanel');
            if (globalFlowPanel) globalFlowPanel.style.display = '';
            if (countryPanelEl) countryPanelEl.style.display = 'none';
            if (currentDrawerCountry.code && currentDrawerCountry.name) {
                showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);
            }
            console.log('[Drawer] Â∑≤ÂàáÂõûÂÖ®ÁêÉ/ÂÆûÊó∂Âä®ÊÄÅÊµÅ');
        }

        /**
         * ÂÖ≥Èó≠ÊäΩÂ±â
         * @param {boolean} clearSelection - ÊòØÂê¶Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅÔºåÈªòËÆ§‰∏∫ true
         */
        function closeDrawers(clearSelection = true) {
            const leftDrawer = document.getElementById('left-drawer');
            const rightDrawer = document.getElementById('right-drawer');

            if (leftDrawer) {
                leftDrawer.classList.remove('active');
            }
            if (rightDrawer) {
                rightDrawer.classList.remove('active');
            }
            
            if (clearSelection) {
                selectedCountry = null;
            }
            console.log('[Drawer] ÊäΩÂ±âÂ∑≤ÂÖ≥Èó≠, selectedCountry =', selectedCountry);
        }

        // Ê∑ªÂä† ESC ÈîÆÂÖ≥Èó≠ÊäΩÂ±â
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDrawers();
            }
        });

        // ÁÇπÂáªÊäΩÂ±âÂ§ñÈÉ®Âå∫ÂüüÂÖ≥Èó≠ÊäΩÂ±âÔºàÁÆÄÂåñÁâàÔºâ
        // Âè™Â§ÑÁêÜÁÇπÂáª UI ÂÖÉÁ¥†Â§ñÈÉ®ÁöÑÊÉÖÂÜµÔºåÂú∞ÂõæÁÇπÂáª‰∫ã‰ª∂Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜÂú∞ÂõæÂå∫ÂüüÁöÑÁÇπÂáª
        document.addEventListener('click', (e) => {
            const leftDrawer = document.getElementById('left-drawer');
            const rightDrawer = document.getElementById('right-drawer');
            
            if (!leftDrawer || !rightDrawer) return;
            
            // Â¶ÇÊûúÊäΩÂ±âÊòØÊøÄÊ¥ªÁä∂ÊÄÅ
            const isDrawerActive = leftDrawer.classList.contains('active') || rightDrawer.classList.contains('active');
            
            if (!isDrawerActive) return;
            
            // Ê£ÄÊü•ÁÇπÂáªÊòØÂê¶Âú®ÊäΩÂ±âÂÜÖÈÉ®
            const isClickInsideDrawer = leftDrawer.contains(e.target) || rightDrawer.contains(e.target);
            
            // Â¶ÇÊûúÁÇπÂáªÂú®ÊäΩÂ±âÂÜÖÈÉ®Ôºå‰∏çÂ§ÑÁêÜ
            if (isClickInsideDrawer) return;
            
            // „Äê‰øÆÂ§çÂú∞ÂõæÁÇπÂáª„ÄëÊ£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÂú∞ÂõæÂÆπÂô®ÔºàÂåÖÊã¨ ECharts canvas ÂÖÉÁ¥†Ôºâ
            // ECharts Ê∏≤ÊüìÂêéÔºåÁÇπÂáªÁõÆÊ†áÂèØËÉΩÊòØ canvas ÂÖÉÁ¥†ÔºåÈúÄË¶ÅÊ£ÄÊü•ÂÖ∂Áà∂ÂÆπÂô®
            const mapContainer = document.getElementById('map-container');
            const isMapClick = mapContainer && (
                e.target === mapContainer || 
                e.target.closest('#map-container') ||
                (e.target.tagName === 'CANVAS' && mapContainer.contains(e.target)) ||
                e.target.closest('canvas')
            );
            if (isMapClick) {
                // Âú∞ÂõæÁÇπÂáª‰∫ã‰ª∂Áî± ECharts Â§ÑÁêÜÔºåËøôÈáå‰∏çÈáçÂ§çÂ§ÑÁêÜÔºàÈÅøÂÖçÂÖ≥Èó≠ÊäΩÂ±âÔºâ
                console.log('[Drawer] Ê£ÄÊµãÂà∞Âú∞ÂõæÁÇπÂáªÔºåË∑≥ËøáÂÖ≥Èó≠ÊäΩÂ±âÈÄªËæë');
                return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫Ü UI ‰∫§‰∫íÂÖÉÁ¥†ÔºàÊåâÈíÆ„ÄÅËæìÂÖ•Ê°ÜÁ≠âÔºâ
            const isUIClick = e.target.closest('.max-w-\\[1600px\\]') && 
                             (e.target.tagName === 'BUTTON' || 
                              e.target.tagName === 'INPUT' || 
                              e.target.tagName === 'SELECT' ||
                              e.target.tagName === 'TEXTAREA' ||
                              e.target.tagName === 'A' ||
                              e.target.closest('button') ||
                              e.target.closest('input') ||
                              e.target.closest('select') ||
                              e.target.closest('a'));
            
            // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØ UI ÂÖÉÁ¥†Ôºå‰πü‰∏çÊòØÂú∞ÂõæÔºåÂàôÂÖ≥Èó≠ÊäΩÂ±â
            if (!isUIClick) {
                console.log('[Drawer] ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÔºåÂÖ≥Èó≠ÊäΩÂ±â');
                selectedCountry = null;
                closeDrawers();
            }
        });

        /**
         * Á≠âÂæÖÂú∞ÂõæÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê
         */
        async function waitForMapData(maxWait = 10000) {
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWait) {
                if (await checkMapLoaded()) {
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.warn('[Map] ‚ö†Ô∏è Á≠âÂæÖÂú∞ÂõæÊï∞ÊçÆË∂ÖÊó∂');
            return false;
        }

        // ‰øùÂ≠òÂÖ®Â±ÄÂú∞ÂõæÊï∞ÊçÆÔºå‰æõÊäΩÂ±â‰ΩøÁî®
        let globalLocationData = [];

        /**
         * ÂàùÂßãÂåñÂÖ®ÁêÉ 2D Âú∞ÂõæÔºàÊîØÊåÅÁº©Êîæ‰∏éÊãñÂä®Ôºâ
         * @param {Array} locationData - Âú∞ÁêÜ‰ΩçÁΩÆÊï∞ÊçÆ [{name: string, value: number}]
         */
        async function initGlobalMap(locationData) {
            try {
                // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè
                globalLocationData = locationData || [];
                const chartDom = document.getElementById('map-container');
                if (!chartDom) {
                    console.warn('[Map] ‚ö†Ô∏è Êâæ‰∏çÂà∞Âú∞ÂõæÂÆπÂô®ÂÖÉÁ¥†');
                    return;
                }
                
                // Ê£ÄÊü• ECharts Âíå ECharts GL ÊòØÂê¶Â∑≤Âä†ËΩΩ
                if (typeof echarts === 'undefined') {
                    console.warn('[Map] ‚ö†Ô∏è ECharts Êú™Âä†ËΩΩÔºåÊó†Ê≥ïÊ∏≤ÊüìÂú∞Âõæ');
                    return;
                }
                
                // Ê∏≤Êüì‰ª§ÁâåÔºàÂè™ÂÖÅËÆ∏ÊúÄÂêé‰∏ÄÊ¨°Ë∞ÉÁî®ÁªßÁª≠ÊâßË°åÔºâ
                const seq = ++mapRenderSeq;
                // Â¶ÇÊûúËøôÊ¨°Ë∞ÉÁî®Â∑≤ÁªèËøáÊúüÔºåÁõ¥Êé•ÈÄÄÂá∫ÔºàÈÅøÂÖç dispose ÂêéËøòÁªßÁª≠ setOptionÔºâ
                if (seq !== mapRenderSeq) return;

                // Á≠âÂæÖÂú∞ÂõæÊï∞ÊçÆÂä†ËΩΩÂÆåÊàêÔºàÂ∞ΩÈáèÁ≠âÂæÖÔºå‰ΩÜ‰∏çÂº∫Âà∂ÈòªÊñ≠Ê∏≤ÊüìÔºâ
                try {
                    await waitForMapData(5000);
                } catch (e) {
                    console.warn('[Map] ‚ö†Ô∏è Âú∞ÂõæÊï∞ÊçÆÊ£ÄÊü•Ë∂ÖÊó∂ÔºåÁªßÁª≠Â∞ùËØïÊ∏≤Êüì');
                }

                // Â§çÁî®ÂÆû‰æãÔºö‰∏çÂ≠òÂú®Âàô initÔºåÂ≠òÂú®Âàô clearÔºàÈÅøÂÖç dispose Âπ∂ÂèëÈóÆÈ¢òÔºâ
                try {
                    if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                        mapChart = echarts.init(chartDom, null, { renderer: 'canvas' });
                    } else {
                        mapChart.clear();
                    }
                } catch (e) {
                    // ÂÖúÂ∫ïÔºöÂ¶ÇÊûúÂÆû‰æãÂºÇÂ∏∏ÔºåÂ∞ùËØïÈáçÊñ∞ÂàõÂª∫
                    mapChart = echarts.init(chartDom, null, { renderer: 'canvas' });
                }
                
                // Âú∞ÂõæÊï∞ÊçÆÂøÖÈ°ªÂ∑≤Ê≥®ÂÜåÔºåÂê¶ÂàôÁ≠âÂæÖÂπ∂ÈáçËØï
                if (!echarts.getMap || !echarts.getMap('world')) {
                    console.warn('[Map] ‚ö†Ô∏è world Âú∞ÂõæÊï∞ÊçÆÊú™Ê≥®ÂÜåÔºàworld.js Êú™Âä†ËΩΩÂÆåÊàêÔºâÔºåÁ≠âÂæÖÈáçËØï...');
                    // Á≠âÂæÖ world.js Âä†ËΩΩÔºåÊúÄÂ§öÁ≠âÂæÖ 5 Áßí
                    let retryCount = 0;
                    const maxRetries = 50; // 50 * 100ms = 5Áßí
                    while (retryCount < maxRetries && (!echarts.getMap || !echarts.getMap('world'))) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        retryCount++;
                    }
                    
                    if (!echarts.getMap || !echarts.getMap('world')) {
                        console.error('[Map] ‚ùå world Âú∞ÂõæÊï∞ÊçÆÂä†ËΩΩË∂ÖÊó∂');
                        chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">Âú∞ÂõæÊï∞ÊçÆÂä†ËΩΩË∂ÖÊó∂ÔºåËØ∑Âà∑Êñ∞È°µÈù¢</div>';
                        return;
                    }
                    console.log('[Map] ‚úÖ world Âú∞ÂõæÊï∞ÊçÆÂ∑≤Âä†ËΩΩ');
                }

                // Â§ÑÁêÜÂú∞ÁêÜ‰ΩçÁΩÆÊï∞ÊçÆÔºà2D ‰∏ñÁïåÂú∞ÂõæÂêçÁß∞ÈúÄ‰∏é world.js ÁöÑËã±ÊñáÂõΩÂÆ∂ÂêçÂåπÈÖçÔºâ
                const processedData = (locationData || []).map(item => ({
                    name: (countryNameMap[item.name]
                        ? countryNameMap[item.name].en
                        : (item.name === 'USA' ? 'United States' : item.name)),
                    value: item.value || 0
                }));

                const maxVal = Math.max(20, ...processedData.map(d => d.value || 0));

                const option2D = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: '#18181b',
                        borderColor: '#27272a',
                        textStyle: { color: '#00ff41', fontFamily: 'JetBrains Mono' },
                        formatter: function(params) {
                            // Èò≤Âæ°ÊÄßÊ£ÄÊü•ÔºöÁ°Æ‰øù params Â≠òÂú®
                            if (!params) {
                                return '<div class="font-mono text-xs">Êú™Áü•Âå∫Âüü</div>';
                            }
                            
                            // Â¶ÇÊûúÊòØÂú∞ÂõæÂõΩÂÆ∂Êï∞ÊçÆÔºåÊòæÁ§∫ÂõΩÂÆ∂‰ø°ÊÅØ
                            if (params.seriesType === 'map') {
                                const name = params.name || params.data?.name || 'Êú™Áü•Âå∫Âüü';
                                const value = params.value || 0;
                                // ÂÆâÂÖ®Ëé∑Âèñ‰∏≠ÊñáÂêçÁß∞
                                const code = typeof resolveCountryCodeFromMapName === 'function'
                                    ? resolveCountryCodeFromMapName(name)
                                    : null;
                                const label =
                                    (code && countryNameMap && countryNameMap[code] && countryNameMap[code].zh)
                                        ? countryNameMap[code].zh
                                        : name;
                                
                                // Proxy ÊèêÁ§∫ÔºöÂà§Êñ≠ is_proxy Â≠óÊÆµÔºåËã•‰∏∫ trueÔºåÂú®Âú∞ÁêÜ‰ΩçÁΩÆÂêéÂ¢ûÂä† [Proxy] Á∫¢Ëâ≤Ë≠¶ÂëäÊ†áÁ≠æ
                                const dataItem = params.data || {};
                                const isProxy = dataItem.is_proxy || dataItem.isProxy || false;
                                const proxyLabel = isProxy ? '<span style="color: #ef4444; font-weight: bold;"> [Proxy]</span>' : '';
                                
                                // Êï∞ÊçÆÂ±ïÁ§∫ÔºöÂú®Âú∞ÂõæÂºπÁ™óÔºàTooltipÔºâ‰∏≠ÂêåÊ≠•Â±ïÁ§∫ËØ•ÂÜ†ÂÜõÁöÑÁß∞Âè∑ÂíåÊàòÁª©
                                let tooltipContent = `<div class="font-mono text-xs">${label}${proxyLabel}<br/>Ê¥ªË∑ÉËäÇÁÇπ: ${value}</div>`;
                                
                                // Â¶ÇÊûúÂΩìÂâçÊúâÈÄâ‰∏≠ÁöÑÂÜ†ÂÜõ‰ø°ÊÅØÔºå‰∏îÂõΩÂÆ∂ÂêçÁß∞ÂåπÈÖçÔºåÊòæÁ§∫ÂÜ†ÂÜõ‰ø°ÊÅØ
                                if (currentChampionInfo && currentChampionInfo.countryName === name) {
                                    const feedback = currentChampionInfo.feedback ? JSON.parse(currentChampionInfo.feedback) : null;
                                    tooltipContent = `
                                        <div class="font-mono text-xs">
                                            <div class="text-[#00ff41] font-bold mb-1">üèÜ ${currentChampionInfo.championName}</div>
                                            <div class="text-white mb-1">${label}${proxyLabel}</div>
                                            <div class="text-zinc-400 text-[10px] mb-1">ÊàòÁª©: ${currentChampionInfo.championValue}</div>
                                            ${feedback ? `
                                                <div class="text-zinc-500 text-[9px] mt-2 pt-2 border-t border-zinc-700">
                                                    <div class="text-[#00ff41]">${feedback.label}</div>
                                                    <div class="text-white">${feedback.title}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }
                                
                                return tooltipContent;
                            }
                            // Â¶ÇÊûúÊòØËÑâÂÜ≤ÁÇπÔºàeffectScatterÔºâÔºåÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØÔºàÂåÖÂê´Â§¥ÂÉèÈ¢ÑËßàÔºâ
                            if (params.seriesType === 'effectScatter' && params.data) {
                                const pointData = params.data;
                                // ‰ªéÊï∞ÊçÆÁÇπ‰∏≠Ëé∑ÂèñÂ§¥ÂÉè‰ø°ÊÅØ
                                const avatarUrl = pointData.avatarUrl || params.series?.avatarUrl || null;
                                const username = pointData.username || params.series?.username || null;
                                const userName = params.name || username || 'Áî®Êà∑';
                                
                                if (avatarUrl || username) {
                                    // Âà§Êñ≠ÈÄªËæëÔºöÂ¶ÇÊûú username Êó†ÊïàÔºå‰ΩøÁî® DEFAULT_AVATAR
                                    let finalAvatarUrl = avatarUrl;
                                    if (!finalAvatarUrl && username) {
                                        // „ÄêTask 3„ÄëÂØπ‰∫éÂú∞Âõæ‰∏äÁöÑÁî®Êà∑ÁÇπÔºåÂ¶ÇÊûúÊòØ fingerprint Áî®Êà∑ÂàôË∑≥Ëøá‰∏•Ê†ºÊ†°È™å
                                        // Ê≥®ÊÑèÔºöËøôÈáåÊó†Ê≥ïËé∑Âèñ user_identityÔºåÊâÄ‰ª•‰øùÊåÅÂéüÈÄªËæëÔºàÂè™Ê£ÄÊü• GitHub Áî®Êà∑ÂêçÊ†ºÂºèÔºâ
                                        if (isValidGitHubUsername(username)) {
                                            finalAvatarUrl = getGitHubAvatarUrl(username);
                                        } else {
                                            finalAvatarUrl = DEFAULT_AVATAR;
                                        }
                                    }
                                    // Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÊúâÊïàÁöÑÂ§¥ÂÉèURLÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                                    if (!finalAvatarUrl) {
                                        finalAvatarUrl = DEFAULT_AVATAR;
                                    }
                                    
                                    // ‰ΩøÁî®HTMLÊ†ºÂºèËøîÂõûÔºåÂåÖÂê´Â§¥ÂÉèÂõæÁâá
                                    // ECharts tooltipÊîØÊåÅHTMLÔºåÂèØ‰ª•Áõ¥Êé•ÂµåÂÖ•imgÊ†áÁ≠æ
                                    return `
                                        <div style="display: flex; align-items: center; gap: 8px; padding: 4px;">
                                            <img 
                                                src="${finalAvatarUrl}" 
                                                alt="avatar" 
                                                style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #27272a;"
                                                onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                            />
                                            <div>
                                                <div style="color: #00ff41; font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: bold;">${userName}</div>
                                                <div style="color: #71717a; font-family: 'JetBrains Mono', monospace; font-size: 10px;">Áî®Êà∑</div>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                return `<div style="color: #00ff41; font-family: 'JetBrains Mono', monospace;">üë§ ${userName}</div>`;
                            }
                            return params.name || '';
                        },
                        // ÂêØÁî®HTMLÊ∏≤ÊüìÊ®°Âºè
                        extraCssText: 'box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);'
                    },
                    visualMap: {
                        min: 0,
                        max: maxVal,
                        show: false,
                        inRange: {
                            color: ['#064e3b', '#065f46', '#00ff41', '#34d399']
                        }
                    },
                    geo: {
                        map: 'world',
                        roam: true, // ÂêØÁî®ÊãñÂä®ÂíåÁº©Êîæ
                        scaleLimit: { min: 1, max: 8 },
                        zoom: 1.2,
                        itemStyle: {
                            areaColor: 'transparent',
                            borderColor: 'transparent',
                            borderWidth: 0
                        },
                        silent: true // ÈùôÈªòÊ®°ÂºèÔºå‰∏çÂìçÂ∫îÈº†Ê†á‰∫ã‰ª∂ÔºåËÆ© map Á≥ªÂàóÂ§ÑÁêÜ
                    },
                    series: [{
                        type: 'map',
                        map: 'world',
                        // ÂêØÁî®ÊãñÂä®ÂíåÁº©Êîæ
                        roam: true,
                        // ÈôêÂà∂Áº©ÊîæËåÉÂõ¥ÔºåÈÅøÂÖçÊó†ÈôêÊîæÂ§ß/Áº©Â∞è
                        scaleLimit: { min: 1, max: 8 },
                        zoom: 1.2,
                        itemStyle: {
                            areaColor: 'transparent',
                            borderColor: 'rgba(0, 255, 65, 0.2)',
                            borderWidth: 1
                        },
                        emphasis: {
                            itemStyle: { areaColor: '#00ff41' },
                            label: { show: false }
                        },
                        data: processedData
                    }]
                };

                // notMerge: true ÂΩªÂ∫ïÊõøÊç¢ÔºåÈÅøÂÖçÊÆãÁïôÊóßÈÖçÁΩÆ
                mapChart.setOption(option2D, { notMerge: true, lazyUpdate: false });
                
                // Ê∑ªÂä†Âú∞ÂõæÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ - ÈáçÊñ∞ËÆæËÆ°ÈÄªËæëÔºàÂê´Ê†°ÂáÜÊ®°ÂºèÔºâ
                mapChart.off('click'); // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                mapChart.on('click', (params) => {
                    console.log('[Map] ‚úÖ Âú∞ÂõæÁÇπÂáª‰∫ã‰ª∂Â∑≤Ëß¶Âèë:', params);
                    
                    // ========== ÁÇπÂáª„ÄåCurrent Location„ÄçÂÖâÊ†áÔºöËøõÂÖ•Ê†°ÂáÜÊ®°Âºè ==========
                    const isCurrentLocationClick = params.seriesType === 'effectScatter' && params.seriesName === 'Current Location';
                    if (isCurrentLocationClick) {
                        if (!isCalibrating) {
                            isCalibrating = true;
                            updateCurrentLocationCursorColor('#3b82f6');
                            console.log('[Map] üìç ËøõÂÖ•Ê†°ÂáÜÊ®°ÂºèÔºåÂÖâÊ†áÂ∑≤ÂèòËìù');
                        }
                        return;
                    }
                    
                    // ========== Ê†°ÂáÜÊ®°Âºè‰∏ãÁÇπÂáªÂú∞Âõæ‰ªªÊÑè‰ΩçÁΩÆÔºöconvertFromPixel ÊçïËé∑ÁªèÁ∫¨Â∫¶Âπ∂ÁßªÂä®ÂÖâÊ†á ==========
                    if (isCalibrating) {
                        try {
                            const dom = mapChart.getDom();
                            if (dom && params.event) {
                                const rect = dom.getBoundingClientRect();
                                const x = (params.event.clientX != null ? params.event.clientX : params.event.offsetX) - rect.left;
                                const y = (params.event.clientY != null ? params.event.clientY : params.event.offsetY) - rect.top;
                                const point = mapChart.convertFromPixel('geo', [x, y]);
                                if (point && Array.isArray(point) && point.length >= 2) {
                                    const lng = Number(point[0]), lat = Number(point[1]);
                                    if (!isNaN(lng) && !isNaN(lat)) {
                                        pendingCalibration.lng = lng;
                                        pendingCalibration.lat = lat;
                                        const hasValidName = params.name && typeof params.name === 'string' && params.name.trim() !== '';
                                        if (params.seriesType === 'map' && hasValidName) {
                                            const countryName = params.name;
                                            let countryCode = null;
                                            for (const [code, names] of Object.entries(countryNameMap)) {
                                                if (names.en === countryName || names.zh === countryName || code === countryName) {
                                                    countryCode = code;
                                                    break;
                                                }
                                            }
                                            pendingCalibration.countryCode = countryCode || countryName;
                                            pendingCalibration.countryName = countryName;
                                        }
                                        moveCurrentLocationCursor(lng, lat);
                                        if (calibrationDebounceTimer) {
                                            clearTimeout(calibrationDebounceTimer);
                                            calibrationDebounceTimer = null;
                                        }
                                        calibrationDebounceTimer = setTimeout(() => {
                                            calibrationDebounceTimer = null;
                                            confirmCalibrationAndLock(
                                                pendingCalibration.countryCode,
                                                pendingCalibration.countryName,
                                                pendingCalibration.lng,
                                                pendingCalibration.lat
                                            );
                                        }, 1500);
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('[Map] convertFromPixel Â§±Ë¥•:', e);
                        }
                        return;
                    }
                    
                    // Âà§Êñ≠ÊòØÂê¶ÁÇπÂáªÂà∞‰∫ÜÂõΩÂÆ∂
                    const hasValidName = params.name && typeof params.name === 'string' && params.name.trim() !== '';
                    const isCountryClick = params.seriesType === 'map' && hasValidName;
                    console.log('[Map] ÁÇπÂáª‰∫ã‰ª∂ËØ¶ÊÉÖ:', { seriesType: params.seriesType, name: params.name, isCountryClick, selectedCountryBefore: selectedCountry });

                    if (isCountryClick) {
                        const countryName = params.name;
                        // ‰ºòÂÖàÁî®Áªü‰∏ÄËß£ÊûêÂáΩÊï∞ÔºöÈÄÇÈÖç world Âú∞ÂõæÁöÑËã±ÊñáÂÖ®Áß∞/Âà´ÂêçÔºàÂ∞§ÂÖ∂ÊòØÁæéÂõΩÔºâ
                        let countryCode = typeof resolveCountryCodeFromMapName === 'function'
                            ? resolveCountryCodeFromMapName(countryName)
                            : null;
                        if (!countryCode) {
                            // ÂÖúÂ∫ïÔºöÊóßÈÄªËæëÔºàISO2 Êò†Â∞ÑË°® en/zhÔºâ
                            try {
                                for (const [code, names] of Object.entries(countryNameMap || {})) {
                                    if (names.en === countryName || names.zh === countryName || code === countryName) {
                                        countryCode = code;
                                        break;
                                    }
                                }
                            } catch (e) {}
                        }
                        if (!countryCode) countryCode = countryName;
                        console.log(`[Map] üó∫Ô∏è ÁÇπÂáªÂõΩÂÆ∂: ${countryName} (${countryCode})`);
                        selectedCountry = countryCode;
                        
                        // ========== ÁæéÂõΩÔºöËøõÂÖ•ÂõΩÂÆ∂Êï∞ÊçÆÈÄèËßÜÊ®°ÂºèÔºàÂä†ËΩΩÁæéÂõΩÂå∫ÂüüÊï∞ÊçÆÔºâ ==========
                        // ‰∏ç‰æùËµñ params.name ÁöÑÂÖ∑‰ΩìÂ≠óÁ¨¶‰∏≤ÔºåÁªü‰∏Ä‰ª•Ëß£ÊûêÂêéÁöÑÂõΩÂÆ∂‰ª£Á†ÅÂà§Êñ≠
                        if (String(countryCode).toUpperCase() === 'US') {
                            switchToCountryView('US', countryName);
                            return;
                        }
                        
                        showDrawersWithCountryData(countryCode, countryName);
                    } else {
                        console.log('[Map] üåä ÁÇπÂáªÁ©∫ÁôΩÂ§ÑÔºåÊ∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅÂπ∂ÂÖ≥Èó≠ÊäΩÂ±â');
                        selectedCountry = null;
                        closeDrawers(false);
                    }
                });

                
                // Ê∑ªÂä†ÂèåÂáª‰∫ã‰ª∂ÔºåÈáçÁΩÆ‰∏∫ÂÖ®ÁêÉËßÜÂõæ
                mapChart.off('dblclick');
                mapChart.on('dblclick', (params) => {
                    if (params.seriesType === 'map') {
                        selectedCountry = null;
                        console.log('[Map] üåç ÂèåÂáªÈáçÁΩÆ‰∏∫ÂÖ®ÁêÉËßÜÂõæ');
                        closeDrawers();
                        
                        // Âú∞ÂõæÂèåÂáªÂêé‰∏çÂÜçÈúÄË¶ÅÈáçÊñ∞Ê∏≤Êüì LPDEF Âç°ÁâáÔºàÂ∑≤Â∫üÂºÉÔºå‰ΩøÁî® rank-cards-containerÔºâ
                    }
                });
                
                // ÂìçÂ∫îÂºèË∞ÉÊï¥ÔºàÁßªÈô§Êóß handlerÔºåÈÅøÂÖçÂ§öÊ¨°ÁªëÂÆö + Âπ∂Âèë resizeÔºâ
                try {
                    if (window.mapResizeHandler) {
                        window.removeEventListener('resize', window.mapResizeHandler);
                    }
                } catch (e) {
                    // ignore
                }
                const resizeHandler = () => {
                    if (mapChart && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                        mapChart.resize();
                    }
                };
                window.mapResizeHandler = resizeHandler;
                window.addEventListener('resize', resizeHandler);

                // Èò≤Ê≠¢ÊªöËΩÆÁº©ÊîæÂú∞ÂõæÊó∂È°µÈù¢Ë∑üÁùÄÊªöÂä®Ôºà‰ªÖÂú®ÊåáÈíàÂÅúÁïôÂú∞ÂõæÂå∫ÂüüÊó∂ÁîüÊïàÔºâ
                if (!chartDom.dataset.wheelLocked) {
                    chartDom.addEventListener('wheel', (e) => {
                        // ECharts Ëá™Â∑±‰ºöÊ∂àË¥πÊªöËΩÆÁî®‰∫éÁº©ÊîæÔºåËøôÈáåÈòªÊ≠¢È°µÈù¢ÊªöÂä®
                        e.preventDefault();
                    }, { passive: false });
                    chartDom.dataset.wheelLocked = 'true';
                }

                console.log('[Map] ‚úÖ 2D Âú∞ÂõæÊ∏≤ÊüìÂÆåÊàêÔºàÂ∑≤ÂêØÁî®Áº©Êîæ/ÊãñÂä®Ôºâ');
            } catch (error) {
                console.error('[Map] ‚ùå 2D Âú∞ÂõæÊ∏≤ÊüìÂ§±Ë¥•:', error);
                chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">Âú∞ÂõæÊ∏≤ÊüìÂ§±Ë¥•</div>';
            }
        }

        /**
         * Âú∞ÂõæËÑâÂÜ≤ÁâπÊïàÔºöÂú®Âú∞Âõæ‰∏äÂä®ÊÄÅÊ∑ªÂä†Ê∂üÊº™ÁâπÊïàÁÇπÔºàÊîØÊåÅÂä®ÊÄÅÈ¢úËâ≤Ôºâ
         * @param {number} lng - ÁªèÂ∫¶
         * @param {number} lat - Á∫¨Â∫¶
         * @param {string} label - ÊòæÁ§∫ÁöÑÊ†áÁ≠æÊñáÂ≠ó
         * @param {string} color - È¢úËâ≤ÂÄºÔºàÂçÅÂÖ≠ËøõÂà∂ÔºåÂ¶Ç '#00ff41' Êàñ '#ffffff'Ôºâ
         */
        /**
         * ËÆæÁΩÆÊàñÊõ¥Êñ∞„ÄåÂΩìÂâçÁî®Êà∑„ÄçÊåÅ‰πÖÂÖâÊ†áÔºàseriesName: 'Current Location'ÔºâÔºå‰∏çËá™Âä®ÁßªÈô§
         */
        function setOrUpdateCurrentLocationCursor(lng, lat, color = '#00ff41', avatarUrl = null, username = null) {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;
            if (typeof lng !== 'number' || typeof lat !== 'number' || isNaN(lng) || isNaN(lat)) return;
            if (!color || typeof color !== 'string') color = '#00ff41';
            try {
                const currentOption = mapChart.getOption();
                if (!currentOption || !currentOption.series || !Array.isArray(currentOption.series)) return;
                const otherSeries = currentOption.series.filter(s => s.name !== 'Current Location');
                const pulseSeries = {
                    name: 'Current Location',
                    type: 'effectScatter',
                    coordinateSystem: 'geo',
                    data: [{ value: [lng, lat], name: 'YOU', avatarUrl: avatarUrl || null, username: username || null }],
                    symbolSize: 20,
                    showEffectOn: 'render',
                    rippleEffect: { brushType: 'stroke', scale: 5, period: 4, color: color },
                    itemStyle: { color: color, shadowBlur: 20, shadowColor: color },
                    label: { show: true, formatter: 'YOU', position: 'top', color: color, fontSize: 10, fontFamily: 'JetBrains Mono' },
                    avatarUrl: avatarUrl || null,
                    username: username || null,
                    zlevel: 10,
                    z: 10
                };
                mapChart.setOption({ series: [...otherSeries, pulseSeries] }, { notMerge: false, lazyUpdate: false });
            } catch (e) { console.warn('[MapPulse] setOrUpdateCurrentLocationCursor:', e); }
        }

        /** ‰ªÖÊõ¥Êñ∞„ÄåCurrent Location„ÄçÁ≥ªÂàóÈ¢úËâ≤ÔºàÊ†°ÂáÜÊ®°ÂºèËìù / Ê≠£Â∏∏ÁªøÔºâ */
        function updateCurrentLocationCursorColor(color) {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;
            try {
                const opt = mapChart.getOption();
                if (!opt || !opt.series) return;
                const series = opt.series.map(s => {
                    if (s.name === 'Current Location') {
                        return {
                            ...s,
                            rippleEffect: { ...(s.rippleEffect || {}), color },
                            itemStyle: { ...(s.itemStyle || {}), color, shadowColor: color },
                            label: { ...(s.label || {}), color }
                        };
                    }
                    return s;
                });
                mapChart.setOption({ series }, { notMerge: false, lazyUpdate: false });
            } catch (e) { console.warn('[MapPulse] updateCurrentLocationCursorColor:', e); }
        }

        /** Â∞Ü„ÄåCurrent Location„ÄçÂÖâÊ†áÁßªÂä®Âà∞ [lng, lat]ÔºàECharts Âä®ÁîªÔºâ */
        function moveCurrentLocationCursor(lng, lat) {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;
            try {
                const opt = mapChart.getOption();
                if (!opt || !opt.series) return;
                const series = opt.series.map(s => {
                    if (s.name === 'Current Location' && s.data && s.data.length > 0) {
                        return { ...s, data: [{ ...s.data[0], value: [lng, lat] }] };
                    }
                    return s;
                });
                mapChart.setOption({ series }, { notMerge: false, lazyUpdate: false });
            } catch (e) { console.warn('[MapPulse] moveCurrentLocationCursor:', e); }
        }

        /**
         * Ê†°ÂáÜÁ°ÆËÆ§ÔºöË∞ÉÁî® /api/v2/analyze ÊåÅ‰πÖÂåñ manual_locationÔºàÂõΩÂÆ∂‰ª£Á†ÅÔºâ„ÄÅmanual_lat„ÄÅmanual_lngÔºåÈÄÄÂá∫Ê†°ÂáÜÂπ∂Êõ¥Êñ∞ UI
         * @param {string} countryCode - ÂõΩÂÆ∂‰ª£Á†ÅÔºàÂ¶Ç CN„ÄÅUSÔºâÔºåÁî®‰∫é manual_location
         * @param {string} countryName - ÂõΩÂÆ∂ÂêçÁß∞ÔºàÁî®‰∫éÂ±ïÁ§∫Ôºâ
         * @param {number} lng - ÁªèÂ∫¶
         * @param {number} lat - Á∫¨Â∫¶
         */
        async function confirmCalibrationAndLock(countryCode, countryName, lng, lat) {
            if (calibrationDebounceTimer) {
                clearTimeout(calibrationDebounceTimer);
                calibrationDebounceTimer = null;
            }
            isCalibrating = false;
            updateCurrentLocationCursorColor('#00ff41');

            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || '';
            const base = apiEndpoint.endsWith('/') ? apiEndpoint.slice(0, -1) : apiEndpoint;
            const analyzeUrl = base ? `${base}/api/v2/analyze` : '/api/v2/analyze';
            let fingerprint = null;
            try {
                fingerprint = localStorage.getItem('user_fingerprint') || window.fpId || null;
            } catch (e) {}
            const payload = {
                chatData: [{ role: 'USER', text: '.' }],
                manual_location: countryCode || null,
                manual_lat: lat,
                manual_lng: lng,
                fingerprint: fingerprint
            };
            try {
                const res = await fetch(analyzeUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    console.warn('[Calibration] ‚ö†Ô∏è Ê†°ÂáÜÊé•Âè£ËøîÂõûÈùû 2xx:', res.status);
                } else {
                    const data = await res.json().catch(() => ({}));
                    // Áä∂ÊÄÅÊåÅ‰πÖÂåñÔºöÁ°ÆËÆ§ÂÆöÂ±ÖÂêéÁ´ãÂç≥ÂÜôÂÖ•ÈîÅÂÆöÊ†áËÆ∞‰∏éÂùêÊ†áÔºåÂπ∂ÈáçÁªòÂú∞ÂõæÂÖâÊ†á‰∏∫ÁªøËâ≤
                    localStorage.setItem('loc_fixed', 'true');
                    if (!window.currentUserData) window.currentUserData = window.currentUser || {};
                    window.currentUserData.manual_lat = lat;
                    window.currentUserData.manual_lng = lng;
                    window.currentUserData.manual_location = countryCode;
                    localStorage.setItem('manual_lat', String(lat));
                    localStorage.setItem('manual_lng', String(lng));
                    if (countryCode && String(countryCode).trim() !== '') localStorage.setItem('manual_location', String(countryCode).trim());
                    updateCurrentLocationCursorColor('#00ff41'); // Á´ãÂç≥ÈáçÁªòÂú∞ÂõæÂÖâÊ†á‰∏∫ÁªøËâ≤
                    // ËßÜËßâÈîÅÂÆöÔºöÂêåÊ≠• currentUserÔºåÈò≤Ê≠¢Âà∑Êñ∞ÂâçÂª∂ËøüÂØºËá¥Ë∑≥Âä®
                    if (window.currentUser) {
                        window.currentUser.manual_location = countryCode;
                        window.currentUser.country_code = countryCode;
                        window.currentUser.manual_lat = lat;
                        window.currentUser.manual_lng = lng;
                    }
                    updateUserCountryFlag(countryCode, countryName, true);
                    if (typeof renderRankCards === 'function' && window.currentUser) renderRankCards(window.currentUser);
                    if (typeof window.refreshUserStats === 'function') {
                        setTimeout(() => window.refreshUserStats(), 300);
                    }
                    if (countryCode && typeof fetchCountrySummaryV3 === 'function') {
                        fetchCountrySummaryV3(countryCode).then((summary) => {
                            if (summary) showDrawersWithCountryData(countryCode, countryName || countryCode, summary);
                        }).catch(() => {});
                    } else if (countryCode) {
                        showDrawersWithCountryData(countryCode, countryName || countryCode);
                    }
                    console.log('[Calibration] ‚úÖ Ê†°ÂáÜÂ∑≤Á°ÆËÆ§Âπ∂ÊåÅ‰πÖÂåñ:', { countryCode, countryName, lng, lat });
                }
            } catch (err) {
                console.warn('[Calibration] ‚ö†Ô∏è Ê†°ÂáÜËØ∑Ê±ÇÂ§±Ë¥•:', err);
            }
        }

        /**
         * ÊãâÂèñÊüêÂõΩÂÆ∂ÁöÑ 10 È°πÊ†∏ÂøÉÊåáÊ†áÔºàget_country_summary_v3ÔºâÔºåÁî®‰∫éÊ†°ÂáÜÂêéÂè≥‰æßÊäΩÂ±âÊ∏≤Êüì
         * @param {string} countryCode - 2 ‰ΩçÂõΩÂÆ∂‰ª£Á†ÅÔºàÂ¶Ç CN„ÄÅUSÔºâ
         * @returns {Promise<Object|null>} ‰∏é lastData ÁªìÊûÑÂÖºÂÆπÁöÑÊëòË¶ÅÂØπË±°
         */
        async function fetchCountrySummaryV3(countryCode) {
            if (!countryCode || String(countryCode).trim().length !== 2) return null;
            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || '';
            const base = apiEndpoint.endsWith('/') ? apiEndpoint.slice(0, -1) : apiEndpoint;
            const url = base ? `${base}/api/country-summary?country=${encodeURIComponent(String(countryCode).toUpperCase())}` : `/api/country-summary?country=${encodeURIComponent(String(countryCode).toUpperCase())}`;
            try {
                const res = await fetch(url);
                if (!res.ok) return null;
                const payload = await res.json();
                // ‰øùÊåÅÊóßËØ≠‰πâÔºöÊòéÁ°ÆÂ§±Ë¥•Êó∂‰∏çÂà∑Êñ∞ÊäΩÂ±âÔºàÈÅøÂÖçÊääÊúâÊïàÁöÑÂÖ®Â±ÄÊï∞ÊçÆË¶ÜÁõñÊàê N/AÔºâ
                if (payload && typeof payload === 'object' && 'success' in payload && payload.success !== true) {
                    return null;
                }
                // ÂÖºÂÆπÂêéÁ´ØÂ§öÁßçÂåÖË£ÖÊ†ºÂºèÔºö{success, data/result/summary/...}
                // ÁõÆÊ†áÔºöËøîÂõû‰∏é window.lastData ÂÖºÂÆπÁöÑ‚ÄúÊâÅÂπ≥ÁªìÊûÑ‚ÄùÔºå‰æõÂè≥‰æßÊäΩÂ±âÁõ¥Êé•Ê∏≤Êüì
                const raw =
                    payload?.data ??
                    payload?.result ??
                    payload?.summary ??
                    payload?.payload ??
                    payload;

                // Êüê‰∫õÊé•Âè£‰ºöËøîÂõû { success: true, ...fields }ÔºàÂ≠óÊÆµÁõ¥Êé•Âú®Ê†π‰∏äÔºâ
                // ËøôÁßçÊÉÖÂÜµ‰∏ã raw ÂèØËÉΩ‰ªçÂ∏¶ success Ê†áËÆ∞Ôºå‰ΩÜ normalizeData ÂØπÊ≠§ÊòØÂÆâÂÖ®ÁöÑ
                const normalized = typeof normalizeData === 'function' ? normalizeData(raw) : raw;
                // ÈôÑÂ∏¶ÂõΩÂÆ∂Á†ÅÔºåÊñπ‰æøË∞ÉËØï/‰∏ãÊ∏∏‰ΩøÁî®Ôºà‰∏çÂΩ±ÂìçÊ∏≤ÊüìÔºâ
                if (normalized && typeof normalized === 'object') {
                    normalized.countryCode = String(countryCode).toUpperCase();
                }
                return normalized && typeof normalized === 'object' ? normalized : null;
            } catch (e) {
                console.warn('[CountrySummary] ÊãâÂèñÂ§±Ë¥•:', e);
                return null;
            }
        }

        /** ÂõΩÂÆ∂‰ª£Á†ÅËΩ¨ÂõΩÊóó EmojiÔºàÂ¶Ç CN -> üá®üá≥Ôºâ */
        function countryCodeToFlagEmoji(code) {
            if (!code || typeof code !== 'string') return '';
            const s = code.toUpperCase().trim();
            if (s.length !== 2) return '';
            const a = s.charCodeAt(0), b = s.charCodeAt(1);
            if (a < 65 || a > 90 || b < 65 || b > 90) return '';
            return String.fromCodePoint(0x1F1E6 + a - 65, 0x1F1E6 + b - 65);
        }

        /**
         * Êõ¥Êñ∞Â∑¶‰æßÊäΩÂ±â‰∏≠ÁöÑÁî®Êà∑ÂõΩÂÆ∂/Âú∞Âå∫Â±ïÁ§∫ÔºöÂõΩÊóó Emoji + ÊñáÊ°àÔºàËá™Âä®ËØÜÂà´ / Áî®Êà∑Ê†°ÂáÜÔºâ
         * Âà©Áî® v_unified_analysis_v2 ÁöÑ country_codeÔºåÁî® JS ËΩ¨‰∏∫ÂõΩÊóó Emoji
         */
        function updateUserCountryFlag(countryCode, countryName, isManual) {
            const el = document.getElementById('user-country-flag');
            if (!el) return;
            const code = (countryCode || '').toUpperCase();
            const flagEmoji = countryCodeToFlagEmoji(code);
            const desc = isManual ? (currentLang === 'zh' ? 'Áî®Êà∑Ê†°ÂáÜ' : 'User calibrated') : (currentLang === 'zh' ? 'Ëá™Âä®ËØÜÂà´' : 'Auto detected');
            if (flagEmoji) {
                el.innerHTML = `<span class="text-lg" aria-hidden="true">${flagEmoji}</span> <span class="text-[10px] text-zinc-400">${desc}</span>`;
            } else {
                el.innerHTML = `<span class="text-[10px] text-zinc-400">${countryName || code || ''} ¬∑ ${desc}</span>`;
            }
        }

        /**
         * Âú∞ÂõæËÑâÂÜ≤ÁâπÊïàÔºöÂú®Âú∞Âõæ‰∏äÂä®ÊÄÅÊ∑ªÂä†Ê∂üÊº™ÁâπÊïàÁÇπÔºàÊîØÊåÅÂä®ÊÄÅÈ¢úËâ≤ÂíåÂ§¥ÂÉèÔºâ
         * ÂΩì label ‰∏∫ 'YOU' Êó∂ÔºåÊîπ‰∏∫Êõ¥Êñ∞ÊåÅ‰πÖ„ÄåCurrent Location„ÄçÂÖâÊ†áÔºå‰∏çËá™Âä®ÁßªÈô§
         */
        function triggerMapPulse(lng, lat, label = '', color = '#00ff41', avatarUrl = null, username = null) {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                console.warn('[MapPulse] ‚ö†Ô∏è Âú∞ÂõæÂÆû‰æãÊú™ÂàùÂßãÂåñÔºåË∑≥ËøáËÑâÂÜ≤ÁâπÊïà');
                return;
            }
            if (typeof lng !== 'number' || typeof lat !== 'number' || isNaN(lng) || isNaN(lat)) {
                console.warn('[MapPulse] ‚ö†Ô∏è ÁªèÁ∫¨Â∫¶Êï∞ÊçÆÊ†ºÂºèÊó†ÊïàÔºåË∑≥ËøáËÑâÂÜ≤ÁâπÊïà');
                return;
            }
            if (!color || typeof color !== 'string') color = '#00ff41';

            // ÂΩìÂâçÁî®Êà∑‰ΩçÁΩÆÔºö‰ΩøÁî®ÊåÅ‰πÖ„ÄåCurrent Location„ÄçÁ≥ªÂàóÔºå‰∏ç 5 ÁßíÁßªÈô§
            if (label === 'YOU' || label === 'Áî®Êà∑') {
                setOrUpdateCurrentLocationCursor(lng, lat, color, avatarUrl, username);
                console.log(`[MapPulse] ‚úÖ ÂΩìÂâçÁî®Êà∑ÂÖâÊ†áÂ∑≤Êõ¥Êñ∞: [${lng}, ${lat}] (È¢úËâ≤: ${color})`);
                return;
            }

            try {
                const currentOption = mapChart.getOption();
                if (!currentOption || !currentOption.series || !Array.isArray(currentOption.series)) return;

                const pulseSeries = {
                    type: 'effectScatter',
                    coordinateSystem: 'geo',
                    data: [{ value: [lng, lat], name: label || 'Áî®Êà∑', avatarUrl: avatarUrl || null, username: username || null }],
                    symbolSize: 20,
                    showEffectOn: 'render',
                    rippleEffect: { brushType: 'stroke', scale: 5, period: 4, color: color },
                    itemStyle: { color: color, shadowBlur: 20, shadowColor: color },
                    label: { show: !!label, formatter: label || '', position: 'top', color: color, fontSize: 10, fontFamily: 'JetBrains Mono' },
                    avatarUrl: avatarUrl || null,
                    username: username || null,
                    zlevel: 10,
                    z: 10
                };
                const updatedSeries = [...currentOption.series, pulseSeries];
                mapChart.setOption({ series: updatedSeries }, { notMerge: false, lazyUpdate: false });
                console.log(`[MapPulse] ‚úÖ ËÑâÂÜ≤ÁâπÊïàÂ∑≤Ê∑ªÂä†: [${lng}, ${lat}] ${label || ''} (È¢úËâ≤: ${color})`);

                setTimeout(() => {
                    try {
                        if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;
                        const currentOpt = mapChart.getOption();
                        if (!currentOpt || !currentOpt.series || !Array.isArray(currentOpt.series)) return;
                        const filteredSeries = currentOpt.series.filter((s) => {
                            if (s.type === 'effectScatter' && s.name !== 'Current Location' && s.data && s.data.length > 0) {
                                const point = s.data[0];
                                if (point && Array.isArray(point.value) && point.value.length >= 2) {
                                    if (Math.abs(point.value[0] - lng) < 0.0001 && Math.abs(point.value[1] - lat) < 0.0001) return false;
                                }
                            }
                            return true;
                        });
                        mapChart.setOption({ series: filteredSeries }, { notMerge: false, lazyUpdate: false });
                    } catch (err) { console.warn('[MapPulse] ‚ö†Ô∏è ÁßªÈô§ËÑâÂÜ≤ÁâπÊïàÊó∂Âá∫Èîô:', err); }
                }, 5000);
            } catch (error) {
                console.error('[MapPulse] ‚ùå Ê∑ªÂä†ËÑâÂÜ≤ÁâπÊïàÂ§±Ë¥•:', error);
            }
        }

        /**
         * Ê∏≤ÊüìÈõ∑ËææÂõæÂà∞ÊåáÂÆöÁöÑ canvas
         * @param {HTMLCanvasElement} canvas - Canvas ÂÖÉÁ¥†
         * @param {Object} averages - Âπ≥ÂùáÂÄºÊï∞ÊçÆ
         */
        function renderRadarChartToCanvas(canvas, averages) {
            if (!canvas) {
                console.warn('[Èõ∑ËææÂõæ] ‚ùå Canvas ÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.warn('[Èõ∑ËææÂõæ] ‚ùå Êó†Ê≥ïËé∑Âèñ Canvas ‰∏ä‰∏ãÊñá');
                return;
            }
            
            const labels = currentLang === 'zh' ? ['ËØ≠Ë®Ä', 'Ê®°Âºè', 'Ê∑±Â∫¶', 'ÊïàÁéá', 'È¢ëÁéá'] : ['Lang', 'Pattern', 'Depth', 'Effi', 'Freq'];
            const targetData = [
                averages.L !== undefined && averages.L !== null ? Number(averages.L) : 0,
                averages.P !== undefined && averages.P !== null ? Number(averages.P) : 0,
                averages.D !== undefined && averages.D !== null ? Number(averages.D) : 0,
                averages.E !== undefined && averages.E !== null ? Number(averages.E) : 0,
                averages.F !== undefined && averages.F !== null ? Number(averages.F) : 0
            ];
            const zeroData = [0, 0, 0, 0, 0];

            const chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: zeroData,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        borderWidth: 1,
                        pointRadius: 2
                    }]
                },
                options: {
                    animation: {
                        duration: 900,
                        easing: 'easeOutQuart',
                        animateScale: true,
                        animateRotate: true
                    },
                    scales: {
                        r: {
                            angleLines: { color: '#27272a' },
                            grid: { color: '#27272a' },
                            pointLabels: { color: '#71717a', font: { size: 9 } },
                            ticks: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Ëß¶Âèë‰∏ÄÊ¨° updateÔºåËÆ©Èõ∑ËææÂõæ‰ªé‰∏≠ÂøÉÊâ©Âº†Âà∞ÁúüÂÆûÂÄº
            try {
                chart.data.datasets[0].data = targetData;
                chart.update();
            } catch (e) {
                console.warn('[Èõ∑ËææÂõæ] ‚ö†Ô∏è update Âä®ÁîªËß¶ÂèëÂ§±Ë¥•:', e);
            }
            
            return chart;
        }

        function renderRadarChart(averages) {
            // „ÄêID Â≠òÂú®ÊÄßÊ£ÄÊü•„ÄëÂú®ÊâßË°åÂâçÔºåÂøÖÈ°ªÊ£ÄÊü• document.getElementById ÊòØÂê¶ÈùûÁ©∫
            const radarCanvas = document.getElementById('radarChart');
            if (!radarCanvas) {
                console.warn('[Èõ∑ËææÂõæ] ‚ùå DOM ÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                return;
            }
            
            const ctx = radarCanvas.getContext('2d');
            if (!ctx) {
                console.warn('[Èõ∑ËææÂõæ] ‚ùå Êó†Ê≥ïËé∑Âèñ Canvas ‰∏ä‰∏ãÊñá');
                return;
            }
            
            if (radarChart) radarChart.destroy();

            const labels = currentLang === 'zh' ? ['ËØ≠Ë®Ä', 'Ê®°Âºè', 'Ê∑±Â∫¶', 'ÊïàÁéá', 'È¢ëÁéá'] : ['Lang', 'Pattern', 'Depth', 'Effi', 'Freq'];
            // „ÄêÈõ∑ËææÂõæÊï∞ÊçÆÊ†ºÂºè„ÄëÊõ¥Êñ∞ globalRadarChart Êó∂Ôºå‰º†ÂÖ• [stats.L, stats.P, stats.D, stats.E, stats.F]
            // ÂΩªÂ∫ïÂà†Èô§Á°¨ÁºñÁ†ÅÔºåÂ¶ÇÊûúÊé•Âè£ÊúâÂÄºÂàôÂøÖÈ°ªÊòæÁ§∫Êé•Âè£ÁöÑÂÄº
            const targetData = [
                averages.L !== undefined && averages.L !== null ? Number(averages.L) : 0,
                averages.P !== undefined && averages.P !== null ? Number(averages.P) : 0,
                averages.D !== undefined && averages.D !== null ? Number(averages.D) : 0,
                averages.E !== undefined && averages.E !== null ? Number(averages.E) : 0,
                averages.F !== undefined && averages.F !== null ? Number(averages.F) : 0
            ];
            const zeroData = [0, 0, 0, 0, 0];

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: zeroData,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        borderWidth: 1,
                        pointRadius: 2
                    }]
                },
                options: {
                    animation: {
                        duration: 900,
                        easing: 'easeOutQuart',
                        animateScale: true,
                        animateRotate: true
                    },
                    scales: {
                        r: {
                            angleLines: { color: '#27272a' },
                            grid: { color: '#27272a' },
                            pointLabels: { color: '#71717a', font: { size: 9 } },
                            ticks: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Ëß¶Âèë‰∏ÄÊ¨° updateÔºåËÆ©Èõ∑ËææÂõæ‰ªé‰∏≠ÂøÉÊâ©Âº†Âà∞ÁúüÂÆûÂÄº
            try {
                radarChart.data.datasets[0].data = targetData;
                radarChart.update();
            } catch (e) {
                console.warn('[Èõ∑ËææÂõæ] ‚ö†Ô∏è update Âä®ÁîªËß¶ÂèëÂ§±Ë¥•:', e);
            }
        }

        function renderLocationList(data) {
            const list = document.getElementById('locationList');
            if (!data || data.length === 0) return;
            
            list.innerHTML = data.slice(0, 5).map((item, i) => {
                const name = countryNameMap[item.name] ? countryNameMap[item.name][currentLang] : item.name;
                return `
                <div class="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2">
                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                    <span class="font-bold uppercase tracking-tighter">${name}</span>
                    <span class="text-[var(--accent-terminal)] font-bold">${item.value}</span>
                </div>`;
            }).join('');

            // ‰øÆÂ§çÔºötop-country ÂÖÉÁ¥†Â∑≤ÁßªÈô§ÔºåÊ∑ªÂä† null Ê£ÄÊü•
            const topCountryEl = document.getElementById('top-country');
            if (topCountryEl && data.length > 0) {
                const top = data[0];
                topCountryEl.innerText = countryNameMap[top.name] ? countryNameMap[top.name][currentLang] : top.name;
            }
        }

        /**
         * Âà§Êñ≠Áî®Êà∑ÂêçÊòØÂê¶‰∏∫ÊúâÊïàGitHubÁî®Êà∑Âêç
         * @param {string} username - Áî®Êà∑Âêç
         * @returns {boolean} ÊòØÂê¶‰∏∫ÊúâÊïàÁî®Êà∑Âêç
         */
        function isValidGitHubUsername(username, userIdentity = null) {
            if (!username || typeof username !== 'string') {
                return false;
            }
            const trimmed = username.trim();
            if (trimmed === '') {
                return false;
            }
            
            // „ÄêTask 3„Äë‰ºòÂåñÁî®Êà∑ÂêçÂêàÊ≥ïÊÄßÊ†°È™åÔºöÂ¶ÇÊûúÊòØ fingerprint Áî®Êà∑ÔºàÂåøÂêçÁî®Êà∑ÔºâÔºåË∑≥Ëøá‰∏•Ê†ºÁöÑ GitHub Ê†ºÂºèÊ†°È™å
            if (userIdentity === 'fingerprint' || userIdentity === 'anonymous') {
                // ÂØπ‰∫éÂåøÂêçÁî®Êà∑ÔºåÂè™ÂÅöÂü∫Êú¨Ê£ÄÊü•ÔºåÂÖÅËÆ∏‰∏≠ÊñáÁ≠âÁâπÊÆäÂ≠óÁ¨¶
                console.log('[GitHub] ‚ÑπÔ∏è Ê£ÄÊµãÂà∞ fingerprint Áî®Êà∑ÔºåË∑≥Ëøá‰∏•Ê†ºÊ†ºÂºèÊ†°È™å:', trimmed);
                // Âè™Ê£ÄÊü•ÊòØÂê¶‰∏∫Êó†ÊïàÁöÑÈªòËÆ§ÂÄº
                if (INVALID_USERNAME_VALUES.includes(trimmed)) {
                    return false;
                }
                // ÂÖÅËÆ∏ÂåÖÂê´‰∏≠ÊñáÂíåÂÖ∂‰ªñÂ≠óÁ¨¶
                return trimmed.length > 0;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶‰∏∫Êó†ÊïàÁöÑÈªòËÆ§ÂÄº
            if (INVALID_USERNAME_VALUES.includes(trimmed)) {
                return false;
            }
            // Ê£ÄÊü•ÊòØÂê¶‰ª• 'Guest_' ÂºÄÂ§¥ÔºàËá™Âä®ÁîüÊàêÁöÑËÆøÂÆ¢Áî®Êà∑ÂêçÔºâ
            if (trimmed.startsWith('Guest_')) {
                return false;
            }
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´‰∏≠ÊñáÂ≠óÁ¨¶ÔºàGitHubÁî®Êà∑Âêç‰∏çÊîØÊåÅ‰∏≠ÊñáÔºâ
            if (/[\u4e00-\u9fa5]/.test(trimmed)) {
                console.warn('[GitHub] ‚ö†Ô∏è GitHubÁî®Êà∑Âêç‰∏çËÉΩÂåÖÂê´‰∏≠ÊñáÂ≠óÁ¨¶:', trimmed);
                return false;
            }
            // GitHubÁî®Êà∑ÂêçÂè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅËøûÂ≠óÁ¨¶Âíå‰∏ãÂàíÁ∫ø
            // ÂøÖÈ°ª‰ª•Â≠óÊØçÊàñÊï∞Â≠óÂºÄÂ§¥ÔºåÈïøÂ∫¶Âú®1-39‰πãÈó¥
            const githubUsernamePattern = /^[a-zA-Z0-9]([a-zA-Z0-9]|-(?![.-])){0,38}$/;
            if (!githubUsernamePattern.test(trimmed)) {
                console.warn('[GitHub] ‚ö†Ô∏è GitHubÁî®Êà∑ÂêçÊ†ºÂºèÊó†Êïà:', trimmed);
                return false;
            }
            return true;
        }

        /**
         * Ëé∑ÂèñGitHubÂ§¥ÂÉèURL
         * @param {string} username - GitHubÁî®Êà∑Âêç
         * @returns {string|null} Â§¥ÂÉèURLÔºåÂ¶ÇÊûúÁî®Êà∑ÂêçÊó†ÊïàÂàôËøîÂõûnull
         */
        function getGitHubAvatarUrl(username) {
            // Â¶ÇÊûúÁî®Êà∑ÂêçÊó†ÊïàÔºåËøîÂõûnullÔºà‰∏çËØ∑Ê±ÇGitHubÂõæÁâáÔºâ
            if (!isValidGitHubUsername(username)) {
                return null;
            }
            // GitHubÂ§¥ÂÉèURLÊ†ºÂºè: https://github.com/[Áî®Êà∑Âêç].png
            return `https://github.com/${username.trim()}.png`;
        }

        /**
         * ÂàõÂª∫Â§¥ÂÉèHTMLÔºåÂåÖÂê´onerrorÂÖúÂ∫ïÈÄªËæë
         * @param {string} avatarUrl - Â§¥ÂÉèURL
         * @param {string} username - GitHubÁî®Êà∑ÂêçÔºàÁî®‰∫éidenticonÔºâ
         * @param {number} size - Â§¥ÂÉèÂ∞∫ÂØ∏ÔºàÂÉèÁ¥†Ôºâ
         * @returns {string} Â§¥ÂÉèHTMLÂ≠óÁ¨¶‰∏≤
         */
        function createAvatarHtml(avatarUrl, username, size = 32, userIdentity = null) {
            // „Äê‰øÆÂ§ç„ÄëÂ¶ÇÊûúÊ≤°ÊúâÊúâÊïàÁöÑÂ§¥ÂÉèURLÔºåÁõ¥Êé•‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
            // Â¶ÇÊûú username ‰∏∫ null ÊàñÊó†ÊïàÔºå‰πü‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉèÔºà‰∏çËøõË°å‰∏•Ê†ºÊ†°È™åÔºâ
            if (!avatarUrl) {
                return `<img 
                    src="${DEFAULT_AVATAR}" 
                    alt="avatar" 
                    class="rounded-full" 
                    width="${size}" 
                    height="${size}" 
                    loading="lazy" 
                    style="object-fit: cover;"
                    onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                />`;
            }
            
            // Âè™ÊúâÂΩì username Â≠òÂú®‰∏îÈúÄË¶ÅÊ†°È™åÊó∂ÊâçËøõË°åÊ†°È™å
            // Â¶ÇÊûú username ‰∏∫ nullÔºåËØ¥ÊòéÊòØÂåøÂêçÁî®Êà∑ÔºåÁõ¥Êé•‰ΩøÁî®Êèê‰æõÁöÑ avatarUrl
            if (username && !isValidGitHubUsername(username, userIdentity)) {
                // Áî®Êà∑ÂêçÊó†ÊïàÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                return `<img 
                    src="${DEFAULT_AVATAR}" 
                    alt="avatar" 
                    class="rounded-full" 
                    width="${size}" 
                    height="${size}" 
                    loading="lazy" 
                    style="object-fit: cover;"
                    onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                />`;
            }

            // Â¶ÇÊûúÊúâÊúâÊïàÁöÑÂ§¥ÂÉèURLÔºå‰ΩøÁî®ÂÆÉÔºå‰ΩÜonerrorÊó∂ÂõûÈÄÄÂà∞DEFAULT_AVATAR
            return `<img 
                src="${avatarUrl}" 
                alt="avatar" 
                class="rounded-full" 
                width="${size}" 
                height="${size}" 
                loading="lazy" 
                style="object-fit: cover;"
                onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
            />`;
        }

        function renderRecentActivity(victims) {
            const box = document.getElementById('recentActivity');
            if (!box) return;
            
            // ‰ºòÂÖà‰ΩøÁî® latestRecordsÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî® recentVictims
            const records = victims || [];
            
            if (records.length === 0) {
                box.innerHTML = '<div class="text-zinc-500 text-center py-4">ÊöÇÊó†Êï∞ÊçÆ</div>';
                return;
            }
            
            box.innerHTML = records.map((v, index) => {
                // ÂÖºÂÆπ‰∏§ÁßçÊï∞ÊçÆÊ†ºÂºèÔºölatestRecords Âíå recentVictims
                const time = v.time || v.created_at || new Date().toISOString();
                const type = v.type || v.personality_type || 'UNKNOWN';
                const location = v.location || v.ip_location || 'Êú™Áü•';
                const name = v.name || `ËÆ∞ÂΩï${index + 1}`;
                
                // Ëé∑ÂèñÂ§¥ÂÉè‰ø°ÊÅØ
                const avatarUrl = v.avatar_url || null;
                const githubUsername = v.github_username || null;
                
                // Âà§Êñ≠ÈÄªËæëÔºöÂ¶ÇÊûú github_username ‰∏∫Á©∫„ÄÅÊàñËÄÖÊòØÈªòËÆ§ÂÄºÔºåÂàô‰∏çË¶ÅËØ∑Ê±Ç GitHub ÂõæÁâá
                // „ÄêTask 3„Äë‰º†ÂÖ• user_identityÔºåÂØπ fingerprint Áî®Êà∑Ë∑≥Ëøá‰∏•Ê†ºÊ†°È™å
                const recordUserIdentity = v.user_identity || null;
                let finalAvatarUrl = avatarUrl;
                if (!finalAvatarUrl && githubUsername) {
                    if (isValidGitHubUsername(githubUsername, recordUserIdentity)) {
                        // Âè™ÊúâÊúâÊïàÁöÑGitHubÁî®Êà∑ÂêçÊâçÁîüÊàêÂ§¥ÂÉèURL
                        finalAvatarUrl = getGitHubAvatarUrl(githubUsername);
                    } else {
                        // Êó†ÊïàÁî®Êà∑ÂêçÊó∂Ôºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                        finalAvatarUrl = DEFAULT_AVATAR;
                    }
                }
                // Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÊúâÊïàÁöÑÂ§¥ÂÉèURLÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                if (!finalAvatarUrl) {
                    finalAvatarUrl = DEFAULT_AVATAR;
                }
                
                // „Äê‰øÆÂ§ç„ÄëfinalUsername Â∫îËØ•‰ΩøÁî® githubUsernameÔºàÂ¶ÇÊûúÊúâÊïàÔºâÔºåÂê¶Âàô‰ΩøÁî® name
                // ‰ΩÜ‰º†Áªô createAvatarHtml Êó∂ÔºåÂ∫îËØ•Âè™‰º†ÊúâÊïàÁöÑ GitHub Áî®Êà∑ÂêçÊàñ null
                // Âõ†‰∏∫ createAvatarHtml ‰ºöÊ†°È™åÁî®Êà∑ÂêçÔºåËÄå name ÂèØËÉΩÊòØ"ËÆ∞ÂΩï1"ËøôÊ†∑ÁöÑÂÄº
                const finalUsername = githubUsername || name;
                const usernameForAvatar = githubUsername && isValidGitHubUsername(githubUsername, recordUserIdentity) 
                    ? githubUsername 
                    : null;
                
                // ÁîüÊàêÂ§¥ÂÉèHTMLÔºàÂè™‰º†ÊúâÊïàÁöÑ GitHub Áî®Êà∑ÂêçÔºåÈÅøÂÖçÊ†°È™åË≠¶ÂëäÔºâ
                // „Äê‰øÆÂ§ç„Äë‰º†ÂÖ• user_identity ÂèÇÊï∞ÔºåÂØπ fingerprint Áî®Êà∑Ë∑≥Ëøá‰∏•Ê†ºÊ†°È™å
                const avatarHtml = createAvatarHtml(finalAvatarUrl, usernameForAvatar, 32, recordUserIdentity);
                
                return `
                <div class="border-l-2 border-zinc-800 pl-3 py-1 flex items-start gap-2">
                    <div class="flex-shrink-0 mt-0.5">
                        ${avatarHtml}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-zinc-500">${new Date(time).toLocaleTimeString()}</div>
                        <div class="text-white">${name.length > 6 ? name.slice(0,6) + '...' : name}</div>
                        <div class="text-[var(--accent-terminal)]">${type} @ ${location}</div>
                    </div>
                </div>
            `;
            }).join('');
        }


        /**
         * Êõ¥Êñ∞‰∏ìÂÆ∂Âç°Áâá UI
         * @param {string} dim - Áª¥Â∫¶Ê†áËØÜ (L, P, D, E, F)
         * @param {Object|null} expert - ‰∏ìÂÆ∂Êï∞ÊçÆÂØπË±°
         * @param {boolean} isNoDataArea - ÊòØÂê¶‰∏∫Êó†‰∫∫Âå∫Áä∂ÊÄÅÔºàtrue Êó∂ÊòæÁ§∫"ÂæÖÊãõÂãü"Ôºâ
         */
        function updateExpertCard(dim, expert, isNoDataArea = false) {
            // Èò≤Âæ°ÊÄßÁºñÁ®ãÔºöÊâÄÊúâ DOM Êìç‰ΩúÂâçÂÖàÊ£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            const card = document.getElementById(`card-${dim}`);
            if (!card) {
                console.warn(`[LPDEF] ‚ö†Ô∏è Âç°Áâá card-${dim} ‰∏çÂ≠òÂú®`);
                return;
            }
            
            const avatarEl = document.getElementById(`expert-avatar-${dim}`);
            const nameEl = document.getElementById(`expert-name-${dim}`);
            const titleEl = document.getElementById(`expert-title-${dim}`);
            const scoreEl = document.getElementById(`expert-score-${dim}`);
            const labelEl = document.getElementById(`expert-label-${dim}`);
            const descEl = document.getElementById(`expert-desc-${dim}`);

            if (expert) {
                // Êõ¥Êñ∞Â§¥ÂÉè
                if (avatarEl) {
                    let avatarUrl = DEFAULT_AVATAR;
                    
                    // ‰ºòÂÖàÁ∫ß 1: Â¶ÇÊûúÊúâ GitHub IDÔºå‰ΩøÁî® GitHub Â§¥ÂÉè
                    // „ÄêTask 3„Äë‰º†ÂÖ• user_identityÔºåÂØπ fingerprint Áî®Êà∑Ë∑≥Ëøá‰∏•Ê†ºÊ†°È™å
                    const expertUserIdentity = expert.user?.user_identity || null;
                    if (expert.githubUsername && isValidGitHubUsername(expert.githubUsername, expertUserIdentity)) {
                        avatarUrl = getGitHubAvatarUrl(expert.githubUsername);
                    } else if (expert.user?.github_username && isValidGitHubUsername(expert.user.github_username, expertUserIdentity)) {
                        // ÈôçÁ∫ßÔºö‰ªé user ÂØπË±°‰∏≠Ëé∑Âèñ
                        avatarUrl = getGitHubAvatarUrl(expert.user.github_username);
                    }
                    // ‰ºòÂÖàÁ∫ß 2: Â¶ÇÊûúÊúâ fingerprintÔºå‰ΩøÁî®Âü∫‰∫éÊåáÁ∫πÁöÑÂîØ‰∏ÄÂ§¥ÂÉè
                    else if (expert.fingerprint) {
                        avatarUrl = `https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(expert.fingerprint)}`;
                    }
                    // Âê¶Âàô‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                    
                    avatarEl.innerHTML = `<img 
                        src="${avatarUrl}" 
                        alt="${expert.username || 'Expert'}"
                        class="w-full h-full object-cover rounded-full"
                        onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                    />`;
                }

                // Êõ¥Êñ∞Áî®Êà∑Âêç
                if (nameEl) {
                    nameEl.textContent = expert.username || 'Unknown';
                }

                // Êõ¥Êñ∞Áß∞Âè∑ÔºàÂ∑¶‰∏äËßíÔºâ- ‰ΩøÁî®Áª¥Â∫¶‰∏ìÂ±ûÁß∞Âè∑
                if (labelEl && DIMENSION_TITLES[dim]) {
                    labelEl.textContent = DIMENSION_TITLES[dim].title;
                }
                
                // Êõ¥Êñ∞ËØ¥ÊòéÔºàÂàÜÊï∞‰∏ãÊñπÔºâ- ‰ΩøÁî®Áª¥Â∫¶‰∏ìÂ±ûËØ¥Êòé
                if (descEl && DIMENSION_TITLES[dim]) {
                    descEl.textContent = DIMENSION_TITLES[dim].description;
                }
                
                // Êõ¥Êñ∞ personality_typeÔºà‰øùÁïôÂéüÊúâÈÄªËæëÔºå‰ΩÜ‰∏çÂú®‰∏ªË¶Å‰ΩçÁΩÆÊòæÁ§∫Ôºâ
                if (titleEl) {
                    titleEl.textContent = expert.personalityType || 'UNKNOWN';
                }

                // Êõ¥Êñ∞ÂàÜÊï∞Ôºà‰ΩøÁî®ÊèêÂèñÂà∞ÁöÑ scoreÔºâ
                if (scoreEl) {
                    scoreEl.textContent = Math.round(expert.score || 0);
                }
                
                // ÊÅ¢Â§çÁÇπÂáª‰∫ã‰ª∂ÔºàÂ¶ÇÊûúÊúâ‰∏ìÂÆ∂Êï∞ÊçÆÔºâ
                if (card) {
                    card.onclick = () => openExpertGitHub(dim);
                    card.style.cursor = 'pointer';
                }
            } else {
                // Êó†Êï∞ÊçÆÊó∂ÁöÑÊòæÁ§∫ÔºàÂåÖÊã¨Êó†‰∫∫Âå∫Áä∂ÊÄÅÔºâ
                // ‰øùÊåÅÁß∞Âè∑ÂíåËØ¥ÊòéÔºàÁª¥Â∫¶‰∏ìÂ±ûÔºâ
                if (labelEl && DIMENSION_TITLES[dim]) {
                    labelEl.textContent = DIMENSION_TITLES[dim].title;
                }
                
                if (descEl && DIMENSION_TITLES[dim]) {
                    descEl.textContent = DIMENSION_TITLES[dim].description;
                }
                
                if (avatarEl) {
                    // Êó†‰∫∫Âå∫Áä∂ÊÄÅÔºö‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                    avatarEl.innerHTML = `<img 
                        src="${DEFAULT_AVATAR}" 
                        alt="ÂæÖÊãõÂãü"
                        class="w-full h-full object-cover rounded-full opacity-50"
                    />`;
                }
                
                if (nameEl) {
                    nameEl.textContent = isNoDataArea ? 'ÂæÖÊãõÂãü' : 'ÊöÇÊó†Êï∞ÊçÆ';
                }
                
                if (titleEl) {
                    titleEl.textContent = isNoDataArea ? 'Á≠âÂæÖÂä†ÂÖ•' : '...';
                }
                
                if (scoreEl) {
                    scoreEl.textContent = '0';
                }
                
                // Êó†‰∫∫Âå∫Áä∂ÊÄÅÔºöÂèñÊ∂àÁÇπÂáªË∑≥ËΩ¨‰∫ã‰ª∂
                if (card) {
                    card.onclick = null;
                    card.style.cursor = 'default';
                }
            }
        }

        /**
         * ÊâìÂºÄ‰∏ìÂÆ∂ÁöÑ GitHub ‰∏ªÈ°µ
         * @param {string} dim - Áª¥Â∫¶Ê†áËØÜ (L, P, D, E, F)
         */
        function openExpertGitHub(dim) {
            const expert = lpdefExperts[dim];
            if (expert && expert.githubUsername && isValidGitHubUsername(expert.githubUsername)) {
                window.open(`https://github.com/${expert.githubUsername}`, '_blank');
            } else if (expert && expert.user && expert.user.github_username && isValidGitHubUsername(expert.user.github_username)) {
                window.open(`https://github.com/${expert.user.github_username}`, '_blank');
            } else {
                console.warn(`[LPDEF] ‚ö†Ô∏è Áª¥Â∫¶ ${dim} ÁöÑ‰∏ìÂÆ∂Ê≤°ÊúâÊúâÊïàÁöÑ GitHub Áî®Êà∑Âêç`);
            }
        }

        /**
         * Ê∏≤Êüì‰∫∫Ê†ºÂàÜÂ∏ÉÊéíË°å
         * @param {Array} distribution - ‰∫∫Ê†ºÂàÜÂ∏ÉÊï∞ÊçÆ [{type: string, count: number}]
         */
        function renderPersonalityDistribution(distribution) {
            const list = document.getElementById('personalityDistribution');
            if (!list) return;
            
            if (!distribution || !Array.isArray(distribution) || distribution.length === 0) {
                list.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">ÊöÇÊó†Êï∞ÊçÆ</div>';
                return;
            }
            
            list.innerHTML = distribution.map((item, i) => {
                const type = item.type || 'UNKNOWN';
                const count = Number(item.count) || 0;
                return `
                <div class="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2">
                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                    <span class="font-bold uppercase tracking-tighter">${type}</span>
                    <span class="text-[var(--accent-terminal)] font-bold">${count}</span>
                </div>`;
            }).join('');
        }

        /**
         * „ÄêÈÄÇÈÖçÂ±ÇÈáçÂÜô„ÄëÂº∫Âà∂Êò†Â∞ÑÂ±ÇÔºö‰ªéÂ§ö‰∏™ÂèØËÉΩÁöÑÂ≠óÊÆµË∑ØÂæÑÊèêÂèñÊï∞ÊçÆ
         * @param {Object} result - API ËøîÂõûÁöÑÂéüÂßãÊï∞ÊçÆ
         * @returns {Object} Ê†áÂáÜÂåñÂêéÁöÑÊï∞ÊçÆÂØπË±°
         */
        function normalizeData(result) {
            // ÂÖºÂÆπÔºöÊüê‰∫õÊé•Âè£ÊääÁúüÂÆûÊï∞ÊçÆÂåÖÂú® {success, data/result/...} ‰∏≠
            const unwrap = (v) => {
                if (!v || typeof v !== 'object') return v;
                // ‰ªÖÂú®Âá∫Áé∞ success Ê†áËÆ∞Êó∂Â∞ùËØïËß£ÂåÖÔºåÈÅøÂÖçËØØÊääÊôÆÈÄö data Â≠óÊÆµÂΩìÊàêÂåÖË£πÂ±Ç
                if ('success' in v) {
                    return v.data ?? v.result ?? v.summary ?? v.payload ?? v;
                }
                return v;
            };
            const data = unwrap(result) || {};
            
            // „ÄêÊ†∏ÂøÉÊåáÊ†áÊèêÂèñ„Äë‰ªé json.totalAnalysis ÊèêÂèñÊÄªÊâ´ÊèèÊï∞Ôºå‰ªé json.totalUsers ÊèêÂèñÊÄª‰∫∫Êï∞
            let totalAnalysis =
                data.totalAnalysis ??
                data.total_analysis ??
                data.data?.totalAnalysis ??
                data.data?.total_analysis ??
                undefined;
            if (totalAnalysis === undefined || totalAnalysis === null) {
                const recentVictims = data.recentVictims || data.latestRecords || data.latest_records || [];
                if (Array.isArray(recentVictims)) totalAnalysis = recentVictims.length;
            }
            const totalAnalysisNum = Number(totalAnalysis);
            totalAnalysis = Number.isFinite(totalAnalysisNum) ? totalAnalysisNum : undefined;
            
            // „ÄêÊÄª‰∫∫Êï∞ÊèêÂèñ„Äë‰ªé json.totalUsers ÊèêÂèñ
            const totalUsersRaw =
                data.totalUsers ??
                data.total_users ??
                data.data?.totalUsers ??
                data.data?.total_users ??
                data.us_stats?.totalUsers ??
                data.us_stats?.total_users ??
                undefined;
            const totalUsersNum = Number(totalUsersRaw);
            const totalUsers = Number.isFinite(totalUsersNum) ? totalUsersNum : undefined;
            
            // „ÄêÁ¥ØËÆ°ÂêêÊßΩÂ≠óÊï∞‰øÆÂ§ç„Äë‰∏çË¶ÅËØªÂèñ json.totalRoastWordsÔºàÂÆÉÊòØ 0ÔºâÔºåËØ∑Â∞ùËØï‰ªé json.totalChars Êàñ json.latestRecords[0].total_chars Ëé∑ÂèñÊï∞ÊçÆ
            let totalRoastWords =
                data.totalChars ??
                data.total_chars ??
                data.totalCharsSum ??
                data.total_chars_sum ??
                data.totalCharsTotal ??
                data.total_chars_total ??
                undefined;
            if (totalRoastWords === undefined || totalRoastWords === null || totalRoastWords === 0) {
                // Â∞ùËØï‰ªé latestRecords ‰∏≠Ëé∑Âèñ
                const latestRecords =
                    data.latestRecords ||
                    data.latest_records ||
                    data.recentVictims ||
                    data.recent_victims ||
                    [];
                if (Array.isArray(latestRecords) && latestRecords.length > 0) {
                    const first = latestRecords[0] || {};
                    if (first.total_chars !== undefined && first.total_chars !== null) {
                        totalRoastWords = first.total_chars;
                    } else if (first.totalChars !== undefined && first.totalChars !== null) {
                        totalRoastWords = first.totalChars;
                    }
                }
            }
            // ÊúÄÂêéÂÖúÂ∫ïÔºöÂ¶ÇÊûúËøòÊòØ 0 ÊàñÊú™ÂÆö‰πâÔºåÂ∞ùËØïÂÖ∂‰ªñË∑ØÂæÑ
            if (totalRoastWords === undefined || totalRoastWords === null || totalRoastWords === 0) {
                totalRoastWords =
                    data.totalRoastWords ??
                    data.total_roast_words ??
                    data.data?.totalRoastWords ??
                    data.data?.total_roast_words ??
                    undefined;
            }
            
            // „ÄêÁ¥ØËÆ°ÂêêÊßΩÂ≠óÊï∞‰øÆÂ§ç„ÄëÁªëÂÆöÂà∞ json.totalChars
            const totalCharsRaw =
                data.totalChars ??
                data.total_chars ??
                data.totalCharsSum ??
                data.total_chars_sum ??
                totalRoastWords;
            const totalCharsNum = Number(totalCharsRaw);
            const totalChars = Number.isFinite(totalCharsNum) ? totalCharsNum : undefined;
            
            // „ÄêÂº∫Âà∂Êò†Â∞ÑÂ±Ç„ÄëavgPerUser Âíå avgPerScanÔºö‰æùÊ¨°Â∞ùËØï result.avgPerUser/avgPerScan, result.data.avgPerUser/avgPerScan
            let avgPerUser =
                data.avgPerUser ??
                data.avg_per_user ??
                data.data?.avgPerUser ??
                data.data?.avg_per_user ??
                undefined;
            // ÂÖºÂÆπÊóßÂ≠óÊÆµÂêç
            if (avgPerUser === undefined || avgPerUser === null) {
                avgPerUser = data.avgChars ?? data.avg_chars ?? undefined;
            }
            // Â¶ÇÊûú avgPerUser ‰∏∫ 0 ÊàñÊó†ÊïàÔºå‰∏î totalChars Âíå totalUsers ÈÉΩÂ≠òÂú®ÔºåÂàôËÆ°ÁÆóÔºötotalChars / totalUsers
            const avgPerUserNum = Number(avgPerUser);
            if ((!Number.isFinite(avgPerUserNum) || avgPerUserNum === 0) && totalChars !== undefined && totalUsers !== undefined && totalUsers > 0) {
                avgPerUser = totalChars / totalUsers;
            } else {
                avgPerUser = Number.isFinite(avgPerUserNum) ? avgPerUserNum : undefined;
            }
            
            let avgPerScan =
                data.avgPerScan ??
                data.avg_per_scan ??
                data.data?.avgPerScan ??
                data.data?.avg_per_scan ??
                undefined;
            // Â¶ÇÊûú avgPerScan ‰∏∫ 0 ÊàñÊó†ÊïàÔºå‰∏î totalChars Âíå totalAnalysis ÈÉΩÂ≠òÂú®ÔºåÂàôËÆ°ÁÆóÔºötotalChars / totalAnalysis
            const avgPerScanNum = Number(avgPerScan);
            if ((!Number.isFinite(avgPerScanNum) || avgPerScanNum === 0) && totalChars !== undefined && totalAnalysis !== undefined && totalAnalysis !== null && totalAnalysis > 0) {
                avgPerScan = totalChars / totalAnalysis;
            } else {
                avgPerScan = Number.isFinite(avgPerScanNum) ? avgPerScanNum : undefined;
            }
            
            // „Äê‰∫îÁª¥Âπ≥ÂùáÂàÜÊèêÂèñ„ÄëÂøÖÈ°ª‰ªé json.averages Êàñ json.globalAverage ÂØπË±°‰∏≠ÊèêÂèñÔºà‰æãÂ¶ÇÔºöjson.averages.LÔºâ
            // ÂΩªÂ∫ïÂà†Èô§Á°¨ÁºñÁ†ÅÔºåÂ¶ÇÊûúÊé•Âè£ÊúâÂÄºÂàôÂøÖÈ°ªÊòæÁ§∫Êé•Âè£ÁöÑÂÄº
            let averages = data.averages || data.globalAverage || data.global_average;
            if (!averages || typeof averages !== 'object') {
                // ÂÖºÂÆπÔºöÊúâ‰∫õÊé•Âè£ËøîÂõû avg_l/avg_p/... ËÄå‰∏çÊòØÂØπË±°
                const avgL = data.avg_l ?? data.avgL ?? data.data?.avg_l ?? data.data?.avgL ?? undefined;
                const avgP = data.avg_p ?? data.avgP ?? data.data?.avg_p ?? data.data?.avgP ?? undefined;
                const avgD = data.avg_d ?? data.avgD ?? data.data?.avg_d ?? data.data?.avgD ?? undefined;
                const avgE = data.avg_e ?? data.avgE ?? data.data?.avg_e ?? data.data?.avgE ?? undefined;
                const avgF = data.avg_f ?? data.avgF ?? data.data?.avg_f ?? data.data?.avgF ?? undefined;
                const hasAny = [avgL, avgP, avgD, avgE, avgF].some((v) => v !== undefined && v !== null && v !== '');
                averages = hasAny ? { L: avgL, P: avgP, D: avgD, E: avgE, F: avgF } : {};
            }
            // Á°Æ‰øùÊâÄÊúâÁª¥Â∫¶ÈÉΩÊúâÂÄºÔºå‰ΩÜ‰∏ç‰ΩøÁî®Á°¨ÁºñÁ†ÅÈªòËÆ§ÂÄº
            averages = {
                L: averages.L !== undefined && averages.L !== null ? Number(averages.L) : undefined,
                P: averages.P !== undefined && averages.P !== null ? Number(averages.P) : undefined,
                D: averages.D !== undefined && averages.D !== null ? Number(averages.D) : undefined,
                E: averages.E !== undefined && averages.E !== null ? Number(averages.E) : undefined,
                F: averages.F !== undefined && averages.F !== null ? Number(averages.F) : undefined
            };
            
            // ‰∏∫‰∫ÜÂÖºÂÆπÊÄßÔºåÂêåÊó∂ËÆæÁΩÆ globalAverage
            const globalAverage = averages;
            
            // „Äê‰∏äÂ≤óÂ§©Êï∞‰øÆÂ§ç„Äë‰ªé json.systemDays Êàñ json.latestRecords[0].work_days ÊèêÂèñÔºå‰∏çÁ°¨ÁºñÁ†Å
            let systemDays = data.systemDays;
            if (systemDays === undefined || systemDays === null) {
                const latestRecords =
                    data.latestRecords ||
                    data.latest_records ||
                    data.recentVictims ||
                    data.recent_victims ||
                    [];
                if (Array.isArray(latestRecords) && latestRecords.length > 0) {
                    const first = latestRecords[0] || {};
                    if (first.work_days !== undefined && first.work_days !== null) systemDays = first.work_days;
                    else if (first.workDays !== undefined && first.workDays !== null) systemDays = first.workDays;
                }
            }
            
            return {
                totalUsers: totalUsers !== undefined && totalUsers !== null ? totalUsers : undefined,
                totalAnalysis: totalAnalysis !== undefined && totalAnalysis !== null ? totalAnalysis : undefined,
                totalRoastWords: totalRoastWords !== undefined && totalRoastWords !== null ? totalRoastWords : undefined,
                totalChars: totalChars,
                avgPerUser: avgPerUser !== undefined && avgPerUser !== null ? avgPerUser : undefined,
                avgPerScan: avgPerScan !== undefined && avgPerScan !== null ? avgPerScan : undefined,
                cityCount: data.cityCount !== undefined && data.cityCount !== null ? data.cityCount : undefined,
                systemDays: systemDays !== undefined && systemDays !== null ? systemDays : undefined,
                personalityRank:
                    data.personalityRank ||
                    data.personality_rank ||
                    data.personalityDistribution ||
                    data.personality_distribution ||
                    [],
                personalityDistribution:
                    data.personalityDistribution ||
                    data.personality_distribution ||
                    data.personalityRank ||
                    data.personality_rank ||
                    [],
                globalAverage: globalAverage,
                averages: averages,
                locationRank: data.locationRank || data.location_rank || [],
                recentVictims:
                    data.recentVictims ||
                    data.recent_victims ||
                    data.latestRecords ||
                    data.latest_records ||
                    [],
                latestRecords:
                    data.latestRecords ||
                    data.latest_records ||
                    data.recentVictims ||
                    data.recent_victims ||
                    [],
                // „ÄêÊñ∞Â¢û„Äë‰øùÂ≠òÂêÑÁª¥Â∫¶ÁöÑÊúÄÈ´òËÆ∞ÂΩïÔºàÁî®‰∫é"ÂÖ®ÁêÉÊúÄÂº∫Ê®°Âºè"Ôºâ
                topRecords: data.topRecords || {},
            };
        }

        /**
         * „ÄêÂä®ÁîªÂÆπÈîô„ÄëÂÆâÂÖ®ÁöÑÂä®ÁîªÂáΩÊï∞ÔºåÈò≤Ê≠¢ NaN Êàñ undefined ÂØºËá¥Â¥©Ê∫É
         * @param {HTMLElement} element - ÁõÆÊ†áÂÖÉÁ¥†
         * @param {number} start - Ëµ∑ÂßãÂÄº
         * @param {number} end - ÁªìÊùüÂÄº
         * @param {number} duration - Âä®ÁîªÊåÅÁª≠Êó∂Èó¥
         * @param {boolean} useFormat - ÊòØÂê¶‰ΩøÁî®Ê†ºÂºèÂåñ
         */
        function safeAnimateValue(element, start, end, duration = 1500, useFormat = true) {
            if (!element) {
                console.warn('[Âä®Áîª] ‚ùå DOM ÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                return;
            }
            
            // „ÄêÂä®ÁîªÂÆπÈîô„ÄëÂú®Ë∞ÉÁî® animateValue ‰πãÂâçÔºåÊ∑ªÂä† if (isNaN(value)) value = 0; ÁöÑÂà§Êñ≠
            if (isNaN(start)) start = 0;
            if (isNaN(end)) end = 0;
            
            start = Number(start) || 0;
            end = Number(end) || 0;
            
            animateValue(element, start, end, duration, useFormat);
        }

        /**
         * „Äê‰∫∫Ê†ºÊéíË°åÊ∏≤ÊüìÂáΩÊï∞„ÄëÁã¨Á´ãÁöÑ renderPersonalityRank ÂáΩÊï∞ÔºåÂåÖÂê´ÂâçÁ´ØËá™ËÆ°ÁÆóÈôçÁ∫ßÈÄªËæë
         * @param {Array} rankData - ‰∫∫Ê†ºÊéíË°åÊï∞ÊçÆ [{type, count, percentage}]
         * @param {Array} recentVictims - ÊúÄËøëÂèóÂÆ≥ËÄÖÊï∞ÊçÆÔºàÁî®‰∫éÈôçÁ∫ßËÆ°ÁÆóÔºâ
         */
        function renderPersonalityRank(rankData, recentVictims = []) {
            const personalityEl = document.getElementById('personalityDistribution');
            if (!personalityEl) {
                console.warn('[‰∫∫Ê†ºÊéíË°å] ‚ùå DOM ÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                return;
            }
            
            // Â¶ÇÊûúÂêéÁ´Ø personalityRank Â≠òÂú®‰∏î‰∏ç‰∏∫Á©∫ÔºåÁõ¥Êé•Ê∏≤Êüì
            if (rankData && Array.isArray(rankData) && rankData.length > 0) {
                personalityEl.innerHTML = rankData.map((item, i) => {
                    const type = item.type || 'Êú™Áü•';
                    const count = Number(item.count || 0);
                    const percentage = Number(item.percentage || 0);
                    return `
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                <span class="text-zinc-400">${i+1}. ${type}</span>
                                <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                            </div>
                            <div class="w-full bg-zinc-800/50 h-1">
                                <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                console.log(`[‰∫∫Ê†ºÊéíË°å] ‚úÖ Ê∏≤ÊüìÊàêÂäü (${rankData.length} Êù°)`);
                return;
            }
            
            // „ÄêÂâçÁ´ØËá™ËÆ°ÁÆóÈôçÁ∫ßÈÄªËæë„ÄëËã•ÂêéÁ´Ø personalityRank ‰∏∫Á©∫ÔºåÂàôÊ†πÊçÆ recentVictims ÂÆûÊó∂ËÆ°ÁÆóÂç†ÊØîÂπ∂Ê∏≤ÊüìËøõÂ∫¶Êù°
            if (recentVictims && recentVictims.length > 0) {
                console.log('[‰∫∫Ê†ºÊéíË°å] ‚ö†Ô∏è personalityRank ‰∏∫Á©∫Ôºå‰ΩøÁî® recentVictims ÈôçÁ∫ßÊñπÊ°à');
                const typeMap = new Map();
                recentVictims.forEach((v) => {
                    const type = v.type || v.personality_type || 'UNKNOWN';
                    typeMap.set(type, (typeMap.get(type) || 0) + 1);
                });
                
                const total = recentVictims.length;
                const personalityRank = Array.from(typeMap.entries())
                    .map(([type, count]) => ({
                        type: type,
                        count: Number(count) || 0,
                        percentage: Math.round((Number(count) / total) * 100) || 0,
                    }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                personalityEl.innerHTML = personalityRank.map((item, i) => {
                    const type = item.type || 'Êú™Áü•';
                    const count = Number(item.count || 0);
                    const percentage = Number(item.percentage || 0);
                    return `
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                <span class="text-zinc-400">${i+1}. ${type}</span>
                                <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                            </div>
                            <div class="w-full bg-zinc-800/50 h-1">
                                <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                console.log(`[‰∫∫Ê†ºÊéíË°å] ‚úÖ ÈôçÁ∫ßÊñπÊ°àÊ∏≤ÊüìÊàêÂäü (${personalityRank.length} Êù°)`);
                return;
            }
            
            // Â¶ÇÊûúÈÉΩÊ≤°ÊúâÊï∞ÊçÆÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ
            personalityEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">ÊöÇÊó†Êï∞ÊçÆ</div>';
            console.warn('[‰∫∫Ê†ºÊéíË°å] ‚ùå Êó†ÂèØÁî®Êï∞ÊçÆ');
        }

        /**
         * ÂêØÂä® Supabase Realtime ÁõëÂê¨
         * ÁõëÂê¨ user_analysis Ë°®ÁöÑ INSERT ‰∫ã‰ª∂
         */
        function startRealtimeListener() {
            // ÂÅ•Â£ÆÊÄßÊ£ÄÊü•ÔºöÁ°Æ‰øù Supabase ÂÆ¢Êà∑Á´ØÂ∑≤ÂàùÂßãÂåñ
            if (!supabaseClient) {
                console.warn('[Realtime] ‚ö†Ô∏è Supabase ÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñÔºåË∑≥Ëøá Realtime ÁõëÂê¨');
                return;
            }

            // Â¶ÇÊûúÂ∑≤ÊúâÁõëÂê¨ÈÄöÈÅìÔºåÂÖàÂèñÊ∂àËÆ¢ÈòÖ
            if (realtimeChannel) {
                try {
                    supabaseClient.removeChannel(realtimeChannel);
                    console.log('[Realtime] ‚úÖ Â∑≤ÂèñÊ∂àÊóßÁöÑÁõëÂê¨ÈÄöÈÅì');
                } catch (error) {
                    console.warn('[Realtime] ‚ö†Ô∏è ÂèñÊ∂àÊóßÈÄöÈÅìÊó∂Âá∫Èîô:', error);
                }
            }

            try {
                // ÂàõÂª∫Êñ∞ÁöÑÁõëÂê¨ÈÄöÈÅì
                realtimeChannel = supabaseClient
                    .channel('user_analysis_changes')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'user_analysis'
                        },
                        (payload) => {
                            console.log('[Realtime] üì® Êî∂Âà∞Êñ∞Êï∞ÊçÆ:', payload);
                            
                            // ÂÅ•Â£ÆÊÄßÊ£ÄÊü•ÔºöÁ°Æ‰øù payload Âíå payload.new Â≠òÂú®
                            if (!payload || !payload.new) {
                                console.warn('[Realtime] ‚ö†Ô∏è Êï∞ÊçÆÊ†ºÂºè‰∏çÂÆåÊï¥ÔºåË∑≥ËøáÂ§ÑÁêÜ');
                                return;
                            }

                            const newRecord = payload.new;
                            
                            // Â±ÄÈÉ®Êõ¥Êñ∞ÔºöÂ∞ÜÊñ∞Êï∞ÊçÆÊèíÂÖ•Âà∞ latestRecords ÊúÄÂâçÈù¢
                            if (!Array.isArray(latestRecords)) {
                                latestRecords = [];
                            }
                            
                            latestRecords.unshift(newRecord);
                            
                            // ÈïøÂ∫¶ÊéßÂà∂Ôºö‰øùÊåÅÊï∞ÁªÑÈïøÂ∫¶‰∏çË∂ÖËøá 10
                            if (latestRecords.length > 10) {
                                latestRecords = latestRecords.slice(0, 10);
                            }

                            // ÂêåÊ≠•Êõ¥Êñ∞ window.allDataÔºàÁî®‰∫é LPDEF ‰∏ìÂÆ∂Á≠õÈÄâÔºâ
                            if (!window.allData) {
                                window.allData = [];
                            }
                            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÔºàÈÅøÂÖçÈáçÂ§çÔºâ
                            const exists = window.allData.some(item => 
                                (item.id && newRecord.id && item.id === newRecord.id) ||
                                (item.name === newRecord.name && item.created_at === newRecord.created_at)
                            );
                            if (!exists) {
                                window.allData.unshift(newRecord);
                                // ÈôêÂà∂ allData ÈïøÂ∫¶Ôºà‰øùÁïôÊúÄËøë 1000 Êù°ÔºåÈÅøÂÖçÂÜÖÂ≠òËøáÂ§ßÔºâ
                                if (window.allData.length > 1000) {
                                    window.allData = window.allData.slice(0, 1000);
                                }
                            }
                            
                            console.log(`[Realtime] ‚úÖ Â∑≤Êõ¥Êñ∞ latestRecords (ÂΩìÂâçÈïøÂ∫¶: ${latestRecords.length})Ôºåwindow.allData (ÂΩìÂâçÈïøÂ∫¶: ${window.allData.length})`);

                            // ÈáçÊñ∞Ê∏≤ÊüìÂè≥‰æßÂç°ÁâáÂàóË°®
                            try {
                                renderRecentActivity(latestRecords);
                                console.log('[Realtime] ‚úÖ Â∑≤Âà∑Êñ∞ÂÆûÊó∂ËØäÊñ≠Ê¥ªÂä®ÂàóË°®');
                            } catch (error) {
                                console.error('[Realtime] ‚ùå Ê∏≤ÊüìÊ¥ªÂä®ÂàóË°®Â§±Ë¥•:', error);
                            }
                            
                            // Realtime Êõ¥Êñ∞Âêé‰∏çÂÜçÈúÄË¶ÅÈáçÊñ∞Ê∏≤Êüì LPDEF Âç°ÁâáÔºàÂ∑≤Â∫üÂºÉÔºâ

                            // Âú∞ÂõæËÅîÂä®ÁâπÊïàÔºöÂ¶ÇÊûúÊñ∞Êï∞ÊçÆÂåÖÂê´Âú∞ÁêÜ‰ΩçÁΩÆ‰ø°ÊÅØÔºåËß¶ÂèëÂú∞ÂõæËÑâÂÜ≤
                            try {
                                // Â∞ùËØï‰ªéÊñ∞Êï∞ÊçÆ‰∏≠ÊèêÂèñÁªèÁ∫¨Â∫¶‰ø°ÊÅØ
                                // Ê†πÊçÆÂÆûÈôÖÊï∞ÊçÆÂ≠óÊÆµË∞ÉÊï¥ÔºàÂèØËÉΩÊòØ lng/lat, longitude/latitude, location Á≠âÔºâ
                                let lng = null;
                                let lat = null;
                                let vibeName = '';

                                // ÊñπÂºè1ÔºöÁõ¥Êé•Â≠óÊÆµÔºà‰ºòÂÖàÊ£ÄÊü•ÁªèÁ∫¨Â∫¶Â≠óÊÆµÔºâ
                                if (newRecord.lng !== undefined && newRecord.lat !== undefined) {
                                    lng = Number(newRecord.lng);
                                    lat = Number(newRecord.lat);
                                } else if (newRecord.longitude !== undefined && newRecord.latitude !== undefined) {
                                    lng = Number(newRecord.longitude);
                                    lat = Number(newRecord.latitude);
                                }
                                // ÊñπÂºè2Ôºö‰ªé location Êàñ ip_location Â≠óÊÆµËß£ÊûêÔºàÂ¶ÇÊûúÂåÖÂê´ÂùêÊ†áÔºâ
                                else {
                                    const locationSource = newRecord.location || newRecord.ip_location;
                                    if (locationSource) {
                                        // Â∞ùËØïËß£Êûê "lng,lat" Ê†ºÂºèÁöÑÂùêÊ†áÂ≠óÁ¨¶‰∏≤
                                        const locationStr = String(locationSource);
                                        const coords = locationStr.split(',');
                                        if (coords.length >= 2) {
                                            const parsedLng = Number(coords[0].trim());
                                            const parsedLat = Number(coords[1].trim());
                                            if (!isNaN(parsedLng) && !isNaN(parsedLat)) {
                                                lng = parsedLng;
                                                lat = parsedLat;
                                            }
                                        }
                                    }
                                }

                                // ÊèêÂèñÂêçÁß∞ÔºàÂèØËÉΩÊòØ name, vibe_name, personality_type Á≠âÔºâ
                                const baseName = newRecord.name || newRecord.vibe_name || newRecord.personality_type || '';

                                // VPN Á©øÈÄèÊ£ÄÊµãÂà§ÂÆöÈÄªËæëÔºàÂ∑≤ÁßªÈô§VPNÂÖ≥ÈîÆÂ≠óÊòæÁ§∫Ôºâ
                                // =========================
                                let pulseColor = '#ffffff'; // ÈªòËÆ§ÁôΩËâ≤ÔºàÊ≠£Â∏∏Áî®Êà∑Ôºâ
                                let pulseLabel = baseName ? `${baseName}` : 'Áî®Êà∑';

                                // Ëé∑ÂèñÂà§ÂÆöÊâÄÈúÄÂ≠óÊÆµ
                                const ipLocation = String(newRecord.ip_location || '').toUpperCase().trim();
                                const timezone = String(newRecord.timezone || '').trim();

                                // Âà§ÂÆöÊù°‰ª∂ÔºöÂ¶ÇÊûú ip_location ‰∏çÂ±û‰∫é 'CN'Ôºå‰ΩÜ timezone ÊòØ 'Asia/Shanghai'ÔºåÂàô‰ΩøÁî®ÁâπÊÆäÈ¢úËâ≤
                                const isNotChina = ipLocation !== 'CN' && ipLocation !== '';
                                const isShanghaiTimezone = timezone === 'Asia/Shanghai';

                                if (isNotChina && isShanghaiTimezone) {
                                    // ÁâπÊÆäÁî®Êà∑ÔºöÊµ∑Â§ñ IP + ‰∏äÊµ∑Êó∂Âå∫
                                    pulseColor = '#00ff41'; // ÁªàÁ´ØÁªø
                                    pulseLabel = baseName ? `${baseName}` : 'Áî®Êà∑';
                                    console.log('[Realtime] üîç Áî®Êà∑Âà§ÂÆö: Ê£ÄÊµãÂà∞ÁâπÊÆäÁî®Êà∑', {
                                        ipLocation,
                                        timezone,
                                        reason: 'Êµ∑Â§ñIP‰ΩÜÊó∂Âå∫‰∏∫Asia/Shanghai'
                                    });
                                } else {
                                    // Ê≠£Â∏∏Áî®Êà∑ÔºöÁõ¥Êé•ËøûÊé•
                                    pulseColor = '#ffffff'; // Ê≠£Â∏∏Áî®Êà∑ÔºöÁ∫ØÁôΩËâ≤
                                    pulseLabel = baseName ? `${baseName}` : 'Áî®Êà∑';
                                    console.log('[Realtime] üîç Áî®Êà∑Âà§ÂÆö: Ê≠£Â∏∏Áî®Êà∑', {
                                        ipLocation,
                                        timezone,
                                        reason: isNotChina ? 'Êó∂Âå∫‰∏çÂåπÈÖç' : 'IP‰ΩçÁΩÆÊ≠£Â∏∏'
                                    });
                                }

                                // Â¶ÇÊûúÊàêÂäüÊèêÂèñÂà∞ÁªèÁ∫¨Â∫¶ÔºåËß¶ÂèëÂú∞ÂõæËÑâÂÜ≤Ôºà‰ΩøÁî®Âà§ÂÆöÂêéÁöÑÈ¢úËâ≤ÂíåÊ†áÁ≠æÔºâ
                                if (lng !== null && lat !== null && !isNaN(lng) && !isNaN(lat)) {
                                    // ÊèêÂèñÂ§¥ÂÉè‰ø°ÊÅØ
                                    let avatarUrl = newRecord.avatar_url || null;
                                    const githubUsername = newRecord.github_username || newRecord.github_id || null;
                                    const userName = newRecord.name || newRecord.vibe_name || newRecord.personality_type || '';
                                    
                                    // Âà§Êñ≠ÈÄªËæëÔºöÂ¶ÇÊûú github_username ‰∏∫Á©∫„ÄÅÊàñËÄÖÊòØÈªòËÆ§ÂÄºÔºåÂàô‰∏çË¶ÅËØ∑Ê±Ç GitHub ÂõæÁâá
                                    // „ÄêTask 3„Äë‰º†ÂÖ• user_identityÔºåÂØπ fingerprint Áî®Êà∑Ë∑≥Ëøá‰∏•Ê†ºÊ†°È™å
                                    const recordUserIdentity = newRecord.user_identity || null;
                                    if (!avatarUrl && githubUsername) {
                                        if (isValidGitHubUsername(githubUsername, recordUserIdentity)) {
                                            // Âè™ÊúâÊúâÊïàÁöÑGitHubÁî®Êà∑ÂêçÊâçÁîüÊàêÂ§¥ÂÉèURL
                                            avatarUrl = getGitHubAvatarUrl(githubUsername);
                                        } else {
                                            // Êó†ÊïàÁî®Êà∑ÂêçÊó∂Ôºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                                            avatarUrl = DEFAULT_AVATAR;
                                        }
                                    }
                                    // Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÊúâÊïàÁöÑÂ§¥ÂÉèURLÔºå‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                                    if (!avatarUrl) {
                                        avatarUrl = DEFAULT_AVATAR;
                                    }
                                    
                                    // Ëé∑ÂèñÁî®Êà∑Áä∂ÊÄÅÈ¢úËâ≤ÔºàÂ¶ÇÊûúÂ≠òÂú®ÔºâÔºåÂê¶Âàô‰ΩøÁî®ÈªòËÆ§È¢úËâ≤
                                    const statusColor = newRecord.status_color || pulseColor;
                                    
                                    triggerMapPulse(lng, lat, pulseLabel, statusColor, avatarUrl, githubUsername || userName);
                                    console.log(`[Realtime] ‚úÖ Â∑≤Ëß¶ÂèëÂú∞ÂõæËÑâÂÜ≤: [${lng}, ${lat}] ${pulseLabel} (È¢úËâ≤: ${statusColor}, Â§¥ÂÉè: ${avatarUrl}, Áî®Êà∑Âêç: ${githubUsername || userName})`);
                                } else {
                                    console.log('[Realtime] ‚ÑπÔ∏è Êñ∞Êï∞ÊçÆÊú™ÂåÖÂê´ÊúâÊïàÁöÑÂú∞ÁêÜ‰ΩçÁΩÆ‰ø°ÊÅØÔºåË∑≥ËøáÂú∞ÂõæËÑâÂÜ≤');
                                }
                            } catch (error) {
                                console.warn('[Realtime] ‚ö†Ô∏è Â§ÑÁêÜÂú∞ÂõæËÅîÂä®ÁâπÊïàÊó∂Âá∫Èîô:', error);
                            }
                        }
                    )
                    .on(
                        'postgres_changes',
                        {
                            event: 'UPDATE',
                            schema: 'public',
                            table: 'user_analysis'
                        },
                        (payload) => {
                            console.log('[Realtime] üîÑ Êî∂Âà∞Êï∞ÊçÆÊõ¥Êñ∞:', payload);
                            
                            // ÂÅ•Â£ÆÊÄßÊ£ÄÊü•ÔºöÁ°Æ‰øù payload Âíå payload.new Â≠òÂú®
                            if (!payload || !payload.new) {
                                console.warn('[Realtime] ‚ö†Ô∏è Êõ¥Êñ∞Êï∞ÊçÆÊ†ºÂºè‰∏çÂÆåÊï¥ÔºåË∑≥ËøáÂ§ÑÁêÜ');
                                return;
                            }

                            const updatedRecord = payload.new;
                            
                            // ÂêåÊ≠•Êõ¥Êñ∞ window.allDataÔºàÁî®‰∫éË∫´‰ªΩÂåπÈÖçÂíåÊéíÂêçÂç°ÁâáÔºâ
                            if (!window.allData) {
                                window.allData = [];
                            }
                            
                            // Êü•ÊâæÂπ∂Êõ¥Êñ∞ÂØπÂ∫îÁöÑËÆ∞ÂΩï
                            const index = window.allData.findIndex(item => 
                                (item.id && updatedRecord.id && item.id === updatedRecord.id) ||
                                (item.fingerprint && updatedRecord.fingerprint && item.fingerprint === updatedRecord.fingerprint) ||
                                (item.user_identity && updatedRecord.user_identity && item.user_identity === updatedRecord.user_identity)
                            );
                            
                            if (index !== -1) {
                                // Êõ¥Êñ∞Áé∞ÊúâËÆ∞ÂΩï
                                window.allData[index] = { ...window.allData[index], ...updatedRecord };
                                console.log(`[Realtime] ‚úÖ Â∑≤Êõ¥Êñ∞ window.allData ‰∏≠ÁöÑËÆ∞ÂΩï (Á¥¢Âºï: ${index})`);
                            } else {
                                // Â¶ÇÊûúÊ≤°ÊâæÂà∞ÔºåÊ∑ªÂä†Âà∞Êï∞ÁªÑÂâçÈù¢
                                window.allData.unshift(updatedRecord);
                                // ÈôêÂà∂ allData ÈïøÂ∫¶
                                if (window.allData.length > 1000) {
                                    window.allData = window.allData.slice(0, 1000);
                                }
                                console.log(`[Realtime] ‚úÖ Â∑≤Â∞ÜÊõ¥Êñ∞ËÆ∞ÂΩïÊ∑ªÂä†Âà∞ window.allData`);
                            }
                            
                            // Ê£ÄÊü•Êõ¥Êñ∞ÁöÑËÆ∞ÂΩïÊòØÂê¶ÊòØÂΩìÂâçÁî®Êà∑ÔºåÂ¶ÇÊûúÊòØÂàôÂà∑Êñ∞ÊéíÂêçÂç°Áâá
                            // ÂÆûÊó∂Êõ¥Êñ∞ÔºöÁ°Æ‰øùÂÜçÊ¨°Ëß¶Âèë renderRankCards(currentUser)ÔºåËÆ©Âç°ÁâáÊï∞Â≠óËÉΩÂ§üÈöèÁùÄÊï∞ÊçÆÂ∫ìÂÆûÊó∂ÂèòÂä®
                            try {
                                // ËæÖÂä©ÂáΩÊï∞ÔºöËßÑËåÉÂåñÊåáÁ∫πÂ≠óÁ¨¶‰∏≤ÔºàÂøΩÁï•Â§ßÂ∞èÂÜôÂπ∂ÂâîÈô§È¶ñÂ∞æÁ©∫Ê†ºÔºâ
                                const normalizeFingerprint = (fp) => {
                                    if (!fp) return '';
                                    return String(fp).trim().toLowerCase();
                                };
                                
                                // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÁöÑÊ†áËØÜ‰ø°ÊÅØÔºàÂ¢ûÂä†ÂºÇÂ∏∏Â§ÑÁêÜÔºâ
                                let localGitHubName = null;
                                let currentFingerprint = null;
                                try {
                                    localGitHubName = localStorage.getItem('github_username');
                                    currentFingerprint = localStorage.getItem('user_fingerprint');
                                } catch (e) {
                                    console.warn('[Realtime] ‚ö†Ô∏è ËØªÂèñ localStorage Â§±Ë¥•:', e);
                                }
                                
                                const urlParams = new URLSearchParams(window.location.search);
                                const urlId = urlParams.get('id');
                                
                                // ËßÑËåÉÂåñÂΩìÂâçÊåáÁ∫π
                                const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                                
                                // Âà§Êñ≠ÊòØÂê¶ÊòØÂΩìÂâçÁî®Êà∑ÁöÑËÆ∞ÂΩïÔºà‰ºòÂÖàÁ∫ßÂåπÈÖçÁ≠ñÁï•ÔºöÊåáÁ∫π‰ºòÂÖà > GitHub IDÔºâ
                                let isCurrentUser = false;
                                let matchedByFingerprint = false;
                                
                                // ÊñπÂºè1ÔºöÈÄöËøá URL ÂèÇÊï∞ÂåπÈÖçÔºàÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºåÁî®‰∫éË∞ÉËØïÔºâ
                                if (urlId) {
                                    const recordId = (updatedRecord.id || '').toString();
                                    const recordFingerprint = (updatedRecord.fingerprint || updatedRecord.user_identity || '').toString();
                                    if (recordId === urlId || recordFingerprint === urlId) {
                                        isCurrentUser = true;
                                    }
                                }
                                
                                // ÊñπÂºè2ÔºöÈÄöËøá Fingerprint ÂåπÈÖçÔºà‰ºòÂÖà‰∫éGitHub IDÔºåÂøΩÁï•Â§ßÂ∞èÂÜôÂíåÁ©∫Ê†ºÔºâ
                                if (!isCurrentUser && normalizedCurrentFingerprint) {
                                    const recordFingerprint = normalizeFingerprint(updatedRecord.fingerprint || updatedRecord.user_fingerprint);
                                    const recordIdentity = normalizeFingerprint(updatedRecord.user_identity);
                                    
                                    if ((recordFingerprint && recordFingerprint === normalizedCurrentFingerprint) ||
                                        (recordIdentity && recordIdentity === normalizedCurrentFingerprint)) {
                                        isCurrentUser = true;
                                        matchedByFingerprint = true;
                                    }
                                }
                                
                                // ÊñπÂºè3ÔºöÈÄöËøá GitHub ID ÂåπÈÖçÔºàÂú®ÊåáÁ∫πÂåπÈÖçÂ§±Ë¥•ÂêéÂ∞ùËØïÔºâ
                                if (!isCurrentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                                    // „Äê‰øÆÂ§ç„ÄëÁªü‰∏Ä‰ΩøÁî® user_name Â≠óÊÆµÔºå‰∏ç‰ΩøÁî® github_username
                                    const recordGithubId = normalizeFingerprint(updatedRecord.user_name || updatedRecord.github_id || '');
                                    const normalizedLocalGitHub = normalizeFingerprint(localGitHubName);
                                    if (recordGithubId && recordGithubId === normalizedLocalGitHub) {
                                        isCurrentUser = true;
                                    }
                                }
                                
                                // Â¶ÇÊûúÊòØÂΩìÂâçÁî®Êà∑ÁöÑËÆ∞ÂΩïÔºåÂà∑Êñ∞ÊéíÂêçÂç°ÁâáÂíåÂÖ®Â±ÄÂèòÈáè
                                if (isCurrentUser) {
                                    console.log('[Realtime] ‚úÖ Ê£ÄÊµãÂà∞ÂΩìÂâçÁî®Êà∑Êï∞ÊçÆÊõ¥Êñ∞ÔºåÂà∑Êñ∞ÊéíÂêçÂç°Áâá');
                                    
                                    // Êõ¥Êñ∞ÂÖ®Â±ÄÂèòÈáè
                                    window.currentUser = updatedRecord;
                                    window.currentUserMatchedByFingerprint = matchedByFingerprint;
                                    
                                    // Êõ¥Êñ∞ window.allData ‰∏≠ÁöÑÂØπÂ∫îËÆ∞ÂΩï
                                    const allData = window.allData || [];
                                    const updateIndex = allData.findIndex(item => {
                                        const itemFingerprint = normalizeFingerprint(item.fingerprint || item.user_fingerprint);
                                        const itemIdentity = normalizeFingerprint(item.user_identity);
                                        const recordFingerprint = normalizeFingerprint(updatedRecord.fingerprint || updatedRecord.user_fingerprint);
                                        const recordIdentity = normalizeFingerprint(updatedRecord.user_identity);
                                        
                                        return (itemFingerprint && itemFingerprint === recordFingerprint) ||
                                               (itemIdentity && itemIdentity === recordIdentity) ||
                                               (item.id && item.id === updatedRecord.id);
                                    });
                                    
                                    if (updateIndex !== -1) {
                                        allData[updateIndex] = updatedRecord;
                                        window.allData = allData;
                                    } else {
                                        // Â¶ÇÊûúÊ≤°ÊâæÂà∞ÔºåÊ∑ªÂä†Âà∞Êï∞ÁªÑ
                                        allData.push(updatedRecord);
                                        window.allData = allData;
                                    }
                                    
                                    // ‰ΩøÁî®Êõ¥Êñ∞ÂêéÁöÑËÆ∞ÂΩïÁõ¥Êé•Ê∏≤ÊüìÔºåÁ°Æ‰øùÂç°ÁâáÊï∞Â≠óËÉΩÂ§üÂÆûÊó∂ÂèòÂä®
                                    renderRankCards(updatedRecord);
                                } else {
                                    console.debug('[Realtime] ‚ÑπÔ∏è Êõ¥Êñ∞ÁöÑËÆ∞ÂΩï‰∏çÊòØÂΩìÂâçÁî®Êà∑ÔºåË∑≥ËøáÊéíÂêçÂç°ÁâáÂà∑Êñ∞');
                                }
                            } catch (error) {
                                console.error('[Realtime] ‚ùå Âà∑Êñ∞ÊéíÂêçÂç°ÁâáÂ§±Ë¥•:', error);
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('[Realtime] ‚úÖ Â∑≤ÊàêÂäüËÆ¢ÈòÖ user_analysis Ë°®ÁöÑ INSERT Âíå UPDATE ‰∫ã‰ª∂');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('[Realtime] ‚ùå ËÆ¢ÈòÖÈÄöÈÅìÈîôËØØ');
                        } else {
                            console.log(`[Realtime] ‚ÑπÔ∏è ËÆ¢ÈòÖÁä∂ÊÄÅ: ${status}`);
                        }
                    });

                console.log('[Realtime] üöÄ Realtime ÁõëÂê¨Â∑≤ÂêØÂä®');

                // =========================
                // Supabase Presence ÂäüËÉΩÔºöÁªüËÆ°ÂÆûÊó∂Âú®Á∫ø‰∫∫Êï∞
                // =========================
                
                // Â¶ÇÊûúÂ∑≤Êúâ Presence È¢ëÈÅìÔºåÂÖàÂèñÊ∂àËÆ¢ÈòÖ
                if (presenceChannel) {
                    try {
                        supabaseClient.removeChannel(presenceChannel);
                        console.log('[Presence] ‚úÖ Â∑≤ÂèñÊ∂àÊóßÁöÑ Presence È¢ëÈÅì');
                    } catch (error) {
                        console.warn('[Presence] ‚ö†Ô∏è ÂèñÊ∂àÊóß Presence È¢ëÈÅìÊó∂Âá∫Èîô:', error);
                    }
                }

                try {
                    // ÂàõÂª∫Âêç‰∏∫ online_users ÁöÑ Presence È¢ëÈÅì
                    presenceChannel = supabaseClient
                        .channel('online_users')
                        .on('presence', { event: 'sync' }, () => {
                            // sync ÂõûË∞ÉÔºöËé∑ÂèñÂΩìÂâçÂú®Á∫øÁöÑÊâÄÊúâÁä∂ÊÄÅÂØπË±°
                            const newState = presenceChannel.presenceState();
                            
                            // Ë∞ÉËØïÊó•ÂøóÔºöËæìÂá∫ÊâÄÊúâÂêåÊ≠•Âà∞ÁöÑÁî®Êà∑
                            console.log('[Presence] ÂΩìÂâçÂêåÊ≠•Âà∞ÁöÑÊâÄÊúâÁî®Êà∑:', newState);
                            
                            // ËÆ°ÁÆóÂú®Á∫ø‰∫∫Êï∞ÔºöÈÅçÂéÜÊâÄÊúâÁä∂ÊÄÅÂØπË±°Âπ∂ËÆ°ÁÆóÊÄªÊï∞Ôºà‰ΩøÁî® user_name ÂéªÈáçÔºâ
                            const userMap = new Map();
                            if (newState) {
                                Object.keys(newState).forEach((key) => {
                                    const presenceEntries = newState[key];
                                    const entries = Array.isArray(presenceEntries) ? presenceEntries : [presenceEntries];
                                    
                                    entries.forEach(entry => {
                                        if (!entry || !entry.online_at) return;
                                        // ‰ΩøÁî® user_name ‰Ωú‰∏∫ÂéªÈáçÈîÆ
                                        const userName = entry.user_name || entry.github_id || entry.github_username || 'Guest';
                                        if (!userMap.has(userName) || new Date(entry.online_at) > new Date(userMap.get(userName).online_at)) {
                                            userMap.set(userName, entry);
                                        }
                                    });
                                });
                            }
                            
                            // Ê≥®ÊÑèÔºö‰∏çÊéíÈô§ÂΩìÂâçÁî®Êà∑Ëá™Â∑±ÔºåÂõ†‰∏∫Áî®Êà∑Ë¶ÅÊ±ÇÂú®ÂàóË°®‰∏≠ÂèØËßÅ
                            const onlineCount = userMap.size;
                            console.log('[Presence] üë• Âú®Á∫ø‰∫∫Êï∞ÂêåÊ≠•ÔºàÂéªÈáçÂêéÔºåÂåÖÂê´Ëá™Â∑±Ôºâ:', onlineCount);

                            // Êõ¥Êñ∞È°µÈù¢‰∏ä #online-count-value ÁöÑÊï∞Â≠óÔºàÂú∞Âõæ‰∏äÁöÑÔºâ
                            const onlineCountElement = document.getElementById('online-count-value');
                            if (onlineCountElement) {
                                // Ê∑ªÂä†Áº©ÊîæÂä®ÁîªÁ±ª
                                onlineCountElement.classList.add('online-count-update');
                                
                                // Êõ¥Êñ∞Êï∞Â≠ó
                                onlineCountElement.textContent = onlineCount;
                                
                                // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§Á±ªÔºà‰ª•‰æø‰∏ãÊ¨°Êõ¥Êñ∞Êó∂ÂèØ‰ª•ÂÜçÊ¨°Ëß¶ÂèëÂä®ÁîªÔºâ
                                setTimeout(() => {
                                    onlineCountElement.classList.remove('online-count-update');
                                }, 400); // ‰∏é CSS Âä®ÁîªÊó∂Èïø‰∏ÄËá¥
                                
                                console.log('[Presence] ‚úÖ Â∑≤Êõ¥Êñ∞Âú®Á∫ø‰∫∫Êï∞ÊòæÁ§∫ÔºàÂú∞ÂõæÔºâ:', onlineCount);
                            } else {
                                console.warn('[Presence] ‚ö†Ô∏è Êâæ‰∏çÂà∞ #online-count-value ÂÖÉÁ¥†');
                            }
                            
                            // Êõ¥Êñ∞ÊäΩÂ±â‰∏≠ÁöÑÂú®Á∫ø‰∫∫Êï∞ÔºàÂç≥‰ΩøÊäòÂè†Áä∂ÊÄÅ‰πüË¶ÅÊõ¥Êñ∞Ôºâ
                            const onlineCountText = document.getElementById('online-count-text');
                            if (onlineCountText) {
                                onlineCountText.textContent = onlineCount;
                            }
                            
                            // Ê∏≤ÊüìÁî®Êà∑ÂàóË°®Ôºà‰ΩøÁî® updateOnlineList Á°Æ‰øùËé∑ÂèñÊúÄÊñ∞Áä∂ÊÄÅÔºâ
                            updateOnlineList();
                        })
                        .on('broadcast', { event: 'burn_msg' }, ({ payload }) => {
                            // Êé•Êî∂ÁßÅ‰ø°ÔºàÈòÖÂêéÂç≥ÁÑöÊ∂àÊÅØÔºâ
                            console.log('[Message] Êî∂Âà∞ÂéüÂßãÂπøÊí≠:', payload);
                            
                            const githubUsername = localStorage.getItem('github_username') || null;
                            const myId = githubUsername;
                            
                            // Ê£ÄÊü•ÊòØÂê¶ÊòØÂèëÁªôÂΩìÂâçÁî®Êà∑ÁöÑÊ∂àÊÅØ
                            // Áªü‰∏Ä‰ΩøÁî® target_id Êàñ to Â≠óÊÆµËøõË°åÂåπÈÖçÔºåÊîØÊåÅ GitHub ID Âíå user_name
                            const targetId = payload.target_id || payload.to;
                            const isForMe = targetId === myId || 
                                          targetId === githubUsername || 
                                          (!myId && targetId === 'Guest');
                            
                            if (payload && isForMe) {
                                console.log('[Message] üì® Êî∂Âà∞ÁßÅ‰ø°:', payload);
                                const content = payload.content || payload.message || '';
                                const fromId = payload.from || 'Unknown';
                                const statusColor = payload.status_color || '#00ff41';
                                
                                showBurnMsg(content, fromId, statusColor);
                            } else {
                                console.log('[Message] ‚ö†Ô∏è Ê∂àÊÅØ‰∏çÊòØÂèëÁªôÊàëÁöÑ:', { targetId, myId, githubUsername });
                            }
                        })
                        .on('broadcast', { event: 'private_message' }, ({ payload }) => {
                            // ÂÖºÂÆπÊóßÁöÑ‰∫ã‰ª∂Âêç
                            console.log('[Message] Êî∂Âà∞ÂéüÂßãÂπøÊí≠ (private_message):', payload);
                            
                            const githubUsername = localStorage.getItem('github_username') || null;
                            const myId = githubUsername;
                            
                            const targetId = payload.target_id || payload.to;
                            const isForMe = targetId === myId || 
                                          targetId === githubUsername || 
                                          (!myId && targetId === 'Guest');
                            
                            if (payload && isForMe) {
                                console.log('[Message] üì® Êî∂Âà∞ÁßÅ‰ø° (ÂÖºÂÆπÊ®°Âºè):', payload);
                                const content = payload.content || payload.message || '';
                                const fromId = payload.from || 'Unknown';
                                const statusColor = payload.status_color || '#00ff41';
                                
                                showBurnMsg(content, fromId, statusColor);
                            }
                        })
                        .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                            console.log('[Presence] ‚ûï Áî®Êà∑Âä†ÂÖ•:', key, newPresences);
                        })
                        .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                            console.log('[Presence] ‚ûñ Áî®Êà∑Á¶ªÂºÄ:', key, leftPresences);
                        })
                        .subscribe(async (status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('[Presence] ‚úÖ Â∑≤ÊàêÂäüËÆ¢ÈòÖ online_users È¢ëÈÅì');
                                
                                // Âº∫Âà∂ÂêåÊ≠•Ëá™Ë∫´Áä∂ÊÄÅÔºàÂøÖÈ°ªÊòæÂºèË∞ÉÁî®Ôºâ
                                await trackSelf();
                            } else if (status === 'CHANNEL_ERROR') {
                                console.error('[Presence] ‚ùå Presence È¢ëÈÅìÈîôËØØ');
                            } else {
                                console.log(`[Presence] ‚ÑπÔ∏è Presence ËÆ¢ÈòÖÁä∂ÊÄÅ: ${status}`);
                            }
                        });

                    console.log('[Presence] üöÄ Presence ÁõëÂê¨Â∑≤ÂêØÂä®');
                } catch (presenceError) {
                    console.error('[Presence] ‚ùå ÂêØÂä® Presence ÁõëÂê¨Â§±Ë¥•:', presenceError);
                }

            } catch (error) {
                console.error('[Realtime] ‚ùå ÂêØÂä® Realtime ÁõëÂê¨Â§±Ë¥•:', error);
            }
        }

        /**
         * ÂÅúÊ≠¢ Supabase Realtime ÁõëÂê¨
         */
        function stopRealtimeListener() {
            // ÂÅúÊ≠¢ postgres_changes ÁõëÂê¨
            if (realtimeChannel && supabaseClient) {
                try {
                    supabaseClient.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                    console.log('[Realtime] ‚úÖ Â∑≤ÂÅúÊ≠¢ Realtime ÁõëÂê¨');
                } catch (error) {
                    console.warn('[Realtime] ‚ö†Ô∏è ÂÅúÊ≠¢ÁõëÂê¨Êó∂Âá∫Èîô:', error);
                }
            }

            // ÂÅúÊ≠¢ Presence ÁõëÂê¨
            if (presenceChannel && supabaseClient) {
                try {
                    // ÂÖàÂèñÊ∂àË∑üË∏™ÔºåÁÑ∂ÂêéÁßªÈô§È¢ëÈÅì
                    presenceChannel.untrack();
                    supabaseClient.removeChannel(presenceChannel);
                    presenceChannel = null;
                    console.log('[Presence] ‚úÖ Â∑≤ÂÅúÊ≠¢ Presence ÁõëÂê¨');
                } catch (error) {
                    console.warn('[Presence] ‚ö†Ô∏è ÂÅúÊ≠¢ Presence ÁõëÂê¨Êó∂Âá∫Èîô:', error);
                }
            }
        }

        /**
         * ËÆæÁΩÆÁî®Êà∑Áä∂ÊÄÅ
         * @param {string} status - Áä∂ÊÄÅÁ±ªÂûã ('idle', 'busy', 'sprint')
         */
        function setUserStatus(status) {
            if (!USER_STATUSES[status]) {
                console.warn('[Status] ‚ö†Ô∏è Êó†ÊïàÁöÑÁä∂ÊÄÅÁ±ªÂûã:', status);
                return;
            }
            
            currentUserStatus = status;
            localStorage.setItem('user_status', status);
            
            // Êõ¥Êñ∞ÊåâÈíÆÊ†∑Âºè
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnStatus = btn.getAttribute('data-status');
                if (btnStatus === status) {
                    btn.classList.add('active');
                    const statusConfig = USER_STATUSES[status];
                    btn.style.borderColor = statusConfig.color;
                    btn.style.color = statusConfig.color;
                } else {
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }
            });
            
            // Á´ãÂç≥ÂêåÊ≠•Áä∂ÊÄÅÂà∞Presence
            syncPresenceState();
            
            console.log('[Status] ‚úÖ Áî®Êà∑Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞:', status, USER_STATUSES[status]);
        }
        
        /**
         * ÂàùÂßãÂåñÁä∂ÊÄÅÊåâÈíÆÊ†∑Âºè
         */
        function initStatusButtons() {
            const savedStatus = localStorage.getItem('user_status') || 'idle';
            setUserStatus(savedStatus);
        }
        
        /**
         * Ëé∑ÂèñÁî®Êà∑Âú∞ÁêÜ‰ΩçÁΩÆÔºàÁªèÁ∫¨Â∫¶Ôºâ
         * @returns {Promise<Object>} ÂåÖÂê´ lat, lng ÁöÑÂØπË±°
         */
        async function getUserLocation() {
            try {
                // ‰ΩøÁî® ip-api.com API Ëé∑Âèñ IP ÂΩíÂ±ûÂú∞‰ø°ÊÅØ
                const ipResponse = await fetch('http://ip-api.com/json/', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (ipResponse.ok) {
                    const ipInfo = await ipResponse.json();
                    const lat = ipInfo.lat ? Number(ipInfo.lat) : null;
                    const lng = ipInfo.lon ? Number(ipInfo.lon) : null; // Ê≥®ÊÑèÔºöip-api.com ‰ΩøÁî® lon
                    return { lat, lng };
                }
            } catch (error) {
                console.warn('[Location] ‚ö†Ô∏è Ëé∑ÂèñÂú∞ÁêÜ‰ΩçÁΩÆÂ§±Ë¥•:', error);
            }
            return { lat: null, lng: null };
        }

        /**
         * Âº∫Âà∂ÂêåÊ≠•Ëá™Ë∫´Áä∂ÊÄÅÔºàtrackSelfÔºâ
         * Âú® SUBSCRIBED ÂõûË∞É‰∏≠ÊòæÂºèË∞ÉÁî®
         */
        async function trackSelf() {
            if (!presenceChannel) {
                console.warn('[Presence] ‚ö†Ô∏è PresenceÈ¢ëÈÅìÊú™ÂàùÂßãÂåñ');
                return;
            }
            
            try {
                // Ëé∑Âèñ GitHub Áî®Êà∑Âêç
                const ghUsername = localStorage.getItem('github_username') || null;
                
                // ÁîüÊàê user_name
                const userName = ghUsername && isValidGitHubUsername(ghUsername) 
                    ? ghUsername 
                    : `Guest_${Math.floor(Math.random() * 1000)}`;
                
                // ÁîüÊàê avatar_url
                const avatarUrl = ghUsername && isValidGitHubUsername(ghUsername)
                    ? `https://github.com/${ghUsername}.png`
                    : DEFAULT_AVATAR;
                
                // Ëé∑ÂèñÁä∂ÊÄÅ‰ø°ÊÅØ
                const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                const status = statusConfig.status || 'idle';
                const statusColor = statusConfig.status_color || '#00ff41';
                
                // Ëé∑ÂèñÁªèÁ∫¨Â∫¶
                const location = await getUserLocation();
                
                // ÊûÑÂª∫ Presence Êï∞ÊçÆ
                const myPresence = {
                    user_name: userName,
                    avatar_url: avatarUrl,
                    github_id: ghUsername || null,
                    github_username: ghUsername || null,
                    status: status,
                    status_color: statusColor,
                    online_at: new Date().toISOString(),
                    lat: location.lat,
                    lng: location.lng,
                    last_vibe: new Date().toISOString()
                };
                
                // ÊòæÂºèË∞ÉÁî® track
                await presenceChannel.track(myPresence);
                
                console.log('[Presence] ‚úÖ Ëá™Ë∫´Áä∂ÊÄÅÂ∑≤ÂêåÊ≠•:', myPresence);
            } catch (error) {
                console.error('[Presence] ‚ùå ÂêåÊ≠•Ëá™Ë∫´Áä∂ÊÄÅÂ§±Ë¥•:', error);
            }
        }

        /**
         * ÂêåÊ≠•PresenceÁä∂ÊÄÅÔºàÂåÖÂê´ÊâÄÊúâÁî®Êà∑‰ø°ÊÅØÔºâ
         * ÂÖºÂÆπÊóß‰ª£Á†ÅÔºåÂÜÖÈÉ®Ë∞ÉÁî® trackSelf
         */
        async function syncPresenceState() {
            await trackSelf();
        }
        
        /**
         * ÂàáÊç¢ÊäΩÂ±âÂ±ïÂºÄ/ÊäòÂè†Áä∂ÊÄÅ
         */
        function toggleDrawer() {
            drawerExpanded = !drawerExpanded;
            const drawer = document.getElementById('live-nodes-drawer');
            if (!drawer) return;
            
            if (drawerExpanded) {
                drawer.classList.remove('collapsed');
                drawer.classList.add('expanded');
            } else {
                drawer.classList.remove('expanded');
                drawer.classList.add('collapsed');
            }
            
            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem('drawer_expanded', drawerExpanded.toString());
            console.log('[Drawer] ‚úÖ ÊäΩÂ±âÁä∂ÊÄÅÂ∑≤ÂàáÊç¢:', drawerExpanded ? 'Â±ïÂºÄ' : 'ÊäòÂè†');
        }
        
        /**
         * ÂàùÂßãÂåñÊäΩÂ±âÁä∂ÊÄÅ
         */
        function initDrawerState() {
            const drawer = document.getElementById('live-nodes-drawer');
            if (!drawer) return;
            
            if (drawerExpanded) {
                drawer.classList.remove('collapsed');
                drawer.classList.add('expanded');
            } else {
                drawer.classList.remove('expanded');
                drawer.classList.add('collapsed');
            }
        }
        
        /**
         * Êõ¥Êñ∞Âú®Á∫øÁî®Êà∑ÂàóË°®ÔºàÊ†∏ÂøÉÊ∏≤ÊüìÈÄªËæëÔºâ
         * Âú® onlineChannel.on('presence', { event: 'sync' }) ÂõûË∞É‰∏≠Ë∞ÉÁî®
         */
        function updateOnlineList() {
            if (!presenceChannel) {
                console.warn('[UserList] ‚ö†Ô∏è PresenceÈ¢ëÈÅìÊú™ÂàùÂßãÂåñ');
                return;
            }
            
            // ÈÄöËøá onlineChannel.presenceState() Ëé∑ÂèñÊúÄÊñ∞Áä∂ÊÄÅ
            const state = presenceChannel.presenceState();
            renderOnlineUsersList(state);
        }
        
        /**
         * Ê∏≤ÊüìÂú®Á∫øÁî®Êà∑ÂàóË°®ÔºàÂàÜÁ±ªÊòæÁ§∫ÔºöÂ∑≤ÂÆûÂêç/ÂåøÂêçÔºâ
         * @param {Object} presenceState - PresenceÁä∂ÊÄÅÂØπË±°
         */
        function renderOnlineUsersList(presenceState) {
            const listContainer = document.getElementById('online-users-list');
            if (!listContainer) {
                console.warn('[UserList] ‚ö†Ô∏è Êâæ‰∏çÂà∞Áî®Êà∑ÂàóË°®ÂÆπÂô®');
                return;
            }
            
            // Âç≥Êó∂Ê∏ÖÁ©∫ÂÆπÂô®ÔºåÁßªÈô§ "Scanning..." ÊèêÁ§∫
            listContainer.innerHTML = '';
            
            // Êî∂ÈõÜÊâÄÊúâÁî®Êà∑Ôºå‰ΩøÁî® user_name ‰Ωú‰∏∫ÂéªÈáçÈîÆ
            const userMap = new Map();
            
            if (presenceState && Object.keys(presenceState).length > 0) {
                Object.keys(presenceState).forEach((key) => {
                    const presenceEntries = presenceState[key];
                    const entries = Array.isArray(presenceEntries) ? presenceEntries : [presenceEntries];
                    
                    entries.forEach(entry => {
                        if (!entry || !entry.online_at) return;
                        
                        // ‰ΩøÁî® user_name ‰Ωú‰∏∫ÂéªÈáçÈîÆ
                        const userName = entry.user_name || entry.github_id || entry.github_username || 'Guest';
                        
                        // ÂéªÈáçÈÄªËæëÔºöÂ¶ÇÊûúÂ∑≤Â≠òÂú®ËØ•Áî®Êà∑Ôºå‰øùÁïôÊúÄÊñ∞ÁöÑ
                        if (!userMap.has(userName) || new Date(entry.online_at) > new Date(userMap.get(userName).online_at)) {
                            userMap.set(userName, {
                                ...entry,
                                user_name: userName,
                                github_id: entry.github_id || entry.github_username || null,
                                github_username: entry.github_username || entry.github_id || null
                            });
                        }
                    });
                });
            }
            
            // Ê≥®ÊÑèÔºö‰∏çÊéíÈô§ÂΩìÂâçÁî®Êà∑Ëá™Â∑±ÔºåÂõ†‰∏∫Áî®Êà∑Ë¶ÅÊ±ÇÂú®ÂàóË°®‰∏≠ÂèØËßÅ
            
            // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ÂàÜÁ±ª
            const allUsers = Array.from(userMap.values());
            
            // ÂàÜÁ±ªÔºöÂ∑≤ÂÆûÂêçÁî®Êà∑ÔºàÊúâ github_id ‰∏î‰∏ç‰∏∫ÈªòËÆ§ÂÄºÔºâÂíåÂåøÂêçÁî®Êà∑
            const verifiedUsers = allUsers.filter(user => {
                const githubId = user.github_id || user.github_username;
                return githubId && isValidGitHubUsername(githubId) && !githubId.startsWith('Guest_');
            });
            
            const anonymousUsers = allUsers.filter(user => {
                const githubId = user.github_id || user.github_username;
                return !githubId || !isValidGitHubUsername(githubId) || githubId.startsWith('Guest_');
            });
            
            // ÊéíÂ∫èÔºöÊåâÂú®Á∫øÊó∂Èó¥ÂÄíÂ∫è
            verifiedUsers.sort((a, b) => new Date(b.online_at) - new Date(a.online_at));
            anonymousUsers.sort((a, b) => new Date(b.online_at) - new Date(a.online_at));
            
            // Â¶ÇÊûúÊ≤°ÊúâÁî®Êà∑ÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ
            if (verifiedUsers.length === 0 && anonymousUsers.length === 0) {
                listContainer.innerHTML = '<div class="text-zinc-500 text-center py-8 text-[10px]">Scanning for nearby nodes...</div>';
                return;
            }
            
            // Ê∏≤ÊüìÂ∑≤ÂÆûÂêçÁî®Êà∑ÔºàÊéíÂú®ÊúÄÂâçÔºâ
            let html = '';
            
            if (verifiedUsers.length > 0) {
                html += verifiedUsers.map(user => {
                    const userName = user.user_name || user.github_id || user.github_username || 'Guest';
                    const githubId = user.github_id || user.github_username || userName;
                    const avatarUrl = user.avatar_url || DEFAULT_AVATAR;
                    const status = user.status || 'idle';
                    const statusConfig = USER_STATUSES[status] || USER_STATUSES.idle;
                    const statusLabel = statusConfig.label;
                    
                    // ‰ΩøÁî®Áî®Êà∑Ë¶ÅÊ±ÇÁöÑ HTML ÁªìÊûÑÔºåÂåÖË£π <a> Ê†áÁ≠æÔºåÈìæÊé•ÊåáÂêë GitHub
                    // Ê∑ªÂä† onclick="event.stopPropagation()" Èò≤Ê≠¢Ëß¶ÂèëÊäΩÂ±âÊäòÂè†
                    return `
                        <a 
                            href="https://github.com/${userName}" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="flex items-center gap-3 p-2 hover:bg-white/10 rounded-lg transition-all group"
                            onclick="event.stopPropagation(); openMessageInput('${userName}'); return false;"
                        >
                            <img 
                                src="${avatarUrl}" 
                                alt="${userName}" 
                                class="w-8 h-8 rounded-full border border-[var(--accent-terminal)]"
                                loading="lazy"
                                onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                            />
                            <div class="flex flex-col flex-1 min-w-0">
                                <span class="text-xs text-white font-mono group-hover:text-[var(--accent-terminal)] truncate">${userName}</span>
                                <span class="text-[10px] text-[var(--text-dim)] uppercase">${statusLabel}</span>
                            </div>
                            <i class="ml-auto opacity-0 group-hover:opacity-100 transition-opacity text-[var(--accent-terminal)]">üîó</i>
                        </a>
                    `;
                }).join('');
            }
            
            // Ê∏≤ÊüìÂåøÂêçÁî®Êà∑
            if (anonymousUsers.length > 0) {
                html += anonymousUsers.map(user => {
                    const userName = user.user_name || 'Guest';
                    const avatarUrl = user.avatar_url || DEFAULT_AVATAR;
                    const status = user.status || 'idle';
                    const statusConfig = USER_STATUSES[status] || USER_STATUSES.idle;
                    const statusLabel = statusConfig.label;
                    
                    return `
                        <div 
                            class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-lg transition-all opacity-70"
                            onclick="openMessageInput('${userName}')"
                        >
                            <img 
                                src="${avatarUrl}" 
                                alt="${userName}" 
                                class="w-8 h-8 rounded-full border border-zinc-700"
                                loading="lazy"
                                onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                            />
                            <div class="flex flex-col flex-1 min-w-0">
                                <span class="text-xs text-zinc-400 font-mono truncate">${userName}</span>
                                <span class="text-[10px] text-zinc-600 uppercase">${statusLabel}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            listContainer.innerHTML = html;
        }
        
        /**
         * ÊâìÂºÄÁßÅ‰ø°ËæìÂÖ•Ê°Ü
         * @param {string} targetUserId - ÁõÆÊ†áÁî®Êà∑ID
         */
        function openMessageInput(targetUserId) {
            // ÂàõÂª∫ÈÅÆÁΩ©Â±Ç
            const overlay = document.createElement('div');
            overlay.className = 'message-input-overlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            };
            
            // ÂàõÂª∫ËæìÂÖ•Ê°Ü
            const inputBox = document.createElement('div');
            inputBox.className = 'message-input-box';
            inputBox.onclick = (e) => e.stopPropagation();
            
            inputBox.innerHTML = `
                <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest">ÂèëÈÄÅÁßÅ‰ø°Áªô ${targetUserId}</div>
                <textarea 
                    id="messageTextInput" 
                    placeholder="ËæìÂÖ•Ê∂àÊÅØÔºàÈòÖÂêéÂç≥ÁÑöÔºå5ÁßíÂêéËá™Âä®ÈîÄÊØÅÔºâ"
                    class="w-full bg-zinc-900/50 border border-zinc-800 px-3 py-2 rounded text-sm text-white placeholder-zinc-600 focus:outline-none focus:border-[var(--accent-terminal)] transition-colors resize-none"
                    rows="4"
                ></textarea>
                <div class="flex gap-2 mt-3">
                    <button 
                        onclick="sendMessage('${targetUserId}')"
                        class="flex-1 px-4 py-2 bg-[var(--accent-terminal)]/20 border border-[var(--accent-terminal)] text-[var(--accent-terminal)] text-xs font-bold uppercase tracking-wider hover:bg-[var(--accent-terminal)]/30 transition-colors"
                    >
                        ÂèëÈÄÅ
                    </button>
                    <button 
                        onclick="this.closest('.message-input-overlay').remove()"
                        class="px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-xs font-bold uppercase tracking-wider hover:bg-zinc-700 transition-colors"
                    >
                        ÂèñÊ∂à
                    </button>
                </div>
            `;
            
            overlay.appendChild(inputBox);
            document.body.appendChild(overlay);
            
            // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                const textarea = document.getElementById('messageTextInput');
                if (textarea) textarea.focus();
            }, 100);
        }
        
        /**
         * ÊòæÁ§∫ÂèëÈÄÅÊàêÂäüÊèêÁ§∫
         * @param {string} message - ÊèêÁ§∫Ê∂àÊÅØ
         */
        function showNotification(message) {
            // ÂàõÂª∫ÊèêÁ§∫ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-[var(--accent-terminal)]/20 border border-[var(--accent-terminal)] px-4 py-2 rounded text-[var(--accent-terminal)] text-xs font-bold uppercase tracking-wider z-50';
            notification.textContent = message;
            notification.style.animation = 'popup-appear 0.3s ease-out';
            
            document.body.appendChild(notification);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                notification.style.animation = 'popup-destroy 0.3s ease-out forwards';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        /**
         * ÂèëÈÄÅÁßÅ‰ø°Ôºà‰ΩøÁî®BroadcastÔºâ
         * @param {string} targetUserId - ÁõÆÊ†áÁî®Êà∑ID
         */
        function sendMessage(targetUserId) {
            const textarea = document.getElementById('messageTextInput');
            const message = textarea?.value.trim();
            
            if (!message) {
                alert('Ê∂àÊÅØ‰∏çËÉΩ‰∏∫Á©∫');
                return;
            }
            
            if (!presenceChannel) {
                alert('ËøûÊé•Êú™Âª∫Á´ãÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ');
                return;
            }
            
            const myId = localStorage.getItem('github_username') || null;
            const githubUsername = myId || 'Guest';
            const statusConfig = USER_STATUSES[currentUserStatus];
            
            // ‰ΩøÁî®BroadcastÂèëÈÄÅÊ∂àÊÅØ
            presenceChannel.send({
                type: 'broadcast',
                event: 'burn_msg',
                payload: {
                    from: githubUsername,
                    to: targetUserId,
                    target_id: targetUserId,
                    content: message,
                    message: message, // ÂÖºÂÆπÊóßÂ≠óÊÆµÂêç
                    timestamp: new Date().toISOString(),
                    status_color: statusConfig.status_color
                }
            });
            
            console.log('[Message] ‚úÖ ÁßÅ‰ø°Â∑≤ÂèëÈÄÅ:', { from: githubUsername, to: targetUserId, message });
            
            // üí° ‰øÆÂ§çÈÄªËæëÔºöÂ¶ÇÊûúÊòØÂèëÁªôËá™Â∑±ÔºåÁõ¥Êé•Âú®Êú¨Âú∞ËøêË°åÊòæÁ§∫ÈÄªËæë
            if (targetUserId === myId || targetUserId === githubUsername) {
                // Ëá™Êé•Êî∂ÔºöÁõ¥Êé•ÊòæÁ§∫Ê∂àÊÅØ
                showBurnMsg(message, githubUsername, statusConfig.status_color);
                console.log('[Message] üîÑ Ëá™Êé•Êî∂Ê∂àÊÅØÂ∑≤ÊòæÁ§∫');
            } else {
                // ÂèëÈÄÅÁªô‰ªñ‰∫∫ÔºöÊòæÁ§∫ÂèëÈÄÅÊàêÂäüÊèêÁ§∫
                showNotification('ÂØÜ‰ø°Â∑≤ÂèëÂá∫');
            }
            
            // ÂÖ≥Èó≠ËæìÂÖ•Ê°Ü
            const overlay = document.querySelector('.message-input-overlay');
            if (overlay) overlay.remove();
        }
        
        // ÂÖ®Â±ÄÂèòÈáèÔºöÁî®‰∫éÁÆ°ÁêÜÂÄíËÆ°Êó∂ÔºåÈò≤Ê≠¢Â§ö‰∏™ÂºπÁ™óÈáçÂè†
        let currentBurnMsgInterval = null;
        let currentBurnMsgPopup = null;

        /**
         * Áªü‰∏ÄÊ∂àÊÅØÊòæÁ§∫ÂáΩÊï∞ÔºàÈòÖÂêéÂç≥ÁÑöÂºπÁ™óÔºâ
         * @param {string} content - Ê∂àÊÅØÂÜÖÂÆπ
         * @param {string} fromId - ÂèëÈÄÅËÄÖID
         * @param {string} statusColor - Áä∂ÊÄÅÈ¢úËâ≤ÔºàÂèØÈÄâÔºâ
         */
        function showBurnMsg(content, fromId, statusColor = '#00ff41') {
            // Â¶ÇÊûúÂ∑≤ÊúâÂºπÁ™óÔºåÂÖàÊ∏ÖÈô§ÊóßÁöÑÂÄíËÆ°Êó∂
            if (currentBurnMsgInterval) {
                clearInterval(currentBurnMsgInterval);
                currentBurnMsgInterval = null;
            }
            
            // Â¶ÇÊûúÂ∑≤ÊúâÂºπÁ™óÔºåÂÖàÁßªÈô§
            if (currentBurnMsgPopup) {
                currentBurnMsgPopup.classList.add('destroying');
                setTimeout(() => {
                    if (currentBurnMsgPopup && currentBurnMsgPopup.parentNode) {
                        currentBurnMsgPopup.remove();
                    }
                }, 300);
            }
            
            // ÂàõÂª∫Êñ∞ÂºπÁ™ó
            const popup = document.createElement('div');
            popup.className = 'message-popup';
            currentBurnMsgPopup = popup;
            
            let countdown = 5;
            
            // Âà§Êñ≠ÊòØÂê¶‰∏∫Ëá™‰º†Ê∂àÊÅØ
            const myId = localStorage.getItem('github_username') || null;
            const isSelf = fromId === myId || fromId === 'Á≥ªÁªü (Ëá™‰º†)';
            const fromLabel = isSelf ? 'Á≥ªÁªü (Ëá™‰º†)' : fromId;
            
            popup.innerHTML = `
                <div class="flex items-center gap-3 mb-3">
                    <div class="text-[10px] text-zinc-500 uppercase tracking-widest">From: ${fromLabel}</div>
                    <div class="flex-1"></div>
                    <div class="text-[10px] font-bold" style="color: ${statusColor};" id="countdown-${Date.now()}">5Áßí</div>
                </div>
                <div class="text-white text-sm mb-3 font-mono" style="min-height: 60px; word-break: break-word;">${content}</div>
                <div class="text-[9px] text-zinc-600 font-mono">ÈòÖÂêéÂç≥ÁÑö // Ëá™Âä®ÈîÄÊØÅ</div>
            `;
            
            document.body.appendChild(popup);
            
            // ÂÄíËÆ°Êó∂ÈÄªËæëÔºàÁ°Æ‰øùÊØèÊ¨°Êñ∞Ê∂àÊÅØÂà∞ËææÊó∂ÈÉΩËÉΩÊ≠£Á°ÆÈáçÁΩÆÔºâ
            const countdownId = `countdown-${Date.now()}`;
            const countdownEl = popup.querySelector(`#${countdownId}`);
            
            currentBurnMsgInterval = setInterval(() => {
                countdown--;
                if (countdownEl) {
                    countdownEl.textContent = `${countdown}Áßí`;
                }
                
                if (countdown <= 0) {
                    clearInterval(currentBurnMsgInterval);
                    currentBurnMsgInterval = null;
                    // ÈîÄÊØÅÂä®Áîª
                    popup.classList.add('destroying');
                    setTimeout(() => {
                        if (popup && popup.parentNode) {
                            popup.remove();
                        }
                        if (currentBurnMsgPopup === popup) {
                            currentBurnMsgPopup = null;
                        }
                    }, 500);
                }
            }, 1000);
        }

        /**
         * ÊòæÁ§∫ÁßÅ‰ø°ÂºπÁ™óÔºàÊé•Êî∂Á´ØÔºâ- ÂÖºÂÆπÊóßÂáΩÊï∞Âêç
         * @param {Object} messageData - Ê∂àÊÅØÊï∞ÊçÆ
         */
        function showMessagePopup(messageData) {
            const content = messageData.content || messageData.message || '';
            const fromId = messageData.from || 'Unknown';
            const statusColor = messageData.status_color || '#00ff41';
            
            showBurnMsg(content, fromId, statusColor);
        }
        
        /**
         * GitHub OAuth ÁôªÂΩï
         * Ë∞ÉÁî® Supabase Auth ÁöÑ signInWithOAuth ÊñπÊ≥ï
         */
        async function loginWithGitHub() {
            if (!supabaseClient) {
                console.error('[Auth] ‚ùå Supabase ÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñ');
                alert('Êï∞ÊçÆÂ∫ìËøûÊé•Êú™Â∞±Áª™ÔºåËØ∑Á®çÂÄôÂÜçËØï');
                return;
            }
            
            try {
                console.log('[Auth] üöÄ ÂºÄÂßã GitHub OAuth ÁôªÂΩïÊµÅÁ®ã...');
                
                // Ëé∑ÂèñÂΩìÂâçÈ°µÈù¢ URL ‰Ωú‰∏∫ÈáçÂÆöÂêëÂú∞ÂùÄ
                const redirectTo = window.location.origin + window.location.pathname;
                
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'github',
                    options: {
                        redirectTo: redirectTo,
                        scopes: 'read:user user:email', // ËØ∑Ê±ÇËØªÂèñÁî®Êà∑‰ø°ÊÅØÂíåÈÇÆÁÆ±ÁöÑÊùÉÈôê
                    }
                });
                
                if (error) {
                    console.error('[Auth] ‚ùå GitHub OAuth ÁôªÂΩïÂ§±Ë¥•:', error);
                    alert(`ÁôªÂΩïÂ§±Ë¥•: ${error.message}`);
                    return;
                }
                
                console.log('[Auth] ‚úÖ GitHub OAuth ÁôªÂΩïËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅÔºåÁ≠âÂæÖÈáçÂÆöÂêë...');
                // Ê≥®ÊÑèÔºösignInWithOAuth ‰ºöËß¶ÂèëÈ°µÈù¢ÈáçÂÆöÂêëÔºåÂêéÁª≠ÈÄªËæëÂú® handleAuthStateChange ‰∏≠Â§ÑÁêÜ
                
            } catch (error) {
                console.error('[Auth] ‚ùå GitHub OAuth ÁôªÂΩïÂºÇÂ∏∏:', error);
                alert(`ÁôªÂΩïÂ§±Ë¥•: ${error.message || 'Êú™Áü•ÈîôËØØ'}`);
            }
        }
        
        /**
         * ÈÄÄÂá∫ÁôªÂΩï
         * Ê∏ÖÁêÜ‰ºöËØùÂíåÊú¨Âú∞Êï∞ÊçÆ
         */
        async function logout() {
            if (!supabaseClient) {
                console.error('[Auth] ‚ùå Supabase ÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñ');
                return;
            }
            
            try {
                console.log('[Auth] üö™ ÂºÄÂßãÈÄÄÂá∫ÁôªÂΩï...');
                
                // Ê∏ÖÁêÜ localStorage
                localStorage.removeItem('github_username');
                // ‰øùÁïô fingerprintÔºå‰ª•‰æøÈùôÈªòÁôªÂΩï
                
                // Ë∞ÉÁî® Supabase Auth ÈÄÄÂá∫
                const { error } = await supabaseClient.auth.signOut();
                
                if (error) {
                    console.error('[Auth] ‚ùå ÈÄÄÂá∫ÁôªÂΩïÂ§±Ë¥•:', error);
                    alert(`ÈÄÄÂá∫Â§±Ë¥•: ${error.message}`);
                    return;
                }
                
                // Ê∏ÖÁêÜÂÖ®Â±ÄÂèòÈáè
                window.currentUser = null;
                window.currentUserMatchedByFingerprint = false;
                
                // Âà∑Êñ∞ UI
                updateAuthUI(null);
                
                // Âà∑Êñ∞ÊéíÂêçÂç°ÁâáÔºàÊòæÁ§∫ÂÖ®ÁêÉÊúÄÂº∫Ê®°ÂºèÔºâ
                renderRankCards(null);
                
                console.log('[Auth] ‚úÖ Â∑≤ÈÄÄÂá∫ÁôªÂΩï');
                alert('Â∑≤ÈÄÄÂá∫ÁôªÂΩï');
                
            } catch (error) {
                console.error('[Auth] ‚ùå ÈÄÄÂá∫ÁôªÂΩïÂºÇÂ∏∏:', error);
                alert(`ÈÄÄÂá∫Â§±Ë¥•: ${error.message || 'Êú™Áü•ÈîôËØØ'}`);
            }
        }
        
        /**
         * ÊòæÁ§∫ÂêåÊ≠•ÈÅÆÁΩ©
         */
        function showSyncingOverlay() {
            try {
                const leftDrawer = document.getElementById('left-drawer');
                const leftBody = document.getElementById('left-drawer-body');
                
                if (!leftDrawer || !leftBody) {
                    console.warn('[Auth] ‚ö†Ô∏è Êó†Ê≥ïÊâæÂà∞ÊäΩÂ±âÂÖÉÁ¥†ÔºåË∑≥ËøáÊòæÁ§∫ÂêåÊ≠•ÈÅÆÁΩ©');
                    return;
                }
                
                // ÁßªÈô§ÊóßÁöÑÂêåÊ≠•Âç†‰ΩçÁ¨¶ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                const existingSyncingCards = leftBody.querySelectorAll('.drawer-item');
                existingSyncingCards.forEach(card => {
                    const label = card.querySelector('.drawer-item-label');
                    if (label && label.textContent === 'Êï∞ÊçÆÂêåÊ≠•‰∏≠') {
                        card.remove();
                    }
                });
                
                // ÂàõÂª∫"Êï∞ÊçÆÂêåÊ≠•‰∏≠"Âç†‰ΩçÁ¨¶Âç°Áâá
                const loadingCard = document.createElement('div');
                loadingCard.className = 'drawer-item';
                loadingCard.id = 'syncing-overlay-card';
                loadingCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">‚è≥</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                            SYNCING
                        </span>
                    </div>
                    <div class="drawer-item-label mb-2">Êï∞ÊçÆÂêåÊ≠•‰∏≠</div>
                    <div class="text-[10px] text-[#00ff41]/60 mb-3">
                        Ê≠£Âú®ËøÅÁßªÊåáÁ∫πÊï∞ÊçÆÔºåËØ∑Á®çÂÄô...
                    </div>
                    <div class="flex items-center space-x-2 mb-2">
                        <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                `;
                
                // ÂÖàÁßªÈô§ÊóßÁöÑÁªüËÆ°Âç°ÁâáÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                const existingStatsCards = leftBody.querySelectorAll('.drawer-item:not(#syncing-overlay-card)');
                existingStatsCards.forEach(card => card.remove());
                
                // Ê∑ªÂä†ÂêåÊ≠•Âç†‰ΩçÁ¨¶
                leftBody.appendChild(loadingCard);
                
                // Á°Æ‰øùÊäΩÂ±âÊâìÂºÄ
                if (!leftDrawer.classList.contains('active')) {
                    leftDrawer.classList.add('active');
                }
                
                console.log('[Auth] ‚úÖ Â∑≤ÊòæÁ§∫ÂêåÊ≠•ÈÅÆÁΩ©');
            } catch (error) {
                console.error('[Auth] ‚ùå ÊòæÁ§∫ÂêåÊ≠•ÈÅÆÁΩ©Â§±Ë¥•:', error);
            }
        }
        
        /**
         * ÈöêËóèÂêåÊ≠•ÈÅÆÁΩ©
         */
        function hideSyncingOverlay() {
            try {
                const leftBody = document.getElementById('left-drawer-body');
                if (!leftBody) {
                    console.warn('[Auth] ‚ö†Ô∏è Êó†Ê≥ïÊâæÂà∞ÊäΩÂ±â body ÂÖÉÁ¥†ÔºåË∑≥ËøáÈöêËóèÂêåÊ≠•ÈÅÆÁΩ©');
                    return;
                }
                
                // ÁßªÈô§ÂêåÊ≠•Âç†‰ΩçÁ¨¶Âç°Áâá
                const syncingCard = document.getElementById('syncing-overlay-card');
                if (syncingCard) {
                    syncingCard.remove();
                    console.log('[Auth] ‚úÖ Â∑≤ÁßªÈô§ÂêåÊ≠•ÈÅÆÁΩ©');
                }
                
                // Â¶ÇÊûúÊúâÂΩìÂâçÁî®Êà∑Êï∞ÊçÆÔºåÈáçÊñ∞Ê∏≤ÊüìÁªüËÆ°Âç°ÁâáÔºà‰ºòÂÖà‰ΩøÁî® allData ‰∏≠ÁöÑÂÆåÊï¥ËÆ∞ÂΩïÔºâ
                if (window.currentUser) {
                    renderUserStatsCards(leftBody, getBestUserRecordForStats(window.currentUser));
                }
            } catch (error) {
                console.error('[Auth] ‚ùå ÈöêËóèÂêåÊ≠•ÈÅÆÁΩ©Â§±Ë¥•:', error);
            }
        }
        
        /**
         * Â§ÑÁêÜËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ
         * ÂΩìÁî®Êà∑ÁôªÂΩï/ÈÄÄÂá∫Êó∂Ëá™Âä®Ë∞ÉÁî®
         * @param {Object} session - Supabase ‰ºöËØùÂØπË±°
         */
        async function handleAuthStateChange(session) {
            console.log('[Auth] üîî ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ:', session ? 'Â∑≤ÁôªÂΩï' : 'Êú™ÁôªÂΩï');
            
            // Ë∂ÖÊó∂ÂÖúÂ∫ïÂÆöÊó∂Âô®
            let timeoutTimer = null;
            
            // Á°Æ‰øù finally Âùó‰∏≠ËÉΩËÆøÈóÆÁöÑÂèòÈáè
            let migrationCompleted = false;
            
            try {
                if (session && session.user) {
                    const user = session.user;
                    console.log('[Auth] üë§ Áî®Êà∑‰ø°ÊÅØ:', {
                        id: user.id,
                        email: user.email,
                        user_metadata: user.user_metadata
                    });
                    
                    // ‰ªé user_metadata ‰∏≠ÊèêÂèñ GitHub ‰ø°ÊÅØ
                    // GitHub OAuth ËøîÂõûÁöÑÊï∞ÊçÆÈÄöÂ∏∏Âú® user_metadata ‰∏≠
                    const githubUsername = user.user_metadata?.user_name || 
                                         user.user_metadata?.preferred_username ||
                                         user.user_metadata?.login ||
                                         user.email?.split('@')[0] || // ÈôçÁ∫ßÔºö‰ΩøÁî®ÈÇÆÁÆ±ÂâçÁºÄ
                                         null;
                    
                    const avatarUrl = user.user_metadata?.avatar_url || 
                                    user.user_metadata?.picture ||
                                    (githubUsername ? getGitHubAvatarUrl(githubUsername) : null) ||
                                    DEFAULT_AVATAR;
                    
                    if (!githubUsername) {
                        console.warn('[Auth] ‚ö†Ô∏è Êó†Ê≥ï‰ªé user_metadata ‰∏≠ÊèêÂèñ GitHub Áî®Êà∑Âêç');
                        updateAuthUI(null);
                        return;
                    }
                    
                    console.log('[Auth] ‚úÖ ÊèêÂèñÂà∞ GitHub ‰ø°ÊÅØ:', {
                        username: githubUsername,
                        avatarUrl: avatarUrl
                    });
                    
                    // ‰øùÂ≠òÂà∞ localStorageÔºàÂÖºÂÆπÊóß‰ª£Á†ÅÔºâ
                    localStorage.setItem('github_username', githubUsername);
                    
                    // „ÄêÂèòÈáè‰øÆÊ≠£„ÄëÁªü‰∏Ä‰ΩøÁî® currentFp ÂèòÈáè
                    // „Äê‰øÆÂ§ç„ÄëÁ°Æ‰øùÂú®Ë∞ÉÁî® migrate Êé•Âè£ÂâçÔºå‰ª£Á†ÅËÉΩÂ§üÊ≠£Á°Æ‰ªé localStorage Ëé∑Âèñ user_fingerprint
                    let currentFp = null;
                    try {
                        // ‰ºòÂÖàÂ∞ùËØï‰ªé localStorage Ëé∑ÂèñÔºåËøôÊòØÂåøÂêçÁî®Êà∑Êï∞ÊçÆÁöÑÂîØ‰∏ÄÊ†áËØÜ
                        currentFp = localStorage.getItem('user_fingerprint') || window.fpId;
                    } catch (e) {
                        console.warn('[Auth] ‚ö†Ô∏è ËØªÂèñ localStorage user_fingerprint Â§±Ë¥•:', e);
                    }
                    
                    if (!currentFp) {
                        console.warn('[Auth] ‚ö†Ô∏è Êó†Ê≥ïËé∑ÂèñÊåáÁ∫πÔºåÂ∞ùËØïÁîüÊàê...');
                        try {
                            const generatedFp = await getCurrentFingerprint();
                            if (generatedFp) {
                                currentFp = generatedFp;
                                window.fpId = generatedFp;
                                try {
                                    localStorage.setItem('user_fingerprint', generatedFp);
                                } catch (e) {
                                    console.warn('[Auth] ‚ö†Ô∏è ÂÜôÂÖ• localStorage user_fingerprint Â§±Ë¥•:', e);
                                }
                            }
                        } catch (genError) {
                            console.error('[Auth] ‚ùå ÁîüÊàêÊåáÁ∫πÂ§±Ë¥•:', genError);
                        }
                    }
                    
                    const githubUserId = user.id; // ‰ªé Supabase Auth Áî®Êà∑ÂØπË±°Ëé∑Âèñ user_id
                    let migrationSuccess = false;
                    
                    // „ÄêËøÅÁßª‰ºòÂÖà„ÄëÂú®Ê£ÄÊµãÂà∞ GitHub ÁôªÂΩïÂêéÔºåÂÖàË∞ÉÁî® /api/fingerprint/migrate Êé•Âè£
                    if (currentFp && githubUserId) {
                        console.log('[Auth] üîÑ Ê£ÄÊµãÂà∞ÊåáÁ∫πÂíå GitHub Áî®Êà∑ÔºåÂºÄÂßãÊï∞ÊçÆËøÅÁßª...');
                        console.log('[Auth] üìã ËøÅÁßª‰ø°ÊÅØ:', {
                            currentFp: currentFp.substring(0, 8) + '...',
                            githubUserId: githubUserId.substring(0, 8) + '...',
                            username: githubUsername
                        });
                        
                        // „ÄêÂêàÂπ∂Á°ÆËÆ§ÂºπÁ™ó„ÄëÂú®ËøÅÁßªÂâçÊ£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÁî®Êà∑Á°ÆËÆ§
                        const claimToken = localStorage.getItem('vibe_claim_token');
                        const hasLocalData = claimToken || currentFp;
                        const localDataExists = localStorage.getItem('last_analysis_data') || claimToken;
                        
                        // „Äê‰∏•Ê†ºÊ†°È™åËøÅÁßªÈÄªËæë„ÄëÊ£ÄÊü•ÊòØÂê¶ÊúâÂΩ±Â≠ê‰ª§Áâå
                        // Ê≥®ÊÑè:Êñ∞ÁöÑÂº∫Âà∂ËÆ§È¢ÜÊú∫Âà∂Âè™ËÆ§ claimToken,‰∏çÂÜçÊîØÊåÅÁ∫ØÊåáÁ∫πËøÅÁßª
                        if (!claimToken) {
                            console.warn('[Auth] ‚ö†Ô∏è Êú¨Âú∞Êó† claim_tokenÔºåÊó†Ê≥ïÊâßË°åÊï∞ÊçÆËÆ§È¢Ü„ÄÇ');
                            // ÊòæÁ§∫ÊèêÁ§∫ÂºπÁ™ó
                            const noDataDialog = document.createElement('div');
                            noDataDialog.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
                            noDataDialog.id = 'no-data-dialog';
                            noDataDialog.innerHTML = `
                                <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Êú™Ê£ÄÊµãÂà∞ÂæÖËÆ§È¢ÜÊï∞ÊçÆ</h3>
                                    <p class="text-sm text-gray-600 mb-4">Êú™ÂèëÁé∞Êú¨Âú∞ÂàÜÊûêÊï∞ÊçÆÔºåÂ∞Ü‰∏∫ÊÇ®ÂàõÂª∫Êñ∞Ë¥¶Âè∑Êï∞ÊçÆ„ÄÇ</p>
                                    <div class="flex gap-3 justify-end">
                                        <button class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors" id="no-data-confirm">Á°ÆÂÆö</button>
                                    </div>
                                </div>
                            `;
                            document.body.appendChild(noDataDialog);
                            
                            await new Promise((resolve) => {
                                const removeDialog = () => {
                                    const dialogElement = document.getElementById('no-data-dialog');
                                    if (dialogElement && dialogElement.parentNode) {
                                        dialogElement.parentNode.removeChild(dialogElement);
                                    }
                                    resolve();
                                };
                                
                                noDataDialog.querySelector('#no-data-confirm')?.addEventListener('click', removeDialog);
                            });
                            
                            // Ê≤°ÊúâÂéÜÂè≤Êï∞ÊçÆÔºåË∑≥ËøáËøÅÁßªÔºåÁªßÁª≠Ê≠£Â∏∏ÊµÅÁ®ã
                            hideSyncingOverlay();
                            return;
                        }
                        
                        // Â¶ÇÊûúÈúÄË¶ÅÁ°ÆËÆ§ÔºåÂÖàÊòæÁ§∫ÂºπÁ™ó
                        if (hasLocalData && localDataExists) {
                            const shouldMerge = await new Promise((resolve) => {
                                const dialog = document.createElement('div');
                                dialog.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
                                dialog.id = 'merge-confirm-dialog';
                                dialog.innerHTML = `
                                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Êï∞ÊçÆÂêàÂπ∂Á°ÆËÆ§</h3>
                                        <p class="text-sm text-gray-600 mb-4">Ê£ÄÊµãÂà∞ÊÇ®ÊúâÊú™ÂΩíÊ°£ÁöÑÊàòÁª©ÔºåÊòØÂê¶ÂêàÂπ∂Âà∞ GitHub Ë¥¶Âè∑Ôºü</p>
                                        <div class="flex gap-3 justify-end">
                                            <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors" id="merge-cancel">ÂèñÊ∂à</button>
                                            <button class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors" id="merge-confirm">ÂêàÂπ∂</button>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(dialog);
                                
                                const removeDialog = () => {
                                    const dialogElement = document.getElementById('merge-confirm-dialog');
                                    if (dialogElement && dialogElement.parentNode) {
                                        dialogElement.parentNode.removeChild(dialogElement);
                                    }
                                };
                                
                                dialog.querySelector('#merge-confirm')?.addEventListener('click', () => {
                                    removeDialog();
                                    resolve(true);
                                });
                                
                                dialog.querySelector('#merge-cancel')?.addEventListener('click', () => {
                                    removeDialog();
                                    resolve(false);
                                });
                            });
                            
                            if (!shouldMerge) {
                                console.log('[Auth] ‚ÑπÔ∏è Áî®Êà∑ÂèñÊ∂àÂêàÂπ∂ÔºåË∑≥ËøáËøÅÁßª');
                                return;
                            }
                        }
                        
                        // ÊòæÁ§∫ÂêåÊ≠•ÈÅÆÁΩ©
                        showSyncingOverlay();
                        
                        // ËÆæÁΩÆ 8 ÁßíË∂ÖÊó∂ÂÖúÂ∫ï
                        timeoutTimer = setTimeout(() => {
                            if (!migrationCompleted) {
                                console.warn('[Auth] ‚ö†Ô∏è ËøÅÁßªÊé•Âè£Ë∂ÖÊó∂Ôºà8ÁßíÔºâÔºåÂº∫Âà∂ÊâßË°å hideSyncingOverlay()');
                                migrationCompleted = true;
                                hideSyncingOverlay();
                            }
                        }, 8000);
                        
                        try {
                            // „ÄêTask 1„ÄëËé∑Âèñ API Âü∫ÂáÜÂú∞ÂùÄ
                            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || 
                                              'https://cursor-clinical-analysis.psterman.workers.dev/';
                            const migrateUrl = `${apiEndpoint}api/fingerprint/migrate`;
                            
                            console.log('[Auth] üì° ‰ΩøÁî® API Âú∞ÂùÄ:', migrateUrl);
                            
                            // „Äê‰øÆÂ§ç AbortError„ÄëÊ∑ªÂä† AbortController ÂíåË∂ÖÊó∂Â§ÑÁêÜ
                            const abortController = new AbortController();
                            const timeoutId = setTimeout(() => {
                                abortController.abort();
                            }, 10000); // 10ÁßíË∂ÖÊó∂
                            
                            let migrateResponse;
                            try {
                                // Ë∞ÉÁî®ÂêéÁ´ØÊé•Âè£ËøÅÁßªÊï∞ÊçÆ
                                // „ÄêÂøÖÈ°ªÂú® Body ‰∏≠Êê∫Â∏¶Ôºö{ userId, claimToken }„Äë
                                const migrateBody = {
                                    userId: githubUserId
                                };
                                
                                // „ÄêÂΩ±Â≠ê‰ª§Áâå‰ºòÂÖà„ÄëÂ¶ÇÊûúÂ≠òÂú® claimTokenÔºå‰ºòÂÖà‰ΩøÁî®ÂÆÉ
                                if (claimToken) {
                                    migrateBody.claimToken = claimToken; // ÂêéÁ´ØÊé•Êî∂ claimTokenÔºàÈ©ºÂ≥∞ÂëΩÂêçÔºâ
                                    console.log('[Auth] üîë Ê£ÄÊµãÂà∞ vibe_claim_tokenÔºåÊâßË°åÂº∫Ë°åËÆ§È¢Ü:', claimToken.substring(0, 8) + '...');
                                } else {
                                    // „ÄêÈáçË¶Å„ÄëÂ¶ÇÊûúÊ≤°Êúâ claimTokenÔºåË∑≥ËøáËøÅÁßª
                                    console.warn('[Auth] ‚ö†Ô∏è Êó† claimTokenÔºåË∑≥ËøáËøÅÁßªÔºàÊñ∞ÁöÑÂº∫Âà∂ËÆ§È¢ÜÊú∫Âà∂Ë¶ÅÊ±ÇÂøÖÈ°ªÊúâ claim_tokenÔºâ');
                                    hideSyncingOverlay();
                                    return;
                                }

                                
                                migrateResponse = await fetch(migrateUrl, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${session.access_token}` // ‰º†ÈÄíËÆ§ËØÅ token
                                    },
                                    body: JSON.stringify(migrateBody),
                                    signal: abortController.signal // Ê∑ªÂä† signal ÊîØÊåÅÂèñÊ∂à
                                });
                                
                                clearTimeout(timeoutId); // Ê∏ÖÈô§Ë∂ÖÊó∂ÂÆöÊó∂Âô®
                            } catch (fetchError) {
                                clearTimeout(timeoutId); // Á°Æ‰øùÊ∏ÖÈô§Ë∂ÖÊó∂ÂÆöÊó∂Âô®
                                
                                // Â§ÑÁêÜ AbortError
                                if (fetchError.name === 'AbortError' || fetchError.message?.includes('aborted')) {
                                    console.warn('[Auth] ‚ö†Ô∏è ËøÅÁßªËØ∑Ê±ÇË¢´ÂèñÊ∂àÔºàË∂ÖÊó∂ÊàñÈ°µÈù¢Âà∑Êñ∞Ôºâ:', fetchError);
                                    throw new Error('ËØ∑Ê±ÇË∂ÖÊó∂ÊàñË¢´ÂèñÊ∂àÔºåËØ∑Á®çÂêéÈáçËØï');
                                }
                                throw fetchError; // ÈáçÊñ∞ÊäõÂá∫ÂÖ∂‰ªñÈîôËØØ
                            }
                            
                            // Ê∏ÖÈô§Ë∂ÖÊó∂ÂÖúÂ∫ïÂÆöÊó∂Âô®
                            if (timeoutTimer) {
                                clearTimeout(timeoutTimer);
                                timeoutTimer = null;
                            }
                            
                            // „ÄêTask 4„Äë‰øÆÂ§ç JSON Ëß£ÊûêÂºÇÂ∏∏ÔºöÊ£ÄÊü•ÂìçÂ∫îÁä∂ÊÄÅÂíå Content-Type
                            let migrateResult = null;
                            if (migrateResponse.status !== 204) {
                                const contentType = migrateResponse.headers.get('content-type') || '';
                                if (contentType.includes('application/json')) {
                                    try {
                                        migrateResult = await migrateResponse.json();
                                    } catch (jsonError) {
                                        console.error('[Auth] ‚ùå JSON Ëß£ÊûêÂ§±Ë¥•:', jsonError);
                                        const responseText = await migrateResponse.text();
                                        console.error('[Auth] ÂìçÂ∫îÂÜÖÂÆπ:', responseText);
                                        throw new Error(`JSON Ëß£ÊûêÂ§±Ë¥•: ${jsonError.message}`);
                                    }
                                } else {
                                    const responseText = await migrateResponse.text();
                                    console.warn('[Auth] ‚ö†Ô∏è ÂìçÂ∫î‰∏çÊòØ JSON Ê†ºÂºè:', {
                                        status: migrateResponse.status,
                                        contentType: contentType,
                                        responseText: responseText.substring(0, 200)
                                    });
                                    throw new Error(`ÂìçÂ∫îÊ†ºÂºèÈîôËØØ: ${contentType}`);
                                }
                            } else {
                                console.log('[Auth] ‚ÑπÔ∏è ÂìçÂ∫îÁä∂ÊÄÅ‰∏∫ 204 No ContentÔºåË∑≥Ëøá JSON Ëß£Êûê');
                                migrateResult = { status: 'success', data: null };
                            }
                            
                            // „Äê‰øÆÂ§ç 404 ÈîôËØØÂ§ÑÁêÜ„ÄëÊ£ÄÊü•ÂìçÂ∫îÁä∂ÊÄÅ
                            if (!migrateResponse.ok) {
                                const errorMsg = migrateResult?.error || `HTTP ${migrateResponse.status}: ${migrateResponse.statusText}`;
                                console.warn('[Auth] ‚ö†Ô∏è ËøÅÁßªÊé•Âè£ËøîÂõûÈîôËØØ:', {
                                    status: migrateResponse.status,
                                    statusText: migrateResponse.statusText,
                                    error: errorMsg
                                });
                                
                                // Â¶ÇÊûúÊòØ 404ÔºåËØ¥ÊòéË∑ØÁî±‰∏çÂ≠òÂú®ÊàñÊú™ÈÉ®ÁΩ≤ÔºåÁªßÁª≠Ê≠£Â∏∏ÊµÅÁ®ã
                                if (migrateResponse.status === 404) {
                                    console.log('[Auth] ‚ÑπÔ∏è ËøÅÁßªÊé•Âè£‰∏çÂ≠òÂú®Ôºà404ÔºâÔºåË∑≥ËøáËøÅÁßªÔºåÁªßÁª≠Ê≠£Â∏∏ÊµÅÁ®ã');
                                    // ‰∏çÊäõÂá∫ÈîôËØØÔºåÁªßÁª≠ÊâßË°åÂêéÁª≠ÈÄªËæë
                                } else if (migrateResponse.status === 400 && (errorMsg.includes('claim_token') || errorMsg.includes('Êó†Êïà'))) {
                                    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„Äë‰ª§ÁâåÁ°ÆÂÆûÊó†ÊïàÊàñÂ∑≤ËøáÊúü,ÂøÖÈ°ªÊ∏ÖÈô§,Âê¶ÂàôÁî®Êà∑ÊØèÊ¨°ÁôªÂΩïÈÉΩ‰ºöÊä•Èîô
                                    console.warn('[Auth] ‚ö†Ô∏è Ê£ÄÊµãÂà∞Â§±ÊïàÁöÑÂΩ±Â≠ê‰ª§Áâå,Ê≠£Âú®Âº∫Âà∂Ê∏ÖÈô§Êú¨Âú∞ÁºìÂ≠ò...');
                                    localStorage.removeItem('vibe_claim_token');
                                    localStorage.removeItem('user_fingerprint'); // ÂêåÊó∂Ê∏ÖÈô§ÊåáÁ∫π
                                } else {
                                    // ÂÖ∂‰ªñÈîôËØØÔºåËÆ∞ÂΩï‰ΩÜ‰∏ç‰∏≠Êñ≠ÊµÅÁ®ã
                                    console.warn('[Auth] ‚ö†Ô∏è Êï∞ÊçÆËøÅÁßªÂ§±Ë¥•ÔºåÁªßÁª≠Ê≠£Â∏∏ÊµÅÁ®ã:', errorMsg);
                                }
                                
                                // Êó†ËÆ∫‰ªÄ‰πàÈîôËØØÔºåÈÉΩÁªßÁª≠Ê≠£Â∏∏ÊµÅÁ®ãÔºà‰∏çËøÅÁßªÔºâ
                                migrateResult = { status: 'error', error: errorMsg };
                            }
                            
                            migrationCompleted = true;
                            
                            if (migrateResult && migrateResult.status === 'success') {
                                console.log('[Auth] ‚úÖ Step A: Êï∞ÊçÆËøÅÁßªÊàêÂäü:', migrateResult.data);
                                migrationSuccess = true;
                                
                                // „ÄêÂú∫ÊôØ AÔºöÂÖàÂàÜÊûêÂêéÁôªÂΩï„ÄëÊ∏ÖÈô§ claim_token Âíå fingerprint ÁºìÂ≠ò
                                localStorage.removeItem('vibe_claim_token');
                                localStorage.removeItem('user_fingerprint');
                                if (window.fpId) {
                                    delete window.fpId;
                                }
                                console.log('[Auth] ‚úÖ Â∑≤Ê∏ÖÈô§Êú¨Âú∞ fingerprint Âíå claim_token ÁºìÂ≠ò');
                                
                                // ËøÅÁßªÊàêÂäüÂêéÔºåÊõ¥Êñ∞ window.allData
                                const allData = window.allData || [];
                                const migratedUser = migrateResult.data;
                                
                                // ÁßªÈô§ÊóßÁöÑÊåáÁ∫πËÆ∞ÂΩïÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                                const oldIndex = allData.findIndex(item => 
                                    item.fingerprint === currentFp && item.id !== githubUserId
                                );
                                if (oldIndex !== -1) {
                                    allData.splice(oldIndex, 1);
                                }
                                
                                // Ê∑ªÂä†ÊàñÊõ¥Êñ∞ËøÅÁßªÂêéÁöÑÁî®Êà∑Êï∞ÊçÆ
                                const newIndex = allData.findIndex(item => item.id === githubUserId);
                                if (newIndex !== -1) {
                                    allData[newIndex] = { ...allData[newIndex], ...migratedUser };
                                } else {
                                    allData.push(migratedUser);
                                }
                                window.allData = allData;
                                
                                // ËÆæÁΩÆÂΩìÂâçÁî®Êà∑‰∏∫ËøÅÁßªÂêéÁöÑÁî®Êà∑
                                window.currentUser = migratedUser;
                                window.currentUserMatchedByFingerprint = false; // Áé∞Âú®ÊòØÈÄöËøá GitHub OAuth ÂåπÈÖçÁöÑ
                                
                                console.log('[Auth] ‚úÖ Ë∫´‰ªΩÂêàÂπ∂ÂÆåÊàêÔºåÂéÜÂè≤Êï∞ÊçÆÂ∑≤ËøÅÁßªÂà∞ GitHub User ID');
                                
                                // „ÄêÈ°∫Â∫èÈáçÁªÑ„ÄëStep B: Ë∞ÉÁî® autoReportSelfÔºà‰∏äÊä•ÂΩìÂâçÂú∞ÁêÜ‰ΩçÁΩÆÔºåÁ°Æ‰øù GitHub Ë¥¶Âè∑Êúâ‰∫Ü lat/lngÔºâ
                                console.log('[Auth] üîÑ Step B: ÂºÄÂßã‰∏äÊä•Âú∞ÁêÜ‰ΩçÁΩÆ...');
                                try {
                                    const reportResult = await autoReportSelf();
                                    if (reportResult.success) {
                                        console.log('[Auth] ‚úÖ Step B: Âú∞ÁêÜ‰ΩçÁΩÆ‰∏äÊä•ÊàêÂäü');
                                    } else {
                                        console.warn('[Auth] ‚ö†Ô∏è Step B: Âú∞ÁêÜ‰ΩçÁΩÆ‰∏äÊä•Â§±Ë¥•:', reportResult.error);
                                    }
                                } catch (reportError) {
                                    console.error('[Auth] ‚ùå Step B: Âú∞ÁêÜ‰ΩçÁΩÆ‰∏äÊä•ÂºÇÂ∏∏:', reportError);
                                }
                                
                                // „ÄêËøÅÁßª‰ºòÂÖà„ÄëÂè™ÊúâÂú®ËøÅÁßªËØ∑Ê±ÇÁªìÊùüÂêéÔºåÊâçË∞ÉÁî® refreshUserStats() Âä†ËΩΩÊï∞ÊçÆ
                                console.log('[Auth] üîÑ Step C: ÂºÄÂßãÂà∑Êñ∞Áî®Êà∑ÁªüËÆ°Êï∞ÊçÆ...');
                                if (typeof window.refreshUserStats === 'function') {
                                    try {
                                        await window.refreshUserStats();
                                        console.log('[Auth] ‚úÖ Step C: refreshUserStats ÊâßË°åÂÆåÊàê');
                                    } catch (refreshError) {
                                        // „Äê‰øÆÂ§ç AbortError„ÄëÁâπÊÆäÂ§ÑÁêÜ AbortError
                                        if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                            console.log('[Auth] ‚ÑπÔ∏è refreshUserStats Ë¢´ÂèñÊ∂àÔºàÂèØËÉΩÊòØÈ°µÈù¢Âà∑Êñ∞ÂØºËá¥Ôºâ');
                                        } else {
                                            console.error('[Auth] ‚ùå Step C: refreshUserStats ÊâßË°åÂ§±Ë¥•:', refreshError);
                                        }
                                    }
                                } else {
                                    console.warn('[Auth] ‚ö†Ô∏è window.refreshUserStats ÂáΩÊï∞‰∏çÂ≠òÂú®');
                                }
                                
                                // Êõ¥Êñ∞ UI
                                updateAuthUI({ username: githubUsername, avatarUrl });
                                
                                // ÈöêËóèÂêåÊ≠•ÈÅÆÁΩ©
                                hideSyncingOverlay();
                                
                                return; // ËøÅÁßªÊàêÂäüÔºåÁõ¥Êé•ËøîÂõûÔºå‰∏çÂÜçÊâßË°åÂêéÁª≠ÁöÑÊåáÁ∫πÁªëÂÆöÈÄªËæë
                            } else if (migrateResult && migrateResult.status === 'not_found') {
                                console.log('[Auth] ‚ÑπÔ∏è Êú™ÊâæÂà∞ÈúÄË¶ÅËøÅÁßªÁöÑÊï∞ÊçÆÔºåÁªßÁª≠Ê≠£Â∏∏ÊµÅÁ®ã');
                                hideSyncingOverlay();
                            } else {
                                console.warn('[Auth] ‚ö†Ô∏è Êï∞ÊçÆËøÅÁßªÂ§±Ë¥•ÔºåÁªßÁª≠Ê≠£Â∏∏ÊµÅÁ®ã:', migrateResult?.error);
                                hideSyncingOverlay();
                            }
                        } catch (migrateError) {
                            migrationCompleted = true;
                            
                            // „Äê‰øÆÂ§ç AbortError„ÄëÁâπÊÆäÂ§ÑÁêÜ AbortError
                            if (migrateError.name === 'AbortError' || migrateError.message?.includes('aborted')) {
                                console.warn('[Auth] ‚ö†Ô∏è ËøÅÁßªËØ∑Ê±ÇË¢´ÂèñÊ∂àÔºàÂèØËÉΩÊòØÈ°µÈù¢Âà∑Êñ∞ÂØºËá¥Ôºâ:', migrateError);
                            } else {
                                console.error('[Auth] ‚ùå Êï∞ÊçÆËøÅÁßªÂºÇÂ∏∏ÔºåÁªßÁª≠Ê≠£Â∏∏ÊµÅÁ®ã:', migrateError);
                            }
                            
                            hideSyncingOverlay();
                        }
                    } else {
                        console.log('[Auth] ‚ÑπÔ∏è Êú™Ê£ÄÊµãÂà∞ÊåáÁ∫πÊàñ GitHub Áî®Êà∑ IDÔºåË∑≥ËøáËøÅÁßª');
                    }
                    
                    // „Äê‰ªÖÂú®ËøÅÁßªÊú™ÊàêÂäüÊó∂ÊâßË°å„ÄëÂÖ≥ÈîÆÁªëÂÆöÈÄªËæëÔºöÁôªÂΩïÂêéÂøÖÈ°ª‰ΩøÁî® user_id Êõ¥Êñ∞ÔºåËÄå‰∏çÊòØ fingerprint
                    if (!migrationSuccess) {
                        console.log('[Auth] üîó ËøÅÁßªÊú™ÊàêÂäüÔºåÂºÄÂßã‰ΩøÁî® GitHub User ID ËøõË°åÊï∞ÊçÆÂêåÊ≠•...');
                        
                        // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÁôªÂΩïÂêéÂøÖÈ°ª‰ΩøÁî® user_id ËøõË°åÊâÄÊúâÊìç‰ΩúÔºåËÄå‰∏çÊòØ fingerprint
                        // ËøôÊòØ"ËÆ§Á•ñÂΩíÂÆó"ÁöÑÂÖ≥ÈîÆÔºöÁ°Æ‰øùÊï∞ÊçÆÂÖ≥ËÅîÂà∞Ê≠£Á°ÆÁöÑ GitHub Ë¥¶Âè∑
                        const normalizedUsername = githubUsername.toLowerCase().trim();
                        
                        // „ÄêÂèòÈáè‰øÆÊ≠£„ÄëÁªü‰∏Ä‰ΩøÁî® currentFp ÂèòÈáè
                        const currentFp = window.fpId || localStorage.getItem('user_fingerprint') || await getCurrentFingerprint();
                        
                        console.log('[Auth] üîó ‰ΩøÁî® GitHub User ID ÊâßË°å upsert Êìç‰ΩúÔºåid =', githubUserId.substring(0, 8) + '...');
                        
                        // È¶ñÂÖàÂ∞ùËØïÊ†πÊçÆ user_id Êü•ÊâæÁé∞ÊúâÁî®Êà∑
                        const { data: existingUserById, error: findByIdError } = await supabaseClient
                            .from('v_unified_analysis_v2')
                            .select('*')
                            .eq('id', githubUserId)
                            .maybeSingle();
                        
                        let updatedUser = null;
                        
                        if (existingUserById) {
                            // Áî®Êà∑Â∑≤Â≠òÂú®ÔºàÈÄöËøá user_idÔºâÔºåÊõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ
                            console.log('[Auth] ‚úÖ ÊâæÂà∞Áé∞ÊúâÁî®Êà∑ÔºàÈÄöËøá user_idÔºâÔºåÊõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ');
                            
                            const updatePayload = {
                                user_name: normalizedUsername,
                                user_identity: 'github',
                                updated_at: new Date().toISOString()
                            };
                            
                            // Â¶ÇÊûúÊúâ fingerprintÔºå‰πüÊõ¥Êñ∞Ôºà‰ΩÜ‰∏ç‰Ωú‰∏∫‰∏ªË¶ÅÊ†áËØÜÔºâ
                            if (currentFp) {
                                updatePayload.fingerprint = currentFp;
                            }
                            
                            const { data: updateData, error: updateError } = await supabaseClient
                                .from('user_analysis')
                                .update(updatePayload)
                                .eq('id', githubUserId) // „ÄêÂÖ≥ÈîÆ„Äë‰ΩøÁî® user_id ËÄå‰∏çÊòØ fingerprint
                                .select()
                                .single();
                            
                            if (updateError) {
                                console.error('[Auth] ‚ùå Êõ¥Êñ∞Áî®Êà∑Â§±Ë¥•:', updateError);
                                // Âç≥‰ΩøÊõ¥Êñ∞Â§±Ë¥•Ôºå‰πüÁªßÁª≠‰ΩøÁî®Áé∞ÊúâÁî®Êà∑Êï∞ÊçÆ
                                updatedUser = { ...existingUserById, ...updatePayload };
                            } else {
                                updatedUser = updateData;
                                console.log('[Auth] ‚úÖ Áî®Êà∑‰ø°ÊÅØÂ∑≤ÊàêÂäüÊõ¥Êñ∞Ôºà‰ΩøÁî® user_idÔºâ');
                            }
                        } else {
                            // Áî®Êà∑‰∏çÂ≠òÂú®ÔºåÂàõÂª∫Êñ∞ËÆ∞ÂΩïÔºà‰ΩøÁî® GitHub User IDÔºâ
                            console.log('[Auth] ‚úÖ Áî®Êà∑‰∏çÂ≠òÂú®ÔºåÂàõÂª∫Êñ∞ËÆ∞ÂΩïÔºà‰ΩøÁî® GitHub User IDÔºâ');
                            
                            const newUserData = {
                                id: githubUserId, // „ÄêÂÖ≥ÈîÆ„Äë‰ΩøÁî® GitHub User ID
                                user_name: normalizedUsername,
                                user_identity: 'github', // ÊòéÁ°ÆËÆæÁΩÆË∫´‰ªΩ
                                fingerprint: currentFp || null, // ÂèØÈÄâÔºöÂ¶ÇÊûúÊúâ fingerprint ‰πü‰øùÂ≠ò
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            };
                            
                            const { data: insertData, error: insertError } = await supabaseClient
                                .from('user_analysis')
                                .insert([newUserData])
                                .select()
                                .single();
                            
                            if (insertError) {
                                console.error('[Auth] ‚ùå ÂàõÂª∫Áî®Êà∑Â§±Ë¥•:', insertError);
                                
                                // „ÄêRLS ÈîôËØØÂ§ÑÁêÜ„ÄëÂ¶ÇÊûúÊòØ RLS Á≠ñÁï•ÈîôËØØÔºåÂ∞ùËØï‰ΩøÁî® upsert
                                if (insertError.code === '42501' || insertError.message?.includes('row-level security')) {
                                    console.log('[Auth] üîÑ RLS Á≠ñÁï•ÈòªÊ≠¢ÊèíÂÖ•ÔºåÂ∞ùËØï‰ΩøÁî® upsert...');
                                    
                                    const { data: upsertData, error: upsertError } = await supabaseClient
                                        .from('user_analysis')
                                        .upsert([newUserData], { onConflict: 'id' })
                                        .select()
                                        .single();
                                    
                                    if (upsertError) {
                                        console.error('[Auth] ‚ùå Upsert ‰πüÂ§±Ë¥•:', upsertError);
                                        // Âç≥‰ΩøÂ§±Ë¥•Ôºå‰πüÁªßÁª≠‰ΩøÁî®Êñ∞Áî®Êà∑Êï∞ÊçÆ
                                        updatedUser = newUserData;
                                    } else {
                                        updatedUser = upsertData;
                                        console.log('[Auth] ‚úÖ ÈÄöËøá upsert ÂàõÂª∫Áî®Êà∑ÊàêÂäü');
                                    }
                                } else {
                                    // ÂÖ∂‰ªñÈîôËØØÔºåÁªßÁª≠‰ΩøÁî®Êñ∞Áî®Êà∑Êï∞ÊçÆ
                                    updatedUser = newUserData;
                                }
                            } else {
                                updatedUser = insertData;
                                console.log('[Auth] ‚úÖ Êñ∞Áî®Êà∑Â∑≤ÂàõÂª∫Ôºà‰ΩøÁî® GitHub User IDÔºâ');
                            }
                        }
                        
                        // Êõ¥Êñ∞ window.allDataÔºàÂú® window.currentUser ËµãÂÄº‰πãÂêéÔºâ
                        const allData = window.allData || [];
                        const index = allData.findIndex(item => 
                            item.id === updatedUser.id ||
                            (item.fingerprint && item.fingerprint === currentFp) ||
                            (item.user_name && item.user_name.toLowerCase() === normalizedUsername)
                        );
                        
                        if (index !== -1) {
                            allData[index] = { ...allData[index], ...updatedUser };
                        } else {
                            allData.push(updatedUser);
                        }
                        window.allData = allData;
                        
                        // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„Äë‰ΩøÁî®ÂêàÂπ∂ÂêéÁöÑËÆ∞ÂΩï‰Ωú‰∏∫ currentUserÔºåÁ°Æ‰øùÂ∑¶‰æßÊäΩÂ±âËÉΩÊòæÁ§∫ allData ‰∏≠Â∑≤ÊúâÁöÑÁª¥Â∫¶/‰∫∫Ê†º/ÁÆ¥Ë®ÄÁ≠âÂÆåÊï¥Êï∞ÊçÆÔºàËÄåÈùû‰ªÖ upsert ËøîÂõûÁöÑÁÆÄÁï•Â≠óÊÆµÔºâ
                        window.currentUser = (index !== -1) ? allData[index] : updatedUser;
                        window.currentUserMatchedByFingerprint = true;
                        
                        // „ÄêTask 1„ÄëÊ∏ÖÈô§Êú¨Âú∞ÁöÑ user_fingerprint ÁºìÂ≠òÔºåÁªü‰∏Ä‰ΩøÁî® Supabase User ID
                        localStorage.removeItem('user_fingerprint');
                        console.log('[Auth] ‚úÖ Â∑≤Ê∏ÖÈô§Êú¨Âú∞ fingerprint ÁºìÂ≠ò');
                        
                        // „ÄêTask 1„ÄëÂ¶ÇÊûúÂΩìÂâçÁî®Êà∑ÊòØÊñ∞Ê≥®ÂÜåÁöÑÔºàdimensions ‰∏∫ nullÔºâÔºåÁ´ãÂç≥Ëß¶Âèë‰∏ÄÊ¨°ÈùôÈªòÂàÜÊûêËØ∑Ê±Ç
                        const hasDimensions = updatedUser.dimensions || 
                                            updatedUser.l_score !== null || 
                                            updatedUser.p_score !== null ||
                                            updatedUser.d_score !== null ||
                                            updatedUser.e_score !== null ||
                                            updatedUser.f_score !== null;
                        
                        if (!hasDimensions || 
                            (updatedUser.l_score === 50 && updatedUser.p_score === 50 && 
                             updatedUser.d_score === 50 && updatedUser.e_score === 50 && updatedUser.f_score === 50)) {
                            console.log('[Auth] üîç Ê£ÄÊµãÂà∞Êñ∞Áî®Êà∑Ôºàdimensions ‰∏∫Á©∫Êàñ‰∏∫ÈªòËÆ§ÂÄºÔºâÔºåËß¶ÂèëÈùôÈªòÂàÜÊûê...');
                            
                            // Â∞ùËØï‰ªé localStorage Ëé∑ÂèñÊúÄÂêé‰∏ÄÊ¨°ÂàÜÊûêÊï∞ÊçÆ
                            try {
                                const lastAnalysisData = localStorage.getItem('last_analysis_data');
                                if (lastAnalysisData) {
                                    const analysisData = JSON.parse(lastAnalysisData);
                                    console.log('[Auth] üìä ÊâæÂà∞Êú¨Âú∞ÁºìÂ≠òÁöÑÊúÄÂêé‰∏ÄÊ¨°ÂàÜÊûêÊï∞ÊçÆÔºåÂáÜÂ§áÂêåÊ≠•...');
                                    
                                    // Ë∞ÉÁî®ÂêéÁ´ØÂàÜÊûêÊé•Âè£ÂêåÊ≠•Êï∞ÊçÆ
                                    if (analysisData.chatData && analysisData.chatData.length > 0) {
                                        try {
                                            // „Äê‰øÆÂ§ç API Ë∑ØÂæÑ„Äë‰ΩøÁî® meta Ê†áÁ≠æ‰∏≠ÁöÑ api-endpoint
                                            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || 
                                                              'https://cursor-clinical-analysis.psterman.workers.dev/';
                                            const analyzeUrl = `${apiEndpoint}api/analyze`;
                                            
                                            const analyzeResponse = await fetch(analyzeUrl, {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'Authorization': `Bearer ${session.access_token}`
                                                },
                                                body: JSON.stringify({
                                                    ...analysisData,
                                                    userId: githubUserId,
                                                    user_name: normalizedUsername,
                                                    fingerprint: currentFp // ‰øÆÂ§ç ReferenceError
                                                })
                                            });
                                            
                                            if (analyzeResponse.ok) {
                                                const analyzeResult = await analyzeResponse.json();
                                                console.log('[Auth] ‚úÖ ÈùôÈªòÂàÜÊûêÂêåÊ≠•ÊàêÂäü:', analyzeResult);
                                                
                                                // „ÄêÂº∫Âà∂Âõ∫ÂåñÂ≠òÂÇ®„Äë‰øùÂ≠ò claim_token Âà∞ localStorage
                                                if (analyzeResult.claim_token) {
                                                    localStorage.setItem('vibe_claim_token', analyzeResult.claim_token);
                                                    console.log('[Auth] üîë ÂΩ±Â≠ê‰ª§ÁâåÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞:', analyzeResult.claim_token.substring(0, 8) + '...');
                                                }
                                                
                                                // Êõ¥Êñ∞ updatedUser Êï∞ÊçÆ
                                                if (analyzeResult.dimensions) {
                                                    updatedUser = { ...updatedUser, ...analyzeResult };
                                                    window.currentUser = updatedUser;
                                                    
                                                    // Êõ¥Êñ∞ allData
                                                    const allData = window.allData || [];
                                                    const userIndex = allData.findIndex(item => item.id === updatedUser.id);
                                                    if (userIndex !== -1) {
                                                        allData[userIndex] = updatedUser;
                                                    } else {
                                                        allData.push(updatedUser);
                                                    }
                                                    window.allData = allData;
                                                    
                                                    // „ÄêÈùôÈªòÂà∑Êñ∞„ÄëËß¶ÂèëÈ°µÈù¢Êï∞ÂÄºÂà∑Êñ∞
                                                    if (typeof window.refreshUserStats === 'function') {
                                                        try {
                                                            await window.refreshUserStats();
                                                            console.log('[Auth] ‚úÖ ÈùôÈªòÂà∑Êñ∞ÂÆåÊàê');
                                                        } catch (refreshError) {
                                                            console.warn('[Auth] ‚ö†Ô∏è ÈùôÈªòÂà∑Êñ∞Â§±Ë¥•:', refreshError);
                                                        }
                                                    }
                                                }
                                            } else {
                                                console.warn('[Auth] ‚ö†Ô∏è ÈùôÈªòÂàÜÊûêÂêåÊ≠•Â§±Ë¥•:', await analyzeResponse.text());
                                            }
                                        } catch (analyzeError) {
                                            console.warn('[Auth] ‚ö†Ô∏è ÈùôÈªòÂàÜÊûêÂêåÊ≠•ÂºÇÂ∏∏:', analyzeError);
                                        }
                                    }
                                } else {
                                    console.log('[Auth] ‚ÑπÔ∏è Êú™ÊâæÂà∞Êú¨Âú∞ÁºìÂ≠òÁöÑÊúÄÂêé‰∏ÄÊ¨°ÂàÜÊûêÊï∞ÊçÆ');
                                }
                            } catch (e) {
                                console.warn('[Auth] ‚ö†Ô∏è ËØªÂèñÊú¨Âú∞ÂàÜÊûêÊï∞ÊçÆÂ§±Ë¥•:', e);
                            }
                        }
                        
                        // „ÄêÈ°∫Â∫èÈáçÁªÑ„ÄëStep B: Ë∞ÉÁî® autoReportSelfÔºà‰∏äÊä•ÂΩìÂâçÂú∞ÁêÜ‰ΩçÁΩÆÔºåÁ°Æ‰øù GitHub Ë¥¶Âè∑Êúâ‰∫Ü lat/lngÔºâ
                        console.log('[Auth] üîÑ Step B: ÂºÄÂßã‰∏äÊä•Âú∞ÁêÜ‰ΩçÁΩÆ...');
                        try {
                            const reportResult = await autoReportSelf();
                            if (reportResult.success) {
                                console.log('[Auth] ‚úÖ Step B: Âú∞ÁêÜ‰ΩçÁΩÆ‰∏äÊä•ÊàêÂäü');
                            } else {
                                console.warn('[Auth] ‚ö†Ô∏è Step B: Âú∞ÁêÜ‰ΩçÁΩÆ‰∏äÊä•Â§±Ë¥•:', reportResult.error);
                            }
                        } catch (reportError) {
                            console.error('[Auth] ‚ùå Step B: Âú∞ÁêÜ‰ΩçÁΩÆ‰∏äÊä•ÂºÇÂ∏∏:', reportError);
                        }
                        
                        // „ÄêÈ°∫Â∫èÈáçÁªÑ„ÄëStep C: ÊúÄÂêéË∞ÉÁî® window.refreshUserStats() Âà∑Êñ∞ËßÜÂõæÊï∞ÊçÆ
                        console.log('[Auth] üîÑ Step C: ÂºÄÂßãÂà∑Êñ∞Áî®Êà∑ÁªüËÆ°Êï∞ÊçÆ...');
                        if (typeof window.refreshUserStats === 'function') {
                            try {
                                await window.refreshUserStats();
                                console.log('[Auth] ‚úÖ Step C: refreshUserStats ÊâßË°åÂÆåÊàê');
                            } catch (refreshError) {
                                // „Äê‰øÆÂ§ç AbortError„ÄëÁâπÊÆäÂ§ÑÁêÜ AbortError
                                if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                    console.log('[Auth] ‚ÑπÔ∏è refreshUserStats Ë¢´ÂèñÊ∂àÔºàÂèØËÉΩÊòØÈ°µÈù¢Âà∑Êñ∞ÂØºËá¥Ôºâ');
                                } else {
                                    console.error('[Auth] ‚ùå Step C: refreshUserStats ÊâßË°åÂ§±Ë¥•:', refreshError);
                                }
                            }
                            
                            // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÁ°Æ‰øù refreshUserStats ÂêéÔºåwindow.currentUser Â∑≤Ê≠£Á°ÆËÆæÁΩÆ
                            // Â¶ÇÊûú refreshUserStats Ê≤°ÊúâËÆæÁΩÆ currentUserÔºå‰ΩøÁî® updatedUser
                            if (!window.currentUser && updatedUser) {
                                console.log('[Auth] üîÑ refreshUserStats Êú™ËÆæÁΩÆ currentUserÔºå‰ΩøÁî® updatedUser');
                                window.currentUser = updatedUser;
                                
                                // Êõ¥Êñ∞ allData
                                const allData = window.allData || [];
                                const userIndex = allData.findIndex(item => item.id === updatedUser.id);
                                if (userIndex !== -1) {
                                    allData[userIndex] = updatedUser;
                                } else {
                                    allData.push(updatedUser);
                                }
                                window.allData = allData;
                            }
                            
                            // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÂ¶ÇÊûúÁî®Êà∑Êï∞ÊçÆÂ∑≤Â≠òÂú®‰ΩÜÊòæÁ§∫"Êï∞ÊçÆÂêåÊ≠•‰∏≠"ÔºåÂº∫Âà∂Âà∑Êñ∞ÁªüËÆ°Âç°Áâá
                            if (window.currentUser) {
                                const leftDrawer = document.getElementById('left-drawer');
                                const leftBody = document.getElementById('left-drawer-body');
                                
                                if (leftBody && typeof renderUserStatsCards === 'function') {
                                    // Ê£ÄÊü•ÊòØÂê¶Êúâ"Êï∞ÊçÆÂêåÊ≠•‰∏≠"Âç†‰ΩçÁ¨¶
                                    const syncingCards = leftBody.querySelectorAll('.drawer-item');
                                    let hasSyncingCard = false;
                                    syncingCards.forEach(card => {
                                        const label = card.querySelector('.drawer-item-label');
                                        if (label && (label.textContent === 'Êï∞ÊçÆÂêåÊ≠•‰∏≠' || label.textContent.includes('SYNCING'))) {
                                            hasSyncingCard = true;
                                        }
                                    });
                                    
                                    if (hasSyncingCard) {
                                        console.log('[Auth] üîÑ Ê£ÄÊµãÂà∞"Êï∞ÊçÆÂêåÊ≠•‰∏≠"Âç†‰ΩçÁ¨¶ÔºåÂº∫Âà∂Âà∑Êñ∞ÁªüËÆ°Âç°Áâá...');
                                        // ÁßªÈô§ÊâÄÊúâÁªüËÆ°Âç°ÁâáÔºà‰øùÁïôË∫´‰ªΩÈÖçÁΩÆÂç°ÁâáÔºâ
                                        syncingCards.forEach(card => {
                                            const label = card.querySelector('.drawer-item-label');
                                            if (label && (label.textContent === 'Êï∞ÊçÆÂêåÊ≠•‰∏≠' || label.textContent.includes('SYNCING') || label.textContent === 'ÊàëÁöÑÊï∞ÊçÆÁªüËÆ°')) {
                                                card.remove();
                                            }
                                        });
                                        // ÈáçÊñ∞Ê∏≤ÊüìÁî®Êà∑ÁªüËÆ°Âç°ÁâáÔºà‰ºòÂÖà‰ΩøÁî® allData ‰∏≠ÁöÑÂÆåÊï¥ËÆ∞ÂΩïÔºâ
                                        renderUserStatsCards(leftBody, getBestUserRecordForStats(window.currentUser));
                                        console.log('[Auth] ‚úÖ Â∑≤Âº∫Âà∂Âà∑Êñ∞ÁªüËÆ°Âç°Áâá');
                                    }
                                }
                                
                                // Âà∑Êñ∞ÊéíÂêçÂç°Áâá
                                if (typeof renderRankCards === 'function') {
                                    renderRankCards(window.currentUser);
                                }
                            }
                        } else {
                            console.warn('[Auth] ‚ö†Ô∏è window.refreshUserStats ÂáΩÊï∞‰∏çÂ≠òÂú®');
                        }
                        
                        // Êõ¥Êñ∞ UIÔºàÁ°Æ‰øùÂú®Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéËß¶ÂèëÔºâ
                        try {
                            updateAuthUI({ username: githubUsername, avatarUrl });
                            console.log('[Auth] ‚úÖ UI Â∑≤Êõ¥Êñ∞‰∏∫Â∑≤ÁôªÂΩïÁä∂ÊÄÅ');
                        } catch (uiError) {
                            console.error('[Auth] ‚ùå UI Êõ¥Êñ∞Â§±Ë¥•:', uiError);
                        }
                        
                        // Ëß¶ÂèëÂú∞ÂõæÂÆö‰ΩçËÑâÂÜ≤ÔºàÁ≠âÂæÖ window.allData Âä†ËΩΩÂÆåÊàêÔºâ
                        try {
                            // Á°Æ‰øù window.allData Â∑≤Âä†ËΩΩ
                            if (!window.allData || window.allData.length === 0) {
                                console.log('[Auth] ‚ö†Ô∏è allData Êú™Âä†ËΩΩÔºåÁ≠âÂæÖÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê...');
                                // Âª∂ËøüÊâßË°åÔºåÁ≠âÂæÖ fetchData ÂÆåÊàê
                                setTimeout(async () => {
                                    try {
                                        const location = await getUserLocation();
                                        if (location && location.lat && location.lng && typeof triggerMapPulse === 'function') {
                                            const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                                            const pulseColor = statusConfig.status_color || '#00ff41';
                                            triggerMapPulse(location.lng, location.lat, githubUsername, pulseColor, avatarUrl, githubUsername);
                                            console.log('[Auth] ‚úÖ Â∑≤Ëß¶ÂèëÂú∞ÂõæËÑâÂÜ≤ÔºàÂª∂ËøüÔºâ');
                                        }
                                    } catch (pulseError) {
                                        console.warn('[Auth] ‚ö†Ô∏è Ëß¶ÂèëÂú∞ÂõæËÑâÂÜ≤Â§±Ë¥•ÔºàÂª∂ËøüÔºâ:', pulseError);
                                    }
                                }, 1000);
                            } else {
                                const location = await getUserLocation();
                                if (location && location.lat && location.lng && typeof triggerMapPulse === 'function') {
                                    const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                                    const pulseColor = statusConfig.status_color || '#00ff41';
                                    triggerMapPulse(location.lng, location.lat, githubUsername, pulseColor, avatarUrl, githubUsername);
                                    console.log('[Auth] ‚úÖ Â∑≤Ëß¶ÂèëÂú∞ÂõæËÑâÂÜ≤');
                                }
                            }
                        } catch (pulseError) {
                            console.warn('[Auth] ‚ö†Ô∏è Ëß¶ÂèëÂú∞ÂõæËÑâÂÜ≤Â§±Ë¥•:', pulseError);
                        }
                        
                        // Ëá™Âä®ÊâìÂºÄÊäΩÂ±âÂπ∂ÊòæÁ§∫ÁªüËÆ°Âç°ÁâáÔºàÁ≠âÂæÖ window.allData Âä†ËΩΩÂÆåÊàêÔºâ
                        try {
                            // Á°Æ‰øù window.allData Â∑≤Âä†ËΩΩ
                            if (!window.allData || window.allData.length === 0) {
                                console.log('[Auth] ‚ö†Ô∏è allData Êú™Âä†ËΩΩÔºåÁ≠âÂæÖÊï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéÂÜçÊâìÂºÄÊäΩÂ±â...');
                                // Âª∂ËøüÊâßË°åÔºåÁ≠âÂæÖ fetchData ÂÆåÊàê
                                setTimeout(async () => {
                                    try {
                                        const location = await getUserLocation();
                                        const countryCode = location?.countryCode || updatedUser?.ip_location || null;
                                        const countryName = countryCode && countryNameMap[countryCode]
                                            ? (currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en)
                                            : (countryCode || 'ÂÖ®ÁêÉ');
                                        
                                        if (countryCode && countryCode !== 'ÂÖ®ÁêÉ') {
                                            showDrawersWithCountryData(countryCode, countryName);
                                            console.log('[Auth] ‚úÖ Â∑≤ÊâìÂºÄÊäΩÂ±âÂπ∂ÊòæÁ§∫Áî®Êà∑Êï∞ÊçÆÔºàÂª∂ËøüÔºâ');
                                        } else {
                                            const leftDrawer = document.getElementById('left-drawer');
                                            const leftBody = document.getElementById('left-drawer-body');
                                            if (leftDrawer && leftBody) {
                                                if (!leftDrawer.classList.contains('active')) {
                                                    leftDrawer.classList.add('active');
                                                    const rightDrawer = document.getElementById('right-drawer');
                                                    if (rightDrawer) {
                                                        rightDrawer.classList.add('active');
                                                    }
                                                }
                                                renderUserStatsCards(leftBody, getBestUserRecordForStats(updatedUser));
                                                console.log('[Auth] ‚úÖ Â∑≤Âà∑Êñ∞Áî®Êà∑ÁªüËÆ°Âç°ÁâáÔºàÂª∂ËøüÔºâ');
                                            }
                                        }
                                    } catch (drawerError) {
                                        console.warn('[Auth] ‚ö†Ô∏è ÊâìÂºÄÊäΩÂ±âÂ§±Ë¥•ÔºàÂª∂ËøüÔºâ:', drawerError);
                                    }
                                }, 1000);
                            } else {
                                const location = await getUserLocation();
                                const countryCode = location?.countryCode || updatedUser?.ip_location || null;
                                const countryName = countryCode && countryNameMap[countryCode]
                                    ? (currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en)
                                    : (countryCode || 'ÂÖ®ÁêÉ');
                                
                                if (countryCode && countryCode !== 'ÂÖ®ÁêÉ') {
                                    showDrawersWithCountryData(countryCode, countryName);
                                    console.log('[Auth] ‚úÖ Â∑≤ÊâìÂºÄÊäΩÂ±âÂπ∂ÊòæÁ§∫Áî®Êà∑Êï∞ÊçÆ');
                                } else {
                                    const leftDrawer = document.getElementById('left-drawer');
                                    const leftBody = document.getElementById('left-drawer-body');
                                    if (leftDrawer && leftBody) {
                                        if (!leftDrawer.classList.contains('active')) {
                                            leftDrawer.classList.add('active');
                                            const rightDrawer = document.getElementById('right-drawer');
                                            if (rightDrawer) {
                                                rightDrawer.classList.add('active');
                                            }
                                        }
                                        renderUserStatsCards(leftBody, getBestUserRecordForStats(updatedUser));
                                        console.log('[Auth] ‚úÖ Â∑≤Âà∑Êñ∞Áî®Êà∑ÁªüËÆ°Âç°Áâá');
                                    }
                                }
                            }
                        } catch (drawerError) {
                            console.warn('[Auth] ‚ö†Ô∏è ÊâìÂºÄÊäΩÂ±âÂ§±Ë¥•:', drawerError);
                        }
                        
                        // Âà∑Êñ∞ÊéíÂêçÂç°ÁâáÔºàÁ°Æ‰øùÂú®Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéÔºâ
                        try {
                            if (window.currentUser) {
                                renderRankCards(window.currentUser);
                                console.log('[Auth] ‚úÖ Â∑≤Âà∑Êñ∞ÊéíÂêçÂç°Áâá');
                            }
                        } catch (rankError) {
                            console.warn('[Auth] ‚ö†Ô∏è Âà∑Êñ∞ÊéíÂêçÂç°ÁâáÂ§±Ë¥•:', rankError);
                        }
                    }
                } else {
                    // Êú™ÁôªÂΩïÁä∂ÊÄÅ
                    updateAuthUI(null);
                }
            } catch (error) {
                console.error('[Auth] ‚ùå Â§ÑÁêÜËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñÂ§±Ë¥•:', error);
                updateAuthUI(null);
            } finally {
                // „ÄêÂºÇÊ≠•ÊµÅ‰øùÊä§„ÄëÂú® finally Âùó‰∏≠ÂøÖÈ°ªË∞ÉÁî® hideSyncingOverlay()ÔºåÁ°Æ‰øùÊó†ËÆ∫ÊàêÂäüÂ§±Ë¥•ÔºåUI ÈÅÆÁΩ©ÈÉΩËÉΩÊ∂àÂ§±
                if (timeoutTimer) {
                    clearTimeout(timeoutTimer);
                    timeoutTimer = null;
                }
                hideSyncingOverlay();
                migrationCompleted = true;
            }
        }
        
        /**
         * Êõ¥Êñ∞ËÆ§ËØÅ UIÔºàÁôªÂΩïÊåâÈíÆ/Áî®Êà∑‰ø°ÊÅØÊòæÁ§∫Ôºâ
         * @param {Object|null} userInfo - Áî®Êà∑‰ø°ÊÅØÂØπË±° { username, avatarUrl } Êàñ null
         */
        function updateAuthUI(userInfo) {
            // Êü•ÊâæËÆ§ËØÅ UI ÂÆπÂô®ÔºàÂèØËÉΩÂú®Â§ö‰∏™‰ΩçÁΩÆÔºâ
            const authContainers = [
                document.getElementById('auth-container'),
                document.querySelector('.auth-container'),
                document.querySelector('[data-auth-container]')
            ].filter(Boolean);
            
            // Â¶ÇÊûúÊ≤°Êúâ‰∏ìÈó®ÁöÑÂÆπÂô®ÔºåÂú®Â∑¶‰æßÊäΩÂ±â‰∏≠Êõ¥Êñ∞
            const leftBody = document.getElementById('left-drawer-body');
            const identityCard = leftBody ? leftBody.querySelector('.drawer-item:first-child') : null;
            
            if (userInfo) {
                // Â∑≤ÁôªÂΩïÁä∂ÊÄÅÔºöÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØ
                console.log('[Auth] ‚úÖ Êõ¥Êñ∞ UI ‰∏∫Â∑≤ÁôªÂΩïÁä∂ÊÄÅ:', userInfo.username);
                
                    // Êõ¥Êñ∞Â∑¶‰æßÊäΩÂ±â‰∏≠ÁöÑË∫´‰ªΩÂç°Áâá
                const leftBody = document.getElementById('left-drawer-body');
                if (leftBody) {
                    const identityCard = leftBody.querySelector('.drawer-item:first-child');
                    if (identityCard) {
                        const userInfoSection = identityCard.querySelector('.mb-3.pb-3.border-b');
                        const loginSection = identityCard.querySelector('#auth-login-section') || 
                                            identityCard.querySelector('.mt-3.pt-3.border-t');
                        
                        if (userInfoSection) {
                            userInfoSection.innerHTML = `
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-8 h-8 rounded-full overflow-hidden border border-[#00ff41]/30 flex-shrink-0">
                                        <img 
                                            src="${userInfo.avatarUrl}" 
                                            alt="Avatar" 
                                            class="w-full h-full object-cover"
                                            onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                        />
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="drawer-item-value text-sm truncate">${userInfo.username}</div>
                                        <div class="drawer-item-desc text-[8px]">GitHub Account</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Êõ¥Êñ∞ÁôªÂΩïÂå∫Âüü
                        if (loginSection) {
                            loginSection.innerHTML = `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <img 
                                            src="${userInfo.avatarUrl}" 
                                            alt="${userInfo.username}"
                                            class="w-6 h-6 rounded-full border border-[#00ff41]/30"
                                            onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                        />
                                        <div>
                                            <div class="text-[10px] text-white font-bold">${userInfo.username}</div>
                                            <a 
                                                href="https://github.com/${userInfo.username}" 
                                                target="_blank"
                                                class="text-[8px] text-[#00ff41]/60 hover:text-[#00ff41] transition-colors"
                                            >
                                                Êü•Áúã GitHub
                                            </a>
                                        </div>
                                    </div>
                                    <button 
                                        onclick="logout()"
                                        class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-[8px] text-zinc-400 hover:text-white transition-colors rounded"
                                    >
                                        ÈÄÄÂá∫
                                    </button>
                                </div>
                            `;
                        }
                    }
                }
            } else {
                // Êú™ÁôªÂΩïÁä∂ÊÄÅÔºöÊòæÁ§∫ÁôªÂΩïÊåâÈíÆ
                console.log('[Auth] ‚úÖ Êõ¥Êñ∞ UI ‰∏∫Êú™ÁôªÂΩïÁä∂ÊÄÅ');
                
                // Êõ¥Êñ∞Â∑¶‰æßÊäΩÂ±â‰∏≠ÁöÑË∫´‰ªΩÂç°Áâá
                const leftBody = document.getElementById('left-drawer-body');
                if (leftBody) {
                    const identityCard = leftBody.querySelector('.drawer-item:first-child');
                    if (identityCard) {
                        const userInfoSection = identityCard.querySelector('.mb-3.pb-3.border-b');
                        const loginSection = identityCard.querySelector('#auth-login-section') || 
                                            identityCard.querySelector('.mt-3.pt-3.border-t');
                        
                        if (userInfoSection) {
                            userInfoSection.innerHTML = `
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-8 h-8 rounded-full overflow-hidden border border-zinc-700 flex-shrink-0 bg-zinc-800 flex items-center justify-center">
                                        <span class="text-lg">üë§</span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="drawer-item-value text-sm text-zinc-500">Êú™ÁôªÂΩï</div>
                                        <div class="drawer-item-desc text-[8px]">ËØ∑‰ΩøÁî® GitHub ÁôªÂΩï</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // ÊõøÊç¢ÁôªÂΩïËæìÂÖ•Ê°Ü‰∏∫ÁôªÂΩïÊåâÈíÆ
                        if (loginSection) {
                            loginSection.innerHTML = `
                                <div class="drawer-item-label mb-2">GitHub ÁôªÂΩï</div>
                                <button 
                                    onclick="loginWithGitHub()"
                                    class="w-full px-4 py-3 bg-[#24292e] hover:bg-[#2f363d] border border-[#444d56] rounded-md text-white text-sm font-semibold flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl"
                                >
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>‰ΩøÁî® GitHub ÁôªÂΩï</span>
                                </button>
                                <div class="text-[8px] text-[#00ff41]/40 mt-2 text-center">
                                    ÂÆâÂÖ®„ÄÅÂø´ÈÄü„ÄÅ‰∏ÄÈîÆÁôªÂΩï
                                </div>
                            `;
                        }
                    }
                }
            }
        }
        
        /**
         * Ëé∑ÂèñÂΩìÂâçÊµèËßàÂô®ÊåáÁ∫πÔºà‰∏éÈ°µÈù¢Âä†ËΩΩÊó∂ÁîüÊàêÈÄªËæë‰∏ÄËá¥Ôºâ
         * @returns {Promise<string>} ÊåáÁ∫πÂ≠óÁ¨¶‰∏≤
         */
        async function getCurrentFingerprint() {
            try {
                // ÂÖàÂ∞ùËØï‰ªé localStorage ËØªÂèñ
                let fingerprint = localStorage.getItem('user_fingerprint');
                
                if (!fingerprint) {
                    // Â¶ÇÊûú‰∏çÂ≠òÂú®ÔºåÁîüÊàêÊñ∞ÁöÑÊåáÁ∫πÔºà‰∏é window.onload ‰∏≠ÁöÑÈÄªËæë‰∏ÄËá¥Ôºâ
                    const deviceInfo = {
                        userAgent: navigator.userAgent || '',
                        language: navigator.language || '',
                        platform: navigator.platform || '',
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || ''
                    };
                    const deviceString = JSON.stringify(deviceInfo);
                    const msgUint8 = new TextEncoder().encode(deviceString);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                    fingerprint = Array.from(new Uint8Array(hashBuffer))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                    
                    try {
                        localStorage.setItem('user_fingerprint', fingerprint);
                        console.log('[Fingerprint] üîë Â∑≤ÁîüÊàêËÆæÂ§á Fingerprint:', fingerprint.substring(0, 8) + '...');
                    } catch (e) {
                        console.warn('[Fingerprint] ‚ö†Ô∏è ‰øùÂ≠ò Fingerprint Âà∞ localStorage Â§±Ë¥•:', e);
                    }
                }
                
                return fingerprint;
            } catch (error) {
                console.error('[Fingerprint] ‚ùå Ëé∑ÂèñÊåáÁ∫πÂ§±Ë¥•:', error);
                return null;
            }
        }

        /**
         * ‰øùÂ≠òGitHubÁî®Êà∑ÂêçÂà∞localStorageÂπ∂ÁªëÂÆöÊåáÁ∫π
         * ‰ΩøÁî® Supabase ÂÆ¢Êà∑Á´ØÁõ¥Êé•Êõ¥Êñ∞ fingerprint Â≠óÊÆµ
         * „ÄêÂ¢ûÂº∫Áâà„ÄëÂåÖÂê´È≤ÅÊ£íÁöÑÂÖÉÁ¥†Ëé∑Âèñ„ÄÅÂº∫Âà∂ÊåáÁ∫πÁªëÂÆö„ÄÅUIÁä∂ÊÄÅËÅîÂä®
         */
        async function saveGitHubUsername() {
            // ============================================
            // 1. È≤ÅÊ£íÁöÑÂÖÉÁ¥†Ëé∑ÂèñÔºàÂ§öÈáçÈÄâÊã©Âô®Ôºâ
            // ============================================
            let input = null;
            let saveButton = null;
            
            // Â∞ùËØïÂ§öÁßçÊñπÂºèËé∑ÂèñËæìÂÖ•Ê°ÜÔºàÊîØÊåÅ‰∏ªËæìÂÖ•Ê°ÜÂíåÊäΩÂ±âËæìÂÖ•Ê°ÜÔºâ
            input = document.getElementById('githubUsername') ||
                   document.getElementById('drawer-github-username') ||
                   document.querySelector('#githubUsername') ||
                   document.querySelector('#drawer-github-username') ||
                   document.querySelector('input[id="githubUsername"]') ||
                   document.querySelector('input[id="drawer-github-username"]') ||
                   document.querySelector('input[placeholder*="GitHub"]') ||
                   document.querySelector('input[placeholder*="github"]');
            
            // Â¶ÇÊûúÊâæÂà∞ÊäΩÂ±âËæìÂÖ•Ê°ÜÔºåÂêåÊ≠•Âà∞‰∏ªËæìÂÖ•Ê°Ü
            if (input && input.id === 'drawer-github-username') {
                const mainInput = document.getElementById('githubUsername');
                if (mainInput) {
                    mainInput.value = input.value;
                    console.log('[GitHub] ‚úÖ Â∑≤ÂêåÊ≠•ÊäΩÂ±âËæìÂÖ•Ê°ÜÂà∞‰∏ªËæìÂÖ•Ê°Ü');
                }
            }
            
            // Â∞ùËØïËé∑Âèñ‰øùÂ≠òÊåâÈíÆÔºàÁî®‰∫éÊòæÁ§∫ Loading Áä∂ÊÄÅÔºâ
            saveButton = document.querySelector('button[onclick*="saveGitHubUsername"]') ||
                        document.querySelector('button:has-text("‰øùÂ≠ò")') ||
                        document.querySelector('.drawer-item button');
            
            // Â¶ÇÊûúÊâæ‰∏çÂà∞ËæìÂÖ•Ê°ÜÔºåÊâìÂç∞ËØ¶ÁªÜÁöÑ DOM ÁªìÊûÑË≠¶Âëä
            if (!input) {
                console.error('[GitHub] ‚ùå Êâæ‰∏çÂà∞ GitHub ËæìÂÖ•Ê°ÜÂÖÉÁ¥†');
                console.warn('[GitHub] üîç DOM ÁªìÊûÑËØäÊñ≠:', {
                    hasGetElementById: typeof document.getElementById === 'function',
                    allInputs: Array.from(document.querySelectorAll('input')).map(el => ({
                        id: el.id,
                        name: el.name,
                        placeholder: el.placeholder,
                        type: el.type
                    })),
                    bodyHTML: document.body ? document.body.innerHTML.substring(0, 500) : 'body ‰∏çÂ≠òÂú®'
                });
                alert('Êó†Ê≥ïÊâæÂà∞ GitHub ËæìÂÖ•Ê°ÜÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
                return;
            }
            
            // ============================================
            // 2. Ëé∑ÂèñÁî®Êà∑ÂêçÂπ∂È™åËØÅ
            // ============================================
            const username = input.value.trim();
            if (username === '') {
                // Â¶ÇÊûúËæìÂÖ•‰∏∫Á©∫ÔºåÊ∏ÖÈô§localStorage
                localStorage.removeItem('github_username');
                console.log('[GitHub] ‚úÖ Â∑≤Ê∏ÖÈô§GitHubÁî®Êà∑Âêç');
                alert('Â∑≤Ê∏ÖÈô§GitHubÁî®Êà∑Âêç');
                return;
            }
            
            // È™åËØÅ GitHub Áî®Êà∑ÂêçÊ†ºÂºè
            if (!isValidGitHubUsername(username)) {
                alert('GitHub Áî®Êà∑ÂêçÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑Ê£ÄÊü•ÂêéÈáçËØï');
                return;
            }
            
            // ============================================
            // 3. ÊòæÁ§∫ Loading Áä∂ÊÄÅ
            // ============================================
            const originalButtonText = saveButton ? saveButton.textContent : '';
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.textContent = '‰øùÂ≠ò‰∏≠...';
                saveButton.style.opacity = '0.6';
            }
            
            try {
                // ============================================
                // 4. Âº∫Âà∂ÊåáÁ∫πÁªëÂÆöÊµÅÔºàÂú® localStorage Êõ¥Êñ∞‰πãÂâçÂÆåÊàêÔºâ
                // ============================================
                
                // 4.1 Ëé∑ÂèñÂΩìÂâçÊåáÁ∫πÔºà‰ΩøÁî®Áªü‰∏ÄÁöÑÊåáÁ∫πÁîüÊàêÂáΩÊï∞Ôºâ
                const currentFingerprint = await getCurrentFingerprint();
                
                if (!currentFingerprint) {
                    console.warn('[GitHub] ‚ö†Ô∏è Êú™ÊâæÂà∞ÊåáÁ∫πÔºåÊó†Ê≥ïÁªëÂÆö');
                    alert('Êú™ÊâæÂà∞ËÆæÂ§áÊåáÁ∫πÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
                    return;
                }
                
                console.log('[GitHub] üîë ÂΩìÂâçÊåáÁ∫π:', currentFingerprint.substring(0, 8) + '...');
                
                // 4.2 Ê£ÄÊü• Supabase ÂÆ¢Êà∑Á´Ø
                if (!supabaseClient) {
                    console.error('[GitHub] ‚ùå Supabase ÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñ');
                    alert('Êï∞ÊçÆÂ∫ìËøûÊé•Êú™Â∞±Áª™ÔºåËØ∑Á®çÂÄôÂÜçËØï');
                    return;
                }
                
                // 4.3 ËßÑËåÉÂåñÁî®Êà∑ÂêçÔºàÂ∞èÂÜôÔºâ
                const normalizedUsername = username.toLowerCase().trim();
                
                console.log('[GitHub] üîó ÂºÄÂßãÁªëÂÆöÊåáÁ∫πÂà∞ user_name:', normalizedUsername);
                
                // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÁôªÂΩïÂêéÂøÖÈ°ª‰ΩøÁî® user_id ËøõË°åÊâÄÊúâÊìç‰ΩúÔºåËÄå‰∏çÊòØ fingerprint Êàñ user_name
                // ËøôÊòØ"ËÆ§Á•ñÂΩíÂÆó"ÁöÑÂÖ≥ÈîÆÔºöÁ°Æ‰øùÊï∞ÊçÆÂÖ≥ËÅîÂà∞Ê≠£Á°ÆÁöÑ GitHub Ë¥¶Âè∑
                let authenticatedUserId = null;
                let authenticatedSession = null;
                
                try {
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    if (!sessionError && session && session.user) {
                        authenticatedUserId = session.user.id;
                        authenticatedSession = session;
                        console.log('[GitHub] ‚úÖ Ê£ÄÊµãÂà∞Â∑≤ÁôªÂΩïÁî®Êà∑Ôºåuser_id:', authenticatedUserId.substring(0, 8) + '...');
                    }
                } catch (authError) {
                    console.warn('[GitHub] ‚ö†Ô∏è Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•:', authError);
                }
                
                let updatedUser = null;
                
                // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÂ¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÂøÖÈ°ª‰ΩøÁî® user_id ËøõË°åÊõ¥Êñ∞
                if (authenticatedUserId) {
                    console.log('[GitHub] üîó Â∑≤ÁôªÂΩïÔºå‰ΩøÁî® user_id ËøõË°åÊõ¥Êñ∞ÔºàËÆ§Á•ñÂΩíÂÆóÔºâ:', authenticatedUserId.substring(0, 8) + '...');
                    
                    // È¶ñÂÖàÂ∞ùËØïÊ†πÊçÆ user_id Êü•ÊâæÁé∞ÊúâÁî®Êà∑
                    const { data: existingUserById, error: findByIdError } = await supabaseClient
                        .from('v_unified_analysis_v2')
                        .select('*')
                        .eq('id', authenticatedUserId)
                        .maybeSingle();
                    
                    if (findByIdError && findByIdError.code !== 'PGRST116') {
                        console.error('[GitHub] ‚ùå Êü•ËØ¢Áî®Êà∑Â§±Ë¥•:', findByIdError);
                        throw new Error(`Êü•ËØ¢Â§±Ë¥•: ${findByIdError.message}`);
                    }
                    
                    // ÊâßË°åÊõ¥Êñ∞Ôºà‰ΩøÁî® user_idÔºâ
                    const updatePayload = {
                        user_name: normalizedUsername,
                        user_identity: 'github',
                        fingerprint: currentFingerprint, // ÂèØÈÄâÔºö‰øùÂ≠ò fingerprint ‰Ωú‰∏∫Â§áÁî®
                        updated_at: new Date().toISOString()
                    };
                    
                    const { data, error: updateError } = await supabaseClient
                        .from('user_analysis')
                        .update(updatePayload)
                        .eq('id', authenticatedUserId) // „ÄêÂÖ≥ÈîÆ„Äë‰ΩøÁî® user_id ËÄå‰∏çÊòØ user_name
                        .select()
                        .single();
                    
                    if (updateError) {
                        console.error('[GitHub] ‚ùå Êõ¥Êñ∞Áî®Êà∑Â§±Ë¥•:', updateError);
                        
                        // Â¶ÇÊûúÊõ¥Êñ∞Â§±Ë¥•ÔºåÂ∞ùËØï‰ΩøÁî® upsert
                        if (updateError.code === '42501' || updateError.message?.includes('row-level security')) {
                            console.log('[GitHub] üîÑ RLS Á≠ñÁï•ÈòªÊ≠¢Êõ¥Êñ∞ÔºåÂ∞ùËØï‰ΩøÁî® upsert...');
                            
                            const upsertPayload = {
                                id: authenticatedUserId,
                                user_name: normalizedUsername,
                                user_identity: 'github',
                                fingerprint: currentFingerprint,
                                updated_at: new Date().toISOString()
                            };
                            
                            const { data: upsertData, error: upsertError } = await supabaseClient
                                .from('user_analysis')
                                .upsert([upsertPayload], { onConflict: 'id' })
                                .select()
                                .single();
                            
                            if (upsertError) {
                                console.error('[GitHub] ‚ùå Upsert ‰πüÂ§±Ë¥•:', upsertError);
                                throw new Error(`Êõ¥Êñ∞Â§±Ë¥•: ${upsertError.message}`);
                            } else {
                                updatedUser = upsertData;
                                console.log('[GitHub] ‚úÖ ÈÄöËøá upsert Êõ¥Êñ∞Áî®Êà∑ÊàêÂäüÔºà‰ΩøÁî® user_idÔºâ');
                            }
                        } else {
                            throw new Error(`Êõ¥Êñ∞Â§±Ë¥•: ${updateError.message}`);
                        }
                    } else {
                        updatedUser = data;
                        console.log('[GitHub] ‚úÖ Áî®Êà∑‰ø°ÊÅØÂ∑≤ÊàêÂäüÊõ¥Êñ∞Ôºà‰ΩøÁî® user_idÔºâ');
                    }
                } else {
                    // „ÄêÈôçÁ∫ßÊñπÊ°à„ÄëÊú™ÁôªÂΩïÊó∂Ôºå‰ΩøÁî® user_name ËøõË°åÊõ¥Êñ∞ÔºàÂÖºÂÆπÊóßÈÄªËæëÔºâ
                    console.log('[GitHub] ‚ö†Ô∏è Êú™ÁôªÂΩïÔºå‰ΩøÁî® user_name ËøõË°åÊõ¥Êñ∞ÔºàÈôçÁ∫ßÊñπÊ°àÔºâ');
                    
                    // 4.4 È¶ñÂÖàÂ∞ùËØïÊ†πÊçÆ user_name Êü•ÊâæÁé∞ÊúâÁî®Êà∑
                    // „ÄêTask 2„ÄëÊü•ËØ¢Êó∂‰ΩøÁî®Áªü‰∏ÄËßÜÂõæ
                    const { data: existingUser, error: findError } = await supabaseClient
                        .from('v_unified_analysis_v2')
                        .select('*')
                        // GitHub Áî®Êà∑ÂêçÂ§ßÂ∞èÂÜô‰∏çÊïèÊÑüÔºöÈÅøÂÖç user_name Â§ßÂ∞èÂÜô‰∏ç‰∏ÄËá¥ÂØºËá¥Êü•‰∏çÂà∞
                        .ilike('user_name', normalizedUsername)
                        .maybeSingle();
                    
                    if (findError && findError.code !== 'PGRST116') { // PGRST116 Ë°®Á§∫Êú™ÊâæÂà∞ËÆ∞ÂΩïÔºåËøôÊòØÊ≠£Â∏∏ÁöÑ
                        console.error('[GitHub] ‚ùå Êü•ËØ¢Áî®Êà∑Â§±Ë¥•:', findError);
                        throw new Error(`Êü•ËØ¢Â§±Ë¥•: ${findError.message}`);
                    }
                    
                    // 4.5 ÊâßË°å UPSERT Êìç‰ΩúÔºàÊõ¥Êñ∞ÊàñÂàõÂª∫Ôºâ
                    if (existingUser) {
                        // Áî®Êà∑Â∑≤Â≠òÂú®ÔºåÊõ¥Êñ∞ fingerprint Â≠óÊÆµ
                        console.log('[GitHub] ‚úÖ ÊâæÂà∞Áé∞ÊúâÁî®Êà∑ÔºåÊõ¥Êñ∞ fingerprint Â≠óÊÆµ');
                        
                        // „Äê‰øÆÂ§ç„ÄëÂè™‰ΩøÁî® user_name Â≠óÊÆµÔºå‰∏ç‰ΩøÁî® github_username
                        const { data, error: updateError } = await supabaseClient
                                .from('user_analysis')
                                .update({
                                    fingerprint: currentFingerprint,
                                    user_name: normalizedUsername,
                                    updated_at: new Date().toISOString()
                                })
                                // GitHub Áî®Êà∑ÂêçÂ§ßÂ∞èÂÜô‰∏çÊïèÊÑüÔºöÈÅøÂÖç user_name Â§ßÂ∞èÂÜô‰∏ç‰∏ÄËá¥ÂØºËá¥Êõ¥Êñ∞‰∏çÂà∞
                                .ilike('user_name', normalizedUsername)
                                .select()
                                .single();
                        
                        if (updateError) {
                            console.error('[GitHub] ‚ùå Êõ¥Êñ∞Áî®Êà∑Â§±Ë¥•:', updateError);
                            throw new Error(`Êõ¥Êñ∞Â§±Ë¥•: ${updateError.message}`);
                        }
                        
                        updatedUser = data;
                        console.log('[GitHub] ‚úÖ ÊåáÁ∫πÂ∑≤ÊàêÂäüÊõ¥Êñ∞Âà∞Êï∞ÊçÆÂ∫ì');
                    } else {
                        // Áî®Êà∑‰∏çÂ≠òÂú®ÔºåÂàõÂª∫Êñ∞ËÆ∞ÂΩï
                        console.log('[GitHub] ‚úÖ Áî®Êà∑‰∏çÂ≠òÂú®ÔºåÂàõÂª∫Êñ∞ËÆ∞ÂΩï');
                        
                        // „Äê‰øÆÂ§ç„ÄëÂè™‰ΩøÁî® user_name Â≠óÊÆµÔºå‰∏ç‰ΩøÁî® github_username
                        const newUserData = {
                            id: crypto.randomUUID(),
                            user_name: normalizedUsername,
                            fingerprint: currentFingerprint,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        
                        const { data, error: insertError } = await supabaseClient
                            .from('user_analysis')
                            .insert([newUserData])
                            .select()
                            .single();
                        
                        if (insertError) {
                            console.error('[GitHub] ‚ùå ÂàõÂª∫Áî®Êà∑Â§±Ë¥•:', insertError);
                            throw new Error(`ÂàõÂª∫Â§±Ë¥•: ${insertError.message}`);
                        }
                        
                        updatedUser = data;
                        console.log('[GitHub] ‚úÖ Êñ∞Áî®Êà∑Â∑≤ÂàõÂª∫ÔºåÊåáÁ∫πÂ∑≤ÁªëÂÆö');
                    }
                }
                
                // ============================================
                // 5. Êõ¥Êñ∞ localStorageÔºàÂú®Êï∞ÊçÆÂ∫ìÊõ¥Êñ∞ÊàêÂäüÂêéÔºâ
                // ============================================
                localStorage.setItem('github_username', username);
                console.log('[GitHub] ‚úÖ Â∑≤‰øùÂ≠òGitHubÁî®Êà∑ÂêçÂà∞ localStorage:', username);
                
                // ============================================
                // 6. UI Áä∂ÊÄÅËÅîÂä®ÔºàÂú∞Âõæ‰∏éÂç°ÁâáÔºâ
                // ============================================
                console.log('[GitHub] üîÑ ÂºÄÂßãÂà∑Êñ∞ÂÖ®Â±ÄÊï∞ÊçÆÂíå UI...');
                
                // 6.1 Êõ¥Êñ∞ÂÖ®Â±ÄÁî®Êà∑Êï∞ÊçÆ
                window.currentUser = updatedUser;
                window.currentUserMatchedByFingerprint = true;
                
                // 6.2 Êõ¥Êñ∞ window.allData ‰∏≠ÁöÑÂØπÂ∫îËÆ∞ÂΩï
                const allData = window.allData || [];
                const index = allData.findIndex(item => 
                    item.id === updatedUser.id ||
                    (item.fingerprint && item.fingerprint === currentFingerprint) ||
                    (item.user_name && item.user_name.toLowerCase() === normalizedUsername)
                );
                
                if (index !== -1) {
                    allData[index] = { ...allData[index], ...updatedUser };
                    console.log('[GitHub] ‚úÖ Â∑≤Êõ¥Êñ∞ allData ‰∏≠ÁöÑËÆ∞ÂΩïÔºåÁ¥¢Âºï:', index);
                } else {
                    allData.push(updatedUser);
                    console.log('[GitHub] ‚úÖ Â∑≤Ê∑ªÂä†Êñ∞ËÆ∞ÂΩïÂà∞ allData');
                }
                window.allData = allData;
                
                // 6.3 Âà∑Êñ∞ÊéíÂêçÂç°Áâá
                if (window.currentUser) {
                    renderRankCards(window.currentUser);
                    console.log('[GitHub] ‚úÖ Â∑≤Âà∑Êñ∞ÊéíÂêçÂç°Áâá');
                }
                
                // 6.4 Ëß¶ÂèëÂú∞ÂõæËÑâÂÜ≤ÔºàÂ¶ÇÊûúÁî®Êà∑ÊúâÂú∞ÁêÜ‰ΩçÁΩÆ‰ø°ÊÅØÔºâ
                try {
                    // Ëé∑ÂèñÁî®Êà∑Âú∞ÁêÜ‰ΩçÁΩÆÔºàÊó†ËÆ∫Êï∞ÊçÆÂ∫ì‰∏≠ÊòØÂê¶ÊúâÔºåÈÉΩÂ∞ùËØïËé∑ÂèñÂΩìÂâç‰ΩçÁΩÆÔºâ
                    const location = await getUserLocation();
                    if (location && location.lat && location.lng && typeof triggerMapPulse === 'function') {
                        const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                        const pulseColor = statusConfig.status_color || '#00ff41';
                        const pulseLabel = normalizedUsername;
                        const avatarUrl = getGitHubAvatarUrl(normalizedUsername);
                        
                        triggerMapPulse(location.lng, location.lat, pulseLabel, pulseColor, avatarUrl, normalizedUsername);
                        console.log('[GitHub] ‚úÖ Â∑≤Ëß¶ÂèëÂú∞ÂõæËÑâÂÜ≤:', {
                            lng: location.lng,
                            lat: location.lat,
                            label: pulseLabel,
                            color: pulseColor
                        });
                    } else if (!location || !location.lat || !location.lng) {
                        console.log('[GitHub] ‚ÑπÔ∏è Êó†Ê≥ïËé∑ÂèñÂú∞ÁêÜ‰ΩçÁΩÆÔºåË∑≥ËøáÂú∞ÂõæËÑâÂÜ≤');
                    }
                } catch (pulseError) {
                    console.warn('[GitHub] ‚ö†Ô∏è Ëß¶ÂèëÂú∞ÂõæËÑâÂÜ≤Â§±Ë¥•:', pulseError);
                }
                
                // 6.5 Ëá™Âä®ÊâìÂºÄÊäΩÂ±âÂπ∂ÊòæÁ§∫Áî®Êà∑ÁªüËÆ°Âç°Áâá
                try {
                    // Ëé∑ÂèñÁî®Êà∑ÁöÑÂõΩÂÆ∂‰ª£Á†ÅÔºà‰ªé ip_location Êàñ locationÔºåÊàñ‰ªéÂú∞ÁêÜ‰ΩçÁΩÆËé∑ÂèñÔºâ
                    let userCountryCode = updatedUser.ip_location || updatedUser.location || null;
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÂõΩÂÆ∂‰ª£Á†ÅÔºåÂ∞ùËØï‰ªéÂú∞ÁêÜ‰ΩçÁΩÆËé∑Âèñ
                    if (!userCountryCode) {
                        try {
                            const location = await getUserLocation();
                            if (location && location.countryCode) {
                                userCountryCode = location.countryCode;
                                console.log('[GitHub] ‚úÖ ‰ªéÂú∞ÁêÜ‰ΩçÁΩÆËé∑ÂèñÂõΩÂÆ∂‰ª£Á†Å:', userCountryCode);
                            }
                        } catch (geoError) {
                            console.warn('[GitHub] ‚ö†Ô∏è Ëé∑ÂèñÂú∞ÁêÜ‰ΩçÁΩÆÂ§±Ë¥•:', geoError);
                        }
                    }
                    
                    const userCountryName = userCountryCode && countryNameMap[userCountryCode]
                        ? (currentLang === 'zh' ? countryNameMap[userCountryCode].zh : countryNameMap[userCountryCode].en)
                        : (userCountryCode || 'ÂÖ®ÁêÉ');
                    
                    // Ëé∑ÂèñÊäΩÂ±âÂÖÉÁ¥†
                    const leftDrawer = document.getElementById('left-drawer');
                    const leftBody = document.getElementById('left-drawer-body');
                    const rightDrawer = document.getElementById('right-drawer');
                    
                    if (userCountryCode && userCountryCode !== 'ÂÖ®ÁêÉ') {
                        // Â¶ÇÊûúÊúâÂõΩÂÆ∂‰ª£Á†ÅÔºåÊâìÂºÄÊäΩÂ±âÂπ∂ÊòæÁ§∫Áî®Êà∑Êï∞ÊçÆ
                        showDrawersWithCountryData(userCountryCode, userCountryName);
                        console.log('[GitHub] ‚úÖ Â∑≤ÊâìÂºÄÊäΩÂ±âÂπ∂ÊòæÁ§∫Áî®Êà∑Êï∞ÊçÆ:', userCountryCode);
                    } else {
                        // Â¶ÇÊûúÊ≤°ÊúâÂõΩÂÆ∂‰ª£Á†ÅÔºåÁõ¥Êé•Âà∑Êñ∞Â∑¶‰æßÊäΩÂ±âÁöÑÁªüËÆ°Âç°Áâá
                        // Â¶ÇÊûúÊäΩÂ±âÊú™ÊâìÂºÄÔºåÂÖàÊâìÂºÄÂÆÉ
                        if (leftDrawer && !leftDrawer.classList.contains('active')) {
                            leftDrawer.classList.add('active');
                            if (rightDrawer) {
                                rightDrawer.classList.add('active');
                            }
                            console.log('[GitHub] ‚úÖ Â∑≤ÊâìÂºÄÊäΩÂ±â');
                        }
                        
                        // Âà∑Êñ∞ÁªüËÆ°Âç°Áâá
                        if (leftBody) {
                            // ÁßªÈô§Á≠âÂæÖÂç°ÁâáÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                            const waitingCards = leftBody.querySelectorAll('.drawer-item');
                            waitingCards.forEach(card => {
                                const label = card.querySelector('.drawer-item-label');
                                if (label && (label.textContent === 'Êï∞ÊçÆÂä†ËΩΩ‰∏≠' || label.textContent.includes('WAIT'))) {
                                    card.remove();
                                    console.log('[GitHub] ‚úÖ Â∑≤ÁßªÈô§Á≠âÂæÖÂç°Áâá');
                                }
                            });
                            
                            // Ê∏≤ÊüìÁî®Êà∑ÁªüËÆ°Âç°ÁâáÔºà‰ºòÂÖà‰ΩøÁî® allData ‰∏≠ÁöÑÂÆåÊï¥ËÆ∞ÂΩïÔºâ
                            renderUserStatsCards(leftBody, getBestUserRecordForStats(updatedUser));
                            console.log('[GitHub] ‚úÖ Â∑≤Âà∑Êñ∞Áî®Êà∑ÁªüËÆ°Âç°Áâá');
                        }
                    }
                } catch (drawerError) {
                    console.warn('[GitHub] ‚ö†Ô∏è ÊâìÂºÄÊäΩÂ±âÂ§±Ë¥•:', drawerError);
                }
                
                // 6.6 ‰øÆÂ§ç"ÂåøÂêç‰∏ìÂÆ∂"ÊòæÁ§∫ÈóÆÈ¢òÔºöÊõ¥Êñ∞ÊâÄÊúâÊòæÁ§∫Áî®Êà∑ÂêçÁöÑ UI ÂÖÉÁ¥†
                try {
                    // Êõ¥Êñ∞Â∑¶‰æßÊäΩÂ±â‰∏≠ÁöÑÊòæÁ§∫ÂêçÁß∞
                    const leftTitle = document.getElementById('left-drawer-title');
                    if (leftTitle) {
                        const currentTitle = leftTitle.textContent || '';
                        if (!currentTitle.includes(normalizedUsername)) {
                            // ÁßªÈô§"ÔºàÂΩìÂâçËÆæÂ§áÔºâ"Ê†áËØÜÔºàÂ¶ÇÊûúÂ≠òÂú®ÔºâÔºåÁÑ∂ÂêéÊ∑ªÂä†Êñ∞ÁöÑ
                            const cleanTitle = currentTitle.replace(/\s*ÔºàÂΩìÂâçËÆæÂ§áÔºâ\s*$/, '');
                            leftTitle.textContent = normalizedUsername + 'ÔºàÂΩìÂâçËÆæÂ§áÔºâ';
                            console.log('[GitHub] ‚úÖ Â∑≤Êõ¥Êñ∞ÊäΩÂ±âÊ†áÈ¢ò:', leftTitle.textContent);
                        }
                    }
                    
                    // Êõ¥Êñ∞ÊâÄÊúâÊòæÁ§∫"ÂåøÂêç‰∏ìÂÆ∂"ÁöÑÂÖÉÁ¥†ÔºàÊõ¥Á≤æÁ°ÆÁöÑÂåπÈÖçÔºâ
                    const fingerprintPrefix = currentFingerprint.substring(0, 6).toUpperCase();
                    const anonymousPattern = new RegExp(`ÂåøÂêç‰∏ìÂÆ∂\\s+${fingerprintPrefix}`, 'i');
                    
                    // Êü•ÊâæÊâÄÊúâÂèØËÉΩÂåÖÂê´"ÂåøÂêç‰∏ìÂÆ∂"ÁöÑÂÖÉÁ¥†
                    const allElements = document.querySelectorAll('*');
                    let updateCount = 0;
                    
                    allElements.forEach(el => {
                        // Ë∑≥Ëøá script Âíå style Ê†áÁ≠æ
                        if (el.tagName === 'SCRIPT' || el.tagName === 'STYLE') {
                            return;
                        }
                        
                        // Ê£ÄÊü•ÊñáÊú¨ÂÜÖÂÆπ
                        if (el.textContent && anonymousPattern.test(el.textContent)) {
                            el.textContent = el.textContent.replace(anonymousPattern, normalizedUsername);
                            updateCount++;
                        }
                        
                        // Ê£ÄÊü•Â±ûÊÄßÂÄºÔºàÂ¶Ç placeholder, title Á≠âÔºâ
                        Array.from(el.attributes || []).forEach(attr => {
                            if (attr.value && anonymousPattern.test(attr.value)) {
                                el.setAttribute(attr.name, attr.value.replace(anonymousPattern, normalizedUsername));
                                updateCount++;
                            }
                        });
                    });
                    
                    if (updateCount > 0) {
                        console.log('[GitHub] ‚úÖ Â∑≤Êõ¥Êñ∞', updateCount, '‰∏™"ÂåøÂêç‰∏ìÂÆ∂"ÊòæÁ§∫');
                    }
                    
                    // Âº∫Âà∂Âà∑Êñ∞ÊéíÂêçÂç°Áâá‰∏≠ÁöÑÁî®Êà∑ÂêçÊòæÁ§∫
                    setTimeout(() => {
                        if (window.currentUser) {
                            renderRankCards(window.currentUser);
                            console.log('[GitHub] ‚úÖ Â∑≤Âº∫Âà∂Âà∑Êñ∞ÊéíÂêçÂç°ÁâáÔºà‰øÆÂ§çÂåøÂêç‰∏ìÂÆ∂ÊòæÁ§∫Ôºâ');
                        }
                    }, 100);
                    
                } catch (updateError) {
                    console.warn('[GitHub] ‚ö†Ô∏è Êõ¥Êñ∞ÂåøÂêç‰∏ìÂÆ∂ÊòæÁ§∫Â§±Ë¥•:', updateError);
                }
                
                // 6.7 Êõ¥Êñ∞Â§¥ÂÉèÊòæÁ§∫
                updateGitHubAvatar();
                
                // 6.8 Â¶ÇÊûúPresenceÈ¢ëÈÅìÂ∑≤ËøûÊé•ÔºåÁ´ãÂç≥ÂêåÊ≠•Áä∂ÊÄÅ
                if (presenceChannel) {
                    syncPresenceState().then(() => {
                        console.log('[GitHub] ‚úÖ Â∑≤Êõ¥Êñ∞Âú®Á∫øÁä∂ÊÄÅÔºàÂåÖÂê´Êñ∞Â§¥ÂÉèÔºâ');
                    }).catch((err) => {
                        console.warn('[GitHub] ‚ö†Ô∏è Êõ¥Êñ∞Âú®Á∫øÁä∂ÊÄÅÂ§±Ë¥•:', err);
                    });
                }
                
                // 6.9 ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫ÔºàÊ∏ÖÁêÜÊóßÁöÑÊåáÁ∫πÂåπÈÖçÊä•ÈîôÔºâ
                console.log('[GitHub] üéâ ÁªëÂÆöÊµÅÁ®ãÂÖ®ÈÉ®ÂÆåÊàêÔºÅ');
                alert('‚úÖ GitHubÁî®Êà∑ÂêçÂ∑≤‰øùÂ≠òÂπ∂ÁªëÂÆöÊàêÂäüÔºÅ\n\n' +
                      '‚Ä¢ ÊåáÁ∫πÂ∑≤Êõ¥Êñ∞Âà∞Êï∞ÊçÆÂ∫ì\n' +
                      '‚Ä¢ Âú∞ÂõæËÑâÂÜ≤Â∑≤Ëß¶Âèë\n' +
                      '‚Ä¢ ÁªüËÆ°Âç°ÁâáÂ∑≤Âà∑Êñ∞\n' +
                      '‚Ä¢ Áî®Êà∑ÂêçÂ∑≤Êõ¥Êñ∞');
                
            } catch (error) {
                const errorMessage = error && typeof error === 'object' && 'message' in error 
                    ? error.message 
                    : (typeof error === 'string' ? error : 'Êú™Áü•ÈîôËØØ');
                console.error('[GitHub] ‚ùå ÁªëÂÆöÊåáÁ∫πÂ§±Ë¥•:', error);
                alert(`ÁªëÂÆöÂ§±Ë¥•: ${errorMessage}\n\nËØ∑Ê£ÄÊü•Ôºö\n1. Supabase RLS Á≠ñÁï•ÊòØÂê¶ÂÖÅËÆ∏Êõ¥Êñ∞\n2. ÁΩëÁªúËøûÊé•ÊòØÂê¶Ê≠£Â∏∏\n3. ÊµèËßàÂô®ÊéßÂà∂Âè∞Êü•ÁúãËØ¶ÁªÜÈîôËØØ`);
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = originalButtonText || '‰øùÂ≠ò';
                    saveButton.style.opacity = '1';
                }
            }
        }

        /**
         * ‰ªélocalStorageÂä†ËΩΩGitHubÁî®Êà∑ÂêçÂπ∂Â°´ÂÖÖÂà∞ËæìÂÖ•Ê°Ü
         */
        /**
         * Êõ¥Êñ∞GitHubÂ§¥ÂÉèÊòæÁ§∫
         */
        function updateGitHubAvatar() {
            const input = document.getElementById('githubUsername');
            const avatarContainer = document.getElementById('githubAvatarContainer');
            const avatarImg = document.getElementById('githubAvatarImg');
            
            if (!input || !avatarContainer || !avatarImg) {
                return;
            }
            
            const username = input.value.trim();
            
            if (username && isValidGitHubUsername(username)) {
                // ÊòæÁ§∫Â§¥ÂÉèÂÆπÂô®
                avatarContainer.classList.remove('hidden');
                // ËÆæÁΩÆÂ§¥ÂÉèURL
                const avatarUrl = getGitHubAvatarUrl(username);
                avatarImg.src = avatarUrl;
                console.log('[GitHub] ‚úÖ Â∑≤Êõ¥Êñ∞Â§¥ÂÉè:', avatarUrl);
            } else {
                // ÈöêËóèÂ§¥ÂÉèÂÆπÂô®
                avatarContainer.classList.add('hidden');
            }
        }

        function loadGitHubUsername() {
            const input = document.getElementById('githubUsername');
            if (!input) {
                return;
            }
            
            const savedUsername = localStorage.getItem('github_username');
            if (savedUsername) {
                input.value = savedUsername;
                console.log('[GitHub] ‚úÖ Â∑≤Âä†ËΩΩ‰øùÂ≠òÁöÑGitHubÁî®Êà∑Âêç:', savedUsername);
                // Âä†ËΩΩÂ§¥ÂÉè
                updateGitHubAvatar();
            }
        }

        /**
         * Ëé∑ÂèñÁî®Êà∑Á≥ªÁªüÁâπÂæÅÔºàÂºÇÊ≠•ÈùûÈòªÂ°ûÔºâ
         * Áî®‰∫éÊï∞ÊçÆÈááÈõÜÁ´ØÔºåËé∑Âèñ timezone Âíå browser_lang
         * @returns {Promise<Object>} ÂåÖÂê´ timezone, browser_lang ÁöÑÂØπË±°
         */
        async function getUserSystemFeatures() {
            try {
                // ‰ΩøÁî® requestIdleCallback Á°Æ‰øùÈùûÈòªÂ°ûÔºå‰∏çÂΩ±ÂìçÈ°µÈù¢Âä†ËΩΩÈÄüÂ∫¶
                return new Promise((resolve) => {
                    const schedule = window.requestIdleCallback || ((cb) => setTimeout(cb, 0));
                    
                    schedule(() => {
                        // Ëé∑ÂèñÊó∂Âå∫Ôºö‰ΩøÁî® Intl.DateTimeFormat().resolvedOptions().timeZone
                        let timezone = 'Unknown';
                        try {
                            const formatter = new Intl.DateTimeFormat();
                            const resolvedOptions = formatter.resolvedOptions();
                            timezone = resolvedOptions.timeZone || 'Unknown';
                        } catch (err) {
                            console.warn('[SystemFeatures] ‚ö†Ô∏è Ëé∑ÂèñÊó∂Âå∫Â§±Ë¥•:', err);
                            timezone = 'Unknown';
                        }

                        // Ëé∑ÂèñÊµèËßàÂô®ËØ≠Ë®ÄÔºö‰ΩøÁî® navigator.language
                        const browser_lang = navigator.language || navigator.userLanguage || 'Unknown';

                        resolve({
                            timezone,
                            browser_lang
                        });
                    });
                });
            } catch (error) {
                console.error('[SystemFeatures] ‚ùå Ëé∑ÂèñÁ≥ªÁªüÁâπÂæÅÂ§±Ë¥•:', error);
                // ËøîÂõûÈªòËÆ§ÂÄºÔºåÁ°Æ‰øùÂáΩÊï∞‰∏ç‰ºöÈòªÂ°û
                return {
                    timezone: 'Unknown',
                    browser_lang: navigator.language || 'Unknown'
                };
            }
        }

        /**
         * Ëá™Âä®‰∏äÊä•ÂΩìÂâçÁî®Êà∑‰ø°ÊÅØÂà∞ user_analysis Ë°®
         * Âú® fetchData ÊâßË°åÊàêÂäüÂêéËá™Âä®Ë∞ÉÁî®
         * @returns {Promise<Object>} ‰∏äÊä•ÁªìÊûú
         */
        async function autoReportSelf() {
            // Ê†∏ÂøÉÊã¶Êà™ÔºöÂ¶ÇÊûúÂêéÁ´ØÂ∑≤Â≠òÊâãÂä®ÂùêÊ†áÔºåÊàñËÄÖÊú¨Âú∞Â≠òÊúâÈîÅÂÆöÊ†áËÆ∞ÔºåÁ¶ÅÊ≠¢ÊâßË°å IP ÂÆö‰Ωç
            if (window.currentUserData?.manual_lat || localStorage.getItem('loc_fixed') === 'true') {
                console.log('[Lock] üîí ‰ΩçÁΩÆÂ∑≤ÊâãÂä®ÈîÅÂÆöÔºåË∑≥ËøáËá™Âä®‰∏äÊä•');
                return;
            }
            // ÂÅ•Â£ÆÊÄßÊ£ÄÊü•ÔºöÁ°Æ‰øù Supabase ÂÆ¢Êà∑Á´ØÂ∑≤ÂàùÂßãÂåñ
            if (!supabaseClient) {
                console.warn('[AutoReport] ‚ö†Ô∏è Supabase ÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñÔºåË∑≥ËøáËá™Âä®‰∏äÊä•');
                return { success: false, error: 'Supabase ÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñ' };
            }

            try {
                console.log('[AutoReport] üöÄ ÂºÄÂßãËá™Âä®‰∏äÊä•Áî®Êà∑‰ø°ÊÅØ...');

                // „ÄêAutoReport Â¢ûÂº∫„ÄëÊ£ÄÊµãÊòØÂê¶Â∑≤ÁôªÂΩïÔºåÂ¶ÇÊûúÂ∑≤ÁôªÂΩïÂàôÊê∫Â∏¶ id
                let authenticatedUserId = null;
                let authenticatedSession = null;
                
                try {
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    if (!sessionError && session && session.user) {
                        authenticatedUserId = session.user.id;
                        authenticatedSession = session;
                        console.log('[AutoReport] ‚úÖ Ê£ÄÊµãÂà∞Â∑≤ÁôªÂΩïÁî®Êà∑Ôºåuser_id:', authenticatedUserId.substring(0, 8) + '...');
                    }
                } catch (authError) {
                    console.warn('[AutoReport] ‚ö†Ô∏è Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•:', authError);
                }

                // 1. Ëé∑ÂèñÁ≥ªÁªüÁâπÂæÅÔºàÊó∂Âå∫ÂíåËØ≠Ë®ÄÔºâ
                const systemFeatures = await getUserSystemFeatures();
                console.log('[AutoReport] üìä Á≥ªÁªüÁâπÂæÅÂ∑≤Ëé∑Âèñ:', systemFeatures);

                // 2. Ëé∑Âèñ IP ÂíåÂΩíÂ±ûÂú∞‰ø°ÊÅØ
                let ipInfo = null;
                let ipLocation = 'Unknown';
                let lat = null;
                let lng = null;
                let countryCode = 'Unknown';

                try {
                    // ‰ΩøÁî® ip-api.com API Ëé∑Âèñ IP ÂΩíÂ±ûÂú∞‰ø°ÊÅØÔºàÊõ¥Á®≥ÂÆöÁöÑÂÖçË¥π APIÔºâ
                    // ËøîÂõûÂ≠óÊÆµÔºöcountry, countryCode, city, lat, lon Á≠â
                    const ipResponse = await fetch('http://ip-api.com/json/', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (ipResponse.ok) {
                        ipInfo = await ipResponse.json();
                        console.log('[AutoReport] üåç IP ‰ø°ÊÅØÂ∑≤Ëé∑Âèñ:', ipInfo);

                        // ip-api.com ËøîÂõûÊ†ºÂºèÔºö{ country, countryCode, city, lat, lon, ... }
                        // ÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØ
                        countryCode = ipInfo.countryCode || ipInfo.country_code || 'Unknown';
                        
                        // ÊûÑÂª∫ ip_location Â≠óÁ¨¶‰∏≤Ôºà‰ΩøÁî®ÂõΩÂÆ∂‰ª£Á†ÅÔºâ
                        if (countryCode && countryCode !== 'Unknown') {
                            ipLocation = countryCode;
                        } else {
                            ipLocation = 'Unknown';
                        }
                        
                        // ÊèêÂèñÁªèÁ∫¨Â∫¶ÔºàÊ≥®ÊÑèÔºöip-api.com ‰ΩøÁî® lon ËÄå‰∏çÊòØ longitudeÔºâ
                        if (ipInfo.lat && ipInfo.lon) {
                            lat = Number(ipInfo.lat);
                            lng = Number(ipInfo.lon);
                        } else if (ipInfo.latitude && ipInfo.longitude) {
                            // ÂÖºÂÆπÂÖ∂‰ªñÂèØËÉΩÁöÑÂ≠óÊÆµÂêç
                            lat = Number(ipInfo.latitude);
                            lng = Number(ipInfo.longitude);
                        }
                    } else {
                        console.warn('[AutoReport] ‚ö†Ô∏è IP API ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂ∞ùËØïÂ§áÁî®ÊñπÊ°à...');
                        // Â§áÁî®ÊñπÊ°àÔºö‰ΩøÁî® ipify Ëé∑Âèñ IP
                        try {
                            const ipifyResponse = await fetch('https://api.ipify.org?format=json');
                            if (ipifyResponse.ok) {
                                const ipifyData = await ipifyResponse.json();
                                console.log('[AutoReport] üìç ‰ªé ipify Ëé∑ÂèñÂà∞ IP:', ipifyData.ip);
                                ipLocation = 'Unknown';
                            }
                        } catch (err) {
                            console.warn('[AutoReport] ‚ö†Ô∏è Â§áÁî® IP API ‰πüÂ§±Ë¥•:', err);
                        }
                    }
                } catch (error) {
                    console.warn('[AutoReport] ‚ö†Ô∏è Ëé∑Âèñ IP ‰ø°ÊÅØÂ§±Ë¥•:', error);
                    // ÁªßÁª≠ÊâßË°åÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº
                }

                // 3. VPN Âà§ÂÆöÈÄªËæë
                // Âà§ÂÆöÊù°‰ª∂ÔºöÂ¶ÇÊûú timezone ÊòØ 'Asia/Shanghai' ‰∏î IP ‰ΩçÁΩÆ‰∏çÂú®‰∏≠ÂõΩÔºåÊ†áËÆ∞‰∏∫ VPN
                const timezone = systemFeatures.timezone || 'Unknown';
                const isShanghaiTimezone = timezone === 'Asia/Shanghai';
                // Âè™ÊúâÂΩì countryCode ÊòéÁ°Æ‰∏çÊòØ 'CN' ‰∏î‰∏çÊòØ 'Unknown' Êó∂ÔºåÊâçÂà§ÂÆö‰∏∫‰∏çÂú®‰∏≠ÂõΩ
                const isNotChina = countryCode !== 'CN' && countryCode !== 'Unknown' && countryCode !== null;

                let is_vpn = false;
                // Âè™ÊúâÂú®Êó∂Âå∫ÊòØ Asia/Shanghai ‰∏î IP ÊòéÁ°Æ‰∏çÂú®‰∏≠ÂõΩÊó∂ÔºåÊâçÂà§ÂÆö‰∏∫ VPN
                if (isShanghaiTimezone && isNotChina) {
                    is_vpn = true;
                    console.log('[AutoReport] üîç VPN Âà§ÂÆö: Ê£ÄÊµãÂà∞ VPN Áî®Êà∑', {
                        timezone,
                        countryCode,
                        is_vpn: true,
                        reason: 'Êó∂Âå∫‰∏∫Asia/Shanghai‰ΩÜIP‰∏çÂú®‰∏≠ÂõΩ'
                    });
                } else {
                    // Â¶ÇÊûú‰ø°ÊÅØ‰∏çË∂≥ÔºàcountryCode ‰∏∫ UnknownÔºâÔºå‰∏çÂà§ÂÆö‰∏∫ VPN
                    const reason = countryCode === 'Unknown' || countryCode === null 
                        ? 'IP‰ΩçÁΩÆ‰ø°ÊÅØ‰∏çË∂≥ÔºåÊó†Ê≥ïÂà§ÂÆö' 
                        : (isShanghaiTimezone ? 'IP‰ΩçÁΩÆÊ≠£Â∏∏ÔºàÂú®‰∏≠ÂõΩÔºâ' : 'Êó∂Âå∫‰∏çÂåπÈÖç');
                    
                    console.log('[AutoReport] üîç VPN Âà§ÂÆö: Ê≠£Â∏∏Áî®Êà∑Êàñ‰ø°ÊÅØ‰∏çË∂≥', {
                        timezone,
                        countryCode,
                        is_vpn: false,
                        reason
                    });
                }

                // 4. ÁîüÊàêÈöèÊú∫ËÆøÂÆ¢Áî®Êà∑ÂêçÔºöGuest_XXXXÔºàXXXX‰∏∫4‰ΩçÈöèÊú∫Êï∞Â≠óÔºâ
                // „ÄêAutoReport Â¢ûÂº∫„ÄëÂ¶ÇÊûúÂ∑≤ÁôªÂΩïÔºå‰ΩøÁî® GitHub Áî®Êà∑Âêç
                let userName = null;
                if (authenticatedUserId && authenticatedSession) {
                    const githubUsername = authenticatedSession.user.user_metadata?.user_name || 
                                         authenticatedSession.user.user_metadata?.preferred_username ||
                                         authenticatedSession.user.user_metadata?.login ||
                                         authenticatedSession.user.email?.split('@')[0] || null;
                    if (githubUsername) {
                        userName = githubUsername.toLowerCase().trim();
                        console.log('[AutoReport] ‚úÖ ‰ΩøÁî® GitHub Áî®Êà∑Âêç:', userName);
                    }
                }
                
                if (!userName) {
                    const randomGuestId = Math.floor(1000 + Math.random() * 9000);
                    userName = `Guest_${randomGuestId}`;
                    console.log('[AutoReport] ‚ÑπÔ∏è ‰ΩøÁî®ËÆøÂÆ¢Áî®Êà∑Âêç:', userName);
                }

                // 5. ÊûÑÂª∫Êèê‰∫§Êï∞ÊçÆ
                // „ÄêAutoReport Â¢ûÂº∫„ÄëÂ¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÊê∫Â∏¶ idÔºàauth.uidÔºâÔºåÁ°Æ‰øùÊï∞ÊçÆÂ≠òÂÖ• GitHub Ë¥¶Âè∑ÂØπÂ∫îÁöÑË°å
                const payload = {
                    user_name: userName,
                    personality_type: 'AUTO_REPORT',
                    lat: lat,
                    lng: lng,
                    timezone: systemFeatures.timezone,
                    browser_lang: systemFeatures.browser_lang,
                    ip_location: ipLocation,
                    is_vpn: is_vpn
                };
                
                // „ÄêAutoReport Â¢ûÂº∫„ÄëÂ¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÊê∫Â∏¶ id
                if (authenticatedUserId) {
                    payload.id = authenticatedUserId;
                    payload.user_identity = 'github';
                    console.log('[AutoReport] ‚úÖ Â∑≤ÁôªÂΩïÔºåÊê∫Â∏¶ user_id:', authenticatedUserId.substring(0, 8) + '...');
                }

                console.log('[AutoReport] üì§ ÂáÜÂ§áÊèê‰∫§Êï∞ÊçÆÂà∞ user_analysis Ë°®:', payload);

                // 5. ÊèíÂÖ•Âà∞ SupabaseÔºàÂ¶ÇÊûúÂ∑≤ÁôªÂΩïÔºå‰ΩøÁî® upsert Á°Æ‰øùÊõ¥Êñ∞Âà∞Ê≠£Á°ÆÁöÑË°åÔºâ
                let data, error;
                if (authenticatedUserId) {
                    // Â∑≤ÁôªÂΩïÔºö‰ΩøÁî® upsertÔºå‰ª• id ‰∏∫ÂÜ≤Á™ÅÈîÆ
                    const { data: upsertData, error: upsertError } = await supabaseClient
                        .from('user_analysis')
                        .upsert([payload], { onConflict: 'id' })
                        .select();
                    data = upsertData;
                    error = upsertError;
                } else {
                    // Êú™ÁôªÂΩïÔºö‰ΩøÁî® insert
                    const { data: insertData, error: insertError } = await supabaseClient
                        .from('user_analysis')
                        .insert([payload])
                        .select();
                    data = insertData;
                    error = insertError;
                }

                if (error) {
                    console.error('[AutoReport] ‚ùå Êèê‰∫§Â§±Ë¥•:', error);
                    return { success: false, error: error.message };
                }

                console.log('[AutoReport] ‚úÖ Ëá™Âä®‰∏äÊä•ÊàêÂäü:', data);

                // 6. Á´ãÂç≥ÂèçÈ¶à:‰∏äÊä•ÊàêÂäüÂêéÁ´ãÂç≥Âú®Âú∞Âõæ‰∏äÊòæÁ§∫Ëá™Â∑±ÁöÑ‰ΩçÁΩÆ(‰∏çÁ≠âÂæÖ Realtime ÁõëÂê¨)
                if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
                    // ÊÄßËÉΩ‰øùÊä§:Ê£ÄÊü• setOrUpdateCurrentLocationCursor ÂáΩÊï∞ÊòØÂê¶Â∑≤ÂÆö‰πâ
                    if (typeof setOrUpdateCurrentLocationCursor === 'function') {
                        // Ëé∑ÂèñÁî®Êà∑Áä∂ÊÄÅÈ¢úËâ≤(‰ºòÂÖà‰ΩøÁî®ÂΩìÂâçÁä∂ÊÄÅÈ¢úËâ≤)
                        const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                        const statusColor = statusConfig.status_color;
                        // ‰ΩøÁî®Áä∂ÊÄÅÈ¢úËâ≤
                        const pulseColor = statusColor;

                        // Ëé∑ÂèñGitHubÁî®Êà∑ÂêçÂíåÂ§¥ÂÉèURL
                        // Âà§Êñ≠ÈÄªËæë:Â¶ÇÊûú github_username ‰∏∫Á©∫„ÄÅÊàñËÄÖÊòØÈªòËÆ§ÂÄº,Âàô‰∏çË¶ÅËØ∑Ê±Ç GitHub ÂõæÁâá
                        const githubUsername = localStorage.getItem('github_username') || null;
                        let avatarUrl = null;
                        
                        if (isValidGitHubUsername(githubUsername)) {
                            // Âè™ÊúâÊúâÊïàÁöÑGitHubÁî®Êà∑ÂêçÊâçÁîüÊàêÂ§¥ÂÉèURL
                            avatarUrl = getGitHubAvatarUrl(githubUsername);
                        } else {
                            // Êó†ÊïàÁî®Êà∑ÂêçÊó∂,‰ΩøÁî®ÈªòËÆ§Â§¥ÂÉè
                            avatarUrl = DEFAULT_AVATAR;
                        }
                        
                        // „Äê‰øÆÂ§ç„Äë‰ΩøÁî®ÊåÅ‰πÖÂåñÂÖâÊ†áÂáΩÊï∞ setOrUpdateCurrentLocationCursor ‰ª£Êõø triggerMapPulse
                        // ËøôÊ†∑ÂÖâÊ†á‰ºö‰∏ÄÁõ¥ÊòæÁ§∫,‰∏ç‰ºö5ÁßíÂêéÊ∂àÂ§±,Âπ∂‰∏îÊîØÊåÅÊâãÂä®ÂÆö‰ΩçÂíåÁº©ÊîæÊãñÂä®
                        try {
                            setOrUpdateCurrentLocationCursor(lng, lat, pulseColor, avatarUrl, githubUsername);
                            console.log('[AutoReport] üó∫Ô∏è Â∑≤Âú®Âú∞Âõæ‰∏äÊòæÁ§∫ÊåÅ‰πÖÂåñÂÖâÊ†á:', {
                                lng,
                                lat,
                                color: pulseColor,
                                status: currentUserStatus,
                                is_vpn,
                                avatarUrl,
                                githubUsername,
                                isValid: isValidGitHubUsername(githubUsername)
                            });
                            
                            // ‰øùÂ≠òÂÖâÊ†á‰ΩçÁΩÆÂà∞ÂÖ®Â±ÄÂèòÈáè,‰æõÂêéÁª≠‰ΩøÁî®
                            window.currentUserLocation = { lng, lat, color: pulseColor };
                        } catch (pulseError) {
                            console.warn('[AutoReport] ‚ö†Ô∏è Ë∞ÉÁî® setOrUpdateCurrentLocationCursor Â§±Ë¥•:', pulseError);
                        }
                    } else {
                        console.warn('[AutoReport] ‚ö†Ô∏è setOrUpdateCurrentLocationCursor ÂáΩÊï∞Êú™ÂÆö‰πâ,Ë∑≥ËøáÂú∞ÂõæÊòæÁ§∫');
                    }
                } else {
                    console.log('[AutoReport] ‚ÑπÔ∏è ÁªèÁ∫¨Â∫¶‰ø°ÊÅØ‰∏çÂÆåÊï¥,Ë∑≥ËøáÂú∞ÂõæÊòæÁ§∫');
                }

                return { success: true, data };

            } catch (error) {
                console.error('[AutoReport] ‚ùå Ëá™Âä®‰∏äÊä•ËøáÁ®ãÂá∫Èîô:', error);
                return { success: false, error: error.message };
            }
        }

        /**
         * Êèê‰∫§Áî®Êà∑ÂàÜÊûêÊï∞ÊçÆÂà∞ user_analysis Ë°®ÔºàÈááÈõÜÁ´ØÂ¢ûÂº∫Ôºâ
         * Âú® insert Êó∂Ëá™Âä®Â¢ûÂä† timezone Âíå browser_lang Â≠óÊÆµ
         * @param {string} user_name - Áî®Êà∑Âêç
         * @param {string} personality_type - ‰∫∫Ê†ºÁ±ªÂûã
         * @param {number} lat - Á∫¨Â∫¶
         * @param {number} lng - ÁªèÂ∫¶
         * @returns {Promise<Object>} Êèê‰∫§ÁªìÊûú
         */
        async function submitUserAnalysis(user_name, personality_type, lat, lng) {
            // ÂÅ•Â£ÆÊÄßÊ£ÄÊü•ÔºöÁ°Æ‰øù Supabase ÂÆ¢Êà∑Á´ØÂ∑≤ÂàùÂßãÂåñ
            if (!supabaseClient) {
                console.warn('[Submit] ‚ö†Ô∏è Supabase ÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñÔºåÊó†Ê≥ïÊèê‰∫§Êï∞ÊçÆ');
                return { success: false, error: 'Supabase ÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñ' };
            }

            try {
                // ÂºÇÊ≠•Ëé∑ÂèñÁ≥ªÁªüÁâπÂæÅÔºàÈùûÈòªÂ°ûÔºå‰∏çÂΩ±ÂìçÈ°µÈù¢Âä†ËΩΩÈÄüÂ∫¶Ôºâ
                const systemFeatures = await getUserSystemFeatures();
                console.log('[Submit] üìä Á≥ªÁªüÁâπÂæÅÂ∑≤Ëé∑Âèñ:', systemFeatures);

                // ÊûÑÂª∫Êèê‰∫§Êï∞ÊçÆÔºàÂåÖÂê´ timezone Âíå browser_lang Â≠óÊÆµÔºâ
                const payload = {
                    user_name: user_name || 'ÂåøÂêçÁî®Êà∑',
                    personality_type: personality_type || 'UNKNOWN',
                    lat: lat || null,
                    lng: lng || null,
                    timezone: systemFeatures.timezone, // ‰ΩøÁî® Intl.DateTimeFormat().resolvedOptions().timeZone
                    browser_lang: systemFeatures.browser_lang // ‰ΩøÁî® navigator.language
                };

                console.log('[Submit] üì§ ÂáÜÂ§áÊèê‰∫§Êï∞ÊçÆÂà∞ user_analysis Ë°®:', payload);

                // ‰ΩøÁî® Supabase ÂÆ¢Êà∑Á´ØÊèíÂÖ•Êï∞ÊçÆ
                const { data, error } = await supabaseClient
                    .from('user_analysis')
                    .insert([payload])
                    .select();

                if (error) {
                    console.error('[Submit] ‚ùå Êèê‰∫§Â§±Ë¥•:', error);
                    return { success: false, error: error.message };
                }

                console.log('[Submit] ‚úÖ Êï∞ÊçÆÂ∑≤ÊàêÂäüÊèê‰∫§ÔºàÂåÖÂê´ timezone Âíå browser_langÔºâ:', data);
                return { success: true, data };

            } catch (error) {
                console.error('[Submit] ‚ùå Êèê‰∫§ËøáÁ®ãÂá∫Èîô:', error);
                return { success: false, error: error.message };
            }
        }

        /**
         * Ëé∑ÂèñÂπ∂Ê∏≤ÊüìÂ§ßÁõòÊï∞ÊçÆ
         * Âü∫‰∫é index.ts ÁöÑÊé•Âè£ËøîÂõûÊ†ºÂºèÔºàÊï∞ÊçÆÁõ¥Êé•ËøîÂõûÔºå‰∏çÂåÖË£πÂú® data Â≠óÊÆµ‰∏≠Ôºâ
         */
        async function fetchData() {
            try {
                const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content;
                console.group('%c üöÄ Dashboard Data Sync Starting ', 'background: #222; color: #bada55; font-size: 12px;');
                // Âä†ËΩΩËøáÂú∫ÔºöÈ™®Êû∂Â±è + Êâ´ÊèèÁ∫ø
                setLoadingState(true);

                console.log(`[1/5] Ê≠£Âú®ËØ∑Ê±Ç: ${apiEndpoint}api/global-average`);
                const response = await fetch(`${apiEndpoint}api/global-average`);
                
                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
                
                const result = await response.json();
                console.log('[2/5] Êî∂Âà∞ÂéüÂßãÂìçÂ∫î:', result);

                // „ÄêÈÄÇÈÖçÂ±ÇÈáçÂÜô„Äë‰ΩøÁî®Âº∫Âà∂Êò†Â∞ÑÂ±ÇÊ†áÂáÜÂåñÊï∞ÊçÆ
                const data = normalizeData(result);
                console.log('[3/5] Êï∞ÊçÆÈÄÇÈÖçÂÆåÊàê:', data);

                // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáèÔºå‰æõËØ≠Ë®ÄÂàáÊç¢Êó∂‰ΩøÁî®
                window.lastData = data;

                // --- Ê∏≤ÊüìÊï∞Â≠óÂç°Áâá ---
                // „ÄêID Â≠òÂú®ÊÄßÊ£ÄÊü•„ÄëÂú®ÊâßË°å animateValue ÂâçÔºåÂøÖÈ°ªÊ£ÄÊü• document.getElementById ÊòØÂê¶ÈùûÁ©∫
                // „ÄêÂä®ÁîªÂÆπÈîô„ÄëÈò≤Ê≠¢ NaN Êàñ undefined ÂØºËá¥Â¥©Ê∫É
                
                // Êï∞ÊçÆËøîÂõûÔºöÁßªÈô§È™®Êû∂Â±èÂπ∂ÂºÄÂßãÊï∞Â≠óÊªöÂä®
                setLoadingState(false);

                // 1. Â∑≤ËØäÊñ≠ÂºÄÂèëËÄÖÔºàÂçÉÂàÜ‰ΩçÔºâ
                const totalUsers = data.totalUsers !== undefined && data.totalUsers !== null ? Number(data.totalUsers) : undefined;
                if (totalUsers !== undefined) {
                    animateValue('totalUsers', totalUsers, 1400, { decimals: 0, useThousands: true });
                }

                // 2. Êâ´ÊèèÊ¨°Êï∞ (totalAnalysis)
                const totalAnalysis = data.totalAnalysis !== undefined && data.totalAnalysis !== null ? Number(data.totalAnalysis) : undefined;
                if (totalAnalysis !== undefined) {
                    animateValue('totalAnalysis', totalAnalysis, 1400, { decimals: 0, useThousands: true });
                }

                // 3. Á¥ØËÆ°ÂêêÊßΩÂ≠óÊï∞ÔºöÁªëÂÆöÂà∞ json.totalChars (276355)
                const totalChars = data.totalChars !== undefined && data.totalChars !== null ? Number(data.totalChars) : (data.totalRoastWords !== undefined && data.totalRoastWords !== null ? Number(data.totalRoastWords) : undefined);
                if (totalChars !== undefined) {
                    animateValue('totalChars', totalChars, 1400, { decimals: 0, useThousands: true });
                }

                // 4. ‰∫∫ÂùáÂπ≥ÂùáÁØáÂπÖ (avgPerUser)ÔºötotalChars / totalUsers
                let avgPerUser = data.avgPerUser !== undefined && data.avgPerUser !== null ? Number(data.avgPerUser) : undefined;
                if ((avgPerUser === undefined || avgPerUser === 0) && totalChars !== undefined && data.totalUsers !== undefined && data.totalUsers > 0) {
                    avgPerUser = totalChars / Number(data.totalUsers);
                }
                if (avgPerUser !== undefined && avgPerUser > 0) {
                    animateValue('avgPerUser', avgPerUser, 900, { decimals: 1, useThousands: true });
                }

                // 5. ÂçïÊ¨°Âπ≥ÂùáÁØáÂπÖ (avgPerScan)ÔºötotalChars / totalAnalysis
                let avgPerScan = data.avgPerScan !== undefined && data.avgPerScan !== null ? Number(data.avgPerScan) : undefined;
                if ((avgPerScan === undefined || avgPerScan === 0) && totalChars !== undefined && data.totalAnalysis !== undefined && data.totalAnalysis !== null && data.totalAnalysis > 0) {
                    avgPerScan = totalChars / Number(data.totalAnalysis);
                }
                if (avgPerScan !== undefined && avgPerScan > 0) {
                    animateValue('avgPerScan', avgPerScan, 900, { decimals: 1, useThousands: true });
                }

                // 6. ËøêË°åÂ§©Êï∞
                const systemDays = data.systemDays !== undefined && data.systemDays !== null ? Number(data.systemDays) : undefined;
                if (systemDays !== undefined) {
                    animateValue('systemDays', systemDays, 900, { decimals: 0, useThousands: true });
                }

                // 7. Ë¶ÜÁõñÂüéÂ∏Ç
                const cityCount = data.cityCount !== undefined && data.cityCount !== null ? Number(data.cityCount) : undefined;
                if (cityCount !== undefined) {
                    animateValue('cityCount', cityCount, 900, { decimals: 0, useThousands: true });
                }

                // --- Ê∏≤Êüì‰∫∫Ê†ºÂàÜÂ∏ÉÊéíË°å ---
                // „Äê‰∫∫Ê†ºÊéíË°åÊ∏≤ÊüìÂáΩÊï∞„Äë‰ΩøÁî®Áã¨Á´ãÁöÑ renderPersonalityRank ÂáΩÊï∞
                renderPersonalityRank(data.personalityRank, data.recentVictims);

                // --- Ê∏≤ÊüìÂõæË°®ÁªÑ‰ª∂ ---
                // Ê∏≤ÊüìÂú∞ÁêÜ‰ΩçÁΩÆÁÉ≠ÂäõÊéíË°åÂíåÂú∞Âõæ
                if (data.locationRank && Array.isArray(data.locationRank) && data.locationRank.length > 0) {
                    // Ê£ÄÊü• ECharts ÊòØÂê¶Â∑≤Âä†ËΩΩ
                    if (typeof echarts === 'undefined') {
                        console.warn('[fetchData] ‚ö†Ô∏è ECharts Êú™Âä†ËΩΩÔºåÂª∂ËøüÂàùÂßãÂåñÂú∞Âõæ...');
                        // Âª∂ËøüÈáçËØïÂú∞ÂõæÂàùÂßãÂåñ
                        setTimeout(async () => {
                            if (typeof echarts !== 'undefined') {
                                try {
                                    await initGlobalMap(data.locationRank);
                                } catch (mapError) {
                                    console.error('[fetchData] ‚ùå Âª∂ËøüÂú∞ÂõæÂàùÂßãÂåñÂ§±Ë¥•:', mapError);
                                }
                            } else {
                                console.error('[fetchData] ‚ùå ECharts ‰ªçÊú™Âä†ËΩΩÔºåÊó†Ê≥ïÂàùÂßãÂåñÂú∞Âõæ');
                            }
                        }, 1000);
                    } else {
                        try {
                            await initGlobalMap(data.locationRank);
                        } catch (mapError) {
                            console.error('[fetchData] ‚ùå Âú∞ÂõæÂàùÂßãÂåñÂ§±Ë¥•:', mapError);
                            // Âç≥‰ΩøÂú∞ÂõæÂàùÂßãÂåñÂ§±Ë¥•Ôºå‰πüÁªßÁª≠Ê∏≤Êüì‰ΩçÁΩÆÂàóË°®
                        }
                    }
                    try {
                        renderLocationList(data.locationRank);
                    } catch (listError) {
                        console.error('[fetchData] ‚ùå ‰ΩçÁΩÆÂàóË°®Ê∏≤ÊüìÂ§±Ë¥•:', listError);
                    }
                } else {
                    const locationListEl = document.getElementById('locationList');
                    if (locationListEl) {
                        locationListEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">ÊöÇÊó†Êï∞ÊçÆ</div>';
                    }
                    // Âç≥‰ΩøÊ≤°ÊúâÊï∞ÊçÆÔºå‰πüÂ∞ùËØïÂàùÂßãÂåñÁ©∫Âú∞Âõæ
                    if (typeof echarts !== 'undefined') {
                        try {
                            await initGlobalMap([]);
                        } catch (mapError) {
                            console.warn('[fetchData] ‚ö†Ô∏è Á©∫Âú∞ÂõæÂàùÂßãÂåñÂ§±Ë¥•:', mapError);
                        }
                    }
                }
                
                // Ê∏≤ÊüìÈõ∑ËææÂõæÔºà‰ºòÂÖà‰ΩøÁî® globalAverageÔºåÂê¶Âàô‰ΩøÁî® averagesÔºâ
                // „ÄêÁéØÂ¢ÉÂØπÈΩê„ÄëÁ°Æ‰øùÊâÄÊúâÁöÑ Number() ËΩ¨Êç¢ÈÄªËæëÂú®ËµãÂÄºÂâçÂÆåÊàêÔºåÂΩªÂ∫ïÂà†Èô§Á°¨ÁºñÁ†Å
                const radarData = data.globalAverage || data.averages;
                if (radarData && typeof radarData === 'object' && typeof Chart !== 'undefined') {
                    // Á°Æ‰øùÊâÄÊúâÂÄºÈÉΩÊòØÊï∞Â≠óÁ±ªÂûãÔºåÂ¶ÇÊûúÊé•Âè£ÊúâÂÄºÂàôÂøÖÈ°ªÊòæÁ§∫Êé•Âè£ÁöÑÂÄº
                    const normalizedRadarData = {
                        L: radarData.L !== undefined && radarData.L !== null ? Number(radarData.L) : undefined,
                        P: radarData.P !== undefined && radarData.P !== null ? Number(radarData.P) : undefined,
                        D: radarData.D !== undefined && radarData.D !== null ? Number(radarData.D) : undefined,
                        E: radarData.E !== undefined && radarData.E !== null ? Number(radarData.E) : undefined,
                        F: radarData.F !== undefined && radarData.F !== null ? Number(radarData.F) : undefined,
                    };
                    console.log(`[Èõ∑ËææÂõæ] Êï∞ÊçÆ: L=${normalizedRadarData.L}, P=${normalizedRadarData.P}, D=${normalizedRadarData.D}, E=${normalizedRadarData.E}, F=${normalizedRadarData.F}`);
                    renderRadarChart(normalizedRadarData);
                } else {
                    console.warn('[Èõ∑ËææÂõæ] ‚ùå Êï∞ÊçÆÊ†ºÂºèÈîôËØØÊàñ Chart.js Êú™Âä†ËΩΩ');
                }
                
                // Ê∏≤ÊüìÂÆûÊó∂ËØäÊñ≠Ê¥ªÂä®Ôºà‰ºòÂÖà‰ΩøÁî® latestRecordsÔºâ
                const activityData = data.latestRecords && data.latestRecords.length > 0 
                    ? data.latestRecords 
                    : (data.recentVictims || []);
                
                // ÂàùÂßãÂåñÂÖ®Â±Ä latestRecords Êï∞ÁªÑÔºàÁî®‰∫é Realtime Êõ¥Êñ∞Ôºâ
                latestRecords = Array.isArray(activityData) ? [...activityData] : [];
                // Á°Æ‰øùÈïøÂ∫¶‰∏çË∂ÖËøá 10
                if (latestRecords.length > 10) {
                    latestRecords = latestRecords.slice(0, 10);
                }
                
                renderRecentActivity(latestRecords);

                // ÂàùÂßãÂåñ window.allDataÔºàÁî®‰∫é LPDEF ‰∏ìÂÆ∂Á≠õÈÄâ - ÈÄâÊãîÂêÑÁª¥Â∫¶ÊúÄÂº∫ÁéãËÄÖÔºâ
                // ‰ºòÂÖà‰ΩøÁî® latestRecordsÔºàÂåÖÂê´ÊâÄÊúâÁî®Êà∑Êï∞ÊçÆÔºâÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî® recentVictims
                const allDataArray = Array.isArray(data.latestRecords) && data.latestRecords.length > 0
                    ? [...data.latestRecords]
                    : (Array.isArray(data.recentVictims) && data.recentVictims.length > 0
                        ? [...data.recentVictims]
                        : []);
                
                // „ÄêÂÖ®ÁêÉÊúÄÂº∫Êï∞ÊçÆÊèêÂèñ„ÄëÈÅçÂéÜ latestRecords ÊâæÂà∞Á¨¨‰∏Ä‰∏™ jiafang_count > 0 ÁöÑËÆ∞ÂΩï‰Ωú‰∏∫'ÂÖ®ÁêÉÊúÄÂº∫'ÁöÑÂ±ïÁ§∫Êï∞ÊçÆ
                let globalChampionRecord = null;
                if (allDataArray.length > 0) {
                    globalChampionRecord = allDataArray.find(record => {
                        const jiafangCount = record.jiafang_count !== undefined && record.jiafang_count !== null ? Number(record.jiafang_count) : 0;
                        return jiafangCount > 0;
                    });
                    if (globalChampionRecord) {
                        console.log('[Global] ‚úÖ ÊâæÂà∞ÂÖ®ÁêÉÊúÄÂº∫ËÆ∞ÂΩïÔºàjiafang_count > 0Ôºâ:', globalChampionRecord);
                        // Â∞ÜÂÖ®ÁêÉÊúÄÂº∫ËÆ∞ÂΩïÂ≠òÂÇ®Âà∞ÂÖ®Â±ÄÂèòÈáè
                        window.globalChampionRecord = globalChampionRecord;
                    }
                }
                
                window.allData = allDataArray;
                console.log(`[LPDEF] üì¶ Â∑≤ÂàùÂßãÂåñ window.allDataÔºåÂÖ± ${allDataArray.length} Êù°Êï∞ÊçÆÔºàÁî®‰∫éÈÄâÊãîÊúÄÂº∫ÁéãËÄÖÔºâ`);

                // Ê≥®ÊÑèÔºöLPDEF ‰∏ìÂÆ∂Âç°ÁâáÂ∞ÜÂú® window.onload ÁöÑË∫´‰ªΩÊ£ÄÊü•ÂêéÊ∏≤Êüì
                // ËøôÈáå‰∏çË∞ÉÁî® renderLPDEFExpertsÔºåÈÅøÂÖçË¶ÜÁõñË∫´‰ªΩÊ£ÄÊü•ÁöÑÁªìÊûú

                console.log('%c [5/5] ‚úÖ Ê∏≤ÊüìÈÄªËæëÂêåÊ≠•ÂÆåÊØï ', 'color: #00ff41');

                // ÊâßË°åËá™Âä®‰∏äÊä•ÔºàÂºÇÊ≠•Ôºå‰∏çÈòªÂ°û‰∏ªÊµÅÁ®ãÔºâ
                autoReportSelf().catch(err => {
                    console.warn('[AutoReport] ‚ö†Ô∏è Ëá™Âä®‰∏äÊä•Â§±Ë¥•Ôºà‰∏çÂΩ±Âìç‰∏ªÊµÅÁ®ãÔºâ:', err);
                });

            } catch (err) {
                console.error('[ERROR] Dashboard Ê∏≤ÊüìÂ¥©Ê∫É:', err);
                
                // ÊòæÁ§∫ÈîôËØØÊèêÁ§∫
                const container = document.querySelector('.max-w-\\[1600px\\]');
                if (container) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed top-4 right-4 bg-red-900/80 text-white px-4 py-2 rounded border border-red-500 z-50';
                    errorDiv.textContent = `ÈîôËØØ: ${err.message || 'Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•'}`;
                    container.appendChild(errorDiv);
                    
                    setTimeout(() => {
                        errorDiv.remove();
                    }, 5000);
                }
            } finally {
                // Á°Æ‰øùÂºÇÂ∏∏ÊÉÖÂÜµ‰∏ã‰πüÂÖ≥Èó≠Âä†ËΩΩËøáÂú∫
                setLoadingState(false);
                console.groupEnd();
            }
        }

        /**
         * Âä†ËΩΩ rank-content.ts Êï∞ÊçÆ
         */
        async function loadRankResources() {
            try {
                // ‰ºòÂåñÔºö‰ºòÂÖàÂ∞ùËØïËØªÂèñ TS Êñá‰ª∂ÔºàÂõ†‰∏∫ÁéØÂ¢ÉÁõÆÂâçËß£Êûê TS Êñá‰ª∂Êõ¥Á®≥ÂÆöÔºâ
                const tsPaths = [
                    './src/rank-content.ts',
                    '../src/rank-content.ts',
                    '/src/rank-content.ts',
                    'src/rank-content.ts'
                ];
                
                let text = null;
                let lastError = null;
                
                // ‰ºòÂÖàÂ∞ùËØïÊØè‰∏™ TS Ë∑ØÂæÑ
                for (const path of tsPaths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            const contentType = response.headers.get('content-type') || '';
                            // Ê£ÄÊü•ÊòØÂê¶ÊòØÊñáÊú¨Êñá‰ª∂ÔºàTS/JS Êñá‰ª∂Ôºâ
                            if (contentType.includes('text/') || contentType.includes('application/javascript') || contentType.includes('application/typescript')) {
                                text = await response.text();
                                console.log(`[Rank] ‚úÖ ÊàêÂäü‰ªé ${path} Âä†ËΩΩ TS Êñá‰ª∂`);
                                break;
                            } else {
                                console.debug(`[Rank] ${path} ËøîÂõûÁöÑ‰∏çÊòØÊñáÊú¨Ê†ºÂºè (Content-Type: ${contentType})ÔºåË∑≥Ëøá`);
                            }
                        } else {
                            console.debug(`[Rank] ${path} ËøîÂõûÁä∂ÊÄÅÁ†Å ${response.status}ÔºåË∑≥Ëøá`);
                        }
                    } catch (err) {
                        lastError = err;
                        console.debug(`[Rank] TS Ë∑ØÂæÑ ${path} Âä†ËΩΩÂ§±Ë¥•:`, err.message);
                    }
                }
                
                // Â¶ÇÊûú TS Êñá‰ª∂Âä†ËΩΩÊàêÂäüÔºåËß£ÊûêÂπ∂ËøîÂõû
                if (text) {
                    // ‰ΩøÁî®Êõ¥ÂÅ•Â£ÆÁöÑÊ≠£ÂàôÊèêÂèñ JSON ÂØπË±°
                    // ‰ªéÁ¨¨‰∏Ä‰∏™ { Âà∞ÊúÄÂêé‰∏Ä‰∏™ } ‰πãÈó¥ÁöÑÂÜÖÂÆπ
                    const firstBrace = text.indexOf('{');
                    const lastBrace = text.lastIndexOf('}');
                    
                    if (firstBrace === -1 || lastBrace === -1 || firstBrace >= lastBrace) {
                        console.warn('[Rank] ‚ö†Ô∏è Êó†Ê≥ï‰ªé rank-content.ts ‰∏≠ÊâæÂà∞ÊúâÊïàÁöÑ JSON ÂØπË±°');
                        return false;
                    }
                    
                    const jsonText = text.substring(firstBrace, lastBrace + 1);
                    
                    // Ê∏ÖÁêÜÊñáÊú¨ÔºöÁßªÈô§Ê≥®ÈáäÂíåÁ±ªÂûãÊ≥®Ëß£
                    let cleaned = jsonText
                        .replace(/\/\*[\s\S]*?\*\//g, '') // ÁßªÈô§ÂùóÊ≥®Èáä
                        .replace(/\/\/.*$/gm, '') // ÁßªÈô§Ë°åÊ≥®Èáä
                        .replace(/:\s*Record<string,\s*any>/g, '') // ÁßªÈô§Á±ªÂûãÊ≥®Ëß£
                        .replace(/:\s*any/g, ''); // ÁßªÈô§ÂÖ∂‰ªñ any Á±ªÂûãÊ≥®Ëß£
                    
                    // Â∞ùËØïËß£Êûê‰∏∫ JSON
                    try {
                        RANK_RESOURCES = JSON.parse(cleaned);
                        console.log('[Rank] ‚úÖ Áª¥Â∫¶ÊéíÂêçÊï∞ÊçÆÂä†ËΩΩÊàêÂäüÔºà‰ªé TS Êñá‰ª∂ JSON Ëß£ÊûêÔºâ');
                        return true;
                    } catch (e) {
                        console.warn(`[Rank] ‚ö†Ô∏è ‰ªé TS Êñá‰ª∂Ëß£Êûê JSON Â§±Ë¥•: ${e.message}`);
                        return false;
                    }
                }
                
                // Â¶ÇÊûú TS Êñá‰ª∂Âä†ËΩΩÂ§±Ë¥•ÔºåÈùôÈªòÂ∞ùËØï JSON Êñá‰ª∂Ôºà‰Ωú‰∏∫Â§áÈÄâÔºâ
                const jsonPaths = [
                    './rank-data.json',
                    '../rank-data.json',
                    '/rank-data.json',
                    'rank-data.json'
                ];
                
                // ÈùôÈªòÂ∞ùËØï JSON Êñá‰ª∂Ôºà‰ΩøÁî® console.debug ÈÅøÂÖçÂπ≤Êâ∞ÊéßÂà∂Âè∞Ôºâ
                for (const path of jsonPaths) {
                    try {
                        const response = await fetch(path);
                        // Ê£ÄÊü•ÂìçÂ∫îÁä∂ÊÄÅÂíå Content-TypeÔºåÈÅøÂÖç 404 ËøîÂõû HTML ÂØºËá¥ÁöÑËß£ÊûêÈîôËØØ
                        if (response.ok) {
                            const contentType = response.headers.get('content-type') || '';
                            // Á°Æ‰øùÂìçÂ∫îÊòØ JSON Ê†ºÂºèÔºåËÄå‰∏çÊòØ HTML ÈîôËØØÈ°µÈù¢
                            if (contentType.includes('application/json') || contentType.includes('text/json')) {
                                const jsonData = await response.json();
                                RANK_RESOURCES = jsonData;
                                console.log(`[Rank] ‚úÖ ÊàêÂäü‰ªé ${path} Âä†ËΩΩ JSON Êï∞ÊçÆ`);
                                return true;
                            } else {
                                // Â¶ÇÊûú Content-Type ‰∏çÊòØ JSONÔºåÂèØËÉΩÊòØ 404 ËøîÂõûÁöÑ HTMLÔºåÈùôÈªòË∑≥Ëøá
                                console.debug(`[Rank] ${path} ËøîÂõûÁöÑ‰∏çÊòØ JSON Ê†ºÂºè (Content-Type: ${contentType})ÔºåË∑≥Ëøá`);
                            }
                        } else {
                            // ÂìçÂ∫îÁä∂ÊÄÅ‰∏çÊòØ 200-299ÔºåÈùôÈªòË∑≥Ëøá
                            console.debug(`[Rank] ${path} ËøîÂõûÁä∂ÊÄÅÁ†Å ${response.status}ÔºåË∑≥Ëøá`);
                        }
                    } catch (err) {
                        // ÁΩëÁªúÈîôËØØÊàñÂÖ∂‰ªñÂºÇÂ∏∏ÔºåÈùôÈªòËÆ∞ÂΩï
                        console.debug(`[Rank] JSON Ë∑ØÂæÑ ${path} Âä†ËΩΩÂ§±Ë¥•:`, err.message);
                    }
                }
                
                // Â¶ÇÊûúÊâÄÊúâË∑ØÂæÑÈÉΩÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ΩÜ‰∏çÊäõÂá∫ÂºÇÂ∏∏ÔºåÂÖÅËÆ∏È°µÈù¢ÁªßÁª≠Âä†ËΩΩ
                console.warn(`[Rank] ‚ö†Ô∏è ÊâÄÊúâË∑ØÂæÑÈÉΩÂä†ËΩΩÂ§±Ë¥•„ÄÇÊúÄÂêéÈîôËØØ: ${lastError?.message || 'Êú™Áü•ÈîôËØØ'}`);
                return false;
            } catch (error) {
                console.error('[Rank] ‚ùå Âä†ËΩΩÊéíÂêçÊï∞ÊçÆÂ§±Ë¥•:', error);
                // ËøîÂõû falseÔºå‰ΩÜ‰∏çÈòªÊ≠¢È°µÈù¢ÁªßÁª≠Âä†ËΩΩ
                // Ê∏≤ÊüìÊó∂‰ºöÊòæÁ§∫Âä†ËΩΩ‰∏≠ÁöÑÊèêÁ§∫
                return false;
            }
        }

        /**
         * Ê†πÊçÆÁª¥Â∫¶IDÂíåÊï∞ÂÄºËé∑ÂèñÁ≠âÁ∫ßÂèçÈ¶à
         * @param {string} dimId - Áª¥Â∫¶ID (ai, word, day, no, say, please)
         * @param {number} value - Êï∞ÂÄº
         * @returns {Object|null} ÂåÖÂê´ label, title, content ÁöÑÂØπË±°ÔºåÂ¶ÇÊûúÊú™ÊâæÂà∞ÂàôËøîÂõû null
         */
        function getRankFeedback(dimId, value) {
            if (!RANK_RESOURCES || !RANK_RESOURCES[dimId]) {
                console.log(`[Rank] Áª¥Â∫¶ ${dimId} ‰∏çÂ≠òÂú®‰∫é RANK_RESOURCESÔºåËøîÂõûÈªòËÆ§ÂèçÈ¶à`);
                return null;
            }

            const dim = RANK_RESOURCES[dimId];
            if (!dim.levels || !Array.isArray(dim.levels) || dim.levels.length === 0) {
                console.log(`[Rank] Áª¥Â∫¶ ${dimId} ÁöÑ levels Êï∞ÊçÆÊó†ÊïàÔºåËøîÂõûÈªòËÆ§ÂèçÈ¶à`);
                return null;
            }

            let matchedLevel = null;

            // 0 ÂÄº‰øùÊä§ÔºöÂ¶ÇÊûú value <= 0ÔºåÁõ¥Êé•Âº∫Âà∂ÂåπÈÖçÁ¨¨‰∏Ä‰∏™Á≠âÁ∫ß
            if (value <= 0) {
                matchedLevel = dim.levels[0];
                console.log(`[Rank] Áª¥Â∫¶ ${dimId} ÁöÑÂÄº ${value} <= 0ÔºåËá™Âä®ÂåπÈÖçÁ¨¨‰∏Ä‰∏™Á≠âÁ∫ß: ${matchedLevel.label}`);
            } else {
                // Êü•ÊâæÊª°Ë∂≥ value >= min && value <= max ÁöÑÁ≠âÁ∫ß
                matchedLevel = dim.levels.find(level => {
                    const min = Number(level.min) || 0;
                    const max = Number(level.max) || Infinity;
                    return value >= min && value <= max;
                });

                // Ê∫¢Âá∫‰øùÊä§ÔºöÂ¶ÇÊûúÊï∞ÂÄºË∂ÖËøá‰∫ÜÈÖçÁΩÆÁöÑÊúÄÂ§ßÂÄºÔºåËá™Âä®ÂåπÈÖçÊúÄÂêé‰∏Ä‰∏™Á≠âÁ∫ß
                if (!matchedLevel) {
                    matchedLevel = dim.levels[dim.levels.length - 1];
                    console.log(`[Rank] Áª¥Â∫¶ ${dimId} ÁöÑÂÄº ${value} Ë∂ÖÂá∫ËåÉÂõ¥ÔºåËá™Âä®ÂåπÈÖçÊúÄÂêé‰∏Ä‰∏™Á≠âÁ∫ß: ${matchedLevel.label}`);
                }
            }

            // ÈöèÊú∫ÊäΩÂèñ‰∏ÄÊù°ËØÑ‰ª∑
            const comments = matchedLevel.commentsZh || [];
            if (comments.length === 0) {
                console.log(`[Rank] Áª¥Â∫¶ ${dimId} ÁöÑÁ≠âÁ∫ß ${matchedLevel.label} Ê≤°ÊúâËØÑ‰ª∑Êï∞ÊçÆÔºåËøîÂõûÈªòËÆ§ÂÜÖÂÆπ`);
                return {
                    label: matchedLevel.label || 'Êú™Áü•Á≠âÁ∫ß',
                    title: 'ÊöÇÊó†ËØÑ‰ª∑',
                    content: 'ÊöÇÊó†ËØÑ‰ª∑ÂÜÖÂÆπ'
                };
            }

            const randomComment = comments[Math.floor(Math.random() * comments.length)];
            return {
                label: matchedLevel.label || 'Êú™Áü•Á≠âÁ∫ß',
                title: randomComment.title || 'ÊöÇÊó†Ê†áÈ¢ò',
                content: randomComment.content || 'ÊöÇÊó†ÂÜÖÂÆπ'
            };
        }

        /**
         * ‰ªé lpdef ÊèêÂèñ vibe_indexÔºà5 ‰ΩçÊï∞Â≠óÔºâÔºå‰∏é worker ÁöÑ generateLPDEF ‰∏ÄËá¥ÔºöL0P1D2E1F0 -> 01210
         * ‰∏é index.html ÁöÑ lpdefToVibeIndex ‰øùÊåÅÂêåÊ≠•ÔºåÁî®‰∫éÁ≠îÊ°à‰πã‰π¶Êåâ lpdef Êü• answerBookByVibeIndex.json
         */
        function lpdefToVibeIndex(lpdef) {
            if (!lpdef || typeof lpdef !== 'string') return null;
            const digits = String(lpdef).replace(/\D/g, '');
            return digits.length === 5 ? digits : null;
        }

        /**
         * ‰ªé personality.detailedStats Êàñ l_score/p_score/... ËÆ°ÁÆó 5 ‰Ωç vibe_index Â≠óÁ¨¶‰∏≤Ôºà‰∏é worker content.ts getVibeIndex ‰∏ÄËá¥Ôºâ
         * ÂΩìËßÜÂõæÊú™ËøîÂõû vibe_index_str/lpdef Êó∂ÔºåÁî®Ê≠§ÁªìÊûúÂä†ËΩΩ‰∫∫Ê†ºÁß∞Âè∑‰∏éÁ≠îÊ°à‰πã‰π¶
         */
        function scoresToVibeIndexStr(userData) {
            if (!userData) return null;
            let L = userData.l_score ?? userData.l ?? null;
            let P = userData.p_score ?? userData.p ?? null;
            let D = userData.d_score ?? userData.d ?? null;
            let E = userData.e_score ?? userData.e ?? null;
            let F = userData.f_score ?? userData.f ?? null;
            const stats = userData.personality?.detailedStats || userData.personality_data || userData.personalityData;
            if (Array.isArray(stats) && stats.length > 0) {
                stats.forEach(s => {
                    const dim = (s.dimension || '').toUpperCase();
                    const score = Number(s.score);
                    if (dim === 'L') L = score;
                    else if (dim === 'P') P = score;
                    else if (dim === 'D') D = score;
                    else if (dim === 'E') E = score;
                    else if (dim === 'F') F = score;
                });
            }
            if (L == null && P == null && D == null && E == null && F == null) return null;
            const indexMap = (v) => {
                if (v == null || isNaN(v)) return '1';
                if (Number(v) < 40) return '0';
                if (Number(v) < 70) return '1';
                return '2';
            };
            const eIndex = (v) => {
                if (v == null || isNaN(v)) return '1';
                const n = Number(v);
                if (n < 5) return '0';
                if (n < 10) return '1';
                return '2';
            };
            return [
                indexMap(L),
                indexMap(P),
                indexMap(D),
                eIndex(E),
                indexMap(F)
            ].join('');
        }

        /**
         * ‰ªé allData ‰∏≠Ëß£ÊûêÂá∫Âêå‰∏ÄÁî®Êà∑ÁöÑÊúÄÂÆåÊï¥ËÆ∞ÂΩïÔºåÁî®‰∫éÂ∑¶‰æßÊäΩÂ±âÁªüËÆ°Â±ïÁ§∫
         * Á°Æ‰øùÊòæÁ§∫ÁöÑÊòØ„ÄåÊèê‰∫§ËÅäÂ§©ËÆ∞ÂΩïÂØπÂ∫îÁöÑÊï∞ÊçÆÂíåÊï∞ÂÄº„ÄçÔºàÊù•Ëá™ latestRecords/Êé•Âè£ÔºâÔºåËÄåÈùû‰ªÖ upsert ËøîÂõûÁöÑÁÆÄÁï•Â≠óÊÆµ
         * @param {Object} user - ÂΩìÂâçÁî®Êà∑ÂØπË±°ÔºàÂèØËÉΩÊù•Ëá™ window.currentUser Êàñ upsert ÂìçÂ∫îÔºâ
         * @returns {Object} Âêå‰∏ÄÁî®Êà∑Âú® allData ‰∏≠ÁöÑËÆ∞ÂΩïÔºàÊõ¥ÂÆåÊï¥ÔºâÊàñÂéü user
         */
        function getBestUserRecordForStats(user) {
            if (!user) return null;
            const allData = window.allData || [];
            const normalize = (v) => (v == null ? '' : String(v).trim().toLowerCase());
            const isSameUser = (item) => {
                if (!item) return false;
                if (item.id != null && user.id != null && item.id === user.id) return true;
                const itemFp = normalize(item.fingerprint || item.user_fingerprint);
                const userFp = normalize(user.fingerprint || user.user_fingerprint);
                if (itemFp && userFp && itemFp === userFp) return true;
                const itemIdentity = normalize(item.user_identity);
                const userIdentity = normalize(user.user_identity);
                if (itemIdentity && userIdentity && itemIdentity === userIdentity) return true;
                const itemName = normalize(item.user_name || item.name || item.github_username);
                const userName = normalize(user.user_name || user.name || user.github_username);
                return itemName && userName && itemName === userName;
            };

            // ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰∏çË¶ÅÁî® allData Èáå‚ÄúÁ¨¨‰∏ÄÊù°ÂëΩ‰∏≠‚ÄùË¶ÜÁõñÊõ¥ÂÆåÊï¥ÁöÑËÆ∞ÂΩïÔºà‰æãÂ¶Ç Supabase ÂàöÊãâÂà∞ÁöÑ dbUserÔºâ
            // Êîπ‰∏∫ÔºöÂú® [user + allData ÁöÑÂêå‰∫∫ËÆ∞ÂΩï] ÈáåÊåâ‚ÄúÂ≠óÊÆµÂÆåÊï¥Â∫¶‚ÄùÊâìÂàÜÊã©‰ºò
            const candidates = [user, ...allData.filter(isSameUser)];
            const score = (u) => {
                if (!u) return -1;
                let s = 0;

                // Ë∫´‰ªΩ/‰∏ªÈîÆÂ≠óÊÆµ
                if (u.id != null) s += 3;
                if (u.user_id != null) s += 2;
                if (u.github_id != null) s += 2;
                if (u.fingerprint || u.user_fingerprint) s += 2;
                if (u.user_identity) s += 1;

                // Áª¥Â∫¶/ÁªüËÆ°Â≠óÊÆµÔºàË¶ÜÁõñ renderUserStatsCards ‰∏é extractDimensionValues ÁöÑÂÆûÈôÖÁî®Ê≥ïÔºâ
                const statKeys = [
                    'dimensions',
                    'l_score','p_score','d_score','e_score','f_score',
                    'l','p','d','e','f',
                    'L','P','D','E','F',
                    'question_message_count','total_messages',
                    'total_user_chars','total_chars','totalUserChars',
                    'avg_user_message_length','avgMessageLength','avgUserMessageLength',
                    'work_days','usage_days','days',
                    'jiafang_count','ketao_count',
                    'vibe_rank','vibe_percentile','avg_rank'
                ];
                statKeys.forEach((k) => {
                    const v = u[k];
                    if (v !== undefined && v !== null && v !== '' && !(typeof v === 'number' && Number.isNaN(v))) s += 1;
                });

                // JSON/ÁªìÊûÑÂåñÂ≠óÊÆµ
                if (u.personality || u.personality_data || u.personalityData) s += 2;
                if (u.answer_book || u.answerBook) s += 1;
                if (u.personality_name || u.personalityName) s += 1;

                return s;
            };

            let best = candidates[0] || null;
            let bestScore = score(best);
            for (let i = 1; i < candidates.length; i++) {
                const c = candidates[i];
                const cs = score(c);
                if (cs > bestScore) {
                    best = c;
                    bestScore = cs;
                }
            }
            return best || user;
        }

        /**
         * Ê∏≤ÊüìÁî®Êà∑ÁªüËÆ°Âç°ÁâáÂà∞Â∑¶‰æßÊäΩÂ±âÔºà‰∏é index ÂêåÊ≠•ÔºöÊó† answer_book Êó∂Êåâ vibe_index/lpdef ‰ªé answerBookByVibeIndex.json Âèñ‰ªäÊó•ÁÆ¥Ë®ÄÔºâ
         * @param {HTMLElement} leftBody - Â∑¶‰æßÊäΩÂ±âÂÆπÂô®
         * @param {Object} userData - ÂΩìÂâçÁî®Êà∑Êï∞ÊçÆÂØπË±°
         */
        async function renderUserStatsCards(leftBody, userData) {
            console.log('[UserStats] üöÄ ÂºÄÂßãÊ∏≤ÊüìÁî®Êà∑ÁªüËÆ°Âç°ÁâáÔºåuserData:', {
                hasUserData: !!userData,
                userName: userData?.user_name || userData?.name,
                fingerprint: userData?.fingerprint ? userData.fingerprint.substring(0, 8) : null,
                hasLeftBody: !!leftBody,
                hasVibeRank: !!(userData?.vibe_rank || userData?.vibeRank),
                hasPersonalityName: !!(userData?.personality_name || userData?.personalityName),
                hasAnswerBook: !!(userData?.answer_book || userData?.answerBook),
                hasPersonality: !!userData?.personality,
                hasPersonalityData: !!userData?.personality_data
            });
            
            if (!leftBody) {
                console.error('[UserStats] ‚ùå leftBody ‰∏çÂ≠òÂú®');
                return;
            }
            
            if (!userData) {
                console.warn('[UserStats] ‚ö†Ô∏è userData ‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÊ∏≤Êüì');
                return;
            }
            
            try {
                // „ÄêTask 4„ÄëÊ£ÄÊü•ÊòØÂê¶‰∏∫Êñ∞Áî®Êà∑ÔºàÁª¥Â∫¶/ÁªüËÆ°‰∏∫Á©∫Êàñ‰∏∫ÈªòËÆ§ÂÄºÔºâ
                // ‰øÆÂ§çÔºöÁªü‰∏ÄËßÜÂõæ/ÈöêÁßÅË£ÅÂâ™ÂèØËÉΩ‰∏çËøîÂõû l_score..f_scoreÔºå‰ΩÜ‰ªçÂèØËÉΩËøîÂõûÂÖ∂ÂÆÉÁªüËÆ°Â≠óÊÆµÔºàtotal_messages Á≠âÔºâ
                const quickScoreKeys = ['l_score','p_score','d_score','e_score','f_score','l','p','d','e','f','L','P','D','E','F'];
                const hasAnyScore = quickScoreKeys.some(k => userData[k] !== null && userData[k] !== undefined);

                const extracted = extractDimensionValues(userData);
                const hasAnyMetric =
                    (extracted.ai !== undefined && extracted.ai !== null && extracted.ai > 0) ||
                    (extracted.say !== undefined && extracted.say !== null && extracted.say > 0) ||
                    (extracted.word !== undefined && extracted.word !== null && extracted.word > 0) ||
                    (extracted.no !== undefined && extracted.no !== null && extracted.no > 0) ||
                    (extracted.please !== undefined && extracted.please !== null && extracted.please > 0) ||
                    (extracted.day !== undefined && extracted.day !== null && extracted.day > 0);

                const hasDimensions = !!userData.dimensions || hasAnyScore || hasAnyMetric;

                // ÈªòËÆ§ÂàÜÂè™Âú®‚Äú‰∫îÁª¥ÂàÜÈÉΩÂ≠òÂú®‰∏îÈÉΩÁ≠â‰∫é 50‚ÄùÊó∂ÊàêÁ´ã
                const isDefaultScores =
                    userData.l_score === 50 &&
                    userData.p_score === 50 &&
                    userData.d_score === 50 &&
                    userData.e_score === 50 &&
                    userData.f_score === 50;
                
                // „Äê‰øÆÂ§ç„ÄëGitHub Áî®Êà∑ÔºöÂç≥‰Ωø latestRecords ÈáåÂ≠óÊÆµ‰∏çÂÖ®Ôºå‰πü‰∏çÂ∫î‰∏ÄÁõ¥Âç°Âú®‚ÄúÂêåÊ≠•‰∏≠‚Äù
                // ÂÖ∏ÂûãÂú∫ÊôØÔºö/api/global-average ËøîÂõûÁöÑ latestRecords ‰ºöÂÅöÈöêÁßÅË£ÅÂâ™ÔºåÂèØËÉΩÁº∫Â∞ë id/fingerprint/Áª¥Â∫¶Â≠óÊÆµ
                const candidateUserName = String(userData?.user_name || userData?.name || '').trim();
                const candidateIdentity = userData?.user_identity || null;
                const isGitHubUser = !!(candidateUserName && typeof isValidGitHubUsername === 'function' && isValidGitHubUsername(candidateUserName, candidateIdentity));
                const canQuerySupabase = (typeof supabaseClient !== 'undefined' && supabaseClient && typeof supabaseClient.from === 'function');

                // Ëã•ÊòØ GitHub Áî®Êà∑‰ΩÜÊï∞ÊçÆ‰∏çÂÖ®ÔºöËá™Âä®‰ªéÁªü‰∏ÄËßÜÂõæÊãâÂÆåÊï¥ËÆ∞ÂΩïÂêéÂÜçÊ∏≤ÊüìÔºåÈÅøÂÖçÊó†Èôê loading
                if ((!hasDimensions || isDefaultScores) && !userData.id && isGitHubUser && canQuerySupabase && !userData.__unifiedFetchAttempted) {
                    try {
                        userData.__unifiedFetchAttempted = true; // Ê†áËÆ∞ÔºöÈÅøÂÖçÈÄíÂΩíÊ≠ªÂæ™ÁéØ
                        console.log('[UserStats] üîÑ GitHub Áî®Êà∑Êï∞ÊçÆ‰∏çÂÖ®ÔºåÂ∞ùËØï‰ªé v_unified_analysis_v2 ÊãâÂèñÂÆåÊï¥ËÆ∞ÂΩï:', candidateUserName);
                        supabaseClient
                            .from('v_unified_analysis_v2')
                            .select('*')
                            // GitHub Áî®Êà∑ÂêçÂ§ßÂ∞èÂÜô‰∏çÊïèÊÑüÔºöÈÅøÂÖç user_name Â§ßÂ∞èÂÜô‰∏ç‰∏ÄËá¥ÂØºËá¥Êü•‰∏çÂà∞
                            .ilike('user_name', candidateUserName)
                            .maybeSingle()
                            .then(({ data: dbUser }) => {
                                if (!dbUser) {
                                    console.warn('[UserStats] ‚ö†Ô∏è v_unified_analysis_v2 Êú™ÊâæÂà∞Áî®Êà∑ËÆ∞ÂΩï:', candidateUserName);
                                    // ÁªßÁª≠Ëµ∞ÂêéÁª≠Ê∏≤ÊüìÔºà‰ºöÊòæÁ§∫‚ÄúÊöÇÊó†‰∫ëÁ´ØÊï∞ÊçÆ‚ÄùÂç°ÁâáÔºâ
                                    renderUserStatsCards(leftBody, { ...userData, __unifiedFetchAttempted: true });
                                    return;
                                }
                                console.log('[UserStats] ‚úÖ Â∑≤Ëé∑ÂèñÂÆåÊï¥Áî®Êà∑ËÆ∞ÂΩïÔºåÂà∑Êñ∞ÁªüËÆ°Âç°Áâá:', dbUser.user_name || dbUser.name);
                                renderUserStatsCards(leftBody, getBestUserRecordForStats(dbUser));
                            })
                            .catch((e) => {
                                console.warn('[UserStats] ‚ö†Ô∏è v_unified_analysis_v2 Êü•ËØ¢Â§±Ë¥•:', e);
                                renderUserStatsCards(leftBody, { ...userData, __unifiedFetchAttempted: true });
                            });
                        return; // ÂºÇÊ≠•ÊãâÂèñÂêé‰ºöÈáçÊ∏≤ÊüìÔºåËøôÈáåÂÖàÈÄÄÂá∫
                    } catch (e) {
                        console.warn('[UserStats] ‚ö†Ô∏è Ëß¶Âèë GitHub Áî®Êà∑Ë°•ÂÖ®ÊµÅÁ®ãÂ§±Ë¥•:', e);
                    }
                }

                // Âè™ÊúâÂú®Á°ÆÂÆöÊòØ‚ÄúÂÆåÂÖ®Ê≤°ÊúâÊï∞ÊçÆÁöÑÂåøÂêçÁî®Êà∑/Âç†‰ΩçËÆ∞ÂΩï‚ÄùÊó∂ÊâçÊòæÁ§∫ÂêåÊ≠•‰∏≠
                const isNewUser = (!hasDimensions || isDefaultScores) && !userData.id && !isGitHubUser;
                
                if (isNewUser) {
                    console.log('[UserStats] ‚è≥ Ê£ÄÊµãÂà∞Êñ∞Áî®Êà∑ÔºàÊï∞ÊçÆÂêåÊ≠•‰∏≠ÔºâÔºåÊòæÁ§∫Âä†ËΩΩÂç†‰ΩçÁ¨¶');
                    
                    // ÂàõÂª∫"Êï∞ÊçÆÂêåÊ≠•‰∏≠"Âç†‰ΩçÁ¨¶Âç°Áâá
                    const loadingCard = document.createElement('div');
                    loadingCard.className = 'drawer-item';
                    loadingCard.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">‚è≥</span>
                            <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                                SYNCING
                            </span>
                        </div>
                        <div class="drawer-item-label mb-2">Êï∞ÊçÆÂêåÊ≠•‰∏≠</div>
                        <div class="text-[10px] text-[#00ff41]/60 mb-3">
                            ÊÇ®ÁöÑÊï∞ÊçÆÊ≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂÄô...
                        </div>
                        <div class="flex items-center space-x-2 mb-2">
                            <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                        <div class="text-[8px] text-[#00ff41]/40 mt-2">
                            Áî®Êà∑: ${userData.user_name || userData.name || 'Êú™Áü•'}
                        </div>
                    `;
                    
                    // ÂÖàÁßªÈô§ÊóßÁöÑÁªüËÆ°Âç°ÁâáÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                    const existingStatsCards = leftBody.querySelectorAll('.drawer-item');
                    existingStatsCards.forEach(card => {
                        const label = card.querySelector('.drawer-item-label');
                        if (label && (label.textContent === 'ÊàëÁöÑÊï∞ÊçÆÁªüËÆ°' || label.textContent === 'Êï∞ÊçÆÂêåÊ≠•‰∏≠')) {
                            card.remove();
                        }
                    });
                    
                    // Â∞ÜÂä†ËΩΩÂç°ÁâáÊèíÂÖ•Âà∞Ë∫´‰ªΩÈÖçÁΩÆÂç°Áâá‰πãÂêé
                    const identityCard = leftBody.querySelector('.drawer-item');
                    if (identityCard && identityCard.nextSibling) {
                        leftBody.insertBefore(loadingCard, identityCard.nextSibling);
                    } else {
                        leftBody.appendChild(loadingCard);
                    }
                    
                    console.log('[UserStats] ‚úÖ Â∑≤ÊòæÁ§∫Êï∞ÊçÆÂêåÊ≠•‰∏≠Âç†‰ΩçÁ¨¶');
                    return; // ÊèêÂâçËøîÂõûÔºå‰∏çÊ∏≤ÊüìÂÆåÊï¥ÁªüËÆ°Âç°Áâá
                }

                // GitHub Áî®Êà∑‰ΩÜ Supabase ÂÆ¢Êà∑Á´ØÂ∞öÊú™Â∞±Áª™ÔºöÂÖàÊòæÁ§∫‚ÄúËøûÊé•‰∏≠‚ÄùÔºåÂπ∂Á®çÂêéËá™Âä®ÈáçËØï
                if ((!hasDimensions || isDefaultScores) && isGitHubUser && !userData.id && !canQuerySupabase && !userData.__unifiedFetchAttempted) {
                    try {
                        const attempts = Number(userData.__supabaseWaitAttempts || 0);
                        if (attempts < 6) {
                            userData.__supabaseWaitAttempts = attempts + 1;
                            const delayMs = 800 + attempts * 400;
                            setTimeout(() => {
                                const lb = document.getElementById('left-drawer-body');
                                if (lb) renderUserStatsCards(lb, userData);
                            }, delayMs);
                        }
                    } catch (e) { /* ignore */ }

                    const connectingCard = document.createElement('div');
                    connectingCard.className = 'drawer-item';
                    connectingCard.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">üîå</span>
                            <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                                CONNECT
                            </span>
                        </div>
                        <div class="drawer-item-label mb-2">ÊàëÁöÑÊï∞ÊçÆÁªüËÆ°</div>
                        <div class="text-[10px] text-[#00ff41]/60 mb-2">
                            Ê≠£Âú®ËøûÊé•‰∫ëÁ´ØÊï∞ÊçÆÊ∫êÔºåËØ∑Á®çÂÄô‚Ä¶
                        </div>
                        <div class="text-[8px] text-[#00ff41]/40">
                            GitHub Áî®Êà∑Ôºö${candidateUserName || 'Êú™Áü•'}
                        </div>
                    `;

                    const existingStatsCards = leftBody.querySelectorAll('.drawer-item');
                    existingStatsCards.forEach(card => {
                        const label = card.querySelector('.drawer-item-label');
                        if (label && (label.textContent === 'ÊàëÁöÑÊï∞ÊçÆÁªüËÆ°' || label.textContent === 'Êï∞ÊçÆÂêåÊ≠•‰∏≠')) {
                            card.remove();
                        }
                    });

                    const identityCard = leftBody.querySelector('.drawer-item');
                    if (identityCard && identityCard.nextSibling) {
                        leftBody.insertBefore(connectingCard, identityCard.nextSibling);
                    } else {
                        leftBody.appendChild(connectingCard);
                    }
                    return;
                }

                // GitHub Áî®Êà∑‰ªçÊó†Áª¥Â∫¶‰∏îÂ∑≤Â∞ùËØïË°•ÂÖ®Ôºö‰∏çË¶ÅÊòæÁ§∫‚ÄúÂêåÊ≠•‰∏≠‚ÄùÔºåÊîπ‰∏∫‚ÄúÊöÇÊó†‰∫ëÁ´ØÊ±áÊÄªÊï∞ÊçÆ‚ÄùÔºàÊèêÁ§∫Áî®Êà∑ÂÖàË∑ë‰∏ÄÊ¨°ÂàÜÊûêÔºâ
                if ((!hasDimensions || isDefaultScores) && isGitHubUser && !userData.id && userData.__unifiedFetchAttempted) {
                    console.warn('[UserStats] ‚ö†Ô∏è GitHub Áî®Êà∑ÊöÇÊó†‰∫ëÁ´ØÊ±áÊÄªÊï∞ÊçÆÔºàÂèØËÉΩÂ∞öÊú™Ë∑ëËøáÂàÜÊûêÊàñÊï∞ÊçÆ‰ªçÊú™ÂÖ•Â∫ìÔºâ:', candidateUserName);

                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'drawer-item';
                    emptyCard.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">üßæ</span>
                            <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                                NO DATA
                            </span>
                        </div>
                        <div class="drawer-item-label mb-2">ÊàëÁöÑÊï∞ÊçÆÁªüËÆ°</div>
                        <div class="text-[10px] text-[#00ff41]/60 mb-2">
                            ÊöÇÊú™Ëé∑ÂèñÂà∞‰∫ëÁ´ØÊ±áÊÄªÊï∞ÊçÆÔºàGitHub Áî®Êà∑Ôºö${candidateUserName || 'Êú™Áü•'}Ôºâ„ÄÇ
                        </div>
                        <div class="text-[8px] text-[#00ff41]/40">
                            Âª∫ËÆÆÔºöÂÖàÂú®‰∏ªÈ°µÈù¢ÂÆåÊàê‰∏ÄÊ¨°ÂàÜÊûê/‰∏äÊä•ÔºåÁÑ∂ÂêéÂà∑Êñ∞Ê≠§È°µÈù¢„ÄÇ
                        </div>
                    `;

                    // Ê∏ÖÁêÜÊóßÂç°ÁâáÂπ∂ÊèíÂÖ•
                    const existingStatsCards = leftBody.querySelectorAll('.drawer-item');
                    existingStatsCards.forEach(card => {
                        const label = card.querySelector('.drawer-item-label');
                        if (label && (label.textContent === 'ÊàëÁöÑÊï∞ÊçÆÁªüËÆ°' || label.textContent === 'Êï∞ÊçÆÂêåÊ≠•‰∏≠')) {
                            card.remove();
                        }
                    });

                    const identityCard = leftBody.querySelector('.drawer-item');
                    if (identityCard && identityCard.nextSibling) {
                        leftBody.insertBefore(emptyCard, identityCard.nextSibling);
                    } else {
                        leftBody.appendChild(emptyCard);
                    }
                    return;
                }
                
                // ÊèêÂèñÁª¥Â∫¶ÂÄº
                const dimensionValues = extractDimensionValues(userData);
                console.log('[UserStats] üìä ÊèêÂèñÁöÑÁª¥Â∫¶ÂÄº:', dimensionValues);
                
                // 1. ÊäÄÊúØÊéíÂêçÔºà‰ΩøÁî®Âπ≥ÂùáÊéíÂêçÊàñÁªºÂêàÊéíÂêçÔºâ
                // „ÄêTask 2„Äë‰ºòÂÖà‰ΩøÁî®ËßÜÂõæËøîÂõûÁöÑ vibe_rank Âíå vibe_percentile
                const vibeRank = userData.vibe_rank || userData.vibeRank || null;
                const vibePercentile = userData.vibe_percentile || userData.vibePercentile || null;
                // Â∞ùËØï‰ªéÂ§ö‰∏™Êù•Ê∫êËé∑ÂèñÊéíÂêçÔºöranks ÂØπË±°„ÄÅavg_rank„ÄÅÊàñ‰ªé personality_data ‰∏≠ËÆ°ÁÆó
                let avgRank = userData.avg_rank || userData.avgRank || userData.ranks?.avgRank || vibePercentile || null;
                
                // Â¶ÇÊûúËøòÊ≤°ÊúâÊéíÂêçÔºåÂ∞ùËØï‰ªé personality_data Êàñ personality JSONB Â≠óÊÆµ‰∏≠Ëé∑Âèñ
                if (avgRank === null || avgRank === undefined) {
                    try {
                        const personalityData = userData.personality_data || userData.personalityData;
                        const personality = userData.personality;
                        if (personalityData && Array.isArray(personalityData)) {
                            // ËÆ°ÁÆóÂπ≥ÂùáÊéíÂêçÔºö‰ªé‰∫î‰∏™Áª¥Â∫¶ÁöÑÊéíÂêç‰∏≠ÂèñÂπ≥ÂùáÂÄº
                            const ranks = personalityData.map(d => d.rank || d.rankPercent || 50).filter(r => r !== null && r !== undefined);
                            if (ranks.length > 0) {
                                avgRank = ranks.reduce((sum, r) => sum + r, 0) / ranks.length;
                            }
                        } else if (personality && typeof personality === 'object') {
                            // Â∞ùËØï‰ªé personality.detailedStats ‰∏≠Ëé∑Âèñ
                            const detailedStats = personality.detailedStats || personality.detailed_stats;
                            if (detailedStats && Array.isArray(detailedStats)) {
                                const ranks = detailedStats.map(d => d.rank || d.rankPercent || 50).filter(r => r !== null && r !== undefined);
                                if (ranks.length > 0) {
                                    avgRank = ranks.reduce((sum, r) => sum + r, 0) / ranks.length;
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('[UserStats] ‚ö†Ô∏è ‰ªé personality Êï∞ÊçÆÊèêÂèñÊéíÂêçÂ§±Ë¥•:', e);
                    }
                }
                
                const totalUsers = window.lastData?.totalUsers || 1;
                let techRankText = 'N/A';
                
                // ‰ºòÂÖà‰ΩøÁî® vibe_rankÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                if (vibeRank !== null && vibeRank !== undefined && totalUsers > 0) {
                    techRankText = `Á¨¨ ${vibeRank} Âêç / ${totalUsers} ‰∫∫`;
                } else if (avgRank !== null && avgRank !== undefined && totalUsers > 0) {
                    // avgRank ÊòØÁôæÂàÜÊØîÔºà0-100ÔºâÔºåÈúÄË¶ÅËΩ¨Êç¢‰∏∫ÊéíÂêç
                    const rankPercent = Math.round((1 - avgRank / 100) * totalUsers);
                    techRankText = `Á¨¨ ${rankPercent} Âêç / ${totalUsers} ‰∫∫`;
                }
                console.log('[UserStats] üèÜ ÊäÄÊúØÊéíÂêç:', { vibeRank, vibePercentile, avgRank, totalUsers, techRankText });
                
                // 2. Ë∞ÉÊàèAIÊ¨°Êï∞ÔºàaiÁª¥Â∫¶Ôºâ
                const aiCount = dimensionValues.ai !== undefined && dimensionValues.ai !== null 
                    ? new Intl.NumberFormat('zh-CN').format(dimensionValues.ai) 
                    : 'N/A';
                
                // 3. Áî≤ÊñπÁà∏Áà∏‰∏äË∫´Ê¨°Êï∞ÔºànoÁª¥Â∫¶Ôºâ
                const noCount = dimensionValues.no !== undefined && dimensionValues.no !== null 
                    ? new Intl.NumberFormat('zh-CN').format(dimensionValues.no) 
                    : 'N/A';
                
                // 4. ËµõÂçöÁ£ïÂ§¥Ê¨°Êï∞ÔºàpleaseÁª¥Â∫¶Ôºâ
                const pleaseCount = dimensionValues.please !== undefined && dimensionValues.please !== null 
                    ? new Intl.NumberFormat('zh-CN').format(dimensionValues.please) 
                    : 'N/A';
                
                // 5. Â∫üËØùËæìÂá∫ÊÄªÊï∞ÔºàsayÁª¥Â∫¶Ôºâ
                const sayTotal = dimensionValues.say !== undefined && dimensionValues.say !== null 
                    ? new Intl.NumberFormat('zh-CN').format(dimensionValues.say) 
                    : 'N/A';
                
                // 6. Âπ≥ÂùáÂêπÊ∞¥ÈïøÂ∫¶ÔºàwordÁª¥Â∫¶Ôºâ
                const avgLength = dimensionValues.word !== undefined && dimensionValues.word !== null 
                    ? new Intl.NumberFormat('zh-CN').format(Math.round(dimensionValues.word)) 
                    : 'N/A';
                
                // 7. ‰∫∫Ê†ºÁß∞Âè∑ÔºàÂèÇËÄÉ index.html ÁöÑËé∑ÂèñÊñπÂºèÔºöÊ†πÊçÆ 5 ‰Ωç vibe_index ‰ªé personalityNames.json Ëé∑ÂèñÔºâ
                const personalityType = userData.personality_type || userData.personalityType || userData.type || 'UNKNOWN';
                let personalityName = userData.personality_name || userData.personalityName || null;
                // ËßÜÂõæËøîÂõûÁöÑ vibe_index ‰∏∫Êï∞ÂÄºÔºàÁªºÂêàÂàÜÔºâÔºå‰∫∫Ê†º/Á≠îÊ°à‰πã‰π¶ÈúÄ 5 ‰ΩçÂ≠óÁ¨¶‰∏≤Ôºö‰ºòÂÖà vibe_index_str / vibeIndex / lpdefÔºåÂê¶Âàô‰ªé detailedStats Êàñ l_score Á≠âËÆ°ÁÆó
                const vibeIndexStr = (typeof userData.vibe_index_str === 'string' && userData.vibe_index_str.length === 5)
                    ? userData.vibe_index_str
                    : (typeof userData.vibe_index === 'string' && userData.vibe_index.length === 5 ? userData.vibe_index : null)
                    || (typeof userData.vibeIndex === 'string' && userData.vibeIndex.length === 5 ? userData.vibeIndex : null)
                    || lpdefToVibeIndex(userData.lpdef)
                    || scoresToVibeIndexStr(userData);
                
                // Â¶ÇÊûúËøòÊ≤°Êúâ‰∫∫Ê†ºÁß∞Âè∑ÔºåÂ∞ùËØïÊ†πÊçÆ 5 ‰Ωç vibe_index ‰ªé personalityNames.json Ëé∑ÂèñÔºàÂèÇËÄÉ index.htmlÔºâ
                const loadPersonalityName = (vibeIndex) => {
                    return new Promise((resolve) => {
                        const idx = (vibeIndex != null && typeof vibeIndex === 'string') ? vibeIndex : String(vibeIndex || '');
                        if (!idx || idx.length !== 5) {
                            resolve(null);
                            return;
                        }
                        fetch('src/personalityNames.json')
                            .then(response => {
                                if (response.ok) {
                                    return response.json();
                                }
                                throw new Error('Failed to load personalityNames.json');
                            })
                            .then(namesData => {
                                if (namesData && namesData[idx]) {
                                    console.log('[UserStats] ‚úÖ ‰ªé personalityNames.json Ëé∑Âèñ‰∫∫Ê†ºÁß∞Âè∑:', namesData[idx]);
                                    resolve(namesData[idx]);
                                } else {
                                    resolve(null);
                                }
                            })
                            .catch(error => {
                                console.warn('[UserStats] ‚ö†Ô∏è Âä†ËΩΩ personalityNames.json Â§±Ë¥•:', error);
                                resolve(null);
                            });
                    });
                };
                
                // Â¶ÇÊûúËøòÊ≤°Êúâ‰∫∫Ê†ºÁß∞Âè∑ÔºåÂ∞ùËØï‰ªéÂ§ö‰∏™Êù•Ê∫êËé∑Âèñ
                if (!personalityName || personalityName === 'Êú™Áü•‰∫∫Ê†º' || personalityName === 'Êú™Áü•') {
                    try {
                        // ÊñπÊ≥ï1: ‰ªé personality JSONB Â≠óÊÆµ‰∏≠Ëé∑ÂèñÔºàÂêåÊ≠•ÊñπÂºèÔºåÁ´ãÂç≥ÊòæÁ§∫Ôºâ
                        const personality = userData.personality;
                        if (personality && typeof personality === 'object') {
                            personalityName = personality.name || personality.personalityName || personality.personality_name || null;
                            
                            // Â¶ÇÊûúËøòÊ≤°ÊúâÔºåÂ∞ùËØï‰ªé personality_data Êàñ detailedStats ‰∏≠Ëé∑Âèñ
                            if (!personalityName) {
                                const personalityData = userData.personality_data || userData.personalityData || personality.detailedStats || personality.detailed_stats;
                                if (personalityData && Array.isArray(personalityData) && personalityData.length > 0) {
                                    const firstDim = personalityData[0];
                                    personalityName = firstDim.personalityName || firstDim.personality_name || null;
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('[UserStats] ‚ö†Ô∏è Ëé∑Âèñ‰∫∫Ê†ºÁß∞Âè∑Â§±Ë¥•:', e);
                    }
                }
                
                // Ë∞ÉËØïÊó•ÂøóÔºöËæìÂá∫ÊâÄÊúâÂèØËÉΩÂåÖÂê´‰∫∫Ê†ºÁß∞Âè∑ÁöÑÂ≠óÊÆµ
                console.log('[UserStats] üé≠ ‰∫∫Ê†ºÁß∞Âè∑Ëé∑ÂèñË∞ÉËØï:', {
                    personality_name: userData.personality_name,
                    personalityName: userData.personalityName,
                    personality: userData.personality,
                    personality_data: userData.personality_data,
                    personalityType: personalityType,
                    vibe_index_str: userData.vibe_index_str,
                    vibe_index: userData.vibe_index,
                    vibeIndex: userData.vibeIndex,
                    lpdef: userData.lpdef,
                    vibeIndexStr: vibeIndexStr,
                    finalPersonalityName: personalityName
                });
                
                // ÊúÄÁªàÂõûÈÄÄÔºöËã•‰ªçÊó†‰∫∫Ê†ºÁß∞Âè∑Ôºå‰ªÖÂΩì personalityType ‰∏∫ÊúâÊÑè‰πâÁ±ªÂûãÊó∂ÊòæÁ§∫„Äå‰∫∫Ê†º xxx„ÄçÔºõAUTO_REPORT ‰∏∫Âç†‰ΩçÁ±ªÂûãÔºå‰∏çÂ±ïÁ§∫
                if (!personalityName || personalityName === 'Êú™Áü•‰∫∫Ê†º' || personalityName === 'Êú™Áü•') {
                    const typeUpper = (personalityType && String(personalityType).toUpperCase()) || '';
                    if (personalityType && personalityType !== 'UNKNOWN' && typeUpper !== 'AUTO_REPORT') {
                        personalityName = `‰∫∫Ê†º ${personalityType}`;
                    } else {
                        personalityName = 'Êú™Áü•‰∫∫Ê†º';
                    }
                }
                
                // 8. Á≠îÊ°à‰πã‰π¶ËØ¥ÊòéÔºàanswer_book ÂØπË±°Ôºâ
                let answerBookTitle = 'ÊöÇÊó†';
                let answerBookContent = 'ÊöÇÊó†ËØ¥Êòé';
                let answerBookVibeLevel = '';
                
                try {
                    // Â∞ùËØïËß£Êûê answer_book Â≠óÊÆµÔºàÂèØËÉΩÊòØ JSON Â≠óÁ¨¶‰∏≤ÊàñÂØπË±°Ôºâ
                    let answerBook = userData.answer_book || userData.answerBook;
                    
                    // Â¶ÇÊûú answer_book ‰∏çÂ≠òÂú®ÔºåÂ∞ùËØï‰ªé personality JSONB Â≠óÊÆµ‰∏≠Ëé∑Âèñ
                    if (!answerBook) {
                        try {
                            const personality = userData.personality;
                            if (personality && typeof personality === 'object') {
                                answerBook = personality.answer_book || personality.answerBook;
                            }
                        } catch (e) {
                            console.warn('[UserStats] ‚ö†Ô∏è ‰ªé personality ÊèêÂèñ answer_book Â§±Ë¥•:', e);
                        }
                    }
                    
                    // Â¶ÇÊûú answer_book ÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂ∞ùËØïËß£Êûê‰∏∫ JSON
                    if (typeof answerBook === 'string') {
                        try {
                            answerBook = JSON.parse(answerBook);
                        } catch (e) {
                            console.warn('[UserStats] ‚ö†Ô∏è Ëß£Êûê answer_book JSON Â§±Ë¥•:', e);
                        }
                    }
                    
                    // Â§ÑÁêÜ answer_book ÂØπË±°Ôºö‰ªäÊó•ÁÆ¥Ë®Ä‰ªÖ‰ΩøÁî®Á≠îÊ°à‰πã‰π¶ÁöÑ title ‰∏é contentÔºå‰∏é index ‰∏≠Á≠îÊ°à‰πã‰π¶‰∏ÄËá¥
                    if (answerBook && typeof answerBook === 'object') {
                        answerBookTitle = answerBook.title || answerBookTitle;
                        answerBookContent = answerBook.content || answerBookContent || answerBook.desc || answerBook.description || answerBookContent;
                        answerBookVibeLevel = answerBook.vibe_level || answerBook.vibeLevel || answerBook.level || '';
                    }
                    
                    // ‰∏é index ÂêåÊ≠•ÔºöËã•Êó† answer_bookÔºå‰ºòÂÖà‰ΩøÁî® index ÂàÜÊûêÂÆåÊàêÂêéÂÜôÂÖ•ÁöÑ„ÄåÁ≠îÊ°à‰πã‰π¶„ÄçÔºà‰æõÂ∑¶‰æßÊäΩÂ±âÁî®Êà∑Ôºâ
                    if ((!answerBookTitle || answerBookTitle === 'ÊöÇÊó†') && (!answerBookContent || answerBookContent === 'ÊöÇÊó†ËØ¥Êòé')) {
                        try {
                            const saved = localStorage.getItem('user_answer_book');
                            if (saved) {
                                const ab = JSON.parse(saved);
                                if (ab && typeof ab === 'object' && (ab.title || ab.content)) {
                                    answerBookTitle = ab.title || answerBookTitle;
                                    answerBookContent = ab.content || answerBookContent || ab.desc || ab.description || answerBookContent;
                                    answerBookVibeLevel = ab.vibe_level || ab.vibeLevel || ab.level || '';
                                    console.log('[UserStats] ‚úÖ Â∑≤‰ªé index ‰º†ÂÖ•ÁöÑÁ≠îÊ°à‰πã‰π¶ÔºàlocalStorageÔºâÂä†ËΩΩ‰ªäÊó•ÁÆ¥Ë®Ä:', answerBookTitle);
                                }
                            }
                        } catch (e) {
                            console.warn('[UserStats] ËØªÂèñ user_answer_book Â§±Ë¥•:', e);
                        }
                    }
                    
                    // ‰∏é index ÂêåÊ≠•ÔºöËã•Êó† answer_book ‰∏îÊó† localStorageÔºåÁî® 5 ‰Ωç vibe_indexÔºàvibe_index_str/lpdefÔºâÊü• JSON
                    if ((!answerBookTitle || answerBookTitle === 'ÊöÇÊó†') && (!answerBookContent || answerBookContent === 'ÊöÇÊó†ËØ¥Êòé')) {
                        const vibeIndexForBook = vibeIndexStr;
                        if (vibeIndexForBook && typeof vibeIndexForBook === 'string' && vibeIndexForBook.length === 5) {
                            try {
                                const resp = await fetch('src/answerBookByVibeIndex.json');
                                if (resp.ok) {
                                    const data = await resp.json();
                                    const entry = data[vibeIndexForBook]; // ‰ªÖÁî®ËØ•Áî®Êà∑ 5 ‰Ωç vibe_index ÁöÑÊù°ÁõÆÔºå‰∏çÁî® data['default']
                                    if (entry) {
                                        answerBookTitle = (currentLang === 'zh' || currentLang === 'zh-CN') ? entry.title_zh : entry.title_en;
                                        answerBookContent = (currentLang === 'zh' || currentLang === 'zh-CN') ? entry.content_zh : entry.content_en;
                                        console.log('[UserStats] ‚úÖ Â∑≤Êåâ vibe_index ‰ªé answerBookByVibeIndex.json Âä†ËΩΩ‰ªäÊó•ÁÆ¥Ë®Ä:', answerBookTitle);
                                    }
                                    // Êó†ÂØπÂ∫îÊù°ÁõÆÊó∂‰øùÊåÅ„ÄåÊöÇÊó†„Äç/„ÄåÊöÇÊó†ËØ¥Êòé„ÄçÔºå‰∏çÊòæÁ§∫Á°¨ÁºñÁ†Å default
                                }
                            } catch (e) {
                                console.warn('[UserStats] ‚ö†Ô∏è Âä†ËΩΩ answerBookByVibeIndex.json Â§±Ë¥•:', e);
                            }
                        }
                    }
                    
                    // ‰∏çÂÜçÁî® roast_text ‰Ωú‰∏∫‰ªäÊó•ÁÆ¥Ë®ÄÔºöroast_text ÊòØÂêÑÁª¥Â∫¶ÂêêÊßΩÊãºÊé•ÔºàÂ¶Ç„Äå„ÄêLÁª¥Â∫¶„Äë‚Ä¶„ÄêPÁª¥Â∫¶„Äë‚Ä¶„ÄçÔºâÔºåÂπ∂ÈùûÁ≠îÊ°à‰πã‰π¶ÂØπÂ∫îÊñáÊú¨
                } catch (e) {
                    console.warn('[UserStats] ‚ö†Ô∏è Â§ÑÁêÜ answer_book Â§±Ë¥•:', e);
                }
                
                // ÂàõÂª∫Áî®Êà∑ÁªüËÆ°Âç°ÁâáÂÆπÂô®
                const statsCard = document.createElement('div');
                statsCard.className = 'drawer-item';
                statsCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">üìä</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                            STATS
                        </span>
                    </div>
                    
                    <div class="drawer-item-label mb-3">ÊàëÁöÑÊï∞ÊçÆÁªüËÆ°</div>
                    
                    <!-- ÊäÄÊúØÊéíÂêç -->
                    <div class="mb-3 pb-3 border-b border-[#00ff41]/10">
                        <div class="drawer-item-label mb-1">ÊäÄÊúØÊéíÂêç</div>
                        <div class="drawer-item-value text-lg">${techRankText}</div>
                        <div class="drawer-item-desc text-[8px]">TECH_RANK</div>
                    </div>
                    
                    <!-- Áª¥Â∫¶ÁªüËÆ° -->
                    <div class="space-y-2 mb-3">
                        <div class="flex items-center justify-between">
                            <span class="text-[12px] text-[#00ff41]/70">üí¨ Ë∞ÉÊàèAIÊ¨°Êï∞</span>
                            <span class="text-[12px] text-white font-bold">${aiCount}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[12px] text-[#00ff41]/70">üö´ Áî≤Êñπ‰∏äË∫´Ê¨°Êï∞</span>
                            <span class="text-[12px] text-white font-bold">${noCount}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[12px] text-[#00ff41]/70">üôè ËµõÂçöÁ£ïÂ§¥Ê¨°Êï∞</span>
                            <span class="text-[12px] text-white font-bold">${pleaseCount}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[12px] text-[#00ff41]/70">üí≠ Â∫üËØùËæìÂá∫ÊÄªÊï∞</span>
                            <span class="text-[12px] text-white font-bold">${sayTotal}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[12px] text-[#00ff41]/70">üìè Âπ≥ÂùáÂêπÊ∞¥ÈïøÂ∫¶</span>
                            <span class="text-[12px] text-white font-bold">${avgLength} Â≠ó/Êù°</span>
                        </div>
                    </div>
                    
                    <!-- ‰∫∫Ê†ºÁß∞Âè∑Ôºà‰∏é index ‰∏ÄËá¥Ôºö‰ºòÂÖàÁî± vibe_index ‰ªé personalityNames.json Ëß£ÊûêÔºâ -->
                    <div class="mb-3 pb-3 border-b border-[#00ff41]/10">
                        <div class="drawer-item-label mb-1">‰∫∫Ê†ºÁß∞Âè∑</div>
                        <div class="drawer-item-value text-sm" data-stat="personality-name">${personalityName}</div>
                        <div class="drawer-item-desc text-[8px]">${personalityType === 'AUTO_REPORT' ? '' : (personalityType || '')}</div>
                    </div>
                    
                    <!-- Á≠îÊ°à‰πã‰π¶ÔºàÂèÇËÄÉ index.htmlÔºöÂéªÊéâ"Á≠îÊ°à‰πã‰π¶"Ê†áÈ¢òÔºåÂè™ÊòæÁ§∫ title Âíå contentÔºåÂ¢ûÂ§ßÊ≠£ÊñáÂ≠ó‰ΩìÔºâ -->
                    ${(answerBookTitle && answerBookTitle !== 'ÊöÇÊó†') || (answerBookContent && answerBookContent !== 'ÊöÇÊó†ËØ¥Êòé') ? `
                    <div class="mb-2">
                        ${answerBookTitle && answerBookTitle !== 'ÊöÇÊó†' ? `<div class="text-[13px] text-white font-bold mb-2">${answerBookTitle}</div>` : ''}
                        <div class="text-[13px] text-[#00ff41]/80 leading-relaxed">${answerBookContent && answerBookContent !== 'ÊöÇÊó†ËØ¥Êòé' ? answerBookContent : ''}</div>
                    </div>
                    ` : ''}
                `;
                
                // ÂÖàÁßªÈô§ÊóßÁöÑÁªüËÆ°Âç°ÁâáÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                const existingStatsCards = leftBody.querySelectorAll('.drawer-item');
                existingStatsCards.forEach(card => {
                    const label = card.querySelector('.drawer-item-label');
                    if (label && label.textContent === 'ÊàëÁöÑÊï∞ÊçÆÁªüËÆ°') {
                        card.remove();
                    }
                });
                
                // Â∞ÜÁªüËÆ°Âç°ÁâáÊèíÂÖ•Âà∞Ë∫´‰ªΩÈÖçÁΩÆÂç°Áâá‰πãÂêé
                const identityCard = leftBody.querySelector('.drawer-item');
                if (identityCard && identityCard.nextSibling) {
                    leftBody.insertBefore(statsCard, identityCard.nextSibling);
                } else {
                    leftBody.appendChild(statsCard);
                }
                
                // ‰∫∫Ê†ºÁß∞Âè∑‰∏é index ‰∏ÄËá¥ÔºöÊúâ 5 ‰Ωç vibe_indexÔºàvibe_index_str/lpdefÔºâÊó∂‰ªé personalityNames.json Ëß£ÊûêÂπ∂Êõ¥Êñ∞
                if (vibeIndexStr && typeof vibeIndexStr === 'string' && vibeIndexStr.length === 5) {
                    loadPersonalityName(vibeIndexStr).then(name => {
                        if (name) {
                            const personalityNameElement = statsCard.querySelector('[data-stat="personality-name"]');
                            if (personalityNameElement) {
                                personalityNameElement.textContent = name;
                                console.log('[UserStats] ‚úÖ Â∑≤‰ªé personalityNames.json Êõ¥Êñ∞‰∫∫Ê†ºÁß∞Âè∑:', name);
                            }
                        }
                    });
                }
                
                console.log('[UserStats] ‚úÖ Áî®Êà∑ÁªüËÆ°Âç°ÁâáÂ∑≤Ê∏≤Êüì');
            } catch (error) {
                console.error('[UserStats] ‚ùå Ê∏≤ÊüìÁî®Êà∑ÁªüËÆ°Âç°ÁâáÂ§±Ë¥•:', error);
            }
        }

        /**
         * ‰ªéÁî®Êà∑Êï∞ÊçÆ‰∏≠ÊèêÂèñÁª¥Â∫¶ÂÄº
         * @param {Object} userData - Áî®Êà∑Êï∞ÊçÆÂØπË±°
         * @returns {Object} ÂåÖÂê´ 6 ‰∏™Áª¥Â∫¶ÂÄºÁöÑÂØπË±°
         */
        function extractDimensionValues(userData) {
            if (!userData) {
                return {
                    ai: undefined,
                    word: undefined,
                    day: undefined,
                    no: undefined,
                    say: undefined,
                    please: undefined
                };
            }

            // ai (ÂØπËØùÊ¨°Êï∞/ËµõÂçöÈú∏ÊÄª)Ôºö‰ºòÂÖàÂèñ question_message_countÔºàv_top_records ËßÜÂõæ‰ΩøÁî®ÔºâÔºåÂÖ∂Ê¨° total_messages
            // Â≠óÊÆµÂõûÈÄÄÔºöquestion_message_count -> total_messages -> l_score -> l -> L
            let messages = undefined;
            if (userData.question_message_count !== undefined && userData.question_message_count !== null) {
                messages = Number(userData.question_message_count);
            } else if (userData.total_messages !== undefined && userData.total_messages !== null) {
                messages = Number(userData.total_messages);
            } else if (userData.l_score !== undefined && userData.l_score !== null) {
                messages = Number(userData.l_score);
            } else if (userData.l !== undefined && userData.l !== null) {
                messages = Number(userData.l);
            } else if (userData.L !== undefined && userData.L !== null) {
                messages = Number(userData.L);
            }
            
            // say (ÊÄªÂ≠óÊï∞/Á¥ØËÆ°Â≠óÊï∞)Ôºö‰ºòÂÖàÂèñ total_user_charsÔºàv_top_records ËßÜÂõæ‰ΩøÁî®ÔºâÔºåÂÖ∂Ê¨° total_chars
            // Â≠óÊÆµÂõûÈÄÄÔºötotal_user_chars -> total_chars -> totalUserChars -> p_score -> p -> P
            // ÂÖ≥ÈîÆÔºöv_top_records ËßÜÂõæ‰ΩøÁî® total_user_chars Â≠óÊÆµ
            let chars = undefined;
            if (userData.total_user_chars !== undefined && userData.total_user_chars !== null && Number(userData.total_user_chars) > 0) {
                chars = Number(userData.total_user_chars);
            } else if (userData.total_chars !== undefined && userData.total_chars !== null && Number(userData.total_chars) > 0) {
                chars = Number(userData.total_chars);
            } else if (userData.totalUserChars !== undefined && userData.totalUserChars !== null && Number(userData.totalUserChars) > 0) {
                chars = Number(userData.totalUserChars);
            } else if (userData.p_score !== undefined && userData.p_score !== null && Number(userData.p_score) > 0) {
                chars = Number(userData.p_score);
            } else if (userData.p !== undefined && userData.p !== null && Number(userData.p) > 0) {
                chars = Number(userData.p);
            } else if (userData.P !== undefined && userData.P !== null && Number(userData.P) > 0) {
                chars = Number(userData.P);
            }
            
            // word (Âπ≥ÂùáÈïøÂ∫¶)ÔºöËã• avg_user_message_length ‰∏∫ 0 ÊàñÊó†ÊïàÔºåÂøÖÈ°ªÊâßË°å Math.round(total_chars / total_messages)
            // Â≠óÊÆµÂõûÈÄÄÔºöavg_user_message_length -> avgMessageLength -> avgUserMessageLength -> ÂÖ¨ÂºèËÆ°ÁÆó
            let word = undefined;
            if (userData.avg_user_message_length !== undefined && userData.avg_user_message_length !== null && Number(userData.avg_user_message_length) > 0) {
                word = Number(userData.avg_user_message_length);
            } else if (userData.avgMessageLength !== undefined && userData.avgMessageLength !== null && Number(userData.avgMessageLength) > 0) {
                word = Number(userData.avgMessageLength);
            } else if (userData.avgUserMessageLength !== undefined && userData.avgUserMessageLength !== null && Number(userData.avgUserMessageLength) > 0) {
                word = Number(userData.avgUserMessageLength);
            }
            // Â¶ÇÊûú word Êú™ÂÆö‰πâÊàñ‰∏∫ 0Ôºå‰∏î messages > 0 ‰∏î chars > 0ÔºåÂøÖÈ°ªÈÄöËøáÂÖ¨ÂºèÂÆûÊó∂ËÆ°ÁÆó
            if ((word === undefined || word === 0) && messages !== undefined && messages > 0 && chars !== undefined && chars > 0) {
                word = Math.round(chars / messages);
            }
            
            // day (‰∏äÂ≤óÂ§©Êï∞)ÔºöÂè™Êò†Â∞Ñ work_daysÔºå‰∏ç‰ΩøÁî®Áª¥Â∫¶ÂæóÂàÜÔºàd_score ÊòØ 0-100 ÁöÑÂæóÂàÜÔºå‰∏çÊòØÂ§©Êï∞Ôºâ
            // Â≠óÊÆµÂõûÈÄÄÔºöwork_days -> usage_days -> days
            let day = undefined;
            if (userData.work_days !== undefined && userData.work_days !== null && Number(userData.work_days) > 0) {
                day = Number(userData.work_days);
            } else if (userData.usage_days !== undefined && userData.usage_days !== null && Number(userData.usage_days) > 0) {
                day = Number(userData.usage_days);
            } else if (userData.days !== undefined && userData.days !== null && Number(userData.days) > 0) {
                day = Number(userData.days);
            }
            
            // no (Áî≤Êñπ‰∏äË∫´)ÔºöÊò†Â∞Ñ jiafang_count
            // Â≠óÊÆµÂõûÈÄÄÔºöjiafang_count -> f_score -> f -> F
            let no = undefined;
            if (userData.jiafang_count !== undefined && userData.jiafang_count !== null) {
                no = Number(userData.jiafang_count);
            } else if (userData.f_score !== undefined && userData.f_score !== null) {
                no = Number(userData.f_score);
            } else if (userData.f !== undefined && userData.f !== null) {
                no = Number(userData.f);
            } else if (userData.F !== undefined && userData.F !== null) {
                no = Number(userData.F);
            }
            
            // please (ËµõÂçöÁ£ïÂ§¥)ÔºöÊò†Â∞Ñ ketao_count
            // Â≠óÊÆµÂõûÈÄÄÔºöketao_count -> e_score -> e -> E
            let please = undefined;
            if (userData.ketao_count !== undefined && userData.ketao_count !== null) {
                please = Number(userData.ketao_count);
            } else if (userData.e_score !== undefined && userData.e_score !== null) {
                please = Number(userData.e_score);
            } else if (userData.e !== undefined && userData.e !== null) {
                please = Number(userData.e);
            } else if (userData.E !== undefined && userData.E !== null) {
                please = Number(userData.E);
            }

            return { 
                ai: messages, 
                word, 
                day, 
                no, 
                say: chars, 
                please 
            };
        }

        /**
         * ËÆ°ÁÆóÊØè‰∏™Áª¥Â∫¶Áõ∏ÂØπ‰∫éÂÖ∂ÊúÄÂ§ßÂÄºÁöÑÊØî‰æãÔºåÊâæÂá∫ÊúÄÈ´òÈ°π
         * @param {Object} values - Áª¥Â∫¶ÂÄºÂØπË±°
         * @returns {string|null} ÊúÄÈ´òÈ°πÁöÑÁª¥Â∫¶IDÔºåÂ¶ÇÊûúÊâÄÊúâÂÄºÈÉΩ‰∏∫0ÂàôËøîÂõûnull
         */
        function findTopDimension(values) {
            // ÂÆö‰πâÊØè‰∏™Áª¥Â∫¶ÁöÑÊúÄÂ§ßÂÄºÔºàÁî®‰∫éËÆ°ÁÆóÁõ∏ÂØπÊØî‰æãÔºâ
            const maxValues = {
                ai: 10000,      // ÂØπËØùÊ¨°Êï∞ÂèØËÉΩÂæàÂ§ß
                word: 1000,     // Âπ≥ÂùáÂ≠óÊï∞
                day: 365,       // Â§©Êï∞
                no: 100,        // Âê¶ÂÆöÊ¨°Êï∞
                say: 100000,    // ÊÄªÂ≠óÊï∞
                please: 100     // Á§ºË≤åÊ¨°Êï∞
            };

            let topDim = null;
            let maxRatio = -1;

            for (const [dimId, value] of Object.entries(values)) {
                const maxValue = maxValues[dimId] || 100;
                const ratio = value / maxValue;
                if (ratio > maxRatio && value > 0) {
                    maxRatio = ratio;
                    topDim = dimId;
                }
            }

            return topDim;
        }

        /**
         * Ê∏≤Êüì 6 ‰∏™Áª¥Â∫¶ÊéíÂêçÂç°Áâá
         * @param {Object} userData - Áî®Êà∑Êï∞ÊçÆÂØπË±°Ôºà‰ªé Supabase ËøîÂõûÔºâÔºåÂ¶ÇÊûú‰∏∫ null ÂàôÊòæÁ§∫ÈªòËÆ§ÂÄº
         */
        function renderRankCards(userData) {
            const container = document.getElementById('rank-cards-container');
            if (!container) {
                console.warn('[Rank] ‚ö†Ô∏è rank-cards-container ÂÆπÂô®‰∏çÂ≠òÂú®');
                return;
            }

            if (!RANK_RESOURCES) {
                console.warn('[Rank] ‚ö†Ô∏è RANK_RESOURCES Êú™Âä†ËΩΩÔºåÊó†Ê≥ïÊ∏≤ÊüìÂç°Áâá');
                container.innerHTML = '<div class="col-span-full text-center text-zinc-500 py-4 text-sm">Áª¥Â∫¶ÊéíÂêçÊï∞ÊçÆÂä†ËΩΩ‰∏≠...</div>';
                return;
            }

            // Êï∞ÊçÆÂà§Âà´ÔºöÂÆö‰πâÂèòÈáè const isGlobalTopMode = !userData
            const isGlobalTopMode = !userData;
            
            // UI ÂèçÈ¶à‰ºòÂåñÔºöÂ¶ÇÊûúËØÜÂà´Âà∞ÊòØÊú¨Âú∞ÊåáÁ∫πÂåπÈÖçÁöÑÁî®Êà∑ÔºåÂú®ÊäΩÂ±âÊ†áÈ¢òÂ¢ûÂä†"ÔºàÂΩìÂâçËÆæÂ§áÔºâ"Ê†áËØÜ
            if (userData && window.currentUserMatchedByFingerprint) {
                try {
                    const leftTitle = document.getElementById('left-drawer-title');
                    if (leftTitle) {
                        // Ê£ÄÊü•Ê†áÈ¢òÊòØÂê¶Â∑≤ÁªèÂåÖÂê´"ÔºàÂΩìÂâçËÆæÂ§áÔºâ"ÔºåÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
                        const currentText = leftTitle.textContent || '';
                        if (!currentText.includes('ÔºàÂΩìÂâçËÆæÂ§áÔºâ') && !currentText.includes('(ÂΩìÂâçËÆæÂ§á)')) {
                            leftTitle.textContent = currentText + 'ÔºàÂΩìÂâçËÆæÂ§áÔºâ';
                            console.log('[Rank] ‚úÖ Â∑≤Êõ¥Êñ∞Â∑¶‰æßÊäΩÂ±âÊ†áÈ¢òÔºåÊ∑ªÂä†"ÔºàÂΩìÂâçËÆæÂ§áÔºâ"Ê†áËØÜ');
                        }
                    }
                } catch (e) {
                    console.warn('[Rank] ‚ö†Ô∏è Êõ¥Êñ∞ÊäΩÂ±âÊ†áÈ¢òÂ§±Ë¥•:', e);
                }
            }

            // Áª¥Â∫¶ÈÖçÁΩÆÔºàÂêçÁß∞Êò†Â∞ÑÂíåÊï∞ÂÄºÂêéÁºÄÔºâ
            const dimensionConfig = {
                ai: { name: 'ÂØπËØùAIÊ¨°Êï∞', icon: 'üí¨', suffix: 'Ê¨°' },
                word: { name: 'Âπ≥ÂùáÈïøÂ∫¶', icon: 'üìè', suffix: 'Â≠ó/Êù°' },
                day: { name: '‰∏äÂ≤óÂ§©Êï∞', icon: 'üìÖ', suffix: 'Â§©' },
                no: { name: 'Áî≤Êñπ‰∏äË∫´', icon: 'üö´', suffix: 'Ê¨°' },
                say: { name: 'Â∫üËØùËæìÂá∫', icon: 'üí≠', suffix: 'Â≠ó' },
                please: { name: 'ËµõÂçöÁ£ïÂ§¥', icon: 'üôè', suffix: 'Ê¨°' }
            };

            // Á°Æ‰øùÂåÖÂê´ÊâÄÊúâ 6 ‰∏™Áª¥Â∫¶
            const allDimensions = ['ai', 'word', 'day', 'no', 'say', 'please'];
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            container.innerHTML = '';

            // ÈÅçÂéÜ 6 ‰∏™Áª¥Â∫¶ÔºåÁîüÊàêÂç°Áâá
            allDimensions.forEach((dimId, index) => {
                const config = dimensionConfig[dimId];
                if (!config) {
                    console.warn(`[Rank] ‚ö†Ô∏è Áª¥Â∫¶ ${dimId} ÈÖçÁΩÆ‰∏çÂ≠òÂú®`);
                    return;
                }

                // Áª¥Â∫¶ÈÄâÊãîÈÄªËæë
                let targetData = null;
                let maxValue = 0;
                let targetUserName = '';
                let targetIpLocation = null; // ËÆ∞ÂΩïÂÜ†ÂÜõÁî®Êà∑ÁöÑ ip_locationÔºàÂõΩÂÆ∂‰ª£Á†ÅÔºâ

                if (isGlobalTopMode) {
                    // „ÄêÂÖ®ÁêÉÈÄâÊãîÊ®°Âºè„Äë‰ºòÂÖà‰ΩøÁî®ÂêéÁ´ØËøîÂõûÁöÑ topRecordsÔºàÂêÑÁª¥Â∫¶ÊúÄÈ´òËÆ∞ÂΩïÔºâ
                    const globalDataForTop = window.lastData || {};
                    const topRecords = globalDataForTop.topRecords || {};
                    
                    // ‰ºòÂÖà‰ΩøÁî® topRecords ‰∏≠ÁöÑÊï∞ÊçÆ
                    if (topRecords[dimId]) {
                        targetData = topRecords[dimId];
                        const targetValues = extractDimensionValues(targetData);
                        maxValue = targetValues[dimId] !== undefined && targetValues[dimId] !== null ? targetValues[dimId] : undefined;
                        targetUserName = targetData.user_name || targetData.name || targetData.github_username || 'ÂÖ®ÁêÉÊúÄÂº∫';
                        targetIpLocation = targetData.ip_location || null;
                        console.log(`[Rank] ‚úÖ ‰ΩøÁî® topRecords Êï∞ÊçÆ (${dimId}):`, maxValue, targetUserName);
                    } else {
                        // ÈôçÁ∫ßÔºö‰ΩøÁî® window.allData ÊâæÂá∫ÂêÑÁª¥Â∫¶ÁöÑÊúÄÂ§ßÂÄºÁî®Êà∑
                        const allData = window.allData || [];
                        if (allData.length > 0) {
                            targetData = allData.reduce((maxUser, currentUser) => {
                                const currentValues = extractDimensionValues(currentUser);
                                const maxValues = extractDimensionValues(maxUser);
                                const currentValue = currentValues[dimId] !== undefined && currentValues[dimId] !== null ? currentValues[dimId] : 0;
                                const maxValue = maxValues[dimId] !== undefined && maxValues[dimId] !== null ? maxValues[dimId] : 0;
                                return currentValue > maxValue ? currentUser : maxUser;
                            }, allData[0]);
                            
                            const targetValues = extractDimensionValues(targetData);
                            maxValue = targetValues[dimId] !== undefined && targetValues[dimId] !== null ? targetValues[dimId] : undefined;
                            targetUserName = targetData.user_name || targetData.name || targetData.github_username || 'Êú™Áü•Áî®Êà∑';
                            // Ë∫´‰ªΩÊ†áËÆ∞ÔºöËÆ∞ÂΩïËØ•ÂÜ†ÂÜõÁî®Êà∑ÁöÑ ip_locationÔºàÂõΩÂÆ∂‰ª£Á†ÅÔºåÂ¶Ç "US", "CN"Ôºâ
                            targetIpLocation = targetData.ip_location || null;
                        } else {
                            // „ÄêÂÖ®Â±ÄÊï∞ÊçÆÂÖúÂ∫ï„ÄëÂ¶ÇÊûúÊ≤°Êúâ allDataÔºå‰ΩøÁî®ÂÖ®Â±Ä averages Êï∞ÊçÆ
                            // ‰ªé window.lastData ÊàñÂÖ®Â±ÄÂèòÈáè‰∏≠Ëé∑Âèñ averages
                            const globalDataForAvg = window.lastData || {};
                            const averages = globalDataForAvg.averages || globalDataForAvg.globalAverage || {};
                            const totalUsers = Number(globalDataForAvg.totalUsers) || 1;
                            
                            // „Äê‰øÆÂ§çÁª¥Â∫¶Êò†Â∞Ñ„ÄëÊ†πÊçÆÊúÄÊñ∞ÁöÑ API ÁªìÊûÑÈáçÊñ∞ÁªëÂÆö
                            // ‰øÆÊ≠£Âç°Áâá ID Êò†Â∞ÑÔºöjiafang ÂØπÂ∫î jiafang_countÔºåketao ÂØπÂ∫î ketao_count
                            // ‰ΩøÁî®ÂÖ®ÁêÉÊúÄÂº∫ËÆ∞ÂΩïÔºàjiafang_count > 0ÔºâÊàñÂÖ®Â±Ä averages Êï∞ÊçÆ
                            let avgValue = undefined;
                            
                            // ‰ºòÂÖà‰ΩøÁî®ÂÖ®ÁêÉÊúÄÂº∫ËÆ∞ÂΩï
                            const championRecord = window.globalChampionRecord;
                            
                            if (dimId === 'ai') {
                                // ÂàÜÊûêÊÄªÈáèÔºöÁªëÂÆöÂà∞ json.totalAnalysis
                                if (globalDataForAvg.totalAnalysis !== undefined && globalDataForAvg.totalAnalysis !== null) {
                                    avgValue = Number(globalDataForAvg.totalAnalysis);
                                }
                            } else if (dimId === 'word') {
                                // Âπ≥ÂùáÈïøÂ∫¶ÈúÄË¶ÅËÆ°ÁÆóÔºöÂ¶ÇÊûúÊúâ totalChars Âíå totalMessagesÔºåËÆ°ÁÆóÂπ≥ÂùáÂÄº
                                const totalChars = globalDataForAvg.totalChars !== undefined && globalDataForAvg.totalChars !== null ? Number(globalDataForAvg.totalChars) : (globalDataForAvg.totalRoastWords !== undefined && globalDataForAvg.totalRoastWords !== null ? Number(globalDataForAvg.totalRoastWords) : undefined);
                                const totalMessages = globalDataForAvg.totalAnalysis !== undefined && globalDataForAvg.totalAnalysis !== null ? Number(globalDataForAvg.totalAnalysis) : undefined;
                                if (totalChars !== undefined && totalMessages !== undefined && totalMessages > 0) {
                                    avgValue = Math.round(totalChars / totalMessages);
                                } else if (averages.P !== undefined && averages.P !== null) {
                                    avgValue = Number(averages.P);
                                }
                            } else if (dimId === 'day') {
                                // ‰∏äÂ≤óÂ§©Êï∞ÔºöÁªëÂÆöÂà∞ json.systemDays
                                if (globalDataForAvg.systemDays !== undefined && globalDataForAvg.systemDays !== null) {
                                    avgValue = Number(globalDataForAvg.systemDays);
                                } else if (championRecord && championRecord.work_days !== undefined && championRecord.work_days !== null) {
                                    avgValue = Number(championRecord.work_days);
                                }
                            } else if (dimId === 'no') {
                                // Áî≤Êñπ‰∏äË∫´ÔºöÊò†Â∞Ñ jiafang_count
                                if (championRecord && championRecord.jiafang_count !== undefined && championRecord.jiafang_count !== null) {
                                    avgValue = Number(championRecord.jiafang_count);
                                } else if (averages.L !== undefined && averages.L !== null) {
                                    avgValue = Number(averages.L);
                                }
                            } else if (dimId === 'say') {
                                // ÊÄªÂ≠óÊï∞Ôºö‰ΩøÁî® totalChars Êàñ totalRoastWords
                                if (globalDataForAvg.totalChars !== undefined && globalDataForAvg.totalChars !== null) {
                                    avgValue = Number(globalDataForAvg.totalChars);
                                } else if (globalDataForAvg.totalRoastWords !== undefined && globalDataForAvg.totalRoastWords !== null) {
                                    avgValue = Number(globalDataForAvg.totalRoastWords);
                                }
                            } else if (dimId === 'please') {
                                // ËµõÂçöÁ£ïÂ§¥ÔºöÊò†Â∞Ñ ketao_count
                                if (championRecord && championRecord.ketao_count !== undefined && championRecord.ketao_count !== null) {
                                    avgValue = Number(championRecord.ketao_count);
                                } else if (averages.P !== undefined && averages.P !== null) {
                                    avgValue = Number(averages.P);
                                }
                            }
                            
                            maxValue = avgValue;
                            // ÂΩì totalUsers ‰∏∫ 1 Êó∂ÔºåÊòæÁ§∫ SYSTEM BASE
                            targetUserName = totalUsers <= 1 ? 'SYSTEM BASE' : 'GLOBAL AVG';
                            targetIpLocation = null;
                        }
                    }
                } else {
                    // Â¶ÇÊûú userData Â≠òÂú®ÔºåÂàô targetData ÂßãÁªà‰∏∫ÂΩìÂâçÁî®Êà∑
                    targetData = userData;
                    const values = extractDimensionValues(userData);
                    maxValue = values[dimId] !== undefined && values[dimId] !== null ? values[dimId] : undefined;
                    
                    // Á°ÆÂÆöÊòæÁ§∫ÁöÑÁî®Êà∑ÂêçÔºöÂ¶ÇÊûúÊòØÁ∫ØÊåáÁ∫πÁî®Êà∑ÔºàÊó† GitHub IDÔºâÔºåÊòæÁ§∫"ÂåøÂêç‰∏ìÂÆ∂ [ÊåáÁ∫πÂâç6‰Ωç]"
                    const userFingerprint = userData.fingerprint || userData.user_fingerprint || userData.user_identity;
                    const userGithubId = userData.github_username || userData.github_id;
                    const userName = userData.user_name || userData.name;
                    
                    if (!userGithubId && !userName && userFingerprint) {
                        // Á∫ØÊåáÁ∫πÁî®Êà∑ÔºöÊòæÁ§∫"ÂåøÂêç‰∏ìÂÆ∂ [ÊåáÁ∫πÂâç6‰Ωç]"
                        const fingerprintPrefix = String(userFingerprint).substring(0, 6).toUpperCase();
                        targetUserName = `ÂåøÂêç‰∏ìÂÆ∂ ${fingerprintPrefix}`;
                    } else {
                        // Êúâ GitHub ID ÊàñÁî®Êà∑ÂêçÁöÑÁî®Êà∑
                        targetUserName = userName || userGithubId || 'ÊàëÁöÑÊï∞ÊçÆ';
                    }
                    
                    targetIpLocation = userData.ip_location || null;
                }

                // Ë∞ÉÁî® getRankFeedback(dimId, maxValue) Ëé∑ÂèñÂØπÂ∫îÁöÑÁ≠âÁ∫ß label ÂíåÂêêÊßΩ content
                // Á°Æ‰øùÂç≥‰ΩøÊòØÂÖ®ÁêÉÊúÄÂº∫ÔºåÊñáÊ°à‰πüÊòØ‰ªéËØ•Áª¥Â∫¶ÁöÑÊúÄÈ´òÁ≠âÁ∫ßÂå∫Èó¥‰∏≠ÈöèÊú∫ÊäΩÂèñÁöÑ
                const feedback = getRankFeedback(dimId, maxValue);

                // „ÄêÁä∂ÊÄÅÂÖúÂ∫ï„ÄëÂΩì totalUsers ‰∏∫ 1 Êó∂ÔºåÁ°¨ÁºñÁ†ÅÊòæÁ§∫ TOP 1 Êàñ SYSTEM BASE
                const globalDataForStatus = window.lastData || {};
                const totalUsers = Number(globalDataForStatus.totalUsers) || 1;
                let statusLabel = isGlobalTopMode ? 'TOP' : 'MINE';
                let feedbackLabel = feedback ? feedback.label : 'RANKED';
                
                // Â¶ÇÊûú totalUsers ‰∏∫ 1ÔºåÊéíÂêçÁªü‰∏ÄÊòæÁ§∫‰∏∫ TOP 1
                if (totalUsers <= 1) {
                    statusLabel = 'TOP 1';
                    if (isGlobalTopMode) {
                        feedbackLabel = 'SYSTEM BASE';
                    }
                }

                // ÊâæÂá∫ÊúÄÈ´òÈ°πÔºàÁî®‰∫é‰∏™‰∫∫Ê®°Âºè‰∏ãÁöÑ TOP Ê†áËØÜÔºâ
                let isTop = false;
                if (!isGlobalTopMode && targetData) {
                    const values = extractDimensionValues(targetData);
                    const topDim = findTopDimension(values);
                    isTop = topDim === dimId;
                }

                // Êï∞ÂÄºÂ§ÑÁêÜÔºösay (ÊÄªÂ≠óÊï∞) ‰ΩøÁî® Intl.NumberFormat('zh-CN').format() ËøõË°åÂçÉÂàÜ‰ΩçÊ†ºÂºèÂåñ
                // Âçï‰ΩçË°•ÂÖ®ÔºöÊ†πÊçÆ RANK_RESOURCES Ëá™Âä®Ë°•ÂÖ®Âçï‰ΩçÔºàÊ¨°„ÄÅÂ≠ó„ÄÅÂ§©Á≠âÔºâ
                // ÂΩªÂ∫ïÂà†Èô§Á°¨ÁºñÁ†ÅÔºåÂ¶ÇÊûúÊé•Âè£ÊúâÂÄºÂàôÂøÖÈ°ªÊòæÁ§∫Êé•Âè£ÁöÑÂÄº
                let displayVal;
                let unit = config.suffix || '';
                if (maxValue !== undefined && maxValue !== null) {
                    if (dimId === 'say') {
                        displayVal = new Intl.NumberFormat('zh-CN').format(maxValue);
                    } else {
                        displayVal = new Intl.NumberFormat('zh-CN').format(maxValue);
                    }
                } else {
                    displayVal = 'N/A';
                }

                // Ëé∑ÂèñËµÑÊ∫ê‰ø°ÊÅØÔºàÁî®‰∫éÊòæÁ§∫Áª¥Â∫¶ÂêçÁß∞Ôºâ
                const resource = RANK_RESOURCES && RANK_RESOURCES[dimId] ? RANK_RESOURCES[dimId] : null;
                
                // ÂàõÂª∫Âç°ÁâáÂÖÉÁ¥†
                // ËµõÂçöÈ£éÊ†ºÔºöËÉåÊôØ bg-[#050505]/60 ÈÖçÂêà backdrop-blur-xl
                // ÊÇ¨ÊµÆÊó∂‰∏äÁßª hover:-translate-y-2ÔºåËæπÊ°ÜÁî±ÊöóÁªøÂèò‰∏∫‰∫ÆÁªøÔºåÂπ∂Âá∫Áé∞ËµõÂçöËΩ¨ËßíÊâ´ÊèèÁ∫ø
                const card = document.createElement('div');
                card.className = `cursor-pointer flex-1 min-w-0 bg-[#050505]/60 backdrop-blur-xl border border-[#00ff41]/20 p-3 rounded-sm transition-all duration-300 hover:-translate-y-2 hover:border-[#00ff41] hover:shadow-[0_0_20px_rgba(0,255,65,0.4)] relative group pointer-events-auto overflow-visible`;
                
                // Â≠òÂÇ®Áª¥Â∫¶IDÂíåÂõΩÂÆ∂‰ª£Á†ÅÔºåÁî®‰∫éÂú∞ÂõæËÅîÂä®
                card.setAttribute('data-dim-id', dimId);
                if (targetIpLocation) {
                    card.setAttribute('data-ip-location', targetIpLocation);
                }
                // Â≠òÂÇ®ÂÜ†ÂÜõ‰ø°ÊÅØÔºåÁî®‰∫éÂú∞ÂõæÂºπÁ™óÂ±ïÁ§∫
                card.setAttribute('data-champion-name', targetUserName);
                card.setAttribute('data-champion-value', maxValue);
                card.setAttribute('data-champion-feedback', feedback ? JSON.stringify(feedback) : '');
                
                // Âç°ÁâáÂÜÖÂÆπÔºöËµõÂçöÈ£éÊ†ºÊ®°Êùø
                // Êï∞Â≠óÔºöÊâÄÊúâÂç°ÁâáÊï∞ÂÄºÊñáÂ≠óÈ¢úËâ≤Áªü‰∏ÄÊîπ‰∏∫Á∫ØÁôΩËâ≤ (text-white)ÔºåÂ¢ûÂä† drop-shadow
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">${config.icon}</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5 z-10 relative">
                            ${statusLabel}
                        </span>
                    </div>

                    <div class="text-[9px] text-[#00ff41]/50 uppercase tracking-widest mb-1 truncate">
                        ${config.name}
                    </div>

                    <div class="text-2xl font-bold text-white font-mono truncate leading-none drop-shadow-[0_0_8px_rgba(255,255,255,0.3)]">
                        ${displayVal}<span class="text-[10px] ml-1 font-normal opacity-70">${unit}</span>
                    </div>

                    <div class="mt-2 pt-2 border-t border-[#00ff41]/10 flex flex-col gap-0.5">
                        <div class="text-[10px] text-white font-bold truncate">
                            ${feedbackLabel}
                        </div>
                        <div class="text-[8px] text-[#00ff41]/60 truncate italic">
                            @${targetUserName || 'ANONYMOUS'}
                        </div>
                    </div>

                    <!-- ËµõÂçöËΩ¨ËßíÊâ´ÊèèÁ∫ø -->
                    <div class="absolute -top-[1px] -left-[1px] w-2 h-2 border-t border-l border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                    <div class="absolute -bottom-[1px] -right-[1px] w-2 h-2 border-b border-r border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                    <div class="absolute -top-[1px] -right-[1px] w-2 h-2 border-t border-r border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                    <div class="absolute -bottom-[1px] -left-[1px] w-2 h-2 border-b border-l border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                `;

                // Âú∞ÂõæËÅîÂä®‰∫§‰∫íÔºö‰∏∫ÊØè‰∏™Âç°ÁâáÁªëÂÆöÁÇπÂáªÁõëÂê¨Âô®
                card.addEventListener('click', () => {
                    const ipLocation = card.getAttribute('data-ip-location');
                    if (ipLocation && mapChart && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                        // Â∞ÜÂõΩÂÆ∂‰ª£Á†ÅËΩ¨Êç¢‰∏∫Âú∞Âõæ‰∏äÁöÑÂõΩÂÆ∂ÂêçÁß∞
                        let countryName = null;
                        if (countryNameMap && countryNameMap[ipLocation]) {
                            // ‰ΩøÁî®Ëã±ÊñáÂêçÁß∞ÔºàÂú∞Âõæ‰ΩøÁî®Ëã±ÊñáÂêçÁß∞Ôºâ
                            countryName = countryNameMap[ipLocation].en;
                        } else {
                            // Â¶ÇÊûúÊ≤°ÊúâÊò†Â∞ÑÔºåÂ∞ùËØïÁõ¥Êé•‰ΩøÁî® ip_locationÔºàÂèØËÉΩÊòØÂÆåÊï¥ÁöÑÂõΩÂÆ∂ÂêçÁß∞Ôºâ
                            countryName = ipLocation;
                        }
                        
                        if (countryName) {
                            // Ëé∑ÂèñÂÜ†ÂÜõ‰ø°ÊÅØÔºåÂ≠òÂÇ®Âà∞ÂÖ®Â±ÄÂèòÈáè‰∏≠ÔºåÁî®‰∫éÂú∞ÂõæÂºπÁ™óÂ±ïÁ§∫
                            const championName = card.getAttribute('data-champion-name');
                            const championValue = card.getAttribute('data-champion-value');
                            const championFeedback = card.getAttribute('data-champion-feedback');
                            const dimId = card.getAttribute('data-dim-id');
                            
                            // Â≠òÂÇ®ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂÜ†ÂÜõ‰ø°ÊÅØ
                            currentChampionInfo = {
                                countryName: countryName,
                                championName: championName,
                                championValue: championValue,
                                feedback: championFeedback,
                                dimId: dimId
                            };
                            
                            // ‰ΩøÁî® ECharts ÂÆû‰æãÊñπÊ≥ïÈ´ò‰∫ÆÊòæÁ§∫Âú∞Âõæ‰∏äÂØπÂ∫îÁöÑÂõΩÂÆ∂
                            try {
                                // ÊñπÊ≥ï1Ôºö‰ΩøÁî® dispatchAction Ëß¶Âèë highlight Âä®‰Ωú
                                mapChart.dispatchAction({
                                    type: 'highlight',
                                    name: countryName
                                });
                                
                                // ÊñπÊ≥ï2Ôºö‰ΩøÁî® showTip ÊòæÁ§∫ tooltipÔºà‰ºöËß¶Âèë formatterÔºåÊòæÁ§∫ÂÜ†ÂÜõ‰ø°ÊÅØÔºâ
                                mapChart.dispatchAction({
                                    type: 'showTip',
                                    name: countryName
                                });
                                
                                console.log(`[Rank] ‚úÖ ÁÇπÂáªÂç°ÁâáÔºåÈ´ò‰∫ÆÂõΩÂÆ∂: ${countryName} (${ipLocation})`);
                                console.log(`[Rank] üìä ÂÜ†ÂÜõ‰ø°ÊÅØ: ${championName}, Êï∞ÂÄº: ${championValue}, Áª¥Â∫¶: ${dimId}`);
                            } catch (error) {
                                console.error('[Rank] ‚ùå È´ò‰∫ÆÂõΩÂÆ∂Â§±Ë¥•:', error);
                            }
                        } else {
                            console.warn(`[Rank] ‚ö†Ô∏è Êó†Ê≥ïÊâæÂà∞ÂõΩÂÆ∂ÂêçÁß∞Ôºåip_location: ${ipLocation}`);
                        }
                    } else if (!ipLocation) {
                        console.warn(`[Rank] ‚ö†Ô∏è ËØ•Áª¥Â∫¶ÂÜ†ÂÜõÊ≤°Êúâ ip_location ‰ø°ÊÅØ`);
                    } else {
                        console.warn(`[Rank] ‚ö†Ô∏è Âú∞ÂõæÂÆû‰æãÊú™ÂàùÂßãÂåñÊàñÂ∑≤ÈîÄÊØÅ`);
                    }
                });

                container.appendChild(card);
            });

            console.log(`[Rank] ‚úÖ Áª¥Â∫¶ÊéíÂêçÂç°ÁâáÊ∏≤ÊüìÂÆåÊàê (Ê®°Âºè: ${isGlobalTopMode ? 'ÂÖ®ÁêÉÊúÄÂº∫' : '‰∏™‰∫∫Êï∞ÊçÆ'})`);
            
            // Â¶ÇÊûúÊ£ÄÊµãÂà∞Áî®Êà∑Êï∞ÊçÆ‰∏îÂ∑¶‰æßÊäΩÂ±âÂ∑≤ÊâìÂºÄÔºåËá™Âä®Âà∑Êñ∞Áî®Êà∑ÁªüËÆ°Âç°Áâá
            if (userData && !isGlobalTopMode) {
                try {
                    const leftDrawer = document.getElementById('left-drawer');
                    const leftBody = document.getElementById('left-drawer-body');
                    
                    // Ê£ÄÊü•Â∑¶‰æßÊäΩÂ±âÊòØÂê¶ÊâìÂºÄÔºàÈÄöËøáÊ£ÄÊü• active classÔºâ
                    if (leftDrawer && leftBody) {
                        const isDrawerOpen = leftDrawer.classList.contains('active');
                        
                        if (isDrawerOpen) {
                            // ÈáçÊñ∞Ê∏≤ÊüìÁî®Êà∑ÁªüËÆ°Âç°ÁâáÔºà‰ºòÂÖà‰ΩøÁî® allData ‰∏≠ÁöÑÂÆåÊï¥ËÆ∞ÂΩïÔºâ
                            renderUserStatsCards(leftBody, getBestUserRecordForStats(userData));
                            console.log('[Rank] ‚úÖ Â∑≤Ëá™Âä®Âà∑Êñ∞Â∑¶‰æßÊäΩÂ±âÁöÑÁî®Êà∑ÁªüËÆ°Âç°Áâá');
                        }
                    }
                } catch (e) {
                    console.warn('[Rank] ‚ö†Ô∏è Âà∑Êñ∞Â∑¶‰æßÊäΩÂ±âÁªüËÆ°Âç°ÁâáÂ§±Ë¥•:', e);
                }
            }
        }


        window.onload = async () => {
            // Âä†ËΩΩ‰øùÂ≠òÁöÑGitHubÁî®Êà∑ÂêçÔºàÂÖºÂÆπÊóß‰ª£Á†ÅÔºâ
            loadGitHubUsername();
            
            // ÂàùÂßãÂåñÁä∂ÊÄÅÊåâÈíÆ
            initStatusButtons();
            
            // ÂàùÂßãÂåñÊäΩÂ±âÁä∂ÊÄÅ
            initDrawerState();
            
            // Âä†ËΩΩÁª¥Â∫¶ÊéíÂêçÊï∞ÊçÆËµÑÊ∫ê
            await loadRankResources();
            
            // ÂÖàÊâßË°åÂàùÂßãÊï∞ÊçÆÂä†ËΩΩÔºàÂ¢ûÂº∫ÈîôËØØÂ§ÑÁêÜÔºâ
            try {
                await fetchData();
            } catch (fetchError) {
                console.error('[Window.onload] ‚ùå fetchData Â§±Ë¥•:', fetchError);
                // Âç≥‰ΩøÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•Ôºå‰πüÁªßÁª≠ÊâßË°åÂêéÁª≠ÂàùÂßãÂåñ
            }
            
            // ============================================
            // „ÄêÊñ∞Â¢û„ÄëÂàùÂßãÂåñ GitHub OAuth ËÆ§ËØÅÁõëÂê¨
            // ============================================
            if (supabaseClient) {
                // Ê£ÄÊü•ÂΩìÂâç‰ºöËØù
                try {
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    
                    if (sessionError) {
                        console.warn('[Auth] ‚ö†Ô∏è Ëé∑Âèñ‰ºöËØùÂ§±Ë¥•:', sessionError);
                    } else if (session) {
                        console.log('[Auth] ‚úÖ Ê£ÄÊµãÂà∞Áé∞Êúâ‰ºöËØùÔºåËá™Âä®Â§ÑÁêÜËÆ§ËØÅÁä∂ÊÄÅ');
                        await handleAuthStateChange(session);
                    } else {
                        console.log('[Auth] ‚ÑπÔ∏è Êú™Ê£ÄÊµãÂà∞‰ºöËØùÔºåÊòæÁ§∫ÁôªÂΩïÊåâÈíÆ');
                        updateAuthUI(null);
                    }
                } catch (error) {
                    console.error('[Auth] ‚ùå ÂàùÂßãÂåñËÆ§ËØÅÁõëÂê¨Â§±Ë¥•:', error);
                }
                
                // ÁõëÂê¨ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('[Auth] üîî ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ‰∫ã‰ª∂:', event, session ? 'Êúâ‰ºöËØù' : 'Êó†‰ºöËØù');
                    
                    if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                        await handleAuthStateChange(session);
                        
                        // „ÄêTask 3„ÄëÂΩì event === 'SIGNED_IN' Êó∂ÔºåÊòæÂºèË∞ÉÁî®‰∏ÄÊ¨° window.refreshUserStats() Âíå fetchAllData()
                        if (event === 'SIGNED_IN') {
                            console.log('[Auth] üîÑ Áî®Êà∑ÁôªÂΩïÊàêÂäüÔºåËß¶ÂèëÊï∞ÊçÆÂà∑Êñ∞...');
                            try {
                                // ÂÖàÂà∑Êñ∞ÂÖ®Â±ÄÊï∞ÊçÆ
                                if (typeof fetchData === 'function') {
                                    await fetchData();
                                    console.log('[Auth] ‚úÖ fetchData ÊâßË°åÂÆåÊàê');
                                }
                                
                                // ÂÜçÂà∑Êñ∞Áî®Êà∑ÁªüËÆ°Êï∞ÊçÆ
                                if (typeof window.refreshUserStats === 'function') {
                                    try {
                                        await window.refreshUserStats();
                                        console.log('[Auth] ‚úÖ refreshUserStats ÊâßË°åÂÆåÊàê');
                                    } catch (refreshError) {
                                        // „Äê‰øÆÂ§ç AbortError„ÄëÁâπÊÆäÂ§ÑÁêÜ AbortError
                                        if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                            console.log('[Auth] ‚ÑπÔ∏è refreshUserStats Ë¢´ÂèñÊ∂àÔºàÂèØËÉΩÊòØÈ°µÈù¢Âà∑Êñ∞ÂØºËá¥Ôºâ');
                                        } else {
                                            console.error('[Auth] ‚ùå refreshUserStats ÊâßË°åÂ§±Ë¥•:', refreshError);
                                        }
                                    }
                                }
                            } catch (refreshError) {
                                // „Äê‰øÆÂ§ç AbortError„ÄëÁâπÊÆäÂ§ÑÁêÜ AbortError
                                if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                    console.log('[Auth] ‚ÑπÔ∏è Êï∞ÊçÆÂà∑Êñ∞Ë¢´ÂèñÊ∂àÔºàÂèØËÉΩÊòØÈ°µÈù¢Âà∑Êñ∞ÂØºËá¥Ôºâ');
                                } else {
                                    console.error('[Auth] ‚ùå Êï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•:', refreshError);
                                }
                            }
                        }
                    } else if (event === 'SIGNED_OUT') {
                        await handleAuthStateChange(null);
                    }
                });
                
                console.log('[Auth] ‚úÖ ËÆ§ËØÅÁä∂ÊÄÅÁõëÂê¨Â∑≤ÂêØÂä®');
            } else {
                console.warn('[Auth] ‚ö†Ô∏è Supabase ÂÆ¢Êà∑Á´ØÊú™ÂàùÂßãÂåñÔºåÊó†Ê≥ïÂêØÂä®ËÆ§ËØÅÁõëÂê¨');
                // Âª∂ËøüÈáçËØï
                setTimeout(async () => {
                    if (supabaseClient) {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        if (session) {
                            await handleAuthStateChange(session);
                        } else {
                            updateAuthUI(null);
                        }
                    }
                }, 1000);
            }
            
            // È°µÈù¢Âä†ËΩΩÂêéÁ´ãÂç≥ÊòæÁ§∫ LPDEF ÂàÜÂÄºÔºöÊâßË°åË∫´‰ªΩÊ£ÄÊü•ÔºàÂ¢ûÂº∫Ë∫´‰ªΩËØÜÂà´ÈÄªËæëÔºâ
            try {
                // ËæÖÂä©ÂáΩÊï∞ÔºöËßÑËåÉÂåñÊåáÁ∫πÂ≠óÁ¨¶‰∏≤ÔºàÂøΩÁï•Â§ßÂ∞èÂÜôÂπ∂ÂâîÈô§È¶ñÂ∞æÁ©∫Ê†ºÔºâ
                const normalizeFingerprint = (fp) => {
                    if (!fp) return '';
                    return String(fp).trim().toLowerCase();
                };
                
                // 1. ÁîüÊàêÊàñËé∑ÂèñÂΩìÂâçËÆæÂ§áÁöÑ FingerprintÔºàÂ¢ûÂä†ÂºÇÂ∏∏Â§ÑÁêÜÔºâ
                // „Äê‰ºòÂåñ„Äë‰ΩøÁî®Áªü‰∏ÄÁöÑÊåáÁ∫πËé∑ÂèñÂáΩÊï∞ÔºåÁ°Æ‰øù‰∏ÄËá¥ÊÄß
                let currentFingerprint = await getCurrentFingerprint();
                
                if (!currentFingerprint) {
                    console.warn('[LPDEF] ‚ö†Ô∏è Êó†Ê≥ïËé∑ÂèñÊàñÁîüÊàêÊåáÁ∫π');
                } else {
                    console.log('[LPDEF] üîë ÂΩìÂâçËÆæÂ§á Fingerprint:', currentFingerprint.substring(0, 8) + '...');
                }
                
                // ËßÑËåÉÂåñÂΩìÂâçÊåáÁ∫π
                const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                
                // 2. ‰ªé localStorage Ëé∑Âèñ github_usernameÔºàÂ¢ûÂä†ÂºÇÂ∏∏Â§ÑÁêÜÔºâ
                let localGitHubName = null;
                try {
                    localGitHubName = localStorage.getItem('github_username');
                } catch (e) {
                    console.warn('[LPDEF] ‚ö†Ô∏è ËØªÂèñ localStorage github_username Â§±Ë¥•:', e);
                }
                
                // 3. „Äê‰ºòÂåñ„Äë‰ºòÂÖà‰ªéÂ∑≤Âä†ËΩΩÁöÑ allData Êï∞ÁªÑ‰∏≠Êü•ÊâæÂåπÈÖçÈ°πÔºàÈÅøÂÖçÈ¢ùÂ§ñÁöÑ API Ë∞ÉÁî®Ôºâ
                const allData = window.allData || [];
                console.log('[LPDEF] üìä allData Êï∞ÊçÆÈáè:', allData.length);
                
                let currentUser = null;
                let matchedByFingerprint = false;
                
                // „Äê‰ºòÂÖàÁ∫ß1„ÄëÈ¶ñÂÖà‰ªé allData ‰∏≠Êü•Êâæ fingerprint ÂåπÈÖçÁöÑËÆ∞ÂΩï
                if (normalizedCurrentFingerprint && allData.length > 0) {
                    console.log('[LPDEF] üîç ÂºÄÂßã‰ªé allData ‰∏≠Êü•ÊâæÊåáÁ∫πÂåπÈÖç...');
                    
                    currentUser = allData.find(user => {
                        const userFingerprint = normalizeFingerprint(user.fingerprint || user.user_fingerprint);
                        const userIdentity = normalizeFingerprint(user.user_identity);
                        
                        const matchFingerprint = userFingerprint && userFingerprint === normalizedCurrentFingerprint;
                        const matchIdentity = userIdentity && userIdentity === normalizedCurrentFingerprint;
                        
                        if (matchFingerprint || matchIdentity) {
                            console.log('[LPDEF] ‚úÖ Âú® allData ‰∏≠ÊâæÂà∞ÊåáÁ∫πÂåπÈÖç:', {
                                id: user.id,
                                user_name: user.user_name || user.name,
                                fingerprint: user.fingerprint ? user.fingerprint.substring(0, 8) + '...' : null
                            });
                            matchedByFingerprint = true;
                            return true;
                        }
                        return false;
                    });
                    
                    if (currentUser) {
                        console.log('[LPDEF] ‚úÖ ÈÄöËøáÊú¨Âú∞ allData ÂåπÈÖçÂà∞Áî®Êà∑:', currentUser.user_name || currentUser.name);
                    } else {
                        console.log('[LPDEF] ‚ÑπÔ∏è Âú® allData ‰∏≠Êú™ÊâæÂà∞ÊåáÁ∫πÂåπÈÖç');
                    }
                }
                
                // „Äê‰ºòÂÖàÁ∫ß2„ÄëÂ¶ÇÊûú allData ‰∏≠Êú™ÊâæÂà∞Ôºå‰∏î Supabase ÂÆ¢Êà∑Á´ØÂ∑≤ÂàùÂßãÂåñÔºåÂ∞ùËØïÁõ¥Êé•Êü•ËØ¢Êï∞ÊçÆÂ∫ì
                if (!currentUser && normalizedCurrentFingerprint && supabaseClient) {
                    try {
                        console.log('[LPDEF] üîç allData ‰∏≠Êú™ÊâæÂà∞ÔºåÂ∞ùËØï‰ªé Supabase Áõ¥Êé•Êü•ËØ¢Ôºà‰ΩøÁî®Áªü‰∏ÄËßÜÂõæÔºâ...');
                        
                        // „ÄêTask 2„Äë‰ΩøÁî®Áªü‰∏ÄËßÜÂõæ v_unified_analysis_v2
                        const { data: dbUser, error: queryError } = await supabaseClient
                            .from('v_unified_analysis_v2')
                            .select('*')
                            .eq('fingerprint', currentFingerprint)
                            .maybeSingle();
                        
                        if (queryError && queryError.code !== 'PGRST116') {
                            console.warn('[LPDEF] ‚ö†Ô∏è Supabase Êü•ËØ¢Â§±Ë¥•:', queryError);
                        } else if (dbUser) {
                            console.log('[LPDEF] ‚úÖ ‰ªé Supabase Êü•ËØ¢Âà∞Áî®Êà∑:', dbUser.user_name || dbUser.name);
                            
                            // Â∞ÜÊü•ËØ¢Âà∞ÁöÑÁî®Êà∑Ê∑ªÂä†Âà∞ allData
                            const existingIndex = allData.findIndex(item => item.id === dbUser.id);
                            if (existingIndex !== -1) {
                                allData[existingIndex] = { ...allData[existingIndex], ...dbUser };
                            } else {
                                allData.push(dbUser);
                            }
                            window.allData = allData;
                            
                            currentUser = dbUser;
                            matchedByFingerprint = true;
                        } else {
                            console.log('[LPDEF] ‚ÑπÔ∏è Supabase ‰∏≠Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÁî®Êà∑');
                        }
                    } catch (error) {
                        console.warn('[LPDEF] ‚ö†Ô∏è Supabase Êü•ËØ¢Âá∫Èîô:', error);
                    }
                }
                
                // 4. URL ÂèÇÊï∞ÊîØÊåÅÔºöÂ¶ÇÊûú URL ‰∏≠Â∏¶‰∫Ü id ÂèÇÊï∞ÔºåÂº∫Âà∂‰ΩøÁî®ËØ• ID ËøõË°åÂåπÈÖçÔºàÁî®‰∫éÊµãËØïÔºâ
                const urlParams = new URLSearchParams(window.location.search);
                const urlId = urlParams.get('id');
                if (urlId) {
                    console.log('[Rank] üîç Ê£ÄÊµãÂà∞ URL ÂèÇÊï∞ id:', urlId, 'ÔºåÂ∞ÜÂº∫Âà∂‰ΩøÁî®ËØ• ID ËøõË°åÂåπÈÖç');
                    const urlMatchedUser = allData.find(user => {
                        const userId = (user.id || '').toString();
                        const userFingerprint = (user.fingerprint || user.user_identity || '').toString();
                        return userId === urlId || userFingerprint === urlId;
                    });
                    if (urlMatchedUser) {
                        currentUser = urlMatchedUser;
                        console.log('[Rank] ‚úÖ ÈÄöËøá URL ÂèÇÊï∞ id ÊâæÂà∞Áî®Êà∑:', currentUser.user_name || currentUser.name);
                    }
                }
                
                // 5. Â¶ÇÊûúÊåáÁ∫πÊú™ÂåπÈÖçÔºåÂÜçÈÄÄËÄåÊ±ÇÂÖ∂Ê¨°ÂØªÊâæ github_username
                if (!currentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                    const normalizedLocalGitHub = normalizeFingerprint(localGitHubName);
                    currentUser = allData.find(user => {
                        const userGithubId = normalizeFingerprint(user.github_username || user.github_id || '');
                        return userGithubId && userGithubId === normalizedLocalGitHub;
                    });
                    
                    if (currentUser) {
                        console.log('[Rank] ‚úÖ ÈÄöËøá GitHub ID ÊâæÂà∞Áî®Êà∑:', currentUser.user_name || currentUser.name);
                    }
                }
                
                // 6. ÂÖúÂ∫ïÂåπÈÖç - Â¶ÇÊûú fingerprint ‰∏∫Á©∫ÔºåÂ∞ùËØïÈÄöËøá id Êàñ user_name ÂåπÈÖç
                if (!currentUser && !normalizedCurrentFingerprint) {
                    try {
                        const savedUserId = localStorage.getItem('user_id');
                        if (savedUserId) {
                            currentUser = allData.find(user => {
                                return user.id && user.id.toString() === savedUserId.toString();
                            });
                        }
                        
                        if (!currentUser) {
                            const savedUserName = localStorage.getItem('user_name');
                            if (savedUserName) {
                                currentUser = allData.find(user => {
                                    return user.user_name && user.user_name.toString() === savedUserName.toString();
                                });
                            }
                        }
                    } catch (e) {
                        console.warn('[Rank] ‚ö†Ô∏è ÂÖúÂ∫ïÂåπÈÖçÊó∂ËØªÂèñ localStorage Â§±Ë¥•:', e);
                    }
                }
                
                // ‰øùÂ≠òÂåπÈÖçÊñπÂºèÂà∞ÂÖ®Â±ÄÂèòÈáèÔºå‰æõ renderRankCards ‰ΩøÁî®
                if (currentUser) {
                    window.currentUser = currentUser;
                    window.currentUserMatchedByFingerprint = matchedByFingerprint;
                }
                
                // 4. Ëá™Âä®Ë°•ÈΩêÈÄªËæëÔºöÂ¶ÇÊûúÂú®Â∫ìÈáåÊâæÂà∞‰∫ÜÂΩìÂâçËÆæÂ§áÁöÑ FingerprintÔºå‰ΩÜËØ•ËÆ∞ÂΩïÁöÑ user_name ÊòØ "Guest" ‰∏î github_id ‰∏∫Á©∫
                if (currentUser && currentFingerprint) {
                    const userGithubId = currentUser.github_username || currentUser.github_id || null;
                    const userName = currentUser.user_name || currentUser.name || '';
                    const isGuestUser = userName.includes('Guest') || userName === 'ÂåøÂêçÂèóÂÆ≥ËÄÖ' || !userGithubId;
                    
                    // Â¶ÇÊûúÁî®Êà∑Â∑≤ÁªèÂú® stats2.html ËÆæÁΩÆ‰∫Ü GitHub Áî®Êà∑ÂêçÔºåÁ´ãÂç≥ÂèëËµ∑ PATCH ËØ∑Ê±ÇÁªëÂÆö
                    if (isGuestUser && localGitHubName && isValidGitHubUsername(localGitHubName) && !userGithubId) {
                        console.log('[LPDEF] üîó Ê£ÄÊµãÂà∞ Guest Áî®Êà∑ÔºåÂ∞ùËØïÁªëÂÆö GitHub ID:', localGitHubName);
                        
                        // ÂèëËµ∑ PATCH ËØ∑Ê±ÇÔºåÊõ¥Êñ∞Êï∞ÊçÆÂ∫ìËÆ∞ÂΩï
                        if (supabaseClient) {
                            try {
                                // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÁôªÂΩïÂêéÂøÖÈ°ª‰ΩøÁî® user_id ËøõË°åÊõ¥Êñ∞ÔºåËÄå‰∏çÊòØ fingerprint
                                let updateField = 'id';
                                let updateValue = currentUser.id;
                                
                                // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩï
                                try {
                                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                                    if (!sessionError && session && session.user) {
                                        const authenticatedUserId = session.user.id;
                                        // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºå‰ºòÂÖà‰ΩøÁî®ÁôªÂΩïÁöÑ user_id
                                        if (authenticatedUserId && currentUser.id === authenticatedUserId) {
                                            updateField = 'id';
                                            updateValue = authenticatedUserId;
                                            console.log('[LPDEF] ‚úÖ Â∑≤ÁôªÂΩïÔºå‰ΩøÁî® user_id ËøõË°åÊõ¥Êñ∞ÔºàËÆ§Á•ñÂΩíÂÆóÔºâ');
                                        }
                                    }
                                } catch (authError) {
                                    console.warn('[LPDEF] ‚ö†Ô∏è Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅÂ§±Ë¥•:', authError);
                                }
                                
                                // Â¶ÇÊûúÊú™ÁôªÂΩïÊàñ user_id ‰∏çÂåπÈÖçÔºå‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à
                                if (!updateValue || updateField !== 'id') {
                                    updateField = currentUser.fingerprint ? 'fingerprint' : (currentUser.user_identity ? 'user_identity' : 'id');
                                    updateValue = currentUser.fingerprint || currentUser.user_identity || currentUser.id;
                                    console.log('[LPDEF] ‚ö†Ô∏è Êú™ÁôªÂΩïÔºå‰ΩøÁî®ÈôçÁ∫ßÊñπÊ°à:', updateField);
                                }
                                
                                if (updateField && updateValue) {
                                    // „Äê‰øÆÂ§ç 400 ÈîôËØØ„ÄëÁßªÈô§‰∏çÂ≠òÂú®ÁöÑ github_username Â≠óÊÆµÔºåÂè™Êõ¥Êñ∞ user_name
                                    const { data, error } = await supabaseClient
                                        .from('user_analysis')
                                        .update({
                                            user_name: localGitHubName, // Êõ¥Êñ∞Áî®Êà∑ÂêçÔºàGitHub Áî®Êà∑ÂêçÂ≠òÂÇ®Âú® user_name Â≠óÊÆµ‰∏≠Ôºâ
                                            user_identity: updateField === 'id' ? 'github' : currentUser.user_identity, // Â¶ÇÊûú‰ΩøÁî® idÔºåËÆæÁΩÆ‰∏∫ github
                                            updated_at: new Date().toISOString()
                                        })
                                        .eq(updateField, updateValue)
                                        .select();
                                    
                                    if (error) {
                                        console.error('[LPDEF] ‚ùå ÁªëÂÆö GitHub ID Â§±Ë¥•:', error);
                                    } else if (data && data.length > 0) {
                                        console.log('[LPDEF] ‚úÖ GitHub ID ÁªëÂÆöÊàêÂäü:', data[0]);
                                        // Êõ¥Êñ∞ currentUser ÂØπË±°
                                        currentUser.github_username = localGitHubName;
                                        currentUser.user_name = localGitHubName;
                                        // Êõ¥Êñ∞ window.allData ‰∏≠ÁöÑÂØπÂ∫îËÆ∞ÂΩï
                                        const index = allData.findIndex(u => 
                                            (u.fingerprint || u.user_identity || u.id) === updateValue
                                        );
                                        if (index !== -1) {
                                            allData[index] = { ...allData[index], ...currentUser };
                                            window.allData = allData;
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error('[LPDEF] ‚ùå ÁªëÂÆö GitHub ID ËøáÁ®ãÂá∫Èîô:', error);
                            }
                        }
                    }
                }
                
                // 7. ‰øùÂ≠òÂåπÈÖçÁªìÊûúÂà∞ÂÖ®Â±ÄÂèòÈáè
                if (currentUser) {
                    window.currentUser = currentUser;
                    window.currentUserMatchedByFingerprint = matchedByFingerprint;
                    console.log('[Rank] ‚úÖ Áî®Êà∑ÂåπÈÖçÊàêÂäüÔºåÂ∑≤ËÆæÁΩÆÂÖ®Â±ÄÂèòÈáè');
                }
                
                // 8. Áªü‰∏ÄË∞ÉÁî® renderRankCards Ê∏≤Êüì 6 Áª¥Â∫¶ÊéíÂêçÂç°Áâá
                // Ë∫´‰ªΩËØÜÂà´ÂÖúÂ∫ïÔºöÂ¶ÇÊûúÊúÄÁªà currentUser ‰æùÁÑ∂‰∏∫ nullÔºåÊòæÂºèË∞ÉÁî® renderRankCards(null)
                // ËøôÂ∞ÜËß¶Âèë"ÂÖ®ÁêÉÈÄâÊãî"ÈÄªËæëÔºåÊòæÁ§∫ÊØè‰∏™Áª¥Â∫¶ÁöÑÂÖ®ÁêÉÊúÄÂº∫Áî®Êà∑
                if (currentUser) {
                    console.log('[Rank] ‚úÖ ÊâæÂà∞ÂΩìÂâçÁî®Êà∑Êï∞ÊçÆÔºåÊ∏≤ÊüìÊéíÂêçÂç°Áâá:', currentUser.user_name || currentUser.name);
                    renderRankCards(currentUser);
                    
                    // „Äê‰ºòÂåñ„ÄëÂ¶ÇÊûúÊâæÂà∞ÂåπÈÖçÁî®Êà∑ÔºåÁ´ãÂç≥Ê£ÄÊü•Âπ∂Âä†ËΩΩÊäΩÂ±âÔºàÂèñÊ∂à WAIT Áä∂ÊÄÅÔºâ
                    setTimeout(() => {
                        const leftDrawer = document.getElementById('left-drawer');
                        const leftBody = document.getElementById('left-drawer-body');
                        
                        if (leftDrawer && leftBody) {
                            // Ê£ÄÊü•ÊòØÂê¶ÊúâÁ≠âÂæÖÂç°Áâá
                            const waitingCards = leftBody.querySelectorAll('.drawer-item');
                            waitingCards.forEach(card => {
                                const label = card.querySelector('.drawer-item-label');
                                if (label && label.textContent === 'Êï∞ÊçÆÂä†ËΩΩ‰∏≠') {
                                    console.log('[Rank] ‚úÖ ÊâæÂà∞ÂåπÈÖçÁî®Êà∑ÔºåÁßªÈô§Á≠âÂæÖÂç°ÁâáÂπ∂Âä†ËΩΩÁªüËÆ°Âç°Áâá');
                                    card.remove();
                                    
                                    // Á´ãÂç≥Ê∏≤ÊüìÁî®Êà∑ÁªüËÆ°Âç°ÁâáÔºà‰ºòÂÖà‰ΩøÁî® allData ‰∏≠ÁöÑÂÆåÊï¥ËÆ∞ÂΩïÔºâ
                                    renderUserStatsCards(leftBody, getBestUserRecordForStats(currentUser));
                                }
                            });
                        }
                    }, 100); // Âª∂Ëøü‰∏ÄÂ∞èÊÆµÊó∂Èó¥ÔºåÁ°Æ‰øù DOM Â∑≤Êõ¥Êñ∞
                } else {
                    console.log('[Rank] ‚ö†Ô∏è Êú™ÊâæÂà∞ÂΩìÂâçÁî®Êà∑Êï∞ÊçÆÔºåËß¶ÂèëÂÖ®ÁêÉÊúÄÂº∫Ê®°ÂºèÔºàÂÖ®ÁêÉÈÄâÊãîÔºâ');
                    // ÊòæÂºèË∞ÉÁî® renderRankCards(null) Ëß¶ÂèëÂÖ®ÁêÉÈÄâÊãîÈÄªËæë
                    renderRankCards(null);
                }
            } catch (error) {
                console.error('[Rank] ‚ùå Ë∫´‰ªΩÊ£ÄÊü•Â§±Ë¥•:', error);
                // Âá∫ÈîôÊó∂‰πüÊòæÂºèË∞ÉÁî® renderRankCards(null)ÔºåËß¶ÂèëÂÖ®ÁêÉÊúÄÂº∫Ê®°ÂºèÔºàÂÖ®ÁêÉÈÄâÊãîÔºâ
                renderRankCards(null);
            }
            
            // ÂàùÂßãÂä†ËΩΩÂÆåÊàêÂêéÔºåÂêØÂä® Realtime ÁõëÂê¨
            // Âª∂Ëøü‰∏ÄÂ∞èÊÆµÊó∂Èó¥ÔºåÁ°Æ‰øùÊâÄÊúâÊ∏≤ÊüìÂ∑≤ÂÆåÊàê
            setTimeout(() => {
                startRealtimeListener();
            }, 500);
        };

        // ==========================================
        // WordCloud: /api/v2/wordcloud-data -> ECharts wordCloud
        // ==========================================
        let vibeWordCloudChart = null;
        let vibeWordCloudAbort = null;

        async function loadWordCloud() {
            const container = document.getElementById('wordcloud-container');
            if (!container) return;

            // Loader
            container.innerHTML = `
                <div class="vibe-cloud-loader">
                    <div class="dot" aria-hidden="true"></div>
                    <div class="dot" aria-hidden="true"></div>
                    <div class="dot" aria-hidden="true"></div>
                    <div class="label">LOADING VIBES</div>
                </div>
            `;

            // Dependency checks
            if (typeof echarts === 'undefined') {
                container.innerHTML = '<div class="text-zinc-500 text-sm p-4">ECharts Êú™Âä†ËΩΩ</div>';
                return;
            }

            const apiEndpoint = (document.querySelector('meta[name="api-endpoint"]')?.content || '').trim();
            const API_ENDPOINT = apiEndpoint.endsWith('/') ? apiEndpoint : `${apiEndpoint}/`;

            try {
                // ÈùûÈòªÂ°û/Èò≤ÊäñÔºöÂ¶ÇÊûú‰∏ä‰∏ÄÊ¨°ËøòÊ≤°ÁªìÊùüÔºåÁõ¥Êé•ÂèñÊ∂à
                try { vibeWordCloudAbort && vibeWordCloudAbort.abort(); } catch (e) { /* ignore */ }
                vibeWordCloudAbort = new AbortController();

                // ÂõΩÂÆ∂ÈÄèËßÜÔºàCOUNTRYÔºâÊó∂ÔºöËØç‰∫ëÂ∫î‰ΩøÁî®ËØ•Âú∞Âå∫/ÂõΩÂÆ∂Âè£ÂæÑÔºåËÄå‰∏çÊòØÂÖ®Â±ÄÂè£ÂæÑ
                let region = null;
                try {
                    if (typeof currentViewState === 'string' && currentViewState === 'COUNTRY') {
                        const cc = String(currentDrawerCountry?.code || '').trim().toUpperCase();
                        if (cc.length === 2) region = cc;
                    }
                } catch (e) { /* ignore */ }

                const wcUrl = region
                    ? `${API_ENDPOINT}api/v2/wordcloud-data?region=${encodeURIComponent(region)}`
                    : `${API_ENDPOINT}api/v2/wordcloud-data`;

                const resp = await fetch(wcUrl, {
                    signal: vibeWordCloudAbort.signal,
                    // COUNTRY ËßÜÂõæ‰∏çË¶ÅÁî® force-cacheÔºåÈÅøÂÖçÊµèËßàÂô®ÁºìÂ≠ò‰Ωè fallbackÔºàÁ°¨ÁºñÁ†ÅÔºâËØç‰∫ë
                    cache: region ? 'no-store' : 'force-cache',
                });
                const json = await resp.json().catch(() => null);

                const rows = Array.isArray(json?.data) ? json.data : [];
                const words = rows
                    .map((x) => ({
                        name: String(x?.name || '').trim(),
                        value: Number(x?.value) || 0,
                        // „ÄêV6.0 Êñ∞Â¢û„ÄëÊîØÊåÅ category Â≠óÊÆµ
                        category: x?.category || 'slang', // ÈªòËÆ§ slang
                    }))
                    .filter((x) => x.name && x.value > 0)
                    .sort((a, b) => b.value - a.value) // ÊåâÊùÉÈáçÊéíÂ∫è
                    .slice(0, 50); // Âä®ÊÄÅÈòàÂÄºÔºöÂè™ÂèñÂâç 50

                if (words.length === 0) {
                    container.innerHTML = '<div class="text-zinc-500 text-sm p-4">ÊöÇÊó†ËØç‰∫ëÊï∞ÊçÆ</div>';
                    return;
                }

                // Clear loader and (re)create chart
                container.innerHTML = '';
                try {
                    if (vibeWordCloudChart && typeof vibeWordCloudChart.dispose === 'function') {
                        vibeWordCloudChart.dispose();
                    }
                } catch (e) {
                    // ignore
                }
                // Ê∑±Ëâ≤È£éÊ†ºÔºö‰ΩøÁî® ECharts ÂÜÖÁΩÆ dark themeÔºàÂ¶Ç‰∏çÂèØÁî®‰πü‰∏ç‰ºöÊä•ÈîôÔºâ
                vibeWordCloudChart = echarts.init(container, 'dark', { renderer: 'canvas' });

                const maxVal = Math.max(...words.map((w) => w.value));
                const minVal = Math.min(...words.map((w) => w.value));
                const width = Math.max(320, container.clientWidth || 640);
                const maxFont = Math.max(22, Math.floor(width * 0.2)); // ÊúÄÂ§ß‰∏çË∂ÖËøáÂÆπÂô®ÂÆΩÂ∫¶ÁöÑ20%

                // „ÄêV6.0 Êñ∞Â¢û„ÄëÂü∫‰∫é category ÁöÑÈ¢úËâ≤Êò†Â∞Ñ
                const getCategoryStyle = (category, value) => {
                    // ÂΩí‰∏ÄÂåñ value Âà∞ 0-1 ËåÉÂõ¥ÔºåÁî®‰∫éÂä®ÊÄÅÂèëÂÖâ
                    const intensity = Math.min(1, value / maxVal);

                    switch (category) {
                        case 'merit': // ÂäüÂæ∑ËØçÔºöÁªøËâ≤Á≥ª
                            return {
                                color: `rgba(16, 185, 129, ${0.7 + intensity * 0.3})`, // #10B981
                                shadowBlur: 8 + intensity * 12,
                                shadowColor: `rgba(16, 185, 129, ${0.4 + intensity * 0.4})`,
                            };
                        case 'sv_slang': // Á°ÖË∞∑ÈªëËØùÔºöÊ©ôËâ≤Á≥ª
                            return {
                                color: `rgba(249, 115, 22, ${0.7 + intensity * 0.3})`, // #F97316
                                shadowBlur: 8 + intensity * 12,
                                shadowColor: `rgba(249, 115, 22, ${0.4 + intensity * 0.4})`,
                            };
                        case 'slang': // ÈªëËØùËØçÔºöÁ¥´Ëâ≤Á≥ªÔºàÈªòËÆ§Ôºâ
                        default:
                            return {
                                color: `rgba(168, 85, 247, ${0.7 + intensity * 0.3})`, // #A855F7
                                shadowBlur: 8 + intensity * 12,
                                shadowColor: `rgba(168, 85, 247, ${0.4 + intensity * 0.4})`,
                            };
                    }
                };

                // „ÄêV6.0 Êñ∞Â¢û„Äëtooltip formatter ÊòæÁ§∫ category ‰ø°ÊÅØ
                const categoryLabels = {
                    'merit': 'ÂäüÂæ∑',
                    'slang': 'ÈªëËØù',
                    'sv_slang': 'Á°ÖË∞∑ÈªëËØù',
                };

                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        show: true,
                        backgroundColor: 'rgba(9,10,15,0.92)',
                        borderColor: 'rgba(148,163,184,0.22)',
                        borderWidth: 1,
                        padding: [8, 10],
                        textStyle: { color: '#e5e7eb', fontFamily: 'JetBrains Mono, monospace' },
                        // „ÄêV6.0 Êñ∞Â¢û„ÄëÊòæÁ§∫ category ‰ø°ÊÅØ
                        formatter: (p) => {
                            const catLabel = categoryLabels[p.data.category] || 'Êú™Áü•';
                            return `${p.name}: ${p.value} (${catLabel})`;
                        },
                    },
                    series: [
                        {
                            type: 'wordCloud',
                            shape: 'circle',
                            left: 'center',
                            top: 'center',
                            width: '100%',
                            height: '100%',
                            gridSize: 6,
                            // value -> font size
                            sizeRange: [12, maxFont],
                            rotationRange: [0, 0], // ËÆæÁΩÆ‰∏∫ 0 ‰ª•ÊèêÈ´ò‰∏≠ÊñáÂ≠óÁ¨¶ÁöÑÈòÖËØªÊÄß
                            rotationStep: 0,
                            drawOutOfBound: false,
                            textStyle: {
                                fontFamily: 'JetBrains Mono, monospace',
                                // „ÄêV6.0 Êñ∞Â¢û„ÄëÂü∫‰∫é category Âä®ÊÄÅÈ¢úËâ≤
                                color: (p) => getCategoryStyle(p.data.category, p.data.value).color,
                                shadowBlur: (p) => getCategoryStyle(p.data.category, p.data.value).shadowBlur,
                                shadowColor: (p) => getCategoryStyle(p.data.category, p.data.value).shadowColor,
                            },
                            emphasis: {
                                focus: 'self',
                                textStyle: {
                                    // „ÄêV6.0 Êñ∞Â¢û„Äëhover Êó∂Â¢ûÂº∫ÂèëÂÖâÊïàÊûú
                                    shadowBlur: (p) => {
                                        return getCategoryStyle(p.data.category, p.data.value).shadowBlur * 1.5;
                                    },
                                    shadowColor: (p) => {
                                        return getCategoryStyle(p.data.category, p.data.value).shadowColor;
                                    },
                                },
                            },
                            // „ÄêV6.0 Êñ∞Â¢û„ÄëÁÇπÂáª‰∫ã‰ª∂ÔºöËß¶ÂèëÂú∞ÂõæËÅîÂä®
                            onclick: (p) => {
                                handleWordCloudClick(p.data.name, p.data.category);
                            },
                            data: words,
                        },
                    ],
                };

                // Some environments load plugin late; wrap setOption for friendly fallback
                try {
                    vibeWordCloudChart.setOption(option, true);
                } catch (e) {
                    container.innerHTML = '<div class="text-zinc-500 text-sm p-4">WordCloud Êèí‰ª∂Êú™Âä†ËΩΩÊàñÊ∏≤ÊüìÂ§±Ë¥•</div>';
                    try { vibeWordCloudChart.dispose(); } catch {}
                    vibeWordCloudChart = null;
                    return;
                }

                // Responsive
                window.setTimeout(() => {
                    try { vibeWordCloudChart && vibeWordCloudChart.resize(); } catch {}
                }, 0);

                // Re-render on resize (lightweight)
                if (!window.__vibeCloudResizeBound) {
                    window.__vibeCloudResizeBound = true;
                    window.addEventListener('resize', () => {
                        try { vibeWordCloudChart && vibeWordCloudChart.resize(); } catch {}
                    });
                }
            } catch (err) {
                // fallback_keywordsÔºöÁ°Æ‰øù UI ‰∏çÂ¥©Ê∫É
                const fallback_keywords = [
                    { name: 'È¢óÁ≤íÂ∫¶', value: 180 },
                    { name: 'Èó≠ÁéØ', value: 165 },
                    { name: 'ÊñπÊ≥ïËÆ∫', value: 142 },
                    { name: 'ÂØπÈΩê', value: 130 },
                    { name: 'ËêΩÂú∞', value: 118 },
                    { name: 'ÊäìÊâã', value: 110 },
                ];
                try {
                    container.innerHTML = '';
                    if (vibeWordCloudChart && typeof vibeWordCloudChart.dispose === 'function') {
                        vibeWordCloudChart.dispose();
                    }
                    vibeWordCloudChart = echarts.init(container, 'dark', { renderer: 'canvas' });
                    vibeWordCloudChart.setOption({
                        backgroundColor: 'transparent',
                        series: [{
                            type: 'wordCloud',
                            shape: 'circle',
                            width: '100%',
                            height: '100%',
                            gridSize: 6,
                            sizeRange: [12, Math.max(22, Math.floor((container.clientWidth || 640) * 0.2))],
                            rotationRange: [0, 0], // ËÆæÁΩÆ‰∏∫ 0 ‰ª•ÊèêÈ´ò‰∏≠ÊñáÂ≠óÁ¨¶ÁöÑÈòÖËØªÊÄß
                            rotationStep: 0,
                            drawOutOfBound: false,
                            textStyle: { fontFamily: 'JetBrains Mono, monospace', color: '#A855F7' },
                            emphasis: { textStyle: { shadowBlur: 18, shadowColor: 'rgba(168,85,247,0.35)' } },
                            data: fallback_keywords,
                        }],
                    }, true);
                } catch (e) {
                    container.innerHTML = '<div class="text-zinc-500 text-sm p-4">ËØç‰∫ëÂä†ËΩΩÂ§±Ë¥•</div>';
                }
            }
        }
        
        // initWordCloud Âà´ÂêçÔºàÂÖºÂÆπÊóß‰ª£Á†ÅÔºâ
        const initWordCloud = loadWordCloud;
        window.initWordCloud = initWordCloud;
        window.loadWordCloud = loadWordCloud;

        // ==========================================
        // „ÄêV6.0 Êñ∞Â¢û„ÄëËØç‰∫ëÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
        // ==========================================

        /**
         * Â§ÑÁêÜËØç‰∫ëÁÇπÂáªÔºåËß¶ÂèëÂú∞ÂõæËÅîÂä®
         * @param {string} keyword - ÁÇπÂáªÁöÑÂÖ≥ÈîÆËØç
         * @param {string} category - ÂÖ≥ÈîÆËØçÂàÜÁ±ª
         */
        window.handleWordCloudClick = async function(keyword, category) {
            console.log('[WordCloud] ÁÇπÂáªËØç‰∫ë:', { keyword, category });

            const apiEndpoint = (document.querySelector('meta[name="api-endpoint"]')?.content || '').trim();
            const API_ENDPOINT = apiEndpoint.endsWith('/') ? apiEndpoint : `${apiEndpoint}/`;

            try {
                // Êü•ËØ¢ËØ•ÂÖ≥ÈîÆËØçÁöÑÂú∞ÁêÜÂàÜÂ∏É
                const resp = await fetch(`${API_ENDPOINT}api/v2/keyword-location?keyword=${encodeURIComponent(keyword)}`, {
                    cache: 'no-cache'
                });
                const json = await resp.json().catch(() => null);

                if (json && json.status === 'success' && json.data) {
                    // ÊòæÁ§∫ÂÖ≥ÈîÆËØçÂú∞ÁêÜÂàÜÂ∏ÉËØ¶ÊÉÖ
                    showKeywordDetails(keyword, category, json.data);
                } else {
                    // Ê≤°ÊúâÂú∞ÁêÜÊï∞ÊçÆÊó∂ÊòæÁ§∫ÁÆÄÂçïÊèêÁ§∫
                    showKeywordSimple(keyword, category);
                }
            } catch (error) {
                console.warn('[Frontend] ‚ö†Ô∏è ËØç‰∫ëÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜÂ§±Ë¥•:', error);
                showKeywordSimple(keyword, category);
            }
        };

        /**
         * ÊòæÁ§∫ÂÖ≥ÈîÆËØçËØ¶ÁªÜ‰ø°ÊÅØÔºàÊó†Âú∞ÁêÜÊï∞ÊçÆÊó∂ÁöÑÁÆÄÂåñÁâàÊú¨Ôºâ
         */
        function showKeywordSimple(keyword, category) {
            const categoryLabels = {
                'merit': 'ÂäüÂæ∑',
                'slang': 'ÈªëËØù',
                'sv_slang': 'Á°ÖË∞∑ÈªëËØù',
            };

            const catLabel = categoryLabels[category] || 'Êú™Áü•';

            // ‰ΩøÁî® existingAlert ÊàñÂàõÂª∫‰∏¥Êó∂ÊèêÁ§∫
            if (typeof existingAlert === 'function') {
                existingAlert(`ÂÖ≥ÈîÆËØç "${keyword}" (${catLabel})\nÂú∞ÁêÜÂàÜÂ∏ÉÊï∞ÊçÆÊöÇ‰∏çÂèØÁî®`, 'info');
            } else {
                alert(`ÂÖ≥ÈîÆËØç: ${keyword}\nÂàÜÁ±ª: ${catLabel}\n\nÂú∞ÁêÜÂàÜÂ∏ÉÂäüËÉΩÂºÄÂèë‰∏≠...`);
            }
        }

        /**
         * ÊòæÁ§∫ÂÖ≥ÈîÆËØçËØ¶ÁªÜ‰ø°ÊÅØÈù¢Êùø
         */
        function showKeywordDetails(keyword, category, locationData) {
            const countryPanel = document.getElementById('countryPanel');
            if (!countryPanel) return;

            // ÊåâÂá∫Áé∞È¢ëÁéáÊéíÂ∫è
            const sortedLocations = (locationData || [])
                .sort((a, b) => (b.count || 0) - (a.count || 0))
                .slice(0, 10);

            const categoryLabels = {
                'merit': 'ÂäüÂæ∑',
                'slang': 'ÈªëËØù',
                'sv_slang': 'Á°ÖË∞∑ÈªëËØù',
            };

            const catLabel = categoryLabels[category] || 'Êú™Áü•';

            const html = `
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="map-pin"></i>
                        <span class="card-title">ÂÖ≥ÈîÆËØçÂú∞ÁêÜÂàÜÂ∏É</span>
                    </div>
                    <div class="mb-4">
                        <div class="text-sm text-zinc-400 mb-2">ÂÖ≥ÈîÆËØç</div>
                        <div class="text-2xl font-bold ${category === 'merit' ? 'text-green-500' : 'text-purple-500'}">
                            ${keyword}
                        </div>
                        <div class="text-xs text-zinc-500 mt-1">
                            ÂàÜÁ±ªÔºö${catLabel}
                        </div>
                    </div>
                    <div>
                        <div class="text-sm text-zinc-400 mb-2">Top 10 Âú∞Âå∫</div>
                        ${sortedLocations.length > 0 ? `
                            <div class="space-y-2">
                                ${sortedLocations.map(item => `
                                    <div class="flex justify-between items-center bg-zinc-900 p-2 border border-zinc-800">
                                        <span class="text-sm">${item.location || 'Êú™Áü•'}</span>
                                        <span class="text-sm font-bold text-emerald-400">${item.count || 0} Ê¨°</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="text-zinc-500 text-sm">ÊöÇÊó†Âú∞ÁêÜÂàÜÂ∏ÉÊï∞ÊçÆ</div>'}
                    </div>
                </div>
            `;

            countryPanel.innerHTML = html;
            countryPanel.style.display = 'block';

            // Âà∑Êñ∞ Lucide ÂõæÊ†á
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // ==========================================
        // ËØ≠‰πâÁàÜÂèëÔºöÈùôÈªò‰∏äÊä•ÔºàDashboard/Áà∂È°µÈù¢ÂèØËß¶ÂèëÔºâ
        // ==========================================
        
        // ÂÖ≥ÈîÆËØçËØçÂÖ∏ÔºàÁî®‰∫éÂàÜÁ±ªÔºâ
        const MERIT_KEYWORDS = new Set(['ÈáçÊûÑ', '‰ºòÂåñ', '‰øÆÂ§ç', 'ÊîπËøõ', 'ÂÆåÂñÑ', 'ÊèêÂçá', 'Â¢ûÂº∫', 'Ë∞ÉÊï¥', 'Êõ¥Êñ∞', 'ÂçáÁ∫ß', 'ÂäüÂæ∑', 'Á¶èÊä•', 'ÁßØÂæ∑', 'ÂñÑ‰∏ö']);
        const SLANG_KEYWORDS = new Set(['Èó≠ÁéØ', 'È¢óÁ≤íÂ∫¶', 'ÂØπÈΩê', 'ÊäìÊâã', 'ËêΩÂú∞', 'Â§çÁõò', 'ÈìæË∑Ø', 'ÂÖúÂ∫ï', 'ËµãËÉΩ', 'ÈôçÁª¥', 'Êä§ÂüéÊ≤≥', 'ËµõÈÅì', 'ÊñπÊ≥ïËÆ∫', 'Â∫ïÂ±ÇÈÄªËæë', 'Êû∂ÊûÑËß£ËÄ¶']);
        
        /**
         * Ëá™Âä®ÂàÜÁ±ªÂÖ≥ÈîÆËØç
         * @param {string} phrase - ÂÖ≥ÈîÆËØç
         * @returns {'merit' | 'slang'}
         */
        function categorizeKeyword(phrase) {
            const normalized = String(phrase || '').trim();
            if (!normalized) return 'slang';
            
            // ÂåπÈÖç"ÈáçÊûÑ/‰ºòÂåñ/‰øÆÂ§ç"ÂΩí‰∏∫ merit
            if (MERIT_KEYWORDS.has(normalized)) {
                return 'merit';
            }
            
            // ÂåπÈÖç"Èó≠ÁéØ/È¢óÁ≤íÂ∫¶/ÂØπÈΩê"ÂΩí‰∏∫ slang
            if (SLANG_KEYWORDS.has(normalized)) {
                return 'slang';
            }
            
            // ÈªòËÆ§ÂΩí‰∏∫ slang
            return 'slang';
        }
        
        /**
         * ÊèêÂèñ Vibe ÂÖ≥ÈîÆËØçÔºàÂ∏¶ÂàÜÁ±ªÂíåÊùÉÈáçÔºâ
         * @param {string} text - ÊñáÊú¨ÂÜÖÂÆπ
         * @param {Object} options - ÈÄâÈ°π { max: number }
         * @returns {Array} - [{ phrase, category, weight }]
         */
        function extractVibeKeywords(text, { max = 5 } = {}) {
            const raw = String(text || '');
            if (!raw.trim()) return [];

            // 2-4 ‰∏™‰∏≠ÊñáÂ≠óÁ¨¶Êàñ 3-15 ‰∏™Ëã±ÊñáÂ≠óÁ¨¶
            const matches = raw.match(/[\u4e00-\u9fa5]{2,4}|[a-zA-Z]{3,15}/g) || [];

            // ÂÅúÁî®ËØçÔºàÊåâÈúÄÂèØÁªßÁª≠Êâ©Â±ïÔºâ
            const stopWords = new Set([
                'Ëøô‰∏™', 'ÂèØ‰ª•', 'ÂÆûÁé∞', 'ÈÄªËæë', 'ÂàÜÊûê', '‰ª£Á†Å', 'Êé•Âè£', 'Êä•Èîô', 'ÂºÇÂ∏∏', 'ÈîôËØØ', 'ËøîÂõû', 'ËØ∑Ê±Ç', 'Êï∞ÊçÆ',
                'ÂáΩÊï∞', 'ÂèòÈáè', 'ÂØπË±°', 'Êï∞ÁªÑ', 'Â≠óÁ¨¶‰∏≤', 'Êï∞Â≠ó', 'Á±ªÂûã', 'ÁªÑ‰ª∂', 'È°µÈù¢', 'ÂâçÁ´Ø', 'ÂêéÁ´Ø',
                'the', 'and', 'that', 'this', 'with', 'from', 'into', 'just', 'like', 'very',
            ]);

            const freq = new Map();
            for (const token of matches) {
                const t = String(token).trim();
                if (!t) continue;
                const normalized = /^[a-zA-Z]+$/.test(t) ? t.toLowerCase() : t;
                if (stopWords.has(normalized)) continue;
                if (normalized.length < 2) continue;
                freq.set(normalized, (freq.get(normalized) || 0) + 1);
            }

            // ËøîÂõûÂ∏¶ÂàÜÁ±ªÁöÑÂØπË±°Êï∞ÁªÑ
            return Array.from(freq.entries())
                .sort((a, b) => (b[1] - a[1]) || (a[0] > b[0] ? 1 : -1))
                .slice(0, Math.max(3, Math.min(5, Number(max) || 5)))
                .map(([phrase, count]) => ({
                    phrase,
                    category: categorizeKeyword(phrase),
                    weight: Math.max(1, Math.min(5, count)) // ÊùÉÈáçÔºöÈ¢ëÊ¨°‰∏äÈôê 5
                }));
        }

        async function reportSlangFromText(text, location) {
            try {
                const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || '';
                const API_ENDPOINT = apiEndpoint.trim().endsWith('/') ? apiEndpoint.trim() : `${apiEndpoint.trim()}/`;
                
                // Ëé∑ÂèñÁî®Êà∑ÊåáÁ∫π
                const fingerprint = (() => {
                    try {
                        return localStorage.getItem('user_fingerprint') || null;
                    } catch (e) {
                        return null;
                    }
                })();
                
                const keywords = extractVibeKeywords(text, { max: 5 });
                if (!keywords || keywords.length === 0) return;
                
                // ‰ΩøÁî®Êñ∞ÁâàÊé•Âè£ /api/v2/report-vibe
                const payload = {
                    keywords: keywords,
                    fingerprint: fingerprint || null,
                    timestamp: new Date().toISOString(),
                    region: location || 'Global',
                };
                
                // sendBeacon ÊúÄ‰∏çÊâìÊâ∞‰∏ªÁ∫øÁ®ã/È°µÈù¢Âç∏ËΩΩ
                if (typeof navigator !== 'undefined' && navigator && typeof navigator.sendBeacon === 'function') {
                    try {
                        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
                        navigator.sendBeacon(`${API_ENDPOINT}api/v2/report-vibe`, blob);
                        return;
                    } catch {
                        // fallthrough
                    }
                }
                
                // fetch keepalive ÂÖúÂ∫ï
                await fetch(`${API_ENDPOINT}api/v2/report-vibe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    keepalive: true,
                    body: JSON.stringify(payload),
                });
            } catch (e) {
                // ÈùôÈªòÂ§±Ë¥•
            }
        }

        // Ëß¶ÂèëÂÖ•Âè£1ÔºöÁà∂È°µÈù¢ postMessage ‰º†ÂÖ•ÂàÜÊûêÁªìÊûú
        // Á∫¶ÂÆöÊ∂àÊÅØÊ†ºÂºèÔºö{ type: 'VIBE_ANALYSIS_RESULT', text: string, location?: string }
        window.addEventListener('message', (event) => {
            try {
                const data = event?.data;
                if (!data || data.type !== 'VIBE_ANALYSIS_RESULT') return;
                const text = data.text || '';
                const location = data.location || 'GLOBAL';
                void reportSlangFromText(text, location);
            } catch (e) {
                // ignore
            }
        });

        // Ëß¶ÂèëÂÖ•Âè£2ÔºöÂΩìÂâçÈ°µÈù¢Ëã•Â≠òÂú® window.lastAnalysisText / window.lastAnalysisLocationÔºåÂèØÁõ¥Êé•Ë∞ÉÁî®
        window.reportSlangFromLastAnalysis = function () {
            try {
                const text = window.lastAnalysisText || '';
                const location = window.lastAnalysisLocation || 'GLOBAL';
                return reportSlangFromText(text, location);
            } catch (e) {
                return Promise.resolve();
            }
        };
        
        /**
         * ÂÖ®Â±ÄÂáΩÊï∞ÔºöÂà∑Êñ∞Áî®Êà∑Êï∞ÊçÆÔºà‰æõ index.html Ë∞ÉÁî®Ôºâ
         * ÂΩì index.html Êèê‰∫§ËÅäÂ§©ËÆ∞ÂΩïÂêéÔºåÂèØ‰ª•Ë∞ÉÁî®Ê≠§ÂáΩÊï∞Âà∑Êñ∞ stats2.html ÁöÑÊï∞ÊçÆ
         * „ÄêGitHub OAuth ‰ºòÂÖà„Äë‰ºòÂÖà‰ªé supabase.auth.getSession() ‰∏≠Ëé∑ÂèñÂΩìÂâçÁôªÂΩïÁî®Êà∑ÁöÑ ID
         * „Äê‰øÆÂ§ç AbortError„ÄëÊ∑ªÂä†Èò≤ÈáçÂ§çË∞ÉÁî®Êú∫Âà∂ÔºåÈÅøÂÖçÈ°µÈù¢Âà∑Êñ∞Êó∂Â§öÊ¨°Ë∞ÉÁî®ÂØºËá¥ÂÜ≤Á™Å
         */
        // Èò≤ÈáçÂ§çË∞ÉÁî®Ê†áÂøó
        let isRefreshingUserStats = false;
        let refreshUserStatsAbortController = null;
        
        window.refreshUserStats = async function() {
            // „Äê‰øÆÂ§ç AbortError„ÄëÂ¶ÇÊûúÊ≠£Âú®Âà∑Êñ∞ÔºåÂèñÊ∂à‰πãÂâçÁöÑËØ∑Ê±Ç
            if (isRefreshingUserStats) {
                console.log('[Refresh] ‚ö†Ô∏è Ê£ÄÊµãÂà∞ÈáçÂ§çË∞ÉÁî®ÔºåÂèñÊ∂à‰πãÂâçÁöÑÂà∑Êñ∞ËØ∑Ê±Ç...');
                if (refreshUserStatsAbortController) {
                    refreshUserStatsAbortController.abort();
                }
                // ÂèñÊ∂àÂêéÁõ¥Êé•ËøîÂõûÔºåÈÅøÂÖçÈáçÂ§çÊâßË°å
                return;
            }
            
            // ÂàõÂª∫Êñ∞ÁöÑ AbortController
            refreshUserStatsAbortController = new AbortController();
            isRefreshingUserStats = true;
            
            console.log('[Refresh] üîÑ Êî∂Âà∞Âà∑Êñ∞ËØ∑Ê±ÇÔºåÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ...');
            try {
                // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆÔºàÊ∑ªÂä† signal ÊîØÊåÅÂèñÊ∂àÔºâ
                // Ê≥®ÊÑèÔºöfetchData ÂèØËÉΩ‰∏çÊîØÊåÅ signalÔºåËøôÈáåÂÖàÂ∞ùËØïË∞ÉÁî®
                try {
                    await fetchData();
                } catch (fetchDataError) {
                    // Â¶ÇÊûúÊòØÂèñÊ∂àÈîôËØØÔºåÁõ¥Êé•ËøîÂõû
                    if (fetchDataError.name === 'AbortError' || fetchDataError.message?.includes('aborted')) {
                        console.log('[Refresh] ‚ÑπÔ∏è Êï∞ÊçÆËé∑ÂèñË¢´ÂèñÊ∂à');
                        return;
                    }
                    throw fetchDataError;
                }
                
                // Ê£ÄÊü•ÊòØÂê¶Â∑≤Ë¢´ÂèñÊ∂à
                if (refreshUserStatsAbortController?.signal.aborted) {
                    console.log('[Refresh] ‚ÑπÔ∏è Âà∑Êñ∞ËØ∑Ê±ÇÂ∑≤Ë¢´ÂèñÊ∂à');
                    return;
                }
                
                // „ÄêGitHub OAuth ‰ºòÂÖà„Äë‰ºòÂÖàÊ£ÄÊü•ÊòØÂê¶ÊúâÁôªÂΩï‰ºöËØù
                let currentUser = null;
                let matchedByGitHub = false;
                
                if (supabaseClient) {
                    try {
                        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                        
                        if (!sessionError && session && session.user) {
                            const githubUserId = session.user.id;
                            console.log('[Refresh] ‚úÖ Ê£ÄÊµãÂà∞ GitHub OAuth ‰ºöËØùÔºåuser_id:', githubUserId.substring(0, 8) + '...');
                            
                            // ‰ºòÂÖà‰ªé allData ‰∏≠Êü•Êâæ user_id ÂåπÈÖçÁöÑËÆ∞ÂΩï
                            const allData = window.allData || [];
                            currentUser = allData.find(user => user.id === githubUserId);
                            
                            if (currentUser) {
                                matchedByGitHub = true;
                                console.log('[Refresh] ‚úÖ ÈÄöËøá GitHub User ID ÊâæÂà∞Áî®Êà∑:', currentUser.user_name || currentUser.name);
                            } else {
                            // Â¶ÇÊûú allData ‰∏≠Ê≤°ÊúâÔºåÂ∞ùËØï‰ªé Supabase Áõ¥Êé•Êü•ËØ¢
                            // „ÄêTask 2„Äë‰ΩøÁî®Áªü‰∏ÄËßÜÂõæ v_unified_analysis_v2
                            console.log('[Refresh] üîç allData ‰∏≠Êú™ÊâæÂà∞ÔºåÂ∞ùËØï‰ªé Supabase Êü•ËØ¢Ôºà‰ΩøÁî®Áªü‰∏ÄËßÜÂõæÔºâ...');
                            const { data: dbUser, error: queryError } = await supabaseClient
                                .from('v_unified_analysis_v2')
                                .select('*')
                                .eq('id', githubUserId)
                                .maybeSingle();
                                
                                if (!queryError && dbUser) {
                                    currentUser = dbUser;
                                    matchedByGitHub = true;
                                    
                                    // Ê∑ªÂä†Âà∞ allData
                                    const existingIndex = allData.findIndex(item => item.id === githubUserId);
                                    if (existingIndex !== -1) {
                                        allData[existingIndex] = { ...allData[existingIndex], ...dbUser };
                                    } else {
                                        allData.push(dbUser);
                                    }
                                    window.allData = allData;
                                    
                                    console.log('[Refresh] ‚úÖ ‰ªé Supabase Êü•ËØ¢Âà∞Áî®Êà∑:', dbUser.user_name || dbUser.name);
                                }
                            }
                        }
                    } catch (authError) {
                        console.warn('[Refresh] ‚ö†Ô∏è Ê£ÄÊü• GitHub OAuth ‰ºöËØùÂ§±Ë¥•:', authError);
                    }
                }
                
                // „ÄêÈôçÁ∫ßÊñπÊ°à„ÄëÂ¶ÇÊûúÊ≤°Êúâ GitHub OAuth ‰ºöËØùÔºå‰ΩøÁî® fingerprint ÂåπÈÖç
                if (!currentUser) {
                    console.log('[Refresh] üîÑ Êú™ÊâæÂà∞ GitHub OAuth Áî®Êà∑ÔºåÂ∞ùËØï‰ΩøÁî® fingerprint ÂåπÈÖç...');
                    
                    const normalizeFingerprint = (fp) => {
                        if (!fp) return '';
                        return String(fp).trim().toLowerCase();
                    };
                    
                    let currentFingerprint = null;
                    try {
                        currentFingerprint = localStorage.getItem('user_fingerprint');
                    } catch (e) {
                        console.warn('[Refresh] ‚ö†Ô∏è ËØªÂèñ localStorage Â§±Ë¥•:', e);
                    }
                    
                    const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                    const allData = window.allData || [];
                    
                    if (normalizedCurrentFingerprint && allData.length > 0) {
                        currentUser = allData.find(user => {
                            const userFingerprint = normalizeFingerprint(user.fingerprint || user.user_fingerprint);
                            const userIdentity = normalizeFingerprint(user.user_identity);
                            return (userFingerprint && userFingerprint === normalizedCurrentFingerprint) ||
                                   (userIdentity && userIdentity === normalizedCurrentFingerprint);
                        });
                        
                        if (currentUser) {
                            console.log('[Refresh] ‚úÖ ÈÄöËøá fingerprint ÊâæÂà∞Áî®Êà∑:', currentUser.user_name || currentUser.name);
                            
                            // „ÄêMaster Key„Äë‰∏ÄÊó¶ÈÄöËøáÊåáÁ∫πÊâæÂà∞ÊúâÊï∞ÊçÆÁöÑÁî®Êà∑ÔºåÂ∞ÜÂÖ∂ÊåáÁ∫πÊ∞∏‰πÖÂ≠òÂÖ•Êú¨Âú∞
                            const totalMsgs = currentUser.total_messages || currentUser.stats?.total_messages || 0;
                            if (totalMsgs > 0 && currentUser.fingerprint) {
                                localStorage.setItem('last_successful_fingerprint', currentUser.fingerprint);
                                console.log('[Refresh] üîë Â∑≤ÂΩïÂÖ• Master Key:', currentUser.fingerprint.substring(0, 8) + '...');
                            }
                        }
                    }
                }
                
                if (currentUser) {
                    // „ÄêÁ´üÊÄÅ‰øÆÂ§ç„ÄëËã•Êú¨Âú∞Â∑≤ÈîÅÂÆöÊ†°ÂáÜÔºå‰ºòÂÖàÁî®Êú¨Âú∞ manual_* Ë¶ÜÁõñ API ËøîÂõûÔºåÈÅøÂÖçÊäΩÂ±âË¢´ IP ÂÆö‰ΩçË¶ÜÁõñÔºàlocalStorage ÂÖúÂ∫ïÔºåÈò≤Ê≠¢ currentUserData Ë¢´Âπ∂ÂèëÂà∑Êñ∞Ë¶ÜÁõñÔºâ
                    if (localStorage.getItem('loc_fixed') === 'true') {
                        const data = window.currentUserData;
                        const mlat = data?.manual_lat ?? (localStorage.getItem('manual_lat') ? Number(localStorage.getItem('manual_lat')) : undefined);
                        const mlng = data?.manual_lng ?? (localStorage.getItem('manual_lng') ? Number(localStorage.getItem('manual_lng')) : undefined);
                        const mloc = (data?.manual_location ?? currentUser.manual_location ?? (localStorage.getItem('manual_location') || '').trim()) || '';
                        if (mlat != null && !isNaN(mlat)) currentUser.manual_lat = mlat;
                        if (mlng != null && !isNaN(mlng)) currentUser.manual_lng = mlng;
                        if (mloc && String(mloc).trim() !== '') currentUser.manual_location = String(mloc).trim();
                        currentUser.country_code = currentUser.manual_location || currentUser.ip_location;
                    }
                    window.currentUser = currentUser;
                    window.currentUserData = currentUser;
                    window.currentUserMatchedByFingerprint = !matchedByGitHub; // Â¶ÇÊûúÈÄöËøá GitHub ÂåπÈÖçÔºåÂàôËÆæ‰∏∫ false
                    
                    // „ÄêMaster Key„ÄëÂ¶ÇÊûúÂΩìÂâçÁî®Êà∑ÊúâÊï∞ÊçÆ‰∏îÂ∑≤ËØÜÂà´ÔºåÁ°Æ‰øùÊåÅ‰πÖÂåñÂ≠òÂÇ®ÂÖ∂ÊåáÁ∫πÔºà‰Ωú‰∏∫‰∏áËÉΩÈí•ÂåôÔºâ
                    const totalMsgs = currentUser.total_messages || currentUser.stats?.total_messages || 0;
                    if (totalMsgs > 0 && currentUser.fingerprint) {
                        localStorage.setItem('last_successful_fingerprint', currentUser.fingerprint);
                    }
                    
                    // Âà∑Êñ∞ÊéíÂêçÂç°Áâá
                    renderRankCards(currentUser);
                    
                    // Â¶ÇÊûúÂ∑¶‰æßÊäΩÂ±âÂ∑≤ÊâìÂºÄÔºåÁî®ÂΩìÂâçÁî®Êà∑ÔºàÂ∑≤ÂêàÂπ∂Ê†°ÂáÜÔºâÂà∑Êñ∞ÔºõËã•Â∑≤ÈîÅÂÆöÊ†°ÂáÜÂàôÂº∫Âà∂ÊòæÁ§∫Ê†°ÂáÜÂõΩÂÆ∂ÔºåÈÅøÂÖçÁ´üÊÄÅÂØºËá¥ÂàáÂõû IP ÂÆö‰Ωç
                    const leftDrawer = document.getElementById('left-drawer');
                    const leftBody = document.getElementById('left-drawer-body');
                    if (leftDrawer && leftBody) {
                        const isDrawerOpen = leftDrawer.classList.contains('active');
                        if (isDrawerOpen) {
                            const drawerCode = (localStorage.getItem('loc_fixed') === 'true' && (currentUser.manual_location || currentUser.country_code))
                                ? (currentUser.manual_location || currentUser.country_code)
                                : currentDrawerCountry.code;
                            const drawerName = drawerCode && (typeof countryNameMap !== 'undefined' && countryNameMap[drawerCode])
                                ? (currentLang === 'zh' ? countryNameMap[drawerCode].zh : countryNameMap[drawerCode].en)
                                : (currentDrawerCountry.name || drawerCode);
                            if (drawerCode) showDrawersWithCountryData(drawerCode, drawerName || drawerCode);
                        }
                    }
                    
                    // „ÄêÂú∞ÂõæËÅîÂä®„Äë‰ºòÂÖà‰ΩøÁî® manual ÂùêÊ†áÔºåÂê¶ÂàôÁî® lat/lngÔºõÊúâÂùêÊ†áÂàôÊõ¥Êñ∞Âú∞Âõæ‰∏éÊåÅ‰πÖÂÖâÊ†á
                    const lat = (currentUser.manual_lat != null && !isNaN(currentUser.manual_lat))
                        ? Number(currentUser.manual_lat)
                        : (currentUser.lat != null && !isNaN(currentUser.lat) ? Number(currentUser.lat) : null);
                    const lng = (currentUser.manual_lng != null && !isNaN(currentUser.manual_lng))
                        ? Number(currentUser.manual_lng)
                        : (currentUser.lng != null && !isNaN(currentUser.lng) ? Number(currentUser.lng) : null);
                    if (lat !== null && lng !== null) {
                        console.log('[Refresh] üó∫Ô∏è Ê£ÄÊµãÂà∞Áî®Êà∑ÂùêÊ†áÔºà‰ºòÂÖà manualÔºâÔºåËß¶ÂèëÂú∞ÂõæËÅîÂä®:', { lat, lng });
                        try {
                            if (mapChart && typeof mapChart.setOption === 'function') {
                                const currentOption = mapChart.getOption();
                                if (currentOption && currentOption.geo && Array.isArray(currentOption.geo) && currentOption.geo.length > 0) {
                                    const updatedGeo = currentOption.geo.map(geo => ({
                                        ...geo,
                                        center: [lng, lat],
                                        zoom: 3
                                    }));
                                    mapChart.setOption({ geo: updatedGeo }, { notMerge: false, lazyUpdate: false });
                                    console.log('[Refresh] ‚úÖ Âú∞Âõæ‰∏≠ÂøÉÂ∑≤Êõ¥Êñ∞Âà∞Áî®Êà∑‰ΩçÁΩÆ');
                                }
                            }
                            if (typeof triggerMapPulse === 'function') {
                                const githubUsername = currentUser.user_name || currentUser.name || 'YOU';
                                const avatarUrl = currentUser.user_metadata?.avatar_url ||
                                    (githubUsername ? getGitHubAvatarUrl(githubUsername) : null) || DEFAULT_AVATAR;
                                const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                                const pulseColor = statusConfig.status_color || '#00ff41';
                                triggerMapPulse(lng, lat, 'YOU', pulseColor, avatarUrl, githubUsername);
                                console.log('[Refresh] ‚úÖ Âú∞ÂõæËÑâÂÜ≤ÊïàÊûúÂ∑≤Ëß¶Âèë');
                            }
                        } catch (mapError) {
                            console.warn('[Refresh] ‚ö†Ô∏è Âú∞ÂõæËÅîÂä®Â§±Ë¥•:', mapError);
                        }
                    } else {
                        console.log('[Refresh] ‚ÑπÔ∏è Áî®Êà∑ÂùêÊ†á‰∏çÂÆåÊï¥ÔºåË∑≥ËøáÂú∞ÂõæËÅîÂä®');
                    }
                    
                    console.log('[Refresh] ‚úÖ Áî®Êà∑Êï∞ÊçÆÂ∑≤Âà∑Êñ∞', matchedByGitHub ? '(GitHub OAuth)' : '(Fingerprint)');
                } else {
                    console.log('[Refresh] ‚ö†Ô∏è Êú™ÊâæÂà∞ÂΩìÂâçÁî®Êà∑Êï∞ÊçÆ');
                }
            } catch (error) {
                // „Äê‰øÆÂ§ç AbortError„ÄëÁâπÊÆäÂ§ÑÁêÜ AbortError
                if (error.name === 'AbortError' || error.message?.includes('aborted')) {
                    console.log('[Refresh] ‚ÑπÔ∏è Âà∑Êñ∞ËØ∑Ê±ÇË¢´ÂèñÊ∂àÔºàÂèØËÉΩÊòØÈ°µÈù¢Âà∑Êñ∞ÂØºËá¥Ôºâ');
                } else {
                    console.error('[Refresh] ‚ùå Âà∑Êñ∞Â§±Ë¥•:', error);
                }
            } finally {
                // ÈáçÁΩÆÊ†áÂøó
                isRefreshingUserStats = false;
                refreshUserStatsAbortController = null;
            }
        };
        
        // ÁõëÂê¨ storage ‰∫ã‰ª∂ÔºåÂΩìÂÖ∂‰ªñÈ°µÈù¢Êõ¥Êñ∞ localStorage Êó∂Ëá™Âä®Âà∑Êñ∞
        window.addEventListener('storage', (e) => {
            if (e.key === 'user_fingerprint' || e.key === 'github_username') {
                console.log('[Storage] üîî Ê£ÄÊµãÂà∞ localStorage ÂèòÂåñÔºåËß¶ÂèëÊï∞ÊçÆÂà∑Êñ∞');
                setTimeout(() => {
                    window.refreshUserStats();
                }, 500);
            }
        });

        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ Realtime ÁõëÂê¨
        window.addEventListener('beforeunload', () => {
            stopRealtimeListener();
        });
    </script>
</body>
</html>
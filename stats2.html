<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Statistics Dashboard - Vibe Coding</title>
    <!-- API Endpoint -->
    <meta name="api-endpoint" content="https://cursor-clinical-analysis.psterman.workers.dev/">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/map/js/world.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --bg-color: #050505;
            --card-bg: rgba(24, 24, 27, 0.7);
            --card-border: #27272a;
            --text-main: #ffffff;
            --text-dim: #71717a;
            --accent-terminal: #00ff41;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 65, 0.02) 2px,
                    rgba(0, 255, 65, 0.02) 4px
                ),
                radial-gradient(
                    circle,
                    rgba(0, 255, 65, 0.03) 1px,
                    transparent 1px
                );
            background-size: 100% 4px, 20px 20px;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(0, 255, 65, 0.05) 50%,
                transparent 100%
            );
            animation: scanline 8s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .hacker-border {
            border: 1px solid var(--card-border);
            position: relative;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
        }

        .hacker-border::before {
            content: '';
            position: absolute;
            top: -1px; left: 0; width: 60px; height: 1px;
            background: var(--accent-terminal);
            box-shadow: 0 0 10px var(--accent-terminal);
        }

        #map-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: auto;
            background: transparent;
        }

        /* ç¡®ä¿ä¸»å®¹å™¨å…è®¸ç©¿é€ï¼Œä½†äº¤äº’å…ƒç´ å¯ç‚¹å‡» */
        .max-w-\[1600px\] {
            pointer-events: none;
        }

        /* æ‰€æœ‰å¯äº¤äº’å…ƒç´ æ¢å¤ pointer-events */
        .max-w-\[1600px\] button,
        .max-w-\[1600px\] input,
        .max-w-\[1600px\] select,
        .max-w-\[1600px\] textarea,
        .max-w-\[1600px\] a,
        .max-w-\[1600px\] [onclick],
        .max-w-\[1600px\] .stat-card,
        .max-w-\[1600px\] .hacker-border,
        .max-w-\[1600px\] canvas,
        .max-w-\[1600px\] #rank-cards-container,
        .max-w-\[1600px\] #rank-cards-container > *,
        .max-w-\[1600px\] .lang-flag-btn,
        .max-w-\[1600px\] img[onerror] {
            pointer-events: auto;
        }

        /* =========================
           é¡¶éƒ¨å›ºå®š Header æ ·å¼
           ========================= */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50; /* åœ¨åœ°å›¾(z-index: 0)ä¹‹ä¸Šï¼Œä½†ä½äºæŠ½å±‰(z-index: 100) */
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
            pointer-events: auto; /* ç¡®ä¿å¯ä»¥ç‚¹å‡» */
        }

        .top-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .top-header-title {
            display: flex;
            flex-direction: column;
        }

        .top-header-title h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 900;
            letter-spacing: -0.02em;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .top-header-title p {
            margin: 4px 0 0 0;
            font-size: 9px;
            color: #71717a;
            letter-spacing: 0.3em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .top-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .top-header-cards {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .top-header {
                padding: 8px 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .top-header-left {
                width: 100%;
            }

            .top-header-right {
                width: 100%;
                justify-content: space-between;
            }

            .top-header-title h1 {
                font-size: 18px;
            }

            .top-header-title p {
                font-size: 8px;
            }

            .top-header-card {
                padding: 6px 10px;
            }

            .top-header-card-label {
                font-size: 8px;
            }

            .top-header-card-value {
                font-size: 10px;
            }

            body.p-4 {
                padding-top: 140px !important;
            }
        }

        .top-header-card {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 65, 0.2);
            border-radius: 4px;
            padding: 8px 12px;
            backdrop-filter: blur(10px);
        }

        .top-header-card-label {
            font-size: 9px;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .top-header-card-value {
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ä¸º body æ·»åŠ é¡¶éƒ¨ paddingï¼Œé¿å…å†…å®¹è¢« header é®æŒ¡ */
        body.p-4 {
            padding-top: 100px !important;
        }
        
        @media (min-width: 768px) {
            body.md\:p-8 {
                padding-top: 120px !important;
            }
        }

        /* =========================
           èµ›åšæœ‹å…‹æŠ½å±‰æ ·å¼
           ========================= */
        .cyber-drawer {
            position: fixed;
            top: 60px; /* åœ¨é¡¶éƒ¨ header ä¸‹æ–¹ï¼Œä¸é®ç›– header */
            width: 400px;
            height: calc(100vh - 60px); /* å‡å» header é«˜åº¦ */
            z-index: 100; /* é«˜äºé¡¶éƒ¨ header (z-index: 50) */
            pointer-events: none;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .left-drawer {
            left: 0;
            transform: translateX(-100%);
        }

        .right-drawer {
            right: 0;
            transform: translateX(100%);
        }

        @media (max-width: 768px) {
            .cyber-drawer {
                top: 140px; /* ç§»åŠ¨ç«¯ header æ›´é«˜ */
                height: calc(100vh - 140px);
            }
        }

        .left-drawer.active {
            transform: translateX(0);
            pointer-events: auto;
        }

        .right-drawer.active {
            transform: translateX(0);
            pointer-events: auto;
        }

        .drawer-content {
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 5, 0.85);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0, 255, 65, 0.3);
            border-left: 1px solid rgba(0, 255, 65, 0.3);
            box-shadow: 
                0 0 30px rgba(0, 255, 65, 0.2),
                inset 0 0 50px rgba(0, 255, 65, 0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .right-drawer .drawer-content {
            border-right: none;
            border-left: 1px solid rgba(0, 255, 65, 0.3);
        }

        .left-drawer .drawer-content {
            border-left: none;
            border-right: 1px solid rgba(0, 255, 65, 0.3);
        }

        /* èµ›åšæœ‹å…‹æ‰«æçº¿æ•ˆæœ */
        .drawer-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(0, 255, 65, 0.8),
                transparent
            );
            animation: drawer-scanline 3s linear infinite;
            z-index: 1;
        }

        @keyframes drawer-scanline {
            0% { transform: translateY(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }

        /* æŠ½å±‰å¤´éƒ¨ */
        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 255, 65, 0.05);
            position: relative;
            z-index: 2;
        }

        .drawer-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .drawer-icon {
            font-size: 20px;
            filter: drop-shadow(0 0 5px rgba(0, 255, 65, 0.8));
        }

        .drawer-title-text {
            font-size: 16px;
            font-weight: bold;
            color: #00ff41;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .drawer-close-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0, 255, 65, 0.3);
            color: #00ff41;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            font-weight: bold;
            background: rgba(0, 255, 65, 0.1);
        }

        .drawer-close-btn:hover {
            background: rgba(0, 255, 65, 0.3);
            border-color: #00ff41;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
            transform: scale(1.1);
        }

        /* æŠ½å±‰å†…å®¹åŒºåŸŸ */
        .drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .drawer-body::-webkit-scrollbar {
            width: 6px;
        }

        .drawer-body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        .drawer-body::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.3);
            border-radius: 3px;
        }

        .drawer-body::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 65, 0.5);
        }

        /* æŠ½å±‰å†…å®¹é¡¹æ ·å¼ */
        .drawer-item {
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid rgba(0, 255, 65, 0.2);
            border-radius: 4px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .drawer-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(0, 255, 65, 0.1),
                transparent
            );
            transition: left 0.5s;
        }

        .drawer-item:hover {
            border-color: rgba(0, 255, 65, 0.5);
            background: rgba(0, 255, 65, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }

        .drawer-item:hover::before {
            left: 100%;
        }

        .drawer-item-label {
            font-size: 11px;
            color: rgba(0, 255, 65, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .drawer-item-value {
            font-size: 18px;
            color: #00ff41;
            font-weight: bold;
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .drawer-item-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .cyber-drawer {
                width: 100%;
            }
        }

        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            border-color: var(--accent-terminal);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
        }

        /* =========================
           Language Switch (Flags)
           ========================= */
        .lang-flag-btn {
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            opacity: 0.6;
            transform: scale(1);
            box-shadow: none;
            overflow: hidden;
        }

        .lang-flag-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
            transition: all 0.4s ease;
            padding: 2px;
            outline: none;
            border: none;
            box-shadow: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .lang-flag-btn.active {
            opacity: 1;
            border: 3px solid var(--accent-terminal);
            box-shadow: 0 0 16px rgba(0, 255, 65, 0.6), 0 0 32px rgba(0, 255, 65, 0.3), inset 0 0 20px rgba(0, 255, 65, 0.1);
            transform: scale(1.1);
        }

        .lang-flag-btn:hover:not(.active) {
            opacity: 0.9;
            transform: scale(1.15);
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .lang-flag-btn:hover.active {
            /* é€‰ä¸­çŠ¶æ€ï¼šä¿æŒ 3px ç²—è¾¹æ¡†ï¼Œåªæ”¹å˜ç¼©æ”¾å’Œé˜´å½± */
            border: 3px solid var(--accent-terminal);
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.8), 0 0 40px rgba(0, 255, 65, 0.4), inset 0 0 25px rgba(0, 255, 65, 0.15);
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.25s ease;
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse { animation: pulse-soft 2s infinite; }

        /* åœ¨çº¿äººæ•°æ•°å­—æ›´æ–°æ—¶çš„ç¼©æ”¾åŠ¨ç”» */
        @keyframes scale-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .online-count-update {
            animation: scale-bounce 0.4s ease-out;
        }

        /* =========================
           Cyberpunk Loading Effects
           ========================= */
        @keyframes skeleton-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* æµå…‰éª¨æ¶å±ï¼šç”¨äºæ•°å­—å ä½ï¼ˆä¸»é¢˜è‰²ç»¿+è“ï¼‰ */
        .skeleton {
            position: relative;
            color: transparent !important;
            user-select: none;
            border-radius: 2px;
            background: linear-gradient(
                90deg,
                rgba(39, 39, 42, 0.25) 0%,
                rgba(0, 255, 65, 0.18) 40%,
                rgba(59, 130, 246, 0.14) 55%,
                rgba(39, 39, 42, 0.25) 100%
            );
            background-size: 240% 100%;
            animation: skeleton-shimmer 1.2s ease-in-out infinite;
            box-shadow: 0 0 18px rgba(0, 255, 65, 0.06);
        }

        /* éª¨æ¶å±æœŸé—´ä¿æŒå¸ƒå±€é«˜åº¦ç¨³å®š */
        #totalUsers.skeleton,
        #totalAnalysis.skeleton,
        #totalChars.skeleton {
            min-height: 2.5rem;
        }
        #avgPerUser.skeleton,
        #avgPerScan.skeleton,
        #systemDays.skeleton,
        #cityCount.skeleton {
            min-height: 1.6rem;
        }

        @keyframes scan-sweep {
            0% { transform: translateY(-120%); opacity: 0; }
            10% { opacity: 0.9; }
            90% { opacity: 0.9; }
            100% { transform: translateY(120%); opacity: 0; }
        }

        /* å…¨å±æ‰«æçº¿ï¼šåŠ è½½æœŸé—´å åŠ  */
        .scan-line {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 40;
            opacity: 0;
            mix-blend-mode: screen;
        }
        .scan-line::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 18vh;
            top: -20vh;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(0, 255, 65, 0.14) 45%,
                rgba(59, 130, 246, 0.10) 60%,
                transparent 100%
            );
            filter: blur(1px);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.12);
            animation: scan-sweep 1.6s linear infinite;
        }
        .scan-line.active {
            opacity: 1;
        }
        
        /* ç¡®ä¿å†…å®¹åœ¨èƒŒæ™¯åŠ¨ç”»ä¹‹ä¸Š */
        body > div {
            position: relative;
            z-index: 10;
        }
        
        /* çŠ¶æ€æŒ‰é’®æ¿€æ´»æ ·å¼ */
        .status-btn.active {
            border-width: 2px;
            box-shadow: 0 0 10px currentColor;
        }
        
        /* ç”¨æˆ·åˆ—è¡¨é¡¹æ ·å¼ */
        .user-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .user-item:hover {
            background: rgba(39, 39, 42, 0.5);
            border-color: var(--card-border);
        }
        
        /* å¤´åƒå‘¼å¸ç¯è¾¹æ¡† */
        .avatar-pulse {
            position: relative;
            border-radius: 50%;
            padding: 2px;
        }
        
        .avatar-pulse::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            border: 2px solid currentColor;
            opacity: 0.6;
            animation: pulse-border 2s ease-in-out infinite;
        }
        
        @keyframes pulse-border {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        /* ç§ä¿¡æµ®çª—æ ·å¼ */
        .message-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border: 2px solid var(--accent-terminal);
            border-radius: 8px;
            padding: 20px;
            min-width: 300px;
            max-width: 500px;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
            animation: popup-appear 0.3s ease-out;
        }
        
        @keyframes popup-appear {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .message-popup.destroying {
            animation: popup-destroy 0.5s ease-out forwards;
        }
        
        @keyframes popup-destroy {
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }
        
        /* ç§ä¿¡è¾“å…¥æ¡†æ ·å¼ */
        .message-input-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .message-input-box {
            background: var(--card-bg);
            border: 2px solid var(--accent-terminal);
            border-radius: 8px;
            padding: 20px;
            min-width: 400px;
            z-index: 1000;
        }
        
        /* æ‚¬æµ®æŠ½å±‰å¼åˆ—è¡¨æ ·å¼ */
        .live-nodes-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .live-nodes-drawer.collapsed {
            transform: translateY(calc(100% - 48px));
        }
        
        .live-nodes-drawer.expanded {
            transform: translateY(0);
        }
        
        .live-nodes-header {
            background: rgba(24, 24, 27, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 2px solid var(--accent-terminal);
            box-shadow: 0 -4px 20px rgba(0, 255, 65, 0.2);
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        
        .live-nodes-header:hover {
            background: rgba(24, 24, 27, 0.95);
            box-shadow: 0 -4px 30px rgba(0, 255, 65, 0.3);
        }
        
        .live-nodes-content {
            background: rgba(24, 24, 27, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(0, 255, 65, 0.2);
            max-height: 400px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        #online-users-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .live-nodes-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .live-nodes-content::-webkit-scrollbar-track {
            background: rgba(39, 39, 42, 0.5);
        }
        
        .live-nodes-content::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.3);
            border-radius: 3px;
        }
        
        .live-nodes-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 65, 0.5);
        }
        
        .chevron-icon {
            transition: transform 0.3s ease;
        }
        
        .live-nodes-drawer.expanded .chevron-icon {
            transform: rotate(180deg);
        }
        
        .user-item-verified {
            border-left: 2px solid var(--accent-terminal);
        }
        
        .user-item-anonymous {
            opacity: 0.7;
        }
        
        .github-link-icon {
            width: 14px;
            height: 14px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        
        .user-item:hover .github-link-icon {
            opacity: 1;
        }

        /* LPDEF å¡ç‰‡åŠ¨ç”» */
        @keyframes lpdef-scan {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
            50% {
                box-shadow: 0 0 20px 5px rgba(0, 255, 65, 0.5);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
        }

        @keyframes lpdef-flash {
            0%, 100% { opacity: 1; }
            25% { opacity: 0.3; }
            50% { opacity: 0.6; }
            75% { opacity: 0.3; }
        }

        .lpdef-card.scanning {
            animation: lpdef-scan 1.5s ease-in-out;
        }

        .lpdef-card.recalculating {
            animation: lpdef-flash 0.8s ease-in-out;
        }

        .lpdef-card.recalculating::after {
            content: 'æ•°æ®é‡ç®—...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: var(--accent-terminal);
            padding: 8px 16px;
            border: 1px solid var(--accent-terminal);
            font-size: 10px;
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
        }

        /* LPDEF å®¹å™¨æ‰«æåŠ¨ç”» */
        @keyframes lpdef-container-scan {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
            50% {
                box-shadow: 0 0 30px 10px rgba(0, 255, 65, 0.6);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
        }

        #lpdef-container.lpdef-scan {
            animation: lpdef-container-scan 1.5s ease-in-out;
        }

        /* å…‰æ¡æ‰«ææ•ˆæœ */
        @keyframes lpdef-light-sweep {
            0% {
                background-position: -100% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        #lpdef-container.lpdef-scan::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(0, 255, 65, 0.3) 50%,
                transparent 100%
            );
            background-size: 200% 100%;
            animation: lpdef-light-sweep 1.5s ease-in-out;
            pointer-events: none;
            z-index: 1;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- é¡¶éƒ¨å›ºå®š Header -->
    <div class="top-header">
        <div class="top-header-left">
            <div class="top-header-title">
                <h1>
                    <span class="text-white">GLOBAL</span>
                    <span class="text-[var(--accent-terminal)]">DATA_STATION</span>
                </h1>
                <p id="sub-title">Telemetry Uplink: Active // Source: Central_Pacific</p>
            </div>
        </div>
        
        <div class="top-header-right">
            <!-- æ´»è·ƒèŠ‚ç‚¹å¡ç‰‡ -->
            <div class="top-header-card">
                <div class="top-header-card-label lang-key" data-key="active-nodes">æ´»è·ƒèŠ‚ç‚¹</div>
                <div class="top-header-card-value text-emerald-400">
                    <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full pulse"></span>
                    <span id="online-count-value">0</span> CONNECTED
                </div>
            </div>
            
            <!-- é£é™©è¯„çº§å¡ç‰‡ -->
            <div class="top-header-card">
                <div class="top-header-card-label lang-key" data-key="threat-level">é£é™©è¯„çº§</div>
                <div class="top-header-card-value text-red-500">LEVEL_CRITICAL</div>
            </div>
            
            <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
            <div class="flex gap-2 items-center">
                <button onclick="switchLang('zh')" id="btn-zh" class="lang-flag-btn active" title="ä¸­æ–‡">
                    <img src="images/zh.png" alt="ä¸­æ–‡" />
                </button>
                <button onclick="switchLang('en')" id="btn-en" class="lang-flag-btn" title="English">
                    <img src="images/us.png" alt="English" />
                </button>
            </div>
        </div>
    </div>
    
    <!-- å…¨å±åœ°å›¾èƒŒæ™¯ -->
    <div id="map-container"></div>
    
    <!-- å·¦å³èµ›åšæœ‹å…‹æŠ½å±‰ -->
    <div id="left-drawer" class="cyber-drawer left-drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <div class="drawer-title">
                    <span class="drawer-icon">âš¡</span>
                    <span class="drawer-title-text" id="left-drawer-title">å›½å®¶æ•°æ®</span>
                </div>
                <div class="drawer-close-btn" onclick="closeDrawers()">âœ•</div>
            </div>
            <div class="drawer-body" id="left-drawer-body">
                <!-- å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </div>
    
    <div id="right-drawer" class="cyber-drawer right-drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <div class="drawer-title">
                    <span class="drawer-icon">ğŸ”</span>
                    <span class="drawer-title-text" id="right-drawer-title">è¯¦ç»†ä¿¡æ¯</span>
                </div>
                <div class="drawer-close-btn" onclick="closeDrawers()">âœ•</div>
            </div>
            <div class="drawer-body" id="right-drawer-body">
                <!-- å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </div>
    
    <div id="scanLine" class="scan-line" aria-hidden="true"></div>
    <div class="max-w-[1600px] mx-auto relative z-10">
        <!-- Main Dashboard Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
            
            <!-- Side Panel: Core Metrics (å·¦ä¾§) - å·²ç§»è‡³æŠ½å±‰ï¼Œéšè— -->
            <div class="xl:col-span-3 flex flex-col gap-4 order-2 xl:order-1 items-start" style="display: none;">
                <!-- ç»Ÿè®¡å¡ç‰‡å·²ç§»è‡³å³è¾¹æŠ½å±‰ï¼Œéšè—åŸå®¹å™¨ -->
                <div class="hacker-border p-6 rounded-sm stat-card" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-victims">å·²è¯Šæ–­å¼€å‘è€…</div>
                    <div id="totalUsers" class="text-4xl font-bold text-[var(--accent-terminal)]">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">USERS_RECOGNIZED_SUCCESSFULLY</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-analysis">å…¨ç½‘æ‰«ææ¬¡æ•°</div>
                    <div id="totalAnalysis" class="text-4xl font-bold">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">TOTAL_SCAN_COUNT</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-roast">ç´¯è®¡åæ§½å­—æ•°</div>
                    <div id="totalChars" class="text-4xl font-bold">0</div>
                    <div class="mt-4 h-1 bg-zinc-800 w-full overflow-hidden">
                        <div class="bg-[var(--accent-terminal)] h-full w-[65%]"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 stat-card" style="display: none;">
                    <div class="hacker-border p-4 rounded-sm bg-zinc-900/50">
                        <div class="text-zinc-500 text-[10px] uppercase tracking-tighter mb-1">Avg Words / äººå‡å¹³å‡ç¯‡å¹…</div>
                        <div id="avgPerUser" class="text-2xl font-bold font-mono text-[var(--accent-terminal)]">0</div>
                        <div class="text-[9px] text-zinc-600 mt-1 uppercase">Per Developer Basis</div>
                    </div>
                    
                    <div class="hacker-border p-4 rounded-sm bg-zinc-900/50">
                        <div class="text-zinc-500 text-[10px] uppercase tracking-tighter mb-1">Scan Words / å•æ¬¡å¹³å‡ç¯‡å¹…</div>
                        <div id="avgPerScan" class="text-2xl font-bold font-mono text-blue-400">0</div>
                        <div class="text-[9px] text-zinc-600 mt-1 uppercase">Per Analysis Basis</div>
                    </div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card bg-zinc-900/40" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-4 uppercase tracking-widest lang-key" data-key="radar-title">å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒ</div>
                    <div class="aspect-square">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Central Map Area (ä¸­é—´) - åœ°å›¾å·²ç§»è‡³å…¨å±èƒŒæ™¯ï¼Œæ­¤åŒºåŸŸå·²ç§»é™¤ -->
            <!-- ç»´åº¦æ’åå¡ç‰‡å®¹å™¨ï¼šå·²ç§»è‡³æŠ½å±‰æ˜¾ç¤º -->
            <div id="rank-cards-container" style="display: none;">
                <!-- å¡ç‰‡å·²ç§»è‡³æŠ½å±‰æ˜¾ç¤º -->
            </div>
        </div>

        <!-- Secondary Charts & Logs (å³ä¾§) - å·²ç§»è‡³æŠ½å±‰ï¼Œéšè—åŸå®¹å™¨ -->
        <div class="xl:col-span-3 grid grid-cols-1 gap-6 mt-6 items-start" style="display: none;">
            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="hot-list">åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ</h3>
                <div id="locationList" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="personality-dist">äººæ ¼åˆ†å¸ƒæ’è¡Œ</h3>
                <div id="personalityDistribution" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm flex flex-col">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="recent-activity">å®æ—¶è¯Šæ–­æ´»åŠ¨</h3>
                <div id="recentActivity" class="flex-1 overflow-y-auto max-h-[300px] text-[10px] font-mono space-y-4 pr-2">
                    <!-- Logs here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ‚¬æµ®æŠ½å±‰å¼åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
    <div id="live-nodes-drawer" class="live-nodes-drawer expanded">
        <div class="live-nodes-header" onclick="toggleDrawer()">
            <div class="flex items-center gap-3">
                <span class="text-[10px] text-zinc-500 uppercase tracking-widest lang-key" data-key="active-nodes">Live Nodes</span>
                <span id="online-count-badge" class="w-2 h-2 bg-[var(--accent-terminal)] rounded-full pulse"></span>
                <span id="online-count-text" class="text-xs font-bold text-[var(--accent-terminal)]">0</span>
            </div>
            <svg class="chevron-icon w-4 h-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
        <div class="live-nodes-content">
            <div id="online-users-list" class="p-4 space-y-2">
                <div class="text-zinc-500 text-center py-4 text-[10px]">Scanning for nearby nodes...</div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ã€v4.0 ç¤ºä¾‹ã€‘VibeCodingerAnalyzer å…¨çƒå„å›½æ•°æ®åˆ‡æ¢ç¤ºä¾‹
        // ==========================================
        /**
         * ç¤ºä¾‹ï¼šå¦‚ä½•ä½¿ç”¨é‡æ„åçš„ VibeCodingerAnalyzer å¤„ç†å…¨çƒ260å›½æ•°æ®
         * 
         * æ ¸å¿ƒåŠŸèƒ½ï¼š
         * 1. å…ƒæ•°æ®é©±åŠ¨ï¼šåŠ¨æ€ç»´åº¦è¯†åˆ«ï¼Œæ”¯æŒ40+ç»´åº¦
         * 2. å®¹å·®å¯¹æ¯”ï¼šå½±å­è°ƒç”¨ä½¿ç”¨Â±5%å®¹å·®
         * 3. å›½å®¶ä¸Šä¸‹æ–‡ï¼šè‡ªåŠ¨è®¡ç®—ä¸ªäººå¾—åˆ†ä¸å›½å®¶å¹³å‡åˆ†çš„åç¦»åº¦
         * 4. æ€§èƒ½ä¼˜åŒ–ï¼šå¹¶å‘é”ã€5ç§’è¶…æ—¶ä¿æŠ¤
         * 5. V6 Statså¯¹æ¥ï¼šå®Œæ•´è§£ætech_stackã€ketao_countç­‰
         */
        
        // ç¤ºä¾‹ï¼šåˆå§‹åŒ–åˆ†æå™¨å¹¶åˆ‡æ¢å›½å®¶ä¸Šä¸‹æ–‡
        async function exampleGlobalCountrySwitching() {
            // 1. å¯¼å…¥åˆ†æå™¨ï¼ˆå‡è®¾å·²é€šè¿‡ESæ¨¡å—å¯¼å…¥ï¼‰
            // import { VibeCodingerAnalyzer } from './src/VibeCodingerAnalyzer.js';
            
            // 2. åˆ›å»ºåˆ†æå™¨å®ä¾‹ï¼ˆæ”¯æŒåŠ¨æ€ç»´åº¦é…ç½®ï¼‰
            const analyzer = new VibeCodingerAnalyzer('zh-CN', {
                // å¯é€‰ï¼šå¦‚æœå·²çŸ¥ç»´åº¦é…ç½®ï¼Œå¯ä»¥é¢„å…ˆä¼ å…¥
                // keys: ['L', 'P', 'D', 'E', 'F', 'G', 'H', ...], // 40+ç»´åº¦
                // metadata: { ... }
            });
            
            // 3. æ¨¡æ‹ŸèŠå¤©æ•°æ®
            const chatData = [
                { role: 'USER', text: 'å¸®æˆ‘å†™ä¸€ä¸ªReactç»„ä»¶ï¼Œä½¿ç”¨TypeScriptå’ŒTailwind CSS' },
                { role: 'ASSISTANT', text: 'å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ ...' },
                { role: 'USER', text: 'è°¢è°¢ï¼Œè¿™ä¸ªå®ç°å¾ˆæ£’ï¼' }
            ];
            
            // 4. å…¨çƒ260å›½æ•°æ®åˆ‡æ¢ç¤ºä¾‹
            const countries = [
                { code: 'US', name: 'United States' },
                { code: 'CN', name: 'China' },
                { code: 'JP', name: 'Japan' },
                { code: 'GB', name: 'United Kingdom' },
                { code: 'DE', name: 'Germany' },
                // ... æ›´å¤šå›½å®¶
            ];
            
            // éå†å„å›½è¿›è¡Œåˆ†æ
            for (const country of countries) {
                try {
                    console.log(`[Example] åˆ†æ ${country.name} (${country.code}) çš„æ•°æ®...`);
                    
                    // 4.1 è®¾ç½®å›½å®¶ä¸Šä¸‹æ–‡ï¼ˆä»åç«¯APIè·å–å›½å®¶å¹³å‡å€¼ï¼‰
                    const countryAverage = await fetchCountryAverage(country.code);
                    analyzer.setCountryContext(country.code, countryAverage, {
                        countryName: country.name,
                        region: getRegionByCountryCode(country.code)
                    });
                    
                    // 4.2 æ‰§è¡Œåˆ†æï¼ˆè‡ªåŠ¨è®¡ç®—åç¦»åº¦ï¼‰
                    const result = await analyzer.analyze(chatData, 'zh-CN');
                    
                    // 4.3 å¤„ç†åˆ†æç»“æœ
                    console.log(`[Example] ${country.name} åˆ†æç»“æœ:`, {
                        dimensions: result.dimensions,
                        personalityType: result.personalityType,
                        deviationFromCountry: result.deviationFromCountry, // ã€v4.0æ–°å¢ã€‘åç¦»åº¦
                        countryAverage: result.countryAverage, // ã€v4.0æ–°å¢ã€‘å›½å®¶å¹³å‡åˆ†
                        stats: result.statistics, // ã€v4.0 V6 Statsã€‘åŒ…å«tech_stackã€ketao_countç­‰
                        hasRageWord: result.metadata?.hasRageWord // ã€v4.0æ–°å¢ã€‘å’†å“®è¯æ£€æµ‹
                    });
                    
                    // 4.4 ä¸Šä¼ æ’åå¹¶è·å–å…¨çƒæ’å
                    const rankData = await analyzer.uploadToSupabase(result, chatData, (progress) => {
                        console.log(`[Example] ${country.name} ä¸Šä¼ è¿›åº¦:`, progress);
                    });
                    
                    console.log(`[Example] ${country.name} æ’åæ•°æ®:`, {
                        rankPercent: rankData.rankPercent,
                        totalUsers: rankData.totalUsers,
                        countryRank: rankData.countryRank // å¦‚æœåç«¯è¿”å›
                    });
                    
                    // 4.5 æ›´æ–°UIï¼ˆç¤ºä¾‹ï¼‰
                    updateCountryDashboard(country.code, {
                        result,
                        rankData,
                        deviation: result.deviationFromCountry
                    });
                    
                } catch (error) {
                    console.error(`[Example] ${country.name} åˆ†æå¤±è´¥:`, error);
                    // ã€v4.0 è¶…æ—¶ä¿æŠ¤ã€‘å¦‚æœè¶…æ—¶ï¼Œä¼šè‡ªåŠ¨é™çº§åˆ°æœ¬åœ°ç®€å•åŒ¹é…
                    if (error.message.includes('timeout')) {
                        console.warn(`[Example] ${country.name} åˆ†æè¶…æ—¶ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ`);
                    }
                }
                
                // é¿å…è¿‡å¿«åˆ‡æ¢å¯¼è‡´å¹¶å‘å†²çªï¼ˆã€v4.0 å¹¶å‘é”ã€‘ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šä»åç«¯è·å–å›½å®¶å¹³å‡å€¼
        async function fetchCountryAverage(countryCode) {
            try {
                const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || 
                                   'https://cursor-clinical-analysis.psterman.workers.dev/';
                const url = `${apiEndpoint}api/v2/country-average?countryCode=${countryCode}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.average || null; // æ ¼å¼ï¼š{L: 65, P: 70, D: 60, E: 8, F: 55}
            } catch (error) {
                console.warn(`[Example] è·å– ${countryCode} å›½å®¶å¹³å‡å€¼å¤±è´¥:`, error);
                return null;
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®å›½å®¶ä»£ç è·å–åœ°åŒº
        function getRegionByCountryCode(code) {
            const regionMap = {
                'US': 'North America',
                'CN': 'Asia',
                'JP': 'Asia',
                'GB': 'Europe',
                'DE': 'Europe',
                // ... æ›´å¤šæ˜ å°„
            };
            return regionMap[code] || 'Unknown';
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°å›½å®¶ä»ªè¡¨æ¿UI
        function updateCountryDashboard(countryCode, data) {
            // ç¤ºä¾‹ï¼šæ›´æ–°UIå…ƒç´ 
            const dashboard = document.getElementById(`country-dashboard-${countryCode}`);
            if (dashboard) {
                dashboard.innerHTML = `
                    <div class="country-stats">
                        <h3>${countryCode} åˆ†æç»“æœ</h3>
                        <div class="dimensions">
                            ${Object.entries(data.result.dimensions).map(([key, value]) => 
                                `<div class="dimension">
                                    <span>${key}:</span>
                                    <span>${value}</span>
                                    ${data.deviation ? `<span class="deviation">${data.deviation.deviations[key]?.deviationPercent || ''}</span>` : ''}
                                </div>`
                            ).join('')}
                        </div>
                        <div class="deviation-summary">
                            ${data.deviation ? `
                                <p>æ•´ä½“åç¦»åº¦: ${data.deviation.overallDeviation}%</p>
                                <p>${data.deviation.interpretation}</p>
                            ` : ''}
                        </div>
                        <div class="stats">
                            <p>æŠ€æœ¯æ ˆ: ${JSON.stringify(data.result.statistics?.tech_stack || {})}</p>
                            <p>å®¢å¥—è¯æ•°: ${data.result.statistics?.ketao_count || 0}</p>
                            <p>åŠ æ–¹è¯æ•°: ${data.result.statistics?.jiafang_count || 0}</p>
                            <p>å·¥ä½œå¤©æ•°: ${data.result.statistics?.work_days || 0}</p>
                        </div>
                        ${data.result.metadata?.hasRageWord ? '<div class="rage-warning">âš ï¸ æ£€æµ‹åˆ°å’†å“®è¯</div>' : ''}
                    </div>
                `;
            }
        }
        
        // ==========================================
        // åŸæœ‰ä»£ç ç»§ç»­...
        // ==========================================
        
        // =========================
        // å…¨å±€å˜é‡å£°æ˜ï¼ˆç¡®ä¿åœ¨å…¨å±€ä½œç”¨åŸŸï¼Œä¸åœ¨é—­åŒ…å†…ï¼‰
        // =========================
        const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content;
        let currentLang = 'zh';
        
        // Supabase ç›¸å…³å˜é‡ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼Œä¸åœ¨ä»»ä½•å‡½æ•°å†…ï¼‰
        let supabaseClient = null;
        let realtimeChannel = null;
        let presenceChannel = null; // Presence é¢‘é“ï¼Œç”¨äºç»Ÿè®¡åœ¨çº¿äººæ•°
        const SUPABASE_URL = 'https://dtcplfhcgnxdzpigmotb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_-rrlujgXDNxqb-UsMJckNw_G2rn2e8x';
        
        // é»˜è®¤å¤´åƒå¸¸é‡
        const DEFAULT_AVATAR = 'https://github.com/identicons/guest.png';
        
        // æ— æ•ˆç”¨æˆ·åçš„é»˜è®¤å€¼åˆ—è¡¨ï¼ˆè¿™äº›å€¼ä¸åº”è¯¥è¯·æ±‚GitHubå¤´åƒï¼‰
        const INVALID_USERNAME_VALUES = ['è‡ªåŠ¨ä¸ŠæŠ¥ç”¨æˆ·', 'Anonymous', 'Guest', 'guest', 'anonymous', ''];
        
        // ç”¨æˆ·çŠ¶æ€é…ç½®
        const USER_STATUSES = {
            idle: { 
                label: 'æé€Ÿ', 
                emoji: 'ğŸŸ¢', 
                color: '#00ff41',
                status_color: '#00ff41',
                status: 'idle'
            },
            busy: { 
                label: 'å¿™ç¢Œ', 
                emoji: 'ğŸŸ ', 
                color: '#ff8c00',
                status_color: '#ff8c00',
                status: 'busy'
            },
            sprint: { 
                label: 'å†²åˆº', 
                emoji: 'ğŸš€', 
                color: '#ff006e',
                status_color: '#ff006e',
                status: 'sprint'
            }
        };
        
        // å½“å‰ç”¨æˆ·çŠ¶æ€ï¼ˆä»localStorageåŠ è½½ï¼‰
        let currentUserStatus = localStorage.getItem('user_status') || 'idle';
        
        // æŠ½å±‰å±•å¼€/æŠ˜å çŠ¶æ€ï¼ˆä»localStorageåŠ è½½ï¼‰
        let drawerExpanded = localStorage.getItem('drawer_expanded') !== 'false'; // é»˜è®¤å±•å¼€

        // ç»´åº¦æ’åæ•°æ®èµ„æºï¼ˆä» rank-content.ts åŠ è½½ï¼‰
        let RANK_RESOURCES = null;

        // ============================================
        // ã€å…¨å±€é”™è¯¯æ•è·ã€‘é˜²æ­¢å•ä¸ªæ¨¡å—å´©æºƒå¯¼è‡´æ•´ä¸ªé¡µé¢æ— æ³•åŠ è½½
        // ============================================
        window.addEventListener('error', (event) => {
            console.error('[Global Error Handler] âŒ æ•è·åˆ°å…¨å±€é”™è¯¯:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
            
            // å¦‚æœæ˜¯è¯­æ³•é”™è¯¯ï¼Œå°è¯•ç»§ç»­æ‰§è¡Œå…³é”®åˆå§‹åŒ–
            if (event.error && event.error.name === 'SyntaxError') {
                console.warn('[Global Error Handler] âš ï¸ æ£€æµ‹åˆ°è¯­æ³•é”™è¯¯ï¼Œå°è¯•ç»§ç»­åˆå§‹åŒ–å…³é”®åŠŸèƒ½...');
                // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œä½†è®°å½•é”™è¯¯
            }
        });
        
        // æ•è·æœªå¤„ç†çš„ Promise æ‹’ç»
        window.addEventListener('unhandledrejection', (event) => {
            console.error('[Global Error Handler] âŒ æ•è·åˆ°æœªå¤„ç†çš„ Promise æ‹’ç»:', event.reason);
            // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆæ§åˆ¶å°æŠ¥é”™ï¼‰ï¼Œä½†è®°å½•é”™è¯¯
            event.preventDefault();
        });
        
        // ============================================
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ï¼ˆå…¨å±€ä½œç”¨åŸŸç›´æ¥æ‰§è¡Œï¼‰
        // ============================================
        // ä½¿ç”¨è½®è¯¢æ–¹å¼ç­‰å¾… SDK åŠ è½½å®Œæˆ
        let initAttempts = 0;
        const maxAttempts = 50; // æœ€å¤šå°è¯• 5 ç§’ï¼ˆ50 * 100msï¼‰

        const initInterval = setInterval(() => {
            initAttempts++;
            
            // æ£€æŸ¥ supabase æ˜¯å¦å·²åŠ è½½
            if (typeof supabase !== 'undefined') {
                clearInterval(initInterval);
                
                try {
                    // å®ä¾‹åŒ–å®¢æˆ·ç«¯ï¼ˆç›´æ¥èµ‹å€¼ç»™å…¨å±€å˜é‡ï¼‰
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    
                    // æŒ‚è½½åˆ°å…¨å±€ windowï¼Œä¾›æ§åˆ¶å°è„šæœ¬ä½¿ç”¨
                    window.supabaseClient = supabaseClient;
                    
                    console.log('[Init] âœ… Supabase å®¢æˆ·ç«¯å·²æˆåŠŸæŒ‚è½½è‡³ window.supabaseClient');
                    console.log('[Init] ğŸ’¡ å¯åœ¨æ§åˆ¶å°ä½¿ç”¨ window.supabaseClient è®¿é—®å®¢æˆ·ç«¯');
                } catch (err) {
                    console.error('[Init] âŒ åˆå§‹åŒ–å¤±è´¥:', err);
                }
            } else if (initAttempts >= maxAttempts) {
                clearInterval(initInterval);
                console.error('[Init] âŒ Supabase SDK åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CDN æ˜¯å¦å¯è®¿é—®');
            }
        }, 100);
        const i18n = {
            zh: {
                'sub-title': 'å®æ—¶è¿œç¨‹ç›‘æµ‹çŠ¶æ€ // èŠ‚ç‚¹ï¼šå¤ªå¹³æ´‹ä¸­éƒ¨',
                'total-victims': 'å·²è¯Šæ–­å¼€å‘è€…',
                'total-analysis': 'å…¨ç½‘æ‰«ææ¬¡æ•°',
                'total-roast': 'ç´¯è®¡åæ§½å­—æ•°',
                'avg-chars': 'äººå‡åæ§½é‡',
                'radar-title': 'å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒ',
                'personality-dist': 'äººæ ¼åˆ†å¸ƒæ’è¡Œ',
                'active-nodes': 'æ´»è·ƒèŠ‚ç‚¹',
                'threat-level': 'é£é™©è¯„çº§',
                'top-hotspot': 'æœ€å¯†é›†çƒ­åŒº',
                'sys-days': 'è¿è¡Œå¤©æ•°',
                'city-coverage': 'åŸå¸‚è¦†ç›–',
                'sync-rate': 'åŒæ­¥é€Ÿç‡',
                'hot-list': 'åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ',
                'recent-activity': 'å®æ—¶è¯Šæ–­æ´»åŠ¨',
                'victim': 'å—å®³è€…',
                'loading': 'åˆå§‹åŒ–ä¸­...',
                'rank': 'æ’å'
            },
            en: {
                'sub-title': 'Telemetry Status // Node: Central_Pacific',
                'total-victims': 'Total Developers',
                'total-analysis': 'Total Scans',
                'total-roast': 'Total Roast Words',
                'avg-chars': 'Avg Roast Per User',
                'radar-title': 'Global Developer Persona',
                'personality-dist': 'Personality Distribution',
                'active-nodes': 'Active Nodes',
                'threat-level': 'Threat Level',
                'top-hotspot': 'Primary Hotspot',
                'sys-days': 'Days Online',
                'city-coverage': 'City Coverage',
                'sync-rate': 'Sync Rate',
                'hot-list': 'Geographic Hotspots',
                'recent-activity': 'Live Activity Feed',
                'victim': 'Victim',
                'loading': 'Initializing...',
                'rank': 'Rank'
            }
        };

        const countryNameMap = {
            'CN': { zh: 'ä¸­å›½', en: 'China' },
            'US': { zh: 'ç¾å›½', en: 'USA' },
            'JP': { zh: 'æ—¥æœ¬', en: 'Japan' },
            'GB': { zh: 'è‹±å›½', en: 'UK' },
            'DE': { zh: 'å¾·å›½', en: 'Germany' },
            'SG': { zh: 'æ–°åŠ å¡', en: 'Singapore' },
            'HK': { zh: 'ä¸­å›½é¦™æ¸¯', en: 'Hong Kong' },
            'TW': { zh: 'ä¸­å›½å°æ¹¾', en: 'Taiwan' }
        };

        let mapChart, radarChart;
        let selectedCountry = null; // å½“å‰é€‰ä¸­çš„å›½å®¶
        let currentChampionInfo = null; // å½“å‰é€‰ä¸­çš„å† å†›ä¿¡æ¯ï¼ˆç”¨äºåœ°å›¾ tooltip å±•ç¤ºï¼‰
        // ğŸ” ç§°å·ä¸è¯´æ˜æ˜ å°„ï¼ˆå®Œå…¨åŒæ­¥ content.ts çš„ä¸šåŠ¡è¯­ä¹‰ï¼‰
        const DIMENSION_TITLES = {
            L: { title: 'æ¶æ„å¸ˆçš„ç›´è§‰', description: 'åœ¨é€»è¾‘è¿·å®«ä¸­ä¸€çœ¼çœ‹ç©¿æœ¬è´¨' },
            P: { title: 'æ·±æµ·æ½œèˆªè€…', description: 'é¢å¯¹å¤æ‚é€»è¾‘æ‹¥æœ‰æè‡´çš„é™æ°”' },
            D: { title: 'åƒç´ çº§ä¾¦æ¢', description: 'ä»»ä½•å¾®å°çš„ä»£ç ç‘•ç–µéƒ½æ— æ‰€éå½¢' },
            E: { title: 'å…±æƒ…æ¶æ„å¸ˆ', description: 'ä»£ç ä¸­æµæ·Œç€å¯¹ç”¨æˆ·ä½“éªŒçš„æè‡´ç†è§£' },
            F: { title: 'æŒ‡å°–æ‰“å‡»ä¹æ‰‹', description: 'æè‡´çš„è¾“å…¥é¢‘ç‡ä¸‹ä¿æŒç€æƒŠäººçš„å‡†ç¡®ç‡' }
        };
        
        let lpdefExperts = { L: null, P: null, D: null, E: null, F: null }; // å­˜å‚¨å½“å‰äº”ä¸ªç»´åº¦çš„ä¸“å®¶ä¿¡æ¯
        // åœ°å›¾æ¸²æŸ“ä»¤ç‰Œï¼šé˜²æ­¢å¹¶å‘ init / dispose å¯¼è‡´ getZr ä¸ºç©º
        let mapRenderSeq = 0;
        
        // å…¨å±€æ•°æ®å­˜å‚¨ï¼šç”¨äº Realtime æ›´æ–°
        let latestRecords = [];

        /**
         * æ•°å­—æ ¼å¼åŒ–å‡½æ•°ï¼ˆæ™ºèƒ½å¤„ç†å¤§æ•°å­—ï¼‰
         * @param {number} num - è¦æ ¼å¼åŒ–çš„æ•°å­—
         * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼ˆå¦‚ 1.2M, 3.5Kï¼‰
         */
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) {
                return '0';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        /**
         * æ•°å­—æ»šåŠ¨åŠ¨ç”»ï¼ˆrequestAnimationFrameï¼‰
         * éœ€æ±‚ï¼šanimateValue(id, end, duration) + åƒåˆ†ä½æ ¼å¼åŒ–
         * @param {string} id - ç›®æ ‡å…ƒç´  id
         * @param {number} end - ç»“æŸå€¼
         * @param {number} duration - åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
         * @param {Object} options - å¯é€‰é¡¹
         */
        function animateValue(id, end, duration = 1200, options = {}) {
            const el = document.getElementById(id);
            if (!el) return;

            const { start = 0, decimals = 0, useThousands = true } = options;
            const s = Number(start) || 0;
            const e = Number(end) || 0;
            const startTime = performance.now();

            const format = (val) => {
                const n = Number(val) || 0;
                if (useThousands) {
                    return n.toLocaleString(undefined, {
                        minimumFractionDigits: decimals,
                        maximumFractionDigits: decimals
                    });
                }
                return decimals > 0 ? n.toFixed(decimals) : String(Math.round(n));
            };

            const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

            function tick(now) {
                const t = Math.min((now - startTime) / duration, 1);
                const eased = easeOutCubic(t);
                const current = s + (e - s) * eased;
                el.textContent = format(decimals > 0 ? current : Math.floor(current));
                if (t < 1) requestAnimationFrame(tick);
                else el.textContent = format(e);
            }

            requestAnimationFrame(tick);
        }

        /**
         * åŠ è½½æ€éª¨æ¶å±æ³¨å…¥/ç§»é™¤
         */
        const numericIds = [
            'totalUsers',
            'totalAnalysis',
            'totalChars',
            'avgPerUser',
            'avgPerScan',
            'systemDays',
            'cityCount',
        ];

        function setLoadingState(isLoading) {
            const scan = document.getElementById('scanLine');
            if (scan) scan.classList.toggle('active', !!isLoading);

            numericIds.forEach((id) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('skeleton', !!isLoading);
                if (isLoading) {
                    el.textContent = '000000';
                }
            });
        }

        function switchLang(lang) {
            currentLang = lang;
            document.getElementById('btn-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('btn-en').classList.toggle('active', lang === 'en');
            
            // æ›´æ–°é™æ€æ–‡æ¡ˆ
            document.getElementById('sub-title').innerText = i18n[lang]['sub-title'];
            document.querySelectorAll('.lang-key').forEach(el => {
                const key = el.getAttribute('data-key');
                el.innerText = i18n[lang][key];
            });

            // é‡æ–°æ¸²æŸ“æ•°æ®ä¾èµ–å‹ç»„ä»¶
            if (window.lastData) {
                renderLocationList(window.lastData.locationRank);
                const activityData = window.lastData.latestRecords || window.lastData.recentVictims || [];
                renderRecentActivity(activityData);
                renderPersonalityDistribution(window.lastData.personalityDistribution);
                // å¼‚æ­¥æ¸²æŸ“åœ°å›¾ï¼Œç¡®ä¿åœ°å›¾æ•°æ®å·²åŠ è½½
                initGlobalMap(window.lastData.locationRank).catch(err => {
                    console.warn('[Dashboard] è¯­è¨€åˆ‡æ¢æ—¶åœ°å›¾æ¸²æŸ“å¤±è´¥:', err);
                });
            }
        }

        /**
         * æ£€æŸ¥åœ°å›¾æ•°æ®æ˜¯å¦å·²åŠ è½½
         * world.js åŠ è½½åä¼šåœ¨ echarts ä¸­æ³¨å†Œ 'world' åœ°å›¾
         */
        async function checkMapLoaded() {
            if (typeof echarts === 'undefined') {
                return false;
            }
            
            // æ£€æŸ¥åœ°å›¾æ˜¯å¦å·²æ³¨å†Œ
            // ECharts 5.x ä½¿ç”¨ getMap æ–¹æ³•æ£€æŸ¥
            try {
                if (typeof echarts.getMap === 'function') {
                    const mapData = echarts.getMap('world');
                    if (mapData) {
                        console.log('[Map] âœ… åœ°å›¾æ•°æ®å·²æ³¨å†Œ');
                        return true;
                    }
                }
                
                // é™çº§æ£€æŸ¥ï¼šå°è¯•æ³¨å†Œåœ°å›¾ï¼ˆå¦‚æœ world.js å·²åŠ è½½ï¼Œåœ°å›¾æ•°æ®ä¼šåœ¨å…¨å±€å˜é‡ä¸­ï¼‰
                // world.js é€šå¸¸ä¼šå°†åœ°å›¾æ•°æ®å­˜å‚¨åœ¨æŸä¸ªå…¨å±€å˜é‡ä¸­
                // å¦‚æœå­˜åœ¨ï¼Œæ‰‹åŠ¨æ³¨å†Œ
                if (typeof window !== 'undefined' && window.worldMapData) {
                    echarts.registerMap('world', window.worldMapData);
                    console.log('[Map] âœ… ä»å…¨å±€å˜é‡æ³¨å†Œåœ°å›¾');
                    return true;
                }
                
                // æ£€æŸ¥è„šæœ¬æ ‡ç­¾æ˜¯å¦å·²åŠ è½½
                const worldScript = document.querySelector('script[src*="world.js"]');
                if (worldScript && worldScript.getAttribute('data-loaded') === 'true') {
                    console.log('[Map] âœ… world.js è„šæœ¬å·²æ ‡è®°ä¸ºåŠ è½½');
                    return true;
                }
                
                console.warn('[Map] âš ï¸ åœ°å›¾æ•°æ®æœªæ‰¾åˆ°ï¼Œç­‰å¾… world.js åŠ è½½...');
                return false;
            } catch (error) {
                console.warn('[Map] âš ï¸ æ£€æŸ¥åœ°å›¾æ•°æ®æ—¶å‡ºé”™:', error);
                return false;
            }
        }

        /**
         * åˆ›å»ºå•ä¸ªç»´åº¦å¡ç‰‡ï¼ˆç”¨äºæŠ½å±‰æ˜¾ç¤ºï¼‰
         * @param {string} dimId - ç»´åº¦ID
         * @param {Object} config - ç»´åº¦é…ç½®
         * @param {number} maxValue - æœ€å¤§å€¼
         * @param {string} targetUserName - ç”¨æˆ·å
         * @param {string|null} targetIpLocation - IPä½ç½®
         * @param {Object|null} feedback - åé¦ˆä¿¡æ¯
         * @param {boolean} isGlobalTopMode - æ˜¯å¦ä¸ºå…¨çƒæœ€å¼ºæ¨¡å¼
         * @returns {HTMLElement} å¡ç‰‡å…ƒç´ 
         */
        function createDimensionCard(dimId, config, maxValue, targetUserName, targetIpLocation, feedback, isGlobalTopMode) {
            const displayVal = new Intl.NumberFormat('zh-CN').format(maxValue);
            const unit = config.suffix || '';

            const card = document.createElement('div');
            card.className = `drawer-item cursor-pointer`;
            card.setAttribute('data-dim-id', dimId);
            if (targetIpLocation) {
                card.setAttribute('data-ip-location', targetIpLocation);
            }
            card.setAttribute('data-champion-name', targetUserName);
            card.setAttribute('data-champion-value', maxValue);
            card.setAttribute('data-champion-feedback', feedback ? JSON.stringify(feedback) : '');

            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">${config.icon}</span>
                    <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                        ${isGlobalTopMode ? 'TOP' : 'MINE'}
                    </span>
                </div>
                <div class="drawer-item-label">${config.name}</div>
                <div class="drawer-item-value text-2xl">${displayVal}<span class="text-[10px] ml-1 font-normal opacity-70">${unit}</span></div>
                <div class="drawer-item-desc mt-2 pt-2 border-t border-[#00ff41]/10">
                    <div class="text-[10px] text-white font-bold truncate">${feedback ? feedback.label : 'RANKED'}</div>
                    <div class="text-[8px] text-[#00ff41]/60 truncate italic">@${targetUserName || 'ANONYMOUS'}</div>
                </div>
            `;

            // æ·»åŠ åœ°å›¾è”åŠ¨äº¤äº’
            card.addEventListener('click', () => {
                const ipLocation = card.getAttribute('data-ip-location');
                if (ipLocation && mapChart && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                    let countryName = null;
                    if (countryNameMap && countryNameMap[ipLocation]) {
                        countryName = countryNameMap[ipLocation].en;
                    } else {
                        countryName = ipLocation;
                    }
                    
                    if (countryName) {
                        const championName = card.getAttribute('data-champion-name');
                        const championValue = card.getAttribute('data-champion-value');
                        const championFeedback = card.getAttribute('data-champion-feedback');
                        const dimId = card.getAttribute('data-dim-id');
                        
                        currentChampionInfo = {
                            countryName: countryName,
                            championName: championName,
                            championValue: championValue,
                            feedback: championFeedback,
                            dimId: dimId
                        };
                        
                        try {
                            mapChart.dispatchAction({
                                type: 'highlight',
                                name: countryName
                            });
                            mapChart.dispatchAction({
                                type: 'showTip',
                                name: countryName
                            });
                            console.log(`[Drawer] âœ… ç‚¹å‡»å¡ç‰‡ï¼Œé«˜äº®å›½å®¶: ${countryName}`);
                        } catch (error) {
                            console.error('[Drawer] âŒ é«˜äº®å›½å®¶å¤±è´¥:', error);
                        }
                    }
                }
            });

            return card;
        }

        // ä¿å­˜å½“å‰æ‰“å¼€æŠ½å±‰çš„å›½å®¶ä¿¡æ¯ï¼Œç”¨äºåˆ·æ–°
        let currentDrawerCountry = { code: null, name: null };

        /**
         * æ˜¾ç¤ºæŠ½å±‰å¹¶å¡«å……å›½å®¶æ•°æ®å’Œç»´åº¦å¡ç‰‡
         * @param {string} countryCode - å›½å®¶ä»£ç 
         * @param {string} countryName - å›½å®¶åç§°
         */
        function showDrawersWithCountryData(countryCode, countryName) {
            // ä¿å­˜å½“å‰å›½å®¶ä¿¡æ¯
            currentDrawerCountry.code = countryCode;
            currentDrawerCountry.name = countryName;
            const leftDrawer = document.getElementById('left-drawer');
            const rightDrawer = document.getElementById('right-drawer');
            const leftTitle = document.getElementById('left-drawer-title');
            const rightTitle = document.getElementById('right-drawer-title');
            const leftBody = document.getElementById('left-drawer-body');
            const rightBody = document.getElementById('right-drawer-body');

            if (!leftDrawer || !rightDrawer) return;

            // è·å–å›½å®¶æ˜¾ç¤ºåç§°
            const countryDisplayName = countryNameMap[countryCode] 
                ? (currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en)
                : countryName;

            // æ›´æ–°æ ‡é¢˜
            if (leftTitle) leftTitle.textContent = countryDisplayName;
            if (rightTitle) rightTitle.textContent = countryDisplayName;

            // æ¸…ç©ºæŠ½å±‰å†…å®¹
            if (leftBody) leftBody.innerHTML = '';
            if (rightBody) rightBody.innerHTML = '';

            // å®šä¹‰ç»´åº¦é…ç½®
            const dimensionConfig = {
                ai: { name: 'å¯¹è¯AIæ¬¡æ•°', icon: 'ğŸ’¬', suffix: 'æ¬¡' },
                word: { name: 'å¹³å‡é•¿åº¦', icon: 'ğŸ“', suffix: 'å­—/æ¡' },
                day: { name: 'ä¸Šå²—å¤©æ•°', icon: 'ğŸ“…', suffix: 'å¤©' },
                no: { name: 'ç”²æ–¹ä¸Šèº«', icon: 'ğŸš«', suffix: 'æ¬¡' },
                say: { name: 'åºŸè¯è¾“å‡º', icon: 'ğŸ’­', suffix: 'å­—' },
                please: { name: 'èµ›åšç£•å¤´', icon: 'ğŸ™', suffix: 'æ¬¡' }
            };

            // å®šä¹‰å·¦å³æŠ½å±‰çš„ç»´åº¦åˆ†é…
            // å·¦è¾¹æŠ½å±‰ï¼šuser_identity_config å¡ç‰‡
            // å³è¾¹æŠ½å±‰ï¼šæ‰€æœ‰ç»´åº¦å¡ç‰‡ï¼ˆai, word, day, no, say, pleaseï¼‰
            const leftDrawerDimensions = []; // å·¦è¾¹åªæ˜¾ç¤º user_identity_config
            const rightDrawerDimensions = ['ai', 'word', 'day', 'no', 'say', 'please']; // æ‰€æœ‰ç»´åº¦å¡ç‰‡

            // è·å–å½“å‰ç”¨æˆ·æ•°æ®ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºå…¨çƒæœ€å¼ºæ¨¡å¼ï¼‰
            // å°è¯•ä»å¤šä¸ªæ¥æºè·å–ç”¨æˆ·æ•°æ®ï¼ˆä¸ window.onload é€»è¾‘ä¸€è‡´ï¼‰
            let currentUser = null;
            try {
                // æ–¹æ³•1: ä»å…¨å±€å˜é‡è·å–
                if (window.currentUser) {
                    currentUser = window.currentUser;
                    console.log('[Drawer] âœ… ä»å…¨å±€å˜é‡è·å–åˆ°ç”¨æˆ·æ•°æ®:', currentUser.user_name || currentUser.name);
                } else {
                    // æ–¹æ³•2: ä» localStorage å’Œ URL å‚æ•°è·å–ï¼Œä¸ renderRankCards é€»è¾‘ä¸€è‡´
                    // è¾…åŠ©å‡½æ•°ï¼šè§„èŒƒåŒ–æŒ‡çº¹å­—ç¬¦ä¸²ï¼ˆå¿½ç•¥å¤§å°å†™å¹¶å‰”é™¤é¦–å°¾ç©ºæ ¼ï¼‰
                    const normalizeFingerprint = (fp) => {
                        if (!fp) return '';
                        return String(fp).trim().toLowerCase();
                    };
                    
                    let localGitHubName = null;
                    let currentFingerprint = null;
                    try {
                        localGitHubName = localStorage.getItem('github_username');
                        currentFingerprint = localStorage.getItem('user_fingerprint');
                        console.log('[Drawer] ğŸ” ä» localStorage è¯»å–:', {
                            hasFingerprint: !!currentFingerprint,
                            fingerprintPrefix: currentFingerprint ? currentFingerprint.substring(0, 8) : null,
                            hasGitHub: !!localGitHubName
                        });
                    } catch (e) {
                        console.warn('[Drawer] âš ï¸ è¯»å– localStorage å¤±è´¥:', e);
                    }
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlFingerprint = urlParams.get('fingerprint');
                    const urlGitHubName = urlParams.get('github');
                    
                    // è§„èŒƒåŒ–å½“å‰æŒ‡çº¹
                    const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                    const normalizedUrlFingerprint = normalizeFingerprint(urlFingerprint);
                    
                    // æŸ¥æ‰¾åŒ¹é…çš„ç”¨æˆ·æ•°æ®ï¼ˆä¼˜å…ˆçº§ï¼šæŒ‡çº¹ä¼˜å…ˆ > GitHub IDï¼‰
                    let allData = window.allData || [];
                    console.log('[Drawer] ğŸ“Š allData æ•°æ®é‡:', allData.length);
                    
                    // å¦‚æœ allData ä¸ºç©ºæˆ–å¾ˆå°‘ï¼Œå°è¯•é‡æ–°è·å–æ•°æ®
                    if (allData.length === 0 && normalizedCurrentFingerprint) {
                        console.log('[Drawer] âš ï¸ allData ä¸ºç©ºï¼Œå°è¯•é‡æ–°è·å–æ•°æ®...');
                        // å¼‚æ­¥é‡æ–°è·å–æ•°æ®ï¼ˆä¸é˜»å¡æŠ½å±‰æ˜¾ç¤ºï¼‰
                        fetchData().then(() => {
                            allData = window.allData || [];
                            console.log('[Drawer] âœ… é‡æ–°è·å–æ•°æ®å®Œæˆï¼ŒallData æ•°æ®é‡:', allData.length);
                            
                            // é‡æ–°å°è¯•åŒ¹é…ç”¨æˆ·
                            const matchedUser = allData.find(item => {
                                const itemFingerprint = normalizeFingerprint(item.fingerprint || item.user_fingerprint);
                                const itemIdentity = normalizeFingerprint(item.user_identity);
                                return (itemFingerprint && itemFingerprint === normalizedCurrentFingerprint) ||
                                       (itemIdentity && itemIdentity === normalizedCurrentFingerprint);
                            });
                            
                            if (matchedUser) {
                                console.log('[Drawer] âœ… é‡æ–°åŒ¹é…åˆ°ç”¨æˆ·:', matchedUser.user_name || matchedUser.name);
                                // æ›´æ–°å…¨å±€å˜é‡
                                window.currentUser = matchedUser;
                                // é‡æ–°æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
                                const leftBody = document.getElementById('left-drawer-body');
                                if (leftBody) {
                                    renderUserStatsCards(leftBody, matchedUser);
                                }
                            }
                        }).catch(err => {
                            console.error('[Drawer] âŒ é‡æ–°è·å–æ•°æ®å¤±è´¥:', err);
                        });
                    }
                    
                    // ä¼˜å…ˆé€šè¿‡æŒ‡çº¹åŒ¹é…
                    if (normalizedCurrentFingerprint || normalizedUrlFingerprint) {
                        console.log('[Drawer] ğŸ” å¼€å§‹æŒ‡çº¹åŒ¹é…ï¼Œç›®æ ‡æŒ‡çº¹:', normalizedCurrentFingerprint || normalizedUrlFingerprint);
                        currentUser = allData.find(item => {
                            const itemFingerprint = normalizeFingerprint(item.fingerprint || item.user_fingerprint);
                            const itemIdentity = normalizeFingerprint(item.user_identity);
                            
                            const matchFingerprint = itemFingerprint && (itemFingerprint === normalizedCurrentFingerprint || itemFingerprint === normalizedUrlFingerprint);
                            const matchIdentity = itemIdentity && (itemIdentity === normalizedCurrentFingerprint || itemIdentity === normalizedUrlFingerprint);
                            
                            if (matchFingerprint || matchIdentity) {
                                console.log('[Drawer] âœ… æŒ‡çº¹åŒ¹é…æˆåŠŸ:', {
                                    itemFingerprint: itemFingerprint ? itemFingerprint.substring(0, 8) : null,
                                    itemIdentity: itemIdentity ? itemIdentity.substring(0, 8) : null,
                                    userName: item.user_name || item.name
                                });
                            }
                            
                            return matchFingerprint || matchIdentity;
                        });
                        
                        if (!currentUser) {
                            console.log('[Drawer] âš ï¸ æŒ‡çº¹åŒ¹é…å¤±è´¥ï¼ŒallData ä¸­çš„æŒ‡çº¹æ ·æœ¬:', 
                                allData.slice(0, 3).map(item => ({
                                    fingerprint: item.fingerprint ? item.fingerprint.substring(0, 8) : null,
                                    user_identity: item.user_identity ? item.user_identity.substring(0, 8) : null,
                                    user_name: item.user_name || item.name
                                }))
                            );
                        }
                    }
                    
                    // å¦‚æœæŒ‡çº¹æœªåŒ¹é…ï¼Œå†é€€è€Œæ±‚å…¶æ¬¡å¯»æ‰¾ github_username
                    if (!currentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                        console.log('[Drawer] ğŸ” å¼€å§‹ GitHub ID åŒ¹é…:', localGitHubName);
                        const normalizedLocalGitHub = normalizeFingerprint(localGitHubName);
                        const normalizedUrlGitHub = normalizeFingerprint(urlGitHubName);
                        
                        currentUser = allData.find(item => {
                            const itemGitHub = normalizeFingerprint(item.github_username || item.user_name || item.name);
                            return itemGitHub && (itemGitHub === normalizedLocalGitHub || itemGitHub === normalizedUrlGitHub);
                        });
                        
                        if (currentUser) {
                            console.log('[Drawer] âœ… é€šè¿‡ GitHub ID æ‰¾åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                        }
                    }
                }
            } catch (e) {
                console.error('[Drawer] âŒ è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', e);
            }
            
            const isGlobalTopMode = !currentUser;
            const userData = currentUser;
            
            if (!currentUser) {
                console.log('[Drawer] âš ï¸ æœªæ‰¾åˆ°å½“å‰ç”¨æˆ·æ•°æ®ï¼Œå°†æ˜¾ç¤ºå…¨çƒæœ€å¼ºæ¨¡å¼');
            } else {
                console.log('[Drawer] âœ… æ‰¾åˆ°å½“å‰ç”¨æˆ·æ•°æ®ï¼Œå°†æ˜¾ç¤ºä¸ªäººç»Ÿè®¡:', userData.user_name || userData.name);
            }

            // å¡«å……å·¦ä¾§æŠ½å±‰ - user_identity_config å¡ç‰‡
            if (leftBody) {
                // è·å– GitHub ç”¨æˆ·åå’ŒæŒ‡çº¹ï¼ˆå¢åŠ å¼‚å¸¸å¤„ç†ï¼‰
                let githubUsername = '';
                let currentFingerprint = null;
                try {
                    githubUsername = localStorage.getItem('github_username') || '';
                    currentFingerprint = localStorage.getItem('user_fingerprint');
                } catch (e) {
                    console.warn('[Drawer] âš ï¸ è¯»å– localStorage å¤±è´¥:', e);
                }
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºçº¯æŒ‡çº¹ç”¨æˆ·ï¼ˆæ—  GitHub IDï¼‰
                // ã€Task 3ã€‘ä¼ å…¥ user_identity å‚æ•°ï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                const userIdentity = currentUser?.user_identity || null;
                const isFingerprintOnlyUser = !githubUsername || !isValidGitHubUsername(githubUsername, userIdentity);
                const fingerprintPrefix = currentFingerprint ? currentFingerprint.substring(0, 6).toUpperCase() : '';
                
                // ç¡®å®šæ˜¾ç¤ºçš„ç”¨æˆ·åå’Œå¤´åƒ
                let displayName = '';
                let displayLabel = '';
                let avatarUrl = DEFAULT_AVATAR;
                
                if (isFingerprintOnlyUser && currentFingerprint) {
                    // çº¯æŒ‡çº¹ç”¨æˆ·ï¼šæ˜¾ç¤º"åŒ¿åä¸“å®¶ [æŒ‡çº¹å‰6ä½]"
                    displayName = `åŒ¿åä¸“å®¶ ${fingerprintPrefix}`;
                    displayLabel = 'è®¾å¤‡æŒ‡çº¹';
                    // ä½¿ç”¨åŸºäºæŒ‡çº¹çš„ Identicon
                    avatarUrl = `https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(currentFingerprint)}`;
                } else if (githubUsername && isValidGitHubUsername(githubUsername, userIdentity)) {
                    // æœ‰ GitHub ID çš„ç”¨æˆ·
                    displayName = githubUsername;
                    displayLabel = 'GitHub ID';
                    avatarUrl = getGitHubAvatarUrl(githubUsername);
                } else {
                    // é»˜è®¤çŠ¶æ€
                    displayName = 'æœªè®¾ç½®';
                    displayLabel = 'GitHub ID';
                    avatarUrl = DEFAULT_AVATAR;
                }
                
                // è·å–å½“å‰çŠ¶æ€
                const currentStatus = localStorage.getItem('user_status') || 'idle';
                const statusConfig = USER_STATUSES[currentStatus] || USER_STATUSES.idle;
                
                // åˆ›å»º user_identity_config å¡ç‰‡
                const identityCard = document.createElement('div');
                identityCard.className = 'drawer-item';
                identityCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">ğŸ•¶ï¸</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                            CONFIG
                        </span>
                    </div>
                    
                    <div class="drawer-item-label mb-2">ç”¨æˆ·èº«ä»½é…ç½®</div>
                    
                    <!-- ç”¨æˆ·ä¿¡æ¯ï¼ˆGitHub æˆ–æŒ‡çº¹ï¼‰ -->
                    <div class="mb-3 pb-3 border-b border-[#00ff41]/10">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 rounded-full overflow-hidden border border-[#00ff41]/30 flex-shrink-0">
                                <img 
                                    src="${avatarUrl}" 
                                    alt="Avatar" 
                                    class="w-full h-full object-cover"
                                    onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                />
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="drawer-item-value text-sm truncate">${displayName}</div>
                                <div class="drawer-item-desc text-[8px]">${displayLabel}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çŠ¶æ€ä¿¡æ¯ -->
                    <div class="mb-2">
                        <div class="drawer-item-label mb-1">å½“å‰çŠ¶æ€</div>
                        <div class="flex items-center gap-2">
                            <span class="text-lg">${statusConfig.emoji}</span>
                            <div>
                                <div class="drawer-item-value text-sm" style="color: ${statusConfig.color}">${statusConfig.label}</div>
                                <div class="drawer-item-desc text-[8px]">${currentLang === 'zh' ? 'å·¥ä½œçŠ¶æ€' : 'Status'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çŠ¶æ€åˆ‡æ¢æŒ‰é’® -->
                    <div class="flex gap-1.5 mt-3 pt-3 border-t border-[#00ff41]/10">
                        <button 
                            onclick="setUserStatus('idle'); if(currentDrawerCountry.code) showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);"
                            class="flex-1 px-2 py-1.5 bg-zinc-900/50 border ${currentStatus === 'idle' ? 'border-[#00ff41]' : 'border-zinc-800'} text-[10px] font-bold uppercase tracking-wider hover:border-[#00ff41] transition-colors"
                            style="color: ${currentStatus === 'idle' ? '#00ff41' : '#71717a'};"
                        >
                            ğŸŸ¢ æé€Ÿ
                        </button>
                        <button 
                            onclick="setUserStatus('busy'); if(currentDrawerCountry.code) showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);"
                            class="flex-1 px-2 py-1.5 bg-zinc-900/50 border ${currentStatus === 'busy' ? 'border-[#ff8c00]' : 'border-zinc-800'} text-[10px] font-bold uppercase tracking-wider hover:border-[#ff8c00] transition-colors"
                            style="color: ${currentStatus === 'busy' ? '#ff8c00' : '#71717a'};"
                        >
                            ğŸŸ  å¿™ç¢Œ
                        </button>
                        <button 
                            onclick="setUserStatus('sprint'); if(currentDrawerCountry.code) showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);"
                            class="flex-1 px-2 py-1.5 bg-zinc-900/50 border ${currentStatus === 'sprint' ? 'border-[#ff006e]' : 'border-zinc-800'} text-[10px] font-bold uppercase tracking-wider hover:border-[#ff006e] transition-colors"
                            style="color: ${currentStatus === 'sprint' ? '#ff006e' : '#71717a'};"
                        >
                            ğŸš€ å†²åˆº
                        </button>
                    </div>
                    
                    <!-- GitHub OAuth ç™»å½•åŒºåŸŸ -->
                    <div class="mt-3 pt-3 border-t border-[#00ff41]/10" id="auth-login-section">
                        ${githubUsername && isValidGitHubUsername(githubUsername, userIdentity) 
                            ? `
                            <!-- å·²ç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œé€€å‡ºæŒ‰é’® -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <img 
                                        src="${getGitHubAvatarUrl(githubUsername)}" 
                                        alt="${githubUsername}"
                                        class="w-6 h-6 rounded-full border border-[#00ff41]/30"
                                        onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                    />
                                    <div>
                                        <div class="text-[10px] text-white font-bold">${githubUsername}</div>
                                        <a 
                                            href="https://github.com/${githubUsername}" 
                                            target="_blank"
                                            class="text-[8px] text-[#00ff41]/60 hover:text-[#00ff41] transition-colors"
                                        >
                                            æŸ¥çœ‹ GitHub
                                        </a>
                                    </div>
                                </div>
                                <button 
                                    onclick="logout()"
                                    class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-[8px] text-zinc-400 hover:text-white transition-colors rounded"
                                >
                                    é€€å‡º
                                </button>
                            </div>
                            `
                            : `
                            <!-- æœªç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤º GitHub ç™»å½•æŒ‰é’® -->
                            <div class="drawer-item-label mb-2">GitHub ç™»å½•</div>
                            <button 
                                onclick="loginWithGitHub()"
                                class="w-full px-4 py-3 bg-[#24292e] hover:bg-[#2f363d] border border-[#444d56] rounded-md text-white text-sm font-semibold flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl"
                            >
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path>
                                </svg>
                                <span>ä½¿ç”¨ GitHub ç™»å½•</span>
                            </button>
                            <div class="text-[8px] text-[#00ff41]/40 mt-2 text-center">
                                å®‰å…¨ã€å¿«é€Ÿã€ä¸€é”®ç™»å½•
                            </div>
                            `
                        }
                    </div>
                `;
                
                leftBody.appendChild(identityCard);

                // æ·»åŠ å®æ—¶è¯Šæ–­æ´»åŠ¨å¡ç‰‡
                const activityCard = document.createElement('div');
                activityCard.className = 'drawer-item';
                activityCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">ğŸ“¡</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                            LIVE
                        </span>
                    </div>
                    <div class="drawer-item-label mb-3">å®æ—¶è¯Šæ–­æ´»åŠ¨</div>
                    <div id="drawer-recentActivity" class="flex-1 overflow-y-auto max-h-[400px] text-[10px] font-mono space-y-3 pr-2"></div>
                `;
                leftBody.appendChild(activityCard);
                
                // æ¸²æŸ“å®æ—¶è¯Šæ–­æ´»åŠ¨
                const data = window.lastData || {};
                const activityData = data.latestRecords || data.recentVictims || [];
                const drawerActivityList = document.getElementById('drawer-recentActivity');
                if (drawerActivityList) {
                    if (activityData.length === 0) {
                        drawerActivityList.innerHTML = '<div class="text-zinc-500 text-center py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
                    } else {
                        drawerActivityList.innerHTML = activityData.map((v, index) => {
                            const time = v.time || v.created_at || new Date().toISOString();
                            const type = v.type || v.personality_type || 'UNKNOWN';
                            const location = v.location || v.ip_location || 'æœªçŸ¥';
                            const name = v.name || `è®°å½•${index + 1}`;
                            
                            const avatarUrl = v.avatar_url || null;
                            const githubUsername = v.github_username || null;
                            
                            // ã€ä¿®å¤ã€‘å°† recordUserIdentity å®šä¹‰ç§»åˆ° if å—å¤–ï¼Œç¡®ä¿åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½èƒ½è®¿é—®
                            const recordUserIdentity = v.user_identity || null;
                            
                            let finalAvatarUrl = avatarUrl;
                            if (!finalAvatarUrl && githubUsername) {
                                // ã€Task 3ã€‘ä¼ å…¥ user_identityï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                                if (isValidGitHubUsername(githubUsername, recordUserIdentity)) {
                                    finalAvatarUrl = getGitHubAvatarUrl(githubUsername);
                                } else {
                                    finalAvatarUrl = DEFAULT_AVATAR;
                                }
                            }
                            if (!finalAvatarUrl) {
                                finalAvatarUrl = DEFAULT_AVATAR;
                            }
                            
                            const finalUsername = githubUsername || name;
                            // ã€ä¿®å¤ã€‘ä¼ å…¥ user_identityï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                            // åªä¼ æœ‰æ•ˆçš„ GitHub ç”¨æˆ·åï¼Œé¿å…"è®°å½•1"è¿™æ ·çš„å€¼è§¦å‘æ ¡éªŒè­¦å‘Š
                            const usernameForAvatar = githubUsername && isValidGitHubUsername(githubUsername, recordUserIdentity) 
                                ? githubUsername 
                                : null;
                            const avatarHtml = createAvatarHtml(finalAvatarUrl, usernameForAvatar, 24, recordUserIdentity);
                            
                            return `
                                <div class="border-l-2 border-[#00ff41]/20 pl-2 py-1.5 flex items-start gap-2">
                                    <div class="flex-shrink-0 mt-0.5">
                                        ${avatarHtml}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-zinc-500 text-[9px]">${new Date(time).toLocaleTimeString()}</div>
                                        <div class="text-white text-[10px] font-bold">${name.length > 8 ? name.slice(0,8) + '...' : name}</div>
                                        <div class="text-[#00ff41] text-[9px]">${type} @ ${location}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
                // å¦‚æœæ£€æµ‹åˆ°å½“å‰ç”¨æˆ·æ•°æ®ï¼Œè‡ªåŠ¨åŠ è½½ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡
                if (currentUser) {
                    console.log('[Drawer] ğŸ“Š å¼€å§‹æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡...');
                    renderUserStatsCards(leftBody, currentUser);
                } else {
                    console.log('[Drawer] âš ï¸ æœªæ‰¾åˆ°ç”¨æˆ·æ•°æ®ï¼Œè·³è¿‡ç»Ÿè®¡å¡ç‰‡æ¸²æŸ“');
                    // å³ä½¿æ²¡æœ‰åŒ¹é…åˆ°ç”¨æˆ·ï¼Œå¦‚æœ localStorage ä¸­æœ‰ fingerprintï¼Œä¹Ÿæ˜¾ç¤ºä¸€ä¸ªæç¤º
                    try {
                        const currentFingerprint = localStorage.getItem('user_fingerprint');
                        if (currentFingerprint) {
                            const waitingCard = document.createElement('div');
                            waitingCard.className = 'drawer-item';
                            waitingCard.innerHTML = `
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">â³</span>
                                    <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                                        WAIT
                                    </span>
                                </div>
                                <div class="drawer-item-label mb-2">æ•°æ®åŠ è½½ä¸­</div>
                                <div class="text-[10px] text-[#00ff41]/60">
                                    æ‚¨çš„æ•°æ®æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...
                                </div>
                                <div class="text-[8px] text-[#00ff41]/40 mt-2">
                                    æŒ‡çº¹: ${currentFingerprint.substring(0, 8)}...
                                </div>
                            `;
                            leftBody.appendChild(waitingCard);
                        }
                    } catch (e) {
                        console.warn('[Drawer] âš ï¸ æ˜¾ç¤ºç­‰å¾…å¡ç‰‡å¤±è´¥:', e);
                    }
                }
            }

            // å¡«å……å³ä¾§æŠ½å±‰ - ç»´åº¦å¡ç‰‡å’Œç»Ÿè®¡å¡ç‰‡
            if (rightBody) {
                // å…ˆæ·»åŠ ç»´åº¦å¡ç‰‡
                if (RANK_RESOURCES) {
                    rightDrawerDimensions.forEach((dimId) => {
                        const config = dimensionConfig[dimId];
                        if (!config) return;

                        // è·å–ç»´åº¦æ•°æ®
                        let targetData = null;
                        let maxValue = 0;
                        let targetUserName = '';
                        let targetIpLocation = null;

                        if (isGlobalTopMode) {
                            const allData = window.allData || [];
                            if (allData.length > 0) {
                                targetData = allData.reduce((maxUser, currentUser) => {
                                    const currentValues = extractDimensionValues(currentUser);
                                    const maxValues = extractDimensionValues(maxUser);
                                    const currentValue = currentValues[dimId] || 0;
                                    const maxValue = maxValues[dimId] || 0;
                                    return currentValue > maxValue ? currentUser : maxUser;
                                }, allData[0]);
                                
                                const targetValues = extractDimensionValues(targetData);
                                maxValue = targetValues[dimId] || 0;
                                targetUserName = targetData.user_name || targetData.name || targetData.github_username || 'æœªçŸ¥ç”¨æˆ·';
                                targetIpLocation = targetData.ip_location || null;
                            } else {
                                maxValue = 0;
                                targetUserName = 'æš‚æ— æ•°æ®';
                                targetIpLocation = null;
                            }
                        } else {
                            targetData = userData;
                            const values = extractDimensionValues(userData);
                            maxValue = values[dimId] || 0;
                            targetUserName = userData.user_name || userData.name || userData.github_username || 'æˆ‘çš„æ•°æ®';
                            targetIpLocation = userData.ip_location || null;
                        }

                        const feedback = getRankFeedback(dimId, maxValue);
                        const card = createDimensionCard(dimId, config, maxValue, targetUserName, targetIpLocation, feedback, isGlobalTopMode);
                        rightBody.appendChild(card);
                    });
                }

                // æ·»åŠ ç»Ÿè®¡å¡ç‰‡ï¼ˆä» window.lastData è·å–æ•°æ®ï¼‰
                const data = window.lastData || {};
                
                // å·²è¯Šæ–­å¼€å‘è€…
                const totalUsersCard = document.createElement('div');
                totalUsersCard.className = 'drawer-item';
                const totalUsers = data.totalUsers !== undefined && data.totalUsers !== null ? Number(data.totalUsers) : undefined;
                totalUsersCard.innerHTML = `
                    <div class="drawer-item-label">å·²è¯Šæ–­å¼€å‘è€…</div>
                    <div class="drawer-item-value text-3xl">${totalUsers !== undefined ? new Intl.NumberFormat('zh-CN').format(totalUsers) : 'N/A'}</div>
                    <div class="drawer-item-desc">USERS_RECOGNIZED_SUCCESSFULLY</div>
                `;
                rightBody.appendChild(totalUsersCard);

                // å…¨ç½‘æ‰«ææ¬¡æ•°
                const totalAnalysisCard = document.createElement('div');
                totalAnalysisCard.className = 'drawer-item';
                const totalAnalysis = data.totalAnalysis !== undefined && data.totalAnalysis !== null ? Number(data.totalAnalysis) : undefined;
                totalAnalysisCard.innerHTML = `
                    <div class="drawer-item-label">å…¨ç½‘æ‰«ææ¬¡æ•°</div>
                    <div class="drawer-item-value text-3xl">${totalAnalysis !== undefined ? new Intl.NumberFormat('zh-CN').format(totalAnalysis) : 'N/A'}</div>
                    <div class="drawer-item-desc">TOTAL_SCAN_COUNT</div>
                `;
                rightBody.appendChild(totalAnalysisCard);

                // ç´¯è®¡åæ§½å­—æ•°ï¼šç»‘å®šåˆ° json.totalChars (276355)
                const totalCharsCard = document.createElement('div');
                totalCharsCard.className = 'drawer-item';
                const totalChars = data.totalChars !== undefined && data.totalChars !== null ? Number(data.totalChars) : (data.totalRoastWords !== undefined && data.totalRoastWords !== null ? Number(data.totalRoastWords) : undefined);
                totalCharsCard.innerHTML = `
                    <div class="drawer-item-label">ç´¯è®¡åæ§½å­—æ•°</div>
                    <div class="drawer-item-value text-3xl">${totalChars !== undefined ? new Intl.NumberFormat('zh-CN').format(totalChars) : 'N/A'}</div>
                    <div class="drawer-item-desc">ç´¯è®¡æ€»å­—æ•°ç»Ÿè®¡</div>
                `;
                rightBody.appendChild(totalCharsCard);

                // äººå‡å¹³å‡ç¯‡å¹…å’Œå•æ¬¡å¹³å‡ç¯‡å¹…ï¼ˆå¹¶æ’æ˜¾ç¤ºï¼‰
                const avgCard = document.createElement('div');
                avgCard.className = 'drawer-item';
                const avgPerUser = data.avgPerUser !== undefined && data.avgPerUser !== null ? Number(data.avgPerUser) : undefined;
                // å¹³å‡ç¯‡å¹…ï¼šç»‘å®šåˆ° json.totalChars / json.totalAnalysis
                let avgPerScan = data.avgPerScan !== undefined && data.avgPerScan !== null ? Number(data.avgPerScan) : undefined;
                if (avgPerScan === undefined && data.totalChars !== undefined && data.totalAnalysis !== undefined && data.totalAnalysis !== null && data.totalAnalysis > 0) {
                    avgPerScan = Number(data.totalChars) / Number(data.totalAnalysis);
                }
                avgCard.innerHTML = `
                    <div class="drawer-item-label mb-2">å¹³å‡ç¯‡å¹…ç»Ÿè®¡</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <div class="drawer-item-value text-xl">${avgPerUser !== undefined ? avgPerUser.toFixed(1) : 'N/A'}</div>
                            <div class="drawer-item-desc text-[8px]">äººå‡å¹³å‡ç¯‡å¹…</div>
                        </div>
                        <div>
                            <div class="drawer-item-value text-xl" style="color: #60a5fa;">${avgPerScan !== undefined ? avgPerScan.toFixed(1) : 'N/A'}</div>
                            <div class="drawer-item-desc text-[8px]">å•æ¬¡å¹³å‡ç¯‡å¹…</div>
                        </div>
                    </div>
                `;
                rightBody.appendChild(avgCard);

                // å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒï¼ˆé›·è¾¾å›¾ï¼‰
                const radarCard = document.createElement('div');
                radarCard.className = 'drawer-item';
                const radarData = data.globalAverage || data.averages;
                radarCard.innerHTML = `
                    <div class="drawer-item-label mb-3">å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒ</div>
                    <div class="aspect-square">
                        <canvas id="drawer-radarChart"></canvas>
                    </div>
                `;
                rightBody.appendChild(radarCard);
                
                // æ¸²æŸ“é›·è¾¾å›¾
                setTimeout(() => {
                    const drawerRadarCanvas = document.getElementById('drawer-radarChart');
                    if (drawerRadarCanvas && typeof Chart !== 'undefined' && radarData) {
                        const normalizedRadarData = {
                            L: radarData.L !== undefined && radarData.L !== null ? Number(radarData.L) : undefined,
                            P: radarData.P !== undefined && radarData.P !== null ? Number(radarData.P) : undefined,
                            D: radarData.D !== undefined && radarData.D !== null ? Number(radarData.D) : undefined,
                            E: radarData.E !== undefined && radarData.E !== null ? Number(radarData.E) : undefined,
                            F: radarData.F !== undefined && radarData.F !== null ? Number(radarData.F) : undefined,
                        };
                        renderRadarChartToCanvas(drawerRadarCanvas, normalizedRadarData);
                    }
                }, 100);

                // åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ
                const locationCard = document.createElement('div');
                locationCard.className = 'drawer-item';
                locationCard.innerHTML = `
                    <div class="drawer-item-label mb-3">åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ</div>
                    <div id="drawer-locationList" class="space-y-2"></div>
                `;
                rightBody.appendChild(locationCard);
                
                // æ¸²æŸ“åœ°ç†ä½ç½®åˆ—è¡¨
                if (data.locationRank && Array.isArray(data.locationRank)) {
                    const drawerLocationList = document.getElementById('drawer-locationList');
                    if (drawerLocationList) {
                        drawerLocationList.innerHTML = data.locationRank.slice(0, 5).map((item, i) => {
                            const name = countryNameMap[item.name] ? countryNameMap[item.name][currentLang] : item.name;
                            return `
                                <div class="flex justify-between items-center text-[10px] border-b border-[#00ff41]/10 pb-2">
                                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                                    <span class="font-bold uppercase tracking-tighter text-white">${name}</span>
                                    <span class="text-[#00ff41] font-bold">${item.value}</span>
                                </div>`;
                        }).join('');
                    }
                }

                // äººæ ¼åˆ†å¸ƒæ’è¡Œ
                const personalityCard = document.createElement('div');
                personalityCard.className = 'drawer-item';
                personalityCard.innerHTML = `
                    <div class="drawer-item-label mb-3">äººæ ¼åˆ†å¸ƒæ’è¡Œ</div>
                    <div id="drawer-personalityDistribution" class="space-y-2"></div>
                `;
                rightBody.appendChild(personalityCard);
                
                // æ¸²æŸ“äººæ ¼åˆ†å¸ƒ
                if (data.personalityRank && Array.isArray(data.personalityRank)) {
                    const drawerPersonalityList = document.getElementById('drawer-personalityDistribution');
                    if (drawerPersonalityList) {
                        drawerPersonalityList.innerHTML = data.personalityRank.map((item, i) => {
                            const type = item.type || 'UNKNOWN';
                            const count = Number(item.count) || 0;
                            return `
                                <div class="flex justify-between items-center text-[10px] border-b border-[#00ff41]/10 pb-2">
                                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                                    <span class="font-bold uppercase tracking-tighter text-white">${type}</span>
                                    <span class="text-[#00ff41] font-bold">${count}</span>
                                </div>`;
                        }).join('');
                    }
                }
            }

            // æ˜¾ç¤ºæŠ½å±‰
            leftDrawer.classList.add('active');
            rightDrawer.classList.add('active');
            console.log('[Drawer] æŠ½å±‰å·²æ‰“å¼€:', countryDisplayName);
        }

        /**
         * å…³é—­æŠ½å±‰
         * @param {boolean} clearSelection - æ˜¯å¦æ¸…é™¤é€‰ä¸­çŠ¶æ€ï¼Œé»˜è®¤ä¸º true
         */
        function closeDrawers(clearSelection = true) {
            const leftDrawer = document.getElementById('left-drawer');
            const rightDrawer = document.getElementById('right-drawer');

            if (leftDrawer) {
                leftDrawer.classList.remove('active');
            }
            if (rightDrawer) {
                rightDrawer.classList.remove('active');
            }
            
            if (clearSelection) {
                selectedCountry = null;
            }
            console.log('[Drawer] æŠ½å±‰å·²å…³é—­, selectedCountry =', selectedCountry);
        }

        // æ·»åŠ  ESC é”®å…³é—­æŠ½å±‰
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDrawers();
            }
        });

        // ç‚¹å‡»æŠ½å±‰å¤–éƒ¨åŒºåŸŸå…³é—­æŠ½å±‰ï¼ˆç®€åŒ–ç‰ˆï¼‰
        // åªå¤„ç†ç‚¹å‡» UI å…ƒç´ å¤–éƒ¨çš„æƒ…å†µï¼Œåœ°å›¾ç‚¹å‡»äº‹ä»¶å·²ç»å¤„ç†äº†åœ°å›¾åŒºåŸŸçš„ç‚¹å‡»
        document.addEventListener('click', (e) => {
            const leftDrawer = document.getElementById('left-drawer');
            const rightDrawer = document.getElementById('right-drawer');
            
            if (!leftDrawer || !rightDrawer) return;
            
            // å¦‚æœæŠ½å±‰æ˜¯æ¿€æ´»çŠ¶æ€
            const isDrawerActive = leftDrawer.classList.contains('active') || rightDrawer.classList.contains('active');
            
            if (!isDrawerActive) return;
            
            // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨æŠ½å±‰å†…éƒ¨
            const isClickInsideDrawer = leftDrawer.contains(e.target) || rightDrawer.contains(e.target);
            
            // å¦‚æœç‚¹å‡»åœ¨æŠ½å±‰å†…éƒ¨ï¼Œä¸å¤„ç†
            if (isClickInsideDrawer) return;
            
            // ã€ä¿®å¤åœ°å›¾ç‚¹å‡»ã€‘æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†åœ°å›¾å®¹å™¨ï¼ˆåŒ…æ‹¬ ECharts canvas å…ƒç´ ï¼‰
            // ECharts æ¸²æŸ“åï¼Œç‚¹å‡»ç›®æ ‡å¯èƒ½æ˜¯ canvas å…ƒç´ ï¼Œéœ€è¦æ£€æŸ¥å…¶çˆ¶å®¹å™¨
            const mapContainer = document.getElementById('map-container');
            const isMapClick = mapContainer && (
                e.target === mapContainer || 
                e.target.closest('#map-container') ||
                (e.target.tagName === 'CANVAS' && mapContainer.contains(e.target)) ||
                e.target.closest('canvas')
            );
            if (isMapClick) {
                // åœ°å›¾ç‚¹å‡»äº‹ä»¶ç”± ECharts å¤„ç†ï¼Œè¿™é‡Œä¸é‡å¤å¤„ç†ï¼ˆé¿å…å…³é—­æŠ½å±‰ï¼‰
                console.log('[Drawer] æ£€æµ‹åˆ°åœ°å›¾ç‚¹å‡»ï¼Œè·³è¿‡å…³é—­æŠ½å±‰é€»è¾‘');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº† UI äº¤äº’å…ƒç´ ï¼ˆæŒ‰é’®ã€è¾“å…¥æ¡†ç­‰ï¼‰
            const isUIClick = e.target.closest('.max-w-\\[1600px\\]') && 
                             (e.target.tagName === 'BUTTON' || 
                              e.target.tagName === 'INPUT' || 
                              e.target.tagName === 'SELECT' ||
                              e.target.tagName === 'TEXTAREA' ||
                              e.target.tagName === 'A' ||
                              e.target.closest('button') ||
                              e.target.closest('input') ||
                              e.target.closest('select') ||
                              e.target.closest('a'));
            
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ UI å…ƒç´ ï¼Œä¹Ÿä¸æ˜¯åœ°å›¾ï¼Œåˆ™å…³é—­æŠ½å±‰
            if (!isUIClick) {
                console.log('[Drawer] ç‚¹å‡»å¤–éƒ¨åŒºåŸŸï¼Œå…³é—­æŠ½å±‰');
                selectedCountry = null;
                closeDrawers();
            }
        });

        /**
         * ç­‰å¾…åœ°å›¾æ•°æ®åŠ è½½å®Œæˆ
         */
        async function waitForMapData(maxWait = 10000) {
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWait) {
                if (await checkMapLoaded()) {
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.warn('[Map] âš ï¸ ç­‰å¾…åœ°å›¾æ•°æ®è¶…æ—¶');
            return false;
        }

        // ä¿å­˜å…¨å±€åœ°å›¾æ•°æ®ï¼Œä¾›æŠ½å±‰ä½¿ç”¨
        let globalLocationData = [];

        /**
         * åˆå§‹åŒ–å…¨çƒ 2D åœ°å›¾ï¼ˆæ”¯æŒç¼©æ”¾ä¸æ‹–åŠ¨ï¼‰
         * @param {Array} locationData - åœ°ç†ä½ç½®æ•°æ® [{name: string, value: number}]
         */
        async function initGlobalMap(locationData) {
            try {
                // ä¿å­˜åˆ°å…¨å±€å˜é‡
                globalLocationData = locationData || [];
                const chartDom = document.getElementById('map-container');
                if (!chartDom) {
                    console.warn('[Map] âš ï¸ æ‰¾ä¸åˆ°åœ°å›¾å®¹å™¨å…ƒç´ ');
                    return;
                }
                
                // æ£€æŸ¥ ECharts å’Œ ECharts GL æ˜¯å¦å·²åŠ è½½
                if (typeof echarts === 'undefined') {
                    console.warn('[Map] âš ï¸ ECharts æœªåŠ è½½ï¼Œæ— æ³•æ¸²æŸ“åœ°å›¾');
                    return;
                }
                
                // æ¸²æŸ“ä»¤ç‰Œï¼ˆåªå…è®¸æœ€åä¸€æ¬¡è°ƒç”¨ç»§ç»­æ‰§è¡Œï¼‰
                const seq = ++mapRenderSeq;
                // å¦‚æœè¿™æ¬¡è°ƒç”¨å·²ç»è¿‡æœŸï¼Œç›´æ¥é€€å‡ºï¼ˆé¿å… dispose åè¿˜ç»§ç»­ setOptionï¼‰
                if (seq !== mapRenderSeq) return;

                // ç­‰å¾…åœ°å›¾æ•°æ®åŠ è½½å®Œæˆï¼ˆå°½é‡ç­‰å¾…ï¼Œä½†ä¸å¼ºåˆ¶é˜»æ–­æ¸²æŸ“ï¼‰
                try {
                    await waitForMapData(5000);
                } catch (e) {
                    console.warn('[Map] âš ï¸ åœ°å›¾æ•°æ®æ£€æŸ¥è¶…æ—¶ï¼Œç»§ç»­å°è¯•æ¸²æŸ“');
                }

                // å¤ç”¨å®ä¾‹ï¼šä¸å­˜åœ¨åˆ™ initï¼Œå­˜åœ¨åˆ™ clearï¼ˆé¿å… dispose å¹¶å‘é—®é¢˜ï¼‰
                try {
                    if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                        mapChart = echarts.init(chartDom, null, { renderer: 'canvas' });
                    } else {
                        mapChart.clear();
                    }
                } catch (e) {
                    // å…œåº•ï¼šå¦‚æœå®ä¾‹å¼‚å¸¸ï¼Œå°è¯•é‡æ–°åˆ›å»º
                    mapChart = echarts.init(chartDom, null, { renderer: 'canvas' });
                }
                
                // åœ°å›¾æ•°æ®å¿…é¡»å·²æ³¨å†Œï¼Œå¦åˆ™ç›´æ¥æç¤ºï¼ˆé¿å… setOption ç»§ç»­æŠ›é”™ï¼‰
                if (!echarts.getMap || !echarts.getMap('world')) {
                    console.warn('[Map] âš ï¸ world åœ°å›¾æ•°æ®æœªæ³¨å†Œï¼ˆworld.js æœªåŠ è½½å®Œæˆï¼‰');
                    chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">åœ°å›¾æ•°æ®æœªåŠ è½½å®Œæˆ</div>';
                    return;
                }

                // å¤„ç†åœ°ç†ä½ç½®æ•°æ®ï¼ˆ2D ä¸–ç•Œåœ°å›¾åç§°éœ€ä¸ world.js çš„è‹±æ–‡å›½å®¶ååŒ¹é…ï¼‰
                const processedData = (locationData || []).map(item => ({
                    name: (countryNameMap[item.name]
                        ? countryNameMap[item.name].en
                        : (item.name === 'USA' ? 'United States' : item.name)),
                    value: item.value || 0
                }));

                const maxVal = Math.max(20, ...processedData.map(d => d.value || 0));

                const option2D = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: '#18181b',
                        borderColor: '#27272a',
                        textStyle: { color: '#00ff41', fontFamily: 'JetBrains Mono' },
                        formatter: function(params) {
                            // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ params å­˜åœ¨
                            if (!params) {
                                return '<div class="font-mono text-xs">æœªçŸ¥åŒºåŸŸ</div>';
                            }
                            
                            // å¦‚æœæ˜¯åœ°å›¾å›½å®¶æ•°æ®ï¼Œæ˜¾ç¤ºå›½å®¶ä¿¡æ¯
                            if (params.seriesType === 'map') {
                                const name = params.name || params.data?.name || 'æœªçŸ¥åŒºåŸŸ';
                                const value = params.value || 0;
                                // å®‰å…¨è·å–ä¸­æ–‡åç§°
                                const label = (countryNameMap && countryNameMap[name] && countryNameMap[name].zh) 
                                    ? countryNameMap[name].zh 
                                    : name;
                                
                                // Proxy æç¤ºï¼šåˆ¤æ–­ is_proxy å­—æ®µï¼Œè‹¥ä¸º trueï¼Œåœ¨åœ°ç†ä½ç½®åå¢åŠ  [Proxy] çº¢è‰²è­¦å‘Šæ ‡ç­¾
                                const dataItem = params.data || {};
                                const isProxy = dataItem.is_proxy || dataItem.isProxy || false;
                                const proxyLabel = isProxy ? '<span style="color: #ef4444; font-weight: bold;"> [Proxy]</span>' : '';
                                
                                // æ•°æ®å±•ç¤ºï¼šåœ¨åœ°å›¾å¼¹çª—ï¼ˆTooltipï¼‰ä¸­åŒæ­¥å±•ç¤ºè¯¥å† å†›çš„ç§°å·å’Œæˆ˜ç»©
                                let tooltipContent = `<div class="font-mono text-xs">${label}${proxyLabel}<br/>æ´»è·ƒèŠ‚ç‚¹: ${value}</div>`;
                                
                                // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„å† å†›ä¿¡æ¯ï¼Œä¸”å›½å®¶åç§°åŒ¹é…ï¼Œæ˜¾ç¤ºå† å†›ä¿¡æ¯
                                if (currentChampionInfo && currentChampionInfo.countryName === name) {
                                    const feedback = currentChampionInfo.feedback ? JSON.parse(currentChampionInfo.feedback) : null;
                                    tooltipContent = `
                                        <div class="font-mono text-xs">
                                            <div class="text-[#00ff41] font-bold mb-1">ğŸ† ${currentChampionInfo.championName}</div>
                                            <div class="text-white mb-1">${label}${proxyLabel}</div>
                                            <div class="text-zinc-400 text-[10px] mb-1">æˆ˜ç»©: ${currentChampionInfo.championValue}</div>
                                            ${feedback ? `
                                                <div class="text-zinc-500 text-[9px] mt-2 pt-2 border-t border-zinc-700">
                                                    <div class="text-[#00ff41]">${feedback.label}</div>
                                                    <div class="text-white">${feedback.title}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }
                                
                                return tooltipContent;
                            }
                            // å¦‚æœæ˜¯è„‰å†²ç‚¹ï¼ˆeffectScatterï¼‰ï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«å¤´åƒé¢„è§ˆï¼‰
                            if (params.seriesType === 'effectScatter' && params.data) {
                                const pointData = params.data;
                                // ä»æ•°æ®ç‚¹ä¸­è·å–å¤´åƒä¿¡æ¯
                                const avatarUrl = pointData.avatarUrl || params.series?.avatarUrl || null;
                                const username = pointData.username || params.series?.username || null;
                                const userName = params.name || username || 'ç”¨æˆ·';
                                
                                if (avatarUrl || username) {
                                    // åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœ username æ— æ•ˆï¼Œä½¿ç”¨ DEFAULT_AVATAR
                                    let finalAvatarUrl = avatarUrl;
                                    if (!finalAvatarUrl && username) {
                                        // ã€Task 3ã€‘å¯¹äºåœ°å›¾ä¸Šçš„ç”¨æˆ·ç‚¹ï¼Œå¦‚æœæ˜¯ fingerprint ç”¨æˆ·åˆ™è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                                        // æ³¨æ„ï¼šè¿™é‡Œæ— æ³•è·å– user_identityï¼Œæ‰€ä»¥ä¿æŒåŸé€»è¾‘ï¼ˆåªæ£€æŸ¥ GitHub ç”¨æˆ·åæ ¼å¼ï¼‰
                                        if (isValidGitHubUsername(username)) {
                                            finalAvatarUrl = getGitHubAvatarUrl(username);
                                        } else {
                                            finalAvatarUrl = DEFAULT_AVATAR;
                                        }
                                    }
                                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒURLï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                                    if (!finalAvatarUrl) {
                                        finalAvatarUrl = DEFAULT_AVATAR;
                                    }
                                    
                                    // ä½¿ç”¨HTMLæ ¼å¼è¿”å›ï¼ŒåŒ…å«å¤´åƒå›¾ç‰‡
                                    // ECharts tooltipæ”¯æŒHTMLï¼Œå¯ä»¥ç›´æ¥åµŒå…¥imgæ ‡ç­¾
                                    return `
                                        <div style="display: flex; align-items: center; gap: 8px; padding: 4px;">
                                            <img 
                                                src="${finalAvatarUrl}" 
                                                alt="avatar" 
                                                style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #27272a;"
                                                onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                            />
                                            <div>
                                                <div style="color: #00ff41; font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: bold;">${userName}</div>
                                                <div style="color: #71717a; font-family: 'JetBrains Mono', monospace; font-size: 10px;">ç”¨æˆ·</div>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                return `<div style="color: #00ff41; font-family: 'JetBrains Mono', monospace;">ğŸ‘¤ ${userName}</div>`;
                            }
                            return params.name || '';
                        },
                        // å¯ç”¨HTMLæ¸²æŸ“æ¨¡å¼
                        extraCssText: 'box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);'
                    },
                    visualMap: {
                        min: 0,
                        max: maxVal,
                        show: false,
                        inRange: {
                            color: ['#064e3b', '#065f46', '#00ff41', '#34d399']
                        }
                    },
                    geo: {
                        map: 'world',
                        roam: true, // å¯ç”¨æ‹–åŠ¨å’Œç¼©æ”¾
                        scaleLimit: { min: 1, max: 8 },
                        zoom: 1.2,
                        itemStyle: {
                            areaColor: 'transparent',
                            borderColor: 'transparent',
                            borderWidth: 0
                        },
                        silent: true // é™é»˜æ¨¡å¼ï¼Œä¸å“åº”é¼ æ ‡äº‹ä»¶ï¼Œè®© map ç³»åˆ—å¤„ç†
                    },
                    series: [{
                        type: 'map',
                        map: 'world',
                        // å¯ç”¨æ‹–åŠ¨å’Œç¼©æ”¾
                        roam: true,
                        // é™åˆ¶ç¼©æ”¾èŒƒå›´ï¼Œé¿å…æ— é™æ”¾å¤§/ç¼©å°
                        scaleLimit: { min: 1, max: 8 },
                        zoom: 1.2,
                        itemStyle: {
                            areaColor: 'transparent',
                            borderColor: 'rgba(0, 255, 65, 0.2)',
                            borderWidth: 1
                        },
                        emphasis: {
                            itemStyle: { areaColor: '#00ff41' },
                            label: { show: false }
                        },
                        data: processedData
                    }]
                };

                // notMerge: true å½»åº•æ›¿æ¢ï¼Œé¿å…æ®‹ç•™æ—§é…ç½®
                mapChart.setOption(option2D, { notMerge: true, lazyUpdate: false });
                
                // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶å¤„ç† - é‡æ–°è®¾è®¡é€»è¾‘
                mapChart.off('click'); // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                mapChart.on('click', (params) => {
                    console.log('[Map] âœ… åœ°å›¾ç‚¹å‡»äº‹ä»¶å·²è§¦å‘:', params);
                    
                    // åˆ¤æ–­æ˜¯å¦ç‚¹å‡»åˆ°äº†å›½å®¶
                    // æ¡ä»¶ï¼šseriesType æ˜¯ 'map' ä¸” name å­˜åœ¨ä¸”ä¸ä¸ºç©ºå­—ç¬¦ä¸²
                    const hasValidName = params.name && typeof params.name === 'string' && params.name.trim() !== '';
                    const isCountryClick = params.seriesType === 'map' && hasValidName;
                    
                    console.log('[Map] ç‚¹å‡»äº‹ä»¶è¯¦æƒ…:', {
                        seriesType: params.seriesType,
                        name: params.name,
                        componentType: params.componentType,
                        hasValidName: hasValidName,
                        isCountryClick: isCountryClick,
                        selectedCountryBefore: selectedCountry
                    });
                    
                    if (isCountryClick) {
                        // ========== ç‚¹å‡»åˆ°äº†å›½å®¶ ==========
                        const countryName = params.name;
                        let countryCode = null;
                        
                        // æŸ¥æ‰¾å¯¹åº”çš„å›½å®¶ä»£ç 
                        for (const [code, names] of Object.entries(countryNameMap)) {
                            if (names.en === countryName || names.zh === countryName || code === countryName) {
                                countryCode = code;
                                break;
                            }
                        }
                        
                        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨åç§°
                        if (!countryCode) {
                            countryCode = countryName;
                        }
                        
                        console.log(`[Map] ğŸ—ºï¸ ç‚¹å‡»å›½å®¶: ${countryName} (${countryCode})`);
                        
                        // æ›´æ–°é€‰ä¸­çš„å›½å®¶
                        selectedCountry = countryCode;
                        
                        // æ˜¾ç¤ºæŠ½å±‰å¹¶å¡«å……æ•°æ®
                        showDrawersWithCountryData(countryCode, countryName);
                    } else {
                        // ========== ç‚¹å‡»åœ°å›¾ç©ºç™½å¤„ï¼ˆæµ·æ´‹ã€æœªå®šä¹‰åŒºåŸŸç­‰ï¼‰==========
                        console.log('[Map] ğŸŒŠ ç‚¹å‡»ç©ºç™½å¤„ï¼Œæ¸…é™¤é€‰ä¸­çŠ¶æ€å¹¶å…³é—­æŠ½å±‰', {
                            seriesType: params.seriesType,
                            name: params.name,
                            componentType: params.componentType,
                            selectedCountryBefore: selectedCountry
                        });
                        
                        // æ¸…é™¤é€‰ä¸­çŠ¶æ€å¹¶å…³é—­æŠ½å±‰
                        selectedCountry = null;
                        closeDrawers(false); // ä¸é‡å¤æ¸…é™¤ï¼Œå› ä¸ºä¸Šé¢å·²ç»æ¸…é™¤äº†
                        
                        console.log('[Map] é€‰ä¸­çŠ¶æ€å·²æ¸…é™¤ï¼ŒselectedCountry =', selectedCountry);
                    }
                });

                
                // æ·»åŠ åŒå‡»äº‹ä»¶ï¼Œé‡ç½®ä¸ºå…¨çƒè§†å›¾
                mapChart.off('dblclick');
                mapChart.on('dblclick', (params) => {
                    if (params.seriesType === 'map') {
                        selectedCountry = null;
                        console.log('[Map] ğŸŒ åŒå‡»é‡ç½®ä¸ºå…¨çƒè§†å›¾');
                        closeDrawers();
                        
                        // åœ°å›¾åŒå‡»åä¸å†éœ€è¦é‡æ–°æ¸²æŸ“ LPDEF å¡ç‰‡ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ rank-cards-containerï¼‰
                    }
                });
                
                // å“åº”å¼è°ƒæ•´ï¼ˆç§»é™¤æ—§ handlerï¼Œé¿å…å¤šæ¬¡ç»‘å®š + å¹¶å‘ resizeï¼‰
                try {
                    if (window.mapResizeHandler) {
                        window.removeEventListener('resize', window.mapResizeHandler);
                    }
                } catch (e) {
                    // ignore
                }
                const resizeHandler = () => {
                    if (mapChart && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                        mapChart.resize();
                    }
                };
                window.mapResizeHandler = resizeHandler;
                window.addEventListener('resize', resizeHandler);

                // é˜²æ­¢æ»šè½®ç¼©æ”¾åœ°å›¾æ—¶é¡µé¢è·Ÿç€æ»šåŠ¨ï¼ˆä»…åœ¨æŒ‡é’ˆåœç•™åœ°å›¾åŒºåŸŸæ—¶ç”Ÿæ•ˆï¼‰
                if (!chartDom.dataset.wheelLocked) {
                    chartDom.addEventListener('wheel', (e) => {
                        // ECharts è‡ªå·±ä¼šæ¶ˆè´¹æ»šè½®ç”¨äºç¼©æ”¾ï¼Œè¿™é‡Œé˜»æ­¢é¡µé¢æ»šåŠ¨
                        e.preventDefault();
                    }, { passive: false });
                    chartDom.dataset.wheelLocked = 'true';
                }

                console.log('[Map] âœ… 2D åœ°å›¾æ¸²æŸ“å®Œæˆï¼ˆå·²å¯ç”¨ç¼©æ”¾/æ‹–åŠ¨ï¼‰');
            } catch (error) {
                console.error('[Map] âŒ 2D åœ°å›¾æ¸²æŸ“å¤±è´¥:', error);
                chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">åœ°å›¾æ¸²æŸ“å¤±è´¥</div>';
            }
        }

        /**
         * åœ°å›¾è„‰å†²ç‰¹æ•ˆï¼šåœ¨åœ°å›¾ä¸ŠåŠ¨æ€æ·»åŠ æ¶Ÿæ¼ªç‰¹æ•ˆç‚¹ï¼ˆæ”¯æŒåŠ¨æ€é¢œè‰²ï¼‰
         * @param {number} lng - ç»åº¦
         * @param {number} lat - çº¬åº¦
         * @param {string} label - æ˜¾ç¤ºçš„æ ‡ç­¾æ–‡å­—
         * @param {string} color - é¢œè‰²å€¼ï¼ˆåå…­è¿›åˆ¶ï¼Œå¦‚ '#00ff41' æˆ– '#ffffff'ï¼‰
         */
        /**
         * åœ°å›¾è„‰å†²ç‰¹æ•ˆï¼šåœ¨åœ°å›¾ä¸ŠåŠ¨æ€æ·»åŠ æ¶Ÿæ¼ªç‰¹æ•ˆç‚¹ï¼ˆæ”¯æŒåŠ¨æ€é¢œè‰²å’Œå¤´åƒï¼‰
         * @param {number} lng - ç»åº¦
         * @param {number} lat - çº¬åº¦
         * @param {string} label - æ˜¾ç¤ºçš„æ ‡ç­¾æ–‡å­—
         * @param {string} color - é¢œè‰²å€¼ï¼ˆåå…­è¿›åˆ¶ï¼Œå¦‚ '#00ff41' æˆ– '#ffffff'ï¼‰
         * @param {string} avatarUrl - å¤´åƒURLï¼ˆå¯é€‰ï¼‰
         * @param {string} username - GitHubç”¨æˆ·åï¼ˆç”¨äºå¤´åƒå’Œidenticonå…œåº•ï¼‰
         */
        function triggerMapPulse(lng, lat, label = '', color = '#00ff41', avatarUrl = null, username = null) {
            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ ECharts å®ä¾‹å·²åˆå§‹åŒ–ä¸”æœªé”€æ¯
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                console.warn('[MapPulse] âš ï¸ åœ°å›¾å®ä¾‹æœªåˆå§‹åŒ–ï¼Œè·³è¿‡è„‰å†²ç‰¹æ•ˆ');
                return;
            }

            // æ•°æ®æ ¼å¼éªŒè¯
            if (typeof lng !== 'number' || typeof lat !== 'number' || isNaN(lng) || isNaN(lat)) {
                console.warn('[MapPulse] âš ï¸ ç»çº¬åº¦æ•°æ®æ ¼å¼æ— æ•ˆï¼Œè·³è¿‡è„‰å†²ç‰¹æ•ˆ');
                return;
            }

            // é¢œè‰²éªŒè¯å’Œé»˜è®¤å€¼
            if (!color || typeof color !== 'string') {
                color = '#00ff41'; // é»˜è®¤ç»ˆç«¯ç»¿
            }

            try {
                // è·å–å½“å‰åœ°å›¾é…ç½®
                const currentOption = mapChart.getOption();
                if (!currentOption || !currentOption.series || !Array.isArray(currentOption.series)) {
                    console.warn('[MapPulse] âš ï¸ æ— æ³•è·å–åœ°å›¾é…ç½®ï¼Œè·³è¿‡è„‰å†²ç‰¹æ•ˆ');
                    return;
                }

                // åˆ›å»ºä¸´æ—¶æ¶Ÿæ¼ªç‰¹æ•ˆç³»åˆ—ï¼ˆæ‰€æœ‰é¢œè‰²ç»‘å®šåˆ° color å‚æ•°ï¼‰
                // å°†å¤´åƒä¿¡æ¯å­˜å‚¨åˆ°ç³»åˆ—çš„è‡ªå®šä¹‰å±æ€§ä¸­ï¼Œä¾›tooltipä½¿ç”¨
                const pulseSeries = {
                    type: 'effectScatter',
                    coordinateSystem: 'geo',
                    data: [{
                        value: [lng, lat],
                        name: label || 'ç”¨æˆ·',
                        avatarUrl: avatarUrl || null,
                        username: username || null
                    }],
                    symbolSize: 20,
                    showEffectOn: 'render',
                    rippleEffect: {
                        brushType: 'stroke',
                        scale: 5, // å¢å¼ºè§†è§‰æ‰©æ•£æ„Ÿ
                        period: 4, // ä¼˜åŒ–æ¶Ÿæ¼ªå‘¨æœŸ
                        color: color // æ¶Ÿæ¼ªé¢œè‰²ç»‘å®šåˆ° color å‚æ•°
                    },
                    itemStyle: {
                        color: color, // ç‚¹é¢œè‰²ç»‘å®šåˆ° color å‚æ•°
                        shadowBlur: 20,
                        shadowColor: color // é˜´å½±é¢œè‰²ç»‘å®šåˆ° color å‚æ•°
                    },
                    label: {
                        show: !!label,
                        formatter: label || '',
                        position: 'top',
                        color: color, // æ ‡ç­¾é¢œè‰²ç»‘å®šåˆ° color å‚æ•°
                        fontSize: 10,
                        fontFamily: 'JetBrains Mono'
                    },
                    // å°†å¤´åƒä¿¡æ¯å­˜å‚¨åˆ°ç³»åˆ—çº§åˆ«ï¼Œä¾›tooltip formatterä½¿ç”¨
                    avatarUrl: avatarUrl || null,
                    username: username || null,
                    zlevel: 10,
                    z: 10
                };

                // å°†è„‰å†²ç³»åˆ—æ·»åŠ åˆ°ç°æœ‰ç³»åˆ—æ•°ç»„ä¸­
                const updatedSeries = [...currentOption.series, pulseSeries];
                
                // æ›´æ–°åœ°å›¾é…ç½®ï¼ˆä½¿ç”¨ merge æ¨¡å¼ï¼Œä¿ç•™åŸæœ‰é…ç½®ï¼‰
                mapChart.setOption({
                    series: updatedSeries
                }, { notMerge: false, lazyUpdate: false });

                console.log(`[MapPulse] âœ… è„‰å†²ç‰¹æ•ˆå·²æ·»åŠ : [${lng}, ${lat}] ${label || ''} (é¢œè‰²: ${color})`);

                // 5 ç§’åè‡ªåŠ¨ç§»é™¤è„‰å†²ç‰¹æ•ˆï¼ˆä¿è¯æ€§èƒ½ï¼Œé¿å… Canvas å †ç§¯è¿‡å¤šç‚¹ï¼‰
                setTimeout(() => {
                    try {
                        // å†æ¬¡æ£€æŸ¥åœ°å›¾å®ä¾‹æœ‰æ•ˆæ€§
                        if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                            return;
                        }

                        // è·å–å½“å‰é…ç½®å¹¶ç§»é™¤è„‰å†²ç³»åˆ—
                        const currentOpt = mapChart.getOption();
                        if (currentOpt && currentOpt.series && Array.isArray(currentOpt.series)) {
                            // æ‰¾åˆ°å¹¶ç§»é™¤æˆ‘ä»¬åˆšæ·»åŠ çš„ effectScatter ç³»åˆ—
                            // é€šè¿‡æ¯”è¾ƒæ•°æ®ç‚¹æ¥è¯†åˆ«ï¼ˆæ›´ç²¾ç¡®çš„åŒ¹é…ï¼‰
                            const filteredSeries = currentOpt.series.filter((s) => {
                                // ä¿ç•™åŸå§‹ç³»åˆ—ï¼Œç§»é™¤æˆ‘ä»¬æ·»åŠ çš„ effectScatter ç³»åˆ—
                                if (s.type === 'effectScatter' && s.data && s.data.length > 0) {
                                    const point = s.data[0];
                                    // å¦‚æœæ•°æ®ç‚¹åŒ¹é…ï¼Œè¯´æ˜æ˜¯æˆ‘ä»¬åˆšæ·»åŠ çš„ï¼Œéœ€è¦ç§»é™¤
                                    if (Array.isArray(point) && point.length >= 2) {
                                        const pointLng = point[0];
                                        const pointLat = point[1];
                                        // å…è®¸å°çš„æµ®ç‚¹æ•°è¯¯å·®
                                        if (Math.abs(pointLng - lng) < 0.0001 && Math.abs(pointLat - lat) < 0.0001) {
                                            return false; // ç§»é™¤è¿™ä¸ªç³»åˆ—
                                        }
                                    }
                                }
                                return true; // ä¿ç•™å…¶ä»–ç³»åˆ—
                            });
                            
                            mapChart.setOption({
                                series: filteredSeries
                            }, { notMerge: false, lazyUpdate: false });
                            
                            console.log('[MapPulse] âœ… è„‰å†²ç‰¹æ•ˆå·²è‡ªåŠ¨ç§»é™¤');
                        }
                    } catch (error) {
                        console.warn('[MapPulse] âš ï¸ ç§»é™¤è„‰å†²ç‰¹æ•ˆæ—¶å‡ºé”™:', error);
                    }
                }, 5000);

            } catch (error) {
                console.error('[MapPulse] âŒ æ·»åŠ è„‰å†²ç‰¹æ•ˆå¤±è´¥:', error);
            }
        }

        /**
         * æ¸²æŸ“é›·è¾¾å›¾åˆ°æŒ‡å®šçš„ canvas
         * @param {HTMLCanvasElement} canvas - Canvas å…ƒç´ 
         * @param {Object} averages - å¹³å‡å€¼æ•°æ®
         */
        function renderRadarChartToCanvas(canvas, averages) {
            if (!canvas) {
                console.warn('[é›·è¾¾å›¾] âŒ Canvas å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.warn('[é›·è¾¾å›¾] âŒ æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡');
                return;
            }
            
            const labels = currentLang === 'zh' ? ['è¯­è¨€', 'æ¨¡å¼', 'æ·±åº¦', 'æ•ˆç‡', 'é¢‘ç‡'] : ['Lang', 'Pattern', 'Depth', 'Effi', 'Freq'];
            const targetData = [
                averages.L !== undefined && averages.L !== null ? Number(averages.L) : 0,
                averages.P !== undefined && averages.P !== null ? Number(averages.P) : 0,
                averages.D !== undefined && averages.D !== null ? Number(averages.D) : 0,
                averages.E !== undefined && averages.E !== null ? Number(averages.E) : 0,
                averages.F !== undefined && averages.F !== null ? Number(averages.F) : 0
            ];
            const zeroData = [0, 0, 0, 0, 0];

            const chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: zeroData,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        borderWidth: 1,
                        pointRadius: 2
                    }]
                },
                options: {
                    animation: {
                        duration: 900,
                        easing: 'easeOutQuart',
                        animateScale: true,
                        animateRotate: true
                    },
                    scales: {
                        r: {
                            angleLines: { color: '#27272a' },
                            grid: { color: '#27272a' },
                            pointLabels: { color: '#71717a', font: { size: 9 } },
                            ticks: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // è§¦å‘ä¸€æ¬¡ updateï¼Œè®©é›·è¾¾å›¾ä»ä¸­å¿ƒæ‰©å¼ åˆ°çœŸå®å€¼
            try {
                chart.data.datasets[0].data = targetData;
                chart.update();
            } catch (e) {
                console.warn('[é›·è¾¾å›¾] âš ï¸ update åŠ¨ç”»è§¦å‘å¤±è´¥:', e);
            }
            
            return chart;
        }

        function renderRadarChart(averages) {
            // ã€ID å­˜åœ¨æ€§æ£€æŸ¥ã€‘åœ¨æ‰§è¡Œå‰ï¼Œå¿…é¡»æ£€æŸ¥ document.getElementById æ˜¯å¦éç©º
            const radarCanvas = document.getElementById('radarChart');
            if (!radarCanvas) {
                console.warn('[é›·è¾¾å›¾] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            const ctx = radarCanvas.getContext('2d');
            if (!ctx) {
                console.warn('[é›·è¾¾å›¾] âŒ æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡');
                return;
            }
            
            if (radarChart) radarChart.destroy();

            const labels = currentLang === 'zh' ? ['è¯­è¨€', 'æ¨¡å¼', 'æ·±åº¦', 'æ•ˆç‡', 'é¢‘ç‡'] : ['Lang', 'Pattern', 'Depth', 'Effi', 'Freq'];
            // ã€é›·è¾¾å›¾æ•°æ®æ ¼å¼ã€‘æ›´æ–° globalRadarChart æ—¶ï¼Œä¼ å…¥ [stats.L, stats.P, stats.D, stats.E, stats.F]
            // å½»åº•åˆ é™¤ç¡¬ç¼–ç ï¼Œå¦‚æœæ¥å£æœ‰å€¼åˆ™å¿…é¡»æ˜¾ç¤ºæ¥å£çš„å€¼
            const targetData = [
                averages.L !== undefined && averages.L !== null ? Number(averages.L) : 0,
                averages.P !== undefined && averages.P !== null ? Number(averages.P) : 0,
                averages.D !== undefined && averages.D !== null ? Number(averages.D) : 0,
                averages.E !== undefined && averages.E !== null ? Number(averages.E) : 0,
                averages.F !== undefined && averages.F !== null ? Number(averages.F) : 0
            ];
            const zeroData = [0, 0, 0, 0, 0];

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: zeroData,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        borderWidth: 1,
                        pointRadius: 2
                    }]
                },
                options: {
                    animation: {
                        duration: 900,
                        easing: 'easeOutQuart',
                        animateScale: true,
                        animateRotate: true
                    },
                    scales: {
                        r: {
                            angleLines: { color: '#27272a' },
                            grid: { color: '#27272a' },
                            pointLabels: { color: '#71717a', font: { size: 9 } },
                            ticks: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // è§¦å‘ä¸€æ¬¡ updateï¼Œè®©é›·è¾¾å›¾ä»ä¸­å¿ƒæ‰©å¼ åˆ°çœŸå®å€¼
            try {
                radarChart.data.datasets[0].data = targetData;
                radarChart.update();
            } catch (e) {
                console.warn('[é›·è¾¾å›¾] âš ï¸ update åŠ¨ç”»è§¦å‘å¤±è´¥:', e);
            }
        }

        function renderLocationList(data) {
            const list = document.getElementById('locationList');
            if (!data || data.length === 0) return;
            
            list.innerHTML = data.slice(0, 5).map((item, i) => {
                const name = countryNameMap[item.name] ? countryNameMap[item.name][currentLang] : item.name;
                return `
                <div class="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2">
                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                    <span class="font-bold uppercase tracking-tighter">${name}</span>
                    <span class="text-[var(--accent-terminal)] font-bold">${item.value}</span>
                </div>`;
            }).join('');

            // ä¿®å¤ï¼štop-country å…ƒç´ å·²ç§»é™¤ï¼Œæ·»åŠ  null æ£€æŸ¥
            const topCountryEl = document.getElementById('top-country');
            if (topCountryEl && data.length > 0) {
                const top = data[0];
                topCountryEl.innerText = countryNameMap[top.name] ? countryNameMap[top.name][currentLang] : top.name;
            }
        }

        /**
         * åˆ¤æ–­ç”¨æˆ·åæ˜¯å¦ä¸ºæœ‰æ•ˆGitHubç”¨æˆ·å
         * @param {string} username - ç”¨æˆ·å
         * @returns {boolean} æ˜¯å¦ä¸ºæœ‰æ•ˆç”¨æˆ·å
         */
        function isValidGitHubUsername(username, userIdentity = null) {
            if (!username || typeof username !== 'string') {
                return false;
            }
            const trimmed = username.trim();
            if (trimmed === '') {
                return false;
            }
            
            // ã€Task 3ã€‘ä¼˜åŒ–ç”¨æˆ·ååˆæ³•æ€§æ ¡éªŒï¼šå¦‚æœæ˜¯ fingerprint ç”¨æˆ·ï¼ˆåŒ¿åç”¨æˆ·ï¼‰ï¼Œè·³è¿‡ä¸¥æ ¼çš„ GitHub æ ¼å¼æ ¡éªŒ
            if (userIdentity === 'fingerprint' || userIdentity === 'anonymous') {
                // å¯¹äºåŒ¿åç”¨æˆ·ï¼ŒåªåšåŸºæœ¬æ£€æŸ¥ï¼Œå…è®¸ä¸­æ–‡ç­‰ç‰¹æ®Šå­—ç¬¦
                console.log('[GitHub] â„¹ï¸ æ£€æµ‹åˆ° fingerprint ç”¨æˆ·ï¼Œè·³è¿‡ä¸¥æ ¼æ ¼å¼æ ¡éªŒ:', trimmed);
                // åªæ£€æŸ¥æ˜¯å¦ä¸ºæ— æ•ˆçš„é»˜è®¤å€¼
                if (INVALID_USERNAME_VALUES.includes(trimmed)) {
                    return false;
                }
                // å…è®¸åŒ…å«ä¸­æ–‡å’Œå…¶ä»–å­—ç¬¦
                return trimmed.length > 0;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ— æ•ˆçš„é»˜è®¤å€¼
            if (INVALID_USERNAME_VALUES.includes(trimmed)) {
                return false;
            }
            // æ£€æŸ¥æ˜¯å¦ä»¥ 'Guest_' å¼€å¤´ï¼ˆè‡ªåŠ¨ç”Ÿæˆçš„è®¿å®¢ç”¨æˆ·åï¼‰
            if (trimmed.startsWith('Guest_')) {
                return false;
            }
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼ˆGitHubç”¨æˆ·åä¸æ”¯æŒä¸­æ–‡ï¼‰
            if (/[\u4e00-\u9fa5]/.test(trimmed)) {
                console.warn('[GitHub] âš ï¸ GitHubç”¨æˆ·åä¸èƒ½åŒ…å«ä¸­æ–‡å­—ç¬¦:', trimmed);
                return false;
            }
            // GitHubç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦å’Œä¸‹åˆ’çº¿
            // å¿…é¡»ä»¥å­—æ¯æˆ–æ•°å­—å¼€å¤´ï¼Œé•¿åº¦åœ¨1-39ä¹‹é—´
            const githubUsernamePattern = /^[a-zA-Z0-9]([a-zA-Z0-9]|-(?![.-])){0,38}$/;
            if (!githubUsernamePattern.test(trimmed)) {
                console.warn('[GitHub] âš ï¸ GitHubç”¨æˆ·åæ ¼å¼æ— æ•ˆ:', trimmed);
                return false;
            }
            return true;
        }

        /**
         * è·å–GitHubå¤´åƒURL
         * @param {string} username - GitHubç”¨æˆ·å
         * @returns {string|null} å¤´åƒURLï¼Œå¦‚æœç”¨æˆ·åæ— æ•ˆåˆ™è¿”å›null
         */
        function getGitHubAvatarUrl(username) {
            // å¦‚æœç”¨æˆ·åæ— æ•ˆï¼Œè¿”å›nullï¼ˆä¸è¯·æ±‚GitHubå›¾ç‰‡ï¼‰
            if (!isValidGitHubUsername(username)) {
                return null;
            }
            // GitHubå¤´åƒURLæ ¼å¼: https://github.com/[ç”¨æˆ·å].png
            return `https://github.com/${username.trim()}.png`;
        }

        /**
         * åˆ›å»ºå¤´åƒHTMLï¼ŒåŒ…å«onerrorå…œåº•é€»è¾‘
         * @param {string} avatarUrl - å¤´åƒURL
         * @param {string} username - GitHubç”¨æˆ·åï¼ˆç”¨äºidenticonï¼‰
         * @param {number} size - å¤´åƒå°ºå¯¸ï¼ˆåƒç´ ï¼‰
         * @returns {string} å¤´åƒHTMLå­—ç¬¦ä¸²
         */
        function createAvatarHtml(avatarUrl, username, size = 32, userIdentity = null) {
            // ã€ä¿®å¤ã€‘å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒURLï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤å¤´åƒ
            // å¦‚æœ username ä¸º null æˆ–æ— æ•ˆï¼Œä¹Ÿä½¿ç”¨é»˜è®¤å¤´åƒï¼ˆä¸è¿›è¡Œä¸¥æ ¼æ ¡éªŒï¼‰
            if (!avatarUrl) {
                return `<img 
                    src="${DEFAULT_AVATAR}" 
                    alt="avatar" 
                    class="rounded-full" 
                    width="${size}" 
                    height="${size}" 
                    loading="lazy" 
                    style="object-fit: cover;"
                    onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                />`;
            }
            
            // åªæœ‰å½“ username å­˜åœ¨ä¸”éœ€è¦æ ¡éªŒæ—¶æ‰è¿›è¡Œæ ¡éªŒ
            // å¦‚æœ username ä¸º nullï¼Œè¯´æ˜æ˜¯åŒ¿åç”¨æˆ·ï¼Œç›´æ¥ä½¿ç”¨æä¾›çš„ avatarUrl
            if (username && !isValidGitHubUsername(username, userIdentity)) {
                // ç”¨æˆ·åæ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                return `<img 
                    src="${DEFAULT_AVATAR}" 
                    alt="avatar" 
                    class="rounded-full" 
                    width="${size}" 
                    height="${size}" 
                    loading="lazy" 
                    style="object-fit: cover;"
                    onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                />`;
            }

            // å¦‚æœæœ‰æœ‰æ•ˆçš„å¤´åƒURLï¼Œä½¿ç”¨å®ƒï¼Œä½†onerroræ—¶å›é€€åˆ°DEFAULT_AVATAR
            return `<img 
                src="${avatarUrl}" 
                alt="avatar" 
                class="rounded-full" 
                width="${size}" 
                height="${size}" 
                loading="lazy" 
                style="object-fit: cover;"
                onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
            />`;
        }

        function renderRecentActivity(victims) {
            const box = document.getElementById('recentActivity');
            if (!box) return;
            
            // ä¼˜å…ˆä½¿ç”¨ latestRecordsï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ recentVictims
            const records = victims || [];
            
            if (records.length === 0) {
                box.innerHTML = '<div class="text-zinc-500 text-center py-4">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            box.innerHTML = records.map((v, index) => {
                // å…¼å®¹ä¸¤ç§æ•°æ®æ ¼å¼ï¼šlatestRecords å’Œ recentVictims
                const time = v.time || v.created_at || new Date().toISOString();
                const type = v.type || v.personality_type || 'UNKNOWN';
                const location = v.location || v.ip_location || 'æœªçŸ¥';
                const name = v.name || `è®°å½•${index + 1}`;
                
                // è·å–å¤´åƒä¿¡æ¯
                const avatarUrl = v.avatar_url || null;
                const githubUsername = v.github_username || null;
                
                // åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœ github_username ä¸ºç©ºã€æˆ–è€…æ˜¯é»˜è®¤å€¼ï¼Œåˆ™ä¸è¦è¯·æ±‚ GitHub å›¾ç‰‡
                // ã€Task 3ã€‘ä¼ å…¥ user_identityï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                const recordUserIdentity = v.user_identity || null;
                let finalAvatarUrl = avatarUrl;
                if (!finalAvatarUrl && githubUsername) {
                    if (isValidGitHubUsername(githubUsername, recordUserIdentity)) {
                        // åªæœ‰æœ‰æ•ˆçš„GitHubç”¨æˆ·åæ‰ç”Ÿæˆå¤´åƒURL
                        finalAvatarUrl = getGitHubAvatarUrl(githubUsername);
                    } else {
                        // æ— æ•ˆç”¨æˆ·åæ—¶ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                        finalAvatarUrl = DEFAULT_AVATAR;
                    }
                }
                // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒURLï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                if (!finalAvatarUrl) {
                    finalAvatarUrl = DEFAULT_AVATAR;
                }
                
                // ã€ä¿®å¤ã€‘finalUsername åº”è¯¥ä½¿ç”¨ githubUsernameï¼ˆå¦‚æœæœ‰æ•ˆï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ name
                // ä½†ä¼ ç»™ createAvatarHtml æ—¶ï¼Œåº”è¯¥åªä¼ æœ‰æ•ˆçš„ GitHub ç”¨æˆ·åæˆ– null
                // å› ä¸º createAvatarHtml ä¼šæ ¡éªŒç”¨æˆ·åï¼Œè€Œ name å¯èƒ½æ˜¯"è®°å½•1"è¿™æ ·çš„å€¼
                const finalUsername = githubUsername || name;
                const usernameForAvatar = githubUsername && isValidGitHubUsername(githubUsername, recordUserIdentity) 
                    ? githubUsername 
                    : null;
                
                // ç”Ÿæˆå¤´åƒHTMLï¼ˆåªä¼ æœ‰æ•ˆçš„ GitHub ç”¨æˆ·åï¼Œé¿å…æ ¡éªŒè­¦å‘Šï¼‰
                // ã€ä¿®å¤ã€‘ä¼ å…¥ user_identity å‚æ•°ï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                const avatarHtml = createAvatarHtml(finalAvatarUrl, usernameForAvatar, 32, recordUserIdentity);
                
                return `
                <div class="border-l-2 border-zinc-800 pl-3 py-1 flex items-start gap-2">
                    <div class="flex-shrink-0 mt-0.5">
                        ${avatarHtml}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-zinc-500">${new Date(time).toLocaleTimeString()}</div>
                        <div class="text-white">${name.length > 6 ? name.slice(0,6) + '...' : name}</div>
                        <div class="text-[var(--accent-terminal)]">${type} @ ${location}</div>
                    </div>
                </div>
            `;
            }).join('');
        }


        /**
         * æ›´æ–°ä¸“å®¶å¡ç‰‡ UI
         * @param {string} dim - ç»´åº¦æ ‡è¯† (L, P, D, E, F)
         * @param {Object|null} expert - ä¸“å®¶æ•°æ®å¯¹è±¡
         * @param {boolean} isNoDataArea - æ˜¯å¦ä¸ºæ— äººåŒºçŠ¶æ€ï¼ˆtrue æ—¶æ˜¾ç¤º"å¾…æ‹›å‹Ÿ"ï¼‰
         */
        function updateExpertCard(dim, expert, isNoDataArea = false) {
            // é˜²å¾¡æ€§ç¼–ç¨‹ï¼šæ‰€æœ‰ DOM æ“ä½œå‰å…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const card = document.getElementById(`card-${dim}`);
            if (!card) {
                console.warn(`[LPDEF] âš ï¸ å¡ç‰‡ card-${dim} ä¸å­˜åœ¨`);
                return;
            }
            
            const avatarEl = document.getElementById(`expert-avatar-${dim}`);
            const nameEl = document.getElementById(`expert-name-${dim}`);
            const titleEl = document.getElementById(`expert-title-${dim}`);
            const scoreEl = document.getElementById(`expert-score-${dim}`);
            const labelEl = document.getElementById(`expert-label-${dim}`);
            const descEl = document.getElementById(`expert-desc-${dim}`);

            if (expert) {
                // æ›´æ–°å¤´åƒ
                if (avatarEl) {
                    let avatarUrl = DEFAULT_AVATAR;
                    
                    // ä¼˜å…ˆçº§ 1: å¦‚æœæœ‰ GitHub IDï¼Œä½¿ç”¨ GitHub å¤´åƒ
                    // ã€Task 3ã€‘ä¼ å…¥ user_identityï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                    const expertUserIdentity = expert.user?.user_identity || null;
                    if (expert.githubUsername && isValidGitHubUsername(expert.githubUsername, expertUserIdentity)) {
                        avatarUrl = getGitHubAvatarUrl(expert.githubUsername);
                    } else if (expert.user?.github_username && isValidGitHubUsername(expert.user.github_username, expertUserIdentity)) {
                        // é™çº§ï¼šä» user å¯¹è±¡ä¸­è·å–
                        avatarUrl = getGitHubAvatarUrl(expert.user.github_username);
                    }
                    // ä¼˜å…ˆçº§ 2: å¦‚æœæœ‰ fingerprintï¼Œä½¿ç”¨åŸºäºæŒ‡çº¹çš„å”¯ä¸€å¤´åƒ
                    else if (expert.fingerprint) {
                        avatarUrl = `https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(expert.fingerprint)}`;
                    }
                    // å¦åˆ™ä½¿ç”¨é»˜è®¤å¤´åƒ
                    
                    avatarEl.innerHTML = `<img 
                        src="${avatarUrl}" 
                        alt="${expert.username || 'Expert'}"
                        class="w-full h-full object-cover rounded-full"
                        onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                    />`;
                }

                // æ›´æ–°ç”¨æˆ·å
                if (nameEl) {
                    nameEl.textContent = expert.username || 'Unknown';
                }

                // æ›´æ–°ç§°å·ï¼ˆå·¦ä¸Šè§’ï¼‰- ä½¿ç”¨ç»´åº¦ä¸“å±ç§°å·
                if (labelEl && DIMENSION_TITLES[dim]) {
                    labelEl.textContent = DIMENSION_TITLES[dim].title;
                }
                
                // æ›´æ–°è¯´æ˜ï¼ˆåˆ†æ•°ä¸‹æ–¹ï¼‰- ä½¿ç”¨ç»´åº¦ä¸“å±è¯´æ˜
                if (descEl && DIMENSION_TITLES[dim]) {
                    descEl.textContent = DIMENSION_TITLES[dim].description;
                }
                
                // æ›´æ–° personality_typeï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼Œä½†ä¸åœ¨ä¸»è¦ä½ç½®æ˜¾ç¤ºï¼‰
                if (titleEl) {
                    titleEl.textContent = expert.personalityType || 'UNKNOWN';
                }

                // æ›´æ–°åˆ†æ•°ï¼ˆä½¿ç”¨æå–åˆ°çš„ scoreï¼‰
                if (scoreEl) {
                    scoreEl.textContent = Math.round(expert.score || 0);
                }
                
                // æ¢å¤ç‚¹å‡»äº‹ä»¶ï¼ˆå¦‚æœæœ‰ä¸“å®¶æ•°æ®ï¼‰
                if (card) {
                    card.onclick = () => openExpertGitHub(dim);
                    card.style.cursor = 'pointer';
                }
            } else {
                // æ— æ•°æ®æ—¶çš„æ˜¾ç¤ºï¼ˆåŒ…æ‹¬æ— äººåŒºçŠ¶æ€ï¼‰
                // ä¿æŒç§°å·å’Œè¯´æ˜ï¼ˆç»´åº¦ä¸“å±ï¼‰
                if (labelEl && DIMENSION_TITLES[dim]) {
                    labelEl.textContent = DIMENSION_TITLES[dim].title;
                }
                
                if (descEl && DIMENSION_TITLES[dim]) {
                    descEl.textContent = DIMENSION_TITLES[dim].description;
                }
                
                if (avatarEl) {
                    // æ— äººåŒºçŠ¶æ€ï¼šä½¿ç”¨é»˜è®¤å¤´åƒ
                    avatarEl.innerHTML = `<img 
                        src="${DEFAULT_AVATAR}" 
                        alt="å¾…æ‹›å‹Ÿ"
                        class="w-full h-full object-cover rounded-full opacity-50"
                    />`;
                }
                
                if (nameEl) {
                    nameEl.textContent = isNoDataArea ? 'å¾…æ‹›å‹Ÿ' : 'æš‚æ— æ•°æ®';
                }
                
                if (titleEl) {
                    titleEl.textContent = isNoDataArea ? 'ç­‰å¾…åŠ å…¥' : '...';
                }
                
                if (scoreEl) {
                    scoreEl.textContent = '0';
                }
                
                // æ— äººåŒºçŠ¶æ€ï¼šå–æ¶ˆç‚¹å‡»è·³è½¬äº‹ä»¶
                if (card) {
                    card.onclick = null;
                    card.style.cursor = 'default';
                }
            }
        }

        /**
         * æ‰“å¼€ä¸“å®¶çš„ GitHub ä¸»é¡µ
         * @param {string} dim - ç»´åº¦æ ‡è¯† (L, P, D, E, F)
         */
        function openExpertGitHub(dim) {
            const expert = lpdefExperts[dim];
            if (expert && expert.githubUsername && isValidGitHubUsername(expert.githubUsername)) {
                window.open(`https://github.com/${expert.githubUsername}`, '_blank');
            } else if (expert && expert.user && expert.user.github_username && isValidGitHubUsername(expert.user.github_username)) {
                window.open(`https://github.com/${expert.user.github_username}`, '_blank');
            } else {
                console.warn(`[LPDEF] âš ï¸ ç»´åº¦ ${dim} çš„ä¸“å®¶æ²¡æœ‰æœ‰æ•ˆçš„ GitHub ç”¨æˆ·å`);
            }
        }

        /**
         * æ¸²æŸ“äººæ ¼åˆ†å¸ƒæ’è¡Œ
         * @param {Array} distribution - äººæ ¼åˆ†å¸ƒæ•°æ® [{type: string, count: number}]
         */
        function renderPersonalityDistribution(distribution) {
            const list = document.getElementById('personalityDistribution');
            if (!list) return;
            
            if (!distribution || !Array.isArray(distribution) || distribution.length === 0) {
                list.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            list.innerHTML = distribution.map((item, i) => {
                const type = item.type || 'UNKNOWN';
                const count = Number(item.count) || 0;
                return `
                <div class="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2">
                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                    <span class="font-bold uppercase tracking-tighter">${type}</span>
                    <span class="text-[var(--accent-terminal)] font-bold">${count}</span>
                </div>`;
            }).join('');
        }

        /**
         * ã€é€‚é…å±‚é‡å†™ã€‘å¼ºåˆ¶æ˜ å°„å±‚ï¼šä»å¤šä¸ªå¯èƒ½çš„å­—æ®µè·¯å¾„æå–æ•°æ®
         * @param {Object} result - API è¿”å›çš„åŸå§‹æ•°æ®
         * @returns {Object} æ ‡å‡†åŒ–åçš„æ•°æ®å¯¹è±¡
         */
        function normalizeData(result) {
            const data = result || {};
            
            // ã€æ ¸å¿ƒæŒ‡æ ‡æå–ã€‘ä» json.totalAnalysis æå–æ€»æ‰«ææ•°ï¼Œä» json.totalUsers æå–æ€»äººæ•°
            let totalAnalysis = data.totalAnalysis;
            if (totalAnalysis === undefined || totalAnalysis === null) {
                totalAnalysis = data.data?.totalAnalysis;
            }
            if (totalAnalysis === undefined || totalAnalysis === null) {
                const recentVictims = data.recentVictims || data.latestRecords || [];
                totalAnalysis = recentVictims.length;
            }
            
            // ã€æ€»äººæ•°æå–ã€‘ä» json.totalUsers æå–
            const totalUsers = data.totalUsers || 0;
            
            // ã€ç´¯è®¡åæ§½å­—æ•°ä¿®å¤ã€‘ä¸è¦è¯»å– json.totalRoastWordsï¼ˆå®ƒæ˜¯ 0ï¼‰ï¼Œè¯·å°è¯•ä» json.totalChars æˆ– json.latestRecords[0].total_chars è·å–æ•°æ®
            let totalRoastWords = data.totalChars;
            if (totalRoastWords === undefined || totalRoastWords === null || totalRoastWords === 0) {
                // å°è¯•ä» latestRecords ä¸­è·å–
                const latestRecords = data.latestRecords || data.recentVictims || [];
                if (latestRecords.length > 0 && latestRecords[0].total_chars) {
                    totalRoastWords = latestRecords[0].total_chars;
                }
            }
            // æœ€åå…œåº•ï¼šå¦‚æœè¿˜æ˜¯ 0 æˆ–æœªå®šä¹‰ï¼Œå°è¯•å…¶ä»–è·¯å¾„
            if (totalRoastWords === undefined || totalRoastWords === null || totalRoastWords === 0) {
                totalRoastWords = data.totalRoastWords || data.data?.total_roast_words || 0;
            }
            
            // ã€å¼ºåˆ¶æ˜ å°„å±‚ã€‘avgPerUser å’Œ avgPerScanï¼šä¾æ¬¡å°è¯• result.avgPerUser/avgPerScan, result.data.avgPerUser/avgPerScan
            let avgPerUser = data.avgPerUser;
            if (avgPerUser === undefined || avgPerUser === null) {
                avgPerUser = data.data?.avgPerUser;
            }
            // å…¼å®¹æ—§å­—æ®µå
            if (avgPerUser === undefined || avgPerUser === null) {
                avgPerUser = data.avgChars;
            }
            
            let avgPerScan = data.avgPerScan;
            if (avgPerScan === undefined || avgPerScan === null) {
                avgPerScan = data.data?.avgPerScan;
            }
            
            // ã€äº”ç»´å¹³å‡åˆ†æå–ã€‘å¿…é¡»ä» json.averages æˆ– json.globalAverage å¯¹è±¡ä¸­æå–ï¼ˆä¾‹å¦‚ï¼šjson.averages.Lï¼‰
            // å½»åº•åˆ é™¤ç¡¬ç¼–ç ï¼Œå¦‚æœæ¥å£æœ‰å€¼åˆ™å¿…é¡»æ˜¾ç¤ºæ¥å£çš„å€¼
            let averages = data.averages || data.globalAverage;
            if (!averages || typeof averages !== 'object') {
                averages = {};
            }
            // ç¡®ä¿æ‰€æœ‰ç»´åº¦éƒ½æœ‰å€¼ï¼Œä½†ä¸ä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼
            averages = {
                L: averages.L !== undefined && averages.L !== null ? Number(averages.L) : undefined,
                P: averages.P !== undefined && averages.P !== null ? Number(averages.P) : undefined,
                D: averages.D !== undefined && averages.D !== null ? Number(averages.D) : undefined,
                E: averages.E !== undefined && averages.E !== null ? Number(averages.E) : undefined,
                F: averages.F !== undefined && averages.F !== null ? Number(averages.F) : undefined
            };
            
            // ä¸ºäº†å…¼å®¹æ€§ï¼ŒåŒæ—¶è®¾ç½® globalAverage
            const globalAverage = averages;
            
            // ã€ä¸Šå²—å¤©æ•°ä¿®å¤ã€‘ä» json.systemDays æˆ– json.latestRecords[0].work_days æå–ï¼Œä¸ç¡¬ç¼–ç 
            let systemDays = data.systemDays;
            if (systemDays === undefined || systemDays === null) {
                const latestRecords = data.latestRecords || data.recentVictims || [];
                if (latestRecords.length > 0 && latestRecords[0].work_days !== undefined && latestRecords[0].work_days !== null) {
                    systemDays = latestRecords[0].work_days;
                }
            }
            
            // ã€ç´¯è®¡åæ§½å­—æ•°ä¿®å¤ã€‘ç»‘å®šåˆ° json.totalChars
            const totalChars = data.totalChars !== undefined && data.totalChars !== null ? Number(data.totalChars) : (totalRoastWords !== undefined && totalRoastWords !== null ? Number(totalRoastWords) : undefined);
            
            // ã€å¹³å‡ç¯‡å¹…ä¿®å¤ã€‘ç»‘å®šåˆ° json.totalChars / json.totalAnalysis
            let calculatedAvgPerScan = undefined;
            if (totalChars !== undefined && totalAnalysis !== undefined && totalAnalysis !== null && totalAnalysis > 0) {
                calculatedAvgPerScan = totalChars / totalAnalysis;
            }
            // å¦‚æœæ¥å£æä¾›äº† avgPerScanï¼Œä¼˜å…ˆä½¿ç”¨æ¥å£å€¼
            if (avgPerScan === undefined || avgPerScan === null) {
                avgPerScan = calculatedAvgPerScan;
            }
            
            return {
                totalUsers: totalUsers !== undefined && totalUsers !== null ? totalUsers : undefined,
                totalAnalysis: totalAnalysis !== undefined && totalAnalysis !== null ? totalAnalysis : undefined,
                totalRoastWords: totalRoastWords !== undefined && totalRoastWords !== null ? totalRoastWords : undefined,
                totalChars: totalChars,
                avgPerUser: avgPerUser !== undefined && avgPerUser !== null ? avgPerUser : undefined,
                avgPerScan: avgPerScan !== undefined && avgPerScan !== null ? avgPerScan : undefined,
                cityCount: data.cityCount !== undefined && data.cityCount !== null ? data.cityCount : undefined,
                systemDays: systemDays !== undefined && systemDays !== null ? systemDays : undefined,
                personalityRank: data.personalityRank || data.personalityDistribution || [],
                personalityDistribution: data.personalityDistribution || data.personalityRank || [],
                globalAverage: globalAverage,
                averages: averages,
                locationRank: data.locationRank || [],
                recentVictims: data.recentVictims || data.latestRecords || [],
                latestRecords: data.latestRecords || data.recentVictims || [],
                // ã€æ–°å¢ã€‘ä¿å­˜å„ç»´åº¦çš„æœ€é«˜è®°å½•ï¼ˆç”¨äº"å…¨çƒæœ€å¼ºæ¨¡å¼"ï¼‰
                topRecords: data.topRecords || {},
            };
        }

        /**
         * ã€åŠ¨ç”»å®¹é”™ã€‘å®‰å…¨çš„åŠ¨ç”»å‡½æ•°ï¼Œé˜²æ­¢ NaN æˆ– undefined å¯¼è‡´å´©æºƒ
         * @param {HTMLElement} element - ç›®æ ‡å…ƒç´ 
         * @param {number} start - èµ·å§‹å€¼
         * @param {number} end - ç»“æŸå€¼
         * @param {number} duration - åŠ¨ç”»æŒç»­æ—¶é—´
         * @param {boolean} useFormat - æ˜¯å¦ä½¿ç”¨æ ¼å¼åŒ–
         */
        function safeAnimateValue(element, start, end, duration = 1500, useFormat = true) {
            if (!element) {
                console.warn('[åŠ¨ç”»] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // ã€åŠ¨ç”»å®¹é”™ã€‘åœ¨è°ƒç”¨ animateValue ä¹‹å‰ï¼Œæ·»åŠ  if (isNaN(value)) value = 0; çš„åˆ¤æ–­
            if (isNaN(start)) start = 0;
            if (isNaN(end)) end = 0;
            
            start = Number(start) || 0;
            end = Number(end) || 0;
            
            animateValue(element, start, end, duration, useFormat);
        }

        /**
         * ã€äººæ ¼æ’è¡Œæ¸²æŸ“å‡½æ•°ã€‘ç‹¬ç«‹çš„ renderPersonalityRank å‡½æ•°ï¼ŒåŒ…å«å‰ç«¯è‡ªè®¡ç®—é™çº§é€»è¾‘
         * @param {Array} rankData - äººæ ¼æ’è¡Œæ•°æ® [{type, count, percentage}]
         * @param {Array} recentVictims - æœ€è¿‘å—å®³è€…æ•°æ®ï¼ˆç”¨äºé™çº§è®¡ç®—ï¼‰
         */
        function renderPersonalityRank(rankData, recentVictims = []) {
            const personalityEl = document.getElementById('personalityDistribution');
            if (!personalityEl) {
                console.warn('[äººæ ¼æ’è¡Œ] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // å¦‚æœåç«¯ personalityRank å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œç›´æ¥æ¸²æŸ“
            if (rankData && Array.isArray(rankData) && rankData.length > 0) {
                personalityEl.innerHTML = rankData.map((item, i) => {
                    const type = item.type || 'æœªçŸ¥';
                    const count = Number(item.count || 0);
                    const percentage = Number(item.percentage || 0);
                    return `
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                <span class="text-zinc-400">${i+1}. ${type}</span>
                                <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                            </div>
                            <div class="w-full bg-zinc-800/50 h-1">
                                <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                console.log(`[äººæ ¼æ’è¡Œ] âœ… æ¸²æŸ“æˆåŠŸ (${rankData.length} æ¡)`);
                return;
            }
            
            // ã€å‰ç«¯è‡ªè®¡ç®—é™çº§é€»è¾‘ã€‘è‹¥åç«¯ personalityRank ä¸ºç©ºï¼Œåˆ™æ ¹æ® recentVictims å®æ—¶è®¡ç®—å æ¯”å¹¶æ¸²æŸ“è¿›åº¦æ¡
            if (recentVictims && recentVictims.length > 0) {
                console.log('[äººæ ¼æ’è¡Œ] âš ï¸ personalityRank ä¸ºç©ºï¼Œä½¿ç”¨ recentVictims é™çº§æ–¹æ¡ˆ');
                const typeMap = new Map();
                recentVictims.forEach((v) => {
                    const type = v.type || v.personality_type || 'UNKNOWN';
                    typeMap.set(type, (typeMap.get(type) || 0) + 1);
                });
                
                const total = recentVictims.length;
                const personalityRank = Array.from(typeMap.entries())
                    .map(([type, count]) => ({
                        type: type,
                        count: Number(count) || 0,
                        percentage: Math.round((Number(count) / total) * 100) || 0,
                    }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                personalityEl.innerHTML = personalityRank.map((item, i) => {
                    const type = item.type || 'æœªçŸ¥';
                    const count = Number(item.count || 0);
                    const percentage = Number(item.percentage || 0);
                    return `
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                <span class="text-zinc-400">${i+1}. ${type}</span>
                                <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                            </div>
                            <div class="w-full bg-zinc-800/50 h-1">
                                <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                console.log(`[äººæ ¼æ’è¡Œ] âœ… é™çº§æ–¹æ¡ˆæ¸²æŸ“æˆåŠŸ (${personalityRank.length} æ¡)`);
                return;
            }
            
            // å¦‚æœéƒ½æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            personalityEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
            console.warn('[äººæ ¼æ’è¡Œ] âŒ æ— å¯ç”¨æ•°æ®');
        }

        /**
         * å¯åŠ¨ Supabase Realtime ç›‘å¬
         * ç›‘å¬ user_analysis è¡¨çš„ INSERT äº‹ä»¶
         */
        function startRealtimeListener() {
            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                console.warn('[Realtime] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè·³è¿‡ Realtime ç›‘å¬');
                return;
            }

            // å¦‚æœå·²æœ‰ç›‘å¬é€šé“ï¼Œå…ˆå–æ¶ˆè®¢é˜…
            if (realtimeChannel) {
                try {
                    supabaseClient.removeChannel(realtimeChannel);
                    console.log('[Realtime] âœ… å·²å–æ¶ˆæ—§çš„ç›‘å¬é€šé“');
                } catch (error) {
                    console.warn('[Realtime] âš ï¸ å–æ¶ˆæ—§é€šé“æ—¶å‡ºé”™:', error);
                }
            }

            try {
                // åˆ›å»ºæ–°çš„ç›‘å¬é€šé“
                realtimeChannel = supabaseClient
                    .channel('user_analysis_changes')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'user_analysis'
                        },
                        (payload) => {
                            console.log('[Realtime] ğŸ“¨ æ”¶åˆ°æ–°æ•°æ®:', payload);
                            
                            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ payload å’Œ payload.new å­˜åœ¨
                            if (!payload || !payload.new) {
                                console.warn('[Realtime] âš ï¸ æ•°æ®æ ¼å¼ä¸å®Œæ•´ï¼Œè·³è¿‡å¤„ç†');
                                return;
                            }

                            const newRecord = payload.new;
                            
                            // å±€éƒ¨æ›´æ–°ï¼šå°†æ–°æ•°æ®æ’å…¥åˆ° latestRecords æœ€å‰é¢
                            if (!Array.isArray(latestRecords)) {
                                latestRecords = [];
                            }
                            
                            latestRecords.unshift(newRecord);
                            
                            // é•¿åº¦æ§åˆ¶ï¼šä¿æŒæ•°ç»„é•¿åº¦ä¸è¶…è¿‡ 10
                            if (latestRecords.length > 10) {
                                latestRecords = latestRecords.slice(0, 10);
                            }

                            // åŒæ­¥æ›´æ–° window.allDataï¼ˆç”¨äº LPDEF ä¸“å®¶ç­›é€‰ï¼‰
                            if (!window.allData) {
                                window.allData = [];
                            }
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
                            const exists = window.allData.some(item => 
                                (item.id && newRecord.id && item.id === newRecord.id) ||
                                (item.name === newRecord.name && item.created_at === newRecord.created_at)
                            );
                            if (!exists) {
                                window.allData.unshift(newRecord);
                                // é™åˆ¶ allData é•¿åº¦ï¼ˆä¿ç•™æœ€è¿‘ 1000 æ¡ï¼Œé¿å…å†…å­˜è¿‡å¤§ï¼‰
                                if (window.allData.length > 1000) {
                                    window.allData = window.allData.slice(0, 1000);
                                }
                            }
                            
                            console.log(`[Realtime] âœ… å·²æ›´æ–° latestRecords (å½“å‰é•¿åº¦: ${latestRecords.length})ï¼Œwindow.allData (å½“å‰é•¿åº¦: ${window.allData.length})`);

                            // é‡æ–°æ¸²æŸ“å³ä¾§å¡ç‰‡åˆ—è¡¨
                            try {
                                renderRecentActivity(latestRecords);
                                console.log('[Realtime] âœ… å·²åˆ·æ–°å®æ—¶è¯Šæ–­æ´»åŠ¨åˆ—è¡¨');
                            } catch (error) {
                                console.error('[Realtime] âŒ æ¸²æŸ“æ´»åŠ¨åˆ—è¡¨å¤±è´¥:', error);
                            }
                            
                            // Realtime æ›´æ–°åä¸å†éœ€è¦é‡æ–°æ¸²æŸ“ LPDEF å¡ç‰‡ï¼ˆå·²åºŸå¼ƒï¼‰

                            // åœ°å›¾è”åŠ¨ç‰¹æ•ˆï¼šå¦‚æœæ–°æ•°æ®åŒ…å«åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œè§¦å‘åœ°å›¾è„‰å†²
                            try {
                                // å°è¯•ä»æ–°æ•°æ®ä¸­æå–ç»çº¬åº¦ä¿¡æ¯
                                // æ ¹æ®å®é™…æ•°æ®å­—æ®µè°ƒæ•´ï¼ˆå¯èƒ½æ˜¯ lng/lat, longitude/latitude, location ç­‰ï¼‰
                                let lng = null;
                                let lat = null;
                                let vibeName = '';

                                // æ–¹å¼1ï¼šç›´æ¥å­—æ®µï¼ˆä¼˜å…ˆæ£€æŸ¥ç»çº¬åº¦å­—æ®µï¼‰
                                if (newRecord.lng !== undefined && newRecord.lat !== undefined) {
                                    lng = Number(newRecord.lng);
                                    lat = Number(newRecord.lat);
                                } else if (newRecord.longitude !== undefined && newRecord.latitude !== undefined) {
                                    lng = Number(newRecord.longitude);
                                    lat = Number(newRecord.latitude);
                                }
                                // æ–¹å¼2ï¼šä» location æˆ– ip_location å­—æ®µè§£æï¼ˆå¦‚æœåŒ…å«åæ ‡ï¼‰
                                else {
                                    const locationSource = newRecord.location || newRecord.ip_location;
                                    if (locationSource) {
                                        // å°è¯•è§£æ "lng,lat" æ ¼å¼çš„åæ ‡å­—ç¬¦ä¸²
                                        const locationStr = String(locationSource);
                                        const coords = locationStr.split(',');
                                        if (coords.length >= 2) {
                                            const parsedLng = Number(coords[0].trim());
                                            const parsedLat = Number(coords[1].trim());
                                            if (!isNaN(parsedLng) && !isNaN(parsedLat)) {
                                                lng = parsedLng;
                                                lat = parsedLat;
                                            }
                                        }
                                    }
                                }

                                // æå–åç§°ï¼ˆå¯èƒ½æ˜¯ name, vibe_name, personality_type ç­‰ï¼‰
                                const baseName = newRecord.name || newRecord.vibe_name || newRecord.personality_type || '';

                                // VPN ç©¿é€æ£€æµ‹åˆ¤å®šé€»è¾‘ï¼ˆå·²ç§»é™¤VPNå…³é”®å­—æ˜¾ç¤ºï¼‰
                                // =========================
                                let pulseColor = '#ffffff'; // é»˜è®¤ç™½è‰²ï¼ˆæ­£å¸¸ç”¨æˆ·ï¼‰
                                let pulseLabel = baseName ? `${baseName}` : 'ç”¨æˆ·';

                                // è·å–åˆ¤å®šæ‰€éœ€å­—æ®µ
                                const ipLocation = String(newRecord.ip_location || '').toUpperCase().trim();
                                const timezone = String(newRecord.timezone || '').trim();

                                // åˆ¤å®šæ¡ä»¶ï¼šå¦‚æœ ip_location ä¸å±äº 'CN'ï¼Œä½† timezone æ˜¯ 'Asia/Shanghai'ï¼Œåˆ™ä½¿ç”¨ç‰¹æ®Šé¢œè‰²
                                const isNotChina = ipLocation !== 'CN' && ipLocation !== '';
                                const isShanghaiTimezone = timezone === 'Asia/Shanghai';

                                if (isNotChina && isShanghaiTimezone) {
                                    // ç‰¹æ®Šç”¨æˆ·ï¼šæµ·å¤– IP + ä¸Šæµ·æ—¶åŒº
                                    pulseColor = '#00ff41'; // ç»ˆç«¯ç»¿
                                    pulseLabel = baseName ? `${baseName}` : 'ç”¨æˆ·';
                                    console.log('[Realtime] ğŸ” ç”¨æˆ·åˆ¤å®š: æ£€æµ‹åˆ°ç‰¹æ®Šç”¨æˆ·', {
                                        ipLocation,
                                        timezone,
                                        reason: 'æµ·å¤–IPä½†æ—¶åŒºä¸ºAsia/Shanghai'
                                    });
                                } else {
                                    // æ­£å¸¸ç”¨æˆ·ï¼šç›´æ¥è¿æ¥
                                    pulseColor = '#ffffff'; // æ­£å¸¸ç”¨æˆ·ï¼šçº¯ç™½è‰²
                                    pulseLabel = baseName ? `${baseName}` : 'ç”¨æˆ·';
                                    console.log('[Realtime] ğŸ” ç”¨æˆ·åˆ¤å®š: æ­£å¸¸ç”¨æˆ·', {
                                        ipLocation,
                                        timezone,
                                        reason: isNotChina ? 'æ—¶åŒºä¸åŒ¹é…' : 'IPä½ç½®æ­£å¸¸'
                                    });
                                }

                                // å¦‚æœæˆåŠŸæå–åˆ°ç»çº¬åº¦ï¼Œè§¦å‘åœ°å›¾è„‰å†²ï¼ˆä½¿ç”¨åˆ¤å®šåçš„é¢œè‰²å’Œæ ‡ç­¾ï¼‰
                                if (lng !== null && lat !== null && !isNaN(lng) && !isNaN(lat)) {
                                    // æå–å¤´åƒä¿¡æ¯
                                    let avatarUrl = newRecord.avatar_url || null;
                                    const githubUsername = newRecord.github_username || newRecord.github_id || null;
                                    const userName = newRecord.name || newRecord.vibe_name || newRecord.personality_type || '';
                                    
                                    // åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœ github_username ä¸ºç©ºã€æˆ–è€…æ˜¯é»˜è®¤å€¼ï¼Œåˆ™ä¸è¦è¯·æ±‚ GitHub å›¾ç‰‡
                                    // ã€Task 3ã€‘ä¼ å…¥ user_identityï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                                    const recordUserIdentity = newRecord.user_identity || null;
                                    if (!avatarUrl && githubUsername) {
                                        if (isValidGitHubUsername(githubUsername, recordUserIdentity)) {
                                            // åªæœ‰æœ‰æ•ˆçš„GitHubç”¨æˆ·åæ‰ç”Ÿæˆå¤´åƒURL
                                            avatarUrl = getGitHubAvatarUrl(githubUsername);
                                        } else {
                                            // æ— æ•ˆç”¨æˆ·åæ—¶ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                                            avatarUrl = DEFAULT_AVATAR;
                                        }
                                    }
                                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒURLï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                                    if (!avatarUrl) {
                                        avatarUrl = DEFAULT_AVATAR;
                                    }
                                    
                                    // è·å–ç”¨æˆ·çŠ¶æ€é¢œè‰²ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤é¢œè‰²
                                    const statusColor = newRecord.status_color || pulseColor;
                                    
                                    triggerMapPulse(lng, lat, pulseLabel, statusColor, avatarUrl, githubUsername || userName);
                                    console.log(`[Realtime] âœ… å·²è§¦å‘åœ°å›¾è„‰å†²: [${lng}, ${lat}] ${pulseLabel} (é¢œè‰²: ${statusColor}, å¤´åƒ: ${avatarUrl}, ç”¨æˆ·å: ${githubUsername || userName})`);
                                } else {
                                    console.log('[Realtime] â„¹ï¸ æ–°æ•°æ®æœªåŒ…å«æœ‰æ•ˆçš„åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œè·³è¿‡åœ°å›¾è„‰å†²');
                                }
                            } catch (error) {
                                console.warn('[Realtime] âš ï¸ å¤„ç†åœ°å›¾è”åŠ¨ç‰¹æ•ˆæ—¶å‡ºé”™:', error);
                            }
                        }
                    )
                    .on(
                        'postgres_changes',
                        {
                            event: 'UPDATE',
                            schema: 'public',
                            table: 'user_analysis'
                        },
                        (payload) => {
                            console.log('[Realtime] ğŸ”„ æ”¶åˆ°æ•°æ®æ›´æ–°:', payload);
                            
                            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ payload å’Œ payload.new å­˜åœ¨
                            if (!payload || !payload.new) {
                                console.warn('[Realtime] âš ï¸ æ›´æ–°æ•°æ®æ ¼å¼ä¸å®Œæ•´ï¼Œè·³è¿‡å¤„ç†');
                                return;
                            }

                            const updatedRecord = payload.new;
                            
                            // åŒæ­¥æ›´æ–° window.allDataï¼ˆç”¨äºèº«ä»½åŒ¹é…å’Œæ’åå¡ç‰‡ï¼‰
                            if (!window.allData) {
                                window.allData = [];
                            }
                            
                            // æŸ¥æ‰¾å¹¶æ›´æ–°å¯¹åº”çš„è®°å½•
                            const index = window.allData.findIndex(item => 
                                (item.id && updatedRecord.id && item.id === updatedRecord.id) ||
                                (item.fingerprint && updatedRecord.fingerprint && item.fingerprint === updatedRecord.fingerprint) ||
                                (item.user_identity && updatedRecord.user_identity && item.user_identity === updatedRecord.user_identity)
                            );
                            
                            if (index !== -1) {
                                // æ›´æ–°ç°æœ‰è®°å½•
                                window.allData[index] = { ...window.allData[index], ...updatedRecord };
                                console.log(`[Realtime] âœ… å·²æ›´æ–° window.allData ä¸­çš„è®°å½• (ç´¢å¼•: ${index})`);
                            } else {
                                // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ·»åŠ åˆ°æ•°ç»„å‰é¢
                                window.allData.unshift(updatedRecord);
                                // é™åˆ¶ allData é•¿åº¦
                                if (window.allData.length > 1000) {
                                    window.allData = window.allData.slice(0, 1000);
                                }
                                console.log(`[Realtime] âœ… å·²å°†æ›´æ–°è®°å½•æ·»åŠ åˆ° window.allData`);
                            }
                            
                            // æ£€æŸ¥æ›´æ–°çš„è®°å½•æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·ï¼Œå¦‚æœæ˜¯åˆ™åˆ·æ–°æ’åå¡ç‰‡
                            // å®æ—¶æ›´æ–°ï¼šç¡®ä¿å†æ¬¡è§¦å‘ renderRankCards(currentUser)ï¼Œè®©å¡ç‰‡æ•°å­—èƒ½å¤Ÿéšç€æ•°æ®åº“å®æ—¶å˜åŠ¨
                            try {
                                // è¾…åŠ©å‡½æ•°ï¼šè§„èŒƒåŒ–æŒ‡çº¹å­—ç¬¦ä¸²ï¼ˆå¿½ç•¥å¤§å°å†™å¹¶å‰”é™¤é¦–å°¾ç©ºæ ¼ï¼‰
                                const normalizeFingerprint = (fp) => {
                                    if (!fp) return '';
                                    return String(fp).trim().toLowerCase();
                                };
                                
                                // è·å–å½“å‰ç”¨æˆ·çš„æ ‡è¯†ä¿¡æ¯ï¼ˆå¢åŠ å¼‚å¸¸å¤„ç†ï¼‰
                                let localGitHubName = null;
                                let currentFingerprint = null;
                                try {
                                    localGitHubName = localStorage.getItem('github_username');
                                    currentFingerprint = localStorage.getItem('user_fingerprint');
                                } catch (e) {
                                    console.warn('[Realtime] âš ï¸ è¯»å– localStorage å¤±è´¥:', e);
                                }
                                
                                const urlParams = new URLSearchParams(window.location.search);
                                const urlId = urlParams.get('id');
                                
                                // è§„èŒƒåŒ–å½“å‰æŒ‡çº¹
                                const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                                
                                // åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·çš„è®°å½•ï¼ˆä¼˜å…ˆçº§åŒ¹é…ç­–ç•¥ï¼šæŒ‡çº¹ä¼˜å…ˆ > GitHub IDï¼‰
                                let isCurrentUser = false;
                                let matchedByFingerprint = false;
                                
                                // æ–¹å¼1ï¼šé€šè¿‡ URL å‚æ•°åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œç”¨äºè°ƒè¯•ï¼‰
                                if (urlId) {
                                    const recordId = (updatedRecord.id || '').toString();
                                    const recordFingerprint = (updatedRecord.fingerprint || updatedRecord.user_identity || '').toString();
                                    if (recordId === urlId || recordFingerprint === urlId) {
                                        isCurrentUser = true;
                                    }
                                }
                                
                                // æ–¹å¼2ï¼šé€šè¿‡ Fingerprint åŒ¹é…ï¼ˆä¼˜å…ˆäºGitHub IDï¼Œå¿½ç•¥å¤§å°å†™å’Œç©ºæ ¼ï¼‰
                                if (!isCurrentUser && normalizedCurrentFingerprint) {
                                    const recordFingerprint = normalizeFingerprint(updatedRecord.fingerprint || updatedRecord.user_fingerprint);
                                    const recordIdentity = normalizeFingerprint(updatedRecord.user_identity);
                                    
                                    if ((recordFingerprint && recordFingerprint === normalizedCurrentFingerprint) ||
                                        (recordIdentity && recordIdentity === normalizedCurrentFingerprint)) {
                                        isCurrentUser = true;
                                        matchedByFingerprint = true;
                                    }
                                }
                                
                                // æ–¹å¼3ï¼šé€šè¿‡ GitHub ID åŒ¹é…ï¼ˆåœ¨æŒ‡çº¹åŒ¹é…å¤±è´¥åå°è¯•ï¼‰
                                if (!isCurrentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                                    // ã€ä¿®å¤ã€‘ç»Ÿä¸€ä½¿ç”¨ user_name å­—æ®µï¼Œä¸ä½¿ç”¨ github_username
                                    const recordGithubId = normalizeFingerprint(updatedRecord.user_name || updatedRecord.github_id || '');
                                    const normalizedLocalGitHub = normalizeFingerprint(localGitHubName);
                                    if (recordGithubId && recordGithubId === normalizedLocalGitHub) {
                                        isCurrentUser = true;
                                    }
                                }
                                
                                // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·çš„è®°å½•ï¼Œåˆ·æ–°æ’åå¡ç‰‡å’Œå…¨å±€å˜é‡
                                if (isCurrentUser) {
                                    console.log('[Realtime] âœ… æ£€æµ‹åˆ°å½“å‰ç”¨æˆ·æ•°æ®æ›´æ–°ï¼Œåˆ·æ–°æ’åå¡ç‰‡');
                                    
                                    // æ›´æ–°å…¨å±€å˜é‡
                                    window.currentUser = updatedRecord;
                                    window.currentUserMatchedByFingerprint = matchedByFingerprint;
                                    
                                    // æ›´æ–° window.allData ä¸­çš„å¯¹åº”è®°å½•
                                    const allData = window.allData || [];
                                    const updateIndex = allData.findIndex(item => {
                                        const itemFingerprint = normalizeFingerprint(item.fingerprint || item.user_fingerprint);
                                        const itemIdentity = normalizeFingerprint(item.user_identity);
                                        const recordFingerprint = normalizeFingerprint(updatedRecord.fingerprint || updatedRecord.user_fingerprint);
                                        const recordIdentity = normalizeFingerprint(updatedRecord.user_identity);
                                        
                                        return (itemFingerprint && itemFingerprint === recordFingerprint) ||
                                               (itemIdentity && itemIdentity === recordIdentity) ||
                                               (item.id && item.id === updatedRecord.id);
                                    });
                                    
                                    if (updateIndex !== -1) {
                                        allData[updateIndex] = updatedRecord;
                                        window.allData = allData;
                                    } else {
                                        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ·»åŠ åˆ°æ•°ç»„
                                        allData.push(updatedRecord);
                                        window.allData = allData;
                                    }
                                    
                                    // ä½¿ç”¨æ›´æ–°åçš„è®°å½•ç›´æ¥æ¸²æŸ“ï¼Œç¡®ä¿å¡ç‰‡æ•°å­—èƒ½å¤Ÿå®æ—¶å˜åŠ¨
                                    renderRankCards(updatedRecord);
                                } else {
                                    console.debug('[Realtime] â„¹ï¸ æ›´æ–°çš„è®°å½•ä¸æ˜¯å½“å‰ç”¨æˆ·ï¼Œè·³è¿‡æ’åå¡ç‰‡åˆ·æ–°');
                                }
                            } catch (error) {
                                console.error('[Realtime] âŒ åˆ·æ–°æ’åå¡ç‰‡å¤±è´¥:', error);
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('[Realtime] âœ… å·²æˆåŠŸè®¢é˜… user_analysis è¡¨çš„ INSERT å’Œ UPDATE äº‹ä»¶');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('[Realtime] âŒ è®¢é˜…é€šé“é”™è¯¯');
                        } else {
                            console.log(`[Realtime] â„¹ï¸ è®¢é˜…çŠ¶æ€: ${status}`);
                        }
                    });

                console.log('[Realtime] ğŸš€ Realtime ç›‘å¬å·²å¯åŠ¨');

                // =========================
                // Supabase Presence åŠŸèƒ½ï¼šç»Ÿè®¡å®æ—¶åœ¨çº¿äººæ•°
                // =========================
                
                // å¦‚æœå·²æœ‰ Presence é¢‘é“ï¼Œå…ˆå–æ¶ˆè®¢é˜…
                if (presenceChannel) {
                    try {
                        supabaseClient.removeChannel(presenceChannel);
                        console.log('[Presence] âœ… å·²å–æ¶ˆæ—§çš„ Presence é¢‘é“');
                    } catch (error) {
                        console.warn('[Presence] âš ï¸ å–æ¶ˆæ—§ Presence é¢‘é“æ—¶å‡ºé”™:', error);
                    }
                }

                try {
                    // åˆ›å»ºåä¸º online_users çš„ Presence é¢‘é“
                    presenceChannel = supabaseClient
                        .channel('online_users')
                        .on('presence', { event: 'sync' }, () => {
                            // sync å›è°ƒï¼šè·å–å½“å‰åœ¨çº¿çš„æ‰€æœ‰çŠ¶æ€å¯¹è±¡
                            const newState = presenceChannel.presenceState();
                            
                            // è°ƒè¯•æ—¥å¿—ï¼šè¾“å‡ºæ‰€æœ‰åŒæ­¥åˆ°çš„ç”¨æˆ·
                            console.log('[Presence] å½“å‰åŒæ­¥åˆ°çš„æ‰€æœ‰ç”¨æˆ·:', newState);
                            
                            // è®¡ç®—åœ¨çº¿äººæ•°ï¼šéå†æ‰€æœ‰çŠ¶æ€å¯¹è±¡å¹¶è®¡ç®—æ€»æ•°ï¼ˆä½¿ç”¨ user_name å»é‡ï¼‰
                            const userMap = new Map();
                            if (newState) {
                                Object.keys(newState).forEach((key) => {
                                    const presenceEntries = newState[key];
                                    const entries = Array.isArray(presenceEntries) ? presenceEntries : [presenceEntries];
                                    
                                    entries.forEach(entry => {
                                        if (!entry || !entry.online_at) return;
                                        // ä½¿ç”¨ user_name ä½œä¸ºå»é‡é”®
                                        const userName = entry.user_name || entry.github_id || entry.github_username || 'Guest';
                                        if (!userMap.has(userName) || new Date(entry.online_at) > new Date(userMap.get(userName).online_at)) {
                                            userMap.set(userName, entry);
                                        }
                                    });
                                });
                            }
                            
                            // æ³¨æ„ï¼šä¸æ’é™¤å½“å‰ç”¨æˆ·è‡ªå·±ï¼Œå› ä¸ºç”¨æˆ·è¦æ±‚åœ¨åˆ—è¡¨ä¸­å¯è§
                            const onlineCount = userMap.size;
                            console.log('[Presence] ğŸ‘¥ åœ¨çº¿äººæ•°åŒæ­¥ï¼ˆå»é‡åï¼ŒåŒ…å«è‡ªå·±ï¼‰:', onlineCount);

                            // æ›´æ–°é¡µé¢ä¸Š #online-count-value çš„æ•°å­—ï¼ˆåœ°å›¾ä¸Šçš„ï¼‰
                            const onlineCountElement = document.getElementById('online-count-value');
                            if (onlineCountElement) {
                                // æ·»åŠ ç¼©æ”¾åŠ¨ç”»ç±»
                                onlineCountElement.classList.add('online-count-update');
                                
                                // æ›´æ–°æ•°å­—
                                onlineCountElement.textContent = onlineCount;
                                
                                // åŠ¨ç”»ç»“æŸåç§»é™¤ç±»ï¼ˆä»¥ä¾¿ä¸‹æ¬¡æ›´æ–°æ—¶å¯ä»¥å†æ¬¡è§¦å‘åŠ¨ç”»ï¼‰
                                setTimeout(() => {
                                    onlineCountElement.classList.remove('online-count-update');
                                }, 400); // ä¸ CSS åŠ¨ç”»æ—¶é•¿ä¸€è‡´
                                
                                console.log('[Presence] âœ… å·²æ›´æ–°åœ¨çº¿äººæ•°æ˜¾ç¤ºï¼ˆåœ°å›¾ï¼‰:', onlineCount);
                            } else {
                                console.warn('[Presence] âš ï¸ æ‰¾ä¸åˆ° #online-count-value å…ƒç´ ');
                            }
                            
                            // æ›´æ–°æŠ½å±‰ä¸­çš„åœ¨çº¿äººæ•°ï¼ˆå³ä½¿æŠ˜å çŠ¶æ€ä¹Ÿè¦æ›´æ–°ï¼‰
                            const onlineCountText = document.getElementById('online-count-text');
                            if (onlineCountText) {
                                onlineCountText.textContent = onlineCount;
                            }
                            
                            // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨ï¼ˆä½¿ç”¨ updateOnlineList ç¡®ä¿è·å–æœ€æ–°çŠ¶æ€ï¼‰
                            updateOnlineList();
                        })
                        .on('broadcast', { event: 'burn_msg' }, ({ payload }) => {
                            // æ¥æ”¶ç§ä¿¡ï¼ˆé˜…åå³ç„šæ¶ˆæ¯ï¼‰
                            console.log('[Message] æ”¶åˆ°åŸå§‹å¹¿æ’­:', payload);
                            
                            const githubUsername = localStorage.getItem('github_username') || null;
                            const myId = githubUsername;
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯å‘ç»™å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯
                            // ç»Ÿä¸€ä½¿ç”¨ target_id æˆ– to å­—æ®µè¿›è¡ŒåŒ¹é…ï¼Œæ”¯æŒ GitHub ID å’Œ user_name
                            const targetId = payload.target_id || payload.to;
                            const isForMe = targetId === myId || 
                                          targetId === githubUsername || 
                                          (!myId && targetId === 'Guest');
                            
                            if (payload && isForMe) {
                                console.log('[Message] ğŸ“¨ æ”¶åˆ°ç§ä¿¡:', payload);
                                const content = payload.content || payload.message || '';
                                const fromId = payload.from || 'Unknown';
                                const statusColor = payload.status_color || '#00ff41';
                                
                                showBurnMsg(content, fromId, statusColor);
                            } else {
                                console.log('[Message] âš ï¸ æ¶ˆæ¯ä¸æ˜¯å‘ç»™æˆ‘çš„:', { targetId, myId, githubUsername });
                            }
                        })
                        .on('broadcast', { event: 'private_message' }, ({ payload }) => {
                            // å…¼å®¹æ—§çš„äº‹ä»¶å
                            console.log('[Message] æ”¶åˆ°åŸå§‹å¹¿æ’­ (private_message):', payload);
                            
                            const githubUsername = localStorage.getItem('github_username') || null;
                            const myId = githubUsername;
                            
                            const targetId = payload.target_id || payload.to;
                            const isForMe = targetId === myId || 
                                          targetId === githubUsername || 
                                          (!myId && targetId === 'Guest');
                            
                            if (payload && isForMe) {
                                console.log('[Message] ğŸ“¨ æ”¶åˆ°ç§ä¿¡ (å…¼å®¹æ¨¡å¼):', payload);
                                const content = payload.content || payload.message || '';
                                const fromId = payload.from || 'Unknown';
                                const statusColor = payload.status_color || '#00ff41';
                                
                                showBurnMsg(content, fromId, statusColor);
                            }
                        })
                        .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                            console.log('[Presence] â• ç”¨æˆ·åŠ å…¥:', key, newPresences);
                        })
                        .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                            console.log('[Presence] â– ç”¨æˆ·ç¦»å¼€:', key, leftPresences);
                        })
                        .subscribe(async (status) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('[Presence] âœ… å·²æˆåŠŸè®¢é˜… online_users é¢‘é“');
                                
                                // å¼ºåˆ¶åŒæ­¥è‡ªèº«çŠ¶æ€ï¼ˆå¿…é¡»æ˜¾å¼è°ƒç”¨ï¼‰
                                await trackSelf();
                            } else if (status === 'CHANNEL_ERROR') {
                                console.error('[Presence] âŒ Presence é¢‘é“é”™è¯¯');
                            } else {
                                console.log(`[Presence] â„¹ï¸ Presence è®¢é˜…çŠ¶æ€: ${status}`);
                            }
                        });

                    console.log('[Presence] ğŸš€ Presence ç›‘å¬å·²å¯åŠ¨');
                } catch (presenceError) {
                    console.error('[Presence] âŒ å¯åŠ¨ Presence ç›‘å¬å¤±è´¥:', presenceError);
                }

            } catch (error) {
                console.error('[Realtime] âŒ å¯åŠ¨ Realtime ç›‘å¬å¤±è´¥:', error);
            }
        }

        /**
         * åœæ­¢ Supabase Realtime ç›‘å¬
         */
        function stopRealtimeListener() {
            // åœæ­¢ postgres_changes ç›‘å¬
            if (realtimeChannel && supabaseClient) {
                try {
                    supabaseClient.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                    console.log('[Realtime] âœ… å·²åœæ­¢ Realtime ç›‘å¬');
                } catch (error) {
                    console.warn('[Realtime] âš ï¸ åœæ­¢ç›‘å¬æ—¶å‡ºé”™:', error);
                }
            }

            // åœæ­¢ Presence ç›‘å¬
            if (presenceChannel && supabaseClient) {
                try {
                    // å…ˆå–æ¶ˆè·Ÿè¸ªï¼Œç„¶åç§»é™¤é¢‘é“
                    presenceChannel.untrack();
                    supabaseClient.removeChannel(presenceChannel);
                    presenceChannel = null;
                    console.log('[Presence] âœ… å·²åœæ­¢ Presence ç›‘å¬');
                } catch (error) {
                    console.warn('[Presence] âš ï¸ åœæ­¢ Presence ç›‘å¬æ—¶å‡ºé”™:', error);
                }
            }
        }

        /**
         * è®¾ç½®ç”¨æˆ·çŠ¶æ€
         * @param {string} status - çŠ¶æ€ç±»å‹ ('idle', 'busy', 'sprint')
         */
        function setUserStatus(status) {
            if (!USER_STATUSES[status]) {
                console.warn('[Status] âš ï¸ æ— æ•ˆçš„çŠ¶æ€ç±»å‹:', status);
                return;
            }
            
            currentUserStatus = status;
            localStorage.setItem('user_status', status);
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnStatus = btn.getAttribute('data-status');
                if (btnStatus === status) {
                    btn.classList.add('active');
                    const statusConfig = USER_STATUSES[status];
                    btn.style.borderColor = statusConfig.color;
                    btn.style.color = statusConfig.color;
                } else {
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }
            });
            
            // ç«‹å³åŒæ­¥çŠ¶æ€åˆ°Presence
            syncPresenceState();
            
            console.log('[Status] âœ… ç”¨æˆ·çŠ¶æ€å·²æ›´æ–°:', status, USER_STATUSES[status]);
        }
        
        /**
         * åˆå§‹åŒ–çŠ¶æ€æŒ‰é’®æ ·å¼
         */
        function initStatusButtons() {
            const savedStatus = localStorage.getItem('user_status') || 'idle';
            setUserStatus(savedStatus);
        }
        
        /**
         * è·å–ç”¨æˆ·åœ°ç†ä½ç½®ï¼ˆç»çº¬åº¦ï¼‰
         * @returns {Promise<Object>} åŒ…å« lat, lng çš„å¯¹è±¡
         */
        async function getUserLocation() {
            try {
                // ä½¿ç”¨ ip-api.com API è·å– IP å½’å±åœ°ä¿¡æ¯
                const ipResponse = await fetch('http://ip-api.com/json/', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (ipResponse.ok) {
                    const ipInfo = await ipResponse.json();
                    const lat = ipInfo.lat ? Number(ipInfo.lat) : null;
                    const lng = ipInfo.lon ? Number(ipInfo.lon) : null; // æ³¨æ„ï¼šip-api.com ä½¿ç”¨ lon
                    return { lat, lng };
                }
            } catch (error) {
                console.warn('[Location] âš ï¸ è·å–åœ°ç†ä½ç½®å¤±è´¥:', error);
            }
            return { lat: null, lng: null };
        }

        /**
         * å¼ºåˆ¶åŒæ­¥è‡ªèº«çŠ¶æ€ï¼ˆtrackSelfï¼‰
         * åœ¨ SUBSCRIBED å›è°ƒä¸­æ˜¾å¼è°ƒç”¨
         */
        async function trackSelf() {
            if (!presenceChannel) {
                console.warn('[Presence] âš ï¸ Presenceé¢‘é“æœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                // è·å– GitHub ç”¨æˆ·å
                const ghUsername = localStorage.getItem('github_username') || null;
                
                // ç”Ÿæˆ user_name
                const userName = ghUsername && isValidGitHubUsername(ghUsername) 
                    ? ghUsername 
                    : `Guest_${Math.floor(Math.random() * 1000)}`;
                
                // ç”Ÿæˆ avatar_url
                const avatarUrl = ghUsername && isValidGitHubUsername(ghUsername)
                    ? `https://github.com/${ghUsername}.png`
                    : DEFAULT_AVATAR;
                
                // è·å–çŠ¶æ€ä¿¡æ¯
                const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                const status = statusConfig.status || 'idle';
                const statusColor = statusConfig.status_color || '#00ff41';
                
                // è·å–ç»çº¬åº¦
                const location = await getUserLocation();
                
                // æ„å»º Presence æ•°æ®
                const myPresence = {
                    user_name: userName,
                    avatar_url: avatarUrl,
                    github_id: ghUsername || null,
                    github_username: ghUsername || null,
                    status: status,
                    status_color: statusColor,
                    online_at: new Date().toISOString(),
                    lat: location.lat,
                    lng: location.lng,
                    last_vibe: new Date().toISOString()
                };
                
                // æ˜¾å¼è°ƒç”¨ track
                await presenceChannel.track(myPresence);
                
                console.log('[Presence] âœ… è‡ªèº«çŠ¶æ€å·²åŒæ­¥:', myPresence);
            } catch (error) {
                console.error('[Presence] âŒ åŒæ­¥è‡ªèº«çŠ¶æ€å¤±è´¥:', error);
            }
        }

        /**
         * åŒæ­¥PresenceçŠ¶æ€ï¼ˆåŒ…å«æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ï¼‰
         * å…¼å®¹æ—§ä»£ç ï¼Œå†…éƒ¨è°ƒç”¨ trackSelf
         */
        async function syncPresenceState() {
            await trackSelf();
        }
        
        /**
         * åˆ‡æ¢æŠ½å±‰å±•å¼€/æŠ˜å çŠ¶æ€
         */
        function toggleDrawer() {
            drawerExpanded = !drawerExpanded;
            const drawer = document.getElementById('live-nodes-drawer');
            if (!drawer) return;
            
            if (drawerExpanded) {
                drawer.classList.remove('collapsed');
                drawer.classList.add('expanded');
            } else {
                drawer.classList.remove('expanded');
                drawer.classList.add('collapsed');
            }
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('drawer_expanded', drawerExpanded.toString());
            console.log('[Drawer] âœ… æŠ½å±‰çŠ¶æ€å·²åˆ‡æ¢:', drawerExpanded ? 'å±•å¼€' : 'æŠ˜å ');
        }
        
        /**
         * åˆå§‹åŒ–æŠ½å±‰çŠ¶æ€
         */
        function initDrawerState() {
            const drawer = document.getElementById('live-nodes-drawer');
            if (!drawer) return;
            
            if (drawerExpanded) {
                drawer.classList.remove('collapsed');
                drawer.classList.add('expanded');
            } else {
                drawer.classList.remove('expanded');
                drawer.classList.add('collapsed');
            }
        }
        
        /**
         * æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆæ ¸å¿ƒæ¸²æŸ“é€»è¾‘ï¼‰
         * åœ¨ onlineChannel.on('presence', { event: 'sync' }) å›è°ƒä¸­è°ƒç”¨
         */
        function updateOnlineList() {
            if (!presenceChannel) {
                console.warn('[UserList] âš ï¸ Presenceé¢‘é“æœªåˆå§‹åŒ–');
                return;
            }
            
            // é€šè¿‡ onlineChannel.presenceState() è·å–æœ€æ–°çŠ¶æ€
            const state = presenceChannel.presenceState();
            renderOnlineUsersList(state);
        }
        
        /**
         * æ¸²æŸ“åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†ç±»æ˜¾ç¤ºï¼šå·²å®å/åŒ¿åï¼‰
         * @param {Object} presenceState - PresenceçŠ¶æ€å¯¹è±¡
         */
        function renderOnlineUsersList(presenceState) {
            const listContainer = document.getElementById('online-users-list');
            if (!listContainer) {
                console.warn('[UserList] âš ï¸ æ‰¾ä¸åˆ°ç”¨æˆ·åˆ—è¡¨å®¹å™¨');
                return;
            }
            
            // å³æ—¶æ¸…ç©ºå®¹å™¨ï¼Œç§»é™¤ "Scanning..." æç¤º
            listContainer.innerHTML = '';
            
            // æ”¶é›†æ‰€æœ‰ç”¨æˆ·ï¼Œä½¿ç”¨ user_name ä½œä¸ºå»é‡é”®
            const userMap = new Map();
            
            if (presenceState && Object.keys(presenceState).length > 0) {
                Object.keys(presenceState).forEach((key) => {
                    const presenceEntries = presenceState[key];
                    const entries = Array.isArray(presenceEntries) ? presenceEntries : [presenceEntries];
                    
                    entries.forEach(entry => {
                        if (!entry || !entry.online_at) return;
                        
                        // ä½¿ç”¨ user_name ä½œä¸ºå»é‡é”®
                        const userName = entry.user_name || entry.github_id || entry.github_username || 'Guest';
                        
                        // å»é‡é€»è¾‘ï¼šå¦‚æœå·²å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œä¿ç•™æœ€æ–°çš„
                        if (!userMap.has(userName) || new Date(entry.online_at) > new Date(userMap.get(userName).online_at)) {
                            userMap.set(userName, {
                                ...entry,
                                user_name: userName,
                                github_id: entry.github_id || entry.github_username || null,
                                github_username: entry.github_username || entry.github_id || null
                            });
                        }
                    });
                });
            }
            
            // æ³¨æ„ï¼šä¸æ’é™¤å½“å‰ç”¨æˆ·è‡ªå·±ï¼Œå› ä¸ºç”¨æˆ·è¦æ±‚åœ¨åˆ—è¡¨ä¸­å¯è§
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶åˆ†ç±»
            const allUsers = Array.from(userMap.values());
            
            // åˆ†ç±»ï¼šå·²å®åç”¨æˆ·ï¼ˆæœ‰ github_id ä¸”ä¸ä¸ºé»˜è®¤å€¼ï¼‰å’ŒåŒ¿åç”¨æˆ·
            const verifiedUsers = allUsers.filter(user => {
                const githubId = user.github_id || user.github_username;
                return githubId && isValidGitHubUsername(githubId) && !githubId.startsWith('Guest_');
            });
            
            const anonymousUsers = allUsers.filter(user => {
                const githubId = user.github_id || user.github_username;
                return !githubId || !isValidGitHubUsername(githubId) || githubId.startsWith('Guest_');
            });
            
            // æ’åºï¼šæŒ‰åœ¨çº¿æ—¶é—´å€’åº
            verifiedUsers.sort((a, b) => new Date(b.online_at) - new Date(a.online_at));
            anonymousUsers.sort((a, b) => new Date(b.online_at) - new Date(a.online_at));
            
            // å¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (verifiedUsers.length === 0 && anonymousUsers.length === 0) {
                listContainer.innerHTML = '<div class="text-zinc-500 text-center py-8 text-[10px]">Scanning for nearby nodes...</div>';
                return;
            }
            
            // æ¸²æŸ“å·²å®åç”¨æˆ·ï¼ˆæ’åœ¨æœ€å‰ï¼‰
            let html = '';
            
            if (verifiedUsers.length > 0) {
                html += verifiedUsers.map(user => {
                    const userName = user.user_name || user.github_id || user.github_username || 'Guest';
                    const githubId = user.github_id || user.github_username || userName;
                    const avatarUrl = user.avatar_url || DEFAULT_AVATAR;
                    const status = user.status || 'idle';
                    const statusConfig = USER_STATUSES[status] || USER_STATUSES.idle;
                    const statusLabel = statusConfig.label;
                    
                    // ä½¿ç”¨ç”¨æˆ·è¦æ±‚çš„ HTML ç»“æ„ï¼ŒåŒ…è£¹ <a> æ ‡ç­¾ï¼Œé“¾æ¥æŒ‡å‘ GitHub
                    // æ·»åŠ  onclick="event.stopPropagation()" é˜²æ­¢è§¦å‘æŠ½å±‰æŠ˜å 
                    return `
                        <a 
                            href="https://github.com/${userName}" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="flex items-center gap-3 p-2 hover:bg-white/10 rounded-lg transition-all group"
                            onclick="event.stopPropagation(); openMessageInput('${userName}'); return false;"
                        >
                            <img 
                                src="${avatarUrl}" 
                                alt="${userName}" 
                                class="w-8 h-8 rounded-full border border-[var(--accent-terminal)]"
                                loading="lazy"
                                onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                            />
                            <div class="flex flex-col flex-1 min-w-0">
                                <span class="text-xs text-white font-mono group-hover:text-[var(--accent-terminal)] truncate">${userName}</span>
                                <span class="text-[10px] text-[var(--text-dim)] uppercase">${statusLabel}</span>
                            </div>
                            <i class="ml-auto opacity-0 group-hover:opacity-100 transition-opacity text-[var(--accent-terminal)]">ğŸ”—</i>
                        </a>
                    `;
                }).join('');
            }
            
            // æ¸²æŸ“åŒ¿åç”¨æˆ·
            if (anonymousUsers.length > 0) {
                html += anonymousUsers.map(user => {
                    const userName = user.user_name || 'Guest';
                    const avatarUrl = user.avatar_url || DEFAULT_AVATAR;
                    const status = user.status || 'idle';
                    const statusConfig = USER_STATUSES[status] || USER_STATUSES.idle;
                    const statusLabel = statusConfig.label;
                    
                    return `
                        <div 
                            class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-lg transition-all opacity-70"
                            onclick="openMessageInput('${userName}')"
                        >
                            <img 
                                src="${avatarUrl}" 
                                alt="${userName}" 
                                class="w-8 h-8 rounded-full border border-zinc-700"
                                loading="lazy"
                                onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                            />
                            <div class="flex flex-col flex-1 min-w-0">
                                <span class="text-xs text-zinc-400 font-mono truncate">${userName}</span>
                                <span class="text-[10px] text-zinc-600 uppercase">${statusLabel}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            listContainer.innerHTML = html;
        }
        
        /**
         * æ‰“å¼€ç§ä¿¡è¾“å…¥æ¡†
         * @param {string} targetUserId - ç›®æ ‡ç”¨æˆ·ID
         */
        function openMessageInput(targetUserId) {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'message-input-overlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            };
            
            // åˆ›å»ºè¾“å…¥æ¡†
            const inputBox = document.createElement('div');
            inputBox.className = 'message-input-box';
            inputBox.onclick = (e) => e.stopPropagation();
            
            inputBox.innerHTML = `
                <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest">å‘é€ç§ä¿¡ç»™ ${targetUserId}</div>
                <textarea 
                    id="messageTextInput" 
                    placeholder="è¾“å…¥æ¶ˆæ¯ï¼ˆé˜…åå³ç„šï¼Œ5ç§’åè‡ªåŠ¨é”€æ¯ï¼‰"
                    class="w-full bg-zinc-900/50 border border-zinc-800 px-3 py-2 rounded text-sm text-white placeholder-zinc-600 focus:outline-none focus:border-[var(--accent-terminal)] transition-colors resize-none"
                    rows="4"
                ></textarea>
                <div class="flex gap-2 mt-3">
                    <button 
                        onclick="sendMessage('${targetUserId}')"
                        class="flex-1 px-4 py-2 bg-[var(--accent-terminal)]/20 border border-[var(--accent-terminal)] text-[var(--accent-terminal)] text-xs font-bold uppercase tracking-wider hover:bg-[var(--accent-terminal)]/30 transition-colors"
                    >
                        å‘é€
                    </button>
                    <button 
                        onclick="this.closest('.message-input-overlay').remove()"
                        class="px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-xs font-bold uppercase tracking-wider hover:bg-zinc-700 transition-colors"
                    >
                        å–æ¶ˆ
                    </button>
                </div>
            `;
            
            overlay.appendChild(inputBox);
            document.body.appendChild(overlay);
            
            // èšç„¦è¾“å…¥æ¡†
            setTimeout(() => {
                const textarea = document.getElementById('messageTextInput');
                if (textarea) textarea.focus();
            }, 100);
        }
        
        /**
         * æ˜¾ç¤ºå‘é€æˆåŠŸæç¤º
         * @param {string} message - æç¤ºæ¶ˆæ¯
         */
        function showNotification(message) {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-[var(--accent-terminal)]/20 border border-[var(--accent-terminal)] px-4 py-2 rounded text-[var(--accent-terminal)] text-xs font-bold uppercase tracking-wider z-50';
            notification.textContent = message;
            notification.style.animation = 'popup-appear 0.3s ease-out';
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'popup-destroy 0.3s ease-out forwards';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        /**
         * å‘é€ç§ä¿¡ï¼ˆä½¿ç”¨Broadcastï¼‰
         * @param {string} targetUserId - ç›®æ ‡ç”¨æˆ·ID
         */
        function sendMessage(targetUserId) {
            const textarea = document.getElementById('messageTextInput');
            const message = textarea?.value.trim();
            
            if (!message) {
                alert('æ¶ˆæ¯ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            if (!presenceChannel) {
                alert('è¿æ¥æœªå»ºç«‹ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
                return;
            }
            
            const myId = localStorage.getItem('github_username') || null;
            const githubUsername = myId || 'Guest';
            const statusConfig = USER_STATUSES[currentUserStatus];
            
            // ä½¿ç”¨Broadcastå‘é€æ¶ˆæ¯
            presenceChannel.send({
                type: 'broadcast',
                event: 'burn_msg',
                payload: {
                    from: githubUsername,
                    to: targetUserId,
                    target_id: targetUserId,
                    content: message,
                    message: message, // å…¼å®¹æ—§å­—æ®µå
                    timestamp: new Date().toISOString(),
                    status_color: statusConfig.status_color
                }
            });
            
            console.log('[Message] âœ… ç§ä¿¡å·²å‘é€:', { from: githubUsername, to: targetUserId, message });
            
            // ğŸ’¡ ä¿®å¤é€»è¾‘ï¼šå¦‚æœæ˜¯å‘ç»™è‡ªå·±ï¼Œç›´æ¥åœ¨æœ¬åœ°è¿è¡Œæ˜¾ç¤ºé€»è¾‘
            if (targetUserId === myId || targetUserId === githubUsername) {
                // è‡ªæ¥æ”¶ï¼šç›´æ¥æ˜¾ç¤ºæ¶ˆæ¯
                showBurnMsg(message, githubUsername, statusConfig.status_color);
                console.log('[Message] ğŸ”„ è‡ªæ¥æ”¶æ¶ˆæ¯å·²æ˜¾ç¤º');
            } else {
                // å‘é€ç»™ä»–äººï¼šæ˜¾ç¤ºå‘é€æˆåŠŸæç¤º
                showNotification('å¯†ä¿¡å·²å‘å‡º');
            }
            
            // å…³é—­è¾“å…¥æ¡†
            const overlay = document.querySelector('.message-input-overlay');
            if (overlay) overlay.remove();
        }
        
        // å…¨å±€å˜é‡ï¼šç”¨äºç®¡ç†å€’è®¡æ—¶ï¼Œé˜²æ­¢å¤šä¸ªå¼¹çª—é‡å 
        let currentBurnMsgInterval = null;
        let currentBurnMsgPopup = null;

        /**
         * ç»Ÿä¸€æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°ï¼ˆé˜…åå³ç„šå¼¹çª—ï¼‰
         * @param {string} content - æ¶ˆæ¯å†…å®¹
         * @param {string} fromId - å‘é€è€…ID
         * @param {string} statusColor - çŠ¶æ€é¢œè‰²ï¼ˆå¯é€‰ï¼‰
         */
        function showBurnMsg(content, fromId, statusColor = '#00ff41') {
            // å¦‚æœå·²æœ‰å¼¹çª—ï¼Œå…ˆæ¸…é™¤æ—§çš„å€’è®¡æ—¶
            if (currentBurnMsgInterval) {
                clearInterval(currentBurnMsgInterval);
                currentBurnMsgInterval = null;
            }
            
            // å¦‚æœå·²æœ‰å¼¹çª—ï¼Œå…ˆç§»é™¤
            if (currentBurnMsgPopup) {
                currentBurnMsgPopup.classList.add('destroying');
                setTimeout(() => {
                    if (currentBurnMsgPopup && currentBurnMsgPopup.parentNode) {
                        currentBurnMsgPopup.remove();
                    }
                }, 300);
            }
            
            // åˆ›å»ºæ–°å¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'message-popup';
            currentBurnMsgPopup = popup;
            
            let countdown = 5;
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºè‡ªä¼ æ¶ˆæ¯
            const myId = localStorage.getItem('github_username') || null;
            const isSelf = fromId === myId || fromId === 'ç³»ç»Ÿ (è‡ªä¼ )';
            const fromLabel = isSelf ? 'ç³»ç»Ÿ (è‡ªä¼ )' : fromId;
            
            popup.innerHTML = `
                <div class="flex items-center gap-3 mb-3">
                    <div class="text-[10px] text-zinc-500 uppercase tracking-widest">From: ${fromLabel}</div>
                    <div class="flex-1"></div>
                    <div class="text-[10px] font-bold" style="color: ${statusColor};" id="countdown-${Date.now()}">5ç§’</div>
                </div>
                <div class="text-white text-sm mb-3 font-mono" style="min-height: 60px; word-break: break-word;">${content}</div>
                <div class="text-[9px] text-zinc-600 font-mono">é˜…åå³ç„š // è‡ªåŠ¨é”€æ¯</div>
            `;
            
            document.body.appendChild(popup);
            
            // å€’è®¡æ—¶é€»è¾‘ï¼ˆç¡®ä¿æ¯æ¬¡æ–°æ¶ˆæ¯åˆ°è¾¾æ—¶éƒ½èƒ½æ­£ç¡®é‡ç½®ï¼‰
            const countdownId = `countdown-${Date.now()}`;
            const countdownEl = popup.querySelector(`#${countdownId}`);
            
            currentBurnMsgInterval = setInterval(() => {
                countdown--;
                if (countdownEl) {
                    countdownEl.textContent = `${countdown}ç§’`;
                }
                
                if (countdown <= 0) {
                    clearInterval(currentBurnMsgInterval);
                    currentBurnMsgInterval = null;
                    // é”€æ¯åŠ¨ç”»
                    popup.classList.add('destroying');
                    setTimeout(() => {
                        if (popup && popup.parentNode) {
                            popup.remove();
                        }
                        if (currentBurnMsgPopup === popup) {
                            currentBurnMsgPopup = null;
                        }
                    }, 500);
                }
            }, 1000);
        }

        /**
         * æ˜¾ç¤ºç§ä¿¡å¼¹çª—ï¼ˆæ¥æ”¶ç«¯ï¼‰- å…¼å®¹æ—§å‡½æ•°å
         * @param {Object} messageData - æ¶ˆæ¯æ•°æ®
         */
        function showMessagePopup(messageData) {
            const content = messageData.content || messageData.message || '';
            const fromId = messageData.from || 'Unknown';
            const statusColor = messageData.status_color || '#00ff41';
            
            showBurnMsg(content, fromId, statusColor);
        }
        
        /**
         * GitHub OAuth ç™»å½•
         * è°ƒç”¨ Supabase Auth çš„ signInWithOAuth æ–¹æ³•
         */
        async function loginWithGitHub() {
            if (!supabaseClient) {
                console.error('[Auth] âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                alert('æ•°æ®åº“è¿æ¥æœªå°±ç»ªï¼Œè¯·ç¨å€™å†è¯•');
                return;
            }
            
            try {
                console.log('[Auth] ğŸš€ å¼€å§‹ GitHub OAuth ç™»å½•æµç¨‹...');
                
                // è·å–å½“å‰é¡µé¢ URL ä½œä¸ºé‡å®šå‘åœ°å€
                const redirectTo = window.location.origin + window.location.pathname;
                
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'github',
                    options: {
                        redirectTo: redirectTo,
                        scopes: 'read:user user:email', // è¯·æ±‚è¯»å–ç”¨æˆ·ä¿¡æ¯å’Œé‚®ç®±çš„æƒé™
                    }
                });
                
                if (error) {
                    console.error('[Auth] âŒ GitHub OAuth ç™»å½•å¤±è´¥:', error);
                    alert(`ç™»å½•å¤±è´¥: ${error.message}`);
                    return;
                }
                
                console.log('[Auth] âœ… GitHub OAuth ç™»å½•è¯·æ±‚å·²å‘é€ï¼Œç­‰å¾…é‡å®šå‘...');
                // æ³¨æ„ï¼šsignInWithOAuth ä¼šè§¦å‘é¡µé¢é‡å®šå‘ï¼Œåç»­é€»è¾‘åœ¨ handleAuthStateChange ä¸­å¤„ç†
                
            } catch (error) {
                console.error('[Auth] âŒ GitHub OAuth ç™»å½•å¼‚å¸¸:', error);
                alert(`ç™»å½•å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
        }
        
        /**
         * é€€å‡ºç™»å½•
         * æ¸…ç†ä¼šè¯å’Œæœ¬åœ°æ•°æ®
         */
        async function logout() {
            if (!supabaseClient) {
                console.error('[Auth] âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                console.log('[Auth] ğŸšª å¼€å§‹é€€å‡ºç™»å½•...');
                
                // æ¸…ç† localStorage
                localStorage.removeItem('github_username');
                // ä¿ç•™ fingerprintï¼Œä»¥ä¾¿é™é»˜ç™»å½•
                
                // è°ƒç”¨ Supabase Auth é€€å‡º
                const { error } = await supabaseClient.auth.signOut();
                
                if (error) {
                    console.error('[Auth] âŒ é€€å‡ºç™»å½•å¤±è´¥:', error);
                    alert(`é€€å‡ºå¤±è´¥: ${error.message}`);
                    return;
                }
                
                // æ¸…ç†å…¨å±€å˜é‡
                window.currentUser = null;
                window.currentUserMatchedByFingerprint = false;
                
                // åˆ·æ–° UI
                updateAuthUI(null);
                
                // åˆ·æ–°æ’åå¡ç‰‡ï¼ˆæ˜¾ç¤ºå…¨çƒæœ€å¼ºæ¨¡å¼ï¼‰
                renderRankCards(null);
                
                console.log('[Auth] âœ… å·²é€€å‡ºç™»å½•');
                alert('å·²é€€å‡ºç™»å½•');
                
            } catch (error) {
                console.error('[Auth] âŒ é€€å‡ºç™»å½•å¼‚å¸¸:', error);
                alert(`é€€å‡ºå¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
        }
        
        /**
         * æ˜¾ç¤ºåŒæ­¥é®ç½©
         */
        function showSyncingOverlay() {
            try {
                const leftDrawer = document.getElementById('left-drawer');
                const leftBody = document.getElementById('left-drawer-body');
                
                if (!leftDrawer || !leftBody) {
                    console.warn('[Auth] âš ï¸ æ— æ³•æ‰¾åˆ°æŠ½å±‰å…ƒç´ ï¼Œè·³è¿‡æ˜¾ç¤ºåŒæ­¥é®ç½©');
                    return;
                }
                
                // ç§»é™¤æ—§çš„åŒæ­¥å ä½ç¬¦ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const existingSyncingCards = leftBody.querySelectorAll('.drawer-item');
                existingSyncingCards.forEach(card => {
                    const label = card.querySelector('.drawer-item-label');
                    if (label && label.textContent === 'æ•°æ®åŒæ­¥ä¸­') {
                        card.remove();
                    }
                });
                
                // åˆ›å»º"æ•°æ®åŒæ­¥ä¸­"å ä½ç¬¦å¡ç‰‡
                const loadingCard = document.createElement('div');
                loadingCard.className = 'drawer-item';
                loadingCard.id = 'syncing-overlay-card';
                loadingCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">â³</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                            SYNCING
                        </span>
                    </div>
                    <div class="drawer-item-label mb-2">æ•°æ®åŒæ­¥ä¸­</div>
                    <div class="text-[10px] text-[#00ff41]/60 mb-3">
                        æ­£åœ¨è¿ç§»æŒ‡çº¹æ•°æ®ï¼Œè¯·ç¨å€™...
                    </div>
                    <div class="flex items-center space-x-2 mb-2">
                        <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                `;
                
                // å…ˆç§»é™¤æ—§çš„ç»Ÿè®¡å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const existingStatsCards = leftBody.querySelectorAll('.drawer-item:not(#syncing-overlay-card)');
                existingStatsCards.forEach(card => card.remove());
                
                // æ·»åŠ åŒæ­¥å ä½ç¬¦
                leftBody.appendChild(loadingCard);
                
                // ç¡®ä¿æŠ½å±‰æ‰“å¼€
                if (!leftDrawer.classList.contains('active')) {
                    leftDrawer.classList.add('active');
                }
                
                console.log('[Auth] âœ… å·²æ˜¾ç¤ºåŒæ­¥é®ç½©');
            } catch (error) {
                console.error('[Auth] âŒ æ˜¾ç¤ºåŒæ­¥é®ç½©å¤±è´¥:', error);
            }
        }
        
        /**
         * éšè—åŒæ­¥é®ç½©
         */
        function hideSyncingOverlay() {
            try {
                const leftBody = document.getElementById('left-drawer-body');
                if (!leftBody) {
                    console.warn('[Auth] âš ï¸ æ— æ³•æ‰¾åˆ°æŠ½å±‰ body å…ƒç´ ï¼Œè·³è¿‡éšè—åŒæ­¥é®ç½©');
                    return;
                }
                
                // ç§»é™¤åŒæ­¥å ä½ç¬¦å¡ç‰‡
                const syncingCard = document.getElementById('syncing-overlay-card');
                if (syncingCard) {
                    syncingCard.remove();
                    console.log('[Auth] âœ… å·²ç§»é™¤åŒæ­¥é®ç½©');
                }
                
                // å¦‚æœæœ‰å½“å‰ç”¨æˆ·æ•°æ®ï¼Œé‡æ–°æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
                if (window.currentUser) {
                    renderUserStatsCards(leftBody, window.currentUser);
                }
            } catch (error) {
                console.error('[Auth] âŒ éšè—åŒæ­¥é®ç½©å¤±è´¥:', error);
            }
        }
        
        /**
         * å¤„ç†è®¤è¯çŠ¶æ€å˜åŒ–
         * å½“ç”¨æˆ·ç™»å½•/é€€å‡ºæ—¶è‡ªåŠ¨è°ƒç”¨
         * @param {Object} session - Supabase ä¼šè¯å¯¹è±¡
         */
        async function handleAuthStateChange(session) {
            console.log('[Auth] ğŸ”” è®¤è¯çŠ¶æ€å˜åŒ–:', session ? 'å·²ç™»å½•' : 'æœªç™»å½•');
            
            // è¶…æ—¶å…œåº•å®šæ—¶å™¨
            let timeoutTimer = null;
            
            // ç¡®ä¿ finally å—ä¸­èƒ½è®¿é—®çš„å˜é‡
            let migrationCompleted = false;
            
            try {
                if (session && session.user) {
                    const user = session.user;
                    console.log('[Auth] ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯:', {
                        id: user.id,
                        email: user.email,
                        user_metadata: user.user_metadata
                    });
                    
                    // ä» user_metadata ä¸­æå– GitHub ä¿¡æ¯
                    // GitHub OAuth è¿”å›çš„æ•°æ®é€šå¸¸åœ¨ user_metadata ä¸­
                    const githubUsername = user.user_metadata?.user_name || 
                                         user.user_metadata?.preferred_username ||
                                         user.user_metadata?.login ||
                                         user.email?.split('@')[0] || // é™çº§ï¼šä½¿ç”¨é‚®ç®±å‰ç¼€
                                         null;
                    
                    const avatarUrl = user.user_metadata?.avatar_url || 
                                    user.user_metadata?.picture ||
                                    (githubUsername ? getGitHubAvatarUrl(githubUsername) : null) ||
                                    DEFAULT_AVATAR;
                    
                    if (!githubUsername) {
                        console.warn('[Auth] âš ï¸ æ— æ³•ä» user_metadata ä¸­æå– GitHub ç”¨æˆ·å');
                        updateAuthUI(null);
                        return;
                    }
                    
                    console.log('[Auth] âœ… æå–åˆ° GitHub ä¿¡æ¯:', {
                        username: githubUsername,
                        avatarUrl: avatarUrl
                    });
                    
                    // ä¿å­˜åˆ° localStorageï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
                    localStorage.setItem('github_username', githubUsername);
                    
                    // ã€å˜é‡ä¿®æ­£ã€‘ç»Ÿä¸€ä½¿ç”¨ currentFp å˜é‡
                    // ã€ä¿®å¤ã€‘ç¡®ä¿åœ¨è°ƒç”¨ migrate æ¥å£å‰ï¼Œä»£ç èƒ½å¤Ÿæ­£ç¡®ä» localStorage è·å– user_fingerprint
                    let currentFp = null;
                    try {
                        // ä¼˜å…ˆå°è¯•ä» localStorage è·å–ï¼Œè¿™æ˜¯åŒ¿åç”¨æˆ·æ•°æ®çš„å”¯ä¸€æ ‡è¯†
                        currentFp = localStorage.getItem('user_fingerprint') || window.fpId;
                    } catch (e) {
                        console.warn('[Auth] âš ï¸ è¯»å– localStorage user_fingerprint å¤±è´¥:', e);
                    }
                    
                    if (!currentFp) {
                        console.warn('[Auth] âš ï¸ æ— æ³•è·å–æŒ‡çº¹ï¼Œå°è¯•ç”Ÿæˆ...');
                        try {
                            const generatedFp = await getCurrentFingerprint();
                            if (generatedFp) {
                                currentFp = generatedFp;
                                window.fpId = generatedFp;
                                try {
                                    localStorage.setItem('user_fingerprint', generatedFp);
                                } catch (e) {
                                    console.warn('[Auth] âš ï¸ å†™å…¥ localStorage user_fingerprint å¤±è´¥:', e);
                                }
                            }
                        } catch (genError) {
                            console.error('[Auth] âŒ ç”ŸæˆæŒ‡çº¹å¤±è´¥:', genError);
                        }
                    }
                    
                    const githubUserId = user.id; // ä» Supabase Auth ç”¨æˆ·å¯¹è±¡è·å– user_id
                    let migrationSuccess = false;
                    
                    // ã€è¿ç§»ä¼˜å…ˆã€‘åœ¨æ£€æµ‹åˆ° GitHub ç™»å½•åï¼Œå…ˆè°ƒç”¨ /api/fingerprint/migrate æ¥å£
                    if (currentFp && githubUserId) {
                        console.log('[Auth] ğŸ”„ æ£€æµ‹åˆ°æŒ‡çº¹å’Œ GitHub ç”¨æˆ·ï¼Œå¼€å§‹æ•°æ®è¿ç§»...');
                        console.log('[Auth] ğŸ“‹ è¿ç§»ä¿¡æ¯:', {
                            currentFp: currentFp.substring(0, 8) + '...',
                            githubUserId: githubUserId.substring(0, 8) + '...',
                            username: githubUsername
                        });
                        
                        // æ˜¾ç¤ºåŒæ­¥é®ç½©
                        showSyncingOverlay();
                        
                        // è®¾ç½® 8 ç§’è¶…æ—¶å…œåº•
                        timeoutTimer = setTimeout(() => {
                            if (!migrationCompleted) {
                                console.warn('[Auth] âš ï¸ è¿ç§»æ¥å£è¶…æ—¶ï¼ˆ8ç§’ï¼‰ï¼Œå¼ºåˆ¶æ‰§è¡Œ hideSyncingOverlay()');
                                migrationCompleted = true;
                                hideSyncingOverlay();
                            }
                        }, 8000);
                        
                        try {
                            // ã€Task 1ã€‘è·å– API åŸºå‡†åœ°å€
                            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || 
                                              'https://cursor-clinical-analysis.psterman.workers.dev/';
                            const migrateUrl = `${apiEndpoint}api/fingerprint/migrate`;
                            
                            console.log('[Auth] ğŸ“¡ ä½¿ç”¨ API åœ°å€:', migrateUrl);
                            
                            // ã€ä¿®å¤ AbortErrorã€‘æ·»åŠ  AbortController å’Œè¶…æ—¶å¤„ç†
                            const abortController = new AbortController();
                            const timeoutId = setTimeout(() => {
                                abortController.abort();
                            }, 10000); // 10ç§’è¶…æ—¶
                            
                            let migrateResponse;
                            try {
                                // è°ƒç”¨åç«¯æ¥å£è¿ç§»æ•°æ®
                                // ã€å¿…é¡»åœ¨ Body ä¸­æºå¸¦ï¼š{ userId, fingerprint, username }ã€‘
                                migrateResponse = await fetch(migrateUrl, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${session.access_token}` // ä¼ é€’è®¤è¯ token
                                    },
                                    body: JSON.stringify({
                                        fingerprint: currentFp,
                                        userId: githubUserId,
                                        username: githubUsername
                                    }),
                                    signal: abortController.signal // æ·»åŠ  signal æ”¯æŒå–æ¶ˆ
                                });
                                
                                clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                            } catch (fetchError) {
                                clearTimeout(timeoutId); // ç¡®ä¿æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                                
                                // å¤„ç† AbortError
                                if (fetchError.name === 'AbortError' || fetchError.message?.includes('aborted')) {
                                    console.warn('[Auth] âš ï¸ è¿ç§»è¯·æ±‚è¢«å–æ¶ˆï¼ˆè¶…æ—¶æˆ–é¡µé¢åˆ·æ–°ï¼‰:', fetchError);
                                    throw new Error('è¯·æ±‚è¶…æ—¶æˆ–è¢«å–æ¶ˆï¼Œè¯·ç¨åé‡è¯•');
                                }
                                throw fetchError; // é‡æ–°æŠ›å‡ºå…¶ä»–é”™è¯¯
                            }
                            
                            // æ¸…é™¤è¶…æ—¶å…œåº•å®šæ—¶å™¨
                            if (timeoutTimer) {
                                clearTimeout(timeoutTimer);
                                timeoutTimer = null;
                            }
                            
                            // ã€Task 4ã€‘ä¿®å¤ JSON è§£æå¼‚å¸¸ï¼šæ£€æŸ¥å“åº”çŠ¶æ€å’Œ Content-Type
                            let migrateResult = null;
                            if (migrateResponse.status !== 204) {
                                const contentType = migrateResponse.headers.get('content-type') || '';
                                if (contentType.includes('application/json')) {
                                    try {
                                        migrateResult = await migrateResponse.json();
                                    } catch (jsonError) {
                                        console.error('[Auth] âŒ JSON è§£æå¤±è´¥:', jsonError);
                                        const responseText = await migrateResponse.text();
                                        console.error('[Auth] å“åº”å†…å®¹:', responseText);
                                        throw new Error(`JSON è§£æå¤±è´¥: ${jsonError.message}`);
                                    }
                                } else {
                                    const responseText = await migrateResponse.text();
                                    console.warn('[Auth] âš ï¸ å“åº”ä¸æ˜¯ JSON æ ¼å¼:', {
                                        status: migrateResponse.status,
                                        contentType: contentType,
                                        responseText: responseText.substring(0, 200)
                                    });
                                    throw new Error(`å“åº”æ ¼å¼é”™è¯¯: ${contentType}`);
                                }
                            } else {
                                console.log('[Auth] â„¹ï¸ å“åº”çŠ¶æ€ä¸º 204 No Contentï¼Œè·³è¿‡ JSON è§£æ');
                                migrateResult = { status: 'success', data: null };
                            }
                            
                            // ã€ä¿®å¤ 404 é”™è¯¯å¤„ç†ã€‘æ£€æŸ¥å“åº”çŠ¶æ€
                            if (!migrateResponse.ok) {
                                const errorMsg = migrateResult?.error || `HTTP ${migrateResponse.status}: ${migrateResponse.statusText}`;
                                console.warn('[Auth] âš ï¸ è¿ç§»æ¥å£è¿”å›é”™è¯¯:', {
                                    status: migrateResponse.status,
                                    statusText: migrateResponse.statusText,
                                    error: errorMsg
                                });
                                
                                // å¦‚æœæ˜¯ 404ï¼Œè¯´æ˜è·¯ç”±ä¸å­˜åœ¨æˆ–æœªéƒ¨ç½²ï¼Œç»§ç»­æ­£å¸¸æµç¨‹
                                if (migrateResponse.status === 404) {
                                    console.log('[Auth] â„¹ï¸ è¿ç§»æ¥å£ä¸å­˜åœ¨ï¼ˆ404ï¼‰ï¼Œè·³è¿‡è¿ç§»ï¼Œç»§ç»­æ­£å¸¸æµç¨‹');
                                    // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œåç»­é€»è¾‘
                                } else {
                                    // å…¶ä»–é”™è¯¯ï¼Œè®°å½•ä½†ä¸ä¸­æ–­æµç¨‹
                                    console.warn('[Auth] âš ï¸ æ•°æ®è¿ç§»å¤±è´¥ï¼Œç»§ç»­æ­£å¸¸æµç¨‹:', errorMsg);
                                }
                                
                                // æ— è®ºä»€ä¹ˆé”™è¯¯ï¼Œéƒ½ç»§ç»­æ­£å¸¸æµç¨‹ï¼ˆä¸è¿ç§»ï¼‰
                                migrateResult = { status: 'error', error: errorMsg };
                            }
                            
                            migrationCompleted = true;
                            
                            if (migrateResult && migrateResult.status === 'success') {
                                console.log('[Auth] âœ… Step A: æ•°æ®è¿ç§»æˆåŠŸ:', migrateResult.data);
                                migrationSuccess = true;
                                
                                // ã€Task 1ã€‘æ¸…é™¤æœ¬åœ°çš„ user_fingerprint ç¼“å­˜ï¼Œç»Ÿä¸€ä½¿ç”¨ Supabase User ID
                                localStorage.removeItem('user_fingerprint');
                                if (window.fpId) {
                                    delete window.fpId;
                                }
                                console.log('[Auth] âœ… å·²æ¸…é™¤æœ¬åœ° fingerprint ç¼“å­˜');
                                
                                // è¿ç§»æˆåŠŸåï¼Œæ›´æ–° window.allData
                                const allData = window.allData || [];
                                const migratedUser = migrateResult.data;
                                
                                // ç§»é™¤æ—§çš„æŒ‡çº¹è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                                const oldIndex = allData.findIndex(item => 
                                    item.fingerprint === currentFp && item.id !== githubUserId
                                );
                                if (oldIndex !== -1) {
                                    allData.splice(oldIndex, 1);
                                }
                                
                                // æ·»åŠ æˆ–æ›´æ–°è¿ç§»åçš„ç”¨æˆ·æ•°æ®
                                const newIndex = allData.findIndex(item => item.id === githubUserId);
                                if (newIndex !== -1) {
                                    allData[newIndex] = { ...allData[newIndex], ...migratedUser };
                                } else {
                                    allData.push(migratedUser);
                                }
                                window.allData = allData;
                                
                                // è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºè¿ç§»åçš„ç”¨æˆ·
                                window.currentUser = migratedUser;
                                window.currentUserMatchedByFingerprint = false; // ç°åœ¨æ˜¯é€šè¿‡ GitHub OAuth åŒ¹é…çš„
                                
                                console.log('[Auth] âœ… èº«ä»½åˆå¹¶å®Œæˆï¼Œå†å²æ•°æ®å·²è¿ç§»åˆ° GitHub User ID');
                                
                                // ã€é¡ºåºé‡ç»„ã€‘Step B: è°ƒç”¨ autoReportSelfï¼ˆä¸ŠæŠ¥å½“å‰åœ°ç†ä½ç½®ï¼Œç¡®ä¿ GitHub è´¦å·æœ‰äº† lat/lngï¼‰
                                console.log('[Auth] ğŸ”„ Step B: å¼€å§‹ä¸ŠæŠ¥åœ°ç†ä½ç½®...');
                                try {
                                    const reportResult = await autoReportSelf();
                                    if (reportResult.success) {
                                        console.log('[Auth] âœ… Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥æˆåŠŸ');
                                    } else {
                                        console.warn('[Auth] âš ï¸ Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥å¤±è´¥:', reportResult.error);
                                    }
                                } catch (reportError) {
                                    console.error('[Auth] âŒ Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥å¼‚å¸¸:', reportError);
                                }
                                
                                // ã€è¿ç§»ä¼˜å…ˆã€‘åªæœ‰åœ¨è¿ç§»è¯·æ±‚ç»“æŸåï¼Œæ‰è°ƒç”¨ refreshUserStats() åŠ è½½æ•°æ®
                                console.log('[Auth] ğŸ”„ Step C: å¼€å§‹åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡æ•°æ®...');
                                if (typeof window.refreshUserStats === 'function') {
                                    try {
                                        await window.refreshUserStats();
                                        console.log('[Auth] âœ… Step C: refreshUserStats æ‰§è¡Œå®Œæˆ');
                                    } catch (refreshError) {
                                        // ã€ä¿®å¤ AbortErrorã€‘ç‰¹æ®Šå¤„ç† AbortError
                                        if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                            console.log('[Auth] â„¹ï¸ refreshUserStats è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰');
                                        } else {
                                            console.error('[Auth] âŒ Step C: refreshUserStats æ‰§è¡Œå¤±è´¥:', refreshError);
                                        }
                                    }
                                } else {
                                    console.warn('[Auth] âš ï¸ window.refreshUserStats å‡½æ•°ä¸å­˜åœ¨');
                                }
                                
                                // æ›´æ–° UI
                                updateAuthUI({ username: githubUsername, avatarUrl });
                                
                                // éšè—åŒæ­¥é®ç½©
                                hideSyncingOverlay();
                                
                                return; // è¿ç§»æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­çš„æŒ‡çº¹ç»‘å®šé€»è¾‘
                            } else if (migrateResult && migrateResult.status === 'not_found') {
                                console.log('[Auth] â„¹ï¸ æœªæ‰¾åˆ°éœ€è¦è¿ç§»çš„æ•°æ®ï¼Œç»§ç»­æ­£å¸¸æµç¨‹');
                                hideSyncingOverlay();
                            } else {
                                console.warn('[Auth] âš ï¸ æ•°æ®è¿ç§»å¤±è´¥ï¼Œç»§ç»­æ­£å¸¸æµç¨‹:', migrateResult?.error);
                                hideSyncingOverlay();
                            }
                        } catch (migrateError) {
                            migrationCompleted = true;
                            
                            // ã€ä¿®å¤ AbortErrorã€‘ç‰¹æ®Šå¤„ç† AbortError
                            if (migrateError.name === 'AbortError' || migrateError.message?.includes('aborted')) {
                                console.warn('[Auth] âš ï¸ è¿ç§»è¯·æ±‚è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰:', migrateError);
                            } else {
                                console.error('[Auth] âŒ æ•°æ®è¿ç§»å¼‚å¸¸ï¼Œç»§ç»­æ­£å¸¸æµç¨‹:', migrateError);
                            }
                            
                            hideSyncingOverlay();
                        }
                    } else {
                        console.log('[Auth] â„¹ï¸ æœªæ£€æµ‹åˆ°æŒ‡çº¹æˆ– GitHub ç”¨æˆ· IDï¼Œè·³è¿‡è¿ç§»');
                    }
                    
                    // ã€ä»…åœ¨è¿ç§»æœªæˆåŠŸæ—¶æ‰§è¡Œã€‘å…³é”®ç»‘å®šé€»è¾‘ï¼šç™»å½•åå¿…é¡»ä½¿ç”¨ user_id æ›´æ–°ï¼Œè€Œä¸æ˜¯ fingerprint
                    if (!migrationSuccess) {
                        console.log('[Auth] ğŸ”— è¿ç§»æœªæˆåŠŸï¼Œå¼€å§‹ä½¿ç”¨ GitHub User ID è¿›è¡Œæ•°æ®åŒæ­¥...');
                        
                        // ã€å…³é”®ä¿®å¤ã€‘ç™»å½•åå¿…é¡»ä½¿ç”¨ user_id è¿›è¡Œæ‰€æœ‰æ“ä½œï¼Œè€Œä¸æ˜¯ fingerprint
                        // è¿™æ˜¯"è®¤ç¥–å½’å®—"çš„å…³é”®ï¼šç¡®ä¿æ•°æ®å…³è”åˆ°æ­£ç¡®çš„ GitHub è´¦å·
                        const normalizedUsername = githubUsername.toLowerCase().trim();
                        
                        // ã€å˜é‡ä¿®æ­£ã€‘ç»Ÿä¸€ä½¿ç”¨ currentFp å˜é‡
                        const currentFp = window.fpId || localStorage.getItem('user_fingerprint') || await getCurrentFingerprint();
                        
                        console.log('[Auth] ğŸ”— ä½¿ç”¨ GitHub User ID æ‰§è¡Œ upsert æ“ä½œï¼Œid =', githubUserId.substring(0, 8) + '...');
                        
                        // é¦–å…ˆå°è¯•æ ¹æ® user_id æŸ¥æ‰¾ç°æœ‰ç”¨æˆ·
                        const { data: existingUserById, error: findByIdError } = await supabaseClient
                            .from('v_unified_analysis_v2')
                            .select('*')
                            .eq('id', githubUserId)
                            .maybeSingle();
                        
                        let updatedUser = null;
                        
                        if (existingUserById) {
                            // ç”¨æˆ·å·²å­˜åœ¨ï¼ˆé€šè¿‡ user_idï¼‰ï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯
                            console.log('[Auth] âœ… æ‰¾åˆ°ç°æœ‰ç”¨æˆ·ï¼ˆé€šè¿‡ user_idï¼‰ï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯');
                            
                            const updatePayload = {
                                user_name: normalizedUsername,
                                user_identity: 'github',
                                updated_at: new Date().toISOString()
                            };
                            
                            // å¦‚æœæœ‰ fingerprintï¼Œä¹Ÿæ›´æ–°ï¼ˆä½†ä¸ä½œä¸ºä¸»è¦æ ‡è¯†ï¼‰
                            if (currentFp) {
                                updatePayload.fingerprint = currentFp;
                            }
                            
                            const { data: updateData, error: updateError } = await supabaseClient
                                .from('user_analysis')
                                .update(updatePayload)
                                .eq('id', githubUserId) // ã€å…³é”®ã€‘ä½¿ç”¨ user_id è€Œä¸æ˜¯ fingerprint
                                .select()
                                .single();
                            
                            if (updateError) {
                                console.error('[Auth] âŒ æ›´æ–°ç”¨æˆ·å¤±è´¥:', updateError);
                                // å³ä½¿æ›´æ–°å¤±è´¥ï¼Œä¹Ÿç»§ç»­ä½¿ç”¨ç°æœ‰ç”¨æˆ·æ•°æ®
                                updatedUser = { ...existingUserById, ...updatePayload };
                            } else {
                                updatedUser = updateData;
                                console.log('[Auth] âœ… ç”¨æˆ·ä¿¡æ¯å·²æˆåŠŸæ›´æ–°ï¼ˆä½¿ç”¨ user_idï¼‰');
                            }
                        } else {
                            // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•ï¼ˆä½¿ç”¨ GitHub User IDï¼‰
                            console.log('[Auth] âœ… ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•ï¼ˆä½¿ç”¨ GitHub User IDï¼‰');
                            
                            const newUserData = {
                                id: githubUserId, // ã€å…³é”®ã€‘ä½¿ç”¨ GitHub User ID
                                user_name: normalizedUsername,
                                user_identity: 'github', // æ˜ç¡®è®¾ç½®èº«ä»½
                                fingerprint: currentFp || null, // å¯é€‰ï¼šå¦‚æœæœ‰ fingerprint ä¹Ÿä¿å­˜
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            };
                            
                            const { data: insertData, error: insertError } = await supabaseClient
                                .from('user_analysis')
                                .insert([newUserData])
                                .select()
                                .single();
                            
                            if (insertError) {
                                console.error('[Auth] âŒ åˆ›å»ºç”¨æˆ·å¤±è´¥:', insertError);
                                
                                // ã€RLS é”™è¯¯å¤„ç†ã€‘å¦‚æœæ˜¯ RLS ç­–ç•¥é”™è¯¯ï¼Œå°è¯•ä½¿ç”¨ upsert
                                if (insertError.code === '42501' || insertError.message?.includes('row-level security')) {
                                    console.log('[Auth] ğŸ”„ RLS ç­–ç•¥é˜»æ­¢æ’å…¥ï¼Œå°è¯•ä½¿ç”¨ upsert...');
                                    
                                    const { data: upsertData, error: upsertError } = await supabaseClient
                                        .from('user_analysis')
                                        .upsert([newUserData], { onConflict: 'id' })
                                        .select()
                                        .single();
                                    
                                    if (upsertError) {
                                        console.error('[Auth] âŒ Upsert ä¹Ÿå¤±è´¥:', upsertError);
                                        // å³ä½¿å¤±è´¥ï¼Œä¹Ÿç»§ç»­ä½¿ç”¨æ–°ç”¨æˆ·æ•°æ®
                                        updatedUser = newUserData;
                                    } else {
                                        updatedUser = upsertData;
                                        console.log('[Auth] âœ… é€šè¿‡ upsert åˆ›å»ºç”¨æˆ·æˆåŠŸ');
                                    }
                                } else {
                                    // å…¶ä»–é”™è¯¯ï¼Œç»§ç»­ä½¿ç”¨æ–°ç”¨æˆ·æ•°æ®
                                    updatedUser = newUserData;
                                }
                            } else {
                                updatedUser = insertData;
                                console.log('[Auth] âœ… æ–°ç”¨æˆ·å·²åˆ›å»ºï¼ˆä½¿ç”¨ GitHub User IDï¼‰');
                            }
                        }
                        
                        // æ›´æ–° window.allDataï¼ˆåœ¨ window.currentUser èµ‹å€¼ä¹‹åï¼‰
                        const allData = window.allData || [];
                        const index = allData.findIndex(item => 
                            item.id === updatedUser.id ||
                            (item.fingerprint && item.fingerprint === currentFp) ||
                            (item.user_name && item.user_name.toLowerCase() === normalizedUsername)
                        );
                        
                        if (index !== -1) {
                            allData[index] = { ...allData[index], ...updatedUser };
                        } else {
                            allData.push(updatedUser);
                        }
                        window.allData = allData;
                        
                        // ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿ window.currentUser åœ¨ upsert æˆåŠŸåç«‹å³èµ‹å€¼
                        window.currentUser = updatedUser;
                        window.currentUserMatchedByFingerprint = true;
                        
                        // ã€Task 1ã€‘æ¸…é™¤æœ¬åœ°çš„ user_fingerprint ç¼“å­˜ï¼Œç»Ÿä¸€ä½¿ç”¨ Supabase User ID
                        localStorage.removeItem('user_fingerprint');
                        console.log('[Auth] âœ… å·²æ¸…é™¤æœ¬åœ° fingerprint ç¼“å­˜');
                        
                        // ã€Task 1ã€‘å¦‚æœå½“å‰ç”¨æˆ·æ˜¯æ–°æ³¨å†Œçš„ï¼ˆdimensions ä¸º nullï¼‰ï¼Œç«‹å³è§¦å‘ä¸€æ¬¡é™é»˜åˆ†æè¯·æ±‚
                        const hasDimensions = updatedUser.dimensions || 
                                            updatedUser.l_score !== null || 
                                            updatedUser.p_score !== null ||
                                            updatedUser.d_score !== null ||
                                            updatedUser.e_score !== null ||
                                            updatedUser.f_score !== null;
                        
                        if (!hasDimensions || 
                            (updatedUser.l_score === 50 && updatedUser.p_score === 50 && 
                             updatedUser.d_score === 50 && updatedUser.e_score === 50 && updatedUser.f_score === 50)) {
                            console.log('[Auth] ğŸ” æ£€æµ‹åˆ°æ–°ç”¨æˆ·ï¼ˆdimensions ä¸ºç©ºæˆ–ä¸ºé»˜è®¤å€¼ï¼‰ï¼Œè§¦å‘é™é»˜åˆ†æ...');
                            
                            // å°è¯•ä» localStorage è·å–æœ€åä¸€æ¬¡åˆ†ææ•°æ®
                            try {
                                const lastAnalysisData = localStorage.getItem('last_analysis_data');
                                if (lastAnalysisData) {
                                    const analysisData = JSON.parse(lastAnalysisData);
                                    console.log('[Auth] ğŸ“Š æ‰¾åˆ°æœ¬åœ°ç¼“å­˜çš„æœ€åä¸€æ¬¡åˆ†ææ•°æ®ï¼Œå‡†å¤‡åŒæ­¥...');
                                    
                                    // è°ƒç”¨åç«¯åˆ†ææ¥å£åŒæ­¥æ•°æ®
                                    if (analysisData.chatData && analysisData.chatData.length > 0) {
                                        try {
                                            // ã€ä¿®å¤ API è·¯å¾„ã€‘ä½¿ç”¨ meta æ ‡ç­¾ä¸­çš„ api-endpoint
                                            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || 
                                                              'https://cursor-clinical-analysis.psterman.workers.dev/';
                                            const analyzeUrl = `${apiEndpoint}api/analyze`;
                                            
                                            const analyzeResponse = await fetch(analyzeUrl, {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'Authorization': `Bearer ${session.access_token}`
                                                },
                                                body: JSON.stringify({
                                                    ...analysisData,
                                                    userId: githubUserId,
                                                    user_name: normalizedUsername,
                                                    fingerprint: currentFp // ä¿®å¤ ReferenceError
                                                })
                                            });
                                            
                                            if (analyzeResponse.ok) {
                                                const analyzeResult = await analyzeResponse.json();
                                                console.log('[Auth] âœ… é™é»˜åˆ†æåŒæ­¥æˆåŠŸ:', analyzeResult);
                                                
                                                // æ›´æ–° updatedUser æ•°æ®
                                                if (analyzeResult.dimensions) {
                                                    updatedUser = { ...updatedUser, ...analyzeResult };
                                                    window.currentUser = updatedUser;
                                                    
                                                    // æ›´æ–° allData
                                                    const allData = window.allData || [];
                                                    const userIndex = allData.findIndex(item => item.id === updatedUser.id);
                                                    if (userIndex !== -1) {
                                                        allData[userIndex] = updatedUser;
                                                    } else {
                                                        allData.push(updatedUser);
                                                    }
                                                    window.allData = allData;
                                                }
                                            } else {
                                                console.warn('[Auth] âš ï¸ é™é»˜åˆ†æåŒæ­¥å¤±è´¥:', await analyzeResponse.text());
                                            }
                                        } catch (analyzeError) {
                                            console.warn('[Auth] âš ï¸ é™é»˜åˆ†æåŒæ­¥å¼‚å¸¸:', analyzeError);
                                        }
                                    }
                                } else {
                                    console.log('[Auth] â„¹ï¸ æœªæ‰¾åˆ°æœ¬åœ°ç¼“å­˜çš„æœ€åä¸€æ¬¡åˆ†ææ•°æ®');
                                }
                            } catch (e) {
                                console.warn('[Auth] âš ï¸ è¯»å–æœ¬åœ°åˆ†ææ•°æ®å¤±è´¥:', e);
                            }
                        }
                        
                        // ã€é¡ºåºé‡ç»„ã€‘Step B: è°ƒç”¨ autoReportSelfï¼ˆä¸ŠæŠ¥å½“å‰åœ°ç†ä½ç½®ï¼Œç¡®ä¿ GitHub è´¦å·æœ‰äº† lat/lngï¼‰
                        console.log('[Auth] ğŸ”„ Step B: å¼€å§‹ä¸ŠæŠ¥åœ°ç†ä½ç½®...');
                        try {
                            const reportResult = await autoReportSelf();
                            if (reportResult.success) {
                                console.log('[Auth] âœ… Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥æˆåŠŸ');
                            } else {
                                console.warn('[Auth] âš ï¸ Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥å¤±è´¥:', reportResult.error);
                            }
                        } catch (reportError) {
                            console.error('[Auth] âŒ Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥å¼‚å¸¸:', reportError);
                        }
                        
                        // ã€é¡ºåºé‡ç»„ã€‘Step C: æœ€åè°ƒç”¨ window.refreshUserStats() åˆ·æ–°è§†å›¾æ•°æ®
                        console.log('[Auth] ğŸ”„ Step C: å¼€å§‹åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡æ•°æ®...');
                        if (typeof window.refreshUserStats === 'function') {
                            try {
                                await window.refreshUserStats();
                                console.log('[Auth] âœ… Step C: refreshUserStats æ‰§è¡Œå®Œæˆ');
                            } catch (refreshError) {
                                // ã€ä¿®å¤ AbortErrorã€‘ç‰¹æ®Šå¤„ç† AbortError
                                if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                    console.log('[Auth] â„¹ï¸ refreshUserStats è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰');
                                } else {
                                    console.error('[Auth] âŒ Step C: refreshUserStats æ‰§è¡Œå¤±è´¥:', refreshError);
                                }
                            }
                            
                            // ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿ refreshUserStats åï¼Œwindow.currentUser å·²æ­£ç¡®è®¾ç½®
                            // å¦‚æœ refreshUserStats æ²¡æœ‰è®¾ç½® currentUserï¼Œä½¿ç”¨ updatedUser
                            if (!window.currentUser && updatedUser) {
                                console.log('[Auth] ğŸ”„ refreshUserStats æœªè®¾ç½® currentUserï¼Œä½¿ç”¨ updatedUser');
                                window.currentUser = updatedUser;
                                
                                // æ›´æ–° allData
                                const allData = window.allData || [];
                                const userIndex = allData.findIndex(item => item.id === updatedUser.id);
                                if (userIndex !== -1) {
                                    allData[userIndex] = updatedUser;
                                } else {
                                    allData.push(updatedUser);
                                }
                                window.allData = allData;
                            }
                            
                            // ã€å…³é”®ä¿®å¤ã€‘å¦‚æœç”¨æˆ·æ•°æ®å·²å­˜åœ¨ä½†æ˜¾ç¤º"æ•°æ®åŒæ­¥ä¸­"ï¼Œå¼ºåˆ¶åˆ·æ–°ç»Ÿè®¡å¡ç‰‡
                            if (window.currentUser) {
                                const leftDrawer = document.getElementById('left-drawer');
                                const leftBody = document.getElementById('left-drawer-body');
                                
                                if (leftBody && typeof renderUserStatsCards === 'function') {
                                    // æ£€æŸ¥æ˜¯å¦æœ‰"æ•°æ®åŒæ­¥ä¸­"å ä½ç¬¦
                                    const syncingCards = leftBody.querySelectorAll('.drawer-item');
                                    let hasSyncingCard = false;
                                    syncingCards.forEach(card => {
                                        const label = card.querySelector('.drawer-item-label');
                                        if (label && (label.textContent === 'æ•°æ®åŒæ­¥ä¸­' || label.textContent.includes('SYNCING'))) {
                                            hasSyncingCard = true;
                                        }
                                    });
                                    
                                    if (hasSyncingCard) {
                                        console.log('[Auth] ğŸ”„ æ£€æµ‹åˆ°"æ•°æ®åŒæ­¥ä¸­"å ä½ç¬¦ï¼Œå¼ºåˆ¶åˆ·æ–°ç»Ÿè®¡å¡ç‰‡...');
                                        // ç§»é™¤æ‰€æœ‰ç»Ÿè®¡å¡ç‰‡ï¼ˆä¿ç•™èº«ä»½é…ç½®å¡ç‰‡ï¼‰
                                        syncingCards.forEach(card => {
                                            const label = card.querySelector('.drawer-item-label');
                                            if (label && (label.textContent === 'æ•°æ®åŒæ­¥ä¸­' || label.textContent.includes('SYNCING') || label.textContent === 'æˆ‘çš„æ•°æ®ç»Ÿè®¡')) {
                                                card.remove();
                                            }
                                        });
                                        // é‡æ–°æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡
                                        renderUserStatsCards(leftBody, window.currentUser);
                                        console.log('[Auth] âœ… å·²å¼ºåˆ¶åˆ·æ–°ç»Ÿè®¡å¡ç‰‡');
                                    }
                                }
                                
                                // åˆ·æ–°æ’åå¡ç‰‡
                                if (typeof renderRankCards === 'function') {
                                    renderRankCards(window.currentUser);
                                }
                            }
                        } else {
                            console.warn('[Auth] âš ï¸ window.refreshUserStats å‡½æ•°ä¸å­˜åœ¨');
                        }
                        
                        // æ›´æ–° UIï¼ˆç¡®ä¿åœ¨æ•°æ®åŠ è½½å®Œæˆåè§¦å‘ï¼‰
                        try {
                            updateAuthUI({ username: githubUsername, avatarUrl });
                            console.log('[Auth] âœ… UI å·²æ›´æ–°ä¸ºå·²ç™»å½•çŠ¶æ€');
                        } catch (uiError) {
                            console.error('[Auth] âŒ UI æ›´æ–°å¤±è´¥:', uiError);
                        }
                        
                        // è§¦å‘åœ°å›¾å®šä½è„‰å†²ï¼ˆç­‰å¾… window.allData åŠ è½½å®Œæˆï¼‰
                        try {
                            // ç¡®ä¿ window.allData å·²åŠ è½½
                            if (!window.allData || window.allData.length === 0) {
                                console.log('[Auth] âš ï¸ allData æœªåŠ è½½ï¼Œç­‰å¾…æ•°æ®åŠ è½½å®Œæˆ...');
                                // å»¶è¿Ÿæ‰§è¡Œï¼Œç­‰å¾… fetchData å®Œæˆ
                                setTimeout(async () => {
                                    try {
                                        const location = await getUserLocation();
                                        if (location && location.lat && location.lng && typeof triggerMapPulse === 'function') {
                                            const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                                            const pulseColor = statusConfig.status_color || '#00ff41';
                                            triggerMapPulse(location.lng, location.lat, githubUsername, pulseColor, avatarUrl, githubUsername);
                                            console.log('[Auth] âœ… å·²è§¦å‘åœ°å›¾è„‰å†²ï¼ˆå»¶è¿Ÿï¼‰');
                                        }
                                    } catch (pulseError) {
                                        console.warn('[Auth] âš ï¸ è§¦å‘åœ°å›¾è„‰å†²å¤±è´¥ï¼ˆå»¶è¿Ÿï¼‰:', pulseError);
                                    }
                                }, 1000);
                            } else {
                                const location = await getUserLocation();
                                if (location && location.lat && location.lng && typeof triggerMapPulse === 'function') {
                                    const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                                    const pulseColor = statusConfig.status_color || '#00ff41';
                                    triggerMapPulse(location.lng, location.lat, githubUsername, pulseColor, avatarUrl, githubUsername);
                                    console.log('[Auth] âœ… å·²è§¦å‘åœ°å›¾è„‰å†²');
                                }
                            }
                        } catch (pulseError) {
                            console.warn('[Auth] âš ï¸ è§¦å‘åœ°å›¾è„‰å†²å¤±è´¥:', pulseError);
                        }
                        
                        // è‡ªåŠ¨æ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡ï¼ˆç­‰å¾… window.allData åŠ è½½å®Œæˆï¼‰
                        try {
                            // ç¡®ä¿ window.allData å·²åŠ è½½
                            if (!window.allData || window.allData.length === 0) {
                                console.log('[Auth] âš ï¸ allData æœªåŠ è½½ï¼Œç­‰å¾…æ•°æ®åŠ è½½å®Œæˆåå†æ‰“å¼€æŠ½å±‰...');
                                // å»¶è¿Ÿæ‰§è¡Œï¼Œç­‰å¾… fetchData å®Œæˆ
                                setTimeout(async () => {
                                    try {
                                        const location = await getUserLocation();
                                        const countryCode = location?.countryCode || updatedUser?.ip_location || null;
                                        const countryName = countryCode && countryNameMap[countryCode]
                                            ? (currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en)
                                            : (countryCode || 'å…¨çƒ');
                                        
                                        if (countryCode && countryCode !== 'å…¨çƒ') {
                                            showDrawersWithCountryData(countryCode, countryName);
                                            console.log('[Auth] âœ… å·²æ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç”¨æˆ·æ•°æ®ï¼ˆå»¶è¿Ÿï¼‰');
                                        } else {
                                            const leftDrawer = document.getElementById('left-drawer');
                                            const leftBody = document.getElementById('left-drawer-body');
                                            if (leftDrawer && leftBody) {
                                                if (!leftDrawer.classList.contains('active')) {
                                                    leftDrawer.classList.add('active');
                                                    const rightDrawer = document.getElementById('right-drawer');
                                                    if (rightDrawer) {
                                                        rightDrawer.classList.add('active');
                                                    }
                                                }
                                                renderUserStatsCards(leftBody, updatedUser);
                                                console.log('[Auth] âœ… å·²åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ï¼ˆå»¶è¿Ÿï¼‰');
                                            }
                                        }
                                    } catch (drawerError) {
                                        console.warn('[Auth] âš ï¸ æ‰“å¼€æŠ½å±‰å¤±è´¥ï¼ˆå»¶è¿Ÿï¼‰:', drawerError);
                                    }
                                }, 1000);
                            } else {
                                const location = await getUserLocation();
                                const countryCode = location?.countryCode || updatedUser?.ip_location || null;
                                const countryName = countryCode && countryNameMap[countryCode]
                                    ? (currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en)
                                    : (countryCode || 'å…¨çƒ');
                                
                                if (countryCode && countryCode !== 'å…¨çƒ') {
                                    showDrawersWithCountryData(countryCode, countryName);
                                    console.log('[Auth] âœ… å·²æ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç”¨æˆ·æ•°æ®');
                                } else {
                                    const leftDrawer = document.getElementById('left-drawer');
                                    const leftBody = document.getElementById('left-drawer-body');
                                    if (leftDrawer && leftBody) {
                                        if (!leftDrawer.classList.contains('active')) {
                                            leftDrawer.classList.add('active');
                                            const rightDrawer = document.getElementById('right-drawer');
                                            if (rightDrawer) {
                                                rightDrawer.classList.add('active');
                                            }
                                        }
                                        renderUserStatsCards(leftBody, updatedUser);
                                        console.log('[Auth] âœ… å·²åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡');
                                    }
                                }
                            }
                        } catch (drawerError) {
                            console.warn('[Auth] âš ï¸ æ‰“å¼€æŠ½å±‰å¤±è´¥:', drawerError);
                        }
                        
                        // åˆ·æ–°æ’åå¡ç‰‡ï¼ˆç¡®ä¿åœ¨æ•°æ®åŠ è½½å®Œæˆåï¼‰
                        try {
                            if (window.currentUser) {
                                renderRankCards(window.currentUser);
                                console.log('[Auth] âœ… å·²åˆ·æ–°æ’åå¡ç‰‡');
                            }
                        } catch (rankError) {
                            console.warn('[Auth] âš ï¸ åˆ·æ–°æ’åå¡ç‰‡å¤±è´¥:', rankError);
                        }
                    }
                } else {
                    // æœªç™»å½•çŠ¶æ€
                    updateAuthUI(null);
                }
            } catch (error) {
                console.error('[Auth] âŒ å¤„ç†è®¤è¯çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
                updateAuthUI(null);
            } finally {
                // ã€å¼‚æ­¥æµä¿æŠ¤ã€‘åœ¨ finally å—ä¸­å¿…é¡»è°ƒç”¨ hideSyncingOverlay()ï¼Œç¡®ä¿æ— è®ºæˆåŠŸå¤±è´¥ï¼ŒUI é®ç½©éƒ½èƒ½æ¶ˆå¤±
                if (timeoutTimer) {
                    clearTimeout(timeoutTimer);
                    timeoutTimer = null;
                }
                hideSyncingOverlay();
                migrationCompleted = true;
            }
        }
        
        /**
         * æ›´æ–°è®¤è¯ UIï¼ˆç™»å½•æŒ‰é’®/ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºï¼‰
         * @param {Object|null} userInfo - ç”¨æˆ·ä¿¡æ¯å¯¹è±¡ { username, avatarUrl } æˆ– null
         */
        function updateAuthUI(userInfo) {
            // æŸ¥æ‰¾è®¤è¯ UI å®¹å™¨ï¼ˆå¯èƒ½åœ¨å¤šä¸ªä½ç½®ï¼‰
            const authContainers = [
                document.getElementById('auth-container'),
                document.querySelector('.auth-container'),
                document.querySelector('[data-auth-container]')
            ].filter(Boolean);
            
            // å¦‚æœæ²¡æœ‰ä¸“é—¨çš„å®¹å™¨ï¼Œåœ¨å·¦ä¾§æŠ½å±‰ä¸­æ›´æ–°
            const leftBody = document.getElementById('left-drawer-body');
            const identityCard = leftBody ? leftBody.querySelector('.drawer-item:first-child') : null;
            
            if (userInfo) {
                // å·²ç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                console.log('[Auth] âœ… æ›´æ–° UI ä¸ºå·²ç™»å½•çŠ¶æ€:', userInfo.username);
                
                    // æ›´æ–°å·¦ä¾§æŠ½å±‰ä¸­çš„èº«ä»½å¡ç‰‡
                const leftBody = document.getElementById('left-drawer-body');
                if (leftBody) {
                    const identityCard = leftBody.querySelector('.drawer-item:first-child');
                    if (identityCard) {
                        const userInfoSection = identityCard.querySelector('.mb-3.pb-3.border-b');
                        const loginSection = identityCard.querySelector('#auth-login-section') || 
                                            identityCard.querySelector('.mt-3.pt-3.border-t');
                        
                        if (userInfoSection) {
                            userInfoSection.innerHTML = `
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-8 h-8 rounded-full overflow-hidden border border-[#00ff41]/30 flex-shrink-0">
                                        <img 
                                            src="${userInfo.avatarUrl}" 
                                            alt="Avatar" 
                                            class="w-full h-full object-cover"
                                            onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                        />
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="drawer-item-value text-sm truncate">${userInfo.username}</div>
                                        <div class="drawer-item-desc text-[8px]">GitHub Account</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // æ›´æ–°ç™»å½•åŒºåŸŸ
                        if (loginSection) {
                            loginSection.innerHTML = `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <img 
                                            src="${userInfo.avatarUrl}" 
                                            alt="${userInfo.username}"
                                            class="w-6 h-6 rounded-full border border-[#00ff41]/30"
                                            onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                        />
                                        <div>
                                            <div class="text-[10px] text-white font-bold">${userInfo.username}</div>
                                            <a 
                                                href="https://github.com/${userInfo.username}" 
                                                target="_blank"
                                                class="text-[8px] text-[#00ff41]/60 hover:text-[#00ff41] transition-colors"
                                            >
                                                æŸ¥çœ‹ GitHub
                                            </a>
                                        </div>
                                    </div>
                                    <button 
                                        onclick="logout()"
                                        class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-[8px] text-zinc-400 hover:text-white transition-colors rounded"
                                    >
                                        é€€å‡º
                                    </button>
                                </div>
                            `;
                        }
                    }
                }
            } else {
                // æœªç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤ºç™»å½•æŒ‰é’®
                console.log('[Auth] âœ… æ›´æ–° UI ä¸ºæœªç™»å½•çŠ¶æ€');
                
                // æ›´æ–°å·¦ä¾§æŠ½å±‰ä¸­çš„èº«ä»½å¡ç‰‡
                const leftBody = document.getElementById('left-drawer-body');
                if (leftBody) {
                    const identityCard = leftBody.querySelector('.drawer-item:first-child');
                    if (identityCard) {
                        const userInfoSection = identityCard.querySelector('.mb-3.pb-3.border-b');
                        const loginSection = identityCard.querySelector('#auth-login-section') || 
                                            identityCard.querySelector('.mt-3.pt-3.border-t');
                        
                        if (userInfoSection) {
                            userInfoSection.innerHTML = `
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-8 h-8 rounded-full overflow-hidden border border-zinc-700 flex-shrink-0 bg-zinc-800 flex items-center justify-center">
                                        <span class="text-lg">ğŸ‘¤</span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="drawer-item-value text-sm text-zinc-500">æœªç™»å½•</div>
                                        <div class="drawer-item-desc text-[8px]">è¯·ä½¿ç”¨ GitHub ç™»å½•</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // æ›¿æ¢ç™»å½•è¾“å…¥æ¡†ä¸ºç™»å½•æŒ‰é’®
                        if (loginSection) {
                            loginSection.innerHTML = `
                                <div class="drawer-item-label mb-2">GitHub ç™»å½•</div>
                                <button 
                                    onclick="loginWithGitHub()"
                                    class="w-full px-4 py-3 bg-[#24292e] hover:bg-[#2f363d] border border-[#444d56] rounded-md text-white text-sm font-semibold flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl"
                                >
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ä½¿ç”¨ GitHub ç™»å½•</span>
                                </button>
                                <div class="text-[8px] text-[#00ff41]/40 mt-2 text-center">
                                    å®‰å…¨ã€å¿«é€Ÿã€ä¸€é”®ç™»å½•
                                </div>
                            `;
                        }
                    }
                }
            }
        }
        
        /**
         * è·å–å½“å‰æµè§ˆå™¨æŒ‡çº¹ï¼ˆä¸é¡µé¢åŠ è½½æ—¶ç”Ÿæˆé€»è¾‘ä¸€è‡´ï¼‰
         * @returns {Promise<string>} æŒ‡çº¹å­—ç¬¦ä¸²
         */
        async function getCurrentFingerprint() {
            try {
                // å…ˆå°è¯•ä» localStorage è¯»å–
                let fingerprint = localStorage.getItem('user_fingerprint');
                
                if (!fingerprint) {
                    // å¦‚æœä¸å­˜åœ¨ï¼Œç”Ÿæˆæ–°çš„æŒ‡çº¹ï¼ˆä¸ window.onload ä¸­çš„é€»è¾‘ä¸€è‡´ï¼‰
                    const deviceInfo = {
                        userAgent: navigator.userAgent || '',
                        language: navigator.language || '',
                        platform: navigator.platform || '',
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || ''
                    };
                    const deviceString = JSON.stringify(deviceInfo);
                    const msgUint8 = new TextEncoder().encode(deviceString);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                    fingerprint = Array.from(new Uint8Array(hashBuffer))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                    
                    try {
                        localStorage.setItem('user_fingerprint', fingerprint);
                        console.log('[Fingerprint] ğŸ”‘ å·²ç”Ÿæˆè®¾å¤‡ Fingerprint:', fingerprint.substring(0, 8) + '...');
                    } catch (e) {
                        console.warn('[Fingerprint] âš ï¸ ä¿å­˜ Fingerprint åˆ° localStorage å¤±è´¥:', e);
                    }
                }
                
                return fingerprint;
            } catch (error) {
                console.error('[Fingerprint] âŒ è·å–æŒ‡çº¹å¤±è´¥:', error);
                return null;
            }
        }

        /**
         * ä¿å­˜GitHubç”¨æˆ·ååˆ°localStorageå¹¶ç»‘å®šæŒ‡çº¹
         * ä½¿ç”¨ Supabase å®¢æˆ·ç«¯ç›´æ¥æ›´æ–° fingerprint å­—æ®µ
         * ã€å¢å¼ºç‰ˆã€‘åŒ…å«é²æ£’çš„å…ƒç´ è·å–ã€å¼ºåˆ¶æŒ‡çº¹ç»‘å®šã€UIçŠ¶æ€è”åŠ¨
         */
        async function saveGitHubUsername() {
            // ============================================
            // 1. é²æ£’çš„å…ƒç´ è·å–ï¼ˆå¤šé‡é€‰æ‹©å™¨ï¼‰
            // ============================================
            let input = null;
            let saveButton = null;
            
            // å°è¯•å¤šç§æ–¹å¼è·å–è¾“å…¥æ¡†ï¼ˆæ”¯æŒä¸»è¾“å…¥æ¡†å’ŒæŠ½å±‰è¾“å…¥æ¡†ï¼‰
            input = document.getElementById('githubUsername') ||
                   document.getElementById('drawer-github-username') ||
                   document.querySelector('#githubUsername') ||
                   document.querySelector('#drawer-github-username') ||
                   document.querySelector('input[id="githubUsername"]') ||
                   document.querySelector('input[id="drawer-github-username"]') ||
                   document.querySelector('input[placeholder*="GitHub"]') ||
                   document.querySelector('input[placeholder*="github"]');
            
            // å¦‚æœæ‰¾åˆ°æŠ½å±‰è¾“å…¥æ¡†ï¼ŒåŒæ­¥åˆ°ä¸»è¾“å…¥æ¡†
            if (input && input.id === 'drawer-github-username') {
                const mainInput = document.getElementById('githubUsername');
                if (mainInput) {
                    mainInput.value = input.value;
                    console.log('[GitHub] âœ… å·²åŒæ­¥æŠ½å±‰è¾“å…¥æ¡†åˆ°ä¸»è¾“å…¥æ¡†');
                }
            }
            
            // å°è¯•è·å–ä¿å­˜æŒ‰é’®ï¼ˆç”¨äºæ˜¾ç¤º Loading çŠ¶æ€ï¼‰
            saveButton = document.querySelector('button[onclick*="saveGitHubUsername"]') ||
                        document.querySelector('button:has-text("ä¿å­˜")') ||
                        document.querySelector('.drawer-item button');
            
            // å¦‚æœæ‰¾ä¸åˆ°è¾“å…¥æ¡†ï¼Œæ‰“å°è¯¦ç»†çš„ DOM ç»“æ„è­¦å‘Š
            if (!input) {
                console.error('[GitHub] âŒ æ‰¾ä¸åˆ° GitHub è¾“å…¥æ¡†å…ƒç´ ');
                console.warn('[GitHub] ğŸ” DOM ç»“æ„è¯Šæ–­:', {
                    hasGetElementById: typeof document.getElementById === 'function',
                    allInputs: Array.from(document.querySelectorAll('input')).map(el => ({
                        id: el.id,
                        name: el.name,
                        placeholder: el.placeholder,
                        type: el.type
                    })),
                    bodyHTML: document.body ? document.body.innerHTML.substring(0, 500) : 'body ä¸å­˜åœ¨'
                });
                alert('æ— æ³•æ‰¾åˆ° GitHub è¾“å…¥æ¡†ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                return;
            }
            
            // ============================================
            // 2. è·å–ç”¨æˆ·åå¹¶éªŒè¯
            // ============================================
            const username = input.value.trim();
            if (username === '') {
                // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œæ¸…é™¤localStorage
                localStorage.removeItem('github_username');
                console.log('[GitHub] âœ… å·²æ¸…é™¤GitHubç”¨æˆ·å');
                alert('å·²æ¸…é™¤GitHubç”¨æˆ·å');
                return;
            }
            
            // éªŒè¯ GitHub ç”¨æˆ·åæ ¼å¼
            if (!isValidGitHubUsername(username)) {
                alert('GitHub ç”¨æˆ·åæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥åé‡è¯•');
                return;
            }
            
            // ============================================
            // 3. æ˜¾ç¤º Loading çŠ¶æ€
            // ============================================
            const originalButtonText = saveButton ? saveButton.textContent : '';
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.textContent = 'ä¿å­˜ä¸­...';
                saveButton.style.opacity = '0.6';
            }
            
            try {
                // ============================================
                // 4. å¼ºåˆ¶æŒ‡çº¹ç»‘å®šæµï¼ˆåœ¨ localStorage æ›´æ–°ä¹‹å‰å®Œæˆï¼‰
                // ============================================
                
                // 4.1 è·å–å½“å‰æŒ‡çº¹ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„æŒ‡çº¹ç”Ÿæˆå‡½æ•°ï¼‰
                const currentFingerprint = await getCurrentFingerprint();
                
                if (!currentFingerprint) {
                    console.warn('[GitHub] âš ï¸ æœªæ‰¾åˆ°æŒ‡çº¹ï¼Œæ— æ³•ç»‘å®š');
                    alert('æœªæ‰¾åˆ°è®¾å¤‡æŒ‡çº¹ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                    return;
                }
                
                console.log('[GitHub] ğŸ”‘ å½“å‰æŒ‡çº¹:', currentFingerprint.substring(0, 8) + '...');
                
                // 4.2 æ£€æŸ¥ Supabase å®¢æˆ·ç«¯
                if (!supabaseClient) {
                    console.error('[GitHub] âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                    alert('æ•°æ®åº“è¿æ¥æœªå°±ç»ªï¼Œè¯·ç¨å€™å†è¯•');
                    return;
                }
                
                // 4.3 è§„èŒƒåŒ–ç”¨æˆ·åï¼ˆå°å†™ï¼‰
                const normalizedUsername = username.toLowerCase().trim();
                
                console.log('[GitHub] ğŸ”— å¼€å§‹ç»‘å®šæŒ‡çº¹åˆ° user_name:', normalizedUsername);
                
                // ã€å…³é”®ä¿®å¤ã€‘ç™»å½•åå¿…é¡»ä½¿ç”¨ user_id è¿›è¡Œæ‰€æœ‰æ“ä½œï¼Œè€Œä¸æ˜¯ fingerprint æˆ– user_name
                // è¿™æ˜¯"è®¤ç¥–å½’å®—"çš„å…³é”®ï¼šç¡®ä¿æ•°æ®å…³è”åˆ°æ­£ç¡®çš„ GitHub è´¦å·
                let authenticatedUserId = null;
                let authenticatedSession = null;
                
                try {
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    if (!sessionError && session && session.user) {
                        authenticatedUserId = session.user.id;
                        authenticatedSession = session;
                        console.log('[GitHub] âœ… æ£€æµ‹åˆ°å·²ç™»å½•ç”¨æˆ·ï¼Œuser_id:', authenticatedUserId.substring(0, 8) + '...');
                    }
                } catch (authError) {
                    console.warn('[GitHub] âš ï¸ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', authError);
                }
                
                let updatedUser = null;
                
                // ã€å…³é”®ä¿®å¤ã€‘å¦‚æœå·²ç™»å½•ï¼Œå¿…é¡»ä½¿ç”¨ user_id è¿›è¡Œæ›´æ–°
                if (authenticatedUserId) {
                    console.log('[GitHub] ğŸ”— å·²ç™»å½•ï¼Œä½¿ç”¨ user_id è¿›è¡Œæ›´æ–°ï¼ˆè®¤ç¥–å½’å®—ï¼‰:', authenticatedUserId.substring(0, 8) + '...');
                    
                    // é¦–å…ˆå°è¯•æ ¹æ® user_id æŸ¥æ‰¾ç°æœ‰ç”¨æˆ·
                    const { data: existingUserById, error: findByIdError } = await supabaseClient
                        .from('v_unified_analysis_v2')
                        .select('*')
                        .eq('id', authenticatedUserId)
                        .maybeSingle();
                    
                    if (findByIdError && findByIdError.code !== 'PGRST116') {
                        console.error('[GitHub] âŒ æŸ¥è¯¢ç”¨æˆ·å¤±è´¥:', findByIdError);
                        throw new Error(`æŸ¥è¯¢å¤±è´¥: ${findByIdError.message}`);
                    }
                    
                    // æ‰§è¡Œæ›´æ–°ï¼ˆä½¿ç”¨ user_idï¼‰
                    const updatePayload = {
                        user_name: normalizedUsername,
                        user_identity: 'github',
                        fingerprint: currentFingerprint, // å¯é€‰ï¼šä¿å­˜ fingerprint ä½œä¸ºå¤‡ç”¨
                        updated_at: new Date().toISOString()
                    };
                    
                    const { data, error: updateError } = await supabaseClient
                        .from('user_analysis')
                        .update(updatePayload)
                        .eq('id', authenticatedUserId) // ã€å…³é”®ã€‘ä½¿ç”¨ user_id è€Œä¸æ˜¯ user_name
                        .select()
                        .single();
                    
                    if (updateError) {
                        console.error('[GitHub] âŒ æ›´æ–°ç”¨æˆ·å¤±è´¥:', updateError);
                        
                        // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ upsert
                        if (updateError.code === '42501' || updateError.message?.includes('row-level security')) {
                            console.log('[GitHub] ğŸ”„ RLS ç­–ç•¥é˜»æ­¢æ›´æ–°ï¼Œå°è¯•ä½¿ç”¨ upsert...');
                            
                            const upsertPayload = {
                                id: authenticatedUserId,
                                user_name: normalizedUsername,
                                user_identity: 'github',
                                fingerprint: currentFingerprint,
                                updated_at: new Date().toISOString()
                            };
                            
                            const { data: upsertData, error: upsertError } = await supabaseClient
                                .from('user_analysis')
                                .upsert([upsertPayload], { onConflict: 'id' })
                                .select()
                                .single();
                            
                            if (upsertError) {
                                console.error('[GitHub] âŒ Upsert ä¹Ÿå¤±è´¥:', upsertError);
                                throw new Error(`æ›´æ–°å¤±è´¥: ${upsertError.message}`);
                            } else {
                                updatedUser = upsertData;
                                console.log('[GitHub] âœ… é€šè¿‡ upsert æ›´æ–°ç”¨æˆ·æˆåŠŸï¼ˆä½¿ç”¨ user_idï¼‰');
                            }
                        } else {
                            throw new Error(`æ›´æ–°å¤±è´¥: ${updateError.message}`);
                        }
                    } else {
                        updatedUser = data;
                        console.log('[GitHub] âœ… ç”¨æˆ·ä¿¡æ¯å·²æˆåŠŸæ›´æ–°ï¼ˆä½¿ç”¨ user_idï¼‰');
                    }
                } else {
                    // ã€é™çº§æ–¹æ¡ˆã€‘æœªç™»å½•æ—¶ï¼Œä½¿ç”¨ user_name è¿›è¡Œæ›´æ–°ï¼ˆå…¼å®¹æ—§é€»è¾‘ï¼‰
                    console.log('[GitHub] âš ï¸ æœªç™»å½•ï¼Œä½¿ç”¨ user_name è¿›è¡Œæ›´æ–°ï¼ˆé™çº§æ–¹æ¡ˆï¼‰');
                    
                    // 4.4 é¦–å…ˆå°è¯•æ ¹æ® user_name æŸ¥æ‰¾ç°æœ‰ç”¨æˆ·
                    // ã€Task 2ã€‘æŸ¥è¯¢æ—¶ä½¿ç”¨ç»Ÿä¸€è§†å›¾
                    const { data: existingUser, error: findError } = await supabaseClient
                        .from('v_unified_analysis_v2')
                        .select('*')
                        .eq('user_name', normalizedUsername)
                        .maybeSingle();
                    
                    if (findError && findError.code !== 'PGRST116') { // PGRST116 è¡¨ç¤ºæœªæ‰¾åˆ°è®°å½•ï¼Œè¿™æ˜¯æ­£å¸¸çš„
                        console.error('[GitHub] âŒ æŸ¥è¯¢ç”¨æˆ·å¤±è´¥:', findError);
                        throw new Error(`æŸ¥è¯¢å¤±è´¥: ${findError.message}`);
                    }
                    
                    // 4.5 æ‰§è¡Œ UPSERT æ“ä½œï¼ˆæ›´æ–°æˆ–åˆ›å»ºï¼‰
                    if (existingUser) {
                        // ç”¨æˆ·å·²å­˜åœ¨ï¼Œæ›´æ–° fingerprint å­—æ®µ
                        console.log('[GitHub] âœ… æ‰¾åˆ°ç°æœ‰ç”¨æˆ·ï¼Œæ›´æ–° fingerprint å­—æ®µ');
                        
                        // ã€ä¿®å¤ã€‘åªä½¿ç”¨ user_name å­—æ®µï¼Œä¸ä½¿ç”¨ github_username
                        const { data, error: updateError } = await supabaseClient
                                .from('user_analysis')
                                .update({
                                    fingerprint: currentFingerprint,
                                    user_name: normalizedUsername,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('user_name', normalizedUsername)
                                .select()
                                .single();
                        
                        if (updateError) {
                            console.error('[GitHub] âŒ æ›´æ–°ç”¨æˆ·å¤±è´¥:', updateError);
                            throw new Error(`æ›´æ–°å¤±è´¥: ${updateError.message}`);
                        }
                        
                        updatedUser = data;
                        console.log('[GitHub] âœ… æŒ‡çº¹å·²æˆåŠŸæ›´æ–°åˆ°æ•°æ®åº“');
                    } else {
                        // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•
                        console.log('[GitHub] âœ… ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•');
                        
                        // ã€ä¿®å¤ã€‘åªä½¿ç”¨ user_name å­—æ®µï¼Œä¸ä½¿ç”¨ github_username
                        const newUserData = {
                            id: crypto.randomUUID(),
                            user_name: normalizedUsername,
                            fingerprint: currentFingerprint,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        
                        const { data, error: insertError } = await supabaseClient
                            .from('user_analysis')
                            .insert([newUserData])
                            .select()
                            .single();
                        
                        if (insertError) {
                            console.error('[GitHub] âŒ åˆ›å»ºç”¨æˆ·å¤±è´¥:', insertError);
                            throw new Error(`åˆ›å»ºå¤±è´¥: ${insertError.message}`);
                        }
                        
                        updatedUser = data;
                        console.log('[GitHub] âœ… æ–°ç”¨æˆ·å·²åˆ›å»ºï¼ŒæŒ‡çº¹å·²ç»‘å®š');
                    }
                }
                
                // ============================================
                // 5. æ›´æ–° localStorageï¼ˆåœ¨æ•°æ®åº“æ›´æ–°æˆåŠŸåï¼‰
                // ============================================
                localStorage.setItem('github_username', username);
                console.log('[GitHub] âœ… å·²ä¿å­˜GitHubç”¨æˆ·ååˆ° localStorage:', username);
                
                // ============================================
                // 6. UI çŠ¶æ€è”åŠ¨ï¼ˆåœ°å›¾ä¸å¡ç‰‡ï¼‰
                // ============================================
                console.log('[GitHub] ğŸ”„ å¼€å§‹åˆ·æ–°å…¨å±€æ•°æ®å’Œ UI...');
                
                // 6.1 æ›´æ–°å…¨å±€ç”¨æˆ·æ•°æ®
                window.currentUser = updatedUser;
                window.currentUserMatchedByFingerprint = true;
                
                // 6.2 æ›´æ–° window.allData ä¸­çš„å¯¹åº”è®°å½•
                const allData = window.allData || [];
                const index = allData.findIndex(item => 
                    item.id === updatedUser.id ||
                    (item.fingerprint && item.fingerprint === currentFingerprint) ||
                    (item.user_name && item.user_name.toLowerCase() === normalizedUsername)
                );
                
                if (index !== -1) {
                    allData[index] = { ...allData[index], ...updatedUser };
                    console.log('[GitHub] âœ… å·²æ›´æ–° allData ä¸­çš„è®°å½•ï¼Œç´¢å¼•:', index);
                } else {
                    allData.push(updatedUser);
                    console.log('[GitHub] âœ… å·²æ·»åŠ æ–°è®°å½•åˆ° allData');
                }
                window.allData = allData;
                
                // 6.3 åˆ·æ–°æ’åå¡ç‰‡
                if (window.currentUser) {
                    renderRankCards(window.currentUser);
                    console.log('[GitHub] âœ… å·²åˆ·æ–°æ’åå¡ç‰‡');
                }
                
                // 6.4 è§¦å‘åœ°å›¾è„‰å†²ï¼ˆå¦‚æœç”¨æˆ·æœ‰åœ°ç†ä½ç½®ä¿¡æ¯ï¼‰
                try {
                    // è·å–ç”¨æˆ·åœ°ç†ä½ç½®ï¼ˆæ— è®ºæ•°æ®åº“ä¸­æ˜¯å¦æœ‰ï¼Œéƒ½å°è¯•è·å–å½“å‰ä½ç½®ï¼‰
                    const location = await getUserLocation();
                    if (location && location.lat && location.lng && typeof triggerMapPulse === 'function') {
                        const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                        const pulseColor = statusConfig.status_color || '#00ff41';
                        const pulseLabel = normalizedUsername;
                        const avatarUrl = getGitHubAvatarUrl(normalizedUsername);
                        
                        triggerMapPulse(location.lng, location.lat, pulseLabel, pulseColor, avatarUrl, normalizedUsername);
                        console.log('[GitHub] âœ… å·²è§¦å‘åœ°å›¾è„‰å†²:', {
                            lng: location.lng,
                            lat: location.lat,
                            label: pulseLabel,
                            color: pulseColor
                        });
                    } else if (!location || !location.lat || !location.lng) {
                        console.log('[GitHub] â„¹ï¸ æ— æ³•è·å–åœ°ç†ä½ç½®ï¼Œè·³è¿‡åœ°å›¾è„‰å†²');
                    }
                } catch (pulseError) {
                    console.warn('[GitHub] âš ï¸ è§¦å‘åœ°å›¾è„‰å†²å¤±è´¥:', pulseError);
                }
                
                // 6.5 è‡ªåŠ¨æ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç”¨æˆ·ç»Ÿè®¡å¡ç‰‡
                try {
                    // è·å–ç”¨æˆ·çš„å›½å®¶ä»£ç ï¼ˆä» ip_location æˆ– locationï¼Œæˆ–ä»åœ°ç†ä½ç½®è·å–ï¼‰
                    let userCountryCode = updatedUser.ip_location || updatedUser.location || null;
                    
                    // å¦‚æœæ²¡æœ‰å›½å®¶ä»£ç ï¼Œå°è¯•ä»åœ°ç†ä½ç½®è·å–
                    if (!userCountryCode) {
                        try {
                            const location = await getUserLocation();
                            if (location && location.countryCode) {
                                userCountryCode = location.countryCode;
                                console.log('[GitHub] âœ… ä»åœ°ç†ä½ç½®è·å–å›½å®¶ä»£ç :', userCountryCode);
                            }
                        } catch (geoError) {
                            console.warn('[GitHub] âš ï¸ è·å–åœ°ç†ä½ç½®å¤±è´¥:', geoError);
                        }
                    }
                    
                    const userCountryName = userCountryCode && countryNameMap[userCountryCode]
                        ? (currentLang === 'zh' ? countryNameMap[userCountryCode].zh : countryNameMap[userCountryCode].en)
                        : (userCountryCode || 'å…¨çƒ');
                    
                    // è·å–æŠ½å±‰å…ƒç´ 
                    const leftDrawer = document.getElementById('left-drawer');
                    const leftBody = document.getElementById('left-drawer-body');
                    const rightDrawer = document.getElementById('right-drawer');
                    
                    if (userCountryCode && userCountryCode !== 'å…¨çƒ') {
                        // å¦‚æœæœ‰å›½å®¶ä»£ç ï¼Œæ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç”¨æˆ·æ•°æ®
                        showDrawersWithCountryData(userCountryCode, userCountryName);
                        console.log('[GitHub] âœ… å·²æ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç”¨æˆ·æ•°æ®:', userCountryCode);
                    } else {
                        // å¦‚æœæ²¡æœ‰å›½å®¶ä»£ç ï¼Œç›´æ¥åˆ·æ–°å·¦ä¾§æŠ½å±‰çš„ç»Ÿè®¡å¡ç‰‡
                        // å¦‚æœæŠ½å±‰æœªæ‰“å¼€ï¼Œå…ˆæ‰“å¼€å®ƒ
                        if (leftDrawer && !leftDrawer.classList.contains('active')) {
                            leftDrawer.classList.add('active');
                            if (rightDrawer) {
                                rightDrawer.classList.add('active');
                            }
                            console.log('[GitHub] âœ… å·²æ‰“å¼€æŠ½å±‰');
                        }
                        
                        // åˆ·æ–°ç»Ÿè®¡å¡ç‰‡
                        if (leftBody) {
                            // ç§»é™¤ç­‰å¾…å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            const waitingCards = leftBody.querySelectorAll('.drawer-item');
                            waitingCards.forEach(card => {
                                const label = card.querySelector('.drawer-item-label');
                                if (label && (label.textContent === 'æ•°æ®åŠ è½½ä¸­' || label.textContent.includes('WAIT'))) {
                                    card.remove();
                                    console.log('[GitHub] âœ… å·²ç§»é™¤ç­‰å¾…å¡ç‰‡');
                                }
                            });
                            
                            // æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡
                            renderUserStatsCards(leftBody, updatedUser);
                            console.log('[GitHub] âœ… å·²åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡');
                        }
                    }
                } catch (drawerError) {
                    console.warn('[GitHub] âš ï¸ æ‰“å¼€æŠ½å±‰å¤±è´¥:', drawerError);
                }
                
                // 6.6 ä¿®å¤"åŒ¿åä¸“å®¶"æ˜¾ç¤ºé—®é¢˜ï¼šæ›´æ–°æ‰€æœ‰æ˜¾ç¤ºç”¨æˆ·åçš„ UI å…ƒç´ 
                try {
                    // æ›´æ–°å·¦ä¾§æŠ½å±‰ä¸­çš„æ˜¾ç¤ºåç§°
                    const leftTitle = document.getElementById('left-drawer-title');
                    if (leftTitle) {
                        const currentTitle = leftTitle.textContent || '';
                        if (!currentTitle.includes(normalizedUsername)) {
                            // ç§»é™¤"ï¼ˆå½“å‰è®¾å¤‡ï¼‰"æ ‡è¯†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œç„¶åæ·»åŠ æ–°çš„
                            const cleanTitle = currentTitle.replace(/\s*ï¼ˆå½“å‰è®¾å¤‡ï¼‰\s*$/, '');
                            leftTitle.textContent = normalizedUsername + 'ï¼ˆå½“å‰è®¾å¤‡ï¼‰';
                            console.log('[GitHub] âœ… å·²æ›´æ–°æŠ½å±‰æ ‡é¢˜:', leftTitle.textContent);
                        }
                    }
                    
                    // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º"åŒ¿åä¸“å®¶"çš„å…ƒç´ ï¼ˆæ›´ç²¾ç¡®çš„åŒ¹é…ï¼‰
                    const fingerprintPrefix = currentFingerprint.substring(0, 6).toUpperCase();
                    const anonymousPattern = new RegExp(`åŒ¿åä¸“å®¶\\s+${fingerprintPrefix}`, 'i');
                    
                    // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½åŒ…å«"åŒ¿åä¸“å®¶"çš„å…ƒç´ 
                    const allElements = document.querySelectorAll('*');
                    let updateCount = 0;
                    
                    allElements.forEach(el => {
                        // è·³è¿‡ script å’Œ style æ ‡ç­¾
                        if (el.tagName === 'SCRIPT' || el.tagName === 'STYLE') {
                            return;
                        }
                        
                        // æ£€æŸ¥æ–‡æœ¬å†…å®¹
                        if (el.textContent && anonymousPattern.test(el.textContent)) {
                            el.textContent = el.textContent.replace(anonymousPattern, normalizedUsername);
                            updateCount++;
                        }
                        
                        // æ£€æŸ¥å±æ€§å€¼ï¼ˆå¦‚ placeholder, title ç­‰ï¼‰
                        Array.from(el.attributes || []).forEach(attr => {
                            if (attr.value && anonymousPattern.test(attr.value)) {
                                el.setAttribute(attr.name, attr.value.replace(anonymousPattern, normalizedUsername));
                                updateCount++;
                            }
                        });
                    });
                    
                    if (updateCount > 0) {
                        console.log('[GitHub] âœ… å·²æ›´æ–°', updateCount, 'ä¸ª"åŒ¿åä¸“å®¶"æ˜¾ç¤º');
                    }
                    
                    // å¼ºåˆ¶åˆ·æ–°æ’åå¡ç‰‡ä¸­çš„ç”¨æˆ·åæ˜¾ç¤º
                    setTimeout(() => {
                        if (window.currentUser) {
                            renderRankCards(window.currentUser);
                            console.log('[GitHub] âœ… å·²å¼ºåˆ¶åˆ·æ–°æ’åå¡ç‰‡ï¼ˆä¿®å¤åŒ¿åä¸“å®¶æ˜¾ç¤ºï¼‰');
                        }
                    }, 100);
                    
                } catch (updateError) {
                    console.warn('[GitHub] âš ï¸ æ›´æ–°åŒ¿åä¸“å®¶æ˜¾ç¤ºå¤±è´¥:', updateError);
                }
                
                // 6.7 æ›´æ–°å¤´åƒæ˜¾ç¤º
                updateGitHubAvatar();
                
                // 6.8 å¦‚æœPresenceé¢‘é“å·²è¿æ¥ï¼Œç«‹å³åŒæ­¥çŠ¶æ€
                if (presenceChannel) {
                    syncPresenceState().then(() => {
                        console.log('[GitHub] âœ… å·²æ›´æ–°åœ¨çº¿çŠ¶æ€ï¼ˆåŒ…å«æ–°å¤´åƒï¼‰');
                    }).catch((err) => {
                        console.warn('[GitHub] âš ï¸ æ›´æ–°åœ¨çº¿çŠ¶æ€å¤±è´¥:', err);
                    });
                }
                
                // 6.9 æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆæ¸…ç†æ—§çš„æŒ‡çº¹åŒ¹é…æŠ¥é”™ï¼‰
                console.log('[GitHub] ğŸ‰ ç»‘å®šæµç¨‹å…¨éƒ¨å®Œæˆï¼');
                alert('âœ… GitHubç”¨æˆ·åå·²ä¿å­˜å¹¶ç»‘å®šæˆåŠŸï¼\n\n' +
                      'â€¢ æŒ‡çº¹å·²æ›´æ–°åˆ°æ•°æ®åº“\n' +
                      'â€¢ åœ°å›¾è„‰å†²å·²è§¦å‘\n' +
                      'â€¢ ç»Ÿè®¡å¡ç‰‡å·²åˆ·æ–°\n' +
                      'â€¢ ç”¨æˆ·åå·²æ›´æ–°');
                
            } catch (error) {
                const errorMessage = error && typeof error === 'object' && 'message' in error 
                    ? error.message 
                    : (typeof error === 'string' ? error : 'æœªçŸ¥é”™è¯¯');
                console.error('[GitHub] âŒ ç»‘å®šæŒ‡çº¹å¤±è´¥:', error);
                alert(`ç»‘å®šå¤±è´¥: ${errorMessage}\n\nè¯·æ£€æŸ¥ï¼š\n1. Supabase RLS ç­–ç•¥æ˜¯å¦å…è®¸æ›´æ–°\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = originalButtonText || 'ä¿å­˜';
                    saveButton.style.opacity = '1';
                }
            }
        }

        /**
         * ä»localStorageåŠ è½½GitHubç”¨æˆ·åå¹¶å¡«å……åˆ°è¾“å…¥æ¡†
         */
        /**
         * æ›´æ–°GitHubå¤´åƒæ˜¾ç¤º
         */
        function updateGitHubAvatar() {
            const input = document.getElementById('githubUsername');
            const avatarContainer = document.getElementById('githubAvatarContainer');
            const avatarImg = document.getElementById('githubAvatarImg');
            
            if (!input || !avatarContainer || !avatarImg) {
                return;
            }
            
            const username = input.value.trim();
            
            if (username && isValidGitHubUsername(username)) {
                // æ˜¾ç¤ºå¤´åƒå®¹å™¨
                avatarContainer.classList.remove('hidden');
                // è®¾ç½®å¤´åƒURL
                const avatarUrl = getGitHubAvatarUrl(username);
                avatarImg.src = avatarUrl;
                console.log('[GitHub] âœ… å·²æ›´æ–°å¤´åƒ:', avatarUrl);
            } else {
                // éšè—å¤´åƒå®¹å™¨
                avatarContainer.classList.add('hidden');
            }
        }

        function loadGitHubUsername() {
            const input = document.getElementById('githubUsername');
            if (!input) {
                return;
            }
            
            const savedUsername = localStorage.getItem('github_username');
            if (savedUsername) {
                input.value = savedUsername;
                console.log('[GitHub] âœ… å·²åŠ è½½ä¿å­˜çš„GitHubç”¨æˆ·å:', savedUsername);
                // åŠ è½½å¤´åƒ
                updateGitHubAvatar();
            }
        }

        /**
         * è·å–ç”¨æˆ·ç³»ç»Ÿç‰¹å¾ï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰
         * ç”¨äºæ•°æ®é‡‡é›†ç«¯ï¼Œè·å– timezone å’Œ browser_lang
         * @returns {Promise<Object>} åŒ…å« timezone, browser_lang çš„å¯¹è±¡
         */
        async function getUserSystemFeatures() {
            try {
                // ä½¿ç”¨ requestIdleCallback ç¡®ä¿éé˜»å¡ï¼Œä¸å½±å“é¡µé¢åŠ è½½é€Ÿåº¦
                return new Promise((resolve) => {
                    const schedule = window.requestIdleCallback || ((cb) => setTimeout(cb, 0));
                    
                    schedule(() => {
                        // è·å–æ—¶åŒºï¼šä½¿ç”¨ Intl.DateTimeFormat().resolvedOptions().timeZone
                        let timezone = 'Unknown';
                        try {
                            const formatter = new Intl.DateTimeFormat();
                            const resolvedOptions = formatter.resolvedOptions();
                            timezone = resolvedOptions.timeZone || 'Unknown';
                        } catch (err) {
                            console.warn('[SystemFeatures] âš ï¸ è·å–æ—¶åŒºå¤±è´¥:', err);
                            timezone = 'Unknown';
                        }

                        // è·å–æµè§ˆå™¨è¯­è¨€ï¼šä½¿ç”¨ navigator.language
                        const browser_lang = navigator.language || navigator.userLanguage || 'Unknown';

                        resolve({
                            timezone,
                            browser_lang
                        });
                    });
                });
            } catch (error) {
                console.error('[SystemFeatures] âŒ è·å–ç³»ç»Ÿç‰¹å¾å¤±è´¥:', error);
                // è¿”å›é»˜è®¤å€¼ï¼Œç¡®ä¿å‡½æ•°ä¸ä¼šé˜»å¡
                return {
                    timezone: 'Unknown',
                    browser_lang: navigator.language || 'Unknown'
                };
            }
        }

        /**
         * è‡ªåŠ¨ä¸ŠæŠ¥å½“å‰ç”¨æˆ·ä¿¡æ¯åˆ° user_analysis è¡¨
         * åœ¨ fetchData æ‰§è¡ŒæˆåŠŸåè‡ªåŠ¨è°ƒç”¨
         * @returns {Promise<Object>} ä¸ŠæŠ¥ç»“æœ
         */
        async function autoReportSelf() {
            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                console.warn('[AutoReport] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè·³è¿‡è‡ªåŠ¨ä¸ŠæŠ¥');
                return { success: false, error: 'Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–' };
            }

            try {
                console.log('[AutoReport] ğŸš€ å¼€å§‹è‡ªåŠ¨ä¸ŠæŠ¥ç”¨æˆ·ä¿¡æ¯...');

                // ã€AutoReport å¢å¼ºã€‘æ£€æµ‹æ˜¯å¦å·²ç™»å½•ï¼Œå¦‚æœå·²ç™»å½•åˆ™æºå¸¦ id
                let authenticatedUserId = null;
                let authenticatedSession = null;
                
                try {
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    if (!sessionError && session && session.user) {
                        authenticatedUserId = session.user.id;
                        authenticatedSession = session;
                        console.log('[AutoReport] âœ… æ£€æµ‹åˆ°å·²ç™»å½•ç”¨æˆ·ï¼Œuser_id:', authenticatedUserId.substring(0, 8) + '...');
                    }
                } catch (authError) {
                    console.warn('[AutoReport] âš ï¸ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', authError);
                }

                // 1. è·å–ç³»ç»Ÿç‰¹å¾ï¼ˆæ—¶åŒºå’Œè¯­è¨€ï¼‰
                const systemFeatures = await getUserSystemFeatures();
                console.log('[AutoReport] ğŸ“Š ç³»ç»Ÿç‰¹å¾å·²è·å–:', systemFeatures);

                // 2. è·å– IP å’Œå½’å±åœ°ä¿¡æ¯
                let ipInfo = null;
                let ipLocation = 'Unknown';
                let lat = null;
                let lng = null;
                let countryCode = 'Unknown';

                try {
                    // ä½¿ç”¨ ip-api.com API è·å– IP å½’å±åœ°ä¿¡æ¯ï¼ˆæ›´ç¨³å®šçš„å…è´¹ APIï¼‰
                    // è¿”å›å­—æ®µï¼šcountry, countryCode, city, lat, lon ç­‰
                    const ipResponse = await fetch('http://ip-api.com/json/', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (ipResponse.ok) {
                        ipInfo = await ipResponse.json();
                        console.log('[AutoReport] ğŸŒ IP ä¿¡æ¯å·²è·å–:', ipInfo);

                        // ip-api.com è¿”å›æ ¼å¼ï¼š{ country, countryCode, city, lat, lon, ... }
                        // æå–å…³é”®ä¿¡æ¯
                        countryCode = ipInfo.countryCode || ipInfo.country_code || 'Unknown';
                        
                        // æ„å»º ip_location å­—ç¬¦ä¸²ï¼ˆä½¿ç”¨å›½å®¶ä»£ç ï¼‰
                        if (countryCode && countryCode !== 'Unknown') {
                            ipLocation = countryCode;
                        } else {
                            ipLocation = 'Unknown';
                        }
                        
                        // æå–ç»çº¬åº¦ï¼ˆæ³¨æ„ï¼šip-api.com ä½¿ç”¨ lon è€Œä¸æ˜¯ longitudeï¼‰
                        if (ipInfo.lat && ipInfo.lon) {
                            lat = Number(ipInfo.lat);
                            lng = Number(ipInfo.lon);
                        } else if (ipInfo.latitude && ipInfo.longitude) {
                            // å…¼å®¹å…¶ä»–å¯èƒ½çš„å­—æ®µå
                            lat = Number(ipInfo.latitude);
                            lng = Number(ipInfo.longitude);
                        }
                    } else {
                        console.warn('[AutoReport] âš ï¸ IP API è¯·æ±‚å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ...');
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ ipify è·å– IP
                        try {
                            const ipifyResponse = await fetch('https://api.ipify.org?format=json');
                            if (ipifyResponse.ok) {
                                const ipifyData = await ipifyResponse.json();
                                console.log('[AutoReport] ğŸ“ ä» ipify è·å–åˆ° IP:', ipifyData.ip);
                                ipLocation = 'Unknown';
                            }
                        } catch (err) {
                            console.warn('[AutoReport] âš ï¸ å¤‡ç”¨ IP API ä¹Ÿå¤±è´¥:', err);
                        }
                    }
                } catch (error) {
                    console.warn('[AutoReport] âš ï¸ è·å– IP ä¿¡æ¯å¤±è´¥:', error);
                    // ç»§ç»­æ‰§è¡Œï¼Œä½¿ç”¨é»˜è®¤å€¼
                }

                // 3. VPN åˆ¤å®šé€»è¾‘
                // åˆ¤å®šæ¡ä»¶ï¼šå¦‚æœ timezone æ˜¯ 'Asia/Shanghai' ä¸” IP ä½ç½®ä¸åœ¨ä¸­å›½ï¼Œæ ‡è®°ä¸º VPN
                const timezone = systemFeatures.timezone || 'Unknown';
                const isShanghaiTimezone = timezone === 'Asia/Shanghai';
                // åªæœ‰å½“ countryCode æ˜ç¡®ä¸æ˜¯ 'CN' ä¸”ä¸æ˜¯ 'Unknown' æ—¶ï¼Œæ‰åˆ¤å®šä¸ºä¸åœ¨ä¸­å›½
                const isNotChina = countryCode !== 'CN' && countryCode !== 'Unknown' && countryCode !== null;

                let is_vpn = false;
                // åªæœ‰åœ¨æ—¶åŒºæ˜¯ Asia/Shanghai ä¸” IP æ˜ç¡®ä¸åœ¨ä¸­å›½æ—¶ï¼Œæ‰åˆ¤å®šä¸º VPN
                if (isShanghaiTimezone && isNotChina) {
                    is_vpn = true;
                    console.log('[AutoReport] ğŸ” VPN åˆ¤å®š: æ£€æµ‹åˆ° VPN ç”¨æˆ·', {
                        timezone,
                        countryCode,
                        is_vpn: true,
                        reason: 'æ—¶åŒºä¸ºAsia/Shanghaiä½†IPä¸åœ¨ä¸­å›½'
                    });
                } else {
                    // å¦‚æœä¿¡æ¯ä¸è¶³ï¼ˆcountryCode ä¸º Unknownï¼‰ï¼Œä¸åˆ¤å®šä¸º VPN
                    const reason = countryCode === 'Unknown' || countryCode === null 
                        ? 'IPä½ç½®ä¿¡æ¯ä¸è¶³ï¼Œæ— æ³•åˆ¤å®š' 
                        : (isShanghaiTimezone ? 'IPä½ç½®æ­£å¸¸ï¼ˆåœ¨ä¸­å›½ï¼‰' : 'æ—¶åŒºä¸åŒ¹é…');
                    
                    console.log('[AutoReport] ğŸ” VPN åˆ¤å®š: æ­£å¸¸ç”¨æˆ·æˆ–ä¿¡æ¯ä¸è¶³', {
                        timezone,
                        countryCode,
                        is_vpn: false,
                        reason
                    });
                }

                // 4. ç”Ÿæˆéšæœºè®¿å®¢ç”¨æˆ·åï¼šGuest_XXXXï¼ˆXXXXä¸º4ä½éšæœºæ•°å­—ï¼‰
                // ã€AutoReport å¢å¼ºã€‘å¦‚æœå·²ç™»å½•ï¼Œä½¿ç”¨ GitHub ç”¨æˆ·å
                let userName = null;
                if (authenticatedUserId && authenticatedSession) {
                    const githubUsername = authenticatedSession.user.user_metadata?.user_name || 
                                         authenticatedSession.user.user_metadata?.preferred_username ||
                                         authenticatedSession.user.user_metadata?.login ||
                                         authenticatedSession.user.email?.split('@')[0] || null;
                    if (githubUsername) {
                        userName = githubUsername.toLowerCase().trim();
                        console.log('[AutoReport] âœ… ä½¿ç”¨ GitHub ç”¨æˆ·å:', userName);
                    }
                }
                
                if (!userName) {
                    const randomGuestId = Math.floor(1000 + Math.random() * 9000);
                    userName = `Guest_${randomGuestId}`;
                    console.log('[AutoReport] â„¹ï¸ ä½¿ç”¨è®¿å®¢ç”¨æˆ·å:', userName);
                }

                // 5. æ„å»ºæäº¤æ•°æ®
                // ã€AutoReport å¢å¼ºã€‘å¦‚æœå·²ç™»å½•ï¼Œæºå¸¦ idï¼ˆauth.uidï¼‰ï¼Œç¡®ä¿æ•°æ®å­˜å…¥ GitHub è´¦å·å¯¹åº”çš„è¡Œ
                const payload = {
                    user_name: userName,
                    personality_type: 'AUTO_REPORT',
                    lat: lat,
                    lng: lng,
                    timezone: systemFeatures.timezone,
                    browser_lang: systemFeatures.browser_lang,
                    ip_location: ipLocation,
                    is_vpn: is_vpn
                };
                
                // ã€AutoReport å¢å¼ºã€‘å¦‚æœå·²ç™»å½•ï¼Œæºå¸¦ id
                if (authenticatedUserId) {
                    payload.id = authenticatedUserId;
                    payload.user_identity = 'github';
                    console.log('[AutoReport] âœ… å·²ç™»å½•ï¼Œæºå¸¦ user_id:', authenticatedUserId.substring(0, 8) + '...');
                }

                console.log('[AutoReport] ğŸ“¤ å‡†å¤‡æäº¤æ•°æ®åˆ° user_analysis è¡¨:', payload);

                // 5. æ’å…¥åˆ° Supabaseï¼ˆå¦‚æœå·²ç™»å½•ï¼Œä½¿ç”¨ upsert ç¡®ä¿æ›´æ–°åˆ°æ­£ç¡®çš„è¡Œï¼‰
                let data, error;
                if (authenticatedUserId) {
                    // å·²ç™»å½•ï¼šä½¿ç”¨ upsertï¼Œä»¥ id ä¸ºå†²çªé”®
                    const { data: upsertData, error: upsertError } = await supabaseClient
                        .from('user_analysis')
                        .upsert([payload], { onConflict: 'id' })
                        .select();
                    data = upsertData;
                    error = upsertError;
                } else {
                    // æœªç™»å½•ï¼šä½¿ç”¨ insert
                    const { data: insertData, error: insertError } = await supabaseClient
                        .from('user_analysis')
                        .insert([payload])
                        .select();
                    data = insertData;
                    error = insertError;
                }

                if (error) {
                    console.error('[AutoReport] âŒ æäº¤å¤±è´¥:', error);
                    return { success: false, error: error.message };
                }

                console.log('[AutoReport] âœ… è‡ªåŠ¨ä¸ŠæŠ¥æˆåŠŸ:', data);

                // 6. ç«‹å³åé¦ˆï¼šä¸ŠæŠ¥æˆåŠŸåç«‹å³åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºè‡ªå·±çš„ä½ç½®ï¼ˆä¸ç­‰å¾… Realtime ç›‘å¬ï¼‰
                if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
                    // æ€§èƒ½ä¿æŠ¤ï¼šæ£€æŸ¥ triggerMapPulse å‡½æ•°æ˜¯å¦å·²å®šä¹‰
                    if (typeof triggerMapPulse === 'function') {
                        // è®¾ç½®æ ‡ç­¾ï¼ˆå·²ç§»é™¤VPNå…³é”®å­—ï¼‰
                        const pulseLabel = 'YOU';
                        
                        // è·å–ç”¨æˆ·çŠ¶æ€é¢œè‰²ï¼ˆä¼˜å…ˆä½¿ç”¨å½“å‰çŠ¶æ€é¢œè‰²ï¼‰
                        const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                        const statusColor = statusConfig.status_color;
                        // ä½¿ç”¨çŠ¶æ€é¢œè‰²
                        const pulseColor = statusColor;

                        // è·å–GitHubç”¨æˆ·åå’Œå¤´åƒURL
                        // åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœ github_username ä¸ºç©ºã€æˆ–è€…æ˜¯é»˜è®¤å€¼ï¼Œåˆ™ä¸è¦è¯·æ±‚ GitHub å›¾ç‰‡
                        const githubUsername = localStorage.getItem('github_username') || null;
                        let avatarUrl = null;
                        
                        if (isValidGitHubUsername(githubUsername)) {
                            // åªæœ‰æœ‰æ•ˆçš„GitHubç”¨æˆ·åæ‰ç”Ÿæˆå¤´åƒURL
                            avatarUrl = getGitHubAvatarUrl(githubUsername);
                        } else {
                            // æ— æ•ˆç”¨æˆ·åæ—¶ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                            avatarUrl = DEFAULT_AVATAR;
                        }
                        
                        // ç«‹å³è°ƒç”¨ triggerMapPulse æ˜¾ç¤ºè‡ªå·±çš„ä½ç½®
                        try {
                            triggerMapPulse(lng, lat, pulseLabel, pulseColor, avatarUrl, githubUsername);
                            console.log('[AutoReport] ğŸ—ºï¸ å·²åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºè‡ªå·±çš„ä½ç½®:', {
                                lng,
                                lat,
                                label: pulseLabel,
                                color: pulseColor,
                                status: currentUserStatus,
                                is_vpn,
                                avatarUrl,
                                githubUsername,
                                isValid: isValidGitHubUsername(githubUsername)
                            });
                        } catch (pulseError) {
                            console.warn('[AutoReport] âš ï¸ è°ƒç”¨ triggerMapPulse å¤±è´¥:', pulseError);
                        }
                    } else {
                        console.warn('[AutoReport] âš ï¸ triggerMapPulse å‡½æ•°æœªå®šä¹‰ï¼Œè·³è¿‡åœ°å›¾æ˜¾ç¤º');
                    }
                } else {
                    console.log('[AutoReport] â„¹ï¸ ç»çº¬åº¦ä¿¡æ¯ä¸å®Œæ•´ï¼Œè·³è¿‡åœ°å›¾æ˜¾ç¤º');
                }

                return { success: true, data };

            } catch (error) {
                console.error('[AutoReport] âŒ è‡ªåŠ¨ä¸ŠæŠ¥è¿‡ç¨‹å‡ºé”™:', error);
                return { success: false, error: error.message };
            }
        }

        /**
         * æäº¤ç”¨æˆ·åˆ†ææ•°æ®åˆ° user_analysis è¡¨ï¼ˆé‡‡é›†ç«¯å¢å¼ºï¼‰
         * åœ¨ insert æ—¶è‡ªåŠ¨å¢åŠ  timezone å’Œ browser_lang å­—æ®µ
         * @param {string} user_name - ç”¨æˆ·å
         * @param {string} personality_type - äººæ ¼ç±»å‹
         * @param {number} lat - çº¬åº¦
         * @param {number} lng - ç»åº¦
         * @returns {Promise<Object>} æäº¤ç»“æœ
         */
        async function submitUserAnalysis(user_name, personality_type, lat, lng) {
            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                console.warn('[Submit] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•æäº¤æ•°æ®');
                return { success: false, error: 'Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–' };
            }

            try {
                // å¼‚æ­¥è·å–ç³»ç»Ÿç‰¹å¾ï¼ˆéé˜»å¡ï¼Œä¸å½±å“é¡µé¢åŠ è½½é€Ÿåº¦ï¼‰
                const systemFeatures = await getUserSystemFeatures();
                console.log('[Submit] ğŸ“Š ç³»ç»Ÿç‰¹å¾å·²è·å–:', systemFeatures);

                // æ„å»ºæäº¤æ•°æ®ï¼ˆåŒ…å« timezone å’Œ browser_lang å­—æ®µï¼‰
                const payload = {
                    user_name: user_name || 'åŒ¿åç”¨æˆ·',
                    personality_type: personality_type || 'UNKNOWN',
                    lat: lat || null,
                    lng: lng || null,
                    timezone: systemFeatures.timezone, // ä½¿ç”¨ Intl.DateTimeFormat().resolvedOptions().timeZone
                    browser_lang: systemFeatures.browser_lang // ä½¿ç”¨ navigator.language
                };

                console.log('[Submit] ğŸ“¤ å‡†å¤‡æäº¤æ•°æ®åˆ° user_analysis è¡¨:', payload);

                // ä½¿ç”¨ Supabase å®¢æˆ·ç«¯æ’å…¥æ•°æ®
                const { data, error } = await supabaseClient
                    .from('user_analysis')
                    .insert([payload])
                    .select();

                if (error) {
                    console.error('[Submit] âŒ æäº¤å¤±è´¥:', error);
                    return { success: false, error: error.message };
                }

                console.log('[Submit] âœ… æ•°æ®å·²æˆåŠŸæäº¤ï¼ˆåŒ…å« timezone å’Œ browser_langï¼‰:', data);
                return { success: true, data };

            } catch (error) {
                console.error('[Submit] âŒ æäº¤è¿‡ç¨‹å‡ºé”™:', error);
                return { success: false, error: error.message };
            }
        }

        /**
         * è·å–å¹¶æ¸²æŸ“å¤§ç›˜æ•°æ®
         * åŸºäº index.ts çš„æ¥å£è¿”å›æ ¼å¼ï¼ˆæ•°æ®ç›´æ¥è¿”å›ï¼Œä¸åŒ…è£¹åœ¨ data å­—æ®µä¸­ï¼‰
         */
        async function fetchData() {
            try {
                const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content;
                console.group('%c ğŸš€ Dashboard Data Sync Starting ', 'background: #222; color: #bada55; font-size: 12px;');
                // åŠ è½½è¿‡åœºï¼šéª¨æ¶å± + æ‰«æçº¿
                setLoadingState(true);

                console.log(`[1/5] æ­£åœ¨è¯·æ±‚: ${apiEndpoint}api/global-average`);
                const response = await fetch(`${apiEndpoint}api/global-average`);
                
                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
                
                const result = await response.json();
                console.log('[2/5] æ”¶åˆ°åŸå§‹å“åº”:', result);

                // ã€é€‚é…å±‚é‡å†™ã€‘ä½¿ç”¨å¼ºåˆ¶æ˜ å°„å±‚æ ‡å‡†åŒ–æ•°æ®
                const data = normalizeData(result);
                console.log('[3/5] æ•°æ®é€‚é…å®Œæˆ:', data);

                // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›è¯­è¨€åˆ‡æ¢æ—¶ä½¿ç”¨
                window.lastData = data;

                // --- æ¸²æŸ“æ•°å­—å¡ç‰‡ ---
                // ã€ID å­˜åœ¨æ€§æ£€æŸ¥ã€‘åœ¨æ‰§è¡Œ animateValue å‰ï¼Œå¿…é¡»æ£€æŸ¥ document.getElementById æ˜¯å¦éç©º
                // ã€åŠ¨ç”»å®¹é”™ã€‘é˜²æ­¢ NaN æˆ– undefined å¯¼è‡´å´©æºƒ
                
                // æ•°æ®è¿”å›ï¼šç§»é™¤éª¨æ¶å±å¹¶å¼€å§‹æ•°å­—æ»šåŠ¨
                setLoadingState(false);

                // 1. å·²è¯Šæ–­å¼€å‘è€…ï¼ˆåƒåˆ†ä½ï¼‰
                const totalUsers = data.totalUsers !== undefined && data.totalUsers !== null ? Number(data.totalUsers) : undefined;
                if (totalUsers !== undefined) {
                    animateValue('totalUsers', totalUsers, 1400, { decimals: 0, useThousands: true });
                }

                // 2. æ‰«ææ¬¡æ•° (totalAnalysis)
                const totalAnalysis = data.totalAnalysis !== undefined && data.totalAnalysis !== null ? Number(data.totalAnalysis) : undefined;
                if (totalAnalysis !== undefined) {
                    animateValue('totalAnalysis', totalAnalysis, 1400, { decimals: 0, useThousands: true });
                }

                // 3. ç´¯è®¡åæ§½å­—æ•°ï¼šç»‘å®šåˆ° json.totalChars (276355)
                const totalChars = data.totalChars !== undefined && data.totalChars !== null ? Number(data.totalChars) : (data.totalRoastWords !== undefined && data.totalRoastWords !== null ? Number(data.totalRoastWords) : undefined);
                if (totalChars !== undefined) {
                    animateValue('totalChars', totalChars, 1400, { decimals: 0, useThousands: true });
                }

                // 4. äººå‡å¹³å‡ç¯‡å¹… (avgPerUser)
                const avgPerUser = data.avgPerUser !== undefined && data.avgPerUser !== null ? Number(data.avgPerUser) : undefined;
                if (avgPerUser !== undefined) {
                    animateValue('avgPerUser', avgPerUser, 900, { decimals: 1, useThousands: true });
                }

                // 5. å¹³å‡ç¯‡å¹…ï¼šç»‘å®šåˆ° json.totalChars / json.totalAnalysis
                let avgPerScan = data.avgPerScan !== undefined && data.avgPerScan !== null ? Number(data.avgPerScan) : undefined;
                if (avgPerScan === undefined && totalChars !== undefined && data.totalAnalysis !== undefined && data.totalAnalysis !== null && data.totalAnalysis > 0) {
                    avgPerScan = totalChars / Number(data.totalAnalysis);
                }
                if (avgPerScan !== undefined) {
                    animateValue('avgPerScan', avgPerScan, 900, { decimals: 1, useThousands: true });
                }

                // 6. è¿è¡Œå¤©æ•°
                const systemDays = data.systemDays !== undefined && data.systemDays !== null ? Number(data.systemDays) : undefined;
                if (systemDays !== undefined) {
                    animateValue('systemDays', systemDays, 900, { decimals: 0, useThousands: true });
                }

                // 7. è¦†ç›–åŸå¸‚
                const cityCount = data.cityCount !== undefined && data.cityCount !== null ? Number(data.cityCount) : undefined;
                if (cityCount !== undefined) {
                    animateValue('cityCount', cityCount, 900, { decimals: 0, useThousands: true });
                }

                // --- æ¸²æŸ“äººæ ¼åˆ†å¸ƒæ’è¡Œ ---
                // ã€äººæ ¼æ’è¡Œæ¸²æŸ“å‡½æ•°ã€‘ä½¿ç”¨ç‹¬ç«‹çš„ renderPersonalityRank å‡½æ•°
                renderPersonalityRank(data.personalityRank, data.recentVictims);

                // --- æ¸²æŸ“å›¾è¡¨ç»„ä»¶ ---
                // æ¸²æŸ“åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œå’Œåœ°å›¾
                if (data.locationRank && Array.isArray(data.locationRank) && data.locationRank.length > 0) {
                    if (typeof echarts !== 'undefined') {
                        try {
                            await initGlobalMap(data.locationRank);
                        } catch (mapError) {
                            console.error('[fetchData] âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', mapError);
                            // å³ä½¿åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ¸²æŸ“ä½ç½®åˆ—è¡¨
                        }
                    }
                    try {
                        renderLocationList(data.locationRank);
                    } catch (listError) {
                        console.error('[fetchData] âŒ ä½ç½®åˆ—è¡¨æ¸²æŸ“å¤±è´¥:', listError);
                    }
                } else {
                    const locationListEl = document.getElementById('locationList');
                    if (locationListEl) {
                        locationListEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
                    }
                }
                
                // æ¸²æŸ“é›·è¾¾å›¾ï¼ˆä¼˜å…ˆä½¿ç”¨ globalAverageï¼Œå¦åˆ™ä½¿ç”¨ averagesï¼‰
                // ã€ç¯å¢ƒå¯¹é½ã€‘ç¡®ä¿æ‰€æœ‰çš„ Number() è½¬æ¢é€»è¾‘åœ¨èµ‹å€¼å‰å®Œæˆï¼Œå½»åº•åˆ é™¤ç¡¬ç¼–ç 
                const radarData = data.globalAverage || data.averages;
                if (radarData && typeof radarData === 'object' && typeof Chart !== 'undefined') {
                    // ç¡®ä¿æ‰€æœ‰å€¼éƒ½æ˜¯æ•°å­—ç±»å‹ï¼Œå¦‚æœæ¥å£æœ‰å€¼åˆ™å¿…é¡»æ˜¾ç¤ºæ¥å£çš„å€¼
                    const normalizedRadarData = {
                        L: radarData.L !== undefined && radarData.L !== null ? Number(radarData.L) : undefined,
                        P: radarData.P !== undefined && radarData.P !== null ? Number(radarData.P) : undefined,
                        D: radarData.D !== undefined && radarData.D !== null ? Number(radarData.D) : undefined,
                        E: radarData.E !== undefined && radarData.E !== null ? Number(radarData.E) : undefined,
                        F: radarData.F !== undefined && radarData.F !== null ? Number(radarData.F) : undefined,
                    };
                    console.log(`[é›·è¾¾å›¾] æ•°æ®: L=${normalizedRadarData.L}, P=${normalizedRadarData.P}, D=${normalizedRadarData.D}, E=${normalizedRadarData.E}, F=${normalizedRadarData.F}`);
                    renderRadarChart(normalizedRadarData);
                } else {
                    console.warn('[é›·è¾¾å›¾] âŒ æ•°æ®æ ¼å¼é”™è¯¯æˆ– Chart.js æœªåŠ è½½');
                }
                
                // æ¸²æŸ“å®æ—¶è¯Šæ–­æ´»åŠ¨ï¼ˆä¼˜å…ˆä½¿ç”¨ latestRecordsï¼‰
                const activityData = data.latestRecords && data.latestRecords.length > 0 
                    ? data.latestRecords 
                    : (data.recentVictims || []);
                
                // åˆå§‹åŒ–å…¨å±€ latestRecords æ•°ç»„ï¼ˆç”¨äº Realtime æ›´æ–°ï¼‰
                latestRecords = Array.isArray(activityData) ? [...activityData] : [];
                // ç¡®ä¿é•¿åº¦ä¸è¶…è¿‡ 10
                if (latestRecords.length > 10) {
                    latestRecords = latestRecords.slice(0, 10);
                }
                
                renderRecentActivity(latestRecords);

                // åˆå§‹åŒ– window.allDataï¼ˆç”¨äº LPDEF ä¸“å®¶ç­›é€‰ - é€‰æ‹”å„ç»´åº¦æœ€å¼ºç‹è€…ï¼‰
                // ä¼˜å…ˆä½¿ç”¨ latestRecordsï¼ˆåŒ…å«æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ recentVictims
                const allDataArray = Array.isArray(data.latestRecords) && data.latestRecords.length > 0
                    ? [...data.latestRecords]
                    : (Array.isArray(data.recentVictims) && data.recentVictims.length > 0
                        ? [...data.recentVictims]
                        : []);
                
                // ã€å…¨çƒæœ€å¼ºæ•°æ®æå–ã€‘éå† latestRecords æ‰¾åˆ°ç¬¬ä¸€ä¸ª jiafang_count > 0 çš„è®°å½•ä½œä¸º'å…¨çƒæœ€å¼º'çš„å±•ç¤ºæ•°æ®
                let globalChampionRecord = null;
                if (allDataArray.length > 0) {
                    globalChampionRecord = allDataArray.find(record => {
                        const jiafangCount = record.jiafang_count !== undefined && record.jiafang_count !== null ? Number(record.jiafang_count) : 0;
                        return jiafangCount > 0;
                    });
                    if (globalChampionRecord) {
                        console.log('[Global] âœ… æ‰¾åˆ°å…¨çƒæœ€å¼ºè®°å½•ï¼ˆjiafang_count > 0ï¼‰:', globalChampionRecord);
                        // å°†å…¨çƒæœ€å¼ºè®°å½•å­˜å‚¨åˆ°å…¨å±€å˜é‡
                        window.globalChampionRecord = globalChampionRecord;
                    }
                }
                
                window.allData = allDataArray;
                console.log(`[LPDEF] ğŸ“¦ å·²åˆå§‹åŒ– window.allDataï¼Œå…± ${allDataArray.length} æ¡æ•°æ®ï¼ˆç”¨äºé€‰æ‹”æœ€å¼ºç‹è€…ï¼‰`);

                // æ³¨æ„ï¼šLPDEF ä¸“å®¶å¡ç‰‡å°†åœ¨ window.onload çš„èº«ä»½æ£€æŸ¥åæ¸²æŸ“
                // è¿™é‡Œä¸è°ƒç”¨ renderLPDEFExpertsï¼Œé¿å…è¦†ç›–èº«ä»½æ£€æŸ¥çš„ç»“æœ

                console.log('%c [5/5] âœ… æ¸²æŸ“é€»è¾‘åŒæ­¥å®Œæ¯• ', 'color: #00ff41');

                // æ‰§è¡Œè‡ªåŠ¨ä¸ŠæŠ¥ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                autoReportSelf().catch(err => {
                    console.warn('[AutoReport] âš ï¸ è‡ªåŠ¨ä¸ŠæŠ¥å¤±è´¥ï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰:', err);
                });

            } catch (err) {
                console.error('[ERROR] Dashboard æ¸²æŸ“å´©æºƒ:', err);
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                const container = document.querySelector('.max-w-\\[1600px\\]');
                if (container) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed top-4 right-4 bg-red-900/80 text-white px-4 py-2 rounded border border-red-500 z-50';
                    errorDiv.textContent = `é”™è¯¯: ${err.message || 'æ•°æ®åŠ è½½å¤±è´¥'}`;
                    container.appendChild(errorDiv);
                    
                    setTimeout(() => {
                        errorDiv.remove();
                    }, 5000);
                }
            } finally {
                // ç¡®ä¿å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿå…³é—­åŠ è½½è¿‡åœº
                setLoadingState(false);
                console.groupEnd();
            }
        }

        /**
         * åŠ è½½ rank-content.ts æ•°æ®
         */
        async function loadRankResources() {
            try {
                // ä¼˜åŒ–ï¼šä¼˜å…ˆå°è¯•è¯»å– TS æ–‡ä»¶ï¼ˆå› ä¸ºç¯å¢ƒç›®å‰è§£æ TS æ–‡ä»¶æ›´ç¨³å®šï¼‰
                const tsPaths = [
                    './src/rank-content.ts',
                    '../src/rank-content.ts',
                    '/src/rank-content.ts',
                    'src/rank-content.ts'
                ];
                
                let text = null;
                let lastError = null;
                
                // ä¼˜å…ˆå°è¯•æ¯ä¸ª TS è·¯å¾„
                for (const path of tsPaths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            const contentType = response.headers.get('content-type') || '';
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡æœ¬æ–‡ä»¶ï¼ˆTS/JS æ–‡ä»¶ï¼‰
                            if (contentType.includes('text/') || contentType.includes('application/javascript') || contentType.includes('application/typescript')) {
                                text = await response.text();
                                console.log(`[Rank] âœ… æˆåŠŸä» ${path} åŠ è½½ TS æ–‡ä»¶`);
                                break;
                            } else {
                                console.debug(`[Rank] ${path} è¿”å›çš„ä¸æ˜¯æ–‡æœ¬æ ¼å¼ (Content-Type: ${contentType})ï¼Œè·³è¿‡`);
                            }
                        } else {
                            console.debug(`[Rank] ${path} è¿”å›çŠ¶æ€ç  ${response.status}ï¼Œè·³è¿‡`);
                        }
                    } catch (err) {
                        lastError = err;
                        console.debug(`[Rank] TS è·¯å¾„ ${path} åŠ è½½å¤±è´¥:`, err.message);
                    }
                }
                
                // å¦‚æœ TS æ–‡ä»¶åŠ è½½æˆåŠŸï¼Œè§£æå¹¶è¿”å›
                if (text) {
                    // ä½¿ç”¨æ›´å¥å£®çš„æ­£åˆ™æå– JSON å¯¹è±¡
                    // ä»ç¬¬ä¸€ä¸ª { åˆ°æœ€åä¸€ä¸ª } ä¹‹é—´çš„å†…å®¹
                    const firstBrace = text.indexOf('{');
                    const lastBrace = text.lastIndexOf('}');
                    
                    if (firstBrace === -1 || lastBrace === -1 || firstBrace >= lastBrace) {
                        console.warn('[Rank] âš ï¸ æ— æ³•ä» rank-content.ts ä¸­æ‰¾åˆ°æœ‰æ•ˆçš„ JSON å¯¹è±¡');
                        return false;
                    }
                    
                    const jsonText = text.substring(firstBrace, lastBrace + 1);
                    
                    // æ¸…ç†æ–‡æœ¬ï¼šç§»é™¤æ³¨é‡Šå’Œç±»å‹æ³¨è§£
                    let cleaned = jsonText
                        .replace(/\/\*[\s\S]*?\*\//g, '') // ç§»é™¤å—æ³¨é‡Š
                        .replace(/\/\/.*$/gm, '') // ç§»é™¤è¡Œæ³¨é‡Š
                        .replace(/:\s*Record<string,\s*any>/g, '') // ç§»é™¤ç±»å‹æ³¨è§£
                        .replace(/:\s*any/g, ''); // ç§»é™¤å…¶ä»– any ç±»å‹æ³¨è§£
                    
                    // å°è¯•è§£æä¸º JSON
                    try {
                        RANK_RESOURCES = JSON.parse(cleaned);
                        console.log('[Rank] âœ… ç»´åº¦æ’åæ•°æ®åŠ è½½æˆåŠŸï¼ˆä» TS æ–‡ä»¶ JSON è§£æï¼‰');
                        return true;
                    } catch (e) {
                        console.warn(`[Rank] âš ï¸ ä» TS æ–‡ä»¶è§£æ JSON å¤±è´¥: ${e.message}`);
                        return false;
                    }
                }
                
                // å¦‚æœ TS æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œé™é»˜å°è¯• JSON æ–‡ä»¶ï¼ˆä½œä¸ºå¤‡é€‰ï¼‰
                const jsonPaths = [
                    './rank-data.json',
                    '../rank-data.json',
                    '/rank-data.json',
                    'rank-data.json'
                ];
                
                // é™é»˜å°è¯• JSON æ–‡ä»¶ï¼ˆä½¿ç”¨ console.debug é¿å…å¹²æ‰°æ§åˆ¶å°ï¼‰
                for (const path of jsonPaths) {
                    try {
                        const response = await fetch(path);
                        // æ£€æŸ¥å“åº”çŠ¶æ€å’Œ Content-Typeï¼Œé¿å… 404 è¿”å› HTML å¯¼è‡´çš„è§£æé”™è¯¯
                        if (response.ok) {
                            const contentType = response.headers.get('content-type') || '';
                            // ç¡®ä¿å“åº”æ˜¯ JSON æ ¼å¼ï¼Œè€Œä¸æ˜¯ HTML é”™è¯¯é¡µé¢
                            if (contentType.includes('application/json') || contentType.includes('text/json')) {
                                const jsonData = await response.json();
                                RANK_RESOURCES = jsonData;
                                console.log(`[Rank] âœ… æˆåŠŸä» ${path} åŠ è½½ JSON æ•°æ®`);
                                return true;
                            } else {
                                // å¦‚æœ Content-Type ä¸æ˜¯ JSONï¼Œå¯èƒ½æ˜¯ 404 è¿”å›çš„ HTMLï¼Œé™é»˜è·³è¿‡
                                console.debug(`[Rank] ${path} è¿”å›çš„ä¸æ˜¯ JSON æ ¼å¼ (Content-Type: ${contentType})ï¼Œè·³è¿‡`);
                            }
                        } else {
                            // å“åº”çŠ¶æ€ä¸æ˜¯ 200-299ï¼Œé™é»˜è·³è¿‡
                            console.debug(`[Rank] ${path} è¿”å›çŠ¶æ€ç  ${response.status}ï¼Œè·³è¿‡`);
                        }
                    } catch (err) {
                        // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸ï¼Œé™é»˜è®°å½•
                        console.debug(`[Rank] JSON è·¯å¾„ ${path} åŠ è½½å¤±è´¥:`, err.message);
                    }
                }
                
                // å¦‚æœæ‰€æœ‰è·¯å¾„éƒ½å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä½†ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸é¡µé¢ç»§ç»­åŠ è½½
                console.warn(`[Rank] âš ï¸ æ‰€æœ‰è·¯å¾„éƒ½åŠ è½½å¤±è´¥ã€‚æœ€åé”™è¯¯: ${lastError?.message || 'æœªçŸ¥é”™è¯¯'}`);
                return false;
            } catch (error) {
                console.error('[Rank] âŒ åŠ è½½æ’åæ•°æ®å¤±è´¥:', error);
                // è¿”å› falseï¼Œä½†ä¸é˜»æ­¢é¡µé¢ç»§ç»­åŠ è½½
                // æ¸²æŸ“æ—¶ä¼šæ˜¾ç¤ºåŠ è½½ä¸­çš„æç¤º
                return false;
            }
        }

        /**
         * æ ¹æ®ç»´åº¦IDå’Œæ•°å€¼è·å–ç­‰çº§åé¦ˆ
         * @param {string} dimId - ç»´åº¦ID (ai, word, day, no, say, please)
         * @param {number} value - æ•°å€¼
         * @returns {Object|null} åŒ…å« label, title, content çš„å¯¹è±¡ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› null
         */
        function getRankFeedback(dimId, value) {
            if (!RANK_RESOURCES || !RANK_RESOURCES[dimId]) {
                console.log(`[Rank] ç»´åº¦ ${dimId} ä¸å­˜åœ¨äº RANK_RESOURCESï¼Œè¿”å›é»˜è®¤åé¦ˆ`);
                return null;
            }

            const dim = RANK_RESOURCES[dimId];
            if (!dim.levels || !Array.isArray(dim.levels) || dim.levels.length === 0) {
                console.log(`[Rank] ç»´åº¦ ${dimId} çš„ levels æ•°æ®æ— æ•ˆï¼Œè¿”å›é»˜è®¤åé¦ˆ`);
                return null;
            }

            let matchedLevel = null;

            // 0 å€¼ä¿æŠ¤ï¼šå¦‚æœ value <= 0ï¼Œç›´æ¥å¼ºåˆ¶åŒ¹é…ç¬¬ä¸€ä¸ªç­‰çº§
            if (value <= 0) {
                matchedLevel = dim.levels[0];
                console.log(`[Rank] ç»´åº¦ ${dimId} çš„å€¼ ${value} <= 0ï¼Œè‡ªåŠ¨åŒ¹é…ç¬¬ä¸€ä¸ªç­‰çº§: ${matchedLevel.label}`);
            } else {
                // æŸ¥æ‰¾æ»¡è¶³ value >= min && value <= max çš„ç­‰çº§
                matchedLevel = dim.levels.find(level => {
                    const min = Number(level.min) || 0;
                    const max = Number(level.max) || Infinity;
                    return value >= min && value <= max;
                });

                // æº¢å‡ºä¿æŠ¤ï¼šå¦‚æœæ•°å€¼è¶…è¿‡äº†é…ç½®çš„æœ€å¤§å€¼ï¼Œè‡ªåŠ¨åŒ¹é…æœ€åä¸€ä¸ªç­‰çº§
                if (!matchedLevel) {
                    matchedLevel = dim.levels[dim.levels.length - 1];
                    console.log(`[Rank] ç»´åº¦ ${dimId} çš„å€¼ ${value} è¶…å‡ºèŒƒå›´ï¼Œè‡ªåŠ¨åŒ¹é…æœ€åä¸€ä¸ªç­‰çº§: ${matchedLevel.label}`);
                }
            }

            // éšæœºæŠ½å–ä¸€æ¡è¯„ä»·
            const comments = matchedLevel.commentsZh || [];
            if (comments.length === 0) {
                console.log(`[Rank] ç»´åº¦ ${dimId} çš„ç­‰çº§ ${matchedLevel.label} æ²¡æœ‰è¯„ä»·æ•°æ®ï¼Œè¿”å›é»˜è®¤å†…å®¹`);
                return {
                    label: matchedLevel.label || 'æœªçŸ¥ç­‰çº§',
                    title: 'æš‚æ— è¯„ä»·',
                    content: 'æš‚æ— è¯„ä»·å†…å®¹'
                };
            }

            const randomComment = comments[Math.floor(Math.random() * comments.length)];
            return {
                label: matchedLevel.label || 'æœªçŸ¥ç­‰çº§',
                title: randomComment.title || 'æš‚æ— æ ‡é¢˜',
                content: randomComment.content || 'æš‚æ— å†…å®¹'
            };
        }

        /**
         * æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡åˆ°å·¦ä¾§æŠ½å±‰
         * @param {HTMLElement} leftBody - å·¦ä¾§æŠ½å±‰å®¹å™¨
         * @param {Object} userData - å½“å‰ç”¨æˆ·æ•°æ®å¯¹è±¡
         */
        function renderUserStatsCards(leftBody, userData) {
            console.log('[UserStats] ğŸš€ å¼€å§‹æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ï¼ŒuserData:', {
                hasUserData: !!userData,
                userName: userData?.user_name || userData?.name,
                fingerprint: userData?.fingerprint ? userData.fingerprint.substring(0, 8) : null,
                hasLeftBody: !!leftBody
            });
            
            if (!leftBody) {
                console.error('[UserStats] âŒ leftBody ä¸å­˜åœ¨');
                return;
            }
            
            if (!userData) {
                console.warn('[UserStats] âš ï¸ userData ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸²æŸ“');
                return;
            }
            
            try {
                // ã€Task 4ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºæ–°ç”¨æˆ·ï¼ˆdimensions ä¸ºç©ºæˆ–ä¸ºé»˜è®¤å€¼ï¼‰
                const hasDimensions = userData.dimensions || 
                                    (userData.l_score !== null && userData.l_score !== undefined) ||
                                    (userData.p_score !== null && userData.p_score !== undefined) ||
                                    (userData.d_score !== null && userData.d_score !== undefined) ||
                                    (userData.e_score !== null && userData.e_score !== undefined) ||
                                    (userData.f_score !== null && userData.f_score !== undefined);
                
                const isDefaultScores = userData.l_score === 50 && 
                                       userData.p_score === 50 && 
                                       userData.d_score === 50 && 
                                       userData.e_score === 50 && 
                                       userData.f_score === 50;
                
                // ã€ä¿®å¤ã€‘åªæœ‰åœ¨ç¡®å®šæ˜¯å®Œå…¨æ²¡æœ‰æ•°æ®çš„ç”¨æˆ·æ—¶æ‰æ˜¾ç¤ºåŒæ­¥ä¸­ï¼Œä¸”æ’é™¤å·²ç™»å½•çš„ GitHub ç”¨æˆ·
                const isNewUser = (!hasDimensions || isDefaultScores) && !userData.id;
                
                if (isNewUser) {
                    console.log('[UserStats] â³ æ£€æµ‹åˆ°æ–°ç”¨æˆ·ï¼ˆæ•°æ®åŒæ­¥ä¸­ï¼‰ï¼Œæ˜¾ç¤ºåŠ è½½å ä½ç¬¦');
                    
                    // åˆ›å»º"æ•°æ®åŒæ­¥ä¸­"å ä½ç¬¦å¡ç‰‡
                    const loadingCard = document.createElement('div');
                    loadingCard.className = 'drawer-item';
                    loadingCard.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">â³</span>
                            <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                                SYNCING
                            </span>
                        </div>
                        <div class="drawer-item-label mb-2">æ•°æ®åŒæ­¥ä¸­</div>
                        <div class="text-[10px] text-[#00ff41]/60 mb-3">
                            æ‚¨çš„æ•°æ®æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...
                        </div>
                        <div class="flex items-center space-x-2 mb-2">
                            <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                        <div class="text-[8px] text-[#00ff41]/40 mt-2">
                            ç”¨æˆ·: ${userData.user_name || userData.name || 'æœªçŸ¥'}
                        </div>
                    `;
                    
                    // å…ˆç§»é™¤æ—§çš„ç»Ÿè®¡å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const existingStatsCards = leftBody.querySelectorAll('.drawer-item');
                    existingStatsCards.forEach(card => {
                        const label = card.querySelector('.drawer-item-label');
                        if (label && (label.textContent === 'æˆ‘çš„æ•°æ®ç»Ÿè®¡' || label.textContent === 'æ•°æ®åŒæ­¥ä¸­')) {
                            card.remove();
                        }
                    });
                    
                    // å°†åŠ è½½å¡ç‰‡æ’å…¥åˆ°èº«ä»½é…ç½®å¡ç‰‡ä¹‹å
                    const identityCard = leftBody.querySelector('.drawer-item');
                    if (identityCard && identityCard.nextSibling) {
                        leftBody.insertBefore(loadingCard, identityCard.nextSibling);
                    } else {
                        leftBody.appendChild(loadingCard);
                    }
                    
                    console.log('[UserStats] âœ… å·²æ˜¾ç¤ºæ•°æ®åŒæ­¥ä¸­å ä½ç¬¦');
                    return; // æå‰è¿”å›ï¼Œä¸æ¸²æŸ“å®Œæ•´ç»Ÿè®¡å¡ç‰‡
                }
                
                // æå–ç»´åº¦å€¼
                const dimensionValues = extractDimensionValues(userData);
                console.log('[UserStats] ğŸ“Š æå–çš„ç»´åº¦å€¼:', dimensionValues);
                
                // 1. æŠ€æœ¯æ’åï¼ˆä½¿ç”¨å¹³å‡æ’åæˆ–ç»¼åˆæ’åï¼‰
                // ã€Task 2ã€‘ä¼˜å…ˆä½¿ç”¨è§†å›¾è¿”å›çš„ vibe_rank å’Œ vibe_percentile
                const vibeRank = userData.vibe_rank || null;
                const vibePercentile = userData.vibe_percentile || null;
                const avgRank = userData.avg_rank || userData.avgRank || userData.ranks?.avgRank || vibePercentile || null;
                const totalUsers = window.lastData?.totalUsers || 1;
                let techRankText = 'N/A';
                
                // ä¼˜å…ˆä½¿ç”¨ vibe_rankï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (vibeRank !== null && vibeRank !== undefined && totalUsers > 0) {
                    techRankText = `ç¬¬ ${vibeRank} å / ${totalUsers} äºº`;
                } else if (avgRank !== null && avgRank !== undefined && totalUsers > 0) {
                    const rankPercent = Math.round((1 - avgRank / 100) * totalUsers);
                    techRankText = `ç¬¬ ${rankPercent} å / ${totalUsers} äºº`;
                }
                console.log('[UserStats] ğŸ† æŠ€æœ¯æ’å:', { vibeRank, vibePercentile, avgRank, totalUsers, techRankText });
                
                // 2. è°ƒæˆAIæ¬¡æ•°ï¼ˆaiç»´åº¦ï¼‰
                const aiCount = dimensionValues.ai !== undefined && dimensionValues.ai !== null 
                    ? new Intl.NumberFormat('zh-CN').format(dimensionValues.ai) 
                    : 'N/A';
                
                // 3. ç”²æ–¹çˆ¸çˆ¸ä¸Šèº«æ¬¡æ•°ï¼ˆnoç»´åº¦ï¼‰
                const noCount = dimensionValues.no !== undefined && dimensionValues.no !== null 
                    ? new Intl.NumberFormat('zh-CN').format(dimensionValues.no) 
                    : 'N/A';
                
                // 4. èµ›åšç£•å¤´æ¬¡æ•°ï¼ˆpleaseç»´åº¦ï¼‰
                const pleaseCount = dimensionValues.please !== undefined && dimensionValues.please !== null 
                    ? new Intl.NumberFormat('zh-CN').format(dimensionValues.please) 
                    : 'N/A';
                
                // 5. åºŸè¯è¾“å‡ºæ€»æ•°ï¼ˆsayç»´åº¦ï¼‰
                const sayTotal = dimensionValues.say !== undefined && dimensionValues.say !== null 
                    ? new Intl.NumberFormat('zh-CN').format(dimensionValues.say) 
                    : 'N/A';
                
                // 6. å¹³å‡å¹æ°´é•¿åº¦ï¼ˆwordç»´åº¦ï¼‰
                const avgLength = dimensionValues.word !== undefined && dimensionValues.word !== null 
                    ? new Intl.NumberFormat('zh-CN').format(Math.round(dimensionValues.word)) 
                    : 'N/A';
                
                // 7. äººæ ¼ç§°å·
                const personalityType = userData.personality_type || userData.personalityType || userData.type || 'UNKNOWN';
                const personalityName = userData.personality_name || userData.personalityName || userData.name || 'æœªçŸ¥äººæ ¼';
                
                // 8. ç­”æ¡ˆä¹‹ä¹¦è¯´æ˜ï¼ˆanswer_book å¯¹è±¡ï¼‰
                let answerBookTitle = 'æš‚æ— ';
                let answerBookContent = 'æš‚æ— è¯´æ˜';
                let answerBookVibeLevel = '';
                
                try {
                    // å°è¯•è§£æ answer_book å­—æ®µï¼ˆå¯èƒ½æ˜¯ JSON å­—ç¬¦ä¸²æˆ–å¯¹è±¡ï¼‰
                    let answerBook = userData.answer_book || userData.answerBook;
                    if (typeof answerBook === 'string') {
                        try {
                            answerBook = JSON.parse(answerBook);
                        } catch (e) {
                            console.warn('[UserStats] âš ï¸ è§£æ answer_book JSON å¤±è´¥:', e);
                        }
                    }
                    
                    if (answerBook && typeof answerBook === 'object') {
                        answerBookTitle = answerBook.title || answerBookTitle;
                        answerBookContent = answerBook.content || answerBookContent;
                        answerBookVibeLevel = answerBook.vibe_level || answerBook.vibeLevel || '';
                    }
                } catch (e) {
                    console.warn('[UserStats] âš ï¸ å¤„ç† answer_book å¤±è´¥:', e);
                }
                
                // åˆ›å»ºç”¨æˆ·ç»Ÿè®¡å¡ç‰‡å®¹å™¨
                const statsCard = document.createElement('div');
                statsCard.className = 'drawer-item';
                statsCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">ğŸ“Š</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                            STATS
                        </span>
                    </div>
                    
                    <div class="drawer-item-label mb-3">æˆ‘çš„æ•°æ®ç»Ÿè®¡</div>
                    
                    <!-- æŠ€æœ¯æ’å -->
                    <div class="mb-3 pb-3 border-b border-[#00ff41]/10">
                        <div class="drawer-item-label mb-1">æŠ€æœ¯æ’å</div>
                        <div class="drawer-item-value text-lg">${techRankText}</div>
                        <div class="drawer-item-desc text-[8px]">TECH_RANK</div>
                    </div>
                    
                    <!-- ç»´åº¦ç»Ÿè®¡ -->
                    <div class="space-y-2 mb-3">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] text-[#00ff41]/70">ğŸ’¬ è°ƒæˆAIæ¬¡æ•°</span>
                            <span class="text-[10px] text-white font-bold">${aiCount}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] text-[#00ff41]/70">ğŸš« ç”²æ–¹ä¸Šèº«æ¬¡æ•°</span>
                            <span class="text-[10px] text-white font-bold">${noCount}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] text-[#00ff41]/70">ğŸ™ èµ›åšç£•å¤´æ¬¡æ•°</span>
                            <span class="text-[10px] text-white font-bold">${pleaseCount}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] text-[#00ff41]/70">ğŸ’­ åºŸè¯è¾“å‡ºæ€»æ•°</span>
                            <span class="text-[10px] text-white font-bold">${sayTotal}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] text-[#00ff41]/70">ğŸ“ å¹³å‡å¹æ°´é•¿åº¦</span>
                            <span class="text-[10px] text-white font-bold">${avgLength} å­—/æ¡</span>
                        </div>
                    </div>
                    
                    <!-- äººæ ¼ç§°å· -->
                    <div class="mb-3 pb-3 border-b border-[#00ff41]/10">
                        <div class="drawer-item-label mb-1">äººæ ¼ç§°å·</div>
                        <div class="drawer-item-value text-sm">${personalityName}</div>
                        <div class="drawer-item-desc text-[8px]">${personalityType}</div>
                    </div>
                    
                    <!-- ç­”æ¡ˆä¹‹ä¹¦ -->
                    <div class="mb-2">
                        <div class="drawer-item-label mb-1">ç­”æ¡ˆä¹‹ä¹¦</div>
                        ${answerBookVibeLevel ? `<div class="text-[9px] text-[#00ff41]/80 mb-1">${answerBookVibeLevel}</div>` : ''}
                        <div class="text-[10px] text-white font-bold mb-1">${answerBookTitle}</div>
                        <div class="text-[9px] text-[#00ff41]/60 leading-relaxed">${answerBookContent}</div>
                    </div>
                `;
                
                // å…ˆç§»é™¤æ—§çš„ç»Ÿè®¡å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const existingStatsCards = leftBody.querySelectorAll('.drawer-item');
                existingStatsCards.forEach(card => {
                    const label = card.querySelector('.drawer-item-label');
                    if (label && label.textContent === 'æˆ‘çš„æ•°æ®ç»Ÿè®¡') {
                        card.remove();
                    }
                });
                
                // å°†ç»Ÿè®¡å¡ç‰‡æ’å…¥åˆ°èº«ä»½é…ç½®å¡ç‰‡ä¹‹å
                const identityCard = leftBody.querySelector('.drawer-item');
                if (identityCard && identityCard.nextSibling) {
                    leftBody.insertBefore(statsCard, identityCard.nextSibling);
                } else {
                    leftBody.appendChild(statsCard);
                }
                
                console.log('[UserStats] âœ… ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡å·²æ¸²æŸ“');
            } catch (error) {
                console.error('[UserStats] âŒ æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡å¤±è´¥:', error);
            }
        }

        /**
         * ä»ç”¨æˆ·æ•°æ®ä¸­æå–ç»´åº¦å€¼
         * @param {Object} userData - ç”¨æˆ·æ•°æ®å¯¹è±¡
         * @returns {Object} åŒ…å« 6 ä¸ªç»´åº¦å€¼çš„å¯¹è±¡
         */
        function extractDimensionValues(userData) {
            if (!userData) {
                return {
                    ai: undefined,
                    word: undefined,
                    day: undefined,
                    no: undefined,
                    say: undefined,
                    please: undefined
                };
            }

            // ai (å¯¹è¯æ¬¡æ•°/èµ›åšéœ¸æ€»)ï¼šä¼˜å…ˆå– question_message_countï¼ˆv_top_records è§†å›¾ä½¿ç”¨ï¼‰ï¼Œå…¶æ¬¡ total_messages
            // å­—æ®µå›é€€ï¼šquestion_message_count -> total_messages -> l_score -> l -> L
            let messages = undefined;
            if (userData.question_message_count !== undefined && userData.question_message_count !== null) {
                messages = Number(userData.question_message_count);
            } else if (userData.total_messages !== undefined && userData.total_messages !== null) {
                messages = Number(userData.total_messages);
            } else if (userData.l_score !== undefined && userData.l_score !== null) {
                messages = Number(userData.l_score);
            } else if (userData.l !== undefined && userData.l !== null) {
                messages = Number(userData.l);
            } else if (userData.L !== undefined && userData.L !== null) {
                messages = Number(userData.L);
            }
            
            // say (æ€»å­—æ•°/ç´¯è®¡å­—æ•°)ï¼šä¼˜å…ˆå– total_user_charsï¼ˆv_top_records è§†å›¾ä½¿ç”¨ï¼‰ï¼Œå…¶æ¬¡ total_chars
            // å­—æ®µå›é€€ï¼štotal_user_chars -> total_chars -> totalUserChars -> p_score -> p -> P
            // å…³é”®ï¼šv_top_records è§†å›¾ä½¿ç”¨ total_user_chars å­—æ®µ
            let chars = undefined;
            if (userData.total_user_chars !== undefined && userData.total_user_chars !== null && Number(userData.total_user_chars) > 0) {
                chars = Number(userData.total_user_chars);
            } else if (userData.total_chars !== undefined && userData.total_chars !== null && Number(userData.total_chars) > 0) {
                chars = Number(userData.total_chars);
            } else if (userData.totalUserChars !== undefined && userData.totalUserChars !== null && Number(userData.totalUserChars) > 0) {
                chars = Number(userData.totalUserChars);
            } else if (userData.p_score !== undefined && userData.p_score !== null && Number(userData.p_score) > 0) {
                chars = Number(userData.p_score);
            } else if (userData.p !== undefined && userData.p !== null && Number(userData.p) > 0) {
                chars = Number(userData.p);
            } else if (userData.P !== undefined && userData.P !== null && Number(userData.P) > 0) {
                chars = Number(userData.P);
            }
            
            // word (å¹³å‡é•¿åº¦)ï¼šè‹¥ avg_user_message_length ä¸º 0ï¼Œå¿…é¡»æ‰§è¡Œ Math.round(total_chars / total_messages)
            // å­—æ®µå›é€€ï¼šavg_user_message_length -> avgMessageLength -> avgUserMessageLength -> å…¬å¼è®¡ç®—
            let word = undefined;
            if (userData.avg_user_message_length !== undefined && userData.avg_user_message_length !== null) {
                word = Number(userData.avg_user_message_length);
            } else if (userData.avgMessageLength !== undefined && userData.avgMessageLength !== null) {
                word = Number(userData.avgMessageLength);
            } else if (userData.avgUserMessageLength !== undefined && userData.avgUserMessageLength !== null) {
                word = Number(userData.avgUserMessageLength);
            }
            // å¦‚æœ word æœªå®šä¹‰ä¸” messages > 0 ä¸” chars > 0ï¼Œå¿…é¡»é€šè¿‡å…¬å¼å®æ—¶è®¡ç®—
            if (word === undefined && messages !== undefined && messages > 0 && chars !== undefined && chars > 0) {
                word = Math.round(chars / messages);
            }
            
            // day (ä¸Šå²—å¤©æ•°)ï¼šæ˜ å°„ work_days
            // å­—æ®µå›é€€ï¼šwork_days -> d_score -> d -> D
            let day = undefined;
            if (userData.work_days !== undefined && userData.work_days !== null) {
                day = Number(userData.work_days);
            } else if (userData.d_score !== undefined && userData.d_score !== null) {
                day = Number(userData.d_score);
            } else if (userData.d !== undefined && userData.d !== null) {
                day = Number(userData.d);
            } else if (userData.D !== undefined && userData.D !== null) {
                day = Number(userData.D);
            }
            
            // no (ç”²æ–¹ä¸Šèº«)ï¼šæ˜ å°„ jiafang_count
            // å­—æ®µå›é€€ï¼šjiafang_count -> f_score -> f -> F
            let no = undefined;
            if (userData.jiafang_count !== undefined && userData.jiafang_count !== null) {
                no = Number(userData.jiafang_count);
            } else if (userData.f_score !== undefined && userData.f_score !== null) {
                no = Number(userData.f_score);
            } else if (userData.f !== undefined && userData.f !== null) {
                no = Number(userData.f);
            } else if (userData.F !== undefined && userData.F !== null) {
                no = Number(userData.F);
            }
            
            // please (èµ›åšç£•å¤´)ï¼šæ˜ å°„ ketao_count
            // å­—æ®µå›é€€ï¼šketao_count -> e_score -> e -> E
            let please = undefined;
            if (userData.ketao_count !== undefined && userData.ketao_count !== null) {
                please = Number(userData.ketao_count);
            } else if (userData.e_score !== undefined && userData.e_score !== null) {
                please = Number(userData.e_score);
            } else if (userData.e !== undefined && userData.e !== null) {
                please = Number(userData.e);
            } else if (userData.E !== undefined && userData.E !== null) {
                please = Number(userData.E);
            }

            return { 
                ai: messages, 
                word, 
                day, 
                no, 
                say: chars, 
                please 
            };
        }

        /**
         * è®¡ç®—æ¯ä¸ªç»´åº¦ç›¸å¯¹äºå…¶æœ€å¤§å€¼çš„æ¯”ä¾‹ï¼Œæ‰¾å‡ºæœ€é«˜é¡¹
         * @param {Object} values - ç»´åº¦å€¼å¯¹è±¡
         * @returns {string|null} æœ€é«˜é¡¹çš„ç»´åº¦IDï¼Œå¦‚æœæ‰€æœ‰å€¼éƒ½ä¸º0åˆ™è¿”å›null
         */
        function findTopDimension(values) {
            // å®šä¹‰æ¯ä¸ªç»´åº¦çš„æœ€å¤§å€¼ï¼ˆç”¨äºè®¡ç®—ç›¸å¯¹æ¯”ä¾‹ï¼‰
            const maxValues = {
                ai: 10000,      // å¯¹è¯æ¬¡æ•°å¯èƒ½å¾ˆå¤§
                word: 1000,     // å¹³å‡å­—æ•°
                day: 365,       // å¤©æ•°
                no: 100,        // å¦å®šæ¬¡æ•°
                say: 100000,    // æ€»å­—æ•°
                please: 100     // ç¤¼è²Œæ¬¡æ•°
            };

            let topDim = null;
            let maxRatio = -1;

            for (const [dimId, value] of Object.entries(values)) {
                const maxValue = maxValues[dimId] || 100;
                const ratio = value / maxValue;
                if (ratio > maxRatio && value > 0) {
                    maxRatio = ratio;
                    topDim = dimId;
                }
            }

            return topDim;
        }

        /**
         * æ¸²æŸ“ 6 ä¸ªç»´åº¦æ’åå¡ç‰‡
         * @param {Object} userData - ç”¨æˆ·æ•°æ®å¯¹è±¡ï¼ˆä» Supabase è¿”å›ï¼‰ï¼Œå¦‚æœä¸º null åˆ™æ˜¾ç¤ºé»˜è®¤å€¼
         */
        function renderRankCards(userData) {
            const container = document.getElementById('rank-cards-container');
            if (!container) {
                console.warn('[Rank] âš ï¸ rank-cards-container å®¹å™¨ä¸å­˜åœ¨');
                return;
            }

            if (!RANK_RESOURCES) {
                console.warn('[Rank] âš ï¸ RANK_RESOURCES æœªåŠ è½½ï¼Œæ— æ³•æ¸²æŸ“å¡ç‰‡');
                container.innerHTML = '<div class="col-span-full text-center text-zinc-500 py-4 text-sm">ç»´åº¦æ’åæ•°æ®åŠ è½½ä¸­...</div>';
                return;
            }

            // æ•°æ®åˆ¤åˆ«ï¼šå®šä¹‰å˜é‡ const isGlobalTopMode = !userData
            const isGlobalTopMode = !userData;
            
            // UI åé¦ˆä¼˜åŒ–ï¼šå¦‚æœè¯†åˆ«åˆ°æ˜¯æœ¬åœ°æŒ‡çº¹åŒ¹é…çš„ç”¨æˆ·ï¼Œåœ¨æŠ½å±‰æ ‡é¢˜å¢åŠ "ï¼ˆå½“å‰è®¾å¤‡ï¼‰"æ ‡è¯†
            if (userData && window.currentUserMatchedByFingerprint) {
                try {
                    const leftTitle = document.getElementById('left-drawer-title');
                    if (leftTitle) {
                        // æ£€æŸ¥æ ‡é¢˜æ˜¯å¦å·²ç»åŒ…å«"ï¼ˆå½“å‰è®¾å¤‡ï¼‰"ï¼Œé¿å…é‡å¤æ·»åŠ 
                        const currentText = leftTitle.textContent || '';
                        if (!currentText.includes('ï¼ˆå½“å‰è®¾å¤‡ï¼‰') && !currentText.includes('(å½“å‰è®¾å¤‡)')) {
                            leftTitle.textContent = currentText + 'ï¼ˆå½“å‰è®¾å¤‡ï¼‰';
                            console.log('[Rank] âœ… å·²æ›´æ–°å·¦ä¾§æŠ½å±‰æ ‡é¢˜ï¼Œæ·»åŠ "ï¼ˆå½“å‰è®¾å¤‡ï¼‰"æ ‡è¯†');
                        }
                    }
                } catch (e) {
                    console.warn('[Rank] âš ï¸ æ›´æ–°æŠ½å±‰æ ‡é¢˜å¤±è´¥:', e);
                }
            }

            // ç»´åº¦é…ç½®ï¼ˆåç§°æ˜ å°„å’Œæ•°å€¼åç¼€ï¼‰
            const dimensionConfig = {
                ai: { name: 'å¯¹è¯AIæ¬¡æ•°', icon: 'ğŸ’¬', suffix: 'æ¬¡' },
                word: { name: 'å¹³å‡é•¿åº¦', icon: 'ğŸ“', suffix: 'å­—/æ¡' },
                day: { name: 'ä¸Šå²—å¤©æ•°', icon: 'ğŸ“…', suffix: 'å¤©' },
                no: { name: 'ç”²æ–¹ä¸Šèº«', icon: 'ğŸš«', suffix: 'æ¬¡' },
                say: { name: 'åºŸè¯è¾“å‡º', icon: 'ğŸ’­', suffix: 'å­—' },
                please: { name: 'èµ›åšç£•å¤´', icon: 'ğŸ™', suffix: 'æ¬¡' }
            };

            // ç¡®ä¿åŒ…å«æ‰€æœ‰ 6 ä¸ªç»´åº¦
            const allDimensions = ['ai', 'word', 'day', 'no', 'say', 'please'];
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            // éå† 6 ä¸ªç»´åº¦ï¼Œç”Ÿæˆå¡ç‰‡
            allDimensions.forEach((dimId, index) => {
                const config = dimensionConfig[dimId];
                if (!config) {
                    console.warn(`[Rank] âš ï¸ ç»´åº¦ ${dimId} é…ç½®ä¸å­˜åœ¨`);
                    return;
                }

                // ç»´åº¦é€‰æ‹”é€»è¾‘
                let targetData = null;
                let maxValue = 0;
                let targetUserName = '';
                let targetIpLocation = null; // è®°å½•å† å†›ç”¨æˆ·çš„ ip_locationï¼ˆå›½å®¶ä»£ç ï¼‰

                if (isGlobalTopMode) {
                    // ã€å…¨çƒé€‰æ‹”æ¨¡å¼ã€‘ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„ topRecordsï¼ˆå„ç»´åº¦æœ€é«˜è®°å½•ï¼‰
                    const globalDataForTop = window.lastData || {};
                    const topRecords = globalDataForTop.topRecords || {};
                    
                    // ä¼˜å…ˆä½¿ç”¨ topRecords ä¸­çš„æ•°æ®
                    if (topRecords[dimId]) {
                        targetData = topRecords[dimId];
                        const targetValues = extractDimensionValues(targetData);
                        maxValue = targetValues[dimId] !== undefined && targetValues[dimId] !== null ? targetValues[dimId] : undefined;
                        targetUserName = targetData.user_name || targetData.name || targetData.github_username || 'å…¨çƒæœ€å¼º';
                        targetIpLocation = targetData.ip_location || null;
                        console.log(`[Rank] âœ… ä½¿ç”¨ topRecords æ•°æ® (${dimId}):`, maxValue, targetUserName);
                    } else {
                        // é™çº§ï¼šä½¿ç”¨ window.allData æ‰¾å‡ºå„ç»´åº¦çš„æœ€å¤§å€¼ç”¨æˆ·
                        const allData = window.allData || [];
                        if (allData.length > 0) {
                            targetData = allData.reduce((maxUser, currentUser) => {
                                const currentValues = extractDimensionValues(currentUser);
                                const maxValues = extractDimensionValues(maxUser);
                                const currentValue = currentValues[dimId] !== undefined && currentValues[dimId] !== null ? currentValues[dimId] : 0;
                                const maxValue = maxValues[dimId] !== undefined && maxValues[dimId] !== null ? maxValues[dimId] : 0;
                                return currentValue > maxValue ? currentUser : maxUser;
                            }, allData[0]);
                            
                            const targetValues = extractDimensionValues(targetData);
                            maxValue = targetValues[dimId] !== undefined && targetValues[dimId] !== null ? targetValues[dimId] : undefined;
                            targetUserName = targetData.user_name || targetData.name || targetData.github_username || 'æœªçŸ¥ç”¨æˆ·';
                            // èº«ä»½æ ‡è®°ï¼šè®°å½•è¯¥å† å†›ç”¨æˆ·çš„ ip_locationï¼ˆå›½å®¶ä»£ç ï¼Œå¦‚ "US", "CN"ï¼‰
                            targetIpLocation = targetData.ip_location || null;
                        } else {
                            // ã€å…¨å±€æ•°æ®å…œåº•ã€‘å¦‚æœæ²¡æœ‰ allDataï¼Œä½¿ç”¨å…¨å±€ averages æ•°æ®
                            // ä» window.lastData æˆ–å…¨å±€å˜é‡ä¸­è·å– averages
                            const globalDataForAvg = window.lastData || {};
                            const averages = globalDataForAvg.averages || globalDataForAvg.globalAverage || {};
                            const totalUsers = Number(globalDataForAvg.totalUsers) || 1;
                            
                            // ã€ä¿®å¤ç»´åº¦æ˜ å°„ã€‘æ ¹æ®æœ€æ–°çš„ API ç»“æ„é‡æ–°ç»‘å®š
                            // ä¿®æ­£å¡ç‰‡ ID æ˜ å°„ï¼šjiafang å¯¹åº” jiafang_countï¼Œketao å¯¹åº” ketao_count
                            // ä½¿ç”¨å…¨çƒæœ€å¼ºè®°å½•ï¼ˆjiafang_count > 0ï¼‰æˆ–å…¨å±€ averages æ•°æ®
                            let avgValue = undefined;
                            
                            // ä¼˜å…ˆä½¿ç”¨å…¨çƒæœ€å¼ºè®°å½•
                            const championRecord = window.globalChampionRecord;
                            
                            if (dimId === 'ai') {
                                // åˆ†ææ€»é‡ï¼šç»‘å®šåˆ° json.totalAnalysis
                                if (globalDataForAvg.totalAnalysis !== undefined && globalDataForAvg.totalAnalysis !== null) {
                                    avgValue = Number(globalDataForAvg.totalAnalysis);
                                }
                            } else if (dimId === 'word') {
                                // å¹³å‡é•¿åº¦éœ€è¦è®¡ç®—ï¼šå¦‚æœæœ‰ totalChars å’Œ totalMessagesï¼Œè®¡ç®—å¹³å‡å€¼
                                const totalChars = globalDataForAvg.totalChars !== undefined && globalDataForAvg.totalChars !== null ? Number(globalDataForAvg.totalChars) : (globalDataForAvg.totalRoastWords !== undefined && globalDataForAvg.totalRoastWords !== null ? Number(globalDataForAvg.totalRoastWords) : undefined);
                                const totalMessages = globalDataForAvg.totalAnalysis !== undefined && globalDataForAvg.totalAnalysis !== null ? Number(globalDataForAvg.totalAnalysis) : undefined;
                                if (totalChars !== undefined && totalMessages !== undefined && totalMessages > 0) {
                                    avgValue = Math.round(totalChars / totalMessages);
                                } else if (averages.P !== undefined && averages.P !== null) {
                                    avgValue = Number(averages.P);
                                }
                            } else if (dimId === 'day') {
                                // ä¸Šå²—å¤©æ•°ï¼šç»‘å®šåˆ° json.systemDays
                                if (globalDataForAvg.systemDays !== undefined && globalDataForAvg.systemDays !== null) {
                                    avgValue = Number(globalDataForAvg.systemDays);
                                } else if (championRecord && championRecord.work_days !== undefined && championRecord.work_days !== null) {
                                    avgValue = Number(championRecord.work_days);
                                }
                            } else if (dimId === 'no') {
                                // ç”²æ–¹ä¸Šèº«ï¼šæ˜ å°„ jiafang_count
                                if (championRecord && championRecord.jiafang_count !== undefined && championRecord.jiafang_count !== null) {
                                    avgValue = Number(championRecord.jiafang_count);
                                } else if (averages.L !== undefined && averages.L !== null) {
                                    avgValue = Number(averages.L);
                                }
                            } else if (dimId === 'say') {
                                // æ€»å­—æ•°ï¼šä½¿ç”¨ totalChars æˆ– totalRoastWords
                                if (globalDataForAvg.totalChars !== undefined && globalDataForAvg.totalChars !== null) {
                                    avgValue = Number(globalDataForAvg.totalChars);
                                } else if (globalDataForAvg.totalRoastWords !== undefined && globalDataForAvg.totalRoastWords !== null) {
                                    avgValue = Number(globalDataForAvg.totalRoastWords);
                                }
                            } else if (dimId === 'please') {
                                // èµ›åšç£•å¤´ï¼šæ˜ å°„ ketao_count
                                if (championRecord && championRecord.ketao_count !== undefined && championRecord.ketao_count !== null) {
                                    avgValue = Number(championRecord.ketao_count);
                                } else if (averages.P !== undefined && averages.P !== null) {
                                    avgValue = Number(averages.P);
                                }
                            }
                            
                            maxValue = avgValue;
                            // å½“ totalUsers ä¸º 1 æ—¶ï¼Œæ˜¾ç¤º SYSTEM BASE
                            targetUserName = totalUsers <= 1 ? 'SYSTEM BASE' : 'GLOBAL AVG';
                            targetIpLocation = null;
                        }
                    }
                } else {
                    // å¦‚æœ userData å­˜åœ¨ï¼Œåˆ™ targetData å§‹ç»ˆä¸ºå½“å‰ç”¨æˆ·
                    targetData = userData;
                    const values = extractDimensionValues(userData);
                    maxValue = values[dimId] !== undefined && values[dimId] !== null ? values[dimId] : undefined;
                    
                    // ç¡®å®šæ˜¾ç¤ºçš„ç”¨æˆ·åï¼šå¦‚æœæ˜¯çº¯æŒ‡çº¹ç”¨æˆ·ï¼ˆæ—  GitHub IDï¼‰ï¼Œæ˜¾ç¤º"åŒ¿åä¸“å®¶ [æŒ‡çº¹å‰6ä½]"
                    const userFingerprint = userData.fingerprint || userData.user_fingerprint || userData.user_identity;
                    const userGithubId = userData.github_username || userData.github_id;
                    const userName = userData.user_name || userData.name;
                    
                    if (!userGithubId && !userName && userFingerprint) {
                        // çº¯æŒ‡çº¹ç”¨æˆ·ï¼šæ˜¾ç¤º"åŒ¿åä¸“å®¶ [æŒ‡çº¹å‰6ä½]"
                        const fingerprintPrefix = String(userFingerprint).substring(0, 6).toUpperCase();
                        targetUserName = `åŒ¿åä¸“å®¶ ${fingerprintPrefix}`;
                    } else {
                        // æœ‰ GitHub ID æˆ–ç”¨æˆ·åçš„ç”¨æˆ·
                        targetUserName = userName || userGithubId || 'æˆ‘çš„æ•°æ®';
                    }
                    
                    targetIpLocation = userData.ip_location || null;
                }

                // è°ƒç”¨ getRankFeedback(dimId, maxValue) è·å–å¯¹åº”çš„ç­‰çº§ label å’Œåæ§½ content
                // ç¡®ä¿å³ä½¿æ˜¯å…¨çƒæœ€å¼ºï¼Œæ–‡æ¡ˆä¹Ÿæ˜¯ä»è¯¥ç»´åº¦çš„æœ€é«˜ç­‰çº§åŒºé—´ä¸­éšæœºæŠ½å–çš„
                const feedback = getRankFeedback(dimId, maxValue);

                // ã€çŠ¶æ€å…œåº•ã€‘å½“ totalUsers ä¸º 1 æ—¶ï¼Œç¡¬ç¼–ç æ˜¾ç¤º TOP 1 æˆ– SYSTEM BASE
                const globalDataForStatus = window.lastData || {};
                const totalUsers = Number(globalDataForStatus.totalUsers) || 1;
                let statusLabel = isGlobalTopMode ? 'TOP' : 'MINE';
                let feedbackLabel = feedback ? feedback.label : 'RANKED';
                
                // å¦‚æœ totalUsers ä¸º 1ï¼Œæ’åç»Ÿä¸€æ˜¾ç¤ºä¸º TOP 1
                if (totalUsers <= 1) {
                    statusLabel = 'TOP 1';
                    if (isGlobalTopMode) {
                        feedbackLabel = 'SYSTEM BASE';
                    }
                }

                // æ‰¾å‡ºæœ€é«˜é¡¹ï¼ˆç”¨äºä¸ªäººæ¨¡å¼ä¸‹çš„ TOP æ ‡è¯†ï¼‰
                let isTop = false;
                if (!isGlobalTopMode && targetData) {
                    const values = extractDimensionValues(targetData);
                    const topDim = findTopDimension(values);
                    isTop = topDim === dimId;
                }

                // æ•°å€¼å¤„ç†ï¼šsay (æ€»å­—æ•°) ä½¿ç”¨ Intl.NumberFormat('zh-CN').format() è¿›è¡Œåƒåˆ†ä½æ ¼å¼åŒ–
                // å•ä½è¡¥å…¨ï¼šæ ¹æ® RANK_RESOURCES è‡ªåŠ¨è¡¥å…¨å•ä½ï¼ˆæ¬¡ã€å­—ã€å¤©ç­‰ï¼‰
                // å½»åº•åˆ é™¤ç¡¬ç¼–ç ï¼Œå¦‚æœæ¥å£æœ‰å€¼åˆ™å¿…é¡»æ˜¾ç¤ºæ¥å£çš„å€¼
                let displayVal;
                let unit = config.suffix || '';
                if (maxValue !== undefined && maxValue !== null) {
                    if (dimId === 'say') {
                        displayVal = new Intl.NumberFormat('zh-CN').format(maxValue);
                    } else {
                        displayVal = new Intl.NumberFormat('zh-CN').format(maxValue);
                    }
                } else {
                    displayVal = 'N/A';
                }

                // è·å–èµ„æºä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºç»´åº¦åç§°ï¼‰
                const resource = RANK_RESOURCES && RANK_RESOURCES[dimId] ? RANK_RESOURCES[dimId] : null;
                
                // åˆ›å»ºå¡ç‰‡å…ƒç´ 
                // èµ›åšé£æ ¼ï¼šèƒŒæ™¯ bg-[#050505]/60 é…åˆ backdrop-blur-xl
                // æ‚¬æµ®æ—¶ä¸Šç§» hover:-translate-y-2ï¼Œè¾¹æ¡†ç”±æš—ç»¿å˜ä¸ºäº®ç»¿ï¼Œå¹¶å‡ºç°èµ›åšè½¬è§’æ‰«æçº¿
                const card = document.createElement('div');
                card.className = `cursor-pointer flex-1 min-w-0 bg-[#050505]/60 backdrop-blur-xl border border-[#00ff41]/20 p-3 rounded-sm transition-all duration-300 hover:-translate-y-2 hover:border-[#00ff41] hover:shadow-[0_0_20px_rgba(0,255,65,0.4)] relative group pointer-events-auto overflow-visible`;
                
                // å­˜å‚¨ç»´åº¦IDå’Œå›½å®¶ä»£ç ï¼Œç”¨äºåœ°å›¾è”åŠ¨
                card.setAttribute('data-dim-id', dimId);
                if (targetIpLocation) {
                    card.setAttribute('data-ip-location', targetIpLocation);
                }
                // å­˜å‚¨å† å†›ä¿¡æ¯ï¼Œç”¨äºåœ°å›¾å¼¹çª—å±•ç¤º
                card.setAttribute('data-champion-name', targetUserName);
                card.setAttribute('data-champion-value', maxValue);
                card.setAttribute('data-champion-feedback', feedback ? JSON.stringify(feedback) : '');
                
                // å¡ç‰‡å†…å®¹ï¼šèµ›åšé£æ ¼æ¨¡æ¿
                // æ•°å­—ï¼šæ‰€æœ‰å¡ç‰‡æ•°å€¼æ–‡å­—é¢œè‰²ç»Ÿä¸€æ”¹ä¸ºçº¯ç™½è‰² (text-white)ï¼Œå¢åŠ  drop-shadow
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">${config.icon}</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5 z-10 relative">
                            ${statusLabel}
                        </span>
                    </div>

                    <div class="text-[9px] text-[#00ff41]/50 uppercase tracking-widest mb-1 truncate">
                        ${config.name}
                    </div>

                    <div class="text-2xl font-bold text-white font-mono truncate leading-none drop-shadow-[0_0_8px_rgba(255,255,255,0.3)]">
                        ${displayVal}<span class="text-[10px] ml-1 font-normal opacity-70">${unit}</span>
                    </div>

                    <div class="mt-2 pt-2 border-t border-[#00ff41]/10 flex flex-col gap-0.5">
                        <div class="text-[10px] text-white font-bold truncate">
                            ${feedbackLabel}
                        </div>
                        <div class="text-[8px] text-[#00ff41]/60 truncate italic">
                            @${targetUserName || 'ANONYMOUS'}
                        </div>
                    </div>

                    <!-- èµ›åšè½¬è§’æ‰«æçº¿ -->
                    <div class="absolute -top-[1px] -left-[1px] w-2 h-2 border-t border-l border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                    <div class="absolute -bottom-[1px] -right-[1px] w-2 h-2 border-b border-r border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                    <div class="absolute -top-[1px] -right-[1px] w-2 h-2 border-t border-r border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                    <div class="absolute -bottom-[1px] -left-[1px] w-2 h-2 border-b border-l border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                `;

                // åœ°å›¾è”åŠ¨äº¤äº’ï¼šä¸ºæ¯ä¸ªå¡ç‰‡ç»‘å®šç‚¹å‡»ç›‘å¬å™¨
                card.addEventListener('click', () => {
                    const ipLocation = card.getAttribute('data-ip-location');
                    if (ipLocation && mapChart && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                        // å°†å›½å®¶ä»£ç è½¬æ¢ä¸ºåœ°å›¾ä¸Šçš„å›½å®¶åç§°
                        let countryName = null;
                        if (countryNameMap && countryNameMap[ipLocation]) {
                            // ä½¿ç”¨è‹±æ–‡åç§°ï¼ˆåœ°å›¾ä½¿ç”¨è‹±æ–‡åç§°ï¼‰
                            countryName = countryNameMap[ipLocation].en;
                        } else {
                            // å¦‚æœæ²¡æœ‰æ˜ å°„ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨ ip_locationï¼ˆå¯èƒ½æ˜¯å®Œæ•´çš„å›½å®¶åç§°ï¼‰
                            countryName = ipLocation;
                        }
                        
                        if (countryName) {
                            // è·å–å† å†›ä¿¡æ¯ï¼Œå­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­ï¼Œç”¨äºåœ°å›¾å¼¹çª—å±•ç¤º
                            const championName = card.getAttribute('data-champion-name');
                            const championValue = card.getAttribute('data-champion-value');
                            const championFeedback = card.getAttribute('data-champion-feedback');
                            const dimId = card.getAttribute('data-dim-id');
                            
                            // å­˜å‚¨å½“å‰é€‰ä¸­çš„å† å†›ä¿¡æ¯
                            currentChampionInfo = {
                                countryName: countryName,
                                championName: championName,
                                championValue: championValue,
                                feedback: championFeedback,
                                dimId: dimId
                            };
                            
                            // ä½¿ç”¨ ECharts å®ä¾‹æ–¹æ³•é«˜äº®æ˜¾ç¤ºåœ°å›¾ä¸Šå¯¹åº”çš„å›½å®¶
                            try {
                                // æ–¹æ³•1ï¼šä½¿ç”¨ dispatchAction è§¦å‘ highlight åŠ¨ä½œ
                                mapChart.dispatchAction({
                                    type: 'highlight',
                                    name: countryName
                                });
                                
                                // æ–¹æ³•2ï¼šä½¿ç”¨ showTip æ˜¾ç¤º tooltipï¼ˆä¼šè§¦å‘ formatterï¼Œæ˜¾ç¤ºå† å†›ä¿¡æ¯ï¼‰
                                mapChart.dispatchAction({
                                    type: 'showTip',
                                    name: countryName
                                });
                                
                                console.log(`[Rank] âœ… ç‚¹å‡»å¡ç‰‡ï¼Œé«˜äº®å›½å®¶: ${countryName} (${ipLocation})`);
                                console.log(`[Rank] ğŸ“Š å† å†›ä¿¡æ¯: ${championName}, æ•°å€¼: ${championValue}, ç»´åº¦: ${dimId}`);
                            } catch (error) {
                                console.error('[Rank] âŒ é«˜äº®å›½å®¶å¤±è´¥:', error);
                            }
                        } else {
                            console.warn(`[Rank] âš ï¸ æ— æ³•æ‰¾åˆ°å›½å®¶åç§°ï¼Œip_location: ${ipLocation}`);
                        }
                    } else if (!ipLocation) {
                        console.warn(`[Rank] âš ï¸ è¯¥ç»´åº¦å† å†›æ²¡æœ‰ ip_location ä¿¡æ¯`);
                    } else {
                        console.warn(`[Rank] âš ï¸ åœ°å›¾å®ä¾‹æœªåˆå§‹åŒ–æˆ–å·²é”€æ¯`);
                    }
                });

                container.appendChild(card);
            });

            console.log(`[Rank] âœ… ç»´åº¦æ’åå¡ç‰‡æ¸²æŸ“å®Œæˆ (æ¨¡å¼: ${isGlobalTopMode ? 'å…¨çƒæœ€å¼º' : 'ä¸ªäººæ•°æ®'})`);
            
            // å¦‚æœæ£€æµ‹åˆ°ç”¨æˆ·æ•°æ®ä¸”å·¦ä¾§æŠ½å±‰å·²æ‰“å¼€ï¼Œè‡ªåŠ¨åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡
            if (userData && !isGlobalTopMode) {
                try {
                    const leftDrawer = document.getElementById('left-drawer');
                    const leftBody = document.getElementById('left-drawer-body');
                    
                    // æ£€æŸ¥å·¦ä¾§æŠ½å±‰æ˜¯å¦æ‰“å¼€ï¼ˆé€šè¿‡æ£€æŸ¥ active classï¼‰
                    if (leftDrawer && leftBody) {
                        const isDrawerOpen = leftDrawer.classList.contains('active');
                        
                        if (isDrawerOpen) {
                            // é‡æ–°æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ï¼ˆå‡½æ•°å†…éƒ¨ä¼šå¤„ç†ç§»é™¤æ—§å¡ç‰‡ï¼‰
                            renderUserStatsCards(leftBody, userData);
                            console.log('[Rank] âœ… å·²è‡ªåŠ¨åˆ·æ–°å·¦ä¾§æŠ½å±‰çš„ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡');
                        }
                    }
                } catch (e) {
                    console.warn('[Rank] âš ï¸ åˆ·æ–°å·¦ä¾§æŠ½å±‰ç»Ÿè®¡å¡ç‰‡å¤±è´¥:', e);
                }
            }
        }


        window.onload = async () => {
            // åŠ è½½ä¿å­˜çš„GitHubç”¨æˆ·åï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
            loadGitHubUsername();
            
            // åˆå§‹åŒ–çŠ¶æ€æŒ‰é’®
            initStatusButtons();
            
            // åˆå§‹åŒ–æŠ½å±‰çŠ¶æ€
            initDrawerState();
            
            // åŠ è½½ç»´åº¦æ’åæ•°æ®èµ„æº
            await loadRankResources();
            
            // å…ˆæ‰§è¡Œåˆå§‹æ•°æ®åŠ è½½ï¼ˆå¢å¼ºé”™è¯¯å¤„ç†ï¼‰
            try {
                await fetchData();
            } catch (fetchError) {
                console.error('[Window.onload] âŒ fetchData å¤±è´¥:', fetchError);
                // å³ä½¿æ•°æ®åŠ è½½å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œåç»­åˆå§‹åŒ–
            }
            
            // ============================================
            // ã€æ–°å¢ã€‘åˆå§‹åŒ– GitHub OAuth è®¤è¯ç›‘å¬
            // ============================================
            if (supabaseClient) {
                // æ£€æŸ¥å½“å‰ä¼šè¯
                try {
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    
                    if (sessionError) {
                        console.warn('[Auth] âš ï¸ è·å–ä¼šè¯å¤±è´¥:', sessionError);
                    } else if (session) {
                        console.log('[Auth] âœ… æ£€æµ‹åˆ°ç°æœ‰ä¼šè¯ï¼Œè‡ªåŠ¨å¤„ç†è®¤è¯çŠ¶æ€');
                        await handleAuthStateChange(session);
                    } else {
                        console.log('[Auth] â„¹ï¸ æœªæ£€æµ‹åˆ°ä¼šè¯ï¼Œæ˜¾ç¤ºç™»å½•æŒ‰é’®');
                        updateAuthUI(null);
                    }
                } catch (error) {
                    console.error('[Auth] âŒ åˆå§‹åŒ–è®¤è¯ç›‘å¬å¤±è´¥:', error);
                }
                
                // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('[Auth] ğŸ”” è®¤è¯çŠ¶æ€å˜åŒ–äº‹ä»¶:', event, session ? 'æœ‰ä¼šè¯' : 'æ— ä¼šè¯');
                    
                    if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                        await handleAuthStateChange(session);
                        
                        // ã€Task 3ã€‘å½“ event === 'SIGNED_IN' æ—¶ï¼Œæ˜¾å¼è°ƒç”¨ä¸€æ¬¡ window.refreshUserStats() å’Œ fetchAllData()
                        if (event === 'SIGNED_IN') {
                            console.log('[Auth] ğŸ”„ ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œè§¦å‘æ•°æ®åˆ·æ–°...');
                            try {
                                // å…ˆåˆ·æ–°å…¨å±€æ•°æ®
                                if (typeof fetchData === 'function') {
                                    await fetchData();
                                    console.log('[Auth] âœ… fetchData æ‰§è¡Œå®Œæˆ');
                                }
                                
                                // å†åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡æ•°æ®
                                if (typeof window.refreshUserStats === 'function') {
                                    try {
                                        await window.refreshUserStats();
                                        console.log('[Auth] âœ… refreshUserStats æ‰§è¡Œå®Œæˆ');
                                    } catch (refreshError) {
                                        // ã€ä¿®å¤ AbortErrorã€‘ç‰¹æ®Šå¤„ç† AbortError
                                        if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                            console.log('[Auth] â„¹ï¸ refreshUserStats è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰');
                                        } else {
                                            console.error('[Auth] âŒ refreshUserStats æ‰§è¡Œå¤±è´¥:', refreshError);
                                        }
                                    }
                                }
                            } catch (refreshError) {
                                // ã€ä¿®å¤ AbortErrorã€‘ç‰¹æ®Šå¤„ç† AbortError
                                if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                    console.log('[Auth] â„¹ï¸ æ•°æ®åˆ·æ–°è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰');
                                } else {
                                    console.error('[Auth] âŒ æ•°æ®åˆ·æ–°å¤±è´¥:', refreshError);
                                }
                            }
                        }
                    } else if (event === 'SIGNED_OUT') {
                        await handleAuthStateChange(null);
                    }
                });
                
                console.log('[Auth] âœ… è®¤è¯çŠ¶æ€ç›‘å¬å·²å¯åŠ¨');
            } else {
                console.warn('[Auth] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•å¯åŠ¨è®¤è¯ç›‘å¬');
                // å»¶è¿Ÿé‡è¯•
                setTimeout(async () => {
                    if (supabaseClient) {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        if (session) {
                            await handleAuthStateChange(session);
                        } else {
                            updateAuthUI(null);
                        }
                    }
                }, 1000);
            }
            
            // é¡µé¢åŠ è½½åç«‹å³æ˜¾ç¤º LPDEF åˆ†å€¼ï¼šæ‰§è¡Œèº«ä»½æ£€æŸ¥ï¼ˆå¢å¼ºèº«ä»½è¯†åˆ«é€»è¾‘ï¼‰
            try {
                // è¾…åŠ©å‡½æ•°ï¼šè§„èŒƒåŒ–æŒ‡çº¹å­—ç¬¦ä¸²ï¼ˆå¿½ç•¥å¤§å°å†™å¹¶å‰”é™¤é¦–å°¾ç©ºæ ¼ï¼‰
                const normalizeFingerprint = (fp) => {
                    if (!fp) return '';
                    return String(fp).trim().toLowerCase();
                };
                
                // 1. ç”Ÿæˆæˆ–è·å–å½“å‰è®¾å¤‡çš„ Fingerprintï¼ˆå¢åŠ å¼‚å¸¸å¤„ç†ï¼‰
                // ã€ä¼˜åŒ–ã€‘ä½¿ç”¨ç»Ÿä¸€çš„æŒ‡çº¹è·å–å‡½æ•°ï¼Œç¡®ä¿ä¸€è‡´æ€§
                let currentFingerprint = await getCurrentFingerprint();
                
                if (!currentFingerprint) {
                    console.warn('[LPDEF] âš ï¸ æ— æ³•è·å–æˆ–ç”ŸæˆæŒ‡çº¹');
                } else {
                    console.log('[LPDEF] ğŸ”‘ å½“å‰è®¾å¤‡ Fingerprint:', currentFingerprint.substring(0, 8) + '...');
                }
                
                // è§„èŒƒåŒ–å½“å‰æŒ‡çº¹
                const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                
                // 2. ä» localStorage è·å– github_usernameï¼ˆå¢åŠ å¼‚å¸¸å¤„ç†ï¼‰
                let localGitHubName = null;
                try {
                    localGitHubName = localStorage.getItem('github_username');
                } catch (e) {
                    console.warn('[LPDEF] âš ï¸ è¯»å– localStorage github_username å¤±è´¥:', e);
                }
                
                // 3. ã€ä¼˜åŒ–ã€‘ä¼˜å…ˆä»å·²åŠ è½½çš„ allData æ•°ç»„ä¸­æŸ¥æ‰¾åŒ¹é…é¡¹ï¼ˆé¿å…é¢å¤–çš„ API è°ƒç”¨ï¼‰
                const allData = window.allData || [];
                console.log('[LPDEF] ğŸ“Š allData æ•°æ®é‡:', allData.length);
                
                let currentUser = null;
                let matchedByFingerprint = false;
                
                // ã€ä¼˜å…ˆçº§1ã€‘é¦–å…ˆä» allData ä¸­æŸ¥æ‰¾ fingerprint åŒ¹é…çš„è®°å½•
                if (normalizedCurrentFingerprint && allData.length > 0) {
                    console.log('[LPDEF] ğŸ” å¼€å§‹ä» allData ä¸­æŸ¥æ‰¾æŒ‡çº¹åŒ¹é…...');
                    
                    currentUser = allData.find(user => {
                        const userFingerprint = normalizeFingerprint(user.fingerprint || user.user_fingerprint);
                        const userIdentity = normalizeFingerprint(user.user_identity);
                        
                        const matchFingerprint = userFingerprint && userFingerprint === normalizedCurrentFingerprint;
                        const matchIdentity = userIdentity && userIdentity === normalizedCurrentFingerprint;
                        
                        if (matchFingerprint || matchIdentity) {
                            console.log('[LPDEF] âœ… åœ¨ allData ä¸­æ‰¾åˆ°æŒ‡çº¹åŒ¹é…:', {
                                id: user.id,
                                user_name: user.user_name || user.name,
                                fingerprint: user.fingerprint ? user.fingerprint.substring(0, 8) + '...' : null
                            });
                            matchedByFingerprint = true;
                            return true;
                        }
                        return false;
                    });
                    
                    if (currentUser) {
                        console.log('[LPDEF] âœ… é€šè¿‡æœ¬åœ° allData åŒ¹é…åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                    } else {
                        console.log('[LPDEF] â„¹ï¸ åœ¨ allData ä¸­æœªæ‰¾åˆ°æŒ‡çº¹åŒ¹é…');
                    }
                }
                
                // ã€ä¼˜å…ˆçº§2ã€‘å¦‚æœ allData ä¸­æœªæ‰¾åˆ°ï¼Œä¸” Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–ï¼Œå°è¯•ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
                if (!currentUser && normalizedCurrentFingerprint && supabaseClient) {
                    try {
                        console.log('[LPDEF] ğŸ” allData ä¸­æœªæ‰¾åˆ°ï¼Œå°è¯•ä» Supabase ç›´æ¥æŸ¥è¯¢ï¼ˆä½¿ç”¨ç»Ÿä¸€è§†å›¾ï¼‰...');
                        
                        // ã€Task 2ã€‘ä½¿ç”¨ç»Ÿä¸€è§†å›¾ v_unified_analysis_v2
                        const { data: dbUser, error: queryError } = await supabaseClient
                            .from('v_unified_analysis_v2')
                            .select('*')
                            .eq('fingerprint', currentFingerprint)
                            .maybeSingle();
                        
                        if (queryError && queryError.code !== 'PGRST116') {
                            console.warn('[LPDEF] âš ï¸ Supabase æŸ¥è¯¢å¤±è´¥:', queryError);
                        } else if (dbUser) {
                            console.log('[LPDEF] âœ… ä» Supabase æŸ¥è¯¢åˆ°ç”¨æˆ·:', dbUser.user_name || dbUser.name);
                            
                            // å°†æŸ¥è¯¢åˆ°çš„ç”¨æˆ·æ·»åŠ åˆ° allData
                            const existingIndex = allData.findIndex(item => item.id === dbUser.id);
                            if (existingIndex !== -1) {
                                allData[existingIndex] = { ...allData[existingIndex], ...dbUser };
                            } else {
                                allData.push(dbUser);
                            }
                            window.allData = allData;
                            
                            currentUser = dbUser;
                            matchedByFingerprint = true;
                        } else {
                            console.log('[LPDEF] â„¹ï¸ Supabase ä¸­æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·');
                        }
                    } catch (error) {
                        console.warn('[LPDEF] âš ï¸ Supabase æŸ¥è¯¢å‡ºé”™:', error);
                    }
                }
                
                // 4. URL å‚æ•°æ”¯æŒï¼šå¦‚æœ URL ä¸­å¸¦äº† id å‚æ•°ï¼Œå¼ºåˆ¶ä½¿ç”¨è¯¥ ID è¿›è¡ŒåŒ¹é…ï¼ˆç”¨äºæµ‹è¯•ï¼‰
                const urlParams = new URLSearchParams(window.location.search);
                const urlId = urlParams.get('id');
                if (urlId) {
                    console.log('[Rank] ğŸ” æ£€æµ‹åˆ° URL å‚æ•° id:', urlId, 'ï¼Œå°†å¼ºåˆ¶ä½¿ç”¨è¯¥ ID è¿›è¡ŒåŒ¹é…');
                    const urlMatchedUser = allData.find(user => {
                        const userId = (user.id || '').toString();
                        const userFingerprint = (user.fingerprint || user.user_identity || '').toString();
                        return userId === urlId || userFingerprint === urlId;
                    });
                    if (urlMatchedUser) {
                        currentUser = urlMatchedUser;
                        console.log('[Rank] âœ… é€šè¿‡ URL å‚æ•° id æ‰¾åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                    }
                }
                
                // 5. å¦‚æœæŒ‡çº¹æœªåŒ¹é…ï¼Œå†é€€è€Œæ±‚å…¶æ¬¡å¯»æ‰¾ github_username
                if (!currentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                    const normalizedLocalGitHub = normalizeFingerprint(localGitHubName);
                    currentUser = allData.find(user => {
                        const userGithubId = normalizeFingerprint(user.github_username || user.github_id || '');
                        return userGithubId && userGithubId === normalizedLocalGitHub;
                    });
                    
                    if (currentUser) {
                        console.log('[Rank] âœ… é€šè¿‡ GitHub ID æ‰¾åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                    }
                }
                
                // 6. å…œåº•åŒ¹é… - å¦‚æœ fingerprint ä¸ºç©ºï¼Œå°è¯•é€šè¿‡ id æˆ– user_name åŒ¹é…
                if (!currentUser && !normalizedCurrentFingerprint) {
                    try {
                        const savedUserId = localStorage.getItem('user_id');
                        if (savedUserId) {
                            currentUser = allData.find(user => {
                                return user.id && user.id.toString() === savedUserId.toString();
                            });
                        }
                        
                        if (!currentUser) {
                            const savedUserName = localStorage.getItem('user_name');
                            if (savedUserName) {
                                currentUser = allData.find(user => {
                                    return user.user_name && user.user_name.toString() === savedUserName.toString();
                                });
                            }
                        }
                    } catch (e) {
                        console.warn('[Rank] âš ï¸ å…œåº•åŒ¹é…æ—¶è¯»å– localStorage å¤±è´¥:', e);
                    }
                }
                
                // ä¿å­˜åŒ¹é…æ–¹å¼åˆ°å…¨å±€å˜é‡ï¼Œä¾› renderRankCards ä½¿ç”¨
                if (currentUser) {
                    window.currentUser = currentUser;
                    window.currentUserMatchedByFingerprint = matchedByFingerprint;
                }
                
                // 4. è‡ªåŠ¨è¡¥é½é€»è¾‘ï¼šå¦‚æœåœ¨åº“é‡Œæ‰¾åˆ°äº†å½“å‰è®¾å¤‡çš„ Fingerprintï¼Œä½†è¯¥è®°å½•çš„ user_name æ˜¯ "Guest" ä¸” github_id ä¸ºç©º
                if (currentUser && currentFingerprint) {
                    const userGithubId = currentUser.github_username || currentUser.github_id || null;
                    const userName = currentUser.user_name || currentUser.name || '';
                    const isGuestUser = userName.includes('Guest') || userName === 'åŒ¿åå—å®³è€…' || !userGithubId;
                    
                    // å¦‚æœç”¨æˆ·å·²ç»åœ¨ stats2.html è®¾ç½®äº† GitHub ç”¨æˆ·åï¼Œç«‹å³å‘èµ· PATCH è¯·æ±‚ç»‘å®š
                    if (isGuestUser && localGitHubName && isValidGitHubUsername(localGitHubName) && !userGithubId) {
                        console.log('[LPDEF] ğŸ”— æ£€æµ‹åˆ° Guest ç”¨æˆ·ï¼Œå°è¯•ç»‘å®š GitHub ID:', localGitHubName);
                        
                        // å‘èµ· PATCH è¯·æ±‚ï¼Œæ›´æ–°æ•°æ®åº“è®°å½•
                        if (supabaseClient) {
                            try {
                                // ã€å…³é”®ä¿®å¤ã€‘ç™»å½•åå¿…é¡»ä½¿ç”¨ user_id è¿›è¡Œæ›´æ–°ï¼Œè€Œä¸æ˜¯ fingerprint
                                let updateField = 'id';
                                let updateValue = currentUser.id;
                                
                                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                                try {
                                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                                    if (!sessionError && session && session.user) {
                                        const authenticatedUserId = session.user.id;
                                        // å¦‚æœå·²ç™»å½•ï¼Œä¼˜å…ˆä½¿ç”¨ç™»å½•çš„ user_id
                                        if (authenticatedUserId && currentUser.id === authenticatedUserId) {
                                            updateField = 'id';
                                            updateValue = authenticatedUserId;
                                            console.log('[LPDEF] âœ… å·²ç™»å½•ï¼Œä½¿ç”¨ user_id è¿›è¡Œæ›´æ–°ï¼ˆè®¤ç¥–å½’å®—ï¼‰');
                                        }
                                    }
                                } catch (authError) {
                                    console.warn('[LPDEF] âš ï¸ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', authError);
                                }
                                
                                // å¦‚æœæœªç™»å½•æˆ– user_id ä¸åŒ¹é…ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ
                                if (!updateValue || updateField !== 'id') {
                                    updateField = currentUser.fingerprint ? 'fingerprint' : (currentUser.user_identity ? 'user_identity' : 'id');
                                    updateValue = currentUser.fingerprint || currentUser.user_identity || currentUser.id;
                                    console.log('[LPDEF] âš ï¸ æœªç™»å½•ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ:', updateField);
                                }
                                
                                if (updateField && updateValue) {
                                    // ã€ä¿®å¤ 400 é”™è¯¯ã€‘ç§»é™¤ä¸å­˜åœ¨çš„ github_username å­—æ®µï¼Œåªæ›´æ–° user_name
                                    const { data, error } = await supabaseClient
                                        .from('user_analysis')
                                        .update({
                                            user_name: localGitHubName, // æ›´æ–°ç”¨æˆ·åï¼ˆGitHub ç”¨æˆ·åå­˜å‚¨åœ¨ user_name å­—æ®µä¸­ï¼‰
                                            user_identity: updateField === 'id' ? 'github' : currentUser.user_identity, // å¦‚æœä½¿ç”¨ idï¼Œè®¾ç½®ä¸º github
                                            updated_at: new Date().toISOString()
                                        })
                                        .eq(updateField, updateValue)
                                        .select();
                                    
                                    if (error) {
                                        console.error('[LPDEF] âŒ ç»‘å®š GitHub ID å¤±è´¥:', error);
                                    } else if (data && data.length > 0) {
                                        console.log('[LPDEF] âœ… GitHub ID ç»‘å®šæˆåŠŸ:', data[0]);
                                        // æ›´æ–° currentUser å¯¹è±¡
                                        currentUser.github_username = localGitHubName;
                                        currentUser.user_name = localGitHubName;
                                        // æ›´æ–° window.allData ä¸­çš„å¯¹åº”è®°å½•
                                        const index = allData.findIndex(u => 
                                            (u.fingerprint || u.user_identity || u.id) === updateValue
                                        );
                                        if (index !== -1) {
                                            allData[index] = { ...allData[index], ...currentUser };
                                            window.allData = allData;
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error('[LPDEF] âŒ ç»‘å®š GitHub ID è¿‡ç¨‹å‡ºé”™:', error);
                            }
                        }
                    }
                }
                
                // 7. ä¿å­˜åŒ¹é…ç»“æœåˆ°å…¨å±€å˜é‡
                if (currentUser) {
                    window.currentUser = currentUser;
                    window.currentUserMatchedByFingerprint = matchedByFingerprint;
                    console.log('[Rank] âœ… ç”¨æˆ·åŒ¹é…æˆåŠŸï¼Œå·²è®¾ç½®å…¨å±€å˜é‡');
                }
                
                // 8. ç»Ÿä¸€è°ƒç”¨ renderRankCards æ¸²æŸ“ 6 ç»´åº¦æ’åå¡ç‰‡
                // èº«ä»½è¯†åˆ«å…œåº•ï¼šå¦‚æœæœ€ç»ˆ currentUser ä¾ç„¶ä¸º nullï¼Œæ˜¾å¼è°ƒç”¨ renderRankCards(null)
                // è¿™å°†è§¦å‘"å…¨çƒé€‰æ‹”"é€»è¾‘ï¼Œæ˜¾ç¤ºæ¯ä¸ªç»´åº¦çš„å…¨çƒæœ€å¼ºç”¨æˆ·
                if (currentUser) {
                    console.log('[Rank] âœ… æ‰¾åˆ°å½“å‰ç”¨æˆ·æ•°æ®ï¼Œæ¸²æŸ“æ’åå¡ç‰‡:', currentUser.user_name || currentUser.name);
                    renderRankCards(currentUser);
                    
                    // ã€ä¼˜åŒ–ã€‘å¦‚æœæ‰¾åˆ°åŒ¹é…ç”¨æˆ·ï¼Œç«‹å³æ£€æŸ¥å¹¶åŠ è½½æŠ½å±‰ï¼ˆå–æ¶ˆ WAIT çŠ¶æ€ï¼‰
                    setTimeout(() => {
                        const leftDrawer = document.getElementById('left-drawer');
                        const leftBody = document.getElementById('left-drawer-body');
                        
                        if (leftDrawer && leftBody) {
                            // æ£€æŸ¥æ˜¯å¦æœ‰ç­‰å¾…å¡ç‰‡
                            const waitingCards = leftBody.querySelectorAll('.drawer-item');
                            waitingCards.forEach(card => {
                                const label = card.querySelector('.drawer-item-label');
                                if (label && label.textContent === 'æ•°æ®åŠ è½½ä¸­') {
                                    console.log('[Rank] âœ… æ‰¾åˆ°åŒ¹é…ç”¨æˆ·ï¼Œç§»é™¤ç­‰å¾…å¡ç‰‡å¹¶åŠ è½½ç»Ÿè®¡å¡ç‰‡');
                                    card.remove();
                                    
                                    // ç«‹å³æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡
                                    renderUserStatsCards(leftBody, currentUser);
                                }
                            });
                        }
                    }, 100); // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿ DOM å·²æ›´æ–°
                } else {
                    console.log('[Rank] âš ï¸ æœªæ‰¾åˆ°å½“å‰ç”¨æˆ·æ•°æ®ï¼Œè§¦å‘å…¨çƒæœ€å¼ºæ¨¡å¼ï¼ˆå…¨çƒé€‰æ‹”ï¼‰');
                    // æ˜¾å¼è°ƒç”¨ renderRankCards(null) è§¦å‘å…¨çƒé€‰æ‹”é€»è¾‘
                    renderRankCards(null);
                }
            } catch (error) {
                console.error('[Rank] âŒ èº«ä»½æ£€æŸ¥å¤±è´¥:', error);
                // å‡ºé”™æ—¶ä¹Ÿæ˜¾å¼è°ƒç”¨ renderRankCards(null)ï¼Œè§¦å‘å…¨çƒæœ€å¼ºæ¨¡å¼ï¼ˆå…¨çƒé€‰æ‹”ï¼‰
                renderRankCards(null);
            }
            
            // åˆå§‹åŠ è½½å®Œæˆåï¼Œå¯åŠ¨ Realtime ç›‘å¬
            // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿æ‰€æœ‰æ¸²æŸ“å·²å®Œæˆ
            setTimeout(() => {
                startRealtimeListener();
            }, 500);
        };
        
        /**
         * å…¨å±€å‡½æ•°ï¼šåˆ·æ–°ç”¨æˆ·æ•°æ®ï¼ˆä¾› index.html è°ƒç”¨ï¼‰
         * å½“ index.html æäº¤èŠå¤©è®°å½•åï¼Œå¯ä»¥è°ƒç”¨æ­¤å‡½æ•°åˆ·æ–° stats2.html çš„æ•°æ®
         * ã€GitHub OAuth ä¼˜å…ˆã€‘ä¼˜å…ˆä» supabase.auth.getSession() ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ ID
         * ã€ä¿®å¤ AbortErrorã€‘æ·»åŠ é˜²é‡å¤è°ƒç”¨æœºåˆ¶ï¼Œé¿å…é¡µé¢åˆ·æ–°æ—¶å¤šæ¬¡è°ƒç”¨å¯¼è‡´å†²çª
         */
        // é˜²é‡å¤è°ƒç”¨æ ‡å¿—
        let isRefreshingUserStats = false;
        let refreshUserStatsAbortController = null;
        
        window.refreshUserStats = async function() {
            // ã€ä¿®å¤ AbortErrorã€‘å¦‚æœæ­£åœ¨åˆ·æ–°ï¼Œå–æ¶ˆä¹‹å‰çš„è¯·æ±‚
            if (isRefreshingUserStats) {
                console.log('[Refresh] âš ï¸ æ£€æµ‹åˆ°é‡å¤è°ƒç”¨ï¼Œå–æ¶ˆä¹‹å‰çš„åˆ·æ–°è¯·æ±‚...');
                if (refreshUserStatsAbortController) {
                    refreshUserStatsAbortController.abort();
                }
            }
            
            // åˆ›å»ºæ–°çš„ AbortController
            refreshUserStatsAbortController = new AbortController();
            isRefreshingUserStats = true;
            
            console.log('[Refresh] ğŸ”„ æ”¶åˆ°åˆ·æ–°è¯·æ±‚ï¼Œé‡æ–°åŠ è½½æ•°æ®...');
            try {
                // é‡æ–°è·å–æ•°æ®ï¼ˆæ·»åŠ  signal æ”¯æŒå–æ¶ˆï¼‰
                // æ³¨æ„ï¼šfetchData å¯èƒ½ä¸æ”¯æŒ signalï¼Œè¿™é‡Œå…ˆå°è¯•è°ƒç”¨
                try {
                    await fetchData();
                } catch (fetchDataError) {
                    // å¦‚æœæ˜¯å–æ¶ˆé”™è¯¯ï¼Œç›´æ¥è¿”å›
                    if (fetchDataError.name === 'AbortError' || fetchDataError.message?.includes('aborted')) {
                        console.log('[Refresh] â„¹ï¸ æ•°æ®è·å–è¢«å–æ¶ˆ');
                        return;
                    }
                    throw fetchDataError;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²è¢«å–æ¶ˆ
                if (refreshUserStatsAbortController?.signal.aborted) {
                    console.log('[Refresh] â„¹ï¸ åˆ·æ–°è¯·æ±‚å·²è¢«å–æ¶ˆ');
                    return;
                }
                
                // ã€GitHub OAuth ä¼˜å…ˆã€‘ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ç™»å½•ä¼šè¯
                let currentUser = null;
                let matchedByGitHub = false;
                
                if (supabaseClient) {
                    try {
                        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                        
                        if (!sessionError && session && session.user) {
                            const githubUserId = session.user.id;
                            console.log('[Refresh] âœ… æ£€æµ‹åˆ° GitHub OAuth ä¼šè¯ï¼Œuser_id:', githubUserId.substring(0, 8) + '...');
                            
                            // ä¼˜å…ˆä» allData ä¸­æŸ¥æ‰¾ user_id åŒ¹é…çš„è®°å½•
                            const allData = window.allData || [];
                            currentUser = allData.find(user => user.id === githubUserId);
                            
                            if (currentUser) {
                                matchedByGitHub = true;
                                console.log('[Refresh] âœ… é€šè¿‡ GitHub User ID æ‰¾åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                            } else {
                            // å¦‚æœ allData ä¸­æ²¡æœ‰ï¼Œå°è¯•ä» Supabase ç›´æ¥æŸ¥è¯¢
                            // ã€Task 2ã€‘ä½¿ç”¨ç»Ÿä¸€è§†å›¾ v_unified_analysis_v2
                            console.log('[Refresh] ğŸ” allData ä¸­æœªæ‰¾åˆ°ï¼Œå°è¯•ä» Supabase æŸ¥è¯¢ï¼ˆä½¿ç”¨ç»Ÿä¸€è§†å›¾ï¼‰...');
                            const { data: dbUser, error: queryError } = await supabaseClient
                                .from('v_unified_analysis_v2')
                                .select('*')
                                .eq('id', githubUserId)
                                .maybeSingle();
                                
                                if (!queryError && dbUser) {
                                    currentUser = dbUser;
                                    matchedByGitHub = true;
                                    
                                    // æ·»åŠ åˆ° allData
                                    const existingIndex = allData.findIndex(item => item.id === githubUserId);
                                    if (existingIndex !== -1) {
                                        allData[existingIndex] = { ...allData[existingIndex], ...dbUser };
                                    } else {
                                        allData.push(dbUser);
                                    }
                                    window.allData = allData;
                                    
                                    console.log('[Refresh] âœ… ä» Supabase æŸ¥è¯¢åˆ°ç”¨æˆ·:', dbUser.user_name || dbUser.name);
                                }
                            }
                        }
                    } catch (authError) {
                        console.warn('[Refresh] âš ï¸ æ£€æŸ¥ GitHub OAuth ä¼šè¯å¤±è´¥:', authError);
                    }
                }
                
                // ã€é™çº§æ–¹æ¡ˆã€‘å¦‚æœæ²¡æœ‰ GitHub OAuth ä¼šè¯ï¼Œä½¿ç”¨ fingerprint åŒ¹é…
                if (!currentUser) {
                    console.log('[Refresh] ğŸ”„ æœªæ‰¾åˆ° GitHub OAuth ç”¨æˆ·ï¼Œå°è¯•ä½¿ç”¨ fingerprint åŒ¹é…...');
                    
                    const normalizeFingerprint = (fp) => {
                        if (!fp) return '';
                        return String(fp).trim().toLowerCase();
                    };
                    
                    let currentFingerprint = null;
                    try {
                        currentFingerprint = localStorage.getItem('user_fingerprint');
                    } catch (e) {
                        console.warn('[Refresh] âš ï¸ è¯»å– localStorage å¤±è´¥:', e);
                    }
                    
                    const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                    const allData = window.allData || [];
                    
                    if (normalizedCurrentFingerprint && allData.length > 0) {
                        currentUser = allData.find(user => {
                            const userFingerprint = normalizeFingerprint(user.fingerprint || user.user_fingerprint);
                            const userIdentity = normalizeFingerprint(user.user_identity);
                            return (userFingerprint && userFingerprint === normalizedCurrentFingerprint) ||
                                   (userIdentity && userIdentity === normalizedCurrentFingerprint);
                        });
                        
                        if (currentUser) {
                            console.log('[Refresh] âœ… é€šè¿‡ fingerprint æ‰¾åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                        }
                    }
                }
                
                if (currentUser) {
                    window.currentUser = currentUser;
                    window.currentUserMatchedByFingerprint = !matchedByGitHub; // å¦‚æœé€šè¿‡ GitHub åŒ¹é…ï¼Œåˆ™è®¾ä¸º false
                    
                    // åˆ·æ–°æ’åå¡ç‰‡
                    renderRankCards(currentUser);
                    
                    // å¦‚æœå·¦ä¾§æŠ½å±‰å·²æ‰“å¼€ï¼Œåˆ·æ–°ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡
                    const leftDrawer = document.getElementById('left-drawer');
                    const leftBody = document.getElementById('left-drawer-body');
                    if (leftDrawer && leftBody) {
                        const isDrawerOpen = leftDrawer.classList.contains('active');
                        if (isDrawerOpen && currentDrawerCountry.code) {
                            // é‡æ–°æ˜¾ç¤ºæŠ½å±‰ä»¥åˆ·æ–°å†…å®¹
                            showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);
                        }
                    }
                    
                    // ã€åœ°å›¾è”åŠ¨ã€‘å¦‚æœ window.currentUser æœ‰äº†åæ ‡ï¼Œç«‹å³è°ƒç”¨åœ°å›¾è”åŠ¨
                    if (currentUser.lat !== null && currentUser.lat !== undefined && 
                        currentUser.lng !== null && currentUser.lng !== undefined &&
                        !isNaN(currentUser.lat) && !isNaN(currentUser.lng)) {
                        console.log('[Refresh] ğŸ—ºï¸ æ£€æµ‹åˆ°ç”¨æˆ·åæ ‡ï¼Œè§¦å‘åœ°å›¾è”åŠ¨:', {
                            lat: currentUser.lat,
                            lng: currentUser.lng
                        });
                        
                        try {
                            // æ£€æŸ¥åœ°å›¾å®ä¾‹æ˜¯å¦å­˜åœ¨
                            if (mapChart && typeof mapChart.setOption === 'function') {
                                // ECharts åœ°å›¾ä½¿ç”¨ setOption æ›´æ–° geo é…ç½®æ¥æ”¹å˜ä¸­å¿ƒç‚¹å’Œç¼©æ”¾
                                const currentOption = mapChart.getOption();
                                if (currentOption && currentOption.geo && Array.isArray(currentOption.geo) && currentOption.geo.length > 0) {
                                    // ECharts geo é…ç½®æ•°ç»„
                                    const updatedGeo = currentOption.geo.map(geo => ({
                                        ...geo,
                                        center: [currentUser.lng, currentUser.lat],
                                        zoom: 3 // è®¾ç½®åˆé€‚çš„ç¼©æ”¾çº§åˆ«
                                    }));
                                    
                                    mapChart.setOption({
                                        geo: updatedGeo
                                    }, { notMerge: false, lazyUpdate: false });
                                    console.log('[Refresh] âœ… åœ°å›¾ä¸­å¿ƒå·²æ›´æ–°åˆ°ç”¨æˆ·ä½ç½®');
                                } else {
                                    console.warn('[Refresh] âš ï¸ åœ°å›¾é…ç½®ä¸­æœªæ‰¾åˆ° geo é…ç½®');
                                }
                            } else {
                                console.warn('[Refresh] âš ï¸ åœ°å›¾å®ä¾‹ä¸å­˜åœ¨æˆ– setOption æ–¹æ³•ä¸å¯ç”¨');
                            }
                            
                            // è§¦å‘åœ°å›¾è„‰å†²æ•ˆæœï¼ˆaddPulseEffectï¼‰
                            if (typeof triggerMapPulse === 'function') {
                                const githubUsername = currentUser.user_name || currentUser.name || 'YOU';
                                const avatarUrl = currentUser.user_metadata?.avatar_url || 
                                                (githubUsername ? getGitHubAvatarUrl(githubUsername) : null) ||
                                                DEFAULT_AVATAR;
                                const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                                const pulseColor = statusConfig.status_color || '#00ff41';
                                
                                triggerMapPulse(currentUser.lng, currentUser.lat, 'YOU', pulseColor, avatarUrl, githubUsername);
                                console.log('[Refresh] âœ… åœ°å›¾è„‰å†²æ•ˆæœå·²è§¦å‘');
                            } else {
                                console.warn('[Refresh] âš ï¸ triggerMapPulse å‡½æ•°ä¸å­˜åœ¨');
                            }
                        } catch (mapError) {
                            console.warn('[Refresh] âš ï¸ åœ°å›¾è”åŠ¨å¤±è´¥:', mapError);
                        }
                    } else {
                        console.log('[Refresh] â„¹ï¸ ç”¨æˆ·åæ ‡ä¸å®Œæ•´ï¼Œè·³è¿‡åœ°å›¾è”åŠ¨');
                    }
                    
                    console.log('[Refresh] âœ… ç”¨æˆ·æ•°æ®å·²åˆ·æ–°', matchedByGitHub ? '(GitHub OAuth)' : '(Fingerprint)');
                } else {
                    console.log('[Refresh] âš ï¸ æœªæ‰¾åˆ°å½“å‰ç”¨æˆ·æ•°æ®');
                }
            } catch (error) {
                // ã€ä¿®å¤ AbortErrorã€‘ç‰¹æ®Šå¤„ç† AbortError
                if (error.name === 'AbortError' || error.message?.includes('aborted')) {
                    console.log('[Refresh] â„¹ï¸ åˆ·æ–°è¯·æ±‚è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰');
                } else {
                    console.error('[Refresh] âŒ åˆ·æ–°å¤±è´¥:', error);
                }
            } finally {
                // é‡ç½®æ ‡å¿—
                isRefreshingUserStats = false;
                refreshUserStatsAbortController = null;
            }
        };
        
        // ç›‘å¬ storage äº‹ä»¶ï¼Œå½“å…¶ä»–é¡µé¢æ›´æ–° localStorage æ—¶è‡ªåŠ¨åˆ·æ–°
        window.addEventListener('storage', (e) => {
            if (e.key === 'user_fingerprint' || e.key === 'github_username') {
                console.log('[Storage] ğŸ”” æ£€æµ‹åˆ° localStorage å˜åŒ–ï¼Œè§¦å‘æ•°æ®åˆ·æ–°');
                setTimeout(() => {
                    window.refreshUserStats();
                }, 500);
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç† Realtime ç›‘å¬
        window.addEventListener('beforeunload', () => {
            stopRealtimeListener();
        });
    </script>
</body>
</html>
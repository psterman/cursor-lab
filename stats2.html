<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Statistics Dashboard - Vibe Coding</title>
    <!-- API Endpoint -->
    <meta name="api-endpoint" content="https://cursor-clinical-analysis.psterman.workers.dev/">
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/echarts-gl/dist/echarts-gl.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/echarts/map/js/world.js" onload="this.setAttribute('data-loaded', 'true')"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --bg-color: #050505;
            --card-bg: rgba(24, 24, 27, 0.7);
            --card-border: #27272a;
            --text-main: #ffffff;
            --text-dim: #71717a;
            --accent-terminal: #00ff41;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 65, 0.02) 2px,
                    rgba(0, 255, 65, 0.02) 4px
                ),
                radial-gradient(
                    circle,
                    rgba(0, 255, 65, 0.03) 1px,
                    transparent 1px
                );
            background-size: 100% 4px, 20px 20px;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(0, 255, 65, 0.05) 50%,
                transparent 100%
            );
            animation: scanline 8s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .hacker-border {
            border: 1px solid var(--card-border);
            position: relative;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
        }

        .hacker-border::before {
            content: '';
            position: absolute;
            top: -1px; left: 0; width: 60px; height: 1px;
            background: var(--accent-terminal);
            box-shadow: 0 0 10px var(--accent-terminal);
        }

        #map-container {
            width: 100%;
            height: 600px;
        }

        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            border-color: var(--accent-terminal);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
        }

        .lang-btn {
            border: 1px solid var(--card-border);
            color: var(--text-dim);
            transition: all 0.2s;
        }

        .lang-btn.active {
            border-color: var(--accent-terminal);
            color: var(--accent-terminal);
            background: rgba(0, 255, 65, 0.05);
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse { animation: pulse-soft 2s infinite; }
        
        /* 确保内容在背景动画之上 */
        body > div {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-[1600px] mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black tracking-tighter italic flex items-center gap-2">
                    <span class="text-white">GLOBAL</span>
                    <span class="text-[var(--accent-terminal)]">DATA_STATION</span>
                </h1>
                <p id="sub-title" class="text-[10px] text-zinc-500 tracking-[0.3em] font-bold uppercase mt-1">Telemetry Uplink: Active // Source: Central_Pacific</p>
            </div>
            
            <div class="flex gap-2">
                <button onclick="switchLang('zh')" id="btn-zh" class="lang-btn active px-4 py-1 text-[10px] font-bold uppercase">ZH</button>
                <button onclick="switchLang('en')" id="btn-en" class="lang-btn px-4 py-1 text-[10px] font-bold uppercase">EN</button>
            </div>
        </div>

        <!-- Main Dashboard Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            
            <!-- Side Panel: Core Metrics -->
            <div class="xl:col-span-1 flex flex-col gap-4 order-2 xl:order-1">
                <div class="hacker-border p-6 rounded-sm stat-card">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-victims">已诊断开发者</div>
                    <div id="totalUsers" class="text-4xl font-bold text-[var(--accent-terminal)]">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">USERS_RECOGNIZED_SUCCESSFULLY</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-analysis">全网扫描次数</div>
                    <div id="totalAnalysis" class="text-4xl font-bold">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">TOTAL_SCAN_COUNT</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-roast">累计吐槽字数</div>
                    <div id="totalChars" class="text-4xl font-bold">0</div>
                    <div class="mt-4 h-1 bg-zinc-800 w-full overflow-hidden">
                        <div class="bg-[var(--accent-terminal)] h-full w-[65%]"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 stat-card">
                    <div class="hacker-border p-4 rounded-sm bg-zinc-900/50">
                        <div class="text-zinc-500 text-[10px] uppercase tracking-tighter mb-1">Avg Words / 人均平均篇幅</div>
                        <div id="avgPerUser" class="text-2xl font-bold font-mono text-[var(--accent-terminal)]">0</div>
                        <div class="text-[9px] text-zinc-600 mt-1 uppercase">Per Developer Basis</div>
                    </div>
                    
                    <div class="hacker-border p-4 rounded-sm bg-zinc-900/50">
                        <div class="text-zinc-500 text-[10px] uppercase tracking-tighter mb-1">Scan Words / 单次平均篇幅</div>
                        <div id="avgPerScan" class="text-2xl font-bold font-mono text-blue-400">0</div>
                        <div class="text-[9px] text-zinc-600 mt-1 uppercase">Per Analysis Basis</div>
                    </div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card bg-zinc-900/40">
                    <div class="text-[10px] text-zinc-500 mb-4 uppercase tracking-widest lang-key" data-key="radar-title">全网平均开发者画像</div>
                    <div class="aspect-square">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Central Map Area -->
            <div class="xl:col-span-3 order-1 xl:order-2">
                <div class="hacker-border rounded-sm overflow-hidden relative group">
                    <div id="map-container"></div>
                    
                    <!-- Top Overlay Indicators -->
                    <div class="absolute top-4 left-4 pointer-events-none">
                        <div class="flex gap-4">
                            <div class="bg-black/60 border border-zinc-800 px-3 py-2 rounded">
                                <span class="text-[9px] block text-zinc-500 lang-key" data-key="active-nodes">活跃节点</span>
                                <span class="text-xs font-bold text-emerald-400 flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full pulse"></span>
                                    242 CONNECTED
                                </span>
                            </div>
                            <div class="bg-black/60 border border-zinc-800 px-3 py-2 rounded">
                                <span class="text-[9px] block text-zinc-500 lang-key" data-key="threat-level">风险评级</span>
                                <span class="text-xs font-bold text-red-500">LEVEL_CRITICAL</span>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Horizontal Stats -->
                    <div class="absolute bottom-4 left-4 right-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="top-hotspot">最密集热区</div>
                            <div id="top-country" class="text-sm font-bold truncate">...</div>
                        </div>
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="sys-days">运行天数</div>
                            <div id="systemDays" class="text-xl font-bold">0</div>
                        </div>
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="city-coverage">城市覆盖</div>
                            <div id="cityCount" class="text-xl font-bold">0</div>
                        </div>
                        <div class="bg-black/80 backdrop-blur-md border border-zinc-800 p-4 rounded">
                            <div class="text-[9px] text-zinc-500 mb-1 uppercase lang-key" data-key="sync-rate">同步速率</div>
                            <div class="text-xl font-bold text-[var(--accent-terminal)]">99.8%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Charts & Logs -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mt-6">
            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="hot-list">地理位置热力排行</h3>
                <div id="locationList" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="personality-dist">人格分布排行</h3>
                <div id="personalityDistribution" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm flex flex-col">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="recent-activity">实时诊断活动</h3>
                <div id="recentActivity" class="flex-1 overflow-y-auto max-h-[300px] text-[10px] font-mono space-y-4 pr-2">
                    <!-- Logs here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content;
        let currentLang = 'zh';

        const i18n = {
            zh: {
                'sub-title': '实时远程监测状态 // 节点：太平洋中部',
                'total-victims': '已诊断开发者',
                'total-analysis': '全网扫描次数',
                'total-roast': '累计吐槽字数',
                'avg-chars': '人均吐槽量',
                'radar-title': '全网平均开发者画像',
                'personality-dist': '人格分布排行',
                'active-nodes': '活跃节点',
                'threat-level': '风险评级',
                'top-hotspot': '最密集热区',
                'sys-days': '运行天数',
                'city-coverage': '城市覆盖',
                'sync-rate': '同步速率',
                'hot-list': '地理位置热力排行',
                'recent-activity': '实时诊断活动',
                'victim': '受害者',
                'loading': '初始化中...',
                'rank': '排名'
            },
            en: {
                'sub-title': 'Telemetry Status // Node: Central_Pacific',
                'total-victims': 'Total Developers',
                'total-analysis': 'Total Scans',
                'total-roast': 'Total Roast Words',
                'avg-chars': 'Avg Roast Per User',
                'radar-title': 'Global Developer Persona',
                'personality-dist': 'Personality Distribution',
                'active-nodes': 'Active Nodes',
                'threat-level': 'Threat Level',
                'top-hotspot': 'Primary Hotspot',
                'sys-days': 'Days Online',
                'city-coverage': 'City Coverage',
                'sync-rate': 'Sync Rate',
                'hot-list': 'Geographic Hotspots',
                'recent-activity': 'Live Activity Feed',
                'victim': 'Victim',
                'loading': 'Initializing...',
                'rank': 'Rank'
            }
        };

        const countryNameMap = {
            'CN': { zh: '中国', en: 'China' },
            'US': { zh: '美国', en: 'USA' },
            'JP': { zh: '日本', en: 'Japan' },
            'GB': { zh: '英国', en: 'UK' },
            'DE': { zh: '德国', en: 'Germany' },
            'SG': { zh: '新加坡', en: 'Singapore' },
            'HK': { zh: '中国香港', en: 'Hong Kong' },
            'TW': { zh: '中国台湾', en: 'Taiwan' }
        };

        let mapChart, radarChart;
        // 地图渲染令牌：防止并发 init / dispose 导致 getZr 为空
        let mapRenderSeq = 0;

        /**
         * 数字格式化函数（智能处理大数字）
         * @param {number} num - 要格式化的数字
         * @returns {string} 格式化后的字符串（如 1.2M, 3.5K）
         */
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) {
                return '0';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        /**
         * 数字滚动动画函数
         * @param {HTMLElement} element - 目标元素
         * @param {number} start - 起始值
         * @param {number} end - 结束值
         * @param {number} duration - 动画持续时间（毫秒）
         * @param {boolean} useFormat - 是否使用 formatNumber 格式化（默认 true）
         */
        function animateValue(element, start, end, duration = 1500, useFormat = true) {
            if (!element) return;
            
            // 确保 start 和 end 都是数字类型
            start = Number(start) || 0;
            end = Number(end) || 0;
            
            const startTime = performance.now();
            const isInteger = Number.isInteger(start) && Number.isInteger(end);
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // 使用缓动函数（easeOutCubic）
                const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                const current = start + (end - start) * easeOutCubic;
                
                // 根据是否使用格式化来决定显示方式
                if (useFormat) {
                    // 使用 formatNumber 格式化显示（智能处理大数字）
                    element.textContent = formatNumber(Math.floor(current));
                } else {
                    // 使用原始数字显示
                    if (isInteger) {
                        element.textContent = Math.floor(current).toLocaleString();
                    } else {
                        element.textContent = current.toFixed(1).toLocaleString();
                    }
                }
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    // 确保最终值准确
                    if (useFormat) {
                        element.textContent = formatNumber(end);
                    } else {
                        if (isInteger) {
                            element.textContent = end.toLocaleString();
                        } else {
                            element.textContent = end.toFixed(1).toLocaleString();
                        }
                    }
                }
            }
            
            requestAnimationFrame(update);
        }

        function switchLang(lang) {
            currentLang = lang;
            document.getElementById('btn-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('btn-en').classList.toggle('active', lang === 'en');
            
            // 更新静态文案
            document.getElementById('sub-title').innerText = i18n[lang]['sub-title'];
            document.querySelectorAll('.lang-key').forEach(el => {
                const key = el.getAttribute('data-key');
                el.innerText = i18n[lang][key];
            });

            // 重新渲染数据依赖型组件
            if (window.lastData) {
                renderLocationList(window.lastData.locationRank);
                const activityData = window.lastData.latestRecords || window.lastData.recentVictims || [];
                renderRecentActivity(activityData);
                renderPersonalityDistribution(window.lastData.personalityDistribution);
                // 异步渲染地图，确保地图数据已加载
                initGlobalMap(window.lastData.locationRank).catch(err => {
                    console.warn('[Dashboard] 语言切换时地图渲染失败:', err);
                });
            }
        }

        /**
         * 检查地图数据是否已加载
         * world.js 加载后会在 echarts 中注册 'world' 地图
         */
        async function checkMapLoaded() {
            if (typeof echarts === 'undefined') {
                return false;
            }
            
            // 检查地图是否已注册
            // ECharts 5.x 使用 getMap 方法检查
            try {
                if (typeof echarts.getMap === 'function') {
                    const mapData = echarts.getMap('world');
                    if (mapData) {
                        console.log('[Map] ✅ 地图数据已注册');
                        return true;
                    }
                }
                
                // 降级检查：尝试注册地图（如果 world.js 已加载，地图数据会在全局变量中）
                // world.js 通常会将地图数据存储在某个全局变量中
                // 如果存在，手动注册
                if (typeof window !== 'undefined' && window.worldMapData) {
                    echarts.registerMap('world', window.worldMapData);
                    console.log('[Map] ✅ 从全局变量注册地图');
                    return true;
                }
                
                // 检查脚本标签是否已加载
                const worldScript = document.querySelector('script[src*="world.js"]');
                if (worldScript && worldScript.getAttribute('data-loaded') === 'true') {
                    console.log('[Map] ✅ world.js 脚本已标记为加载');
                    return true;
                }
                
                console.warn('[Map] ⚠️ 地图数据未找到，等待 world.js 加载...');
                return false;
            } catch (error) {
                console.warn('[Map] ⚠️ 检查地图数据时出错:', error);
                return false;
            }
        }

        /**
         * 等待地图数据加载完成
         */
        async function waitForMapData(maxWait = 10000) {
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWait) {
                if (await checkMapLoaded()) {
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.warn('[Map] ⚠️ 等待地图数据超时');
            return false;
        }

        /**
         * 检测浏览器是否支持 WebGL（用于 3D 地球渲染）
         */
        function isWebGLSupported() {
            try {
                const canvas = document.createElement('canvas');
                return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
            } catch (e) {
                return false;
            }
        }

        /**
         * 初始化 3D 地球（修复动画显示问题）
         * @param {Array} locationData - 地理位置数据 [{name: string, value: number}]
         */
        async function initGlobalMap(locationData) {
            const chartDom = document.getElementById('map-container');
            if (!chartDom) {
                console.warn('[Map] ⚠️ 找不到地图容器元素');
                return;
            }
            
            // 检查 ECharts 和 ECharts GL 是否已加载
            if (typeof echarts === 'undefined') {
                console.warn('[Map] ⚠️ ECharts 未加载，无法渲染地图');
                return;
            }
            
            // 渲染令牌（只允许最后一次调用继续执行）
            const seq = ++mapRenderSeq;

            // 等待地图数据加载完成（简化版，不强制要求）
            let mapLoaded = false;
            try {
                mapLoaded = await waitForMapData(5000);
            } catch (e) {
                console.warn('[Map] ⚠️ 地图数据检查超时，继续尝试渲染');
            }
            
            try {
                // 如果这次调用已经过期，直接退出（避免 dispose 后还继续 setOption）
                if (seq !== mapRenderSeq) return;

                // 如果 WebGL 不可用，直接走 2D（避免 echarts-gl 在某些环境下崩溃）
                if (!isWebGLSupported()) {
                    throw new Error('WebGL not supported');
                }

                // 销毁旧图表
                if (mapChart) {
                    mapChart.dispose();
                    mapChart = null;
                }
                
                // 初始化图表
                mapChart = echarts.init(chartDom);
                
                // 处理地理位置数据
                const processedData = (locationData || []).map(item => ({
                    name: (countryNameMap[item.name] ? countryNameMap[item.name].en : item.name),
                    value: item.value || 0
                }));
                
                console.log('[Map] 处理后的数据:', processedData);
                
                // 国家代码到经纬度的映射（用于 3D 散点）
                const countryCoords = {
                    'China': [104.0, 35.0],
                    'United States': [-95.0, 39.0],
                    'USA': [-95.0, 39.0],
                    'Japan': [139.0, 36.0],
                    'United Kingdom': [-2.0, 54.0],
                    'UK': [-2.0, 54.0],
                    'Germany': [10.0, 51.0],
                    'Singapore': [103.8, 1.3],
                    'Hong Kong': [114.1, 22.3],
                    'Taiwan': [121.0, 23.5],
                    'Canada': [-106.0, 56.0],
                    'Australia': [133.0, -25.0]
                };
                
                // 配置 3D 地球选项
                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: '#18181b',
                        borderColor: '#27272a',
                        textStyle: { color: '#00ff41', fontFamily: 'JetBrains Mono' },
                        formatter: (params) => {
                            if (params.seriesType === 'scatter3D' && params.data && params.data.length >= 4) {
                                const item = params.data[3];
                                const label = countryNameMap[item?.name]?.zh || item?.name || '未知';
                                return `${label}: ${params.data[2] || 0} Victims`;
                            }
                            const label = countryNameMap[params.data?.name]?.zh || params.name;
                            return `${label}: ${params.value || 0} Victims`;
                        }
                    },
                    globe: {
                        // 重要：不要设置 baseTexture/heightTexture/layers.texture 为 null
                        // echarts-gl 某些版本会因此触发 loadTexture，且在 dispose 并发时容易出现 getZr 空指针
                        globeRadius: 100,
                        globeOuterRadius: 120,
                        shading: 'lambert',
                        light: {
                            main: {
                                intensity: 1.2,
                                shadow: true
                            },
                            ambient: {
                                intensity: 0.3
                            }
                        },
                        viewControl: {
                            autoRotate: true, // 启用自动旋转
                            autoRotateDirection: 'cw',
                            autoRotateSpeed: 10,
                            distance: 200,
                            minDistance: 100,
                            maxDistance: 400,
                            alpha: 20,
                            beta: 0,
                            rotateSensitivity: 1,
                            zoomSensitivity: 1,
                            panSensitivity: 1,
                            animation: true,
                            animationDurationUpdate: 1000
                        }
                    },
                    series: [
                        // 3D 散点图（显示数据点）
                        {
                            type: 'scatter3D',
                            coordinateSystem: 'globe',
                            blendMode: 'lighter',
                            symbolSize: (val) => {
                                const value = Array.isArray(val) ? val[2] : (val.value || 0);
                                return Math.max(8, Math.min(20, value * 2));
                            },
                            itemStyle: {
                                color: '#00ff41',
                                opacity: 0.8
                            },
                            data: processedData.map(item => {
                                const coords = countryCoords[item.name] || [0, 0];
                                // 返回 [经度, 纬度, 值, 原始数据对象]
                                return [coords[0], coords[1], item.value, item];
                            }),
                            emphasis: {
                                itemStyle: {
                                    color: '#34d399',
                                    opacity: 1
                                }
                            }
                        },
                        // 3D 地图（如果地图数据可用）
                        ...(mapLoaded ? [{
                            type: 'map3D',
                            map: 'world',
                            coordinateSystem: 'globe',
                            shading: 'lambert',
                            itemStyle: {
                                color: 'rgba(39, 39, 42, 0.6)',
                                borderColor: 'rgba(0, 255, 65, 0.3)',
                                borderWidth: 0.5,
                                opacity: 0.8
                            },
                            emphasis: {
                                itemStyle: {
                                    color: 'rgba(0, 255, 65, 0.4)',
                                    borderColor: '#00ff41',
                                    borderWidth: 1
                                }
                            },
                            data: processedData.map(item => ({
                                name: item.name,
                                value: item.value
                            }))
                        }] : [])
                    ]
                };
                
                // 设置地图选项
                mapChart.setOption(option, { notMerge: true, lazyUpdate: false });
                
                // 响应式调整
                const resizeHandler = () => {
                    if (mapChart) {
                        mapChart.resize();
                    }
                };
                window.addEventListener('resize', resizeHandler);
                
                // 保存 resize handler，以便后续清理
                if (!window.mapResizeHandler) {
                    window.mapResizeHandler = resizeHandler;
                }
                
                console.log('[Map] ✅ 3D 地球渲染完成');
            } catch (error) {
                console.error('[Map] ❌ 3D 地球渲染失败，尝试降级到 2D 地图:', error);
                // 降级到 2D 地图
                try {
                    // 如果这次调用已经过期，直接退出
                    if (seq !== mapRenderSeq) return;

                    // 关键：3D setOption 可能部分成功并遗留 GL 图层，2D 降级必须重新 init（否则仍会触发 loadTexture/getZr 报错）
                    if (mapChart) {
                        try {
                            mapChart.dispose();
                        } catch (e) {
                            // ignore
                        }
                        mapChart = null;
                    }
                    mapChart = echarts.init(chartDom, null, { renderer: 'canvas' });

                    // 地图数据必须已注册，否则直接提示（避免 setOption 继续抛错）
                    if (!echarts.getMap || !echarts.getMap('world')) {
                        console.warn('[Map] ⚠️ world 地图数据未注册（world.js 未加载完成）');
                        chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">地图数据未加载完成</div>';
                        return;
                    }

                    // 确保 processedData 已定义
                    const processedData = (locationData || []).map(item => ({
                        // 2D 世界地图名称需要与 world.js 的英文国家名匹配
                        name: (countryNameMap[item.name] ? countryNameMap[item.name].en : (item.name === 'USA' ? 'United States' : item.name)),
                        value: item.value || 0
                    }));
                    
                    const fallbackOption = {
                        backgroundColor: 'transparent',
                        tooltip: {
                            trigger: 'item',
                            backgroundColor: '#18181b',
                            borderColor: '#27272a',
                            textStyle: { color: '#00ff41', fontFamily: 'JetBrains Mono' },
                            formatter: (params) => {
                                const label = countryNameMap[params.data?.name]?.zh || params.name;
                                return `${label}: ${params.value || 0} Victims`;
                            }
                        },
                        visualMap: {
                            min: 0,
                            max: Math.max(20, ...processedData.map(d => d.value || 0)),
                            show: false,
                            inRange: {
                                color: ['#064e3b', '#065f46', '#00ff41', '#34d399']
                            }
                        },
                        series: [{
                            type: 'map',
                            map: 'world',
                            roam: false,
                            zoom: 1.2,
                            top: '20%',
                            itemStyle: {
                                areaColor: 'rgba(39, 39, 42, 0.4)',
                                borderColor: 'rgba(0, 255, 65, 0.2)',
                                borderWidth: 1
                            },
                            emphasis: {
                                itemStyle: { areaColor: '#00ff41' },
                                label: { show: false }
                            },
                            data: processedData
                        }]
                    };
                    // notMerge: true 彻底替换，避免残留 3D 配置
                    mapChart.setOption(fallbackOption, { notMerge: true, lazyUpdate: false });
                    console.log('[Map] ✅ 降级到 2D 地图渲染完成');
                } catch (fallbackError) {
                    console.error('[Map] ❌ 2D 地图降级也失败:', fallbackError);
                    chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">地图渲染失败</div>';
                }
            }
        }

        function renderRadarChart(averages) {
            // 【ID 存在性检查】在执行前，必须检查 document.getElementById 是否非空
            const radarCanvas = document.getElementById('radarChart');
            if (!radarCanvas) {
                console.warn('[雷达图] ❌ DOM 元素不存在');
                return;
            }
            
            const ctx = radarCanvas.getContext('2d');
            if (!ctx) {
                console.warn('[雷达图] ❌ 无法获取 Canvas 上下文');
                return;
            }
            
            if (radarChart) radarChart.destroy();

            const labels = currentLang === 'zh' ? ['语言', '模式', '深度', '效率', '频率'] : ['Lang', 'Pattern', 'Depth', 'Effi', 'Freq'];
            // 【环境对齐】确保所有的 Number() 转换逻辑在赋值前完成
            const data = [
                Number(averages.L || 50),
                Number(averages.P || 50),
                Number(averages.D || 50),
                Number(averages.E || 50),
                Number(averages.F || 50)
            ];

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        borderWidth: 1,
                        pointRadius: 2
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: '#27272a' },
                            grid: { color: '#27272a' },
                            pointLabels: { color: '#71717a', font: { size: 9 } },
                            ticks: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderLocationList(data) {
            const list = document.getElementById('locationList');
            if (!data || data.length === 0) return;
            
            list.innerHTML = data.slice(0, 5).map((item, i) => {
                const name = countryNameMap[item.name] ? countryNameMap[item.name][currentLang] : item.name;
                return `
                <div class="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2">
                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                    <span class="font-bold uppercase tracking-tighter">${name}</span>
                    <span class="text-[var(--accent-terminal)] font-bold">${item.value}</span>
                </div>`;
            }).join('');

            const top = data[0];
            document.getElementById('top-country').innerText = countryNameMap[top.name] ? countryNameMap[top.name][currentLang] : top.name;
        }

        function renderRecentActivity(victims) {
            const box = document.getElementById('recentActivity');
            if (!box) return;
            
            // 优先使用 latestRecords，如果没有则使用 recentVictims
            const records = victims || [];
            
            if (records.length === 0) {
                box.innerHTML = '<div class="text-zinc-500 text-center py-4">暂无数据</div>';
                return;
            }
            
            box.innerHTML = records.map((v, index) => {
                // 兼容两种数据格式：latestRecords 和 recentVictims
                const time = v.time || v.created_at || new Date().toISOString();
                const type = v.type || v.personality_type || 'UNKNOWN';
                const location = v.location || v.ip_location || '未知';
                const name = v.name || `记录${index + 1}`;
                
                return `
                <div class="border-l-2 border-zinc-800 pl-3 py-1">
                    <div class="text-zinc-500">${new Date(time).toLocaleTimeString()}</div>
                    <div class="text-white">${name.length > 6 ? name.slice(0,6) + '...' : name}</div>
                    <div class="text-[var(--accent-terminal)]">${type} @ ${location}</div>
                </div>
            `;
            }).join('');
        }

        /**
         * 渲染人格分布排行
         * @param {Array} distribution - 人格分布数据 [{type: string, count: number}]
         */
        function renderPersonalityDistribution(distribution) {
            const list = document.getElementById('personalityDistribution');
            if (!list) return;
            
            if (!distribution || !Array.isArray(distribution) || distribution.length === 0) {
                list.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">暂无数据</div>';
                return;
            }
            
            list.innerHTML = distribution.map((item, i) => {
                const type = item.type || 'UNKNOWN';
                const count = Number(item.count) || 0;
                return `
                <div class="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2">
                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                    <span class="font-bold uppercase tracking-tighter">${type}</span>
                    <span class="text-[var(--accent-terminal)] font-bold">${count}</span>
                </div>`;
            }).join('');
        }

        /**
         * 【适配层重写】强制映射层：从多个可能的字段路径提取数据
         * @param {Object} result - API 返回的原始数据
         * @returns {Object} 标准化后的数据对象
         */
        function normalizeData(result) {
            const data = result || {};
            
            // 【强制映射层】totalAnalysis：依次尝试 result.totalAnalysis, result.data.totalAnalysis, 若都缺失则取 result.recentVictims.length
            let totalAnalysis = data.totalAnalysis;
            if (totalAnalysis === undefined || totalAnalysis === null) {
                totalAnalysis = data.data?.totalAnalysis;
            }
            if (totalAnalysis === undefined || totalAnalysis === null) {
                const recentVictims = data.recentVictims || data.latestRecords || [];
                totalAnalysis = recentVictims.length;
            }
            
            // 【强制映射层】totalRoastWords：依次尝试 result.totalRoastWords, result.totalChars, result.data.total_roast_words
            let totalRoastWords = data.totalRoastWords;
            if (totalRoastWords === undefined || totalRoastWords === null) {
                totalRoastWords = data.totalChars;
            }
            if (totalRoastWords === undefined || totalRoastWords === null) {
                totalRoastWords = data.data?.total_roast_words;
            }
            
            // 【强制映射层】avgPerUser 和 avgPerScan：依次尝试 result.avgPerUser/avgPerScan, result.data.avgPerUser/avgPerScan
            let avgPerUser = data.avgPerUser;
            if (avgPerUser === undefined || avgPerUser === null) {
                avgPerUser = data.data?.avgPerUser;
            }
            // 兼容旧字段名
            if (avgPerUser === undefined || avgPerUser === null) {
                avgPerUser = data.avgChars;
            }
            
            let avgPerScan = data.avgPerScan;
            if (avgPerScan === undefined || avgPerScan === null) {
                avgPerScan = data.data?.avgPerScan;
            }
            
            return {
                totalUsers: data.totalUsers || 0,
                totalAnalysis: totalAnalysis || 0,
                totalRoastWords: totalRoastWords || 0,
                avgPerUser: avgPerUser || 0,
                avgPerScan: avgPerScan || 0,
                cityCount: data.cityCount || 0,
                systemDays: data.systemDays || 1,
                personalityRank: data.personalityRank || data.personalityDistribution || [],
                personalityDistribution: data.personalityDistribution || data.personalityRank || [],
                globalAverage: data.globalAverage || data.averages || { L: 50, P: 50, D: 50, E: 50, F: 50 },
                averages: data.averages || data.globalAverage || { L: 50, P: 50, D: 50, E: 50, F: 50 },
                locationRank: data.locationRank || [],
                recentVictims: data.recentVictims || data.latestRecords || [],
                latestRecords: data.latestRecords || data.recentVictims || [],
            };
        }

        /**
         * 【动画容错】安全的动画函数，防止 NaN 或 undefined 导致崩溃
         * @param {HTMLElement} element - 目标元素
         * @param {number} start - 起始值
         * @param {number} end - 结束值
         * @param {number} duration - 动画持续时间
         * @param {boolean} useFormat - 是否使用格式化
         */
        function safeAnimateValue(element, start, end, duration = 1500, useFormat = true) {
            if (!element) {
                console.warn('[动画] ❌ DOM 元素不存在');
                return;
            }
            
            // 【动画容错】在调用 animateValue 之前，添加 if (isNaN(value)) value = 0; 的判断
            if (isNaN(start)) start = 0;
            if (isNaN(end)) end = 0;
            
            start = Number(start) || 0;
            end = Number(end) || 0;
            
            animateValue(element, start, end, duration, useFormat);
        }

        /**
         * 【人格排行渲染函数】独立的 renderPersonalityRank 函数，包含前端自计算降级逻辑
         * @param {Array} rankData - 人格排行数据 [{type, count, percentage}]
         * @param {Array} recentVictims - 最近受害者数据（用于降级计算）
         */
        function renderPersonalityRank(rankData, recentVictims = []) {
            const personalityEl = document.getElementById('personalityDistribution');
            if (!personalityEl) {
                console.warn('[人格排行] ❌ DOM 元素不存在');
                return;
            }
            
            // 如果后端 personalityRank 存在且不为空，直接渲染
            if (rankData && Array.isArray(rankData) && rankData.length > 0) {
                personalityEl.innerHTML = rankData.map((item, i) => {
                    const type = item.type || '未知';
                    const count = Number(item.count || 0);
                    const percentage = Number(item.percentage || 0);
                    return `
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                <span class="text-zinc-400">${i+1}. ${type}</span>
                                <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                            </div>
                            <div class="w-full bg-zinc-800/50 h-1">
                                <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                console.log(`[人格排行] ✅ 渲染成功 (${rankData.length} 条)`);
                return;
            }
            
            // 【前端自计算降级逻辑】若后端 personalityRank 为空，则根据 recentVictims 实时计算占比并渲染进度条
            if (recentVictims && recentVictims.length > 0) {
                console.log('[人格排行] ⚠️ personalityRank 为空，使用 recentVictims 降级方案');
                const typeMap = new Map();
                recentVictims.forEach((v) => {
                    const type = v.type || v.personality_type || 'UNKNOWN';
                    typeMap.set(type, (typeMap.get(type) || 0) + 1);
                });
                
                const total = recentVictims.length;
                const personalityRank = Array.from(typeMap.entries())
                    .map(([type, count]) => ({
                        type: type,
                        count: Number(count) || 0,
                        percentage: Math.round((Number(count) / total) * 100) || 0,
                    }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                personalityEl.innerHTML = personalityRank.map((item, i) => {
                    const type = item.type || '未知';
                    const count = Number(item.count || 0);
                    const percentage = Number(item.percentage || 0);
                    return `
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                <span class="text-zinc-400">${i+1}. ${type}</span>
                                <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                            </div>
                            <div class="w-full bg-zinc-800/50 h-1">
                                <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                console.log(`[人格排行] ✅ 降级方案渲染成功 (${personalityRank.length} 条)`);
                return;
            }
            
            // 如果都没有数据，显示空状态
            personalityEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">暂无数据</div>';
            console.warn('[人格排行] ❌ 无可用数据');
        }

        /**
         * 获取并渲染大盘数据
         * 基于 index.ts 的接口返回格式（数据直接返回，不包裹在 data 字段中）
         */
        async function fetchData() {
            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content;
            console.group('%c 🚀 Dashboard Data Sync Starting ', 'background: #222; color: #bada55; font-size: 12px;');
            
            try {
                console.log(`[1/5] 正在请求: ${apiEndpoint}api/global-average`);
                const response = await fetch(`${apiEndpoint}api/global-average`);
                
                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
                
                const result = await response.json();
                console.log('[2/5] 收到原始响应:', result);

                // 【适配层重写】使用强制映射层标准化数据
                const data = normalizeData(result);
                console.log('[3/5] 数据适配完成:', data);

                // 保存到全局变量，供语言切换时使用
                window.lastData = data;

                // --- 渲染数字卡片 ---
                // 【ID 存在性检查】在执行 animateValue 前，必须检查 document.getElementById 是否非空
                // 【动画容错】防止 NaN 或 undefined 导致崩溃
                
                // 1. 已诊断开发者
                const totalUsers = Number(data.totalUsers) || 0;
                const totalUsersEl = document.getElementById('totalUsers');
                console.log(`[卡片: 已诊断开发者] 数据: ${totalUsers} | DOM: ${totalUsersEl ? '✅' : '❌'}`);
                safeAnimateValue(totalUsersEl, 0, totalUsers, 1500, true);

                // 2. 扫描次数 (totalAnalysis)
                const totalAnalysis = Number(data.totalAnalysis) || 0;
                const totalAnalysisEl = document.getElementById('totalAnalysis');
                console.log(`[卡片: 扫描次数] 数据: ${totalAnalysis} | DOM: ${totalAnalysisEl ? '✅' : '❌'}`);
                safeAnimateValue(totalAnalysisEl, 0, totalAnalysis, 1500, true);

                // 3. 累计字数 (totalRoastWords)
                const totalRoastWords = Number(data.totalRoastWords) || 0;
                const totalCharsEl = document.getElementById('totalChars');
                console.log(`[卡片: 累计字数] 数据: ${totalRoastWords} | DOM: ${totalCharsEl ? '✅' : '❌'}`);
                if (totalCharsEl) {
                    // 单位转换：如果超过 100 万，显示为"万"单位
                    const val = totalRoastWords;
                    if (val >= 1000000) {
                        totalCharsEl.innerText = (val / 10000).toFixed(1) + ' 万';
                    } else {
                        safeAnimateValue(totalCharsEl, 0, val, 1500, true);
                    }
                }

                // 4. 人均平均篇幅 (avgPerUser)
                const avgPerUser = Number(data.avgPerUser || 0);
                const avgPerUserEl = document.getElementById('avgPerUser');
                console.log(`[卡片: 人均平均篇幅] 数据: ${avgPerUser} | DOM: ${avgPerUserEl ? '✅' : '❌'}`);
                safeAnimateValue(avgPerUserEl, 0, avgPerUser, 1000, false);

                // 5. 单次平均篇幅 (avgPerScan)
                const avgPerScan = Number(data.avgPerScan || 0);
                const avgPerScanEl = document.getElementById('avgPerScan');
                console.log(`[卡片: 单次平均篇幅] 数据: ${avgPerScan} | DOM: ${avgPerScanEl ? '✅' : '❌'}`);
                safeAnimateValue(avgPerScanEl, 0, avgPerScan, 1000, false);

                // 6. 运行天数
                const systemDays = Number(data.systemDays) || 1;
                const systemDaysEl = document.getElementById('systemDays');
                console.log(`[卡片: 运行天数] 数据: ${systemDays} | DOM: ${systemDaysEl ? '✅' : '❌'}`);
                safeAnimateValue(systemDaysEl, 0, systemDays, 1000, false);

                // 7. 覆盖城市
                const cityCount = Number(data.cityCount) || 0;
                const cityCountEl = document.getElementById('cityCount');
                console.log(`[卡片: 覆盖城市] 数据: ${cityCount} | DOM: ${cityCountEl ? '✅' : '❌'}`);
                safeAnimateValue(cityCountEl, 0, cityCount, 1000, false);

                // --- 渲染人格分布排行 ---
                // 【人格排行渲染函数】使用独立的 renderPersonalityRank 函数
                renderPersonalityRank(data.personalityRank, data.recentVictims);

                // --- 渲染图表组件 ---
                // 渲染地理位置热力排行和地图
                if (data.locationRank && Array.isArray(data.locationRank) && data.locationRank.length > 0) {
                    if (typeof echarts !== 'undefined') {
                        await initGlobalMap(data.locationRank);
                    }
                    renderLocationList(data.locationRank);
                } else {
                    const locationListEl = document.getElementById('locationList');
                    if (locationListEl) {
                        locationListEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">暂无数据</div>';
                    }
                }
                
                // 渲染雷达图（优先使用 globalAverage，否则使用 averages）
                // 【环境对齐】确保所有的 Number() 转换逻辑在赋值前完成
                const radarData = data.globalAverage || data.averages || { L: 50, P: 50, D: 50, E: 50, F: 50 };
                if (typeof radarData === 'object' && typeof Chart !== 'undefined') {
                    // 确保所有值都是数字类型
                    const normalizedRadarData = {
                        L: Number(radarData.L || 50),
                        P: Number(radarData.P || 50),
                        D: Number(radarData.D || 50),
                        E: Number(radarData.E || 50),
                        F: Number(radarData.F || 50),
                    };
                    console.log(`[雷达图] 数据: L=${normalizedRadarData.L}, P=${normalizedRadarData.P}, D=${normalizedRadarData.D}, E=${normalizedRadarData.E}, F=${normalizedRadarData.F}`);
                    renderRadarChart(normalizedRadarData);
                } else {
                    console.warn('[雷达图] ❌ 数据格式错误或 Chart.js 未加载');
                }
                
                // 渲染实时诊断活动（优先使用 latestRecords）
                const activityData = data.latestRecords && data.latestRecords.length > 0 
                    ? data.latestRecords 
                    : (data.recentVictims || []);
                renderRecentActivity(activityData);

                console.log('%c [5/5] ✅ 渲染逻辑同步完毕 ', 'color: #00ff41');

            } catch (err) {
                console.error('[ERROR] Dashboard 渲染崩溃:', err);
                
                // 显示错误提示
                const container = document.querySelector('.max-w-\\[1600px\\]');
                if (container) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed top-4 right-4 bg-red-900/80 text-white px-4 py-2 rounded border border-red-500 z-50';
                    errorDiv.textContent = `错误: ${err.message || '数据加载失败'}`;
                    container.appendChild(errorDiv);
                    
                    setTimeout(() => {
                        errorDiv.remove();
                    }, 5000);
                }
            } finally {
                console.groupEnd();
            }
        }


        window.onload = fetchData;
    </script>
</body>
</html>
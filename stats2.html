<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSPï¼šåœ°ç†ç”±åç«¯ CF æ¥ç®¡ï¼Œæ— éœ€ ipapi.co/ip-api.com -->
     <script data-cfasync="false" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://unpkg.com https://html2canvas.hertzen.com https://cdn.tailwindcss.com; connect-src 'self' https://cdn.jsdelivr.net https://unpkg.com https://cursor-clinical-analysis.psterman.workers.dev https://*.workers.dev https://psterman.supabase.co https://dtcplfhcgnxdzpigmotb.supabase.co wss://dtcplfhcgnxdzpigmotb.supabase.co https://raw.githubusercontent.com https://api.github.com https://www.google.com wss://*.supabase.co; img-src 'self' data: blob: https:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com; font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com https://r2cdn.perplexity.ai;">
    <title>Global Statistics Dashboard - Vibe Coding</title>
    <!-- 
    ============================================
    API ç«¯ç‚¹é…ç½®ï¼ˆV2EX/æŠ€æœ¯ç”¨æˆ·ä¼˜åŒ–ç‰ˆï¼‰
    ============================================
    
    ã€ç›®æ ‡ç”¨æˆ·ã€‘V2EX ç”¨æˆ·ã€ä¸“ä¸šç¨‹åºå‘˜
    ã€ç”¨æˆ·ç”»åƒã€‘70% æœ‰ç§‘å­¦ä¸Šç½‘èƒ½åŠ›ï¼Œ30% å…¬å¸/å­¦æ ¡ç½‘ç»œå—é™
    
    ã€ä¼˜åŒ–ç­–ç•¥ã€‘
    1. æ£€æµ‹ä»£ç†å¯ç”¨æ€§ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä½³è·¯å¾„
    2. æœ‰ä»£ç†ç”¨æˆ· â†’ ç›´æ¥è®¿é—® Cloudflareï¼ˆæœ€ä½³ä½“éªŒï¼‰
    3. æ— ä»£ç†ç”¨æˆ· â†’ å¿«é€Ÿå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜
    4. æä¾›æ˜ç¡®çš„ç½‘ç»œè¯Šæ–­ä¿¡æ¯
    -->
    
    <!-- ä¸»ç«¯ç‚¹ï¼šCloudflare Workersï¼ˆæœ‰ä»£ç†ç”¨æˆ·æœ€ä¼˜ï¼‰ -->
    <meta name="api-endpoint" content="https://cursor-clinical-analysis.psterman.workers.dev/">
    
    <!-- å¤‡ç”¨ç«¯ç‚¹ï¼ˆå¯é€‰ï¼šVercel/å›½å†…å‡½æ•°ï¼‰ -->
    <meta name="api-endpoint-backup" content="">
    
    <!-- æŠ€æœ¯ç”¨æˆ·ä¼˜åŒ–ï¼šå¿«é€Ÿæ£€æµ‹ä»£ç†ï¼Œ1ç§’è¶…æ—¶ -->
    <meta name="api-fast-fail" content="true">
    <meta name="proxy-detect-timeout" content="1500">
    
    <script>
    /**
     * ã€Auth æ‹¦æˆªå™¨ã€‘GitHub OAuth å›è°ƒåä» Hash æ•è· access_tokenï¼ŒæŒä¹…åŒ–å¹¶æ¸…ç† URL
     * Supabase è¿”å›çš„æ˜¯ # å·åçš„ Hashï¼Œä¸ç”¨ URLSearchParams(search)ã€‚
     */
    (function () {
      var hash = typeof window !== 'undefined' && window.location && window.location.hash;
      if (!hash || hash.length < 2) return;
      var params = {};
      hash.slice(1).split('&').forEach(function (pair) {
        var i = pair.indexOf('=');
        if (i !== -1) params[decodeURIComponent(pair.slice(0, i))] = decodeURIComponent((pair.slice(i + 1) || '').replace(/\+/g, ' '));
      });
      var accessToken = params.access_token || params['access_token'];
      var refreshToken = params.refresh_token || params['refresh_token'];
      if (!accessToken) return;
      try {
        localStorage.setItem('vibe_github_access_token', accessToken);
        if (refreshToken) localStorage.setItem('vibe_github_refresh_token', refreshToken);
        console.log('[Auth] âœ… å·²ä» Hash æ•è· access_token å¹¶å†™å…¥ vibe_github_access_token');
      } catch (e) {
        console.warn('[Auth] å†™å…¥ token å¤±è´¥:', e);
      }
      try {
        var parts = accessToken.split('.');
        if (parts.length >= 2) {
          var payload = parts[1].replace(/-/g, '+').replace(/_/g, '/');
          var padded = payload + Array((4 - payload.length % 4) % 4 + 1).join('=');
          var json = atob(padded);
          var data = JSON.parse(json);
          var meta = data.user_metadata || {};
          var avatar = meta.avatar_url || meta.avatar || '';
          var name = meta.user_name || meta.full_name || meta.name || data.email || '';
          if (avatar || name) {
            var cache = { avatar: avatar, name: name, at: Date.now() };
            try { localStorage.setItem('vibe_github_user_cache', JSON.stringify(cache)); } catch (_) {}
            if (typeof window !== 'undefined') {
              window.__vibeGitHubUser = cache;
            }
          }
        }
      } catch (_) {}
      try {
        if (typeof window !== 'undefined' && window.history && window.history.replaceState) {
          var url = window.location.pathname + (window.location.search || '');
          window.history.replaceState(null, '', url);
          console.log('[Auth] âœ… å·²æ¸…ç†åœ°å€æ  Hash');
        }
      } catch (_) {}
    })();
    </script>
    <script>
    /**
     * å…¨å±€é”™è¯¯å¤„ç†ï¼šå±è”½ eval5 ç­‰ç¬¬ä¸‰æ–¹æ’ä»¶äº§ç”Ÿçš„æŠ¥é”™ï¼Œé¿å…æ±¡æŸ“æ§åˆ¶å°
     */
    (function () {
        var _onerror = window.onerror;
        window.onerror = function (msg, url, line, col, err) {
            var str = (msg || '') + (url || '') + (err && err.stack ? err.stack : '');
            if (/eval5|third.?party|extension|plugin/i.test(str)) return true;
            if (typeof _onerror === 'function') return _onerror.apply(this, arguments);
            return false;
        };
        window.addEventListener('error', function (ev) {
            var str = (ev.message || '') + (ev.filename || '') + (ev.error && ev.error.stack ? ev.error.stack : '');
            if (/eval5|third.?party|extension|plugin/i.test(str)) { ev.preventDefault(); ev.stopPropagation(); }
        }, true);
    })();
    </script>
    <script>
    /**
     * ä»£ç†æ£€æµ‹å™¨ï¼šæ£€æµ‹ç”¨æˆ·æ˜¯å¦æœ‰ç§‘å­¦ä¸Šç½‘èƒ½åŠ›
     * é’ˆå¯¹ V2EX/æŠ€æœ¯ç”¨æˆ·ç¾¤ä½“ä¼˜åŒ–
     */
    window.PROXY_DETECTOR = {
        // å¯ç”¨äºæ£€æµ‹çš„ "å¹²å‡€" åŸŸåï¼ˆå›½å†…èƒ½è®¿é—®ä½†å›½å¤–æ›´å¿«ï¼‰
        testUrls: [
            'https://www.google.com/generate_204',  // Google 204 é¡µé¢ï¼Œå›½å†…è¢«å¢™
            'https://github.com/favicon.ico',        // GitHubï¼Œå›½å†…æ…¢/ä¸ç¨³å®š
            'https://raw.githubusercontent.com/github/fetch/master/favicon.ico'
        ],
        
        // æ£€æµ‹æ˜¯å¦æœ‰ä»£ç†ï¼ˆéœ€ CSP connect-src å…è®¸ https://www.google.comï¼‰
        async detect(timeout = 1500) {
            console.log('[ProxyDetect] ğŸ” æ£€æµ‹ç½‘ç»œç¯å¢ƒ...');
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeout);
            try {
                const start = performance.now();
                await fetch('https://www.google.com/generate_204', {
                    mode: 'no-cors',
                    signal: controller.signal
                });
                clearTimeout(timer);
                const latency = Math.round(performance.now() - start);
                console.log(`[ProxyDetect] âœ… æ£€æµ‹åˆ°ä»£ç† (${latency}ms)`);
                return { hasProxy: true, latency };
            } catch (err) {
                clearTimeout(timer);
                console.log('[ProxyDetect] âŒ æ— ä»£ç†æˆ–ä»£ç†æœªç”Ÿæ•ˆ');
                return { hasProxy: false, latency: null };
            }
        },
        
        // æ ¹æ®ä»£ç†çŠ¶æ€è¿”å›æœ€ä½³ API ç«¯ç‚¹
        async getOptimalEndpoint() {
            const { hasProxy } = await this.detect();
            
            // æœ‰ä»£ç† â†’ ç›´æ¥ä½¿ç”¨ Cloudflareï¼ˆæœ€ä½³ä½“éªŒï¼‰
            if (hasProxy) {
                return {
                    url: document.querySelector('meta[name="api-endpoint"]')?.content || '',
                    timeout: 10000,  // æ­£å¸¸è¶…æ—¶
                    useCache: false  // ä¸ç¼“å­˜ï¼Œè·å–æœ€æ–°æ•°æ®
                };
            }
            
            // æ— ä»£ç† â†’ å¿«é€Ÿå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆä¸åŠ è½½æ¼”ç¤ºæ•°æ®ï¼‰
            return {
                url: null,
                timeout: 2000,   // 2ç§’å¿«é€Ÿå¤±è´¥
                useCache: true,  // ä½¿ç”¨æœ¬åœ°ç¼“å­˜
                fallback: false  // ä¸ä½¿ç”¨æ¼”ç¤ºæ•°æ®
            };
        }
    };
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
    window._proxyCheck = window.PROXY_DETECTOR.detect();
    </script>
    <script>
    /**
     * API ç«¯ç‚¹ç®¡ç†å™¨ï¼šè‡ªåŠ¨æ£€æµ‹å¯ç”¨ç«¯ç‚¹å¹¶åˆ‡æ¢
     */
    window.API_ENDPOINT_MANAGER = {
        endpoints: [],
        currentIndex: 0,
        healthStatus: new Map(),
        
        // åˆå§‹åŒ–ç«¯ç‚¹åˆ—è¡¨
        init() {
            const primary = document.querySelector('meta[name="api-endpoint"]')?.content;
            const backup = document.querySelector('meta[name="api-endpoint-backup"]')?.content;
            
            this.endpoints = [];
            if (primary) this.endpoints.push(primary);
            if (backup) {
                backup.split(',').forEach(url => {
                    url = url.trim();
                    if (url && !this.endpoints.includes(url)) this.endpoints.push(url);
                });
            }
            
            // é»˜è®¤ç«¯ç‚¹ï¼ˆå¦‚æœéƒ½æ²¡æœ‰é…ç½®ï¼‰
            if (this.endpoints.length === 0) {
                this.endpoints.push('https://cursor-clinical-analysis.psterman.workers.dev/');
            }
            
            console.log('[API] å¯ç”¨ç«¯ç‚¹:', this.endpoints);
            return this.getCurrent();
        },
        
        // è·å–å½“å‰ç«¯ç‚¹
        getCurrent() {
            if (this.endpoints.length === 0) this.init();
            return this.endpoints[this.currentIndex] || this.endpoints[0];
        },
        
        // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªç«¯ç‚¹
        switchNext() {
            this.currentIndex = (this.currentIndex + 1) % this.endpoints.length;
            console.log(`[API] åˆ‡æ¢åˆ°ç«¯ç‚¹ ${this.currentIndex + 1}/${this.endpoints.length}: ${this.getCurrent()}`);
            return this.getCurrent();
        },
        
        // æ ‡è®°ç«¯ç‚¹å¥åº·çŠ¶æ€
        markHealthy(url, healthy) {
            this.healthStatus.set(url, { healthy, time: Date.now() });
        },
        
        // è·å–å¥åº·çš„ç«¯ç‚¹ï¼ˆä¼˜å…ˆï¼‰
        getHealthy() {
            for (let i = 0; i < this.endpoints.length; i++) {
                const idx = (this.currentIndex + i) % this.endpoints.length;
                const url = this.endpoints[idx];
                const status = this.healthStatus.get(url);
                // å¦‚æœç«¯ç‚¹5åˆ†é’Ÿå†…æ ‡è®°ä¸ºä¸å¥åº·ï¼Œè·³è¿‡
                if (status && !status.healthy && (Date.now() - status.time < 300000)) {
                    continue;
                }
                this.currentIndex = idx;
                return url;
            }
            // æ‰€æœ‰ç«¯ç‚¹éƒ½ä¸å¥åº·ï¼Œè¿”å›å½“å‰ç«¯ç‚¹
            return this.getCurrent();
        }
    };
    
    // åˆå§‹åŒ–
    window.API_ENDPOINT_MANAGER.init();
    
    // å…¨å±€è¾…åŠ©å‡½æ•°ï¼šè·å–å½“å‰ API ç«¯ç‚¹
    window.getApiEndpoint = function() {
        return window.API_ENDPOINT_MANAGER ? window.API_ENDPOINT_MANAGER.getCurrent() : 
            (document.querySelector('meta[name="api-endpoint"]')?.content || '');
    };
    
    /**
     * å…¨å±€ API è¯·æ±‚åŒ…è£…å™¨ï¼šç»Ÿä¸€å¤„ç†è¶…æ—¶ã€é‡è¯•ã€ç«¯ç‚¹åˆ‡æ¢
     * @param {string} path - API è·¯å¾„ï¼ˆå¦‚ /api/country-summaryï¼‰
     * @param {Object} options - fetch é€‰é¡¹
     * @returns {Promise<Response>}
     */
    window.apiFetch = async function(path, options = {}) {
        const manager = window.API_ENDPOINT_MANAGER;
        const maxRetries = manager ? Math.min(manager.endpoints.length, 2) : 1;
        let lastError;
        
        // å¿«é€Ÿå¤±è´¥æ¨¡å¼ï¼ˆå›½å†…ç½‘ç»œä¼˜åŒ–ï¼‰
        const fastFail = document.querySelector('meta[name="api-fast-fail"]')?.content === 'true';
        const defaultTimeout = fastFail ? 3000 : 10000; // 3ç§’å¿«é€Ÿå¤±è´¥
        
        for (let i = 0; i < maxRetries; i++) {
            let base = window.getApiEndpoint();
            // è§„èŒƒåŒ– URL æ‹¼æ¥
            if (base && !base.endsWith('/')) base += '/';
            if (path.startsWith('/')) path = path.slice(1);
            const url = (base || '/') + path;
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), options.timeout || defaultTimeout);
            
            try {
                const res = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        ...(options.headers || {})
                    }
                });
                clearTimeout(timeoutId);
                
                if (res.ok) {
                    if (window.API_ENDPOINT_MANAGER) window.API_ENDPOINT_MANAGER.markHealthy(base, true);
                    return res;
                }
                
                // 5xx é”™è¯¯è§†ä¸ºæœåŠ¡ç«¯æ•…éšœï¼Œå°è¯•åˆ‡æ¢
                if (res.status >= 500 && window.API_ENDPOINT_MANAGER) {
                    console.warn(`[API] ç«¯ç‚¹ ${base} è¿”å› ${res.status}ï¼Œå°è¯•åˆ‡æ¢...`);
                    window.API_ENDPOINT_MANAGER.markHealthy(base, false);
                    window.API_ENDPOINT_MANAGER.switchNext();
                    continue; // è§¦å‘ä¸‹ä¸€æ¬¡å¾ªç¯é‡è¯•
                }
                
                return res; // 4xx é”™è¯¯ç›´æ¥è¿”å›
            } catch (err) {
                clearTimeout(timeoutId);
                console.warn(`[API] è¯·æ±‚å¤±è´¥ (${base}):`, err.name === 'AbortError' ? 'è¶…æ—¶' : err.message);
                
                if (window.API_ENDPOINT_MANAGER) {
                    window.API_ENDPOINT_MANAGER.markHealthy(base, false);
                    if (i < maxRetries - 1) {
                         window.API_ENDPOINT_MANAGER.switchNext();
                         await new Promise(r => setTimeout(r, 500)); // é¿è®©
                         continue;
                    }
                }
                lastError = err;
            }
        }
        
        throw lastError || new Error('API request failed');
    };

    /** ç¼“å­˜ç­–ç•¥ï¼šè‹¥æœ¬åœ°å­˜åœ¨ manual_location åˆ™ä¸ŠæŠ¥ï¼Œå¦åˆ™ç”±åç«¯ CF è‡ªåŠ¨è¯†åˆ« */
    window.reportManualLocationIfCached = async function() {
        try {
            var ml = (typeof localStorage !== 'undefined' && localStorage.getItem('manual_location')) || '';
            ml = (ml && String(ml).trim()).toUpperCase();
            if (!ml || !/^[A-Z]{2}$/.test(ml)) return;
            var fp = (typeof localStorage !== 'undefined' && (localStorage.getItem('user_fingerprint') || window.fpId)) || '';
            var base = (window.getApiEndpoint && window.getApiEndpoint()) || (document.querySelector('meta[name="api-endpoint"]')?.content || '');
            if (base && base.endsWith('/')) base = base.slice(0, -1);
            var url = (base || '') + '/api/v2/analyze?fingerprint=' + encodeURIComponent(fp) + '&_t=' + Date.now();
            await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chatData: [{ role: 'USER', text: '.' }], manual_location: ml, fingerprint: fp || null })
            });
        } catch (e) { /* ignore */ }
    };
    </script>
    <!-- 
    ===========================================
    ç¦»çº¿ä¼˜å…ˆèµ„æºåŠ è½½ç­–ç•¥ï¼ˆæœ¬åœ° > å›½å†…CDN > å›½é™…CDNï¼‰
    ===========================================
    -->
    <script>
    (function() {
        'use strict';
        const RESOURCE_CONFIG = {
            echarts: {
                local: './lib/echarts.min.js',
                cdn: [
                    'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js',
                    'https://cdn.staticfile.net/echarts/5.4.3/echarts.min.js',
                    'https://unpkg.com/echarts@5.4.3/dist/echarts.min.js'
                ],
                globalCheck: 'echarts'
            },
            echartsWordCloud: {
                local: './lib/echarts-wordcloud.min.js',
                cdn: ['https://cdn.jsdelivr.net/npm/echarts-wordcloud@2/dist/echarts-wordcloud.min.js'],
                globalCheck: 'echarts'
            },
            world: {
                local: './lib/world.js',
                cdn: [
                    'https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/world.js',
                    'https://unpkg.com/echarts@4.9.0/map/js/world.js'
                ],
                globalCheck: null
            },
            chartjs: {
                local: './lib/chart.umd.min.js',
                cdn: [
                    'https://cdn.jsdelivr.net/npm/chart.js',
                    'https://cdn.staticfile.net/Chart.js/4.4.1/chart.umd.min.js'
                ],
                globalCheck: 'Chart'
            },
            tailwind: {
                local: null,
                cdn: ['https://cdn.tailwindcss.com?minify=true'],
                globalCheck: null
            }
        };

        function loadScript(url, timeout = 8000) {
            return new Promise((resolve, reject) => {
                if (!url) { reject(new Error('Empty URL')); return; }
                const script = document.createElement('script');
                script.src = url;
                script.async = false;
                let isDone = false;
                const cleanup = () => { isDone = true; };
                script.onload = () => { cleanup(); console.log('[ğŸ“¦] åŠ è½½æˆåŠŸ:', url); resolve(url); };
                script.onerror = () => { cleanup(); reject(new Error('Load failed: ' + url)); };
                setTimeout(() => { if (!isDone) reject(new Error('Timeout: ' + url)); }, timeout);
                document.head.appendChild(script);
            });
        }

        async function loadResource(name, config) {
            const errors = [];
            // ä¼˜å…ˆæœ¬åœ°
            if (config.local) {
                try { await loadScript(config.local, 5000); console.log(`[âœ…] ${name}: æœ¬åœ°èµ„æº`); return { source: 'local' }; }
                catch (err) { errors.push('æœ¬åœ°: ' + err.message); }
            }
            // CDNå›é€€
            for (const url of config.cdn) {
                try {
                    await loadScript(url, 10000);
                    if (config.globalCheck && typeof window[config.globalCheck] === 'undefined') {
                        throw new Error('Global not found: ' + config.globalCheck);
                    }
                    console.log(`[âœ…] ${name}: CDN`); return { source: 'cdn' };
                } catch (err) { errors.push(err.message); }
            }
            throw new Error(`${name} åŠ è½½å¤±è´¥: ` + errors.join('; '));
        }

        window._resourceLoader = async function() {
            console.group('[ğŸš€] åŠ è½½èµ„æº (ç¦»çº¿ä¼˜å…ˆ)');
            try {
                // ECharts æ ¸å¿ƒåº“(å¿…é¡»)
                try {
                    await loadResource('echarts', RESOURCE_CONFIG.echarts);
                    // ä¸­æ–‡ locale,æ¶ˆé™¤ "Locale zh not found" è­¦å‘Š(åœ¨ä»»æ„ echarts.init ä¹‹å‰æ‰§è¡Œ)
                    // æ³¨æ„ï¼šè¿™é‡Œçš„æ³¨å†Œé€»è¾‘ç°åœ¨å°±åœ¨ echarts åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œ
                    if (typeof echarts !== 'undefined' && echarts.registerLocale) {
                        const zhLocale = {
                            time: {
                                month: ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'],
                                monthAbbr: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                                dayOfWeek: ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'],
                                dayOfWeekAbbr: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']
                            },
                            legend: { selector: { all: 'å…¨é€‰', inverse: 'åé€‰' } },
                            toolbox: {
                                brush: { title: { rect: 'çŸ©å½¢é€‰æ‹©', polygon: 'åœˆé€‰', lineX: 'æ¨ªå‘é€‰æ‹©', lineY: 'çºµå‘é€‰æ‹©', keep: 'ä¿æŒé€‰æ‹©', clear: 'æ¸…é™¤é€‰æ‹©' } },
                                dataView: { title: 'æ•°æ®è§†å›¾', lang: ['æ•°æ®è§†å›¾', 'å…³é—­', 'åˆ·æ–°'] },
                                dataZoom: { title: { zoom: 'åŒºåŸŸç¼©æ”¾', back: 'åŒºåŸŸç¼©æ”¾è¿˜åŸ' } },
                                magicType: { title: { line: 'åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾', bar: 'åˆ‡æ¢ä¸ºæŸ±çŠ¶å›¾', stack: 'åˆ‡æ¢ä¸ºå †å ', tiled: 'åˆ‡æ¢ä¸ºå¹³é“º' } },
                                restore: { title: 'è¿˜åŸ' },
                                saveAsImage: { title: 'ä¿å­˜ä¸ºå›¾ç‰‡', lang: ['å³é”®å¦å­˜ä¸ºå›¾ç‰‡'] }
                            },
                            series: {
                                typeNames: {
                                    pie: 'é¥¼å›¾', bar: 'æŸ±çŠ¶å›¾', line: 'æŠ˜çº¿å›¾', scatter: 'æ•£ç‚¹å›¾', effectScatter: 'æ¶Ÿæ¼ªæ•£ç‚¹å›¾', radar: 'é›·è¾¾å›¾',
                                    tree: 'æ ‘å›¾', treemap: 'çŸ©å½¢æ ‘å›¾', boxplot: 'ç®±å‹å›¾', candlestick: 'Kçº¿å›¾', k: 'Kçº¿å›¾', heatmap: 'çƒ­åŠ›å›¾',
                                    map: 'åœ°å›¾', parallel: 'å¹³è¡Œåæ ‡å›¾', lines: 'çº¿å›¾', graph: 'å…³ç³»å›¾', sankey: 'æ¡‘åŸºå›¾', funnel: 'æ¼æ–—å›¾',
                                    gauge: 'ä»ªè¡¨ç›˜å›¾', pictorialBar: 'è±¡å½¢æŸ±å›¾', themeRiver: 'ä¸»é¢˜æ²³æµå›¾', sunburst: 'æ—­æ—¥å›¾'
                                }
                            },
                            aria: {
                                general: { withTitle: 'è¿™æ˜¯ä¸€ä¸ªå…³äº"{title}"çš„å›¾è¡¨ã€‚', withoutTitle: 'è¿™æ˜¯ä¸€ä¸ªå›¾è¡¨,' },
                                series: {
                                    single: { prefix: '', withName: 'å›¾è¡¨ç±»å‹æ˜¯{seriesType},è¡¨ç¤º{seriesName}ã€‚', withoutName: 'å›¾è¡¨ç±»å‹æ˜¯{seriesType}ã€‚' },
                                    multiple: {
                                        prefix: 'å®ƒç”±{seriesCount}ä¸ªå›¾è¡¨ç³»åˆ—ç»„æˆã€‚',
                                        withName: 'ç¬¬{seriesId}ä¸ªç³»åˆ—æ˜¯ä¸€ä¸ªè¡¨ç¤º{seriesName}çš„{seriesType},',
                                        withoutName: 'ç¬¬{seriesId}ä¸ªç³»åˆ—æ˜¯ä¸€ä¸ª{seriesType},',
                                        separator: { middle: ';', end: 'ã€‚' }
                                    }
                                },
                                data: {
                                    allData: 'å…¶æ•°æ®æ˜¯â€”â€”', partialData: 'å…¶ä¸­,å‰{displayCnt}é¡¹æ˜¯â€”â€”',
                                    withName: '{name}çš„æ•°æ®æ˜¯{value}', withoutName: '{value}',
                                    separator: { middle: ',', end: '' }
                                }
                            }
                        };
                        const zhVariants = ['zh', 'zh-CN', 'zh-cn', 'zh_CN', 'ZH', 'zh_cn'];
                        zhVariants.forEach(name => {
                            try { echarts.registerLocale(name, zhLocale); } catch (e) {}
                        });
                        console.log(`[ECharts] âœ… ä¸­æ–‡è¯­è¨€åŒ…å·²åŒæ­¥æ³¨å†Œ: ${zhVariants.join(', ')}`);
                        
                        // å¢åŠ æ‹¦æˆªæ£€æµ‹ï¼šå¦‚æœæœ‰äººåœ¨æ³¨å†Œåè°ƒç”¨ initï¼Œæˆ‘ä»¬å¯ä»¥è®°å½•ä¸‹æ¥
                        const nativeInit = echarts.init;
                        echarts.init = function(dom, theme, opts) {
                            console.log('[ECharts] init è°ƒç”¨:', { dom, theme, opts });
                            return nativeInit.apply(this, arguments);
                        };
                    }
                } catch (err) {
                    console.error('[âŒ] echarts åŠ è½½å¤±è´¥:', err);
                    throw err; // æ ¸å¿ƒåº“å¤±è´¥æ‰æŠ›å‡º
                }
                
                // åŠ è½½è¯äº‘æ‰©å±•
                try {
                    await loadResource('echartsWordCloud', RESOURCE_CONFIG.echartsWordCloud);
                } catch (err) {
                    console.warn('[âš ï¸] echarts-wordcloud åŠ è½½å¤±è´¥(è¯äº‘å°†æ— æ³•æ˜¾ç¤º):', err);
                }
                
                loadResource('world', RESOURCE_CONFIG.world).catch(err => {
                    console.warn('[âš ï¸] world.js åŠ è½½å¤±è´¥:', err.message);
                });
                
                loadResource('chartjs', RESOURCE_CONFIG.chartjs).catch(err => {
                    console.warn('[âš ï¸] chart.js åŠ è½½å¤±è´¥:', err.message);
                });
                
                // Tailwind CDNï¼ˆå¤±è´¥ä¸å½±å“ï¼‰. ç”Ÿäº§ç¯å¢ƒå»ºè®®æ”¹ç”¨ PostCSS/CLI æ„å»ºä»¥æ¶ˆé™¤ CDN è­¦å‘Šï¼šhttps://tailwindcss.com/docs/installation
                (function() {
                    var origWarn = console.warn;
                    var skipTailwindMsg = function(msg) {
                        if (typeof msg === 'string' && msg.indexOf('should not be used in production') !== -1 && msg.indexOf('tailwindcss.com') !== -1) return;
                        origWarn.apply(console, arguments);
                    };
                    loadScript(RESOURCE_CONFIG.tailwind.cdn[0], 5000).then(function() {
                        console.warn = origWarn;
                    }).catch(function() {
                        console.warn = origWarn;
                        console.warn('[âš ï¸] Tailwind CDNå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ ·å¼');
                    });
                    console.warn = skipTailwindMsg;
                })();
                
                window._resourcesLoaded = true;
                console.log('[âœ…] æ ¸å¿ƒèµ„æºåŠ è½½å®Œæˆ');
            } catch (err) {
                window._resourcesLoaded = false;
                window._resourceError = err.message;
                console.error('[âŒ] èµ„æºåŠ è½½å¤±è´¥:', err);
            } finally { console.groupEnd(); }
        };
    })();
    // å¯åŠ¨èµ„æºåŠ è½½ä½†ä¸é˜»å¡é¡µé¢
    window._resourceLoader().catch(err => {
        console.error('[âŒ] èµ„æºåŠ è½½å™¨å¼‚å¸¸:', err);
        window._resourcesLoaded = false;
    });
    </script>
    
    <!-- Tailwind ç¦»çº¿å›é€€æ ·å¼ -->
    <style id="tailwind-fallback">
        *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid}
        html{line-height:1.5;-webkit-text-size-adjust:100%}
        body{margin:0;line-height:inherit;font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
        .flex{display:flex}.grid{display:grid}.hidden{display:none}.block{display:block}
        #user-modal.hidden{display:none!important}
        .h-full{height:100%}.w-full{width:100%}.max-w-\[1600px\]{max-width:1600px}
        .flex-1{flex:1 1 0%}.flex-col{flex-direction:column}
        .items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}
        .gap-2{gap:.5rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}
        .rounded{border-radius:.25rem}.rounded-sm{border-radius:.125rem}
        .border{border-width:1px}.border-b{border-bottom-width:1px}
        .bg-zinc-800{background-color:rgb(39 39 42)}.bg-zinc-900{background-color:rgb(24 24 27)}
        .p-4{padding:1rem}.p-6{padding:1.5rem}.px-4{padding-left:1rem;padding-right:1rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}
        .text-white{color:rgb(255 255 255)}.text-zinc-400{color:rgb(161 161 170)}.text-zinc-500{color:rgb(113 113 122)}
        .text-xs{font-size:.75rem}.text-sm{font-size:.875rem}.text-3xl{font-size:1.875rem}
        .font-bold{font-weight:700}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
        .uppercase{text-transform:uppercase}.tracking-widest{letter-spacing:.1em}
        .text-center{text-align:center}
        .overflow-hidden{overflow:hidden}
        .fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}
        .inset-0{top:0;right:0;bottom:0;left:0}.z-50{z-index:50}
    </style>
    
    <!-- å»¶è¿ŸåŠ è½½éå…³é”®èµ„æº -->
    <script src="https://unpkg.com/lucide@latest" async></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" async></script>
    <style>
        /* ç¦»çº¿å¯ç”¨çš„å­—ä½“æ ˆï¼ˆå›½å†…ç”¨æˆ·æ— éœ€ç¿»å¢™ï¼‰ */
        @font-face {
            font-family: 'JetBrains Mono Fallback';
            src: local('Consolas'), local('Monaco'), local('Courier New'), local('SF Mono'), local('Menlo'), monospace;
            font-display: swap;
        }
        :root { --font-mono-stack: 'JetBrains Mono', 'JetBrains Mono Fallback', 'Consolas', 'Monaco', 'Courier New', 'SF Mono', 'Menlo', monospace; }
        /* Google Fonts ä½œä¸ºå¯é€‰å¢å¼ºï¼ˆå¸¦å›½å†…é•œåƒï¼‰ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@600;700&display=swap');
        @import url('https://fonts.loli.net/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        /* Dashboard theme (Pencil ref: hrdkm + B6GZW) */
        :root {
            --bg-color: #080808;
            --bg-card: #0A0A0A;
            --border-ui: #2f2f2f;
            --divider: #2f2f2f;
            --card-bg: #0A0A0A;
            --card-border: #2f2f2f;
            --text-main: #FFFFFF;
            --text-dim: #6a6a6a;
            --text-muted: #6a6a6a;
            --accent-terminal: #00FF88;
            --accent-on: #0C0C0C;
            --radius-card: 0;
            --radius-tab: 0;
            --radius-pill: 0;
        }
        /* hrdkm+B6GZW: ç®€æ´ç§‘æŠ€é£æ ¼ - label/æ•°å­—/çº¿æ¡† */
        .dashboard-section-label { font-family: var(--font-mono-stack); font-size: 9px; font-weight: 600; color: var(--text-dim); letter-spacing: 0.5px; text-transform: uppercase; }
        .dashboard-section-title { font-family: 'Space Grotesk', system-ui, sans-serif; font-size: 18px; font-weight: 600; color: var(--text-main); }
        .dashboard-metric-value { font-family: 'Space Grotesk', system-ui, sans-serif; font-size: 32px; font-weight: 700; color: var(--text-main); letter-spacing: -1px; }
        .dashboard-metric-label { font-family: var(--font-mono-stack); font-size: 9px; font-weight: 600; color: var(--text-dim); letter-spacing: 0.5px; text-transform: uppercase; }
        .dashboard-card { background: var(--bg-card); border: 1px solid var(--border-ui); padding: 20px; }

        /* æ•°æ®åˆ·æ–°æç¤ºï¼šçŸ­æš‚â€œå‘¼å¸é—ªçƒâ€ */
        @keyframes breathe-flash {
            0% {
                transform: translateZ(0) scale(1);
                box-shadow: 0 0 0 rgba(0, 255, 136, 0);
                background-color: rgba(0, 255, 136, 0.02);
            }
            50% {
                transform: translateZ(0) scale(1.01);
                box-shadow: 0 0 18px rgba(0, 255, 136, 0.35);
                background-color: rgba(0, 255, 136, 0.06);
            }
            100% {
                transform: translateZ(0) scale(1);
                box-shadow: 0 0 0 rgba(0, 255, 136, 0);
                background-color: rgba(0, 255, 136, 0.02);
            }
        }
        .breathe-flash {
            animation: breathe-flash 0.9s ease-in-out 1;
        }

        /* è¯­ä¹‰çˆ†å‘ Tag åŠ¨ç”»ï¼šfade-in-up */
        @keyframes fade-in-up {
            0% { opacity: 0; transform: translateY(8px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .semantic-burst-tag {
            animation-name: fade-in-up;
            animation-duration: 520ms;
            animation-timing-function: ease-out;
            animation-fill-mode: both;
            will-change: transform, opacity;
        }

        /* WordCloud loader (pulse) */
        @keyframes wc-pulse {
            0%, 100% { opacity: 0.35; transform: scale(0.98); }
            50% { opacity: 1; transform: scale(1); }
        }
        .vibe-cloud-loader {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 220px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.02);
        }
        .vibe-cloud-loader .dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: rgba(168, 85, 247, 0.85);
            animation: wc-pulse 900ms ease-in-out infinite;
            margin: 0 6px;
        }
        .vibe-cloud-loader .dot:nth-child(2) { animation-delay: 120ms; opacity: 0.7; }
        .vibe-cloud-loader .dot:nth-child(3) { animation-delay: 240ms; opacity: 0.55; }
        .vibe-cloud-loader .label {
            margin-left: 12px;
            font-size: 12px;
            color: rgba(148, 163, 184, 0.9);
            letter-spacing: 0.12em;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }

        /* è¯­ä¹‰çˆ†å‘å¡ç‰‡åˆ·æ–°åŠ¨æ•ˆï¼ˆæ·¡å…¥/é—ªçƒï¼‰ */
        @keyframes vibe-refresh {
            0% { opacity: 0.55; filter: saturate(0.9) brightness(0.92); }
            50% { opacity: 1; filter: saturate(1.05) brightness(1.05); }
            100% { opacity: 0.85; filter: saturate(1) brightness(1); }
        }
        .vibe-refreshing {
            animation: vibe-refresh 650ms ease-in-out 1;
        }

        /* Personal sentence chips (pulse outline) */
        .sentence-chip {
            position: relative;
            padding: 6px 8px;
            border-radius: 999px;
            border: 1px solid rgba(0, 255, 65, 0.35);
            background: rgba(0, 0, 0, 0.35);
            color: rgba(229, 231, 235, 0.92);
            font-size: 11px;
            line-height: 1.1;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sentence-chip.pulse {
            animation: sentencePulse 1.8s ease-in-out infinite;
            border-color: rgba(0, 255, 65, 0.55);
            box-shadow: 0 0 0 1px rgba(0, 255, 65, 0.08), 0 0 18px rgba(0, 255, 65, 0.08);
        }
        @keyframes sentencePulse {
            0%, 100% {
                box-shadow: 0 0 0 1px rgba(0, 255, 65, 0.08), 0 0 12px rgba(0, 255, 65, 0.08);
                filter: saturate(1);
            }
            50% {
                box-shadow: 0 0 0 1px rgba(0, 255, 65, 0.14), 0 0 22px rgba(0, 255, 65, 0.16);
                filter: saturate(1.15);
            }
        }

        body {
            font-family: 'Inter', 'JetBrains Mono', system-ui, sans-serif;
            background: linear-gradient(180deg, rgba(26,26,28,0) 0%, var(--bg-color) 30%);
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 65, 0.015) 2px,
                    rgba(0, 255, 65, 0.015) 4px
                );
            background-size: 100% 4px, 20px 20px;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background: linear-gradient(180deg, transparent 0%, rgba(0, 255, 65, 0.03) 50%, transparent 100%);
            animation: scanline 12s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        .hacker-border {
            border: 1px solid var(--border-ui);
            border-radius: var(--radius-card);
            position: relative;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
        }

        .hacker-border::before {
            content: '';
            position: absolute;
            top: -1px; left: 0; width: 60px; height: 1px;
            background: var(--accent-terminal);
            box-shadow: 0 0 8px var(--accent-terminal);
            border-radius: var(--radius-card) 0 0 0;
        }

        #map-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: auto;
            background: transparent;
        }

        /* åœ°å›¾å…‰æ ‡å·¥å…·ï¼ˆæ ¡å‡†/æ‹–æ‹½æç¤ºï¼‰ */
        #map-cursor-tools {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            pointer-events: auto;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        #map-cursor-tools .tool-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border: 1px solid rgba(0, 255, 65, 0.45);
            background: rgba(0, 0, 0, 0.55);
            color: #00ff41;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            backdrop-filter: blur(8px);
            margin: 0;
        }
        #map-cursor-tools .tool-btn:hover {
            background: rgba(0, 255, 65, 0.08);
        }
        #map-cursor-tools .hint {
            margin-top: 8px;
            max-width: 320px;
            padding: 10px 10px;
            border: 1px solid rgba(0, 255, 65, 0.45);
            background: rgba(0, 0, 0, 0.55);
            color: #00ff41;
            font-size: 11px;
            line-height: 1.35;
            backdrop-filter: blur(8px);
            display: none;
        }
        #map-cursor-tools .hint b { color: #ffffff; }
        
        /* é”šå®šæ¨¡å¼æŒ‰é’®æ¿€æ´»çŠ¶æ€ */
        #btn-anchor-location.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: #3b82f6;
        }
        
        /* å›½å®¶é€‰æ‹©å™¨æ ·å¼ */
        #country-selector-modal .country-item {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.1);
            cursor: pointer;
            color: #00ff41;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            transition: background 0.2s;
        }
        #country-selector-modal .country-item:hover {
            background: rgba(0, 255, 65, 0.1);
        }
        #country-selector-modal .country-item.selected {
            background: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
        }

        /* ç¡®ä¿ä¸»å®¹å™¨å…è®¸ç©¿é€ï¼Œä½†äº¤äº’å…ƒç´ å¯ç‚¹å‡» */
        .max-w-\[1600px\] {
            pointer-events: none;
        }

        /* æ‰€æœ‰å¯äº¤äº’å…ƒç´ æ¢å¤ pointer-events */
        .max-w-\[1600px\] button,
        .max-w-\[1600px\] input,
        .max-w-\[1600px\] select,
        .max-w-\[1600px\] textarea,
        .max-w-\[1600px\] a,
        .max-w-\[1600px\] [onclick],
        .max-w-\[1600px\] .stat-card,
        .max-w-\[1600px\] .hacker-border,
        .max-w-\[1600px\] canvas,
        .max-w-\[1600px\] #rank-cards-container,
        .max-w-\[1600px\] #rank-cards-container > *,
        .max-w-\[1600px\] .lang-flag-btn,
        .max-w-\[1600px\] img[onerror] {
            pointer-events: auto;
        }

        /* =========================
           é¡¶éƒ¨å›ºå®š Header æ ·å¼
           ========================= */
        :root {
            /* JS ä¼šåœ¨è¿è¡Œæ—¶æŒ‰å®é™… header é«˜åº¦è¦†å†™ï¼Œé¿å…æŠ½å±‰é®æŒ¡æ ‡é¢˜æ  */
            --top-header-height: 60px;
        }

        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 90;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-ui);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: none;
            pointer-events: auto;
        }

        .top-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .top-header-title {
            display: flex;
            flex-direction: column;
        }

        .top-header-title h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.02em;
            font-family: 'Space Grotesk', system-ui, sans-serif;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .top-header-title p {
            margin: 4px 0 0 0;
            font-size: 9px;
            color: var(--text-dim);
            letter-spacing: 0.12em;
            font-weight: 500;
            text-transform: uppercase;
            font-family: var(--font-mono-stack);
        }

        .top-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .top-header-cards {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .top-header {
                padding: 8px 12px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .top-header-left {
                width: 100%;
            }

            .top-header-right {
                width: 100%;
                justify-content: space-between;
            }

            .top-header-title h1 {
                font-size: 18px;
            }

            .top-header-title p {
                font-size: 8px;
            }

            .top-header-card {
                padding: 6px 10px;
            }

            .top-header-card-label {
                font-size: 8px;
            }

            .top-header-card-value {
                font-size: 10px;
            }

            body.p-4 {
                padding-top: 140px !important;
            }
        }

        /* hrdkm: æ§åˆ¶æ¡/å¡ç‰‡ - fill #0A0A0A, stroke #2f2f2f, JetBrains Mono 9px 600 */
        .top-header-card {
            background: var(--bg-card);
            border: 1px solid var(--border-ui);
            padding: 8px 12px;
            backdrop-filter: blur(10px);
        }

        .top-header-card-label {
            font-family: var(--font-mono-stack);
            font-size: 9px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .top-header-card-value {
            font-family: 'Space Grotesk', system-ui, sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ä¸º body æ·»åŠ é¡¶éƒ¨ paddingï¼Œé¿å…å†…å®¹è¢« header é®æŒ¡ */
        body.p-4 {
            padding-top: calc(var(--top-header-height, 60px) + 40px) !important;
        }
        
        @media (min-width: 768px) {
            body.md\:p-8 {
                padding-top: calc(var(--top-header-height, 60px) + 40px) !important;
            }
        }

        /* =========================
           èµ›åšæœ‹å…‹æŠ½å±‰æ ·å¼
           ========================= */
        .cyber-drawer {
            position: fixed;
            top: var(--top-header-height, 60px); /* åœ¨é¡¶éƒ¨ header ä¸‹æ–¹ï¼Œä¸é®ç›– header */
            width: 400px;
            height: calc(100vh - var(--top-header-height, 60px)); /* å‡å» header é«˜åº¦ */
            z-index: 100; /* é«˜äºé¡¶éƒ¨ header (z-index: 50) */
            pointer-events: none;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .left-drawer {
            overflow-y: auto;
            left: 0;
            transform: translateX(-100%);
        }

        .right-drawer {
            right: 0;
            transform: translateX(100%);
        }

        @media (max-width: 768px) {
            .cyber-drawer {
                top: var(--top-header-height, 60px); /* ç§»åŠ¨ç«¯åŠ¨æ€é«˜åº¦ */
                height: calc(100vh - var(--top-header-height, 60px));
            }
        }

        .left-drawer.active {
            transform: translateX(0);
            pointer-events: auto;
        }

        .right-drawer.active {
            transform: translateX(0);
            pointer-events: auto;
        }

        .drawer-content {
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-ui);
            border-left: 1px solid var(--border-ui);
            box-shadow: none;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .right-drawer .drawer-content {
            border-right: none;
            border-left: 1px solid var(--border-ui);
        }

        .left-drawer .drawer-content {
            border-left: none;
            border-right: 1px solid var(--border-ui);
        }

        /* å·¦å³æŠ½å±‰ä¸æ˜¾ç¤ºå…‰æ‰«/æ‰«æçº¿æ•ˆæœï¼ˆå·²æŒ‰éœ€æ±‚å…³é—­ï¼‰ */
        .drawer-content::before {
            display: none;
        }

        /* æŠ½å±‰å¤´éƒ¨ï¼ˆDashboard é£æ ¼ï¼‰ */
        .drawer-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-ui);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-color);
            position: relative;
            z-index: 2;
        }

        .drawer-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .drawer-icon {
            font-size: 20px;
            filter: drop-shadow(0 0 4px var(--accent-terminal));
        }

        .drawer-title-text {
            font-size: 16px;
            font-weight: 600;
            font-family: 'Inter', var(--font-mono-stack);
            color: var(--accent-terminal);
            letter-spacing: 0.5px;
        }

        .drawer-close-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-ui);
            border-radius: 50%;
            color: var(--accent-terminal);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
            font-weight: 600;
            background: transparent;
        }

        .drawer-close-btn:hover {
            background: rgba(0, 255, 65, 0.12);
            border-color: var(--accent-terminal);
        }

        /* æŠ½å±‰å†…å®¹åŒºåŸŸ */
        .drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            position: relative;
            z-index: 1;
        }

        /* =========================
           Tab å¯¼èˆªæ æ ·å¼ï¼ˆDashboard hrdkm æ§åˆ¶æ¡é£æ ¼ï¼‰
           ========================= */
        .drawer-tabs {
            display: flex;
            flex-direction: row;
            gap: 8px;
            padding: 12px 20px;
            margin: 0;
            border-bottom: 1px solid var(--border-ui);
            background: var(--bg-card);
        }

        .drawer-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-ui);
            color: var(--text-dim);
            font-family: var(--font-mono-stack);
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            gap: 4px;
        }

        .drawer-tab:hover {
            color: var(--text-main);
            background: rgba(0, 255, 136, 0.06);
        }

        .drawer-tab.active {
            color: var(--accent-terminal);
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--accent-terminal);
        }

        .drawer-tab .tab-icon {
            font-size: 14px;
            line-height: 1;
        }

        .drawer-tab .tab-text {
            font-size: 9px;
            letter-spacing: 0.5px;
        }

        /* =========================
           æ’è¡Œæ¦œå¡ç‰‡æ ·å¼ï¼ˆIndustrial ç»¿ï¼‰
           ========================= */
        .ranking-card {
            border: 1px solid var(--border-ui);
            background: var(--bg-card);
            border-radius: var(--radius-card);
            overflow: hidden;
        }

        .ranking-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(0, 255, 136, 0.06);
            border-bottom: 1px solid var(--divider);
        }

        .ranking-icon {
            font-size: 18px;
        }

        .ranking-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-terminal);
            font-family: var(--font-mono-stack);
        }

        .ranking-subtitle {
            font-size: 10px;
            color: var(--text-dim);
            margin-left: auto;
            letter-spacing: 0.04em;
        }

        .ranking-list {
            padding: 8px;
            min-height: 120px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--divider);
            transition: background 0.2s;
        }

        .ranking-item:hover {
            background: rgba(0, 255, 136, 0.06);
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-rank {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.5);
            font-family: 'JetBrains Mono', monospace;
        }

        .ranking-rank.top-1 { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .ranking-rank.top-2 { color: #c0c0c0; text-shadow: 0 0 10px rgba(192, 192, 192, 0.5); }
        .ranking-rank.top-3 { color: #cd7f32; text-shadow: 0 0 10px rgba(205, 127, 50, 0.5); }

        .ranking-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid rgba(0, 255, 65, 0.3);
            object-fit: cover;
        }

        .ranking-info {
            flex: 1;
            min-width: 0;
        }

        .ranking-name {
            font-size: 12px;
            color: var(--text-main);
            font-family: var(--font-mono-stack);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-score {
            font-size: 12px;
            color: var(--accent-terminal);
            font-family: var(--font-mono-stack);
            font-weight: 600;
        }

        .ranking-empty {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
        }

        /* é¢æ¿æ˜¾ç¤ºæ§åˆ¶ */
        .right-drawer-panel {
            display: flex;
        }

        .right-drawer-panel.hidden {
            display: none !important;
        }

        /* =========================
           Drawer micro-skeleton (country switch)
           ========================= */
        .cyber-drawer.drawer-loading .drawer-body::after {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            background:
                linear-gradient(90deg,
                    rgba(0,0,0,0) 0%,
                    rgba(0,255,65,0.06) 35%,
                    rgba(0,255,65,0.12) 50%,
                    rgba(0,255,65,0.06) 65%,
                    rgba(0,0,0,0) 100%);
            transform: translateX(-60%);
            animation: drawer-shimmer 0.9s ease-in-out infinite;
            z-index: 3;
        }

        @keyframes drawer-shimmer {
            0% { transform: translateX(-60%); opacity: 0.2; }
            40% { opacity: 0.55; }
            100% { transform: translateX(60%); opacity: 0.2; }
        }

        .drawer-body::-webkit-scrollbar {
            width: 6px;
        }

        .drawer-body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        .drawer-body::-webkit-scrollbar-thumb {
            background: var(--border-ui);
            border-radius: 3px;
        }

        .drawer-body::-webkit-scrollbar-thumb:hover {
            background: var(--accent-terminal);
        }

        /* æŠ½å±‰å†…å®¹é¡¹æ ·å¼ */
        /* å³ä¾§æŠ½å±‰é¢æ¿å®¹å™¨æ ·å¼ */
        .right-drawer-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            padding: 0;
        }

        .right-drawer-panel #panel-global-content,
        .right-drawer-panel #panel-ranking-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 0 16px 16px;
            flex: 1;
            min-height: 0;
        }

        /* å·¥ä¸šç»¿ä¸»é¢˜å¤©æ¢¯æ¦œæ ·å¼ */
        .green-table {
            border: 1px solid var(--border-ui);
            background: var(--bg-card);
            font-family: var(--font-mono-stack);
            width: 100%;
            border-collapse: collapse;
            overflow: hidden;
        }
        .green-table thead {
            background: rgba(0, 255, 136, 0.06);
        }
        .green-table thead th {
            color: var(--accent-terminal);
            padding: 12px 16px;
            text-align: left;
            font-size: 9px;
            font-weight: 600;
            font-family: var(--font-mono-stack);
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--divider);
        }
        .green-table tbody tr {
            border-bottom: 1px solid var(--divider);
        }
        .green-table tbody tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        .green-table tbody td {
            color: var(--text-main);
            padding: 8px 12px;
            font-size: 11px;
        }
        .green-table tbody td:first-child {
            color: var(--accent-terminal);
            font-weight: 600;
            text-align: right;
            width: 40px;
        }
        .green-table .ladder-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid var(--border-ui);
            cursor: pointer;
            object-fit: cover;
        }
        .green-table .ladder-avatar:hover {
            border-color: var(--accent-terminal);
        }
        #global-ladders-container {
            margin-top: 32px;
        }
        .ladder-card {
            border: 1px solid #004400;
            background: #000;
            padding: 12px;
            margin-bottom: 24px;
        }
        .ladder-card-title {
            color: #00ff41;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* çŸ©é˜µç»¿ä¸»é¢˜å¤©æ¢¯æ¦œæ ·å¼ï¼ˆIndustrialï¼‰ */
        .matrix-table {
            border: 1px solid var(--border-ui);
            font-family: var(--font-mono-stack);
            font-size: 12px;
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            overflow: hidden;
        }
        .matrix-table thead {
            background: rgba(0, 255, 136, 0.06);
        }
        .matrix-table thead th {
            color: var(--accent-terminal);
            padding: 12px 16px;
            text-align: left;
            font-size: 9px;
            font-weight: 600;
            font-family: var(--font-mono-stack);
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--divider);
        }
        .matrix-table tbody tr {
            border-bottom: 1px solid var(--divider);
        }
        .matrix-table tbody tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        .matrix-table tbody td {
            color: var(--text-main);
            padding: 8px 12px;
            font-size: 11px;
        }
        .matrix-table tbody td:first-child {
            color: var(--accent-terminal);
            font-weight: 600;
            text-align: right;
            width: 35px;
        }
        .matrix-table .matrix-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid var(--border-ui);
            cursor: pointer;
            object-fit: cover;
        }
        .matrix-table .matrix-avatar:hover {
            border-color: var(--accent-terminal);
        }
        #global-ranking-area {
            margin-top: 24px;
        }

        /* æ’è¡Œæ¦œå…­å¡ç‰‡å·¥ä¸šé£è¦†ç›–ï¼ˆJS æ¸²æŸ“çš„å¡ç‰‡ï¼‰ */
        .industrial-ranking-grid > div {
            background: rgba(17, 24, 39, 0.5) !important;
            border: 1px solid rgba(0, 255, 65, 0.3) !important;
            overflow: hidden;
            width: 100% !important;
            margin-bottom: 0 !important;
            border-radius: 6px;
        }
        .industrial-ranking-grid > div > div:first-child {
            background: rgba(0, 59, 0, 0.5) !important;
            border-bottom: 1px solid rgba(0, 255, 65, 0.3) !important;
        }
        .industrial-ranking-grid table thead th {
            color: var(--accent-terminal);
            font-family: var(--font-mono-stack);
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .industrial-ranking-grid table tbody td {
            color: var(--text-main);
            font-size: 11px;
        }
        .industrial-ranking-grid .text-\[\#00ff41\] { color: var(--accent-terminal) !important; }
        .industrial-ranking-grid .text-\[\#00ff41\]\/90 { color: var(--text-dim) !important; }
        
        /* æ’è¡Œæ¦œåˆ—è¡¨å®¹å™¨ */
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 0;
            width: 100%;
        }
        
        /* é‡‘èAppæ¦œå•é£æ ¼ - Gridå¸ƒå±€ï¼šå›½æ——ã€å¤´åƒã€ç”¨æˆ·ä¿¡æ¯ã€åˆ†å€¼ */
        .ranking-item-row {
            display: grid;
            grid-template-columns: 50px 50px 1fr 100px;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background-color: rgba(0, 255, 65, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
            width: 100%;
            position: relative;
            min-height: 70px;
            cursor: pointer;
        }
        .ranking-item-row:hover {
            background-color: rgba(0, 255, 65, 0.1);
        }
        
        /* ç¬¬ä¸€åˆ—ï¼šå›½æ——ï¼ˆå›ºå®šå®½åº¦ 50pxï¼Œå±…ä¸­æ˜¾ç¤ºï¼ŒåŠ å¤§å­—å·ï¼‰ */
        .ranking-flag-column {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            flex-shrink: 0;
        }
        .ranking-flag-large {
            font-size: 24px; /* text-xl å¤§å° */
            line-height: 1;
        }
        
        /* ç¬¬äºŒåˆ—ï¼šå¤´åƒï¼ˆå›ºå®šå®½åº¦ 50pxï¼Œw-10 h-10 åœ†å½¢ï¼‰ */
        .ranking-avatar-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            flex-shrink: 0;
        }
        .ranking-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid rgba(0, 255, 65, 0.3);
            box-shadow: 0 0 4px rgba(0, 255, 65, 0.2);
            object-fit: cover;
            transition: all 0.2s;
        }
        .ranking-avatar:hover {
            border-color: rgba(0, 255, 65, 0.8);
            box-shadow: 0 0 8px rgba(0, 255, 65, 0.4);
        }
        
        /* ç¬¬ä¸‰åˆ—ï¼šç”¨æˆ·ä¿¡æ¯åŒºï¼ˆflex flex-col å‚ç›´æ’å¸ƒï¼‰ */
        .ranking-user-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
            overflow: visible;
        }
        /* ä¸Šè¡Œï¼šuser_nameï¼ˆç»¿è‰²åŠ ç²—ï¼Œç¦æ­¢ truncate æˆªæ–­ï¼Œå…è®¸è‡ªç„¶ä¼¸å±•ï¼‰ */
        .ranking-username-row {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
        }
        .ranking-username {
            color: rgba(74, 222, 128, 1); /* text-green-400 */
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            white-space: normal;
            word-break: break-word;
            overflow: visible;
            text-overflow: clip;
            line-height: 1.4;
        }
        /* ä¸‹è¡Œï¼šæ˜¾ç¤º user_identity æ¥æº */
        .ranking-identity-row {
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 0;
        }
        .ranking-identity-text {
            color: rgba(107, 114, 128, 0.7);
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.3;
        }
        
        /* ç¬¬å››åˆ—ï¼šæ ¸å¿ƒåˆ†å€¼åŒºï¼ˆå³å¯¹é½ï¼Œflex flex-col items-endï¼‰ */
        .ranking-value-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
            width: 100px;
            flex-shrink: 0;
        }
        /* ä¸Šè¡Œï¼šæ ¸å¿ƒæ•°å€¼ï¼ˆç­‰å®½å¤§å­—ä½“ font-monoï¼‰ */
        .ranking-value {
            text-align: right;
            color: rgba(0, 255, 65, 1);
            font-size: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }
        /* ä¸‹è¡Œï¼šå›ºå®šæ˜¾ç¤ºè¯¥ç»´åº¦çš„å•ä½æˆ–æ ‡ç­¾ */
        .ranking-value-label {
            text-align: right;
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.2;
        }
        
        /* æ•°æ®è¯¦æƒ…å¼¹çª— */
        .ranking-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .ranking-detail-modal.active {
            display: flex;
        }
        .ranking-detail-card {
            background-color: rgba(10, 10, 10, 0.98);
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        .ranking-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
        }
        .ranking-detail-title {
            color: rgba(0, 255, 65, 1);
            font-size: 18px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }
        .ranking-detail-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        .ranking-detail-close:hover {
            color: rgba(255, 255, 255, 1);
        }
        .ranking-detail-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .ranking-detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .ranking-detail-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .ranking-detail-value {
            color: rgba(255, 255, 255, 1);
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
        }
        .ranking-detail-link {
            color: rgba(0, 255, 65, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        .ranking-detail-link:hover {
            color: rgba(74, 222, 128, 1);
            text-decoration: underline;
        }
        
        /* ç§»åŠ¨ç«¯å“åº”å¼ */
        @media (max-width: 768px) {
            .ranking-item-row {
                grid-template-columns: 40px 40px 1fr 80px;
                gap: 8px;
                padding: 10px 12px;
                min-height: 60px;
            }
            .ranking-flag-column {
                width: 40px;
            }
            .ranking-flag-large {
                font-size: 20px;
            }
            .ranking-avatar-wrapper {
                width: 40px;
            }
            .ranking-avatar {
                width: 32px;
                height: 32px;
            }
            .ranking-username {
                font-size: 12px;
            }
            .ranking-identity-text {
                font-size: 10px;
            }
            .ranking-value-section {
                width: 80px;
            }
            .ranking-value {
                font-size: 14px;
            }
            .ranking-value-label {
                font-size: 9px;
            }
            .ranking-detail-card {
                padding: 16px;
                max-width: 90%;
            }
        }

        .ranking-refresh-btn {
            padding: 8px 12px;
            font-size: 9px;
            font-weight: 600;
            font-family: var(--font-mono-stack);
            border: 1px solid var(--border-ui);
            color: var(--text-main);
            background: var(--bg-card);
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }
        .ranking-refresh-btn:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--accent-terminal);
            color: var(--accent-terminal);
        }
        .matrix-ladder-card {
            margin-bottom: 16px;
        }
        .matrix-ladder-title {
            color: #00ff41;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 6px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* çŸ©é˜µç»¿è¡¨æ ¼æ ·å¼ï¼ˆå¼ºåˆ¶é™æ€ï¼‰ */
        .matrix-table {
            width: 100%;
            background: #000;
            border: 1px solid #003b00;
            color: #00ff41;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            border-collapse: collapse;
        }
        .matrix-table thead {
            background: rgba(0, 59, 0, 0.5);
        }
        .matrix-table thead th {
            color: #00ff41;
            padding: 6px 10px;
            text-align: left;
            font-size: 11px;
            font-weight: bold;
            border-bottom: 1px solid #003b00;
        }
        .matrix-table tbody tr {
            border-bottom: 1px solid rgba(0, 59, 0, 0.3);
        }
        .matrix-table tbody tr:hover {
            background: rgba(0, 59, 0, 0.2);
        }
        .matrix-table tbody td {
            color: #00ff41;
            padding: 5px 10px;
            font-size: 11px;
        }
        .matrix-table tbody td:first-child {
            color: #00ff41;
            font-weight: bold;
            text-align: right;
            width: 35px;
        }

        .drawer-item {
            padding: 15px;
            margin-bottom: 0;
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid rgba(0, 255, 65, 0.2);
            border-radius: 4px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .drawer-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(0, 255, 65, 0.1),
                transparent
            );
            transition: left 0.5s;
        }

        .drawer-item:hover {
            border-color: rgba(0, 255, 65, 0.5);
            background: rgba(0, 255, 65, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }

        .drawer-item:hover::before {
            left: 100%;
        }

        /* hrdkm+B6GZW: label=JetBrains Mono 9px 600 #6a6a6a, value=Space Grotesk #FFFFFF */
        .drawer-item-label {
            font-family: var(--font-mono-stack);
            font-size: 9px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .drawer-item-value {
            font-family: 'Space Grotesk', system-ui, sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        .drawer-item-desc {
            font-family: var(--font-mono-stack);
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 8px;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .cyber-drawer {
                width: 100%;
            }
        }

        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            border-color: var(--accent-terminal);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
        }

        /* =========================
           Language Switch (Flags)
           ========================= */
        .lang-flag-btn {
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            opacity: 0.6;
            transform: scale(1);
            box-shadow: none;
            overflow: hidden;
            position: relative;
            z-index: 95; /* é¡¶éƒ¨å›½æ——æŒ‰é’®ç‚¹å‡»ä¼˜å…ˆçº§ */
        }

        .lang-flag-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
            transition: all 0.4s ease;
            padding: 2px;
            outline: none;
            border: none;
            box-shadow: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .lang-flag-btn.active {
            opacity: 1;
            border: 3px solid var(--accent-terminal);
            box-shadow: 0 0 16px rgba(0, 255, 65, 0.6), 0 0 32px rgba(0, 255, 65, 0.3), inset 0 0 20px rgba(0, 255, 65, 0.1);
            transform: scale(1.1);
        }

        .lang-flag-btn:hover:not(.active) {
            opacity: 0.9;
            transform: scale(1.15);
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .lang-flag-btn:hover.active {
            /* é€‰ä¸­çŠ¶æ€ï¼šä¿æŒ 3px ç²—è¾¹æ¡†ï¼Œåªæ”¹å˜ç¼©æ”¾å’Œé˜´å½± */
            border: 3px solid var(--accent-terminal);
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.8), 0 0 40px rgba(0, 255, 65, 0.4), inset 0 0 25px rgba(0, 255, 65, 0.15);
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.25s ease;
        }

        /* é˜²æ­¢è¢« ECharts å›¾å±‚é®æŒ¡ï¼šå¼ºåˆ¶æå‡å±‚çº§ + å¯ç‚¹å‡» */
        #btn-zh, #btn-en {
            cursor: pointer !important;
            z-index: 9999 !important;
            position: relative !important;
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse { animation: pulse-soft 2s infinite; }

        /* åœ¨çº¿äººæ•°æ•°å­—æ›´æ–°æ—¶çš„ç¼©æ”¾åŠ¨ç”» */
        @keyframes scale-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .online-count-update {
            animation: scale-bounce 0.4s ease-out;
        }

        /* =========================
           Cyberpunk Loading Effects
           ========================= */
        @keyframes skeleton-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* æµå…‰éª¨æ¶å±ï¼šç”¨äºæ•°å­—å ä½ï¼ˆä¸»é¢˜è‰²ç»¿+è“ï¼‰ */
        .skeleton {
            position: relative;
            color: transparent !important;
            user-select: none;
            border-radius: 2px;
            background: linear-gradient(
                90deg,
                rgba(39, 39, 42, 0.25) 0%,
                rgba(0, 255, 65, 0.18) 40%,
                rgba(0, 255, 65, 0.10) 55%,
                rgba(39, 39, 42, 0.25) 100%
            );
            background-size: 240% 100%;
            animation: skeleton-shimmer 1.2s ease-in-out infinite;
            box-shadow: 0 0 18px rgba(0, 255, 65, 0.06);
        }

        /* éª¨æ¶å±æœŸé—´ä¿æŒå¸ƒå±€é«˜åº¦ç¨³å®š */
        #totalUsers.skeleton,
        #totalAnalysis.skeleton,
        #totalChars.skeleton {
            min-height: 2.5rem;
        }
        #avgPerUser.skeleton,
        #avgPerScan.skeleton,
        #systemDays.skeleton,
        #cityCount.skeleton {
            min-height: 1.6rem;
        }

        @keyframes scan-sweep {
            0% { transform: translateY(-120%); opacity: 0; }
            10% { opacity: 0.9; }
            90% { opacity: 0.9; }
            100% { transform: translateY(120%); opacity: 0; }
        }

        /* å…¨å±æ‰«æçº¿ï¼šåŠ è½½æœŸé—´å åŠ  */
        .scan-line {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 40;
            opacity: 0;
            mix-blend-mode: screen;
        }
        .scan-line::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 18vh;
            top: -20vh;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(0, 255, 65, 0.14) 45%,
                rgba(0, 255, 65, 0.08) 60%,
                transparent 100%
            );
            filter: blur(1px);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.12);
            animation: scan-sweep 1.6s linear infinite;
        }
        .scan-line.active {
            opacity: 1;
        }
        
        /* ============================================
           æŠ½å±‰åŠ è½½ä¼˜åŒ–ï¼šéª¨æ¶å±ä¸æ¸è¿›å¼åŠ è½½
           ============================================ */
        
        /* æŠ½å±‰å†…å®¹æ·¡å…¥åŠ¨ç”» */
        .drawer-content-fade-in {
            animation: drawer-fade-in 0.4s ease-out forwards;
        }
        
        @keyframes drawer-fade-in {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* æŠ½å±‰å¡ç‰‡ä¾æ¬¡å…¥åœºåŠ¨ç”» */
        .clinic-card {
            opacity: 0;
            transform: translateY(12px);
            animation: card-slide-in 0.35s ease-out forwards;
        }
        
        .clinic-card:nth-child(1) { animation-delay: 0.05s; }
        .clinic-card:nth-child(2) { animation-delay: 0.1s; }
        .clinic-card:nth-child(3) { animation-delay: 0.15s; }
        .clinic-card:nth-child(4) { animation-delay: 0.2s; }
        .clinic-card:nth-child(5) { animation-delay: 0.25s; }
        .clinic-card:nth-child(6) { animation-delay: 0.3s; }
        .clinic-card:nth-child(7) { animation-delay: 0.35s; }
        .clinic-card:nth-child(8) { animation-delay: 0.4s; }
        
        @keyframes card-slide-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* æŠ½å±‰éª¨æ¶å±å¡ç‰‡ */
        .drawer-skeleton-card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 65, 0.15);
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .drawer-skeleton-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(0, 255, 65, 0.08) 50%,
                transparent 100%
            );
            transform: translateX(-100%);
            animation: skeleton-sweep 1.5s ease-in-out infinite;
        }
        
        @keyframes skeleton-sweep {
            to {
                transform: translateX(100%);
            }
        }
        
        .drawer-skeleton-header {
            height: 18px;
            width: 40%;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 2px;
            margin-bottom: 12px;
        }
        
        .drawer-skeleton-line {
            height: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            margin-bottom: 8px;
        }
        
        .drawer-skeleton-line.short { width: 60%; }
        .drawer-skeleton-line.medium { width: 80%; }
        .drawer-skeleton-line.long { width: 100%; }
        
        /* åŠ è½½è¿›åº¦æŒ‡ç¤ºå™¨ */
        .drawer-loading-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(0, 255, 65, 0.2);
            overflow: hidden;
            z-index: 10;
        }
        
        .drawer-loading-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 30%;
            background: linear-gradient(90deg, transparent, #00ff41, transparent);
            animation: loading-progress 1.5s ease-in-out infinite;
        }
        
        @keyframes loading-progress {
            0% { left: -30%; }
            100% { left: 100%; }
        }
        
        /* è„‰å†²åŠ è½½ç‚¹ */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
            align-items: center;
        }
        
        .loading-dots span {
            width: 6px;
            height: 6px;
            background: var(--accent-terminal);
            border-radius: 50%;
            animation: loading-dot 1.4s ease-in-out infinite both;
        }
        
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes loading-dot {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* æ•°æ®æ›´æ–°é—ªçƒæ•ˆæœ */
        .data-updated {
            animation: data-flash 0.6s ease-out;
        }
        
        @keyframes data-flash {
            0% { background-color: rgba(0, 255, 65, 0.2); }
            100% { background-color: transparent; }
        }
        
        /* ç¡®ä¿å†…å®¹åœ¨èƒŒæ™¯åŠ¨ç”»ä¹‹ä¸Š */
        body > div {
            position: relative;
            z-index: 10;
        }
        
        /* çŠ¶æ€æŒ‰é’®æ¿€æ´»æ ·å¼ */
        .status-btn.active {
            border-width: 2px;
            box-shadow: 0 0 10px currentColor;
        }
        
        /* ç”¨æˆ·åˆ—è¡¨é¡¹æ ·å¼ */
        .user-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid transparent;
            border-radius: 4px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .user-item:hover {
            background: rgba(39, 39, 42, 0.5);
            border-color: var(--card-border);
        }
        
        /* å¤´åƒå‘¼å¸ç¯è¾¹æ¡† */
        .avatar-pulse {
            position: relative;
            border-radius: 50%;
            padding: 2px;
        }
        
        .avatar-pulse::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            border: 2px solid currentColor;
            opacity: 0.6;
            animation: pulse-border 2s ease-in-out infinite;
        }
        
        @keyframes pulse-border {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        /* ç§ä¿¡æµ®çª—æ ·å¼ */
        .message-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            border: 2px solid var(--accent-terminal);
            border-radius: 8px;
            padding: 20px;
            min-width: 300px;
            max-width: 500px;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
            animation: popup-appear 0.3s ease-out;
        }
        
        @keyframes popup-appear {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .message-popup.destroying {
            animation: popup-destroy 0.5s ease-out forwards;
        }
        
        @keyframes popup-destroy {
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }
        
        /* ç§ä¿¡è¾“å…¥æ¡†æ ·å¼ */
        .message-input-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* UserText Debug Modalï¼ˆç”¨äºæ£€æŸ¥ userText/æè¯/ä¸ŠæŠ¥åˆ—è¡¨ï¼‰ */
        .usertext-debug-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 1200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .message-input-box {
            background: var(--card-bg);
            border: 2px solid var(--accent-terminal);
            border-radius: 8px;
            padding: 20px;
            min-width: 400px;
            z-index: 1000;
        }

        /* ç§ä¿¡æ”¶ä»¶ç®±æŠ½å±‰ */
        #private-inbox-drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 50%;
            max-width: 420px;
            height: 100%;
            background: rgba(5, 5, 5, 0.98);
            border-left: 1px solid rgba(0, 255, 65, 0.45);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.5);
            z-index: 1002;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        #private-inbox-drawer.active { transform: translateX(0); }
        .inbox-header { padding: 16px 20px; border-bottom: 1px solid rgba(0, 255, 65, 0.2); display: flex; justify-content: space-between; align-items: center; }
        .inbox-title { color: #00ff41; font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 700; }
        .inbox-close { background: none; border: none; color: #00ff41; font-size: 18px; cursor: pointer; }
        .inbox-body { flex: 1; overflow-y: auto; padding: 12px; }
        .inbox-item { background: rgba(0, 255, 65, 0.05); border: 1px solid rgba(0, 255, 65, 0.2); border-radius: 6px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        .inbox-item-info { font-size: 11px; color: #a1a1aa; }
        .inbox-item-btn { padding: 4px 10px; font-size: 10px; border: 1px solid rgba(0, 255, 65, 0.5); color: #00ff41; background: transparent; cursor: pointer; border-radius: 4px; transition: all 0.2s; }
        .inbox-item-btn:hover { background: rgba(0, 255, 65, 0.15); }
        .inbox-indicator { position: relative; }
        .inbox-indicator.has-new::after { content: ''; position: absolute; top: 2px; right: 2px; width: 6px; height: 6px; background: #ef4444; border-radius: 50%; }

        /* é˜…åå³ç„šé˜…è¯»å™¨ - æ¨¡ç³Šæ¸æ˜¾åŠ¨ç”» */
        .burn-reader-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1005;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .burn-reader-box {
            background: rgba(5, 5, 5, 0.98);
            border: 1px solid rgba(0, 255, 65, 0.45);
            border-radius: 8px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
        }
        .burn-reader-content {
            filter: blur(12px);
            opacity: 0;
            animation: burn-reveal 1.2s ease-out forwards;
        }
        @keyframes burn-reveal {
            0% { filter: blur(12px); opacity: 0; }
            100% { filter: blur(0); opacity: 1; }
        }
        .burn-reader-countdown {
            margin-top: 12px;
            font-size: 11px;
            color: #71717a;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* æ‚¬æµ®æŠ½å±‰å¼åˆ—è¡¨æ ·å¼ */
        .live-nodes-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .live-nodes-drawer.collapsed {
            transform: translateY(calc(100% - 48px));
        }
        
        .live-nodes-drawer.expanded {
            transform: translateY(0);
        }
        
        .live-nodes-header {
            background: rgba(24, 24, 27, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 2px solid var(--accent-terminal);
            box-shadow: 0 -4px 20px rgba(0, 255, 65, 0.2);
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        
        .live-nodes-header:hover {
            background: rgba(24, 24, 27, 0.95);
            box-shadow: 0 -4px 30px rgba(0, 255, 65, 0.3);
        }
        
        .live-nodes-content {
            background: rgba(24, 24, 27, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(0, 255, 65, 0.2);
            max-height: 400px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        #online-users-list {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px !important;
            align-items: center; /* ç¡®ä¿å¤´åƒå‚ç›´å¯¹é½ */
        }
        
        /* ç´§å‡‘æ’åˆ—çš„ç”¨æˆ·å¤´åƒ */
        .user-avatar-compact {
            position: relative;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid rgba(0, 255, 65, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
            /* ç§»é™¤ overflow: hidden ä»¥å…è®¸æ˜¾ç¤ºå†…éƒ¨çš„ç»å¯¹å®šä½å¼¹çª— */
            /* overflow: hidden; */
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-avatar-compact:hover {
            border-color: rgba(0, 255, 65, 0.8);
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 0 12px rgba(0, 255, 65, 0.5);
        }
        
        .user-avatar-compact.busy {
            cursor: not-allowed;
            opacity: 0.6;
            border-color: rgba(255, 140, 0, 0.3);
        }
        
        .user-avatar-compact.busy:hover {
            border-color: rgba(255, 140, 0, 0.5);
            box-shadow: 0 0 12px rgba(255, 140, 0, 0.3);
        }
        
        .user-avatar-compact img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%; /* ç¡®ä¿å›¾ç‰‡æœ¬èº«ä¹Ÿæ˜¯åœ†å½¢çš„ */
        }
        
        /* æ‹Ÿæ€é£æ ¼å¼¹çª— - ä»æ´»è·ƒèŠ‚ç‚¹æ¡†ä¸Šè¾¹ç¼˜æ¨å‡ºï¼Œä¸é®æŒ¡æŠ½å±‰ï¼ˆfixed å®šä½ç”± JS è®¡ç®—ï¼‰ */
        .user-popup {
            position: fixed;
            font-size: 13px;
            width: 300px;
            max-width: calc(100vw - 40px);
            background: linear-gradient(145deg, #1e1e22 0%, #25252a 100%);
            border: none;
            border-radius: 12px;
            padding: 16px;
            z-index: 10001;
            box-shadow: 6px 6px 14px rgba(0, 0, 0, 0.5),
                        -6px -6px 14px rgba(50, 50, 55, 0.4),
                        inset 1px 1px 0 rgba(255, 255, 255, 0.04);
            animation: popup-appear 0.2s ease-out;
            pointer-events: auto;
            white-space: normal;
            overflow-x: hidden;
            overflow-y: hidden;
        }
        /* ä»æ´»è·ƒèŠ‚ç‚¹æ¡†ä¸Šè¾¹ç¼˜æ¨å‡ºï¼šè‡ªä¸‹è€Œä¸Šæ»‘å‡ºï¼Œæ‹Ÿç‰©æ„Ÿ */
        .user-popup.emerged-from-drawer {
            animation: popup-emerge-from-drawer 0.28s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        @keyframes popup-emerge-from-drawer {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(18px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* ç®­å¤´æ°´å¹³ä½ç½®ç”± JS è®¾ç½® --arrow-leftï¼Œå¯¹å‡†å¤´åƒä¸­å¿ƒ */
        .user-popup::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: var(--arrow-left, 50%);
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #25252a;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }
        
        .user-popup.top-position::before {
            bottom: auto;
            top: -8px;
            border-top: none;
            border-bottom: 8px solid #25252a;
        }
        
        @keyframes popup-appear {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(6px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        /* è´´è¾¹æ—¶æ—  translateXï¼Œä»…æ·¡å…¥ */
        .user-popup.edge-position {
            animation: popup-appear-edge 0.22s ease-out forwards;
        }
        @keyframes popup-appear-edge {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-popup-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
        }
        
        .user-popup-avatar-link {
            display: block;
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .user-popup-avatar-link .user-popup-avatar {
            display: block;
        }
        
        .user-popup-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid rgba(0, 255, 65, 0.5);
            object-fit: cover;
        }
        
        .user-popup-info {
            flex: 1;
            min-width: 0;
        }
        
        .user-popup-name {
            font-size: 1em;
            font-weight: bold;
            color: #00ff41;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 4px;
            word-break: break-all;
        }
        
        .user-popup-status {
            font-size: 0.85em;
            color: rgba(0, 255, 65, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .user-popup-repo {
            margin-top: 12px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .user-popup-repo-title {
            font-size: 0.85em;
            color: rgba(0, 255, 65, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .user-popup-repo-list {
            font-size: 1em;
            color: rgba(255, 255, 255, 0.9);
            font-family: 'JetBrains Mono', monospace;
            max-height: 140px;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .user-popup-repo-item {
            position: relative;
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 6px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.1);
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .user-popup-repo-item-meta {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 2px;
        }
        
        .user-popup-repo-meta-gap {
            display: inline-block;
            width: 1em;
        }
        
        .user-popup-repo-item:hover {
            background: rgba(0, 255, 65, 0.08);
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .user-popup-repo-item:last-child {
            border-bottom: none;
        }
        
        a.user-popup-repo-item {
            text-decoration: none;
            color: inherit;
            display: block;
        }
        
        /* å•ä»“åº“æ˜Ÿæ ‡å¡ç‰‡ï¼ˆä»…å±•ç¤º Star æœ€é«˜çš„ä¸€ä¸ªï¼‰ */
        .user-popup-repo-star-card {
            display: block;
            text-decoration: none;
            color: inherit;
            padding: 12px 14px;
            margin: 0;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 65, 0.25);
            background: linear-gradient(145deg, rgba(0, 255, 65, 0.06) 0%, rgba(0, 0, 0, 0.3) 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
            word-break: break-word;
        }
        .user-popup-repo-star-card:hover {
            border-color: rgba(0, 255, 65, 0.5);
            box-shadow: 0 6px 16px rgba(0, 255, 65, 0.15);
            transform: translateY(-1px);
        }
        .user-popup-repo-star-card .repo-card-name {
            font-weight: 600;
            font-size: 1em;
            color: #00ff41;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            overflow: hidden;
            word-break: break-all;
        }
        .user-popup-repo-star-card .repo-card-desc {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.35;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .user-popup-repo-star-card .repo-card-meta {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .user-popup-repo-star-card .repo-card-stars {
            color: #fbbf24;
            font-weight: 600;
        }
        .user-popup-repo-star-card .repo-card-updated {
            white-space: nowrap;
        }
        .user-popup-repo-empty {
            padding: 10px 0;
        }
        .user-popup-repo-fallback-link {
            display: block;
            margin-top: 6px;
            color: #00ff41;
            font-size: 0.9em;
            text-decoration: none;
        }
        .user-popup-repo-fallback-link:hover {
            text-decoration: underline;
        }
        
        /* ä»“åº“é¡¹æ‚¬æµ®é¢„è§ˆï¼ˆä»‹ç»ï¼‰ */
        .user-popup-repo-item-tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 8px;
            width: 200px;
            padding: 8px 10px;
            background: linear-gradient(145deg, #25252a 0%, #1e1e22 100%);
            border-radius: 8px;
            box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.5);
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.4;
            white-space: normal;
            z-index: 10002;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
        }
        
        .user-popup-repo-item:hover .user-popup-repo-item-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        .user-popup-repo-item-tooltip.no-desc {
            font-style: italic;
            color: rgba(255, 255, 255, 0.45);
        }
        
        .user-popup-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .user-popup-btn-icon {
            flex: none;
            width: 36px;
            height: 36px;
            padding: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-popup-btn {
            flex: 1;
            padding: 8px 12px;
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid rgba(0, 255, 65, 0.4);
            color: #00ff41;
            font-size: 1em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .user-popup-btn:hover {
            background: rgba(0, 255, 65, 0.2);
            border-color: rgba(0, 255, 65, 0.8);
            box-shadow: 0 0 8px rgba(0, 255, 65, 0.3);
        }
        
        .user-popup-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .user-popup-btn.repo-btn {
            background: rgba(0, 255, 65, 0.05);
        }
        
        .user-popup-btn.repo-btn:hover {
            background: rgba(0, 255, 65, 0.15);
        }
        
        .user-popup-repo-list::-webkit-scrollbar {
            width: 4px;
        }
        
        .user-popup-repo-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .user-popup-repo-list::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.4);
            border-radius: 2px;
        }
        
        .user-popup-repo-list::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 65, 0.6);
        }
        
        .live-nodes-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .live-nodes-content::-webkit-scrollbar-track {
            background: rgba(39, 39, 42, 0.5);
        }
        
        .live-nodes-content::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.3);
            border-radius: 3px;
        }
        
        .live-nodes-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 65, 0.5);
        }
        
        .chevron-icon {
            transition: transform 0.3s ease;
            width: 16px !important;
            height: 16px !important;
            max-width: 16px !important;
            max-height: 16px !important;
            display: inline-block;
            flex-shrink: 0;
        }
        
        .live-nodes-drawer.expanded .chevron-icon {
            transform: rotate(180deg);
        }
        
        /* é˜²æ­¢ SVG å›¾æ ‡åœ¨é¡µé¢åŠ è½½æ—¶æ”¾å¤§åˆ°å…¨å± */
        svg {
            max-width: 100%;
            max-height: 100%;
        }
        
        .user-item-verified {
            border-left: 2px solid var(--accent-terminal);
        }
        
        .user-item-anonymous {
            opacity: 0.7;
        }
        
        .github-link-icon {
            width: 14px;
            height: 14px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        
        .user-item:hover .github-link-icon {
            opacity: 1;
        }

        /* =========================
           å³ä¾§æŠ½å±‰ï¼šé«˜åˆ†å›¾è°±æ’è¡Œæ¦œï¼ˆæ—§ï¼šæ¨ªå‘æ»‘åŠ¨ + æŒ‡ç¤ºå™¨ï¼›æ–°ï¼š6 å¼ çºµå‘å¡ç‰‡ï¼‰
           ========================= */
        .lpdef-carousel {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            gap: 12px;
            padding: 6px 0 2px 0;
        }
        .lpdef-carousel::-webkit-scrollbar { height: 6px; }
        .lpdef-carousel::-webkit-scrollbar-thumb { background: rgba(0,255,65,0.25); border-radius: 999px; }
        .lpdef-page {
            flex: 0 0 100%;
            scroll-snap-align: start;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(9, 9, 9, 0.45);
            padding: 10px;
            text-align: center; /* æ•´ä½“æ–‡æœ¬å±…ä¸­ */
        }
        .lpdef-page-title {
            font-size: 12px;
            color: #e5e7eb;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .lpdef-rank-list {
            display: flex;
            flex-direction: column;
            gap: 8px; /* é—´è·è°ƒæ•´ */
        }
        .lpdef-rank-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 7px 9px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(0,0,0,0.25);
        }
        .lpdef-rank-left {
            display: flex;
            align-items: center;
            gap: 8px; /* æ›´ç´§å‡‘ï¼Œé¿å…æŒ¤å‹åˆ†å€¼ */
            min-width: 0;
            flex: 1 1 auto; /* å·¦ä¾§å¯å‹ç¼©ï¼Œé¿å…æŒ¤æ‰åˆ†å€¼ */
            text-align: left; /* è¡Œå†…ä¾ç„¶å·¦å¯¹é½æ›´æ˜“è¯» */
        }
        .lpdef-rank-badge {
            width: 22px;
            height: 22px;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            border: 1px solid rgba(0,255,65,0.35);
            color: #00ff41;
            flex: 0 0 auto;
        }
        .lpdef-rank-rn {
            width: 38px;
            flex: 0 0 auto;
            text-align: left;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.40);
            font-variant-numeric: tabular-nums;
        }
        .lpdef-rank-avatar {
            width: 20px;
            height: 20px;
            border-radius: 999px;
            object-fit: cover;
            border: 1px solid rgba(0,255,65,0.25);
            flex: 0 0 auto;
        }
        .lpdef-name-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
            flex: 1 1 auto;
        }
        .lpdef-rank-name {
            font-size: 11px;
            color: #e5e7eb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* å…³é”®ï¼šè®©åå­—åœ¨ flex ä¸­å¯ç¼©ï¼Œä¸æŒ¤å åˆ†å€¼ç©ºé—´ */
            min-width: 0;
            flex: 1 1 auto;
        }
        .lpdef-persona-tag {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.40);
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            flex: 0 0 auto;
            white-space: nowrap;
        }
        .lpdef-rank-score {
            font-size: 12px;
            font-weight: 800;
            color: var(--accent-terminal); /* cyberpunk green */
            font-variant-numeric: tabular-nums;
            text-align: right;
            flex: 0 0 auto; /* ä¸ç¼©ï¼Œé˜²æ­¢ 275.3k è¢«æˆªæ–­ */
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            min-width: 72px; /* å³ä¾§å®šå®½ï¼šä¸€è¡Œæ¸…æ™°æ˜¾ç¤ºâ€œåæ¬¡/ç”¨æˆ·/åˆ†æ•°â€ */
        }

        /* æ–°å¸ƒå±€ï¼š6 å¼ çºµå‘å¡ç‰‡ */
        .lpdef-metric-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 6px 0 2px 0;
        }
        .lpdef-metric-card {
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(9, 9, 9, 0.45);
            padding: 10px;
        }
        .lpdef-metric-title {
            font-size: 12px;
            color: #e5e7eb;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            margin-bottom: 8px;
            text-align: left;
        }
        .lpdef-rank-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 0 0 auto;
        }
        .lpdef-rank-delta {
            min-width: 54px;
            text-align: right;
            font-size: 11px;
            font-weight: 800;
            color: rgba(255,255,255,0.35);
            font-variant-numeric: tabular-nums;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            flex: 0 0 auto;
        }
        .lpdef-rank-delta.up { color: #00ff41; }
        .lpdef-rank-delta.down { color: #f87171; }
        .lpdef-rank-delta.flat { color: rgba(255,255,255,0.45); }
        .lpdef-rank-delta.na { color: rgba(255,255,255,0.28); }
        .lpdef-rank-header-row {
            background: rgba(255,255,255,0.03);
            border-color: rgba(255,255,255,0.10);
            padding-top: 6px;
            padding-bottom: 6px;
        }
        .lpdef-rank-header-row .lpdef-rank-rn,
        .lpdef-rank-header-row .lpdef-rank-name,
        .lpdef-rank-header-row .lpdef-rank-score,
        .lpdef-rank-header-row .lpdef-rank-delta {
            font-size: 10px;
            font-weight: 700;
            color: rgba(255,255,255,0.35);
        }
        .lpdef-rank-header-row .lpdef-rank-score { min-width: 72px; }
        .lpdef-rank-header-row .lpdef-rank-delta { min-width: 54px; }

        /* çª„å±è¿›ä¸€æ­¥æ”¶ç´§ï¼šéšè—å¯é€‰æ ‡ç­¾ï¼Œç¡®ä¿ä¸‰æ®µä¿¡æ¯ä¸€è¡Œæ˜¾ç¤º */
        @media (max-width: 420px) {
            .lpdef-rank-left { gap: 8px; }
            .lpdef-rank-rn { width: 34px; }
            .lpdef-rank-avatar { width: 18px; height: 18px; }
            .lpdef-persona-tag { display: none; }
            .lpdef-rank-score { min-width: 64px; font-size: 11px; }
            .lpdef-rank-name { min-width: 0; }
            .lpdef-rank-delta { min-width: 46px; font-size: 10px; }
            .lpdef-rank-header-row .lpdef-rank-delta { min-width: 46px; }
        }
        .lpdef-indicators {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin: 4px 0 10px 0;
            flex-wrap: wrap;
        }
        .lpdef-indicator-btn {
            border: 1px solid rgba(0,255,65,0.28);
            background: rgba(0,255,65,0.06);
            color: rgba(0,255,65,0.85);
            font-size: 10px;
            padding: 4px 8px;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            cursor: pointer;
        }
        .lpdef-indicator-btn.active {
            border-color: rgba(0,255,65,0.75);
            background: rgba(0,255,65,0.12);
            color: #00ff41;
            box-shadow: 0 0 0 1px rgba(0,255,65,0.18) inset;
        }

        /* LPDEF å¡ç‰‡åŠ¨ç”» */
        @keyframes lpdef-scan {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
            50% {
                box-shadow: 0 0 20px 5px rgba(0, 255, 65, 0.5);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
        }

        @keyframes lpdef-flash {
            0%, 100% { opacity: 1; }
            25% { opacity: 0.3; }
            50% { opacity: 0.6; }
            75% { opacity: 0.3; }
        }

        .lpdef-card.scanning {
            animation: lpdef-scan 1.5s ease-in-out;
        }

        .lpdef-card.recalculating {
            animation: lpdef-flash 0.8s ease-in-out;
        }

        .lpdef-card.recalculating::after {
            content: 'æ•°æ®é‡ç®—...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: var(--accent-terminal);
            padding: 8px 16px;
            border: 1px solid var(--accent-terminal);
            font-size: 10px;
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
        }

        /* LPDEF å®¹å™¨æ‰«æåŠ¨ç”» */
        @keyframes lpdef-container-scan {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
            50% {
                box-shadow: 0 0 30px 10px rgba(0, 255, 65, 0.6);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
        }

        #lpdef-container.lpdef-scan {
            animation: lpdef-container-scan 1.5s ease-in-out;
        }

        /* å…‰æ¡æ‰«ææ•ˆæœ */
        @keyframes lpdef-light-sweep {
            0% {
                background-position: -100% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        #lpdef-container.lpdef-scan::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(0, 255, 65, 0.3) 50%,
                transparent 100%
            );
            background-size: 200% 100%;
            animation: lpdef-light-sweep 1.5s ease-in-out;
            pointer-events: none;
            z-index: 1;
        }
        /* =========================
           Right Drawer Template (right.html) - namespaced
           ========================= */
        .country-panel-template {
            color: #ffffff;
            font-family: 'JetBrains Mono', monospace;
        }

        .country-panel-template .report-container {
            width: 100%;
            max-width: 100%;
            padding: 0 2px;
            position: relative;
        }

        .country-panel-template .clinic-card {
            border: 1px solid rgba(0, 255, 65, 0.22);
            background: rgba(5, 5, 5, 0.92);
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.03);
        }

        .country-panel-template .clinic-card::before {
            content: ">>";
            position: absolute;
            top: -2px;
            left: 12px;
            background: var(--bg-color);
            padding: 0 6px;
            color: #00ff41;
            font-size: 12px;
            font-weight: 700;
        }

        .country-panel-template .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.22);
            padding-bottom: 10px;
            margin-bottom: 14px;
        }

        .country-panel-template .card-header i {
            width: 18px;
            height: 18px;
            color: #00ff41;
        }

        /* hrdkm+B6GZW è‰²ç³»: #0A0A0A #2f2f2f #6a6a6a #00FF88 */
        .country-panel-template .card-title {
            font-family: var(--font-mono-stack);
            font-size: 12px;
            color: var(--accent-terminal);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .country-panel-template .metric-label {
            font-family: var(--font-mono-stack);
            font-size: 9px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .country-panel-template .metric-value {
            font-family: 'Space Grotesk', system-ui, sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        .country-panel-template .stat-bar-container {
            height: 6px;
            background: var(--bg-color);
            margin-top: 6px;
            position: relative;
            border: 1px solid var(--border-ui);
        }

        .country-panel-template .stat-bar-fill {
            height: 100%;
            background: var(--accent-terminal);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
        }

        .country-panel-template .pk-track {
            height: 14px;
            background: var(--bg-color);
            display: flex;
            position: relative;
            border: 1px solid var(--border-ui);
        }

        .country-panel-template .pk-left {
            background: var(--text-main);
            height: 100%;
        }

        .country-panel-template .pk-right {
            background: var(--accent-terminal);
            height: 100%;
        }

        .country-panel-template .pk-divider {
            position: absolute;
            left: 50%;
            top: -4px;
            bottom: -4px;
            width: 2px;
            background: #ffffff;
            z-index: 10;
        }

        .country-panel-template .scrolling-wrapper {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 12px;
            padding-bottom: 10px;
            scrollbar-width: none;
        }

        .country-panel-template .scrolling-wrapper::-webkit-scrollbar {
            display: none;
        }

        .country-panel-template .user-avatar-card {
            flex: 0 0 108px;
            text-align: center;
            background: rgba(13, 13, 13, 0.95);
            border: 1px solid rgba(0, 255, 65, 0.18);
            padding: 10px;
        }

        .country-panel-template .avatar-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin: 0 auto 8px;
            border: 2px solid #00ff41;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #00ff41;
            font-size: 12px;
        }

        .country-panel-template .cloud-tag {
            display: inline-block;
            margin: 4px;
            padding: 2px 8px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: all 0.2s;
        }

        .country-panel-template .cloud-tag:hover {
            border-color: #00ff41;
            color: #00ff41;
        }

        /* è¯­ä¹‰çˆ†å‘è¯äº‘ï¼šæŒ‰ç±»åˆ«ä¸Šè‰²ï¼ˆslang/merit/sv_slangï¼‰ */
        .country-panel-template .cloud-tag.slang {
            border-color: rgba(168, 85, 247, 0.65); /* #A855F7 */
            background: rgba(168, 85, 247, 0.12);
            color: #d8b4fe;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.16);
        }
        .country-panel-template .cloud-tag.merit {
            border-color: rgba(16, 185, 129, 0.65); /* #10B981 */
            background: rgba(16, 185, 129, 0.12);
            color: #6ee7b7;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.14);
        }
        .country-panel-template .cloud-tag.sv_slang {
            border-color: rgba(249, 115, 22, 0.65); /* #F97316 */
            background: rgba(249, 115, 22, 0.12);
            color: #fdba74;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.14);
        }
        .country-panel-template .cloud-tag.slang:hover,
        .country-panel-template .cloud-tag.merit:hover,
        .country-panel-template .cloud-tag.sv_slang:hover {
            filter: brightness(1.08);
        }

        /* è¯­ä¹‰çˆ†å‘è¯äº‘ï¼šæ— é¢å¤–åˆ‡æ¢æ§ä»¶ */

        .country-panel-template .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px 0;
        }

        .country-panel-template .status-tag {
            font-size: 10px;
            padding: 3px 8px;
            border: 1px solid #00ff41;
            color: #00ff41;
            font-weight: 800;
        }

        .country-panel-template .status-tag.invert {
            background: #00ff41;
            color: #050505;
        }

        /* LIVE_FEEDï¼šçº¿æ¡†å’ŒèƒŒæ™¯ç»¿è‰²ï¼Œæ–‡å­—ç™½è‰² */
        .country-panel-template #rtStatusTag {
            background: rgba(0, 255, 65, 0.4) !important;
            color: #ffffff !important;
            border: 1px solid rgba(0, 255, 65, 0.9) !important;
        }

        /* äººæ ¼åˆ†å¸ƒï¼šç«–å‘æŸ±çŠ¶å›¾ï¼ˆåœ†è§’æŸ± + ç±»å‹ç¼©å†™ + æ–‡å­—åç§° + ç™¾åˆ†æ¯”ï¼‰ */
        .personality-vbar-chart {
            background: transparent;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px 10px;
            align-items: flex-end;
            min-height: 140px;
        }
        .personality-vbar-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 52px;
            flex-shrink: 0;
        }
        .personality-vbar-bar-wrap {
            width: 100%;
            height: 72px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            margin-bottom: 4px;
        }
        .personality-vbar-fill {
            width: 100%;
            min-height: 4px;
            border-radius: 4px 4px 0 0;
            background: linear-gradient(180deg, rgba(0, 255, 65, 0.65) 0%, rgba(0, 255, 65, 0.25) 100%);
            transition: height 0.35s ease-out;
        }
        .personality-vbar-label {
            font-size: 10px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            color: rgba(255, 255, 255, 0.95);
        }
        .personality-vbar-name {
            font-size: 9px;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            line-height: 1.2;
            max-width: 52px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            margin-top: 1px;
        }
        .personality-vbar-pct {
            font-size: 9px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: rgba(0, 255, 65, 0.95);
            font-variant-numeric: tabular-nums;
            margin-top: 2px;
        }

        /* Leaflet è‡ªå®šä¹‰ç”¨æˆ·å…‰æ ‡æ ·å¼ */
        .custom-user-marker {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }
        .custom-user-marker div {
            pointer-events: none;
        }

        /* å›½å®¶é€‰æ‹©ä¸‹æ‹‰èœå•æ ·å¼ - èµ›åšæœ‹å…‹é£æ ¼ */
        .country-select-dropdown {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 65, 0.4);
            border-radius: 2px;
            color: #00ff41;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            outline: none;
            padding: 6px 24px 6px 8px;
            transition: all 0.2s;
            position: relative;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%2300ff41' d='M5 7L1 3h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            box-shadow: 0 0 8px rgba(0, 255, 65, 0.2);
        }
        .country-select-dropdown:hover {
            border-color: rgba(0, 255, 65, 0.7);
            box-shadow: 0 0 12px rgba(0, 255, 65, 0.4);
            background-color: rgba(0, 255, 65, 0.05);
        }
        .country-select-dropdown:focus {
            border-color: #00ff41;
            box-shadow: 0 0 16px rgba(0, 255, 65, 0.6);
            background-color: rgba(0, 255, 65, 0.1);
        }
        .country-select-dropdown option {
            background: #050505 !important;
            color: #00ff41 !important;
            padding: 8px 12px;
            border: none;
        }
        .country-select-dropdown option:hover,
        .country-select-dropdown option:focus {
            background: rgba(0, 255, 65, 0.2) !important;
            color: #00ff41 !important;
        }
        .country-select-dropdown option:checked,
        .country-select-dropdown option[selected] {
            background: rgba(0, 255, 65, 0.3) !important;
            color: #00ff41 !important;
        }
        /* ä¸‹æ‹‰èœå•æ»šåŠ¨æ¡æ ·å¼ - èµ›åšæœ‹å…‹ç»¿è‰²ç³» */
        .country-select-dropdown::-webkit-scrollbar {
            width: 8px;
        }
        .country-select-dropdown::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.8);
            border-left: 1px solid rgba(0, 255, 65, 0.2);
        }
        .country-select-dropdown::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.5);
            border-radius: 4px;
            border: 1px solid rgba(0, 255, 65, 0.3);
        }
        .country-select-dropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 65, 0.7);
            box-shadow: 0 0 8px rgba(0, 255, 65, 0.4);
        }

        /* è„‰åŠ¨é—ªå…‰æ•ˆæœ */
        @keyframes pulse-glow {
            0% {
                transform: scale(1);
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0.7);
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
                box-shadow: 0 0 20px 10px rgba(0, 255, 65, 0.4);
            }
            100% {
                transform: scale(1);
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);
            }
        }
        .pulse-marker {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* éšè—æ—§çš„å·¥å…·æŒ‰é’® */
        #map-cursor-tools {
            display: none !important;
        }

        /* å·¦ä¾§æŠ½å±‰å›½å®¶é€‰æ‹©èœå•æ»šåŠ¨æ¡æ ·å¼ */
        #left-drawer-country-list::-webkit-scrollbar {
            width: 6px;
        }
        #left-drawer-country-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }
        #left-drawer-country-list::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 65, 0.5);
            border-radius: 3px;
        }
        #left-drawer-country-list::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 65, 0.7);
        }

        /* å·¦ä¾§æŠ½å±‰æœç´¢æ¡†æ ·å¼ - èµ›åšæœ‹å…‹é£æ ¼ */
        #left-drawer-country-search {
            transition: all 0.2s !important;
        }
        #left-drawer-country-search:hover {
            border-color: rgba(0, 255, 65, 0.7) !important;
            box-shadow: 0 0 12px rgba(0, 255, 65, 0.4) !important;
            background-color: rgba(0, 255, 65, 0.05) !important;
        }
        #left-drawer-country-search:focus {
            border-color: #00ff41 !important;
            box-shadow: 0 0 16px rgba(0, 255, 65, 0.6) !important;
            background-color: rgba(0, 255, 65, 0.1) !important;
        }
        #left-drawer-country-search::placeholder {
            color: rgba(0, 255, 65, 0.5);
        }
        /* å·¦ä¾§æŠ½å±‰å›½å®¶åˆ—è¡¨ï¼šé»˜è®¤æ”¶èµ·ï¼Œä»…ç‚¹å‡»æœç´¢æ¡†åå±•å¼€ */
        #left-drawer-country-list {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.2s ease, opacity 0.2s ease;
            border: none !important;
            margin-bottom: 0 !important;
        }
        #left-drawer-country-list.left-drawer-country-list-visible {
            max-height: 200px;
            opacity: 1;
            overflow-y: auto;
            border: 1px solid rgba(0, 255, 65, 0.2) !important;
            margin-bottom: 0 !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- é¡¶éƒ¨å›ºå®š Header -->
    <div class="top-header">
        <div class="top-header-left">
            <div class="top-header-title">
                <h1>
                    <span class="lang-key text-white" data-key="top-title" data-t="top-title">Cursorè¡Œä¸ºæŠ¥å‘Šå…¨çƒåˆ†å¸ƒå›¾</span>
                </h1>
                <p id="sub-title">Telemetry Uplink: Active // Source: Central_Pacific</p>
            </div>
        </div>
        
        <div class="top-header-right">
            <!-- æ´»è·ƒèŠ‚ç‚¹å¡ç‰‡ -->
            <div class="top-header-card">
                <div class="top-header-card-label lang-key" data-key="active-nodes" data-t="active-nodes">æ´»è·ƒèŠ‚ç‚¹</div>
                <div class="top-header-card-value text-[var(--accent-terminal)]">
                    <span class="w-1.5 h-1.5 bg-[var(--accent-terminal)] rounded-full pulse"></span>
                    <span id="online-count-value">0</span> CONNECTED
                </div>
            </div>
            
            <!-- ä½“æ£€äººæ•°å¡ç‰‡ï¼šæ˜¾ç¤ºå·²ä¸Šä¼ è¿‡èŠå¤©è®°å½•çš„äººæ•° -->
            <div class="top-header-card">
                <div class="top-header-card-label lang-key" data-key="threat-level" data-t="threat-level">ä½“æ£€äººæ•°</div>
                <div id="physical-exam-count" class="top-header-card-value text-[var(--accent-terminal)]">--</div>
            </div>
            
            <!-- å›½å®¶é€‰æ‹©ä¸‹æ‹‰èœå• -->
            <div class="top-header-card" style="position: relative;">
                <div class="top-header-card-label lang-key" data-key="select-country" data-t="select-country">é€‰æ‹©å›½å®¶</div>
                <select id="country-select-dropdown" class="country-select-dropdown">
                    <option value="">-- é€‰æ‹©å›½å®¶ --</option>
                </select>
            </div>
            
            <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
            <div class="flex gap-2 items-center">
                <button type="button" id="btn-zh" class="lang-flag-btn active" title="ä¸­æ–‡" aria-label="ä¸­æ–‡" data-lang="zh">
                    <img src="images/zh.png" alt="ä¸­æ–‡" />
                </button>
                <button type="button" id="btn-en" class="lang-flag-btn" title="English" aria-label="English" data-lang="en">
                    <img src="images/us.png" alt="English" />
                </button>
            </div>
        </div>
    </div>
    
    <!-- å…¨å±åœ°å›¾èƒŒæ™¯ -->
    <div id="map-container"></div>
    <div id="map-updated-at" class="fixed bottom-3 right-3 text-[10px] text-zinc-500 font-mono z-[5] pointer-events-none" style="display:none;"></div>
    <!-- åœ°å›¾å…‰æ ‡å·¥å…·ï¼šç”¨äºæ‰‹åŠ¨æ ¡å‡†ï¼ˆé¿å…å…‰æ ‡æ¶ˆå¤±æ—¶æ— æ³•è¿›å…¥æ ¡å‡†ï¼‰ -->
    <div id="map-cursor-tools" aria-live="polite">
        <button type="button" id="btn-anchor-location" class="tool-btn">
            <span style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#3b82f6;"></span>
            <span id="btn-anchor-location-text">å®šä½é”šç‚¹</span>
        </button>
        <button type="button" id="btn-country-selector" class="tool-btn">
            <span style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#8b5cf6;"></span>
            <span>èº«ä»½è®¾ç½®</span>
        </button>
        <button type="button" id="btn-calibrate-location" class="tool-btn">
            <span style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#00ff41;"></span>
            <span id="btn-calibrate-location-text">æ ¡å‡†ä½ç½®</span>
        </button>
        <button type="button" id="btn-reset-location" class="tool-btn" style="display: none;">
            <span style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#ef4444;"></span>
            <span>é€€å‡ºé”šå®š</span>
        </button>
        <div id="map-cursor-hint" class="hint">
            <div><b>æ ¡å‡†æ¨¡å¼</b>ï¼šæ‹–åŠ¨åœ°å›¾ä¸Šçš„ <b>YOU</b> å…‰æ ‡ï¼Œæˆ–ç‚¹å‡»åœ°å›¾ä»»æ„ä½ç½®è®¾ç½®åæ ‡ã€‚</div>
            <div style="margin-top:6px;">å®Œæˆåä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬æœºä¸åç«¯ï¼ˆ`manual_lat/manual_lng/manual_location`ï¼‰ã€‚</div>
            <div style="margin-top:6px; opacity:0.9;">æç¤ºï¼šä½ ä¹Ÿå¯ä»¥å…ˆç‚¹å‡»å›½å®¶æ¥è®¾ç½®â€œé”šå®šå›½å®¶â€ï¼Œå†æ ¡å‡†åæ ‡ã€‚</div>
        </div>
        <div id="map-anchor-hint" class="hint">
            <div><b>é”šå®šæ¨¡å¼</b>ï¼šç‚¹å‡»åœ°å›¾ä»»æ„ä½ç½®ï¼Œå…‰æ ‡ç«‹å³ç§»åŠ¨åˆ°è¯¥åæ ‡ï¼Œå¹¶åœæ­¢æ‰€æœ‰åŸºäº IP çš„è‡ªåŠ¨é‡å†™ã€‚</div>
            <div style="margin-top:6px;">åæ ‡å°†æŒä¹…åŒ–ä¿å­˜ï¼Œå¹¶ç»‘å®šåˆ°ä½ çš„ GitHub è´¦å·ã€‚</div>
        </div>
    </div>
    
    <!-- å›½å®¶é€‰æ‹©å™¨æµ®çª— -->
    <div id="country-selector-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 200; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); pointer-events: auto;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; max-height: 80vh; background: rgba(5, 5, 5, 0.95); border: 1px solid rgba(0, 255, 65, 0.45); border-radius: 4px; padding: 20px; overflow: hidden; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="color: #00ff41; font-family: 'JetBrains Mono', monospace; font-size: 14px; margin: 0;">èº«ä»½è®¾ç½®</h3>
                <button id="country-selector-close" style="background: none; border: none; color: #00ff41; font-size: 20px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;" title="å…³é—­">âœ•</button>
            </div>
            <input type="text" id="country-search-input" placeholder="æœç´¢å›½å®¶..." style="width: 100%; padding: 8px 12px; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(0, 255, 65, 0.3); color: #00ff41; font-family: 'JetBrains Mono', monospace; font-size: 12px; margin-bottom: 12px; outline: none;">
            <div id="country-list-container" style="flex: 1; overflow-y: auto; max-height: calc(80vh - 120px);">
                <!-- å›½å®¶åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </div>
    <script>
    // ã€å¼ºåˆ¶é€‰ç±æ‹¦æˆªã€‘DOMContentLoaded æœ€å¼€å§‹ï¼šæ—  user_country_fixed åˆ™å…¨å±å›½ç±é€‰æ‹©å¼¹çª—å¹¶é”å®šæ»šåŠ¨ï¼Œæœ‰åˆ™è®¾ currentCountryCode åˆå§‹åŒ–
    (function() {
        function closeCountryPickerModal() {
            var modal = document.getElementById('country-selector-modal');
            if (modal) modal.style.display = 'none';
            try { document.body.style.overflow = ''; document.documentElement.style.overflow = ''; } catch (e) {}
        }
        document.addEventListener('click', function(e) {
            var btn = e.target && (e.target.id === 'country-selector-close' || (e.target.closest && e.target.closest('#country-selector-close')));
            if (btn) { closeCountryPickerModal(); }
        });
        function run() {
            var fixed = null;
            try { fixed = localStorage.getItem('user_country_fixed'); } catch (e) {}
            if (fixed && fixed.length >= 2) {
                try { window.currentCountryCode = String(fixed).trim().toUpperCase(); } catch (e) {}
                return;
            }
            var modal = document.getElementById('country-selector-modal');
            if (modal) {
                modal.style.display = 'block';
                modal.style.position = 'fixed';
                modal.style.top = '0'; modal.style.left = '0'; modal.style.right = '0'; modal.style.bottom = '0';
                modal.style.zIndex = '200';
                try { document.body.style.overflow = 'hidden'; document.documentElement.style.overflow = 'hidden'; } catch (e) {}
                window.__countryPickerForced = true;
            }
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', run);
        } else {
            run();
        }
    })();
    </script>
    
    <!-- ç”¨æˆ·è¯¦æƒ…æµ®å±‚ï¼ˆé¢„ç•™åœ¨ HTML ä¸­ï¼Œç”±äº‹ä»¶å§”æ‰˜æ‰“å¼€ï¼›å†…å®¹å¯ç”± JS å¡«å……ï¼‰ -->
    <div id="user-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 180; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; pointer-events: auto;">
        <div class="user-modal-content" style="background: rgba(5, 5, 5, 0.95); border: 1px solid rgba(0, 255, 65, 0.45); border-radius: 8px; padding: 24px; max-width: 90%; max-height: 85vh; overflow: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="color: #00ff41; font-family: 'JetBrains Mono', monospace; font-size: 14px; margin: 0;">ç”¨æˆ·è¯¦æƒ…</h3>
                <button type="button" id="user-modal-close" style="background: none; border: none; color: #00ff41; font-size: 20px; cursor: pointer;">âœ•</button>
            </div>
            <div id="user-modal-body"><!-- ç”± JS å¡«å…… --></div>
        </div>
    </div>
    <script>
    // äº‹ä»¶å§”æ‰˜ï¼šå¤´åƒç‚¹å‡»æ‰“å¼€ user-modalï¼Œé¿å…åŠ¨æ€èŠ‚ç‚¹ç»‘å®šå¤±æ•ˆ
    document.addEventListener('click', function(e) {
        var avatarTrigger = e.target.closest('.user-avatar-trigger');
        if (avatarTrigger) {
            var modal = document.getElementById('user-modal');
            if (modal) modal.classList.remove('hidden');
        }
    });
    document.addEventListener('DOMContentLoaded', function() {
        var closeBtn = document.getElementById('user-modal-close');
        var modal = document.getElementById('user-modal');
        if (closeBtn && modal) {
            closeBtn.addEventListener('click', function() { modal.classList.add('hidden'); });
            modal.addEventListener('click', function(ev) { if (ev.target === modal) modal.classList.add('hidden'); });
        }
    });
    </script>
    
    <!-- å·¦å³èµ›åšæœ‹å…‹æŠ½å±‰ -->
    <div id="left-drawer" class="cyber-drawer left-drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <div class="drawer-title">
                    <span class="drawer-icon">âš¡</span>
                    <span class="drawer-title-text" id="left-drawer-title">å›½å®¶æ•°æ®</span>
                </div>
                <div class="drawer-close-btn" onclick="closeDrawers()">âœ•</div>
            </div>
            <!-- å›½å®¶é€‰æ‹©èœå•åŒºåŸŸ -->
            <div id="left-drawer-country-selector" style="
                padding: 16px 20px;
                border-bottom: 1px solid rgba(0, 255, 65, 0.2);
                background: rgba(0, 255, 65, 0.03);
                position: relative;
                z-index: 2;
            ">
                <div style="
                    font-size: 11px;
                    color: rgba(0, 255, 65, 0.8);
                    font-family: 'JetBrains Mono', monospace;
                    font-weight: 700;
                    margin-bottom: 8px;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                " class="lang-key" data-key="select-country" data-t="select-country">é€‰æ‹©å›½å®¶</div>
                <input 
                    type="text" 
                    id="left-drawer-country-search" 
                    placeholder="" 
                    style="
                        width: 100%;
                        padding: 8px 12px;
                        background: rgba(0, 0, 0, 0.6);
                        border: 1px solid rgba(0, 255, 65, 0.4);
                        color: #00ff41;
                        font-family: 'JetBrains Mono', monospace;
                        font-size: 12px;
                        outline: none;
                        margin-bottom: 8px;
                        border-radius: 2px;
                        box-shadow: 0 0 8px rgba(0, 255, 65, 0.2);
                        transition: all 0.2s;
                    "
                    data-placeholder-zh="æœç´¢å›½å®¶..."
                    data-placeholder-en="Search countries..."
                />
                <div 
                    id="left-drawer-country-list" 
                    class=""
                    style="
                        background: rgba(0, 0, 0, 0.3);
                    "
                >
                    <!-- å›½å®¶åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€å¡«å……ï¼Œé»˜è®¤æ”¶èµ·ï¼Œç‚¹å‡»æœç´¢æ¡†åå±•å¼€ -->
                </div>
            </div>
            <div class="drawer-body" id="left-drawer-body">
                <!-- å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€å¡«å…… -->
                <!-- çŸ©é˜µç»¿å¤©æ¢¯æ¦œåŒºåŸŸï¼ˆé™æ€æŒ‚è½½ï¼‰ -->
                <div id="global-ranking-area" class="mt-8 space-y-6 block"></div>
            </div>
        </div>
    </div>
    
    <div id="right-drawer" class="cyber-drawer right-drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <div class="drawer-title">
                    <span class="drawer-icon">ğŸ”</span>
                    <span class="drawer-title-text" id="right-drawer-title" data-i18n="drawer.details">è¯¦ç»†ä¿¡æ¯</span>
                </div>
                <div class="drawer-close-btn" onclick="closeDrawers()">âœ•</div>
            </div>
            
            <!-- ã€æ–°å¢ã€‘Tab å¯¼èˆªæ  -->
            <div class="drawer-tabs" id="right-drawer-tabs">
                <button type="button" class="drawer-tab active" data-tab="ranking" onclick="switchView('ranking')">
                    <span class="tab-icon">ğŸ†</span>
                    <span class="tab-text" data-t="tab.ranking" data-i18n="tab.ranking">æ’è¡Œæ¦œ</span>
                </button>
                <button type="button" class="drawer-tab" data-tab="global" onclick="switchView('global')">
                    <span class="tab-icon">ğŸŒ</span>
                    <span class="tab-text" data-t="tab.global" data-i18n="tab.global">å…¨çƒ</span>
                </button>
                <button type="button" class="drawer-tab" data-tab="country" onclick="switchView('country')">
                    <span class="tab-icon">ğŸ°</span>
                    <span class="tab-text" data-t="tab.country" data-i18n="tab.country">å›½å®¶</span>
                </button>
            </div>
            
            <div class="drawer-body" id="right-drawer-body">
                <!-- ã€é‡æ„ã€‘å…¨çƒè§†å›¾ -->
                <div id="panel-global-view" class="right-drawer-panel flex flex-col h-full overflow-y-auto">
                    <div id="panel-global-content" class="flex-1 flex flex-col gap-4 min-h-0 p-4">
                        <!-- å…¨çƒè§†å›¾å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€å¡«å…… -->
                        <div class="text-zinc-500 text-xs text-center py-8">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                
                <!-- ã€é‡æ„ã€‘å›½å®¶è§†å›¾ -->
                <div id="panel-country-view" class="right-drawer-panel hidden flex-col h-full overflow-y-auto">
                    <div class="flex items-center gap-2 mb-4 px-4 pt-4">
                        <button type="button" id="refreshCountryBtn" onclick="refreshCountryRightPanel()" class="px-3 py-1.5 text-xs border border-[#00ff41]/50 text-[#00ff41] hover:bg-[#00ff41]/10 transition-colors" data-t="btn.refresh" data-i18n="btn.refresh">åˆ·æ–°</button>
                    </div>
                    <div id="countryTemplateMount" class="flex-1 min-h-0 px-4 pb-4" style="font-family: 'JetBrains Mono', monospace;"></div>
                </div>
                
                <!-- ã€æ–°å¢ã€‘æ’è¡Œæ¦œè§†å›¾ - å…­ä¸ªå…¨çƒæ’è¡Œæ¦œå¡ç‰‡ + é«˜åˆ†å›¾è°± -->
                <div id="panel-ranking-view" class="right-drawer-panel hidden flex-col h-full overflow-y-auto">
                    <div id="panel-ranking-content" class="flex-1 flex flex-col gap-4 min-h-0 p-4">
                        <div class="flex justify-end mb-1">
                            <button type="button" onclick="var f=window.renderGlobalLadders||window.renderGreenLadders; if(f) f(f===window.renderGlobalLadders?undefined:true); else location.reload();" class="ranking-refresh-btn" data-t="ranking.refresh">åˆ·æ–°</button>
                        </div>
                        <div id="view-ranking">
                            <div id="ladders-container">
                                <!-- å…­ä¸ªå…¨çƒæ’è¡Œæ¦œå¡ç‰‡ - renderGlobalLadders ä¼šå†™å…¥æ­¤å¤„æˆ–å…¶å­èŠ‚ç‚¹ global-ranking-grids -->
                                <div id="global-ranking-grids" class="industrial-ranking-grid flex flex-col gap-3"></div>
                            </div>
                            <!-- é«˜åˆ†å›¾è°±å®¹å™¨ - drawHighScores å‡½æ•°ä¼šåœ¨æ­¤æ¸²æŸ“6ä¸ªæ’è¡Œæ¦œ -->
                            <div class="vibe-index-leaderboard space-y-4">
                                <!-- å¡ç‰‡å°†ç”± JavaScript åŠ¨æ€æ¸²æŸ“ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="scanLine" class="scan-line" aria-hidden="true"></div>
    <!-- right.html æ¨¡æ¿ï¼šç”¨äºå›½å®¶é€è§†å³ä¾§æŠ½å±‰ï¼ˆç¾å›½ï¼‰ -->
    <template id="rightDrawerTemplate">
        <div class="country-panel-template">
            <div class="report-container">
                <!-- HEADER -->
                <div class="mb-8 border-b-2 border-white pb-4">
                    <div class="flex justify-between items-start">
                        <h1 class="text-2xl font-black italic tracking-tighter" id="rtPanelTitle" data-t="panel.country_panel" data-i18n="panel.country_panel">å›½å®¶é€è§†</h1>
                        <div class="status-tag" id="rtStatusTag" data-i18n="panel.live_feed">å®æ—¶æ•°æ®</div>
                    </div>
                    <div class="mt-3">
                        <span id="rtMeritBoard" class="inline-block text-[11px] text-[var(--accent-terminal)] border border-[var(--accent-terminal)]/40 bg-[var(--accent-terminal)]/5 px-2 py-1">
                            å·²ç´¯è®¡åˆ†æ -- ä¸‡å­—
                        </span>
                        <span id="rtJiafangCount" class="ml-2 text-[10px] text-zinc-400" title="åŠ æ–¹è¯æ•°">--</span>
                        <span id="rtKetaoCount" class="ml-2 text-[10px] text-zinc-400" title="å®¢å¥—è¯æ•°">--</span>
                        <span id="rtWorkDays" class="ml-2 text-[10px] text-zinc-400" title="å·¥ä½œå¤©æ•°">--</span>
                    </div>
                    <div class="text-[11px] mt-3 text-zinc-500 flex justify-between uppercase">
                        <span id="rtCoord">åæ ‡ï¼š--</span>
                        <span id="rtDataStatus">æ•°æ®ï¼šç¨³å®š</span>
                    </div>
                </div>

                <!-- [01] MACRO SCALE -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="globe"></i>
                        <span class="card-title" data-t="panel.stats" data-i18n="panel.stats">ç»Ÿè®¡</span>
                    </div>
                    <div class="flex justify-between items-center mb-8">
                        <div class="text-5xl" id="rtFlag">ğŸ³ï¸</div>
                        <div class="text-right">
                            <div class="metric-value" id="rtNodeName">--</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div id="rtUsersCard">
                            <div class="metric-label" data-t="panel.dev_scale" data-i18n="panel.dev_scale">å¼€å‘è€…è§„æ¨¡</div>
                            <div class="metric-value" id="rtDiagnosedTotal">--</div>
                        </div>
                        <div id="rtAnalysisCard">
                            <div class="metric-label" data-t="panel.scan_count" data-i18n="panel.scan_count">è¯Šæ–­æ¬¡æ•°</div>
                            <div class="metric-value" id="rtScanTotal">--</div>
                        </div>
                    </div>
                </div>

                <!-- [01.5] RADAR -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="target"></i>
                        <span class="card-title" data-t="panel.radar" data-i18n="panel.radar">å¼€å‘è€…ç”»åƒ</span>
                    </div>
                    <div id="rtRadar" style="height: 260px; width: 100%;"></div>
                </div>

                <!-- [01.6] LIVE FEED -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="radio"></i>
                        <span class="card-title" data-t="panel.personality_distribution" data-i18n="panel.personality_distribution">äººæ ¼åˆ†å¸ƒ</span>
                    </div>
                    <div id="rtRealtimeList" class="space-y-3 text-[11px] leading-snug"></div>
                </div>

                <!-- [01.7] COUNTRY TOTALS -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="bar-chart-3"></i>
                        <span class="card-title" data-t="panel.country_totals" data-i18n="panel.country_totals">å›½å®¶ç´¯è®¡</span>
                    </div>
                    <div id="rtCountryTotals" class="space-y-2 text-[11px] leading-snug"></div>
                </div>

                <!-- [01.8] MY COUNTRY RANK -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="trophy"></i>
                        <span class="card-title" data-t="panel.my_country_rank" data-i18n="panel.my_country_rank">æˆ‘çš„æ’å</span>
                    </div>
                    <div id="rtMyCountryRanks" class="space-y-2 text-[11px] leading-snug"></div>
                </div>

                <!-- [02] POWER STRUGGLE (PK) -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="swords"></i>
                        <span class="card-title" data-t="panel.qa_attitude">é—®ç­”æ€åº¦</span>
                    </div>
                    <div class="space-y-5">
                        <div class="flex justify-between text-[11px] font-bold uppercase">
                            <span class="text-white" id="rtPkLeftLabel">å‚²å¨‡</span>
                            <span class="text-[var(--accent-terminal)]" id="rtPkRightLabel">è·ªèˆ”</span>
                        </div>
                        <div class="pk-track">
                            <div class="pk-divider"></div>
                            <div class="pk-left" id="rtPkLeftFill" style="width: 50%;"></div>
                            <div class="pk-right" id="rtPkRightFill" style="width: 50%;"></div>
                        </div>
                        <div class="flex justify-between text-[16px] font-bold">
                            <span>
                                <span class="text-[10px] text-zinc-500 mr-2" data-t="pk.domineering">éœ¸é“å€¼</span>
                                <span id="rtPkLeftPct">50.0%</span>
                            </span>
                            <span class="text-[var(--accent-terminal)]">
                                <span class="text-[10px] text-zinc-500 mr-2" data-t="pk.bootlick">è·ªèˆ”å€¼</span>
                                <span id="rtPkRightPct">50.0%</span>
                            </span>
                        </div>
                        <div>
                            <div class="flex justify-between items-center text-[11px]">
                                <span class="text-zinc-500 uppercase tracking-widest" data-i18n="panel.pk_power">æƒåŠ›å€¼</span>
                                <span class="text-white font-bold" id="rtPowerScore">--</span>
                            </div>
                            <div class="mt-2 h-1 bg-zinc-800 w-full overflow-hidden">
                                <div id="power-bar" class="h-full bg-white" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="p-3 bg-zinc-900 border-l-2 border-white text-xs leading-relaxed italic text-zinc-300" id="rtPkQuote" style="display:none"></div>
                    </div>
                </div>

                <!-- [03] EMOTIONAL AUDIT -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="activity"></i>
                        <span class="card-title" data-t="panel.meltdown_audit">ç ´é˜²ç›‘æµ‹</span>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <div class="flex justify-between items-end">
                                <div class="metric-label" data-t="panel.meltdown_index">ç ´é˜²æŒ‡æ•°</div>
                                <div class="text-sm font-bold" id="rtBreakdownRate">--</div>
                            </div>
                            <div class="stat-bar-container">
                                <div class="stat-bar-fill" id="breakdown-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-6">
                            <div class="bg-zinc-900 p-3 border border-zinc-800">
                                <div class="metric-label" data-t="panel.meltdown_level">ç ´é˜²ç­‰çº§</div>
                                <div class="text-white font-bold text-lg" id="rtMeltdownLevel">--</div>
                            </div>
                            <div class="bg-zinc-900 p-3 border border-zinc-800">
                                <div class="metric-label" data-t="panel.meltdown_victims">å—è™äººæ•°</div>
                                <div class="text-[var(--accent-terminal)] font-bold text-lg" id="rtMeltdownVictims">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- [04] SEMANTIC BURST -->
                <div class="clinic-card" id="vibe-explosion-card">
                    <div class="card-header">
                        <i data-lucide="cloud"></i>
                        <span class="card-title" data-t="panel.wordcloud">æœ¬å›½è¯äº‘</span>
                        <div class="ml-auto flex items-center gap-3"></div>
                    </div>
                    <div class="p-2" id="rtSemanticTags">
                        <!-- é»‘è¯æ¦œï¼šæŒ‰å›½å®¶èšåˆï¼ˆTop10 + Cloud50ï¼‰ -->
                        <div class="bg-zinc-950/60 border border-zinc-800 p-2 mb-4" id="vibe-burst-root">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-[11px] text-zinc-400 uppercase tracking-widest" data-t="hotlist.title">é»‘è¯æ¦œ</div>
                                <div class="text-[10px] text-zinc-500" id="vibe-country-hint">å›½å®¶ï¼š--</div>
                            </div>

                            <!-- ä¸Šæ–¹ï¼šè¯¥å›½ Top50 è¯äº‘å½¢æ€ï¼ˆç»¼åˆï¼‰ -->
                            <div class="border border-white/10 bg-zinc-950/30 p-2 mb-3">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-[10px] text-zinc-500 uppercase tracking-widest" data-i18n="panel.national_cloud_50">æœ¬å›½è¯äº‘ 50</div>
                                    <div class="text-[10px] text-zinc-600 font-mono" id="vibe-cloud50-meta">--</div>
                                </div>
                                <div id="vibe-cloud50-container" style="height: 260px; width: 100%;"></div>
                                <div id="vibe-cloud50-empty" class="hidden text-zinc-500 text-sm p-3 italic" data-t="hotlist.building">
                                    æ­£åœ¨å»ºç«‹è¯¥åœ°åŒºé»‘è¯æ¦œ...
                                </div>
                            </div>

                            <!-- ä¸‹æ–¹ï¼šæ–‡å­—æ¦œå•ï¼ˆåˆ†ç±»è¯åº“ Top 10ï¼ŒTab åˆ‡æ¢åŠŸå¾·ç°¿/é»‘è¯/å£å¤´ç¦…ï¼‰ -->
                            <div class="border border-white/10 bg-zinc-950/30 p-2">
                                <div class="flex items-center justify-between mb-2">
                                    <div id="vibe-top10-title" class="text-[10px] text-zinc-500 uppercase tracking-widest" data-i18n="panel.country_top_10">æœ¬å›½ Prompt é«˜é¢‘è¯ç»„ Top 10</div>
                                    <div class="text-[10px] text-zinc-600 font-mono" id="vibe-country-top10-meta">--</div>
                                </div>
                                <div id="vibe-lexicon-tabs" class="flex gap-1 mb-2">
                                    <button type="button" class="vibe-lexicon-tab px-2 py-1 text-[10px] rounded border border-white/20 bg-[var(--accent-terminal)]/20 text-[var(--accent-terminal)] font-medium" data-type="merit_board" data-t="lexicon.merit">åŠŸå¾·ç°¿</button>
                                    <button type="button" class="vibe-lexicon-tab px-2 py-1 text-[10px] rounded border border-white/10 bg-transparent text-zinc-400 hover:bg-white/5" data-type="slang_list" data-t="lexicon.slang">è¡Œä¸šé»‘è¯</button>
                                    <button type="button" class="vibe-lexicon-tab px-2 py-1 text-[10px] rounded border border-white/10 bg-transparent text-zinc-400 hover:bg-white/5" data-type="mantra_top" data-t="lexicon.mantra">å…¨æ°‘å£å¤´ç¦…</button>
                                </div>
                                <ol id="vibe-top10-list" class="space-y-1"></ol>
                                <div id="vibe-top10-empty" class="hidden text-zinc-500 text-sm p-3 italic" data-t="hotlist.collecting">
                                    æš‚æ— æ•°æ®ï¼ˆæ­£åœ¨æ”¶å½•ä¸­...ï¼‰
                                </div>
                            </div>

                        </div>
                        <div class="text-xs text-zinc-300 mb-3" id="rtCoreTrait" data-t="semantic.core_trait_empty">è¯¥åœ°åŒºæ ¸å¿ƒç‰¹è´¨ï¼š--</div>
                        <div class="flex justify-between items-center text-[11px]">
                            <span class="text-zinc-500 uppercase tracking-widest" data-i18n="panel.semantic_label">è¯­ä¹‰</span>
                            <span class="text-[var(--accent-terminal)] font-bold" id="rtSemanticScore">--</span>
                        </div>
                        <div class="mt-2 h-1 bg-zinc-800 w-full overflow-hidden">
                            <div id="semantic-bar" class="h-full bg-[#00ff41]" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-zinc-800 flex justify-between text-[11px]">
                        <span class="text-zinc-500" id="rtSemanticMostUsed">æœ€å¸¸ç”¨ï¼š--</span>
                        <span class="text-[var(--accent-terminal)]" id="rtSemanticFreq">é¢‘æ¬¡ï¼š--</span>
                    </div>
                </div>

                <!-- [05] ELITE RANKING -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="users"></i>
                        <span class="card-title" data-t="panel.lpdef_ranking">é«˜åˆ†å›¾è°±</span>
                    </div>
                    <div id="rtTopTalentsHeroes" class="flex flex-wrap gap-2 mb-3"></div>
                    <div class="scrolling-wrapper" id="rtEliteList">
                        <div id="rtTopTalentsList" class="vibe-index-leaderboard space-y-2"></div>
                    </div>
                    <div class="text-[10px] text-zinc-500 mt-2 text-center uppercase tracking-tighter" id="rtEliteHint" data-i18n="panel.elite_hint">
                        å·¦æ»‘æŸ¥çœ‹é«˜åˆ†å›¾è°±
                    </div>
                </div>

                <!-- [06] GLOBAL SHARE -->
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="pie-chart"></i>
                        <span class="card-title" data-t="panel.global_ratio">å…¨çƒå æ¯”</span>
                    </div>
                    <div class="chart-container">
                        <div id="rtGlobalRatioPie" style="width: 200px; height: 200px;"></div>
                    </div>
                    <div class="mt-3">
                        <div class="flex justify-between items-center text-[11px]">
                            <span class="text-zinc-500 uppercase tracking-widest" data-i18n="panel.ratio_label">å æ¯”</span>
                            <span class="text-[var(--accent-terminal)] font-bold" id="rtRatioPct">--</span>
                        </div>
                        <div class="mt-2 h-1 bg-zinc-800 w-full overflow-hidden">
                            <div id="ratio-bar" class="h-full bg-white" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="mt-2 text-[11px] text-zinc-400">
                        <span class="text-zinc-500" data-i18n="panel.global_ratio_label">å…¨çƒå æ¯”ï¼š</span>
                        <span id="rtGlobalRatio" class="text-[var(--accent-terminal)] font-bold">--</span>
                    </div>
                    <div class="space-y-2 mt-2" id="rtRatioList"></div>
                </div>
            </div>
        </div>
    </template>
    <div class="max-w-[1600px] mx-auto relative z-10">
        <!-- Main Dashboard Layout -->
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
            
            <!-- Side Panel: Core Metrics (å·¦ä¾§) - å·²ç§»è‡³æŠ½å±‰ï¼Œéšè— -->
            <div class="xl:col-span-3 flex flex-col gap-4 order-2 xl:order-1 items-start" style="display: none;">
                <!-- ç»Ÿè®¡å¡ç‰‡å·²ç§»è‡³å³è¾¹æŠ½å±‰ï¼Œéšè—åŸå®¹å™¨ -->
                <div class="hacker-border p-6 rounded-sm stat-card" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-victims">å·²è¯Šæ–­å¼€å‘è€…</div>
                    <div id="totalUsers" class="text-4xl font-bold text-[var(--accent-terminal)]">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">USERS_RECOGNIZED_SUCCESSFULLY</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-analysis">å…¨ç½‘æ‰«ææ¬¡æ•°</div>
                    <div id="totalAnalysis" class="text-4xl font-bold">0</div>
                    <div class="mt-4 text-[9px] text-zinc-600 font-mono">TOTAL_SCAN_COUNT</div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest lang-key" data-key="total-roast">ç´¯è®¡åæ§½å­—æ•°</div>
                    <div id="totalChars" class="text-4xl font-bold">0</div>
                    <div class="mt-4 h-1 bg-zinc-800 w-full overflow-hidden">
                        <div class="bg-[var(--accent-terminal)] h-full w-[65%]"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 stat-card" style="display: none;">
                    <div class="hacker-border p-4 rounded-sm bg-zinc-900/50">
                        <div class="text-zinc-500 text-[10px] uppercase tracking-tighter mb-1">Avg Words / äººå‡å¹³å‡ç¯‡å¹…</div>
                        <div id="avgPerUser" class="text-2xl font-bold font-mono text-[var(--accent-terminal)]">0</div>
                        <div class="text-[9px] text-zinc-600 mt-1 uppercase">Per Developer Basis</div>
                    </div>
                    
                    <div class="hacker-border p-4 rounded-sm bg-zinc-900/50">
                        <div class="text-zinc-500 text-[10px] uppercase tracking-tighter mb-1">Scan Words / å•æ¬¡å¹³å‡ç¯‡å¹…</div>
                        <div id="avgPerScan" class="text-2xl font-bold font-mono text-[var(--accent-terminal)]">0</div>
                        <div class="text-[9px] text-zinc-600 mt-1 uppercase">Per Analysis Basis</div>
                    </div>
                </div>

                <div class="hacker-border p-6 rounded-sm stat-card bg-zinc-900/40" style="display: none;">
                    <div class="text-[10px] text-zinc-500 mb-4 uppercase tracking-widest lang-key" data-key="radar-title">å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒ</div>
                    <div class="aspect-square">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Central Map Area (ä¸­é—´) - åœ°å›¾å·²ç§»è‡³å…¨å±èƒŒæ™¯ï¼Œæ­¤åŒºåŸŸå·²ç§»é™¤ -->
            <!-- ç»´åº¦æ’åå¡ç‰‡å®¹å™¨ï¼šå·²ç§»è‡³æŠ½å±‰æ˜¾ç¤º -->
            <div id="rank-cards-container" style="display: none;">
                <!-- å¡ç‰‡å·²ç§»è‡³æŠ½å±‰æ˜¾ç¤º -->
            </div>
        </div>

        <!-- Secondary Charts & Logs (å³ä¾§) - å·²ç§»è‡³æŠ½å±‰ï¼Œéšè—åŸå®¹å™¨ -->
        <div class="xl:col-span-3 grid grid-cols-1 gap-6 mt-6 items-start" style="display: none;">
            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="hot-list">åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ</h3>
                <div id="locationList" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="personality-dist">äººæ ¼åˆ†å¸ƒæ’è¡Œ</h3>
                <div id="personalityDistribution" class="space-y-3">
                    <div class="animate-pulse space-y-2">
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                        <div class="h-8 bg-zinc-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="hacker-border p-6 rounded-sm flex flex-col">
                <h3 class="text-xs font-bold text-zinc-400 mb-6 uppercase tracking-widest lang-key" data-key="recent-activity">å®æ—¶è¯Šæ–­æ´»åŠ¨</h3>
                <div id="recentActivity" class="flex-1 overflow-y-auto max-h-[300px] text-[10px] font-mono space-y-4 pr-2">
                    <!-- Logs here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ‚¬æµ®æŠ½å±‰å¼åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
    <div id="private-inbox-drawer">
        <div class="inbox-header">
            <span class="inbox-title">ç§ä¿¡æ”¶ä»¶ç®±</span>
            <button type="button" class="inbox-close" onclick="closeInboxDrawer()">âœ•</button>
        </div>
        <div class="inbox-body" id="inbox-body">
            <div class="text-zinc-500 text-center py-8 text-xs">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div id="live-nodes-drawer" class="live-nodes-drawer expanded">
        <div class="live-nodes-header" onclick="toggleDrawer()">
            <div class="flex items-center gap-3">
                <span class="text-[10px] text-zinc-500 uppercase tracking-widest lang-key" data-key="active-nodes">Live Nodes</span>
                <span id="online-count-badge" class="w-2 h-2 bg-[var(--accent-terminal)] rounded-full pulse"></span>
                <span id="online-count-text" class="text-xs font-bold text-[var(--accent-terminal)]">0</span>
            </div>
            <svg class="chevron-icon w-4 h-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
        </div>
        <div class="live-nodes-content">
            <div id="online-users-list" class="p-4 space-y-2">
                <div class="text-zinc-500 text-center py-4 text-[10px]">Scanning for nearby nodes...</div>
            </div>
        </div>
    </div>

    <script>
        // ä½¿ç”¨ var ç¡®ä¿ä¸ stats2.app.js å…¼å®¹
        var calibrationDebounceTimer = typeof calibrationDebounceTimer !== 'undefined' ? calibrationDebounceTimer : null;

        // é«˜åˆ†å›¾è°±å…¨å±€ï¼šå®¹å™¨æ˜¾ç¤º + æ¦œå•æ¸²æŸ“ï¼ˆå¯è¢«å…¨å±€è®¿é—®ï¼‰
        function ensureLeaderboardParentVisible(containerEl) {
            if (!containerEl) return;
            var wrapper = containerEl.closest('.scrolling-wrapper');
            var card = containerEl.closest('.clinic-card');
            [wrapper, card].forEach(function (el) {
                if (el) { el.classList.remove('hidden'); el.style.removeProperty('display'); }
            });
        }

        function drawHighScores(topBy, containerSelector) {
            window.drawHighScores = drawHighScores;
            var _resolveUserMeta = window.__resolveUserMeta;
            if (typeof _resolveUserMeta !== 'function') {
                _resolveUserMeta = function (r) {
                    var u = (r && (r.user_name || r.userName || r.username || r.user)) ? String(r.user_name || r.userName || r.username || r.user).trim() : '';
                    var gh = (r && (r.github_username || r.githubUsername || r.gh || r.github)) ? String(r.github_username || r.githubUsername || r.gh || r.github).trim() : '';
                    var display = (gh || u) ? '@' + (gh || u) : (typeof currentLang !== 'undefined' && currentLang === 'en' ? 'unknown' : 'æœªçŸ¥');
                    var avatar = gh ? 'https://github.com/' + encodeURIComponent(gh) + '.png?size=64' : (typeof DEFAULT_AVATAR !== 'undefined' ? DEFAULT_AVATAR : '');
                    var profileUrl = gh ? 'https://github.com/' + encodeURIComponent(gh) : '';
                    return { display: display, avatar: avatar || '', profileUrl: profileUrl };
                };
            }
            // ã€é‡æ„ã€‘æ”¯æŒä¼ å…¥å®¹å™¨é€‰æ‹©å™¨ï¼Œä¼˜å…ˆä½¿ç”¨æ–°çš„ä¸‰è§†å›¾ç»“æ„
            var container;
            if (containerSelector) {
                container = document.querySelector(containerSelector);
                console.log('[drawHighScores] ä½¿ç”¨æŒ‡å®šå®¹å™¨:', containerSelector, container);
            } else {
                // ã€é‡æ„ã€‘ä¼˜å…ˆå°è¯•åœ¨æ–°çš„ä¸‰è§†å›¾ç»“æ„ä¸­æŸ¥æ‰¾å®¹å™¨
                var rankingContainer = document.querySelector('#panel-ranking-view .vibe-index-leaderboard') || 
                                       document.querySelector('#panel-ranking-content .vibe-index-leaderboard');
                var globalContainer = document.querySelector('#panel-global-view .vibe-index-leaderboard') || 
                                     document.querySelector('#panel-global-content .vibe-index-leaderboard');
                var countryContainer = document.querySelector('#panel-country-view .vibe-index-leaderboard') || 
                                      document.querySelector('#countryTemplateMount .vibe-index-leaderboard');
                
                // å…¼å®¹æ—§å®¹å™¨ï¼ˆpanel-global-view ä¸ panel-global-content å·²åœ¨ä¸Šæ–¹æŸ¥æ‰¾ï¼‰
                var oldGlobalContainer = document.querySelector('#panel-global-view .vibe-index-leaderboard');
                var oldCountryContainer = document.querySelector('#panel-country-detail .vibe-index-leaderboard');
                
                console.log('[drawHighScores] å®¹å™¨æŸ¥æ‰¾:', { 
                    currentViewState: currentViewState, 
                    rankingContainerFound: !!rankingContainer,
                    globalContainerFound: !!globalContainer, 
                    countryContainerFound: !!countryContainer,
                    oldGlobalContainerFound: !!oldGlobalContainer,
                    oldCountryContainerFound: !!oldCountryContainer
                });
                
                // ã€é‡æ„ã€‘ä¼˜å…ˆæ ¹æ®è§†å›¾çŠ¶æ€é€‰æ‹©å®¹å™¨
                var rankingPanel = document.getElementById('panel-ranking-view');
                var isRankingVisible = rankingPanel && !rankingPanel.classList.contains('hidden');
                var globalPanel = document.getElementById('panel-global-view');
                var isGlobalVisible = globalPanel && !globalPanel.classList.contains('hidden');
                var countryPanel = document.getElementById('panel-country-view');
                var isCountryVisible = countryPanel && !countryPanel.classList.contains('hidden');
                
                if ((currentViewState === 'RANKING' || isRankingVisible) && rankingContainer) {
                    container = rankingContainer;
                    console.log('[drawHighScores] âœ… ä½¿ç”¨ Ranking æ’è¡Œæ¦œè§†å›¾å®¹å™¨');
                } else if ((currentViewState === 'GLOBAL' || isGlobalVisible) && globalContainer) {
                    container = globalContainer;
                    console.log('[drawHighScores] âœ… ä½¿ç”¨ Global å…¨çƒè§†å›¾å®¹å™¨');
                } else if ((currentViewState === 'COUNTRY' || isCountryVisible) && countryContainer) {
                    container = countryContainer;
                    console.log('[drawHighScores] âœ… ä½¿ç”¨ Country å›½å®¶è§†å›¾å®¹å™¨');
                } else {
                    // é™çº§é€‰æ‹©ï¼šä¼˜å…ˆä½¿ç”¨æ–°å®¹å™¨ï¼Œç„¶åæ˜¯æ—§å®¹å™¨
                    container = rankingContainer || globalContainer || countryContainer || 
                               oldGlobalContainer || oldCountryContainer || 
                               document.querySelector('.vibe-index-leaderboard');
                    console.log('[drawHighScores] âš ï¸ é™çº§å®¹å™¨:', container ? (container.id || container.className) : 'null');
                }
            }
            // éšè— Country è§†å›¾çš„æç¤ºå…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            var topTalentsHeroesEl = document.getElementById('rtTopTalentsHeroes');
            var eliteHintEl = document.getElementById('rtEliteHint');
            if (topTalentsHeroesEl) { topTalentsHeroesEl.innerHTML = ''; try { topTalentsHeroesEl.style.display = 'none'; } catch (_) {} }
            if (eliteHintEl) { try { eliteHintEl.style.display = 'none'; } catch (_) {} }
            if (!container) {
                console.warn('[drawHighScores] âŒ æ‰¾ä¸åˆ°å®¹å™¨ï¼Œæ— æ³•æ¸²æŸ“é«˜åˆ†å›¾è°±');
                return;
            }
            console.log('[drawHighScores] âœ… æ‰¾åˆ°å®¹å™¨:', container);
            var metricOrder = ['total_messages', 'total_chars', 'avg_message_length', 'jiafang_count', 'ketao_count', 'work_days'];
            var sorted = (Array.isArray(topBy) ? topBy.slice() : []).sort(function (a, b) { return metricOrder.indexOf(String((a && a.key) || '')) - metricOrder.indexOf(String((b && b.key) || '')); });
            if (!sorted.length) {
                container.innerHTML = '<div class="text-zinc-500 text-xs text-center">' + (typeof escapeHtml === 'function' ? escapeHtml(typeof getI18nText === 'function' ? getI18nText('lpdef.none') || 'æš‚æ— é«˜åˆ†å›¾è°±æ•°æ®' : 'æš‚æ— é«˜åˆ†å›¾è°±æ•°æ®') : 'æš‚æ— é«˜åˆ†å›¾è°±æ•°æ®') + '</div>';
                ensureLeaderboardParentVisible(container);
                return;
            }
            var formatMetricValue = function (value, key) {
                var n = Number(value);
                if (!Number.isFinite(n)) return '--';
                var k = String(key || '').toLowerCase();
                if (k.indexOf('chars') !== -1) {
                    if (Math.abs(n) >= 1000) return (n / 1000).toFixed(1) + 'k';
                    return new Intl.NumberFormat(typeof currentLang !== 'undefined' && currentLang === 'en' ? 'en-US' : 'zh-CN').format(Math.round(n));
                }
                if (k === 'avg_message_length') return n.toFixed(1);
                return new Intl.NumberFormat(typeof currentLang !== 'undefined' && currentLang === 'en' ? 'en-US' : 'zh-CN').format(Math.round(n));
            };
            var labelForMetric = function (it) {
                return (typeof currentLang !== 'undefined' && currentLang === 'en') ? (it && (it.labelEn || it.key)) || '--' : (it && (it.labelZh || it.key)) || '--';
            };
            var _resolveDailyDelta = function (row) {
                try {
                    var currRank = Number(row && (row.rn !== undefined ? row.rn : row.rank !== undefined ? row.rank : row.position !== undefined ? row.position : row.pos));
                    var prevRank = Number(row && (row.prev_rank !== undefined ? row.prev_rank : row.prevRank !== undefined ? row.prevRank : row.yesterday_rank !== undefined ? row.yesterday_rank : row.yesterdayRank !== undefined ? row.yesterdayRank : row.rank_prev !== undefined ? row.rank_prev : row.rankPrev));
                    if (Number.isFinite(currRank) && Number.isFinite(prevRank)) return prevRank - currRank;
                    var d = Number(row && (row.delta_rank !== undefined ? row.delta_rank : row.deltaRank !== undefined ? row.deltaRank : row.rank_delta !== undefined ? row.rank_delta : row.rankDelta !== undefined ? row.rankDelta : row.rank_change !== undefined ? row.rank_change : row.rankChange !== undefined ? row.rankChange : row.daily_delta_rank !== undefined ? row.daily_delta_rank : row.dailyDeltaRank !== undefined ? row.dailyDeltaRank : row.dailyChange !== undefined ? row.dailyChange : row.daily_change));
                    return Number.isFinite(d) ? d : null;
                } catch (_) { return null; }
            };
            var _renderDelta = function (delta) {
                if (delta === null || delta === undefined || !Number.isFinite(Number(delta))) return '<span class="lpdef-rank-delta na">--</span>';
                var d = Number(delta) || 0;
                if (d > 0) return '<span class="lpdef-rank-delta up">â–² ' + Math.abs(d) + '</span>';
                if (d < 0) return '<span class="lpdef-rank-delta down">â–¼ ' + Math.abs(d) + '</span>';
                return '<span class="lpdef-rank-delta flat">â€”</span>';
            };
            var _headerRow = function () {
                var rankText = typeof currentLang !== 'undefined' && currentLang === 'en' ? 'Rank' : 'åæ¬¡';
                var userText = typeof currentLang !== 'undefined' && currentLang === 'en' ? 'User' : 'ç”¨æˆ·';
                var scoreText = typeof currentLang !== 'undefined' && currentLang === 'en' ? 'Score' : 'åˆ†æ•°';
                var dailyText = typeof currentLang !== 'undefined' && currentLang === 'en' ? 'Daily' : 'æ—¥å˜';
                var esc = typeof escapeHtml === 'function' ? escapeHtml : function (s) { return String(s == null ? '' : s); };
                return '<div class="lpdef-rank-row lpdef-rank-header-row"><div class="lpdef-rank-left"><span class="lpdef-rank-rn">' + esc(rankText) + '</span><span class="lpdef-rank-name" style="min-width:0;flex:1 1 auto;">' + esc(userText) + '</span></div><div class="lpdef-rank-right"><span class="lpdef-rank-score">' + esc(scoreText) + '</span><span class="lpdef-rank-delta">' + esc(dailyText) + '</span></div></div>';
            };
            var esc = typeof escapeHtml === 'function' ? escapeHtml : function (s) { return String(s == null ? '' : s); };
            var getText = typeof getI18nText === 'function' ? getI18nText : function () { return ''; };
            var cardsHtml = sorted.map(function (it, idx) {
                var label = (labelForMetric(it) || '').trim() || ('M' + (idx + 1));
                var leaders = Array.isArray(it && it.leaders) ? it.leaders : (it && it.user ? [{ rank: 1, score: it.score, user: it.user }] : []);
                if (!leaders.length) return '';
                leaders = leaders.slice().map(function (row) {
                    var pData = {};
                    if (typeof row.personality === 'string') {
                        try { pData = JSON.parse(row.personality); } catch (_) {}
                    } else if (row.personality && typeof row.personality === 'object') {
                        pData = row.personality;
                    }
                    if (!pData || !Object.keys(pData).length) {
                        var raw = row.personality_data ?? row.personalityData;
                        if (typeof raw === 'string') {
                            try {
                                pData = JSON.parse(raw);
                                if (typeof pData === 'string') { try { pData = JSON.parse(pData); } catch (_) {} }
                            } catch (_) {}
                        } else if (raw && typeof raw === 'object') {
                            pData = Array.isArray(raw) ? { detailedStats: raw } : raw;
                        }
                    }
                    return Object.assign({}, row, { personality: pData, user: Object.assign({}, row.user || {}, { personality: pData }) });
                });
                leaders.sort(function (a, b) {
                    var scoreA = Number((a && (a.vibe_index_num ?? a.vibe_index)) != null ? (a.vibe_index_num ?? a.vibe_index) : 0);
                    var scoreB = Number((b && (b.vibe_index_num ?? b.vibe_index)) != null ? (b.vibe_index_num ?? b.vibe_index) : 0);
                    return scoreB - scoreA;
                });
                var metricKey = String((it && it.key) || (it && it.col) || '').trim();
                var rows = leaders.slice(0, 10).map(function (row) {
                    var user = row && row.user ? row.user : {};
                    var meta = _resolveUserMeta(user);
                    var scoreText = formatMetricValue(row && (row.score ?? row.vibe_index_num ?? row.vibe_index), metricKey);
                    var rn = Number((row && (row.rn ?? row.rank ?? row._rank)) !== undefined ? (row.rn ?? row.rank ?? row._rank) : '') || 0;
                    var rankText = rn > 0 ? '#' + rn : (row && (row.rank ?? row._rank) ? '#' + (row.rank ?? row._rank) : '#--');
                    var lpdefText = String((user && user.lpdef) || (user && user.lpDef) || '').trim();
                    var pData = {};
                    if (typeof row.personality === 'string') {
                        try { pData = JSON.parse(row.personality); } catch (_) {}
                    } else if (row.personality && typeof row.personality === 'object') {
                        pData = row.personality;
                    }
                    var badgeTitle = (pData && pData.answer_book && pData.answer_book.title) ? String(pData.answer_book.title) : 'èµ›åšæ‰“å·¥äºº';
                    var personaTag = '';
                    try {
                        if (lpdefText && typeof lpdefToVibeIndex === 'function') {
                            var idx5 = lpdefToVibeIndex(lpdefText);
                            if (idx5 && String(idx5).length === 5) {
                                if (typeof currentLang !== 'undefined' && currentLang === 'en' && window.__LANG_CONFIG && window.__LANG_CONFIG.personalityNamesEn && typeof window.__LANG_CONFIG.personalityNamesEn[idx5] === 'string') {
                                    personaTag = String(window.__LANG_CONFIG.personalityNamesEn[idx5]).trim();
                                } else {
                                    personaTag = 'V' + idx5;
                                }
                            }
                        }
                    } catch (_) {}
                    var displayTag = personaTag || badgeTitle;
                    var nameHtml = meta.profileUrl
                        ? '<a href="' + esc(meta.profileUrl) + '" target="_blank" rel="noopener noreferrer" class="lpdef-rank-name hover:underline">' + esc(meta.display) + '</a>'
                        : '<span class="lpdef-rank-name" style="color: rgba(229,231,235,0.75)">' + esc(meta.display) + '</span>';
                    var delta = _resolveDailyDelta(row);
                    var defAvatar = typeof DEFAULT_AVATAR !== 'undefined' ? DEFAULT_AVATAR : '';
                    return '<div class="lpdef-rank-row"><div class="lpdef-rank-left"><span class="lpdef-rank-rn">' + esc(rankText) + '</span><img class="lpdef-rank-avatar" src="' + esc(meta.avatar) + '" alt="" onerror="this.onerror=null; this.src=\'' + esc(defAvatar) + '\';" /><div class="lpdef-name-wrap">' + nameHtml + (displayTag ? '<span class="lpdef-persona-tag" title="' + esc(badgeTitle) + '">' + esc(displayTag) + '</span>' : '') + '</div></div><div class="lpdef-rank-right"><div class="lpdef-rank-score">' + esc(String(scoreText)) + '</div>' + _renderDelta(delta) + '</div></div>';
                }).join('');
                var noData = getText('common.no_data') || 'No data';
                return '<div class="lpdef-metric-card" data-metric-index="' + idx + '"><div class="lpdef-metric-title">' + esc(label) + '</div><div class="lpdef-rank-list">' + _headerRow() + (rows || '<div class="text-zinc-500 text-xs text-center">' + esc(noData) + '</div>') + '</div></div>';
            }).join('');
            var html = '<div class="lpdef-metric-cards">' + cardsHtml + '</div>';
            console.log('âœ… å‡†å¤‡æ¸²æŸ“æ¦œå•ï¼Œæ•°æ®æ ·æœ¬:', topBy[0] && topBy[0].leaders && topBy[0].leaders[0]);
            container.innerHTML = html;
            ensureLeaderboardParentVisible(container);
        }

        // ==========================================
        // ==========================================
        // ã€v4.0 ç¤ºä¾‹ã€‘VibeCodingerAnalyzer å…¨çƒå„å›½æ•°æ®åˆ‡æ¢ç¤ºä¾‹
        // ==========================================
        /**
         * ç¤ºä¾‹ï¼šå¦‚ä½•ä½¿ç”¨é‡æ„åçš„ VibeCodingerAnalyzer å¤„ç†å…¨çƒ260å›½æ•°æ®
         * 
         * æ ¸å¿ƒåŠŸèƒ½ï¼š
         * 1. å…ƒæ•°æ®é©±åŠ¨ï¼šåŠ¨æ€ç»´åº¦è¯†åˆ«ï¼Œæ”¯æŒ40+ç»´åº¦
         * 2. å®¹å·®å¯¹æ¯”ï¼šå½±å­è°ƒç”¨ä½¿ç”¨Â±5%å®¹å·®
         * 3. å›½å®¶ä¸Šä¸‹æ–‡ï¼šè‡ªåŠ¨è®¡ç®—ä¸ªäººå¾—åˆ†ä¸å›½å®¶å¹³å‡åˆ†çš„åç¦»åº¦
         * 4. æ€§èƒ½ä¼˜åŒ–ï¼šå¹¶å‘é”ã€5ç§’è¶…æ—¶ä¿æŠ¤
         * 5. V6 Statså¯¹æ¥ï¼šå®Œæ•´è§£ætech_stackã€ketao_countç­‰
         */
        
        // ç¤ºä¾‹ï¼šåˆå§‹åŒ–åˆ†æå™¨å¹¶åˆ‡æ¢å›½å®¶ä¸Šä¸‹æ–‡
        async function exampleGlobalCountrySwitching() {
            // 1. å¯¼å…¥åˆ†æå™¨ï¼ˆå‡è®¾å·²é€šè¿‡ESæ¨¡å—å¯¼å…¥ï¼‰
            // import { VibeCodingerAnalyzer } from './src/VibeCodingerAnalyzer.js';
            
            // 2. åˆ›å»ºåˆ†æå™¨å®ä¾‹ï¼ˆæ”¯æŒåŠ¨æ€ç»´åº¦é…ç½®ï¼‰
            const analyzer = new VibeCodingerAnalyzer('zh-CN', {
                // å¯é€‰ï¼šå¦‚æœå·²çŸ¥ç»´åº¦é…ç½®ï¼Œå¯ä»¥é¢„å…ˆä¼ å…¥
                // keys: ['L', 'P', 'D', 'E', 'F', 'G', 'H', ...], // 40+ç»´åº¦
                // metadata: { ... }
            });
            
            // 3. æ¨¡æ‹ŸèŠå¤©æ•°æ®
            const chatData = [
                { role: 'USER', text: 'å¸®æˆ‘å†™ä¸€ä¸ªReactç»„ä»¶ï¼Œä½¿ç”¨TypeScriptå’ŒTailwind CSS' },
                { role: 'ASSISTANT', text: 'å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ ...' },
                { role: 'USER', text: 'è°¢è°¢ï¼Œè¿™ä¸ªå®ç°å¾ˆæ£’ï¼' }
            ];
            
            // 4. å…¨çƒ260å›½æ•°æ®åˆ‡æ¢ç¤ºä¾‹
            const countries = [
                { code: 'US', name: 'United States' },
                { code: 'CN', name: 'China' },
                { code: 'JP', name: 'Japan' },
                { code: 'GB', name: 'United Kingdom' },
                { code: 'DE', name: 'Germany' },
                // ... æ›´å¤šå›½å®¶
            ];
            
            // éå†å„å›½è¿›è¡Œåˆ†æ
            for (const country of countries) {
                try {
                    console.log(`[Example] åˆ†æ ${country.name} (${country.code}) çš„æ•°æ®...`);
                    
                    // 4.1 è®¾ç½®å›½å®¶ä¸Šä¸‹æ–‡ï¼ˆä»åç«¯APIè·å–å›½å®¶å¹³å‡å€¼ï¼‰
                    const countryAverage = await fetchCountryAverage(country.code);
                    analyzer.setCountryContext(country.code, countryAverage, {
                        countryName: country.name,
                        region: getRegionByCountryCode(country.code)
                    });
                    
                    // 4.2 æ‰§è¡Œåˆ†æï¼ˆè‡ªåŠ¨è®¡ç®—åç¦»åº¦ï¼‰
                    const result = await analyzer.analyze(chatData, 'zh-CN');
                    
                    // 4.3 å¤„ç†åˆ†æç»“æœ
                    console.log(`[Example] ${country.name} åˆ†æç»“æœ:`, {
                        dimensions: result.dimensions,
                        personalityType: result.personalityType,
                        deviationFromCountry: result.deviationFromCountry, // ã€v4.0æ–°å¢ã€‘åç¦»åº¦
                        countryAverage: result.countryAverage, // ã€v4.0æ–°å¢ã€‘å›½å®¶å¹³å‡åˆ†
                        stats: result.statistics, // ã€v4.0 V6 Statsã€‘åŒ…å«tech_stackã€ketao_countç­‰
                        hasRageWord: result.metadata?.hasRageWord // ã€v4.0æ–°å¢ã€‘å’†å“®è¯æ£€æµ‹
                    });
                    
                    // 4.4 ä¸Šä¼ æ’åå¹¶è·å–å…¨çƒæ’å
                    const rankData = await analyzer.uploadToSupabase(result, chatData, (progress) => {
                        console.log(`[Example] ${country.name} ä¸Šä¼ è¿›åº¦:`, progress);
                    });
                    
                    console.log(`[Example] ${country.name} æ’åæ•°æ®:`, {
                        rankPercent: rankData.rankPercent,
                        totalUsers: rankData.totalUsers,
                        countryRank: rankData.countryRank // å¦‚æœåç«¯è¿”å›
                    });
                    
                    // 4.5 æ›´æ–°UIï¼ˆç¤ºä¾‹ï¼‰
                    updateCountryDashboard(country.code, {
                        result,
                        rankData,
                        deviation: result.deviationFromCountry
                    });
                    
                } catch (error) {
                    console.error(`[Example] ${country.name} åˆ†æå¤±è´¥:`, error);
                    // ã€v4.0 è¶…æ—¶ä¿æŠ¤ã€‘å¦‚æœè¶…æ—¶ï¼Œä¼šè‡ªåŠ¨é™çº§åˆ°æœ¬åœ°ç®€å•åŒ¹é…
                    if (error.message.includes('timeout')) {
                        console.warn(`[Example] ${country.name} åˆ†æè¶…æ—¶ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ`);
                    }
                }
                
                // é¿å…è¿‡å¿«åˆ‡æ¢å¯¼è‡´å¹¶å‘å†²çªï¼ˆã€v4.0 å¹¶å‘é”ã€‘ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šä»åç«¯è·å–å›½å®¶å¹³å‡å€¼
        async function fetchCountryAverage(countryCode) {
            try {
                const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || 
                                   'https://cursor-clinical-analysis.psterman.workers.dev/';
                var _fp = '';
                try { _fp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                const url = `${apiEndpoint}api/v2/country-average?countryCode=${countryCode}&fingerprint=${encodeURIComponent(_fp)}&_t=${Date.now()}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return data.average || null; // æ ¼å¼ï¼š{L: 65, P: 70, D: 60, E: 8, F: 55}
            } catch (error) {
                console.warn(`[Example] è·å– ${countryCode} å›½å®¶å¹³å‡å€¼å¤±è´¥:`, error);
                return null;
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®å›½å®¶ä»£ç è·å–åœ°åŒº
        function getRegionByCountryCode(code) {
            const regionMap = {
                'US': 'North America',
                'CN': 'Asia',
                'JP': 'Asia',
                'GB': 'Europe',
                'DE': 'Europe',
                // ... æ›´å¤šæ˜ å°„
            };
            return regionMap[code] || 'Unknown';
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°å›½å®¶ä»ªè¡¨æ¿UI
        async function updateCountryDashboard(countryNameOrCode, maybeData) {
            // å¼ºåˆ¶æ¸…ç† Loadingï¼šå³ä¾¿å‡ºé”™ä¹Ÿéšè—è½¬åœˆï¼Œè®©ç”¨æˆ·çœ‹åˆ°ã€Œæš‚æ— æ•°æ®ã€è€Œéä¸€ç›´è½¬åœˆ
            try {
                document.querySelectorAll('.loading-spinner').forEach(function(el) { el.classList.add('hidden'); });
            } catch (e) { /* ignore */ }

            // å…¼å®¹æ—§ç¤ºä¾‹è°ƒç”¨ï¼šupdateCountryDashboard(countryCode, { result, ... })
            if (maybeData && typeof maybeData === 'object' && maybeData.result) {
                const countryCode = countryNameOrCode;
                const data = maybeData;
                const dashboard = document.getElementById(`country-dashboard-${countryCode}`);
                if (dashboard) {
                    dashboard.innerHTML = `
                        <div class="country-stats">
                            <h3>${countryCode} åˆ†æç»“æœ</h3>
                            <div class="dimensions">
                                ${Object.entries(data.result.dimensions).map(([key, value]) =>
                                    `<div class="dimension">
                                        <span>${key}:</span>
                                        <span>${value}</span>
                                        ${data.deviation ? `<span class="deviation">${data.deviation.deviations[key]?.deviationPercent || ''}</span>` : ''}
                                    </div>`
                                ).join('')}
                            </div>
                            <div class="deviation-summary">
                                ${data.deviation ? `
                                    <p>æ•´ä½“åç¦»åº¦: ${data.deviation.overallDeviation}%</p>
                                    <p>${data.deviation.interpretation}</p>
                                ` : ''}
                            </div>
                            <div class="stats">
                                <p>æŠ€æœ¯æ ˆ: ${JSON.stringify(data.result.statistics?.tech_stack || {})}</p>
                                <p>å®¢å¥—è¯æ•°: ${data.result.statistics?.ketao_count || 0}</p>
                                <p>åŠ æ–¹è¯æ•°: ${data.result.statistics?.jiafang_count || 0}</p>
                                <p>å·¥ä½œå¤©æ•°: ${data.result.statistics?.work_days || 0}</p>
                            </div>
                            ${data.result.metadata?.hasRageWord ? '<div class="rage-warning">âš ï¸ æ£€æµ‹åˆ°å’†å“®è¯</div>' : ''}
                        </div>
                    `;
                }
                return;
            }

            // åˆå§‹åŒ–ä¿æŠ¤ï¼šåœ¨ onload å®Œæˆæœ€ç»ˆ switchView å‰ï¼Œæ‹¦æˆªæ¥è‡ª storage/resize çš„é‡å¤è¯·æ±‚
            if (isInitialLayoutPending) return;

            // æ–°é€»è¾‘ï¼šç”¨äºå³ä¾§æŠ½å±‰å›½å®¶é€è§†ï¼ˆæ”¯æŒä»»æ„å›½å®¶ä»£ç ï¼‰
            // ã€å…œåº•ã€‘è‹¥å…¥å‚ä¸ºç©ºä½†å¤„äºå›½å®¶è§†è§’ï¼Œä½¿ç”¨ window.currentUserCountry ç¡®ä¿ fetch ä½¿ç”¨æœ€æ–°å›½å®¶ç 
            const rawCountry = String(countryNameOrCode || '').trim() ||
                ((typeof currentViewState === 'string' && currentViewState === 'COUNTRY' && (currentDrawerCountry?.code || window.currentUserCountry))
                    ? String(currentDrawerCountry?.code || window.currentUserCountry || '').trim()
                    : '');
            const isGlobal =
                !rawCountry ||
                rawCountry.toUpperCase() === 'GLOBAL' ||
                rawCountry === 'å…¨ç½‘' ||
                rawCountry === 'ä¸–ç•Œ' ||
                rawCountry.toUpperCase() === 'WORLD';

            let countryCode = '';
            if (!isGlobal) {
                if (/^[A-Za-z]{2}$/.test(rawCountry)) {
                    countryCode = rawCountry.toUpperCase();
                } else if (typeof resolveCountryCodeFromMapName === 'function') {
                    const cc = resolveCountryCodeFromMapName(rawCountry);
                    countryCode = cc ? String(cc).toUpperCase() : '';
                }
                // æ— æ³•è§£æ ISO2 æ—¶ï¼šé€€å›å…¨ç½‘å£å¾„ï¼ˆé¿å…é”™è¯¯æŸ¥è¯¢å¯¼è‡´ ratio å¤±çœŸï¼‰
                if (!/^[A-Z]{2}$/.test(countryCode)) {
                    countryCode = '';
                }
            }
            const effectiveIsGlobal = isGlobal || !/^[A-Z]{2}$/.test(countryCode);

            // vNext: æ”¯æŒç¬¬ä¸‰å‚æ•° optionsï¼ˆpreferCache / silent / forceï¼‰ï¼Œæå‰è§£æä¾›é‡å¤æ£€æŸ¥ä½¿ç”¨
            const opts = (() => {
                try {
                    const o = arguments && arguments.length >= 3 ? arguments[2] : null;
                    return o && typeof o === 'object' ? o : {};
                } catch {
                    return {};
                }
            })();
            // å‡†å…¥æ£€æŸ¥ï¼šåŒä¸€å›½å®¶ä¸”éå¼ºåˆ¶åˆ·æ–°åˆ™ç›´æ¥ returnï¼ˆlastFetchedCountry ä¸ lastRequestCountry åŒè½¨ï¼‰
            const forceRefresh = opts.force === true || opts.forceRefresh === true;
            const sameCountry = !effectiveIsGlobal && countryCode && (
                String(countryCode).toUpperCase() === String(lastFetchedCountry || '').toUpperCase() ||
                String(countryCode).toUpperCase() === String(lastRequestCountry || '').toUpperCase()
            );
            if (sameCountry && !forceRefresh) return;
            if (isProcessingUpdate && !forceRefresh) return;
            isProcessingUpdate = true;

            // RPC/API å‚æ•° target_country ä¸¥æ ¼ç­‰äºå½“å‰é€‰æ‹©çš„å›½å®¶ç ï¼ˆä¸åç«¯ get_country_* ä¸€è‡´ï¼‰
            const target_country = effectiveIsGlobal ? '' : String(countryCode).toUpperCase();
            const selectedCountry = effectiveIsGlobal ? 'GLOBAL' : target_country;
            console.log('[updateCountryDashboard] Requesting Country:', selectedCountry);

            const base = (document.querySelector('meta[name="api-endpoint"]')?.content || '').trim();
            const API_ENDPOINT = base.endsWith('/') ? base : `${base}/`;
            // å›½å®¶è§†å›¾å¿…é¡»ç”¨ country-summary æ‹‰å–è¯¥å›½ v_country_stats çœŸå®èšåˆä¸ v_user_ranks_in_country æ’åï¼›user_id/fingerprint ä¸ã€Œæˆ‘çš„æ’åã€ä¸€è‡´ï¼Œåç«¯æ‰èƒ½è¿”å› global_user_ranks
            let uid = (() => {
                try {
                    const fromWindow = (window.currentUser && window.currentUser.id) || (window.currentUserData && window.currentUserData.id) || (window.supabaseAuthUser && window.supabaseAuthUser.id) || (window.authenticatedUserId) || (window.__authUserId) || '';
                    if (fromWindow) return String(fromWindow);
                    return localStorage.getItem('github_user_id') || localStorage.getItem('supabase_user_id') || localStorage.getItem('auth_user_id') || localStorage.getItem('user_id') || localStorage.getItem('github_username') || window.userId || '';
                } catch { return ''; }
            })();
            let fp = (() => {
                try {
                    const p = new URLSearchParams(window.location.search);
                    const fromUrl = p.get('fingerprint') || p.get('fp') || '';
                    if (fromUrl) return String(fromUrl).trim();
                    return localStorage.getItem('user_fingerprint') || window.fpId || '';
                } catch { return ''; }
            })();
            const cName = (typeof currentDrawerCountry !== 'undefined' && currentDrawerCountry && currentDrawerCountry.name) ? currentDrawerCountry.name : '';
            const url = effectiveIsGlobal
                ? `${API_ENDPOINT}api/global-average`
                : `${API_ENDPOINT}api/country-summary?country=${encodeURIComponent(target_country)}${cName ? `&country_name=${encodeURIComponent(cName)}` : ''}${uid ? `&user_id=${encodeURIComponent(uid)}` : ''}${fp ? `&fingerprint=${encodeURIComponent(fp)}` : ''}&_ts=${Date.now()}`;

            // DOM ç»‘å®šç‚¹
            const usersValEl = document.getElementById('rtDiagnosedTotal');
            const analysisValEl = document.getElementById('rtScanTotal');
            const usersCardEl = document.getElementById('rtUsersCard');
            const analysisCardEl = document.getElementById('rtAnalysisCard');
            const statusEl = document.getElementById('rtDataStatus');
            const radarDom = document.getElementById('rtRadar');
            const realtimeDom = document.getElementById('rtRealtimeList');
            const meritEl = document.getElementById('rtMeritBoard');

            // ä¼˜å…ˆæ•°æ®æºï¼šä¼ å‚ data.countryTotals æˆ– window.lastDataï¼ˆç”¨äºç»Ÿè®¡å¡ç‰‡ï¼Œä¸å†ä¾èµ– country_level/countryDataByCodeï¼‰
            const preferredTotals = (maybeData && typeof maybeData === 'object' && (maybeData.countryTotals ?? maybeData.data?.countryTotals))
                ? (maybeData.countryTotals ?? maybeData.data?.countryTotals)
                : (window.lastData && typeof window.lastData === 'object' ? (window.lastData.countryTotals ?? window.lastData) : null);

            const flash = (el) => {
                if (!el) return;
                el.classList.remove('breathe-flash');
                // å¼ºåˆ¶é‡æ’ä»¥é‡å¯åŠ¨ç”»
                void el.offsetWidth; // eslint-disable-line no-unused-expressions
                el.classList.add('breathe-flash');
                window.setTimeout(() => el.classList.remove('breathe-flash'), 950);
            };

            const stopFlash = (el) => {
                if (!el) return;
                el.classList.remove('breathe-flash');
            };

            const escapeHtml = (s) =>
                String(s ?? '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');

            const setValueOrNA = (el, rawValue) => {
                if (!el) return;
                // UI é™çº§ï¼šä»…å°†â€œç©º/ä¸å¯è§£æâ€è§†ä¸ºç¼ºå¤±ï¼›0 åº”è¯¥æ˜¾ç¤ºä¸º 0ï¼ˆå¦åˆ™ä¼šè¯¯åˆ¤ä¸º N/Aï¼‰
                if (
                    rawValue === null ||
                    rawValue === undefined ||
                    (typeof rawValue === 'string' && rawValue.trim() === '')
                ) {
                    el.textContent = 'N/A';
                    stopFlash(el);
                    return;
                }
                const n = Number(rawValue);
                if (!Number.isFinite(n)) {
                    el.textContent = 'N/A';
                    stopFlash(el);
                    return;
                }
                el.textContent = new Intl.NumberFormat('zh-CN').format(n);
            };

            /** å›½å®¶è§†å›¾ä¸‹ï¼šæœ‰ countryTotals å³æ‰§è¡Œï¼ˆå« ai=0 çš„é¦–äººå›½å®¶ï¼‰â€”â€”ç§»é™¤ .animate-pulseï¼Œå°†æ•°å€¼æ›¿æ¢ä¸ºè¯¥å›½çœŸå®ç»Ÿè®¡ã€‚ä¸¥ç¦å›é€€å…¨çƒæ•°æ®ã€‚ */
            function updateCountryRankUI(payload) {
                if (!payload || !payload.countryTotals) return;
                if (effectiveIsGlobal) return;
                try {
                    document.querySelectorAll('#right-drawer .animate-pulse, .right-drawer .animate-pulse').forEach(function(el) { if (el && el.classList) el.classList.remove('animate-pulse'); });
                    var totalsBox = document.getElementById('rtCountryTotals');
                    var ranksBox = document.getElementById('rtMyCountryRanks');
                    if (totalsBox && totalsBox.closest && totalsBox.closest('.clinic-card')) totalsBox.closest('.clinic-card').classList.remove('animate-pulse');
                    if (ranksBox && ranksBox.closest && ranksBox.closest('.clinic-card')) ranksBox.closest('.clinic-card').classList.remove('animate-pulse');
                    var ct = payload.countryTotals;
                    setValueOrNA(usersValEl, Number(ct.totalUsers ?? ct.total_users ?? 0) || null);
                    setValueOrNA(analysisValEl, Number(ct.ai ?? ct.total_messages ?? 0) || null);
                } catch (e) { /* ignore */ }
            }

            // é›·è¾¾å›¾ï¼ˆEChartsï¼‰
            if (!window.__countryRadarChart) window.__countryRadarChart = null;
            const disposeRadar = () => {
                try {
                    if (window.__countryRadarChart && typeof window.__countryRadarChart.dispose === 'function') {
                        window.__countryRadarChart.dispose();
                    }
                } catch (e) {
                    // ignore
                } finally {
                    window.__countryRadarChart = null;
                }
            };

            const renderRadarMessage = (msg) => {
                if (!radarDom) return;
                disposeRadar();
                radarDom.innerHTML = `
                    <div class="flex items-center justify-center h-full w-full text-center text-zinc-500 text-sm border border-white/10 bg-zinc-950/30">
                        ${escapeHtml(msg)}
                    </div>
                `;
            };

            const renderRadar = (values) => {
                const dom = document.getElementById('rtRadar');
                if (!dom || typeof echarts === 'undefined') return;
                try {
                    if (window.__countryRadarChart && typeof window.__countryRadarChart.dispose === 'function') {
                        window.__countryRadarChart.dispose();
                    }
                } catch (e) {
                    // ignore
                }
                dom.innerHTML = '';
                window.__countryRadarChart = echarts.init(dom, null, { renderer: 'canvas' });
                const radarLabel = effectiveIsGlobal
                    ? 'GLOBAL_AVG'
                    : (countryCode && /^[A-Z]{2}$/.test(String(countryCode).toUpperCase())
                        ? `${String(countryCode).toUpperCase()}_AVG`
                        : 'REGION_AVG');
                const option = {
                    backgroundColor: 'transparent',
                    radar: {
                        indicator: [
                            { name: 'L', max: 100 },
                            { name: 'P', max: 100 },
                            { name: 'D', max: 100 },
                            { name: 'E', max: 100 },
                            { name: 'F', max: 100 },
                        ],
                        axisName: { color: '#e5e7eb', fontFamily: 'JetBrains Mono', fontSize: 11 },
                        splitLine: { lineStyle: { color: 'rgba(0,255,65,0.18)' } },
                        splitArea: { areaStyle: { color: ['rgba(0,255,65,0.02)', 'rgba(0,255,65,0.01)'] } },
                        axisLine: { lineStyle: { color: 'rgba(0,255,65,0.22)' } },
                    },
                    series: [
                        {
                            type: 'radar',
                            data: [
                                {
                                    value: values,
                                    name: radarLabel,
                                    areaStyle: { color: 'rgba(0,255,65,0.15)' },
                                    backgroundStyle: { color: 'transparent' },
                                    lineStyle: { color: '#00ff41', width: 2 },
                                    itemStyle: { color: '#00ff41' },
                                },
                            ],
                        },
                    ],
                    tooltip: { show: true },
                };
                window.__countryRadarChart.setOption(option, true);
                try {
                    window.__countryRadarChart.resize();
                } catch (e) {
                    // ignore
                }
            };

            // Cache-firstï¼šåˆ‡æ¢å›½å®¶æ—¶å…ˆå±•ç¤ºç¼“å­˜ï¼Œå†åå°é™é»˜åˆ·æ–°
            const cacheKey = effectiveIsGlobal ? 'GLOBAL' : (countryCode || rawCountry || 'UNKNOWN');
            // ç«æ€ä¿æŠ¤ï¼šä¿è¯æ—§å›½å®¶è¯·æ±‚ä¸ä¼šè¦†ç›–æ–°å›½å®¶ UI
            const requestKey = String(cacheKey || '').toUpperCase();
            const requestSeq = (() => {
                try {
                    if (!window.__countryDashboardRequestSeq) window.__countryDashboardRequestSeq = 0;
                    const seq = ++window.__countryDashboardRequestSeq;
                    window.__countryDashboardLatestRequest = { seq, key: requestKey, at: Date.now() };
                    return seq;
                } catch {
                    return 0;
                }
            })();
            const isStaleRequest = () => {
                try {
                    const latest = window.__countryDashboardLatestRequest;
                    if (!latest) return false;
                    if (latest.seq !== requestSeq) return true;
                    if (String(latest.key || '').toUpperCase() !== requestKey) return true;
                    // åœ¨å›½å®¶é€è§†æ¨¡å¼ä¸‹ï¼Œè¿˜è¦æ ¡éªŒ currentDrawerCountryï¼ˆé¿å… US è¯·æ±‚å›å†™ CN é¢æ¿ï¼‰
                    if (!effectiveIsGlobal && typeof currentViewState === 'string' && currentViewState === 'COUNTRY') {
                        const cur = String(currentDrawerCountry?.code || '').toUpperCase();
                        const expected = String(countryCode || '').toUpperCase();
                        if (cur && expected && cur !== expected) return true;
                    }
                    return false;
                } catch {
                    return false;
                }
            };
            try {
                if (!window.__countryDashboardCache) window.__countryDashboardCache = new Map();
                if (opts.preferCache) {
                    const hit = window.__countryDashboardCache.get(cacheKey);
                    const cachedData = hit && typeof hit === 'object' ? (hit.data || null) : null;
                    if (cachedData && typeof cachedData === 'object') {
                        try {
                            // çŠ¶æ€ï¼šç¼“å­˜å‘½ä¸­å³è§†ä¸ºç¨³å®šï¼ˆé¿å…â€œé—ªç™½â€ï¼‰
                            if (statusEl) statusEl.textContent = getI18nText('panel.data_stable') || 'DATA: STABLE';
                            setValueOrNA(usersValEl, cachedData.totalUsers ?? cachedData.total_users ?? null);
                            setValueOrNA(analysisValEl, cachedData.totalAnalysis ?? cachedData.total_analysis ?? null);

                            const l = cachedData.avg_l ?? cachedData.avgL ?? null;
                            const p = cachedData.avg_p ?? cachedData.avgP ?? null;
                            const d1 = cachedData.avg_d ?? cachedData.avgD ?? null;
                            const e1 = cachedData.avg_e ?? cachedData.avgE ?? null;
                            const f1 = cachedData.avg_f ?? cachedData.avgF ?? null;
                            const radar = [l, p, d1, e1, f1].map((v) => Number(v || 0));
                            if (radarDom) {
                                // åªè¦æœ‰ä¸€ä¸ªé 0 å€¼å°±æ¸²æŸ“ï¼ˆé¿å…å…¨ 0 è¦†ç›–ï¼‰
                                if (radar.some((x) => Number(x) > 0)) renderRadar(radar);
                            }
                        } catch { /* ignore */ }
                    }
                }
            } catch { /* ignore */ }

            // ä¼˜å…ˆç”¨ lastData / ä¼ å‚ countryTotals æ›´æ–°ç»Ÿè®¡å¡ç‰‡ï¼štotalAnalysis<-aiï¼ŒtotalChars<-say
            if (preferredTotals && typeof preferredTotals === 'object') {
                const aiVal = preferredTotals.ai;
                const sayVal = preferredTotals.say;
                setValueOrNA(analysisValEl, aiVal != null ? aiVal : null);
                if (meritEl) {
                    const n = Number(sayVal);
                    if (Number.isFinite(n) && n >= 0) {
                        meritEl.textContent = currentLang === 'en'
                            ? `Analyzed ${(n / 10000).toFixed(1)} Ã—10k chars`
                            : `å·²ç´¯è®¡åˆ†æ ${(n / 10000).toFixed(1)} ä¸‡å­—`;
                    }
                }
            }

            // äººæ ¼åˆ†å¸ƒï¼ˆåŸºäºæœ€æ–°è®°å½•/å®æ—¶æµçš„è½»é‡èšåˆå±•ç¤ºï¼‰
            const INVALID_NAMES = new Set(['è‡ªåŠ¨ä¸ŠæŠ¥ç”¨æˆ·', 'anonymous', 'guest', '']);
            const _cleanHandle = (s) => String(s ?? '').trim().replace(/^@+/, '').trim();
            const _isInvalidHandle = (s) => {
                const x = _cleanHandle(s).toLowerCase();
                return INVALID_NAMES.has(x) || INVALID_NAMES.has(String(s ?? '').trim());
            };
            const _looksLikeGitHubUsername = (s, identity = null) => {
                const h = _cleanHandle(s);
                if (!h) return false;
                if (_isInvalidHandle(h)) return false;
                // ä¼˜å…ˆä½¿ç”¨é¡¹ç›®å†…æ—¢æœ‰æ ¡éªŒå‡½æ•°ï¼ˆæ”¯æŒ user_identity å…œåº•ï¼‰
                try {
                    if (typeof isValidGitHubUsername === 'function') return !!isValidGitHubUsername(h, identity);
                } catch { /* ignore */ }
                // fallbackï¼šGitHub ç”¨æˆ·åè§„åˆ™ï¼ˆè¿‘ä¼¼ï¼‰
                if (h.length > 39) return false;
                if (!/^[A-Za-z0-9](?:[A-Za-z0-9-]{0,37}[A-Za-z0-9])?$/.test(h)) return false;
                if (h.includes('--')) return false;
                return true;
            };
            const _regionName = (maybeCode) => {
                const raw = String(maybeCode ?? '').trim();
                if (!raw) return '';
                const code = /^[A-Za-z]{2}$/.test(raw) ? raw.toUpperCase() : '';
                if (!code) return raw;
                try {
                    const loc = (typeof currentLang === 'string' && currentLang === 'en') ? 'en' : 'zh-CN';
                    const dn = new Intl.DisplayNames([loc], { type: 'region' });
                    return dn.of(code) || code;
                } catch {
                    return code;
                }
            };
            const _resolveUserMeta = (r) => {
                const identity = r?.user_identity ?? r?.userIdentity ?? null;
                const githubRaw = _cleanHandle(r?.github_username ?? r?.githubUsername ?? r?.gh ?? r?.github ?? '');
                const u1 = _cleanHandle(r?.user_name ?? r?.userName ?? r?.username ?? r?.user ?? '');
                const fp = _cleanHandle(r?.fingerprint ?? r?.fp ?? r?.fpId ?? r?.user_fingerprint ?? '');
                const id = _cleanHandle(r?.user_id ?? r?.userId ?? r?.id ?? '');

                // GitHub ä¼˜å…ˆï¼šæ˜¾å¼ github_usernameï¼Œå…¶æ¬¡ user_name ä¹Ÿå¯èƒ½å°±æ˜¯ GitHub ç”¨æˆ·å
                const github = _looksLikeGitHubUsername(githubRaw, identity)
                    ? githubRaw
                    : (_looksLikeGitHubUsername(u1, identity) ? u1 : '');
                const chosen = github || (!_isInvalidHandle(u1) ? u1 : '');
                const display = chosen
                    ? `@${chosen}`
                    : (fp ? `user_${fp.slice(0, 6)}` : (id ? `user_${id.slice(0, 6)}` : (currentLang === 'en' ? 'unknown' : 'æœªçŸ¥')));
                const avatar = github
                    ? `https://github.com/${encodeURIComponent(github)}.png?size=64`
                    : DEFAULT_AVATAR;
                const profileUrl = github ? `https://github.com/${encodeURIComponent(github)}` : '';
                return { display, avatar, profileUrl };
            };
            const renderRealtime = (records) => {
                const box = document.getElementById('rtRealtimeList');
                if (!box) return;
                if (!Array.isArray(records) || records.length === 0) {
                    box.innerHTML = `<div class="text-zinc-500 text-xs">${escapeHtml(getI18nText('realtime.none') || (currentLang === 'en' ? 'No data' : 'æš‚æ— äººæ ¼åˆ†å¸ƒæ•°æ®'))}</div>`;
                    return;
                }
                // æŒ‰äººæ ¼ç±»å‹èšåˆï¼Œå¾—åˆ° [{ type, count }]ï¼Œä¸äººæ ¼åˆ†å¸ƒæ’è¡Œä¸€è‡´
                const countByType = {};
                records.forEach((r) => {
                    const type = String(
                        r.personality_type ??
                        r.p_type ??
                        r.type ??
                        (r.personality && (r.personality.type || r.personality['type'])) ??
                        'UNKNOWN'
                    ).toUpperCase();
                    countByType[type] = (countByType[type] || 0) + 1;
                });
                const distribution = Object.entries(countByType)
                    .map(([type, count]) => ({ type, count }))
                    .sort((a, b) => (b.count - a.count));
                const total = distribution.reduce((s, it) => s + it.count, 0);
                const maxPct = total > 0 ? Math.max(...distribution.map((it) => (it.count / total) * 100)) : 0;
                box.className = 'personality-vbar-chart';
                box.innerHTML = distribution.map((item) => {
                    const pctVal = total > 0 ? (item.count / total) * 100 : 0;
                    const pct = pctVal.toFixed(1);
                    const heightPct = maxPct > 0 ? Math.max(4, (pctVal / maxPct) * 100) : 0;
                    const title = getPersonalityTitle(item, currentLang);
                    return `<div class="personality-vbar-col"><div class="personality-vbar-bar-wrap"><div class="personality-vbar-fill" style="height: ${heightPct}%;"></div></div><span class="personality-vbar-name" title="${escapeHtml(title)}">${escapeHtml(title)}</span><span class="personality-vbar-pct">${pct}%</span></div>`;
                }).join('');
            };

            const renderErrorState = (message) => {
                if (statusEl) statusEl.textContent = getI18nText('panel.data_error') || 'DATA: ERROR';
                if (usersValEl) usersValEl.textContent = 'N/A';
                if (analysisValEl) analysisValEl.textContent = 'N/A';
                stopFlash(usersCardEl || usersValEl);
                stopFlash(analysisCardEl || analysisValEl);

                renderRadarMessage(message);
                const topTalentsEl = document.getElementById('rtTopTalentsList');
                if (topTalentsEl) topTalentsEl.innerHTML = '';
                const globalRatioEl = document.getElementById('rtGlobalRatio');
                if (globalRatioEl) globalRatioEl.textContent = 'N/A';
                const meritEl = document.getElementById('rtMeritBoard');
                if (meritEl) meritEl.textContent = currentLang === 'en' ? 'Analyzed -- Ã—10k chars' : 'å·²ç´¯è®¡åˆ†æ -- ä¸‡å­—';
                if (realtimeDom) {
                    // countryName å˜é‡åœ¨æ­¤ä½œç”¨åŸŸä¸å­˜åœ¨ï¼Œä½¿ç”¨å…¥å‚å›é€€é‡è¯•
                    const retryArg = escapeHtml(JSON.stringify(countryNameOrCode));
                    realtimeDom.innerHTML = `
                        <div class="border border-red-500/30 bg-red-950/20 p-4">
                            <div class="text-red-300 text-sm font-bold mb-2">${escapeHtml(getI18nText('error.data_load_failed') || 'Failed to load data')}</div>
                            <div class="text-zinc-400 text-xs mb-3">${escapeHtml(message || '')}</div>
                            <button
                                type="button"
                                class="px-3 py-1.5 text-xs border border-red-400/60 text-red-200 hover:bg-red-400/10 transition-colors"
                                onclick="updateCountryDashboard(${retryArg})"
                            >[RETRY]</button>
                        </div>
                    `;
                }
            };

            // é¢„è®¾åŠ è½½æ€ï¼šå‘èµ· fetch å‰ç«‹å³å°†å³ä¾§æŠ½å±‰æ‰€æœ‰å¡ç‰‡ï¼ˆæ€»äººæ•°ã€æ€»æ¶ˆæ¯ã€æ€»å­—æ•°ã€å›½å®¶ç´¯è®¡ã€æˆ‘çš„æ’åï¼‰ç½®ä¸º ... å¹¶ animate-pulse
            if (!effectiveIsGlobal && !opts.silent && !opts.preferCache) {
                if (usersValEl) { usersValEl.textContent = '...'; usersValEl.classList.add('animate-pulse'); }
                if (analysisValEl) { analysisValEl.textContent = '...'; analysisValEl.classList.add('animate-pulse'); }
                const totalsBoxPre = document.getElementById('rtCountryTotals');
                const ranksBoxPre = document.getElementById('rtMyCountryRanks');
                if (totalsBoxPre) totalsBoxPre.innerHTML = '<div class="text-zinc-500 text-xs animate-pulse">...</div>';
                if (ranksBoxPre) ranksBoxPre.innerHTML = '<div class="text-zinc-500 text-xs animate-pulse">...</div>';
                if (meritEl) { meritEl.textContent = '...'; meritEl.classList.add('animate-pulse'); }
                var rtJ = document.getElementById('rtJiafangCount');
                var rtK = document.getElementById('rtKetaoCount');
                var rtW = document.getElementById('rtWorkDays');
                if (rtJ) { rtJ.textContent = '...'; rtJ.classList.add('animate-pulse'); }
                if (rtK) { rtK.textContent = '...'; rtK.classList.add('animate-pulse'); }
                if (rtW) { rtW.textContent = '...'; rtW.classList.add('animate-pulse'); }
                if (window.__countryTotalsCache && countryCode) window.__countryTotalsCache.delete(`CT:${String(countryCode).toUpperCase()}`);
            }
            if (!effectiveIsGlobal && !opts.silent) {
                if (statusEl) statusEl.textContent = getI18nText('panel.data_fetching') || 'DATA: FETCHING';
            }

            var fetchTimeoutId = null;
            try {
                if (window.countryAbortController) try { window.countryAbortController.abort(); } catch (abortE) {}
                window.countryAbortController = new AbortController();
                var fetchSignal = window.countryAbortController.signal;
                // 10 ç§’è¶…æ—¶ï¼Œé€‚åº”å›½å†…æ³¢åŠ¨ä¸è¾¹ç¼˜ç½‘å…³
                fetchTimeoutId = setTimeout(() => { try { window.countryAbortController.abort(); } catch (_) {} }, 10000);
                if (statusEl) statusEl.textContent = getI18nText('panel.data_fetching') || 'DATA: FETCHING';
                if (!opts.silent) {
                    renderRadarMessage(getI18nText('radar.loading') || 'Loading...');
                    if (realtimeDom) realtimeDom.innerHTML = `<div class="text-zinc-500 text-xs">${escapeHtml(getI18nText('common.loading') || (currentLang === 'en' ? 'Loading...' : 'åŠ è½½ä¸­...'))}</div>`;
                }

                const resp = await fetch(url, { signal: fetchSignal });
                if (fetchTimeoutId) { clearTimeout(fetchTimeoutId); fetchTimeoutId = null; }
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const payload = await resp.json();
                // åç«¯è¿”å›å¯èƒ½æ˜¯â€œé¡¶å±‚å®Œæ•´å­—æ®µ + data(å…¼å®¹åŒ…è£…)â€çš„ç»“æ„ã€‚
                const root = (payload && typeof payload === 'object') ? payload : {};
                const nested = (root && typeof root.data === 'object' && root.data) ? root.data : {};
                const data = { ...root, ...nested };
                // å« totalcharssum ä¸”æ•°å€¼å¼‚å¸¸æ—¶ä¸ä½¿ç”¨è¯¥å­—æ®µè¦†ç›– UIï¼Œä½†ä¸é˜»æ–­åŠ è½½ï¼ˆé¿å…æŠ½å±‰/åœ°å›¾æ— æ³•åŠ è½½ï¼‰
                const totalcharssumVal = data.totalcharssum;
                const isAbnormalTotalcharssum = totalcharssumVal != null && Number(totalcharssumVal) > 10000000;
                if (isAbnormalTotalcharssum) {
                    delete data.totalcharssum;
                }
                console.log('[Debug] ç»Ÿè®¡åŸå§‹æ•°æ®:', data);
                if (data.latest_records && data.latest_records.length > 0) {
                    console.log('[Debug] ç¬¬ä¸€äººæ•°æ®ï¼ˆæ£€æŸ¥å­—æ®µåï¼‰:', data.latest_records[0]);
                }
                console.log('[updateCountryDashboard] Requesting Country (response received):', selectedCountry);
                if (isStaleRequest()) {
                    // è¯·æ±‚è¿‡æœŸæ—¶ä»…ç”¨ç¼“å­˜æ¸²æŸ“ï¼Œä¸å†è§¦å‘ fetch æˆ– updateCountryDashboardï¼Œé˜²æ­¢æ­»å¾ªç¯
                    try {
                        if (!window.__countryDashboardCache) window.__countryDashboardCache = new Map();
                        const cachedHit = window.__countryDashboardCache.get(cacheKey);
                        if (cachedHit && typeof cachedHit === 'object' && cachedHit.data) {
                            const cachedData = cachedHit.data;
                            const ct = cachedData.countryTotals ?? cachedData;
                            setValueOrNA(usersValEl, cachedData.totalUsers ?? cachedData.total_users ?? null);
                            setValueOrNA(analysisValEl, ct.ai ?? cachedData.totalAnalysis ?? cachedData.total_analysis ?? null);
                            if (statusEl) statusEl.textContent = getI18nText('panel.data_cached') || 'DATA: CACHED';
                            if (meritEl) {
                                const sayN = Number(ct.say ?? cachedData.totalChars ?? cachedData.total_chars ?? 0);
                                meritEl.textContent = currentLang === 'en'
                                    ? `Analyzed ${(sayN / 10000).toFixed(1)} Ã—10k chars`
                                    : `å·²ç´¯è®¡åˆ†æ ${(sayN / 10000).toFixed(1)} ä¸‡å­—`;
                            }
                        }
                    } catch (e) { /* ignore */ }
                    return;
                }

                // è¯·æ±‚æˆåŠŸååŒæ­¥ lastRequestCountry / lastFetchedCountryï¼ˆè°ƒåº¦ä¸­å¿ƒï¼‰ï¼Œå¹¶æ¸…é™¤é‡è¯•æ ‡å¿—
                if (!effectiveIsGlobal && countryCode) {
                    lastRequestCountry = String(countryCode).toUpperCase();
                    lastFetchedCountry = lastRequestCountry;
                    // åŠ¨æ€æ ‡é¢˜åŒæ­¥ï¼šæ ¹æ®å½“å‰è¯­è¨€ä¸ countryCode ä» countryNameMap å–è¯‘åï¼Œå¼ºåˆ¶æ›´æ–°æŠ½å±‰æ ‡é¢˜
                    try {
                        const titleEl = document.getElementById('right-drawer-title');
                        if (titleEl && typeof countryNameMap !== 'undefined' && countryNameMap) {
                            const cc = String(countryCode).toUpperCase();
                            const names = countryNameMap[cc];
                            const displayName = names ? (currentLang === 'zh' ? names.zh : names.en) : cc;
                            titleEl.textContent = displayName;
                        }
                    } catch (e) { /* ignore */ }
                }
                if (window.__updateCountryDashboardRetried) window.__updateCountryDashboardRetried = false;
                // å†™å…¥ç¼“å­˜ï¼ˆä¾›ä¸‹æ¬¡â€œç§’åˆ‡æ¢â€ä½¿ç”¨ï¼‰
                try {
                    if (!window.__countryDashboardCache) window.__countryDashboardCache = new Map();
                    window.__countryDashboardCache.set(cacheKey, { data, ts: Date.now() });
                } catch { /* ignore */ }
                // ä¿®å¤ç¼“å­˜æ±¡æŸ“ï¼šç¦æ­¢ç›´æ¥è¦†ç›–ï¼Œç”¨æ·±åº¦åˆå¹¶ä¿ç•™ countryStatsã€_sum ç­‰å­—æ®µ
                try {
                    window.cachedSummary = typeof mergeDeep === 'function'
                        ? mergeDeep(window.cachedSummary || {}, data)
                        : Object.assign({}, window.cachedSummary || {}, data);
                } catch (e) { /* ignore */ }

                // å›½å®¶è§†å›¾ï¼šæ‹‰å– get_country_dimension_averages(target_code) ä½œä¸ºé›·è¾¾å›¾çœŸå®æ•°æ®æº
                let countryDimensionAverages = null;
                if (!effectiveIsGlobal && countryCode && typeof supabaseClient !== 'undefined' && supabaseClient && typeof supabaseClient.rpc === 'function') {
                    try {
                        const dimRes = await supabaseClient.rpc('get_country_dimension_averages', { target_code: countryCode });
                        if (dimRes && dimRes.data != null) countryDimensionAverages = dimRes.data;
                    } catch (e) { console.warn('[updateCountryDashboard] get_country_dimension_averages RPC å¤±è´¥:', e); }
                }
                // è¿”å›å€¼å¯èƒ½æ˜¯æ•°ç»„ [{ avg_e: "54.00", has_valid_data: true, ... }]ï¼Œå–é¦–æ¡
                const record = (Array.isArray(countryDimensionAverages) ? countryDimensionAverages[0] : countryDimensionAverages) || null;

                // =========================
                // è¯­ä¹‰çˆ†å‘ï¼ˆé»‘è¯æ¦œï¼‰æ•°æ®æºï¼šå›½å®¶è§†å›¾è¯äº‘ä»…æ¥æºäº get_country_keywords RPCï¼Œç¦æ­¢ä½¿ç”¨ data.cloud50 æˆ– detailedStats æ€§æ ¼æ ‡ç­¾
                // =========================
                try {
                    if (isStaleRequest()) {
                        try {
                            if (!window.__countryDashboardCache) window.__countryDashboardCache = new Map();
                            const cachedHit = window.__countryDashboardCache.get(cacheKey);
                            if (cachedHit && typeof cachedHit === 'object' && cachedHit.data) {
                                const cachedData = cachedHit.data;
                                window.__latestTop10 = Array.isArray(cachedData.top10) ? cachedData.top10 : null;
                                window.__latestCloud50 = Array.isArray(cachedData.cloud50) ? cachedData.cloud50 : null;
                            }
                        } catch (e) { /* ignore */ }
                        return;
                    }
                    if (!effectiveIsGlobal && countryCode && typeof supabaseClient !== 'undefined' && supabaseClient && typeof supabaseClient.rpc === 'function') {
                        var wordCloudContainer = document.getElementById('vibe-cloud50-container');
                        var topRankContainer = document.getElementById('vibe-top10-list');
                        if (wordCloudContainer) {
                            wordCloudContainer.setAttribute('data-loading', 'true');
                            wordCloudContainer.innerHTML = '<div class="flex items-center justify-center h-full min-h-[200px] text-zinc-500 text-sm">åŠ è½½ä¸­...</div>';
                        }
                        if (topRankContainer) {
                            topRankContainer.innerHTML = '<li class="list-none text-zinc-500 text-sm py-4 text-center">åŠ è½½ä¸­...</li>';
                            var emptyEl = document.getElementById('vibe-top10-empty');
                            if (emptyEl) emptyEl.classList.add('hidden');
                        }
                        try {
                            var kwRes = await supabaseClient.rpc('get_country_keywords', { target_code: countryCode });
                            var kwData = (kwRes && kwRes.data != null) ? kwRes.data : null;
                            if (!kwData || !Array.isArray(kwData) || kwData.length === 0) {
                                if (typeof _renderCloud50 === 'function') _renderCloud50(countryCode, []);
                            } else {
                                var cloudData = kwData.map(function(x) { return { phrase: (x && x.tag) ? String(x.tag).trim() : '', hit_count: Number(x && x.weight) || 0 }; }).filter(function(x) { return x.phrase && x.hit_count > 0; });
                                if (typeof _renderCloud50 === 'function') _renderCloud50(countryCode, cloudData);
                            }
                        } catch (rpcErr) {
                            console.warn('[updateCountryDashboard] è¯äº‘ RPC å¤±è´¥:', rpcErr);
                            if (typeof _renderCloud50 === 'function') _renderCloud50(countryCode, []);
                        } finally {
                            if (wordCloudContainer) wordCloudContainer.removeAttribute('data-loading');
                        }
                        // æ’è¡Œæ¦œï¼šè°ƒç”¨ get_national_lexicon(countryCode, type)ï¼Œé»˜è®¤ merit_board
                        window.__currentCountryCode = countryCode;
                        (function loadLexiconList() {
                            var lexType = (window.__currentLexiconType || 'merit_board');
                            var base = (typeof window.getApiEndpoint === 'function' ? window.getApiEndpoint() : (document.querySelector('meta[name="api-endpoint"]') && document.querySelector('meta[name="api-endpoint"]').content)) || '';
                            base = (base && base.trim()) ? (base.trim().endsWith('/') ? base.trim() : base.trim() + '/') : '';
                            var url = base + 'api/national-lexicon?country=' + encodeURIComponent(countryCode) + '&type=' + encodeURIComponent(lexType);
                            fetch(url).then(function(r) { return r.json(); }).then(function(res) {
                                var list = (res && res.data && Array.isArray(res.data)) ? res.data : [];
                                if (typeof _renderTop10List === 'function') _renderTop10List(list, true);
                            }).catch(function() {
                                if (typeof _renderTop10List === 'function') _renderTop10List([], true);
                            });
                        })();
                    } else {
                        window.__latestTop10 = Array.isArray(data.top10) ? data.top10 : null;
                        window.__latestCloud50 = effectiveIsGlobal ? (Array.isArray(data.cloud50) ? data.cloud50 : null) : null;
                        if (effectiveIsGlobal) {
                            try { window.renderVibeCardFromData && window.renderVibeCardFromData(countryNameOrCode, data); } catch (e2) { /* ignore */ }
                        } else {
                            window.__latestCloud50 = null;
                            var emptyEl = document.getElementById('vibe-cloud50-empty');
                            var emptyTopElse = document.getElementById('vibe-top10-empty');
                            if (emptyEl) { emptyEl.textContent = 'æ­£åœ¨æ”¶é›†æ•°æ®...'; emptyEl.classList.remove('hidden'); }
                            if (emptyTopElse) { emptyTopElse.textContent = 'æ­£åœ¨æ”¶é›†æ•°æ®...'; emptyTopElse.classList.remove('hidden'); }
                            try { if (typeof _renderCloud50 === 'function') _renderCloud50(countryCode, []); } catch (_) {}
                            try { if (typeof _renderTop10List === 'function') _renderTop10List([]); } catch (_) {}
                            try { window.renderVibeCardFromData && window.renderVibeCardFromData(countryNameOrCode, { top10: [], cloud50: [] }); } catch (e2) { /* ignore */ }
                        }
                    }
                } catch (e1) { /* ignore */ }

                // å­—æ®µæ˜ å°„ï¼ˆå…¼å®¹ total_users/totalUsers ç­‰ï¼‰
                // ã€æ³¨æ„ã€‘å›½å®¶æ¨¡å¼ä¸‹,data.totalUsers å·²ç»æ˜¯è¯¥å›½æ•°æ®,ä¸éœ€è¦ä» data.us_stats è¯»å–
                const globalTotalUsersRaw =
                    data.totalUsers ??
                    data.total_users ??
                    data.totalusers ??
                    null;
                // å›½å®¶è§†å›¾ï¼šä»…ä» countryTotals è¯»å–ï¼Œä¸è½å›å…¨å±€æ ¹èŠ‚ç‚¹
                const globalTotalAnalysisRaw = effectiveIsGlobal
                    ? (data.countryTotals?.ai ?? data.ai ?? data.totalAnalysis ?? data.total_analysis ?? data.totalanalysis ?? null)
                    : (data.countryTotals?.ai ?? data.total_messages ?? data.totalAnalysis ?? data.total_analysis ?? data.totalanalysis ?? null);

                // é›·è¾¾å›¾æ•°æ®ï¼šä¼˜å…ˆ RPC recordï¼ˆhas_valid_data æ—¶ï¼‰å¼ºåˆ¶ parseFloatï¼Œå¦åˆ™ country-summary çš„ avg_/globalAverageï¼Œä»…æ— æœ‰æ•ˆæ•°æ®æ—¶ç”¨ 50 å ä½
                const toRadarVal = (v) => {
                    const n = parseFloat(v);
                    return Number.isFinite(n) ? Math.max(0, Math.min(100, n)) : null;
                };
                const DEFAULT_RADAR_FALLBACK = [50, 50, 50, 50, 50];
                let radarData;
                if (record && record.has_valid_data === true) {
                    radarData = [record.avg_l, record.avg_p, record.avg_d, record.avg_e, record.avg_f].map(function(v) { return parseFloat(v || 50); });
                } else {
                    const avgObj =
                        (data.globalAverage && typeof data.globalAverage === 'object' ? data.globalAverage : null) ||
                        (data.averages && typeof data.averages === 'object' ? data.averages : null) ||
                        (data.average && typeof data.average === 'object' ? data.average : null) ||
                        null;
                    const avg_l = data.avg_l ?? data.avgL ?? avgObj?.L ?? avgObj?.l ?? null;
                    const avg_p = data.avg_p ?? data.avgP ?? avgObj?.P ?? avgObj?.p ?? null;
                    const avg_d = data.avg_d ?? data.avgD ?? avgObj?.D ?? avgObj?.d ?? null;
                    const avg_e = data.avg_e ?? data.avgE ?? avgObj?.E ?? avgObj?.e ?? null;
                    const avg_f = data.avg_f ?? data.avgF ?? avgObj?.F ?? avgObj?.f ?? null;
                    radarData = [
                        toRadarVal(avg_l) ?? 0,
                        toRadarVal(avg_p) ?? 0,
                        toRadarVal(avg_d) ?? 0,
                        toRadarVal(avg_e) ?? 0,
                        toRadarVal(avg_f) ?? 0
                    ];
                }
                // ä»…å½“æ— æœ‰æ•ˆæ•°æ®ï¼ˆé has_valid_data ä¸”å…¨ä¸º 0ï¼‰æ—¶ä½¿ç”¨ 50 å ä½
                if (radarData.every((v) => Number(v) === 0) && (!record || record.has_valid_data !== true)) {
                    radarData = DEFAULT_RADAR_FALLBACK.slice();
                }

                // å›½å®¶è§†å›¾ï¼šä»…ä» countryTotals è¯»å–ï¼ˆsay/total_charsï¼‰
                const totalCharsSumRaw = effectiveIsGlobal
                    ? (data.countryTotals?.say ?? data.say ?? data.totalCharsSum ?? data.total_chars_sum ?? data.totalChars ?? data.total_chars ?? null)
                    : (data.countryTotals?.say ?? data.total_chars ?? data.totalCharsSum ?? data.total_chars_sum ?? data.totalChars ?? data.total_chars ?? null);
                const totalCharsSum = Number(totalCharsSumRaw);
                if (meritEl) {
                    // 0 ä¹Ÿåº”æ˜¾ç¤ºï¼ˆå¦åˆ™çœ‹èµ·æ¥åƒâ€œæœªåŠ è½½â€ï¼‰
                    if (Number.isFinite(totalCharsSum) && totalCharsSum >= 0) {
                        meritEl.textContent =
                            currentLang === 'en'
                                ? `Analyzed ${(totalCharsSum / 10000).toFixed(1)} Ã—10k chars`
                                : `å·²ç´¯è®¡åˆ†æ ${(totalCharsSum / 10000).toFixed(1)} ä¸‡å­—`;
                    } else {
                        meritEl.textContent = currentLang === 'en' ? 'Analyzed -- Ã—10k chars' : 'å·²ç´¯è®¡åˆ†æ -- ä¸‡å­—';
                    }
                }

                // å›½å®¶è§†å›¾ï¼šai/say/day/no/please å‡ä» countryTotals è¯»å–
                const ctForDrawer = data.countryTotals || {};
                const firstRecord = Array.isArray(data.latest_records) && data.latest_records[0] ? data.latest_records[0] : null;
                const stats = data.statistics || data.stats || (firstRecord && (firstRecord.statistics || firstRecord.stats)) || {};
                const jiafangVal = effectiveIsGlobal ? (data.jiafang_count ?? stats.jiafang_count ?? firstRecord?.jiafang_count ?? null) : (ctForDrawer.no ?? ctForDrawer.jiafang_count ?? data.jiafang_count ?? stats.jiafang_count ?? firstRecord?.jiafang_count ?? null);
                const ketaoVal = effectiveIsGlobal ? (data.ketao_count ?? stats.ketao_count ?? firstRecord?.ketao_count ?? null) : (ctForDrawer.please ?? ctForDrawer.ketao_count ?? data.ketao_count ?? stats.ketao_count ?? firstRecord?.ketao_count ?? null);
                const workDaysVal = effectiveIsGlobal ? (data.work_days ?? stats.work_days ?? firstRecord?.work_days ?? null) : (ctForDrawer.day ?? ctForDrawer.work_days ?? data.work_days ?? stats.work_days ?? firstRecord?.work_days ?? null);
                const rtJiafang = document.getElementById('rtJiafangCount');
                const rtKetao = document.getElementById('rtKetaoCount');
                const rtWorkDays = document.getElementById('rtWorkDays');
                if (rtJiafang) { rtJiafang.textContent = (jiafangVal !== null && jiafangVal !== undefined) ? String(Number(jiafangVal)) : '--'; rtJiafang.classList.remove('animate-pulse'); }
                if (rtKetao) { rtKetao.textContent = (ketaoVal !== null && ketaoVal !== undefined) ? String(Number(ketaoVal)) : '--'; rtKetao.classList.remove('animate-pulse'); }
                if (rtWorkDays) { rtWorkDays.textContent = (workDaysVal !== null && workDaysVal !== undefined) ? String(Number(workDaysVal)) : '--'; rtWorkDays.classList.remove('animate-pulse'); }

                // å¦‚æœæ˜¯ç¾å›½ï¼Œéœ€è¦åŒæ—¶æ‹¿åˆ°ï¼šæœ¬åœ°åŒº totalUsers / totalAnalysis å’Œå…¨çƒ totalUsersï¼ˆç”¨äº Ratioï¼‰
                // ã€ä¿®å¤ã€‘æ ¹æ®è¯·æ±‚ç±»å‹åˆ¤æ–­æ•°æ®ç»“æ„:
                // - å…¨ç½‘è¯·æ±‚ (isGlobal=true): data.totalUsers æ˜¯å…¨ç½‘æ•°æ®
                // - å›½å®¶è¯·æ±‚ (country_code=US): data.totalUsers å·²ç»æ˜¯è¯¥å›½è¿‡æ»¤åçš„æ•°æ®ï¼Œéœ€è¦é¢å¤–è¯·æ±‚å…¨ç½‘æ•°æ®ç”¨äºå æ¯”è®¡ç®—
                let globalTotalUsers = Number(
                    data.totalUsers ?? data.total_users ?? data.totalusers ?? null
                );
                let globalTotalAnalysis = Number(
                    data.totalAnalysis ?? data.total_analysis ?? data.totalanalysis ?? null
                );
                
                let localTotalUsers;
                let localTotalAnalysis;
                
                if (effectiveIsGlobal) {
                    // å…¨ç½‘æ¨¡å¼:æœ¬åœ°=å…¨çƒ
                    localTotalUsers = globalTotalUsers;
                    localTotalAnalysis = globalTotalAnalysis;
                } else {
                    // å›½å®¶æ¨¡å¼ï¼šä¸¥æ ¼ä»…ä» countryTotals è¯»å–è¯¥å›½æ•°æ®ï¼Œå³ä½¿è¯¥å›½ä¸º 0 ä¹Ÿä¸å›é€€å…¨çƒ
                    const ct = data.countryTotals || {};
                    localTotalUsers = Number(ct.totalUsers ?? ct.total_users ?? 0);
                    localTotalAnalysis = Number(ct.ai ?? ct.total_messages ?? 0);
                    
                // å›½å®¶æ¨¡å¼ä¸‹ï¼Œéœ€è¦é‡æ–°è·å–å…¨ç½‘æ•°æ®ç”¨äºå æ¯”è®¡ç®—
                // (å› ä¸ºä¸Šé¢çš„ globalTotalUsers å®é™…æ˜¯è¯¥å›½æ•°æ®)
                    try {
                        var _gfp = '';
                        try { _gfp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                        const gResp = await fetch(`${API_ENDPOINT}api/global-average?fingerprint=${encodeURIComponent(_gfp)}&_t=${Date.now()}`);
                        if (gResp.ok) {
                            const gPayload = await gResp.json();
                        // ä¸ä¸»è¯·æ±‚ä¸€è‡´ï¼šåˆå¹¶ root + dataï¼ˆé¿å…åªå–åˆ°éƒ¨åˆ†å­—æ®µï¼‰
                        const gRoot = (gPayload && typeof gPayload === 'object') ? gPayload : {};
                        const gNested = (gRoot && typeof gRoot.data === 'object' && gRoot.data) ? gRoot.data : {};
                        const gData = { ...gRoot, ...gNested };
                            globalTotalUsers = Number(gData.totalUsers ?? gData.total_users ?? gData.totalusers ?? 0);
                            globalTotalAnalysis = Number(gData.totalAnalysis ?? gData.total_analysis ?? gData.totalanalysis ?? 0);
                            if (globalTotalUsers > 0) try { window.__globalTotalUsers = globalTotalUsers; } catch (_) {}
                        }
                    } catch (e) {
                        console.warn('[CountryDashboard] è·å–å…¨ç½‘æ•°æ®å¤±è´¥ï¼Œå æ¯”å¯èƒ½ä¸å‡†ç¡®:', e);
                    }
                }

                // å…œåº•ï¼šç¡®ä¿ finite number
                if (!Number.isFinite(globalTotalUsers)) globalTotalUsers = 0;
                if (!Number.isFinite(globalTotalAnalysis)) globalTotalAnalysis = 0;
                if (!Number.isFinite(localTotalUsers)) localTotalUsers = 0;
                if (!Number.isFinite(localTotalAnalysis)) localTotalAnalysis = 0;

                const latest =
                    data.latest_records ??
                    data.latestRecords ??
                    data.latest_records_v6 ??
                    data.latest ??
                    data.latestRecordsV6 ??
                    [];

                // =========================
                // å›½å®¶ç´¯è®¡ & æˆ‘çš„æ’åï¼ˆæ•°æ®æ¥æºç»Ÿä¸€ï¼šç™»å½•åç”¨è§†å›¾ v_unified_analysis_v2 / currentUser.idï¼‰
                // - æ‹†åˆ†æˆä¸¤å¼ å¡ï¼š#rtCountryTotalsï¼ˆÎ£ï¼‰ä¸ #rtMyCountryRanksï¼ˆme + rankï¼‰
                // =========================
                try {
                    const totalsBox = document.getElementById('rtCountryTotals');
                    const ranksBox = document.getElementById('rtMyCountryRanks');
                    if (totalsBox || ranksBox) {
                        const fmt = (n) => new Intl.NumberFormat('zh-CN').format(Number(n) || 0);
                        const fp = (() => {
                            try {
                                var p = new URLSearchParams(window.location.search);
                                var fromUrl = p.get('fingerprint') || p.get('fp') || '';
                                if (fromUrl) return String(fromUrl).trim();
                                return localStorage.getItem('user_fingerprint') || window.fpId || '';
                            } catch { return ''; }
                        })();
                        const uid = (() => {
                            try {
                                // æˆ‘çš„æ’åï¼šä¼˜å…ˆç”¨è§†å›¾/ç™»å½•èº«ä»½ idï¼Œç™»å½•åä¸å†ä¾èµ– fingerprint
                                const fromWindow = (window.currentUser && window.currentUser.id) ||
                                    (window.currentUserData && window.currentUserData.id) ||
                                    (window.supabaseAuthUser && window.supabaseAuthUser.id) ||
                                    (window.authenticatedUserId) ||
                                    (window.__authUserId) ||
                                    '';
                                if (fromWindow) return String(fromWindow);
                                // å…œåº•ï¼šå°è¯•ä» localStorage å–ï¼ˆéƒ¨åˆ†ç™»å½•é“¾è·¯ä¼šæŒä¹…åŒ–ï¼‰
                                return localStorage.getItem('github_user_id') ||
                                    localStorage.getItem('supabase_user_id') ||
                                    localStorage.getItem('auth_user_id') ||
                                    localStorage.getItem('user_id') ||
                                    '';
                            } catch { return ''; }
                        })();
                        const cName = (() => {
                            try {
                                const cc = String(countryCode || '').trim().toUpperCase();
                                // ä¼˜å…ˆä½¿ç”¨å†…ç½®æ˜ å°„çš„è‹±æ–‡å›½åï¼ˆæ›´å¯èƒ½ä¸æ•°æ®åº“ä¸­çš„ legacy å…¨åä¸€è‡´ï¼Œå¦‚ "United States"ï¼‰
                                const mapped = (typeof countryNameMap === 'object' && countryNameMap && countryNameMap[cc])
                                    ? (countryNameMap[cc].en || countryNameMap[cc].zh || '')
                                    : '';
                                if (mapped) return String(mapped);
                                return (currentDrawerCountry && currentDrawerCountry.name) ? String(currentDrawerCountry.name) : '';
                            } catch {
                                return '';
                            }
                        })();
                        // å›½å®¶è§†å›¾ä¸”ä¸»è¯·æ±‚å·²æ˜¯ country-summaryï¼šç›´æ¥å¤ç”¨ data ä½œä¸º payload2ï¼Œä¸å†äºŒæ¬¡è¯·æ±‚ï¼Œå³æ—¶åˆ·æ–°
                        const cacheKey2 = `CT:${String(countryCode || '').toUpperCase()}`;
                        if (!window.__countryTotalsCache) window.__countryTotalsCache = new Map();
                        const useMainDataAsPayload2 = !effectiveIsGlobal && data && data.countryTotals && typeof data.countryTotals === 'object';
                        let payload2 = useMainDataAsPayload2 ? data : null;
                        
                        // ã€ä¿®å¤ã€‘æ•°æ®é™çº§ï¼šå¦‚æœ payload2 å­˜åœ¨ä½†å­—æ®µä¸å…¨ï¼Œå°è¯•ä» raw result è¡¥å…¨
                        if (payload2 && !payload2.countryTotals && data.__raw) {
                           payload2 = { ...data.__raw, ...payload2 };
                        }
                        if (!useMainDataAsPayload2) {
                        const url2 = `${API_ENDPOINT}api/country-summary?country=${encodeURIComponent(String(target_country || countryCode || '').toUpperCase())}${cName ? `&country_name=${encodeURIComponent(cName)}` : ''}${uid ? `&user_id=${encodeURIComponent(uid)}` : ''}${fp ? `&fingerprint=${encodeURIComponent(fp)}` : ''}&_ts=${Date.now()}`;
                        const hit2 = window.__countryTotalsCache.get(cacheKey2);
                        if (hit2 && typeof hit2 === 'object') {
                            if (totalsBox && hit2.totalsHtml) totalsBox.innerHTML = hit2.totalsHtml;
                            if (ranksBox && hit2.ranksHtml) ranksBox.innerHTML = hit2.ranksHtml;
                        }
                        if (totalsBox && !String(totalsBox.innerHTML || '').trim()) totalsBox.innerHTML = '<div class="text-zinc-500 text-xs">åŠ è½½ä¸­...</div>';
                        if (ranksBox && !String(ranksBox.innerHTML || '').trim()) ranksBox.innerHTML = '<div class="text-zinc-500 text-xs">åŠ è½½ä¸­...</div>';

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);
                        try {
                            const resp2 = await fetch(url2 + (url2.indexOf('?') >= 0 ? '&' : '?') + '_t=' + Date.now(), { signal: controller.signal });
                            clearTimeout(timeoutId);
                            if (!resp2.ok) throw new Error(`HTTP ${resp2.status}`);
                            payload2 = await resp2.json().catch(() => null);
                            if (!payload2 || typeof payload2 !== 'object') throw new Error('bad payload');
                        } catch (fetchErr) {
                            clearTimeout(timeoutId);
                            if (fetchErr.name === 'AbortError') {
                                console.warn('[Stats2] å›½å®¶ç´¯è®¡ API è¯·æ±‚è¶…æ—¶:', url2);
                                throw new Error('è¯·æ±‚è¶…æ—¶');
                            }
                            throw fetchErr;
                        }
                        }
                        if (!useMainDataAsPayload2 && payload2 && isStaleRequest()) {
                            // ã€ä¿®å¤è¿‡æœŸåˆ¤å®šã€‘å›½å®¶ç´¯è®¡è¯·æ±‚å·²è¿‡æœŸæ—¶ï¼š
                            // 1. ä¼˜å…ˆä» localStorage è¯»å–æ—§æ•°æ®è¿›è¡Œæ¸²æŸ“
                            // 2. å¦‚æœæ˜¯ Global æ ‡ç­¾ï¼Œè§¦å‘ä¸€æ¬¡å¼‚æ­¥é™é»˜åˆ·æ–°
                            // ã€ä¿®å¤å˜é‡å¼•ç”¨ã€‘å®šä¹‰ cc å’Œ countryName å˜é‡
                            const cc = String(countryCode || target_country || '').trim().toUpperCase();
                            const countryName = cName || (currentDrawerCountry && currentDrawerCountry.name) || countryCode || '';
                            
                            try {
                                const cacheKey = `country_summary_${cc}`;
                                const cached = localStorage.getItem(cacheKey);
                                if (cached) {
                                    const { data: cachedData } = JSON.parse(cached);
                                    if (cachedData && typeof cachedData === 'object') {
                                        // ä½¿ç”¨è¿‡æœŸç¼“å­˜æ•°æ®æ¸²æŸ“ï¼Œé¿å…æ˜¾ç¤º 0
                                        showDrawersWithCountryData(cc, countryName, cachedData, { summaryOnly: true });
                                        
                                        // ã€æ–°å¢ã€‘å¦‚æœæ˜¯ Global æ ‡ç­¾ï¼Œè§¦å‘å¼‚æ­¥é™é»˜åˆ·æ–°
                                        const isGlobalView = typeof currentViewState === 'string' && currentViewState === 'GLOBAL';
                                        if (isGlobalView && typeof fetchCountrySummaryV3 === 'function') {
                                            // å¼‚æ­¥åˆ·æ–°ï¼Œä¸é˜»å¡å½“å‰æ¸²æŸ“
                                            setTimeout(() => {
                                                fetchCountrySummaryV3(countryCode).then((summary) => {
                                                    if (summary && typeof summary === 'object' && currentDrawerCountry && String(currentDrawerCountry.code || '').toUpperCase() === String(countryCode || '').toUpperCase()) {
                                                        showDrawersWithCountryData(cc, countryName, summary, { summaryOnly: true });
                                                    }
                                                }).catch(() => {
                                                    // é™é»˜å¤±è´¥
                                                });
                                            }, 100);
                                        }
                                        return;
                                    }
                                }
                            } catch (e) {
                                // ç¼“å­˜è¯»å–å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨ 0
                            }
                            
                            // ã€æ–°å¢ã€‘å¦‚æœæ²¡æœ‰ç¼“å­˜ä¸”æ˜¯ Global æ ‡ç­¾ï¼Œè§¦å‘å¼‚æ­¥åˆ·æ–°è€Œä¸æ˜¯ç›´æ¥è·³è¿‡
                            const isGlobalView = typeof currentViewState === 'string' && currentViewState === 'GLOBAL';
                            if (isGlobalView && typeof fetchCountrySummaryV3 === 'function') {
                                setTimeout(() => {
                                    fetchCountrySummaryV3(countryCode).then((summary) => {
                                        if (summary && typeof summary === 'object' && currentDrawerCountry && String(currentDrawerCountry.code || '').toUpperCase() === String(countryCode || '').toUpperCase()) {
                                            showDrawersWithCountryData(cc, countryName, summary, { summaryOnly: true });
                                        }
                                    }).catch(() => {
                                        // é™é»˜å¤±è´¥
                                    });
                                }, 100);
                            }
                            return;
                            // å³ä½¿è¯·æ±‚è¿‡æœŸï¼Œä¹Ÿè¦æ¸…é™¤"åŠ è½½ä¸­..."çŠ¶æ€
                            try {
                                const totalsBox = document.getElementById('rtCountryTotals');
                                const ranksBox = document.getElementById('rtMyCountryRanks');
                                if (totalsBox && totalsBox.innerHTML.includes('åŠ è½½ä¸­')) {
                                    totalsBox.innerHTML = `<div class="text-zinc-500 text-xs">${currentLang === 'en' ? 'No data' : 'æš‚æ— æ•°æ®'}</div>`;
                                }
                                if (ranksBox && ranksBox.innerHTML.includes('åŠ è½½ä¸­')) {
                                    ranksBox.innerHTML = `<div class="text-zinc-500 text-xs">${currentLang === 'en' ? 'No data' : 'æš‚æ— æ•°æ®'}</div>`;
                                }
                            } catch { /* ignore */ }
                            return;
                        }

                        const userCountry = String(countryCode || '').trim().toUpperCase();
                        console.log('[Stats2] å›½å®¶ç´¯è®¡ API å…¨é‡æ•°æ®:', { payload: payload2, userCountry });
                        const totals = payload2.countryTotals || payload2.data?.countryTotals || null;
                        var totalsRanks = payload2.countryTotalsRanks || payload2.data?.countryTotalsRanks || null;
                        var totalCountriesFromData = payload2.total_countries ?? payload2._meta?.totalCountries ?? payload2._meta?.total_countries ?? (payload2.countryTotalsRanks?._meta?.totalCountries ?? payload2.countryTotalsRanks?._meta?.total_countries) ?? 195;
                        if (!totalsRanks && totalCountriesFromData <= 1) {
                            var oneOne = { rank: 1, total: 1 };
                            totalsRanks = {
                                total_messages: oneOne, total_chars: oneOne, jiafang_count: oneOne,
                                ketao_count: oneOne, avg_user_message_length: oneOne, work_days: oneOne,
                                _meta: { totalCountries: 1 }
                            };
                        }
                        // ã€ä¿®å¤ã€‘å¦‚æœ totals å­˜åœ¨ä½†ç¼ºå°‘å¹³å‡é•¿åº¦ï¼Œå°è¯•æ‰‹åŠ¨è®¡ç®—ä¾› Î£ å±•ç¤º
                        if (totals) {
                            if (!totals.avg_message_length && !totals.avg_user_message_length && !totals.word) {
                                const tc = Number(totals.total_chars ?? totals.say ?? 0);
                                const tm = Number(totals.total_messages ?? totals.ai ?? 0);
                                if (tm > 0) totals.avg_message_length = tc / tm;
                            }
                        }
                        // ã€è°ƒè¯•ã€‘éªŒè¯ work_days å­—æ®µè¯»å–
                        if (totals) {
                            console.log('[Stats2] âœ… å›½å®¶ç´¯è®¡æ•°æ® work_days:', {
                                work_days: totals.work_days,
                                work_days_sum: totals.work_days_sum,
                                rank_h: totalsRanks?.work_days
                            });
                        }
                        // ã€ä¿®å¤ã€‘å¦‚æœ totals æ˜¯ç©ºå¯¹è±¡æˆ–æ‰€æœ‰å…³é”®å­—æ®µéƒ½ä¸º0/nullï¼Œè§†ä¸ºæ— æ•°æ®
                        const hasValidTotals = totals && (
                            totals.total_messages > 0 || 
                            totals.total_chars > 0 || 
                            totals.work_days > 0 || 
                            totals.work_days_sum > 0 ||
                            totals.jiafang_count > 0 ||
                            totals.ketao_count > 0
                        );
                        const countryDataByCode = payload2.countryDataByCode || payload2.data?.countryDataByCode || {};
                        const ranks = payload2.myCountryRanks || payload2.data?.myCountryRanks || null;
                        var remoteVals = payload2.myCountryValues || payload2.data?.myCountryValues || {};
                        var myCountryFromApi = payload2.myCountry || payload2.data?.myCountry || {};
                        var baseUser = window.currentUserData || window.currentUser || {};
                        var merged = Object.assign({}, baseUser, remoteVals, myCountryFromApi);
                        merged.vibe_rank = merged.vibe_rank ?? merged.vibeRank ?? payload2.vibe_rank ?? payload2.vibeRank ?? payload2.data?.vibe_rank ?? payload2.data?.vibeRank
                            ?? (function() {
                                var list = payload2.latest_records ?? payload2.latestRecords ?? payload2.data?.latest_records ?? [];
                                var fp = (merged.fingerprint || baseUser.fingerprint || '').toString();
                                var uid = (merged.id ?? merged.user_id ?? baseUser.id ?? '').toString();
                                for (var i = 0; i < (list.length || 0); i++) {
                                    var r = list[i];
                                    var rFp = (r.fingerprint || r.fp || '').toString();
                                    var rId = (r.id ?? r.user_id ?? '').toString();
                                    if ((fp && rFp && rFp.indexOf(fp.substring(0, 8)) >= 0) || (uid && rId && rId === uid) || (i === 0 && (r.vibe_rank != null || r.vibeRank != null))) {
                                        var vr = r.vibe_rank ?? r.vibeRank;
                                        if (vr != null && Number(vr) > 0) return Number(vr);
                                    }
                                }
                                return (window.lastData && window.lastData.latest_records && window.lastData.latest_records[0]) ? (window.lastData.latest_records[0].vibe_rank ?? window.lastData.latest_records[0].vibeRank) : undefined;
                            })();
                        if (merged.personality_name === undefined && merged.personalityName === undefined) merged.personality_name = merged.personalityName = (baseUser.personality_name || baseUser.personalityName || (currentLang === 'en' ? 'Unknown Title' : 'æœªçŸ¥äººæ ¼'));
                        if (!merged.personality_type && !merged.personalityType) merged.personality_type = merged.personalityType = baseUser.personality_type || baseUser.personalityType || 'UNKNOWN';
                        // å¼ºåˆ¶ä¸ Supabase åŒæ­¥å›½ç±ï¼šæ¬å®¶åç«‹å³è¦†ç›–å…¨å±€ï¼Œç¡®ä¿åç»­ filter èƒ½åŒ¹é…ä¸Š
                        var latestCC = (payload2.user && (payload2.user.current_location || payload2.user.country_code)) || payload2.current_location || payload2.target_country || (typeof target_country !== 'undefined' ? target_country : '');
                        if (latestCC != null && String(latestCC).trim() !== '') {
                            latestCC = String(latestCC).trim().toUpperCase().substring(0, 2);
                            merged.current_location = merged.location = latestCC;
                            window.currentUserCountry = latestCC;
                        }
                        try { window.currentUserData = merged; window.currentUser = merged; } catch (e) { /* ignore */ }
                        if (window.currentUserData && latestCC != null && String(latestCC).trim() !== '') {
                            window.currentUserData.current_location = latestCC;
                            if (window.allData && Array.isArray(window.allData)) {
                                const myIndex = window.allData.findIndex(u =>
                                    (u.fingerprint && u.fingerprint === window.currentUserData.fingerprint) ||
                                    (u.github_username && u.github_username === window.currentUserData.github_username)
                                );
                                if (myIndex !== -1) {
                                    window.allData[myIndex].current_location = latestCC;
                                    console.log('[Fix] å·²åŒæ­¥å…¨å±€ç¼“å­˜ä¸­çš„å›½ç±ä¸º:', latestCC);
                                }
                            }
                        }
                        var localStats = window.last_local_stats;
                        var st = (localStats && localStats.payload && (Date.now() - (localStats.ts || 0)) < 300000) ? (localStats.payload.stats || {}) : null;
                        var meVals = {
                            total_messages: (st?.totalMessages ?? remoteVals?.total_messages ?? merged.total_messages ?? merged.ai ?? 0),
                            total_chars: (st?.total_chars ?? st?.totalUserChars ?? remoteVals?.total_chars ?? remoteVals?.['total_user_chars'] ?? merged.total_chars ?? merged.say ?? 0),
                            total_user_chars: (st?.total_chars ?? st?.totalUserChars ?? remoteVals?.total_chars ?? merged.total_chars ?? merged.say ?? 0),
                            avg_message_length: (function() {
                                if (st && st.totalMessages > 0 && (st.totalUserChars != null || st.total_chars != null)) return (st.totalUserChars || st.total_chars || 0) / st.totalMessages;
                                // ã€ä¿®å¤ã€‘æ‰©å±•æ•°æ®æºï¼Œä»æ›´å¤šæ¥æºè·å–å¹³å‡é•¿åº¦
                                var v = remoteVals?.avg_message_length ?? remoteVals?.['avg_user_message_length'] ?? 
                                        merged.avg_message_length ?? merged.avg_user_message_length ?? 
                                        payload2?.avg_message_length ?? payload2?.avg_user_message_length ??
                                        payload2?.data?.avg_message_length ?? payload2?.data?.avg_user_message_length ??
                                        myCountryFromApi?.avg_message_length ?? myCountryFromApi?.avg_user_message_length;
                                if (v != null && Number(v) > 0) return Number(v);
                                // å°è¯•ä» raw data è·å–
                                var rawAvg = payload2?.__raw?.avg_user_message_length ?? payload2?.__raw?.avg_message_length;
                                if (rawAvg != null && Number(rawAvg) > 0) return Number(rawAvg);
                                // è®¡ç®—å…œåº•
                                var tc = merged.total_chars ?? merged.say ?? merged.total_user_chars ?? remoteVals?.total_chars ?? myCountryFromApi?.total_chars ?? myCountryFromApi?.say ?? 0;
                                var tm = merged.total_messages ?? merged.ai ?? remoteVals?.total_messages ?? myCountryFromApi?.total_messages ?? myCountryFromApi?.ai ?? 0;
                                return (tm > 0 && tc > 0) ? (Number(tc) / Number(tm)) : 0;
                            })(),
                            jiafang_count: (st?.jiafang_count ?? st?.no ?? remoteVals?.jiafang_count ?? merged.jiafang_count ?? merged.no ?? 0),
                            ketao_count: (st?.ketao_count ?? st?.please ?? remoteVals?.ketao_count ?? merged.ketao_count ?? merged.please ?? 0),
                            work_days: (st?.work_days ?? st?.usage_days ?? remoteVals?.work_days ?? remoteVals?.usage_days ?? merged.work_days ?? merged.usage_days ?? merged.day ?? 0)
                        };
                        // å…³é”®ï¼šé«˜åˆ†å›¾è°±çš„æ•°æ®æºæ¥è‡ª country-summaryï¼Œè€Œä¸æ˜¯ global-average
                        try {
                            data.topByMetrics = payload2.topByMetrics || payload2.data?.topByMetrics || [];
                        } catch { /* ignore */ }

                        const totalCountriesCount = totalCountriesFromData;
                        const MEDALS = { 1: 'ğŸ¥‡', 2: 'ğŸ¥ˆ', 3: 'ğŸ¥‰' };
                        const DIM_TO_LETTER = { total_messages:'L', total_chars:'P', total_user_chars:'D', avg_message_length:'E', jiafang_count:'F', ketao_count:'G', work_days:'H' };
                        const rowTotals = (label, totalVal, r, dimKey) => {
                            const letter = DIM_TO_LETTER[dimKey] || dimKey;
                            const rankFromRanks = (countryDataByCode[userCountry]?.ranks || {})[letter];
                            const denom = (r && (r.total != null && Number.isFinite(Number(r.total)))) ? Number(r.total) : totalCountriesCount;
                            const rankNum = (r && (r.rank ?? r._rank) != null && Number.isFinite(Number(r.rank ?? r._rank))) ? Number(r.rank ?? r._rank) : (rankFromRanks != null && Number.isFinite(Number(rankFromRanks)) ? Number(rankFromRanks) : null);
                            const hasRank = rankNum != null && rankNum > 0;
                            var rankText;
                            if (hasRank) {
                                rankText = '#' + rankNum + ' / ' + denom;
                            } else if (denom === 1 || denom === '1') {
                                rankText = '#1 / 1';
                            } else if (r && typeof r === 'object' && (r.rank != null || r.total != null)) {
                                rankText = '#-- / ' + (denom || '--');
                            } else {
                                rankText = 'N/A';
                            }
                            const medal = rankNum != null && MEDALS[rankNum] ? ' ' + MEDALS[rankNum] : '';
                            const ice = (rankNum != null && denom > 0 && rankNum >= Math.ceil(denom * 0.9)) ? ' ğŸ§Š' : '';
                            // ã€å¥å£®æ€§å¤„ç†ã€‘wd ä¸ºç©ºæˆ–0æ—¶æ˜¾ç¤º "0" è€Œä¸æ˜¯ "N/A" æˆ– "..."
                            let displayVal;
                            if (dimKey === 'work_days') {
                                // ä¸Šå²—å¤©æ•°ç‰¹æ®Šå¤„ç†ï¼šç¡®ä¿æ˜¾ç¤ºæ•°å­—ï¼Œå³ä½¿ä¸º0
                                const workDaysVal = Number(totalVal ?? 0);
                                displayVal = Number.isNaN(workDaysVal) ? '0' : String(workDaysVal);
                            } else {
                                displayVal = (totalVal === undefined || totalVal === null) ? '...' : fmt(totalVal);
                            }
                            // ã€country-work-days å…ƒç´ ç»‘å®šã€‘ä¸ºä¸Šå²—å¤©æ•°æ·»åŠ ç‰¹æ®Š ID
                            const workDaysIdAttr = dimKey === 'work_days' ? ' id="country-work-days"' : '';
                            return `
                                <div class="flex items-center justify-between gap-3 border-b border-white/10 pb-2"${workDaysIdAttr}>
                                    <div class="text-zinc-200">${label}</div>
                                    <div class="flex items-center gap-3 min-w-0">
                                        <span class="text-[10px] text-zinc-500">Î£ ${displayVal}</span>
                                        <span class="text-[10px] text-[var(--accent-terminal)] font-bold tabular-nums">${rankText}${medal}${ice}</span>
                                    </div>
                                </div>
                            `;
                        };
                        const fmtMe = (v) => (v === undefined || v === null || Number.isNaN(Number(v))) ? '0' : fmt(v);
                        const pioneerLabel = currentLang === 'en' ? 'Pioneer' : 'è¯¥å›½å…ˆé”‹';
                        const DIM_KEYS = ['total_messages','total_chars','avg_message_length','jiafang_count','ketao_count','work_days'];
                        // ã€ä¿®å¤ã€‘æ‰©å±• global_user_ranks çš„æ•°æ®æº
                        var gRanksFallback = {};
                        if (payload2.myCountryRanks) {
                            gRanksFallback = {
                                total_messages: payload2.myCountryRanks.rank_messages,
                                total_chars: payload2.myCountryRanks.rank_chars,
                                avg_user_message_length: payload2.myCountryRanks.rank_avg_len,
                                jiafang_count: payload2.myCountryRanks.rank_jiafang,
                                ketao_count: payload2.myCountryRanks.rank_ketao,
                                work_days: payload2.myCountryRanks.rank_days
                            };
                        }
                        const gRanks = payload2.global_user_ranks || payload2.data?.global_user_ranks || 
                                       payload2.personalRanks || payload2.data?.personalRanks ||
                                       gRanksFallback || {};
                        const cRanks = payload2.country_user_ranks || payload2.data?.country_user_ranks || ranks || {};
                        const rankDimMap = { total_messages: 'rank_messages', total_chars: 'rank_chars', work_days: 'rank_days', jiafang_count: 'rank_jiafang', ketao_count: 'rank_ketao', avg_user_message_length: 'rank_avg_len' };
                        const rowRanks = (label, myVal, dimKey) => {
                            const dimKeyAlt = dimKey === 'avg_message_length' ? 'avg_user_message_length' : dimKey;
                            const rankKey = rankDimMap[dimKey] || rankDimMap[dimKeyAlt];
                            const cr = ranks?.[dimKey] ?? (rankKey ? ranks?.[rankKey] : null) ?? cRanks[dimKey] ?? ranks?.[dimKeyAlt] ?? (rankKey ? ranks?.[rankKey] : null) ?? cRanks[dimKeyAlt] ?? (dimKey === 'total_chars' ? (ranks?.total_chars ?? ranks?.rank_chars ?? cRanks?.total_chars) : null);
                            const gr = gRanks[dimKey] ?? gRanks[dimKeyAlt] ?? (dimKey === 'total_chars' ? gRanks?.total_chars : null);
                            let rankCountry = cr && ((cr.rank ?? cr._rank) != null) && Number.isFinite(Number(cr.rank ?? cr._rank)) ? Number(cr.rank ?? cr._rank) : null;
                            let totalCountry = cr && (cr.total != null) ? Number(cr.total) : 0;
                            let rankGlobal = gr && (gr.rank ?? gr._rank) != null ? Number(gr.rank ?? gr._rank) : null;
                            let totalGlobal = gr && gr.total != null ? Number(gr.total) : 0;
                            
                            // ã€ä¿®å¤ã€‘æ”¹è¿›å…¨çƒæ’åçš„è·å–é€»è¾‘
                            const userData = window.currentUserData || window.currentUser || {};
                            const vibeRank = Number(userData?.vibe_rank ?? userData?.vibeRank ?? NaN);
                            const totalUsersFallback = effectiveIsGlobal ? globalTotalUsers : (window.__globalTotalUsers || (window.lastData && (window.lastData.totalUsers != null) ? Number(window.lastData.totalUsers) : 0) || globalTotalUsers);
                            
                            // å¦‚æœ gRanks æ²¡æœ‰æä¾›å…¨çƒæ’åï¼Œå°è¯•ä» personalRanks è·å–
                            if ((rankGlobal == null || totalGlobal <= 0) && payload2.personalRanks) {
                                const pr = payload2.personalRanks;
                                if (dimKey === 'total_messages' && pr.ai != null) rankGlobal = Number(pr.ai);
                                if (dimKey === 'total_chars' && (pr.say != null || pr.total_chars != null)) rankGlobal = Number(pr.say ?? pr.total_chars);
                                if (dimKey === 'avg_message_length' && pr.word != null) rankGlobal = Number(pr.word);
                                if (dimKey === 'jiafang_count' && pr.no != null) rankGlobal = Number(pr.no);
                                if (dimKey === 'ketao_count' && pr.please != null) rankGlobal = Number(pr.please);
                                if (dimKey === 'work_days' && pr.day != null) rankGlobal = Number(pr.day);
                                if (rankGlobal != null) totalGlobal = totalUsersFallback;
                            }
                            
                            // æœ€åå…œåº•ï¼šå¦‚æœä»ç„¶æ²¡æœ‰å…¨çƒæ’åï¼Œä½¿ç”¨ vibe_rank
                            if ((rankGlobal == null || totalGlobal <= 0) && Number.isFinite(vibeRank) && vibeRank > 0 && totalUsersFallback > 0) {
                                rankGlobal = Math.min(totalUsersFallback, Math.max(1, Math.round(vibeRank)));
                                totalGlobal = totalUsersFallback;
                            }
                            var countryText;
                            if (rankCountry != null && totalCountry != null && totalCountry > 0) {
                                if (typeof currentViewState === 'string' && currentViewState === 'COUNTRY') {
                                    countryText = currentLang === 'en' ? `#${rankCountry} in country` : `è¯¥å›½ç¬¬ ${rankCountry} å`;
                                    if (totalCountry > 1) countryText += (currentLang === 'en' ? ` / ${totalCountry}` : ` / å…± ${totalCountry} äºº`);
                                } else {
                                    countryText = `æœ¬å›½ï¼š#${rankCountry}/${totalCountry}`;
                                }
                            } else {
                                countryText = currentLang === 'en' ? '(country): --' : 'è¯¥å›½ï¼š--';
                            }
                            const globalText = (rankGlobal != null && totalGlobal != null && totalGlobal > 0) ? (currentLang === 'en' ? `Global: #${rankGlobal}/${totalGlobal}` : `å…¨çƒï¼š#${rankGlobal}/${totalGlobal}`) : (currentLang === 'en' ? 'Global: --' : 'å…¨çƒï¼š--');
                            const medal = rankCountry != null && MEDALS[rankCountry] ? ' ' + MEDALS[rankCountry] : (rankGlobal != null && MEDALS[rankGlobal] ? ' ' + MEDALS[rankGlobal] : '');
                            const isPioneer = rankCountry === 1 && totalCountry != null && totalCountry <= 5;
                            const pioneerBadge = isPioneer ? ` <span class="text-[9px] text-amber-400" title="${pioneerLabel}">ğŸ…</span>` : '';
                            const localLabel = currentLang === 'en' ? '(country)' : 'ï¼ˆæœ¬å›½ï¼‰';
                            const globalLabel = currentLang === 'en' ? '(global)' : 'ï¼ˆå…¨çƒï¼‰';
                            // ã€ä¸Šå²—å¤©æ•°ã€‘åªæ˜¾ç¤ºä¸€è¡Œã€Œå·²ä¸Šå²—: 126 å¤©ã€æˆ–ã€Œ126 å¤©ã€ï¼Œä¸é‡å¤æ•°å­—
                            let workDaysLabel = '';
                            let displayValMe = fmtMe(myVal);
                            if (dimKey === 'work_days') {
                                const userWorkDays = Number(userData?.work_days ?? userData?.usage_days ?? myVal ?? 0);
                                if (userWorkDays > 0 && Number.isFinite(userWorkDays)) {
                                    displayValMe = currentLang === 'en' ? `${userWorkDays} days on duty` : `å·²ä¸Šå²— ${userWorkDays} å¤©`;
                                    workDaysLabel = '';
                                } else {
                                    displayValMe = fmtMe(myVal);
                                }
                            }
                            return `
                                <div class="flex items-center justify-between gap-3 border-b border-white/10 pb-2">
                                    <div class="text-zinc-200">${label}</div>
                                    <div class="flex flex-col items-end gap-0.5 min-w-0">
                                        <span class="text-[10px] text-zinc-400">${displayValMe}${workDaysLabel}</span>
                                        <span class="text-[10px] text-[var(--accent-terminal)] font-bold tabular-nums">${countryText}${medal}${pioneerBadge} | ${globalText}</span>
                                    </div>
                                </div>
                            `;
                        };

                        // å›½å®¶ç´¯è®¡ï¼šå³ä¾§æŠ½å±‰æ‰€æœ‰æ•°å€¼ï¼ˆai, say, day, no, pleaseï¼‰ä¸¥æ ¼ä» payload.countryTotals è¯»å–
                        // æ³¨æ„ï¼šåç«¯ countryTotalsRanks é”®åæ˜¯ avg_user_message_lengthï¼Œéœ€è¦å…¼å®¹
                        // ã€ä¿®å¤ã€‘ä½¿ç”¨ hasValidTotals ç¡®ä¿æ•°æ®çœŸæ­£æœ‰æ•ˆï¼Œè€Œéä»…åˆ¤æ–­å¯¹è±¡å­˜åœ¨
                        const totalsHtml = hasValidTotals
                            ? [
                                rowTotals(getI18nText('countryTotals.messages') || 'Messages', totals.total_messages ?? totals.ai ?? 0, totalsRanks?.total_messages, 'total_messages'),
                                rowTotals(getI18nText('countryTotals.totalChars') || 'Total Chars', totals.total_chars ?? totals.say ?? 0, totalsRanks?.total_chars, 'total_chars'),
                                rowTotals(getI18nText('countryTotals.avgLen') || 'Avg Len', Math.round(Number(totals.avg_message_length ?? totals['avg_user_message_length'] ?? totals.word ?? 0) || 0), totalsRanks?.avg_user_message_length ?? totalsRanks?.avg_message_length, 'avg_message_length'),
                                rowTotals(getI18nText('countryTotals.jiafang') || 'Jiafang', totals.jiafang_count ?? totals.no ?? 0, totalsRanks?.jiafang_count, 'jiafang_count'),
                                rowTotals(getI18nText('countryTotals.ketao') || 'Ketao', totals.ketao_count ?? totals.please ?? 0, totalsRanks?.ketao_count, 'ketao_count'),
                                rowTotals(getI18nText('countryTotals.workDays') || 'ä¸Šå²—å¤©æ•°', totals.work_days ?? totals.work_days_sum ?? totals.day ?? 0, totalsRanks?.work_days, 'work_days'),
                              ].join('')
                            : `<div class="text-zinc-500 text-xs">${currentLang === 'en' ? 'No data' : 'æš‚æ— æ•°æ®'}</div>`;

                        const ranksHtml = hasValidTotals
                            ? [
                                rowRanks(getI18nText('countryTotals.messages') || 'Messages', meVals?.total_messages, 'total_messages'),
                                rowRanks(getI18nText('countryTotals.totalChars') || 'Total Chars', meVals?.total_chars, 'total_chars'),
                                rowRanks(getI18nText('countryTotals.avgLen') || 'Avg Len', Math.round(Number(meVals?.avg_message_length ?? meVals?.['avg_user_message_length']) || 0), 'avg_message_length'),
                                rowRanks(getI18nText('countryTotals.jiafang') || 'Jiafang', meVals?.jiafang_count, 'jiafang_count'),
                                rowRanks(getI18nText('countryTotals.ketao') || 'Ketao', meVals?.ketao_count, 'ketao_count'),
                                rowRanks(getI18nText('countryTotals.workDays') || 'ä¸Šå²—å¤©æ•°', meVals?.work_days ?? meVals?.usage_days ?? 0, 'work_days'),
                              ].join('')
                            : `<div class="text-zinc-500 text-xs">${currentLang === 'en' ? 'No data' : 'æš‚æ— æ•°æ®'}</div>`;

                        if (totalsBox) totalsBox.innerHTML = totalsHtml;
                        if (ranksBox) ranksBox.innerHTML = ranksHtml;
                        try { window.__countryTotalsCache.set(cacheKey2, { totalsHtml, ranksHtml, ts: Date.now() }); } catch { /* ignore */ }
                        // æœ‰ countryTotals å³æ›´æ–°æ’å UIï¼ˆå«è¯¥å›½å…¨ 0 çš„é¦–äººæƒ…å†µï¼‰ï¼Œç§»é™¤ animate-pulseï¼Œä¸¥ç¦å›é€€å…¨çƒæ•°æ®
                        if (payload2.countryTotals && typeof updateCountryRankUI === 'function') updateCountryRankUI(payload2);
                        // å›½å®¶è§†å›¾æˆåŠŸåï¼šä»…å®šå‘è°ƒç”¨ renderUserStatsCards/æ’åæ›´æ–°ã€‚ä¸¥ç¦è°ƒç”¨ refreshUserStatsï¼Œå¦åˆ™ä¼šé‡æ–°æ‹‰å–å¹¶è¦†ç›–å·²åŒæ­¥çš„ allData ç¼“å­˜ã€‚
                        if (!effectiveIsGlobal) {
                            try {
                                var baseUser = window.currentUserData || window.currentUser || {};
                                var myVals = payload2.myCountryValues || payload2.data?.myCountryValues || {};
                                var myCountry = payload2.myCountry || payload2.data?.myCountry || {};
                                var merged = Object.assign({}, baseUser, myVals, myCountry);
                                if (merged.personality_name === undefined && merged.personalityName === undefined) {
                                    merged.personalityName = merged.personality_name = (baseUser.personality_name || baseUser.personalityName || (currentLang === 'en' ? 'Unknown Title' : 'æœªçŸ¥äººæ ¼'));
                                }
                                if (!merged.personality_type && !merged.personalityType) merged.personality_type = baseUser.personality_type || baseUser.personalityType || 'UNKNOWN';
                                if (merged.personality_type && !merged.personalityType) merged.personalityType = merged.personality_type;
                                if (merged.personalityType && !merged.personality_type) merged.personality_type = merged.personalityType;
                                if (!merged.personality && baseUser.personality) merged.personality = baseUser.personality;
                                window.currentUserData = merged;
                                window.currentUser = merged;
                                var leftBody = document.getElementById('left-drawer-body');
                                if (leftBody && typeof renderUserStatsCards === 'function') renderUserStatsCards(leftBody, getBestUserRecordForStats(merged));
                                if (typeof renderRankCards === 'function' && (merged.id || merged.fingerprint)) renderRankCards(merged);
                            } catch (e) { console.warn('[updateCountryDashboard] æ³¨å…¥å·¦ä¾§åç‰‡å¤±è´¥:', e); }
                            try { if (typeof window.highlightSelectedCountry === 'function') window.highlightSelectedCountry(); } catch (e) {}
                        }
                    }
                } catch (e) {
                    if (e && e.name === 'AbortError') return; // é™é»˜ä¸­æ­¢ï¼Œä¸æŠ¥é”™
                    // ä¸é˜»æ–­ä¸»é¢æ¿ï¼›å›½å®¶æ•°æ®åŠ è½½å¤±è´¥æ—¶æ˜¾ç¤º #-- / --
                    try {
                        const totalsBox = document.getElementById('rtCountryTotals');
                        const ranksBox = document.getElementById('rtMyCountryRanks');
                        const failRank = '<span class="text-[10px] text-zinc-500 font-bold tabular-nums">#-- / --</span>';
                        const dimLabels = [
                            getI18nText('countryTotals.messages') || 'Messages',
                            getI18nText('countryTotals.totalChars') || 'Total Chars',
                            getI18nText('countryTotals.avgLen') || 'Avg Len',
                            getI18nText('countryTotals.jiafang') || 'Jiafang',
                            getI18nText('countryTotals.ketao') || 'Ketao',
                            getI18nText('countryTotals.workDays') || 'ä¸Šå²—å¤©æ•°'
                        ];
                        const fallback = dimLabels.map(l => `<div class="flex items-center justify-between gap-3 border-b border-white/10 pb-2"><div class="text-zinc-200">${l}</div><div>${failRank}</div></div>`).join('');
                        if (totalsBox && !totalsBox.innerHTML.trim()) totalsBox.innerHTML = fallback;
                        if (ranksBox && !ranksBox.innerHTML.trim()) ranksBox.innerHTML = fallback;
                    } catch { /* ignore */ }
                }

                // æ•°å€¼å¡«å…… + UI é™çº§ï¼š0/ç©ºä¸é—ªçƒ
                // è§„åˆ™ï¼šåœ°åŒºå¡ç‰‡å±•ç¤ºâ€œå½“å‰åœ°åŒºâ€å£å¾„ï¼›å…¨ç½‘æ¨¡å¼å±•ç¤ºå…¨ç½‘
                setValueOrNA(usersValEl, effectiveIsGlobal ? globalTotalUsers : localTotalUsers);
                setValueOrNA(analysisValEl, effectiveIsGlobal ? globalTotalAnalysis : localTotalAnalysis);
                if (usersValEl && usersValEl.textContent !== 'N/A') flash(usersCardEl || usersValEl);
                if (analysisValEl && analysisValEl.textContent !== 'N/A') flash(analysisCardEl || analysisValEl);

                // é›·è¾¾å›¾ï¼šhas_valid_data ä¸ºçœŸæ—¶å§‹ç»ˆæ¸²æŸ“å›¾è¡¨ä¸”ä¸éšè—å®¹å™¨ï¼›ä»…æ— æœ‰æ•ˆæ•°æ®ä¸”å…¨ 0 æ—¶æ˜¾ç¤ºâ€œæ•°æ®ä¸è¶³â€
                const hasValidRadarData = record && record.has_valid_data === true;
                if (radarData.every((v) => Number(v) === 0) && !hasValidRadarData) {
                    renderRadarMessage(getI18nText('radar.insufficient') || 'Not enough data');
                } else {
                    renderRadar(radarData);
                    if (window.__countryRadarChart && record && record.has_valid_data === true) {
                        try {
                            window.__countryRadarChart.setOption({ series: [{ data: [{ value: radarData }] }] });
                            window.__countryRadarChart.resize();
                        } catch (e) { /* ignore */ }
                    }
                    try {
                        requestAnimationFrame(function() {
                            if (window.__countryRadarChart && typeof window.__countryRadarChart.resize === 'function') {
                                window.__countryRadarChart.resize();
                            }
                        });
                    } catch (e) { /* ignore */ }
                }
                if (radarDom && radarDom.closest) {
                    const radarCard = radarDom.closest('.clinic-card');
                    if (radarCard && hasValidRadarData) radarCard.style.display = '';
                }

                // å¼€å‘è€…ç”»åƒï¼ˆTop Personalityï¼‰ï¼šå›½å®¶è§†å›¾ä¸‹ç”¨ top_personality æ›´æ–°æ ‡é¢˜ä¸æ ·å¼
                try {
                    const radarCard = radarDom && radarDom.closest ? radarDom.closest('.clinic-card') : null;
                    const cardTitleEl = radarCard ? radarCard.querySelector('.card-header .card-title') : null;
                    const topPersonality = data.top_personality ?? data.countryStats?.top_personality ?? data.topPersonality ?? null;
                    const ab = (topPersonality && (topPersonality.answer_book || topPersonality.answerBook)) ? (topPersonality.answer_book || topPersonality.answerBook) : null;
                    const personaTitle = (ab && (ab.title || ab.name)) ? String(ab.title || ab.name).trim() : '';
                    const countryDisplayName = (typeof countryNameMap !== 'undefined' && countryNameMap && countryCode) ? (currentLang === 'zh' ? (countryNameMap[countryCode]?.zh || countryCode) : (countryNameMap[countryCode]?.en || countryCode)) : (countryCode || '');
                    if (cardTitleEl) {
                        if (!effectiveIsGlobal && (personaTitle || countryDisplayName)) {
                            cardTitleEl.textContent = countryDisplayName ? (personaTitle ? `${countryDisplayName} Â· ${personaTitle}` : `${countryDisplayName} å¼€å‘è€…ç”»åƒ`) : (personaTitle || (currentLang === 'en' ? 'Top Personality' : 'å¼€å‘è€…ç”»åƒ'));
                        } else {
                            cardTitleEl.textContent = currentLang === 'en' ? 'Global Developer Persona' : 'å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒ';
                        }
                    }
                    // è¯¥å›½å¹³å‡ Vibe æŒ‡æ•°åŠ¨æ€ç€è‰²ï¼šç”¨é›·è¾¾äº”ç»´å¹³å‡æˆ– top_personality çš„ lpdef æ¨ç®—
                    if (radarCard && !effectiveIsGlobal) {
                        const avgVibe = radarData.length ? (radarData.reduce((s, v) => s + Number(v) || 0, 0) / radarData.length) : 0;
                        const lpdefStr = (topPersonality && (topPersonality.lpdef || topPersonality.lpDef)) ? String(topPersonality.lpdef || topPersonality.lpDef) : '';
                        const vibeIdx = (lpdefStr && typeof lpdefToVibeIndex === 'function') ? lpdefToVibeIndex(lpdefStr) : null;
                        const hue = vibeIdx ? (function() { const n = parseInt(String(vibeIdx).slice(0, 2) || '11', 10) || 11; return 120 + (n % 3) * 40; })() : (avgVibe < 40 ? 200 : avgVibe < 70 ? 150 : 45);
                        const accent = vibeIdx != null ? `hsl(${hue}, 80%, 55%)` : 'var(--accent-terminal)';
                        radarCard.style.setProperty('--radar-card-accent', accent);
                        radarCard.style.borderLeftStyle = 'solid';
                        radarCard.style.borderLeftColor = accent;
                        radarCard.style.borderLeftWidth = '2px';
                    } else if (radarCard) {
                        radarCard.style.removeProperty('--radar-card-accent');
                        radarCard.style.borderLeftStyle = '';
                        radarCard.style.borderLeftColor = '';
                        radarCard.style.borderLeftWidth = '';
                    }
                } catch (e) { console.warn('[updateCountryDashboard] å¼€å‘è€…ç”»åƒæ ·å¼æ›´æ–°å¤±è´¥:', e); }

                // =========================
                // æ´¾ç”ŸæŒ‡æ ‡è®¡ç®—ä¸æ¸²æŸ“
                // =========================
                const clampPct = (n) => {
                    const x = Number(n);
                    if (!Number.isFinite(x)) return 0;
                    return Math.max(0, Math.min(100, x));
                };
                const avgL = radarData[0];
                const avgP = radarData[1];
                const avgD = radarData[2];
                const avgE = radarData[3];
                const avgF = radarData[4];

                const metrics = {
                    power: clampPct(avgD * 0.7 + avgP * 0.3),
                    breakdown: clampPct((100 - avgE) * 0.8),
                    semantic: clampPct(avgL * 0.6 + avgF * 0.4),
                    ratio: clampPct(globalTotalUsers > 0 ? (localTotalUsers / globalTotalUsers) * 100 : 0),
                };
                if (effectiveIsGlobal) metrics.ratio = 100;

                // æ•°å€¼å¡«å……
                const powerScoreEl = document.getElementById('rtPowerScore');
                const breakdownRateEl = document.getElementById('rtBreakdownRate');
                const semanticScoreEl = document.getElementById('rtSemanticScore');
                const ratioPctEl = document.getElementById('rtRatioPct');
                if (powerScoreEl) powerScoreEl.textContent = Number.isFinite(metrics.power) ? metrics.power.toFixed(1) : 'N/A';
                if (breakdownRateEl) breakdownRateEl.textContent = Number.isFinite(metrics.breakdown) ? `${metrics.breakdown.toFixed(1)}%` : 'N/A';
                if (semanticScoreEl) semanticScoreEl.textContent = Number.isFinite(metrics.semantic) ? metrics.semantic.toFixed(1) : 'N/A';
                if (ratioPctEl) ratioPctEl.textContent = `${metrics.ratio.toFixed(2)}%`;

                // è¿›åº¦æ¡è”åŠ¨
                const setBar = (id, v) => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const pct = clampPct(v);
                    el.style.width = `${pct.toFixed(1)}%`;
                };
                setBar('power-bar', metrics.power);
                setBar('breakdown-bar', metrics.breakdown);
                setBar('semantic-bar', metrics.semantic);
                setBar('ratio-bar', metrics.ratio);

                // =========================
                // é«˜åˆ†å›¾è°±ï¼šç”± drawHighScores ç»Ÿä¸€æ¸²æŸ“åˆ° .vibe-index-leaderboardï¼ˆdata.topByMetrics -> it.leadersï¼Œå­—æ®µ vibe_index_numï¼‰
                // =========================
                let topBy = Array.isArray(data.topByMetrics) ? data.topByMetrics : [];
                const metricOrder = [
                    'total_messages', 'total_chars', 'avg_message_length',
                    'jiafang_count', 'ketao_count', 'work_days'
                ];
                topBy = topBy.slice().sort((a, b) => metricOrder.indexOf(String(a?.key || '')) - metricOrder.indexOf(String(b?.key || '')));
                window.__resolveUserMeta = _resolveUserMeta;
                if (typeof drawHighScores === 'function') drawHighScores(topBy);

                // è¯­ä¹‰çˆ†å‘è¯äº‘å¡ç‰‡ï¼šä»…ä¿ç•™è¯äº‘å½¢æ€ï¼ˆECharts wordCloudï¼‰ï¼Œä¸å†æ¸²æŸ“ slang/merit/sv_slang æ–‡æœ¬åŒº
                // è¯äº‘æ•°æ®ç”± loadWordCloud() é€šè¿‡ /api/v2/wordcloud-data åŠ¨æ€æ‹‰å–

                // =========================
                // éœ€æ±‚ï¼šå…¨çƒå æ¯” (#rtGlobalRatio)
                // ã€ä¿®å¤ã€‘ä½¿ç”¨å‰é¢ä¿®å¤çš„ localTotalUsers å’Œ globalTotalUsers
                // å…¬å¼ï¼š(localTotalUsers / globalTotalUsers * 100).toFixed(1) + '%'
                // åŒæ­¥æ›´æ–°æ–‡å­—ä¸è¿›åº¦æ¡
                // =========================
                const globalRatioEl = document.getElementById('rtGlobalRatio');
                const ratioPct = (globalTotalUsers > 0)
                    ? (localTotalUsers / globalTotalUsers) * 100
                    : (effectiveIsGlobal ? 100 : metrics.ratio);
                const ratioPctClamped = clampPct(Number.isFinite(ratioPct) ? ratioPct : 0);
                const ratioText = `${ratioPctClamped.toFixed(1)}%`;
                if (globalRatioEl) globalRatioEl.textContent = ratioText;
                if (ratioPctEl) ratioPctEl.textContent = ratioText;
                setBar('ratio-bar', ratioPctClamped);

                // é¥¼å›¾ï¼ˆECharts pieï¼‰ï¼šæ›¿æ¢æ—§ SVG ç¯å½¢å›¾
                try {
                    const pieDom = document.getElementById('rtGlobalRatioPie');
                    if (pieDom && typeof echarts !== 'undefined') {
                        const own = clampPct(ratioPctClamped);
                        const rest = clampPct(100 - own);
                        const label = effectiveIsGlobal ? 'GLOBAL' : (countryCode || 'REGION');
                        try {
                            const existing = window.__rtGlobalRatioPieChart;
                            const domChanged = existing && typeof existing.getDom === 'function' && existing.getDom() !== pieDom;
                            if (domChanged) {
                                try { existing.dispose(); } catch { /* ignore */ }
                                window.__rtGlobalRatioPieChart = null;
                            }
                        } catch { /* ignore */ }
                        if (!window.__rtGlobalRatioPieChart) {
                            window.__rtGlobalRatioPieChart = echarts.init(pieDom, null, { renderer: 'canvas' });
                            if (!window.__rtGlobalRatioPieResizeBound) {
                                window.__rtGlobalRatioPieResizeBound = true;
                                window.addEventListener('resize', () => {
                                    try { window.__rtGlobalRatioPieChart && window.__rtGlobalRatioPieChart.resize(); } catch { /* ignore */ }
                                });
                            }
                        }
                        window.__rtGlobalRatioPieChart.setOption({
                            backgroundColor: 'transparent',
                            tooltip: { trigger: 'item' },
                            series: [
                                {
                                    type: 'pie',
                                    radius: ['58%', '82%'],
                                    avoidLabelOverlap: true,
                                    label: { show: false },
                                    labelLine: { show: false },
                                    data: [
                                        { name: label, value: own, itemStyle: { color: '#00ff41' } },
                                        { name: 'OTHERS', value: rest, itemStyle: { color: '#3f3f46' } },
                                    ],
                                }
                            ]
                        }, true);
                    }
                } catch { /* ignore */ }

                // å¤ç”¨ç°æœ‰ PK æ¡ï¼ˆå·¦=Powerï¼Œå³=100-Powerï¼‰
                const pkLeftFill = document.getElementById('rtPkLeftFill');
                const pkRightFill = document.getElementById('rtPkRightFill');
                const pkLeftPct = document.getElementById('rtPkLeftPct');
                const pkRightPct = document.getElementById('rtPkRightPct');
                if (pkLeftFill) pkLeftFill.style.width = `${metrics.power.toFixed(1)}%`;
                if (pkRightFill) pkRightFill.style.width = `${(100 - metrics.power).toFixed(1)}%`;
                if (pkLeftPct) pkLeftPct.textContent = `${metrics.power.toFixed(1)}%`;
                if (pkRightPct) pkRightPct.textContent = `${(100 - metrics.power).toFixed(1)}%`;

                // ç ´é˜²ç­‰çº§ / å—è™äººæ•°ï¼ˆæ´¾ç”Ÿå±•ç¤ºï¼‰
                const meltdownLevelEl = document.getElementById('rtMeltdownLevel');
                const meltdownVictimsEl = document.getElementById('rtMeltdownVictims');
                if (meltdownLevelEl) {
                    meltdownLevelEl.textContent =
                        metrics.breakdown >= 70 ? 'ELEVATED' :
                        metrics.breakdown >= 40 ? 'WARNING' :
                        'STABLE';
                }
                if (meltdownVictimsEl) {
                    meltdownVictimsEl.textContent = Number.isFinite(localTotalUsers)
                        ? new Intl.NumberFormat(currentLang === 'en' ? 'en-US' : 'zh-CN').format(Math.max(0, localTotalUsers))
                        : 'N/A';
                }

                // è¯­ä¹‰çˆ†å‘è¡¥å……æ–‡æ¡ˆï¼šæ ¸å¿ƒç‰¹è´¨ + æŒ‡æ ‡
                const dimKeys = ['L', 'P', 'D', 'E', 'F'];
                let maxIdx = 0;
                for (let i = 1; i < radarData.length; i++) {
                    if (Number(radarData[i]) > Number(radarData[maxIdx])) maxIdx = i;
                }
                const coreTrait = dimKeys[maxIdx] || 'L';
                const coreTraitEl = document.getElementById('rtCoreTrait');
                const traitMap = {
                    L: { zh: 'é€»è¾‘åŠ›', en: 'Logic' },
                    P: { zh: 'è€å¿ƒå€¼', en: 'Patience' },
                    D: { zh: 'ç»†è…»åº¦', en: 'Detail' },
                    E: { zh: 'æ¢ç´¢æ¬²', en: 'Exploration' },
                    F: { zh: 'åé¦ˆæ„Ÿ', en: 'Feedback' },
                };
                const traitName = (currentLang === 'en' ? (traitMap[coreTrait]?.en) : (traitMap[coreTrait]?.zh)) || coreTrait;
                if (coreTraitEl) {
                    coreTraitEl.textContent =
                        (currentLang === 'en')
                            ? `Core trait: ${traitName} (${coreTrait}) Â· highest of 5D averages`
                            : `è¯¥åœ°åŒºæ ¸å¿ƒç‰¹è´¨ï¼š${traitName}ï¼ˆ${coreTrait}ï¼‰Â· è¯¥å›½ 5 ç»´å¹³å‡åˆ†æœ€é«˜é¡¹`;
                }

                const semanticMostUsedEl = document.getElementById('rtSemanticMostUsed');
                const semanticFreqEl = document.getElementById('rtSemanticFreq');
                const coreTraitPrefix = typeof getI18nText === 'function' ? getI18nText('panel.core_trait_prefix') : 'CORE_TRAIT';
                const semanticPrefix = typeof getI18nText === 'function' ? getI18nText('panel.semantic_score_prefix') : 'SEMANTIC';
                if (semanticMostUsedEl) semanticMostUsedEl.textContent = `${coreTraitPrefix}: ${traitName} (${coreTrait})`;
                if (semanticFreqEl) semanticFreqEl.textContent = `${semanticPrefix}: ${metrics.semantic.toFixed(1)}`;

                // å…¨çƒå æ¯”åˆ—è¡¨ï¼ˆç®€å•ä¸¤é¡¹ï¼‰
                const ratioListEl = document.getElementById('rtRatioList');
                if (ratioListEl) {
                    const label = effectiveIsGlobal ? 'GLOBAL' : (countryCode ? countryCode : 'REGION');
                    const ownPct = clampPct(Number.isFinite(ratioPct) ? ratioPct : metrics.ratio);
                    const rest = clampPct(100 - ownPct);
                    ratioListEl.innerHTML = `
                        <div class="flex justify-between text-xs">
                            <span class="flex items-center gap-2"><div class="w-2 h-2 bg-[#00ff41]"></div> ${label}</span>
                            <span class="font-bold">${ownPct.toFixed(2)}%</span>
                        </div>
                        <div class="flex justify-between text-xs text-zinc-500">
                            <span class="flex items-center gap-2"><div class="w-2 h-2 bg-zinc-700"></div> OTHERS</span>
                            <span class="font-bold">${rest.toFixed(2)}%</span>
                        </div>
                    `;
                }

                // NOTE: å·²åœ¨ä¸Šæ–¹â€œæ´¾ç”ŸæŒ‡æ ‡è®¡ç®—ä¸æ¸²æŸ“ / è¯­ä¹‰çˆ†å‘ï¼ˆçœŸå®åŠ¨æ€åŒ–ï¼‰â€å®Œæˆæ¸²æŸ“ï¼Œ
                // è¿™é‡Œä¸å†é‡å¤è¦†ç›– powerScore / semanticBurstï¼Œé¿å… UI æŠ–åŠ¨ä¸é€»è¾‘åˆ†å‰ã€‚

                // äººæ ¼åˆ†å¸ƒï¼šå›½å®¶è§†å›¾ç”¨ get_country_personality_distribution æ‹‰å–è¯¥å›½æ•°æ®ï¼Œå…¨ç½‘ç”¨ latest_records èšåˆ
                (async function renderPersonalityDistributionForDrawer() {
                    const box = document.getElementById('rtRealtimeList');
                    if (!box) return;
                    if (!effectiveIsGlobal && target_country && (typeof supabaseClient !== 'undefined' && supabaseClient && typeof supabaseClient.rpc === 'function')) {
                        try {
                            const { data: distData, error } = await supabaseClient.rpc('get_country_personality_distribution', { target_country_code: target_country });
                            if (!error && Array.isArray(distData) && distData.length > 0) {
                                const distribution = distData.map((row) => ({
                                    type: String(row.personality_type ?? row.type ?? row.personality_type_code ?? 'UNKNOWN').toUpperCase(),
                                    count: Number(row.count ?? row.cnt ?? row.total ?? 0) || 0
                                })).filter((it) => it.count > 0).sort((a, b) => b.count - a.count);
                                const total = distribution.reduce((s, it) => s + it.count, 0);
                                const maxPct = total > 0 ? Math.max(...distribution.map((it) => (it.count / total) * 100)) : 0;
                                box.className = 'personality-vbar-chart';
                                box.innerHTML = distribution.map((item) => {
                                    const pctVal = total > 0 ? (item.count / total) * 100 : 0;
                                    const pct = pctVal.toFixed(1);
                                    const heightPct = maxPct > 0 ? Math.max(4, (pctVal / maxPct) * 100) : 0;
                                    const title = typeof getPersonalityTitle === 'function' ? getPersonalityTitle(item, currentLang) : (item.type || '');
                                    return `<div class="personality-vbar-col"><div class="personality-vbar-bar-wrap"><div class="personality-vbar-fill" style="height: ${heightPct}%;"></div></div><span class="personality-vbar-name" title="${escapeHtml(title)}">${escapeHtml(title)}</span><span class="personality-vbar-pct">${pct}%</span></div>`;
                                }).join('');
                                return;
                            }
                        } catch (e) { console.warn('[updateCountryDashboard] get_country_personality_distribution å¤±è´¥ï¼Œå›é€€ latest_records:', e); }
                    }
                    renderRealtime(latest);
                })();

                if (statusEl) statusEl.textContent = getI18nText('panel.data_stable') || 'DATA: STABLE';
            } catch (err) {
                if (fetchTimeoutId) { clearTimeout(fetchTimeoutId); fetchTimeoutId = null; }
                const isAbort = err && (err.name === 'AbortError' || (err.message && String(err.message).includes('aborted')));
                if (isAbort) {
                    console.log('[Info] æ—§è¯·æ±‚å·²é™é»˜ä¸­æ­¢');
                    return;
                }
                console.error('[CountryDashboard] âŒ æ›´æ–°å¤±è´¥:', err);
                const message = (err && err.message) ? String(err.message) : 'ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡å™¨é”™è¯¯';
                if (statusEl) statusEl.textContent = (currentLang === 'en' ? 'Network error' : 'ç½‘ç»œå¼‚å¸¸');
                renderErrorState(message);
                try {
                    const totalsBox = document.getElementById('rtCountryTotals');
                    const ranksBox = document.getElementById('rtMyCountryRanks');
                    const failRank = '<span class="text-[10px] text-zinc-500 font-bold tabular-nums">#-- / --</span>';
                    const dimLabels = [
                        getI18nText('countryTotals.messages') || 'Messages',
                        getI18nText('countryTotals.totalChars') || 'Total Chars',
                        getI18nText('countryTotals.avgLen') || 'Avg Len',
                        getI18nText('countryTotals.jiafang') || 'Jiafang',
                        getI18nText('countryTotals.ketao') || 'Ketao',
                        getI18nText('countryTotals.workDays') || 'ä¸Šå²—å¤©æ•°'
                    ];
                    const fallback = dimLabels.map(l => `<div class="flex items-center justify-between gap-3 border-b border-white/10 pb-2"><div class="text-zinc-200">${l}</div><div>${failRank}</div></div>`).join('');
                    if (totalsBox && totalsBox.innerHTML.includes('åŠ è½½ä¸­')) totalsBox.innerHTML = fallback;
                    if (ranksBox && ranksBox.innerHTML.includes('åŠ è½½ä¸­')) ranksBox.innerHTML = fallback;
                } catch { /* ignore */ }
            } finally {
                isProcessingUpdate = false;
                try { setRightDrawerLoading(false); } catch { /* ignore */ }
            }
        }
        
        // ==========================================
        // åŸæœ‰ä»£ç ç»§ç»­...
        // ==========================================
        
        // =========================
        // å…¨å±€å˜é‡å£°æ˜ï¼ˆç¡®ä¿åœ¨å…¨å±€ä½œç”¨åŸŸï¼Œä¸åœ¨é—­åŒ…å†…ï¼‰
        // =========================
        const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content;
        // stats2 å¤šè¯­è¨€ï¼šä»¥ localStorage.lang ä¸ºå‡†ï¼ˆ'en' | 'zh'ï¼‰
        const LANG_STORAGE_KEY = 'lang';
        const normalizeLang = (v) => {
            const s = String(v || '').trim().toLowerCase();
            if (s === 'en' || s.startsWith('en')) return 'en';
            if (s === 'zh' || s === 'zh-cn' || s.startsWith('zh')) return 'zh';
            return 'zh';
        };
        let currentLang = (() => {
            try {
                const savedLang = localStorage.getItem(LANG_STORAGE_KEY);
                // å…¼å®¹æ—§é”®ï¼šappLanguageï¼ˆindex.html å†å²é—ç•™ï¼‰
                const fallback = localStorage.getItem('appLanguage');
                return normalizeLang(savedLang || fallback || 'zh');
            } catch {
                return 'zh';
            }
        })();
        
        // å¿½ç•¥æµè§ˆå™¨æ‰©å±•è§¦å‘çš„æ— å…³æœªå¤„ç† Promise é”™è¯¯ï¼ˆé¿å…æ§åˆ¶å°åˆ· "message channel closed"ï¼‰
        window.addEventListener('unhandledrejection', function (event) {
            const msg = (event.reason && (event.reason.message || String(event.reason))) || '';
            if (typeof msg === 'string' && msg.includes('message channel closed') && msg.includes('asynchronous response')) {
                event.preventDefault();
                event.stopPropagation();
            }
        }, true);

        // Supabase ç›¸å…³å˜é‡ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼Œä¸åœ¨ä»»ä½•å‡½æ•°å†…ï¼‰
        let supabaseClient = null;
        let realtimeChannel = null;
        let presenceChannel = null; // Presence é¢‘é“ï¼Œç”¨äºç»Ÿè®¡åœ¨çº¿äººæ•°
        const SUPABASE_URL = 'https://dtcplfhcgnxdzpigmotb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_-rrlujgXDNxqb-UsMJckNw_G2rn2e8x';
        
        // é»˜è®¤å¤´åƒå¸¸é‡ï¼ˆåŒ¿åå—å®³è€…ï¼šä½¿ç”¨å†…ç½® SVGï¼Œé¿å…ä¾èµ–å¤–é“¾ identiconï¼‰
        const DEFAULT_AVATAR = "data:image/svg+xml;utf8," + encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
              <defs>
                <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0" stop-color="#00ff41" stop-opacity="0.9"/>
                  <stop offset="1" stop-color="#00b7ff" stop-opacity="0.9"/>
                </linearGradient>
              </defs>
              <rect x="2" y="2" width="60" height="60" rx="14" fill="#0a0a0a" stroke="url(#g)" stroke-width="2"/>
              <circle cx="24" cy="28" r="5" fill="#e5e7eb"/>
              <circle cx="40" cy="28" r="5" fill="#e5e7eb"/>
              <rect x="20" y="40" width="24" height="6" rx="3" fill="#e5e7eb" opacity="0.9"/>
              <path d="M18 18h28" stroke="#00ff41" stroke-opacity="0.55" stroke-width="3" stroke-linecap="round"/>
              <path d="M18 50h28" stroke="#00ff41" stroke-opacity="0.25" stroke-width="3" stroke-linecap="round"/>
            </svg>
        `);
        
        // æ— æ•ˆç”¨æˆ·åçš„é»˜è®¤å€¼åˆ—è¡¨ï¼ˆè¿™äº›å€¼ä¸åº”è¯¥è¯·æ±‚GitHubå¤´åƒï¼‰
        const INVALID_USERNAME_VALUES = ['è‡ªåŠ¨ä¸ŠæŠ¥ç”¨æˆ·', 'Anonymous', 'Guest', 'guest', 'anonymous', ''];
        
        // ç”¨æˆ·çŠ¶æ€é…ç½®ï¼šåœ¨çº¿=å¯äº’å‘æ¶ˆæ¯ï¼Œå¿™ç¢Œ=ä»–äººä¸å¯ç»™è¯¥ç”¨æˆ·å‘æ¶ˆæ¯ï¼Œç¦»çº¿=ä¸å¯å‘æ¶ˆæ¯ä¸”ä»–äººä¸å¯ç»™è¯¥ç”¨æˆ·å‘æ¶ˆæ¯
        const USER_STATUSES = {
            idle: { 
                label: 'åœ¨çº¿', 
                emoji: 'ğŸŸ¢', 
                color: '#00ff41',
                status_color: '#00ff41',
                status: 'idle',
                descZh: 'å¯äº’å‘æ¶ˆæ¯',
                descEn: 'Users can send messages to each other'
            },
            busy: { 
                label: 'å¿™ç¢Œ', 
                emoji: 'ğŸŸ ', 
                color: '#ff8c00',
                status_color: '#ff8c00',
                status: 'busy',
                descZh: 'å…¶ä»–ç”¨æˆ·ä¸èƒ½ç»™ä½ å‘æ¶ˆæ¯',
                descEn: 'Other users cannot send you messages'
            },
            sprint: { 
                label: 'ç¦»çº¿', 
                emoji: 'âš«', 
                color: '#71717a',
                status_color: '#71717a',
                status: 'sprint',
                descZh: 'ä¸èƒ½å‘æ¶ˆæ¯ï¼Œä»–äººä¹Ÿä¸èƒ½ç»™ä½ å‘æ¶ˆæ¯',
                descEn: 'Cannot send messages; others cannot send you messages'
            }
        };
        
        // å½“å‰ç”¨æˆ·çŠ¶æ€ï¼ˆä»localStorageåŠ è½½ï¼‰
        let currentUserStatus = localStorage.getItem('user_status') || 'idle';
        
        // æŠ½å±‰å±•å¼€/æŠ˜å çŠ¶æ€ï¼ˆä»localStorageåŠ è½½ï¼‰
        let drawerExpanded = localStorage.getItem('drawer_expanded') !== 'false'; // é»˜è®¤å±•å¼€

        // ç»´åº¦æ’åæ•°æ®èµ„æºï¼ˆä» rank-content.ts åŠ è½½ï¼‰
        let RANK_RESOURCES = null;

        // ============================================
        // ã€å…¨å±€é”™è¯¯æ•è·ã€‘é˜²æ­¢å•ä¸ªæ¨¡å—å´©æºƒå¯¼è‡´æ•´ä¸ªé¡µé¢æ— æ³•åŠ è½½
        // ============================================
        window.addEventListener('error', (event) => {
            console.error('[Global Error Handler] âŒ æ•è·åˆ°å…¨å±€é”™è¯¯:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
            
            // å¦‚æœæ˜¯è¯­æ³•é”™è¯¯ï¼Œå°è¯•ç»§ç»­æ‰§è¡Œå…³é”®åˆå§‹åŒ–
            if (event.error && event.error.name === 'SyntaxError') {
                console.warn('[Global Error Handler] âš ï¸ æ£€æµ‹åˆ°è¯­æ³•é”™è¯¯ï¼Œå°è¯•ç»§ç»­åˆå§‹åŒ–å…³é”®åŠŸèƒ½...');
                // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œä½†è®°å½•é”™è¯¯
            }
        });
        
        // æ•è·æœªå¤„ç†çš„ Promise æ‹’ç»
        window.addEventListener('unhandledrejection', (event) => {
            console.error('[Global Error Handler] âŒ æ•è·åˆ°æœªå¤„ç†çš„ Promise æ‹’ç»:', event.reason);
            // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼ˆæ§åˆ¶å°æŠ¥é”™ï¼‰ï¼Œä½†è®°å½•é”™è¯¯
            event.preventDefault();
        });

        // ã€ä¸ index åŒæ­¥ã€‘æ¥æ”¶ index åˆ†æå®Œæˆåçš„æœ¬åœ°ç»“æœï¼Œå·¦ä¾§æŠ½å±‰ä¼˜å…ˆæ˜¾ç¤ºæœ¬åœ°æ•°æ®
        try {
            if (typeof BroadcastChannel !== 'undefined') {
                const vibeSyncChannel = new BroadcastChannel('vibe-stats-sync');
                vibeSyncChannel.onmessage = function (e) {
                    const msg = e && e.data;
                    if (msg && msg.type === 'local_analysis_complete' && msg.payload) {
                        window.last_local_stats = { ts: msg.ts || Date.now(), payload: msg.payload };
                        console.log('[Stats2] âœ… æ”¶åˆ° index æœ¬åœ°åˆ†æå®Œæˆå¹¿æ’­ï¼Œå·²è®¾ç½® last_local_stats');
                        var lb = document.getElementById('left-drawer-body');
                        if (lb && window.currentUser && typeof renderUserStatsCards === 'function') {
                            renderUserStatsCards(lb, getBestUserRecordForStats(window.currentUser));
                        }
                    }
                };
            }
        } catch (_) { /* ignore */ }
        
        // ============================================
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ï¼ˆå…¨å±€ä½œç”¨åŸŸç›´æ¥æ‰§è¡Œï¼‰
        // ============================================
        // ä½¿ç”¨è½®è¯¢æ–¹å¼ç­‰å¾… SDK åŠ è½½å®Œæˆ
        let initAttempts = 0;
        const maxAttempts = 50; // æœ€å¤šå°è¯• 5 ç§’ï¼ˆ50 * 100msï¼‰

        const initInterval = setInterval(() => {
            initAttempts++;
            
            // æ£€æŸ¥ supabase æ˜¯å¦å·²åŠ è½½
            if (typeof supabase !== 'undefined') {
                clearInterval(initInterval);
                
                try {
                    // å®ä¾‹åŒ–å®¢æˆ·ç«¯ï¼ˆç›´æ¥èµ‹å€¼ç»™å…¨å±€å˜é‡ï¼‰
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    window.supabase = supabaseClient;
                    // æŒ‚è½½åˆ°å…¨å±€ windowï¼Œä¾›æ§åˆ¶å°è„šæœ¬ä½¿ç”¨
                    window.supabaseClient = supabaseClient;
                    
                    console.log('[Init] âœ… Supabase å®¢æˆ·ç«¯å·²æˆåŠŸæŒ‚è½½è‡³ window.supabaseClient / window.supabase');
                    console.log('[Init] ğŸ’¡ å¯åœ¨æ§åˆ¶å°ä½¿ç”¨ window.supabaseClient è®¿é—®å®¢æˆ·ç«¯');
                } catch (err) {
                    console.error('[Init] âŒ åˆå§‹åŒ–å¤±è´¥:', err);
                }
            } else if (initAttempts >= maxAttempts) {
                clearInterval(initInterval);
                console.error('[Init] âŒ Supabase SDK åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– CDN æ˜¯å¦å¯è®¿é—®');
            }
        }, 100);
        const i18n = {
            zh: {
                // Tab å¯¼èˆª
                'tab.global': 'å…¨çƒ',
                'tab.country': 'å›½å®¶',
                'tab.ranking': 'æ’è¡Œæ¦œ',
                
                // Buttons / panel header / hotlist / PK
                'btn.back_global': '[è¿”å›å…¨ç½‘]',
                'btn.switch_country': '[å›½å®¶é€è§†]',
                'btn.refresh': '[åˆ·æ–°]',
                'panel.country_panel': 'å›½å®¶é€è§†',
                'pk.domineering': 'éœ¸é“å€¼',
                'pk.bootlick': 'è·ªèˆ”å€¼',
                'hotlist.title': 'é»‘è¯æ¦œ',
                'hotlist.building': 'æ­£åœ¨å»ºç«‹è¯¥åœ°åŒºé»‘è¯æ¦œ...',
                'hotlist.collecting': 'æš‚æ— æ•°æ®ï¼ˆæ­£åœ¨æ”¶å½•ä¸­...ï¼‰',
                'semantic.core_trait_empty': 'è¯¥åœ°åŒºæ ¸å¿ƒç‰¹è´¨ï¼š--',

                // Badges (card top-right)
                'badge.config': 'é…ç½®',
                'badge.stats': 'ç»Ÿè®¡',
                'badge.live': 'å®æ—¶',
                'badge.connect': 'è¿æ¥',
                'badge.syncing': 'åŒæ­¥',
                'top-title': 'Cursorè¡Œä¸ºæŠ¥å‘Šå…¨çƒåˆ†å¸ƒå›¾',
                'sub-title': '',
                'total-victims': 'å·²è¯Šæ–­å¼€å‘è€…',
                'total-analysis': 'å…¨ç½‘æ‰«ææ¬¡æ•°',
                'total-roast': 'ç´¯è®¡åæ§½å­—æ•°',
                'avg-chars': 'äººå‡åæ§½é‡',
                'radar-title': 'å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒ',
                'personality-dist': 'äººæ ¼åˆ†å¸ƒæ’è¡Œ',
                'active-nodes': 'æ´»è·ƒèŠ‚ç‚¹',
                'threat-level': 'ä½“æ£€äººæ•°',
                'top-hotspot': 'æœ€å¯†é›†çƒ­åŒº',
                'sys-days': 'è¿è¡Œå¤©æ•°',
                'city-coverage': 'åŸå¸‚è¦†ç›–',
                'sync-rate': 'åŒæ­¥é€Ÿç‡',
                'hot-list': 'åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ',
                'recent-activity': 'å®æ—¶è¯Šæ–­æ´»åŠ¨',
                'victim': 'å—å®³è€…',
                'loading': 'åˆå§‹åŒ–ä¸­...',
                'rank': 'æ’å',
                'select-country': 'é€‰æ‹©å›½å®¶',
                'search-countries': 'æœç´¢å›½å®¶...'
            },
            en: {
                'top-title': 'Cursor Behavior Report Â· Global Distribution Map',
                'sub-title': '',
                'total-victims': 'Total Developers',
                'total-analysis': 'Total Scans',
                'total-roast': 'Total Roast Words',
                'avg-chars': 'Avg Roast Per User',
                'radar-title': 'Global Developer Persona',
                'personality-dist': 'Personality Distribution',
                'active-nodes': 'Active Nodes',
                'threat-level': 'Physical Exam Count',
                'top-hotspot': 'Primary Hotspot',
                'sys-days': 'Days Online',
                'city-coverage': 'City Coverage',
                'sync-rate': 'Sync Rate',
                'hot-list': 'Geographic Hotspots',
                'recent-activity': 'Live Activity Feed',
                'victim': 'Victim',
                'loading': 'Initializing...',
                'rank': 'Rank',
                'select-country': 'Select Country',
                'search-countries': 'Search countries...'
            }
        };

        // ============================================
        // I18N_MAPï¼šåŠ¨æ€æ–‡æ¡ˆæ˜ å°„ï¼ˆä¸è¦ç›´æ¥ä¿¡ä»» RPC labelï¼‰
        // ============================================
        const I18N_MAP = {
            zh: {
                // å³æŠ½å±‰ Tab ä¸æŒ‰é’®ï¼ˆä¸­æ–‡ä¸‹å¿…é¡»æ˜¾ç¤ºä¸­æ–‡ï¼‰
                'tab.ranking': 'æ’è¡Œæ¦œ',
                'tab.global': 'å…¨çƒ',
                'tab.country': 'å›½å®¶',
                'btn.refresh': 'åˆ·æ–°',

                // Drawer / Panels
                'drawer.details': 'è¯¦ç»†ä¿¡æ¯',
                'drawer.my_stats': 'æˆ‘çš„æ•°æ®ç»Ÿè®¡',
                'drawer.tech_rank': 'æŠ€æœ¯æ’å',
                'rank.country': 'è¯¥å›½',
                'rank.global': 'å…¨çƒ',
                'rank.rank_n': 'ç¬¬ {n} å',
                'rank.total_people': 'å…± {n} äºº',
                'rank.global_rank_label': 'å…¨çƒæ’å',
                'drawer.personality_title': 'äººæ ¼ç§°å·',
                'drawer.real_evaluation': 'çœŸå®è¯„ä»·',

                // Country panel titles
                'panel.stats': 'ç»Ÿè®¡',
                'panel.radar': 'å¼€å‘è€…ç”»åƒ',
                'panel.personality_distribution': 'äººæ ¼åˆ†å¸ƒ',
                'panel.country_totals': 'å›½å®¶ç´¯è®¡',
                'panel.my_country_rank': 'æˆ‘çš„æ’å',
                'panel.qa_attitude': 'é—®ç­”æ€åº¦',
                'panel.meltdown_audit': 'ç ´é˜²ç›‘æµ‹',
                'panel.meltdown_index': 'ç ´é˜²æŒ‡æ•°',
                'panel.meltdown_level': 'ç ´é˜²ç­‰çº§',
                'panel.meltdown_victims': 'å—è™äººæ•°',
                'panel.wordcloud': 'æœ¬å›½è¯äº‘',
                'panel.lpdef_ranking': 'é«˜åˆ†å›¾è°±',
                'panel.global_ratio': 'å…¨çƒå æ¯”',

                // Country panel labels
                'panel.country_code': 'å›½å®¶è¯†åˆ«ç ',
                'panel.dev_scale': 'å¼€å‘è€…è§„æ¨¡',
                'panel.scan_count': 'è¯Šæ–­æ¬¡æ•°',

                // Right drawer status / labelsï¼ˆä¸­æ–‡ç‰ˆä¸‹å³æŠ½å±‰æ ‡é¢˜ä¸çŠ¶æ€ï¼‰
                'panel.live_feed': 'å®æ—¶æ•°æ®',
                'panel.coord_prefix': 'åæ ‡',
                'panel.coord_placeholder': 'åæ ‡ï¼š--',
                'panel.data_stable': 'æ•°æ®ï¼šç¨³å®š',
                'panel.data_cached': 'æ•°æ®ï¼šç¼“å­˜',
                'panel.data_fetching': 'æ•°æ®ï¼šè·å–ä¸­',
                'panel.data_error': 'æ•°æ®ï¼šé”™è¯¯',
                'panel.data_ready': 'æ•°æ®ï¼šå°±ç»ª',
                'panel.nation_prefix': 'å›½å®¶',
                'panel.pk_power': 'æƒåŠ›å€¼',
                'panel.pk_tsundere': 'å‚²å¨‡',
                'panel.pk_bootlick': 'è·ªèˆ”',
                'panel.national_cloud_50': 'æœ¬å›½è¯äº‘ 50',
                'panel.country_top_10': 'å›½å®¶ Top10',
                'panel.semantic_label': 'è¯­ä¹‰',
                'panel.most_used': 'æœ€å¸¸ç”¨',
                'panel.freq': 'é¢‘æ¬¡',
                'panel.elite_hint': 'å·¦æ»‘æŸ¥çœ‹é«˜åˆ†å›¾è°±',
                'panel.ratio_label': 'å æ¯”',
                'panel.global_ratio_label': 'å…¨çƒå æ¯”',
                'panel.core_trait_prefix': 'æ ¸å¿ƒç‰¹è´¨',
                'panel.semantic_score_prefix': 'è¯­ä¹‰åˆ†',
                'panel.meltdown_pending': 'å¾…è®¡ç®—',
                'panel.meltdown_words': 'å­—æ•°',
                'panel.others': 'å…¶ä»–',

                // Common
                'common.no_data': 'æš‚æ— æ•°æ®',
                'common.loading': 'åŠ è½½ä¸­...',
                'common.current_device': 'ï¼ˆå½“å‰è®¾å¤‡ï¼‰',
                'common.recruiting': 'å¾…æ‹›å‹Ÿ',
                'common.waiting': 'ç­‰å¾…åŠ å…¥',
                'common.syncing': 'æ•°æ®åŒæ­¥ä¸­',
                'common.connecting_cloud': 'æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®æºï¼Œè¯·ç¨å€™â€¦',
                'common.no_cloud_summary': 'æš‚æœªè·å–åˆ°äº‘ç«¯æ±‡æ€»æ•°æ®',
                'common.suggestion_run_once': 'å»ºè®®ï¼šå…ˆåœ¨ä¸»é¡µé¢å®Œæˆä¸€æ¬¡åˆ†æ/ä¸ŠæŠ¥ï¼Œç„¶ååˆ·æ–°æ­¤é¡µé¢ã€‚',

                // Personality / evaluation
                'personality.unknown': 'æœªçŸ¥äººæ ¼',

                // Metrics
                'metric.ai_interrogations': 'è°ƒæˆAIæ¬¡æ•°',
                'metric.jiafang': 'ç”²æ–¹ä¸Šèº«æ¬¡æ•°',
                'metric.ketao': 'èµ›åšç£•å¤´æ¬¡æ•°',
                'metric.cursor_days': 'ä¸Šå²—å¤©æ•°',
                'metric.banter_total': 'åºŸè¯è¾“å‡ºæ€»æ•°',
                'metric.avg_len': 'å¹³å‡å¹æ°´é•¿åº¦',
                'metric.avg_len_unit': 'å­—/æ¡',
                'metric.cursor_days_unit': 'å¤©',

                // Country totals table labels
                'countryTotals.messages': 'è°ƒæˆAIæ¬¡æ•°',
                'countryTotals.totalChars': 'å¯¹è¯å­—ç¬¦æ•°',
                'countryTotals.userChars': 'åºŸè¯è¾“å‡º',
                'countryTotals.avgLen': 'å¹³å‡é•¿åº¦',
                'countryTotals.jiafang': 'ç”²æ–¹ä¸Šèº«',
                'countryTotals.ketao': 'ç£•å¤´',
                'countryTotals.workDays': 'ä¸Šå²—å¤©æ•°',

                // Radar / states
                'radar.loading': 'æ•°æ®åŠ è½½ä¸­...',
                'radar.insufficient': 'è¯¥åœ°åŒºç”»åƒæ•°æ®ä¸è¶³ï¼Œæ­£åœ¨æ±‡æ€»ä¸­...',
                'realtime.none': 'æš‚æ— äººæ ¼åˆ†å¸ƒæ•°æ®',
                'lpdef.none': 'æš‚æ— é«˜åˆ†å›¾è°±æ•°æ®',

                // Tooltip labelsï¼ˆåœ°å›¾æ‚¬æµ®ï¼šè¯¥å›½å·²æäº¤èŠå¤©è®°å½•çš„ç”¨æˆ·æ•°ï¼Œéåœ¨çº¿äººæ•°ï¼‰
                'tooltip.active_nodes': 'å·²æäº¤ç”¨æˆ·',
                'tooltip.record': 'æˆ˜ç»©',
                'tooltip.roast': 'åæ§½',
                'tooltip.answers': 'ç­”æ¡ˆä¹‹ä¹¦',

                // Errors
                'error.data_load_failed': 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
            },
            en: {
                // Drawer / Panels
                'drawer.details': 'Details',
                'drawer.my_stats': 'My Stats',
                'drawer.tech_rank': 'Tech Rank',
                'rank.country': 'Country',
                'rank.global': 'Global',
                'rank.rank_n': 'No. {n}',
                'rank.total_people': 'Total {n}',
                'rank.global_rank_label': 'Global rank',
                'drawer.personality_title': 'Title',
                'drawer.real_evaluation': 'Real Evaluation',

                // Country panel titles
                'panel.stats': 'Stats',
                'panel.radar': 'Radar',
                'panel.personality_distribution': 'Personality Distribution',
                'panel.country_totals': 'Country Totals',
                'panel.my_country_rank': 'My Country Rank',
                'panel.qa_attitude': 'Q&A Attitude',
                'panel.meltdown_audit': 'Meltdown Audit',
                'panel.meltdown_index': 'Meltdown Index',
                'panel.meltdown_level': 'Meltdown Level',
                'panel.meltdown_victims': 'Victims',
                'panel.wordcloud': 'National Word Cloud',
                'panel.lpdef_ranking': 'LPDEF Ranking',
                'panel.global_ratio': 'Global Ratio',

                // Country panel labels
                'panel.country_code': 'Country Code',
                'panel.dev_scale': 'Developer Scale',
                'panel.scan_count': 'Scan Count',

                // Right drawer status / labels
                'panel.live_feed': 'LIVE_FEED',
                'panel.coord_prefix': 'COORD',
                'panel.coord_placeholder': 'COORD: --',
                'panel.data_stable': 'DATA: STABLE',
                'panel.data_cached': 'DATA: CACHED',
                'panel.data_fetching': 'DATA: FETCHING',
                'panel.data_error': 'DATA: ERROR',
                'panel.data_ready': 'DATA: READY',
                'panel.nation_prefix': 'NATION',
                'panel.pk_power': 'POWER',
                'panel.pk_tsundere': 'Tsundere',
                'panel.pk_bootlick': 'Bootlick',
                'panel.national_cloud_50': 'NATIONAL CLOUD 50',
                'panel.country_top_10': 'COUNTRY TOP 10',
                'panel.semantic_label': 'SEMANTIC',
                'panel.most_used': 'MOST_USED',
                'panel.freq': 'FREQ',
                'panel.elite_hint': 'Swipe to view Top Agents',
                'panel.ratio_label': 'RATIO',
                'panel.global_ratio_label': 'GLOBAL_RATIO',
                'panel.core_trait_prefix': 'Core trait',
                'panel.semantic_score_prefix': 'Semantic',
                'panel.meltdown_pending': 'PENDING',
                'panel.meltdown_words': 'WORDS',
                'panel.others': 'OTHERS',

                // Common
                'common.no_data': 'No data',
                'common.loading': 'Loading...',
                'common.current_device': ' (This Device)',
                'common.recruiting': 'Recruiting',
                'common.waiting': 'Waiting',
                'common.syncing': 'Syncing',
                'common.connecting_cloud': 'Connecting to cloud sourceâ€¦',
                'common.no_cloud_summary': 'No cloud summary available yet',
                'common.suggestion_run_once': 'Tip: run an analysis on the main page first, then refresh this page.',

                // Personality / evaluation
                'personality.unknown': 'Unknown Title',

                // Tab navigation
                'tab.global': 'Global',
                'tab.country': 'Country',
                'tab.ranking': 'Ranking',
                
                // Buttons / panel header / hotlist / PK
                'btn.back_global': '[Back to Global]',
                'btn.switch_country': '[Country Panel]',
                'btn.refresh': '[REFRESH]',
                'panel.country_panel': 'Country Panel',
                'pk.domineering': 'Dominance',
                'pk.bootlick': 'Bootlick',
                'hotlist.title': 'Vibe Hotlist',
                'hotlist.building': 'Building regional hotlist...',
                'hotlist.collecting': 'No data (collecting...)',
                'semantic.core_trait_empty': 'Core trait: --',

                // Badges (card top-right)
                'badge.config': 'CONFIG',
                'badge.stats': 'STATS',
                'badge.live': 'LIVE',
                'badge.connect': 'CONNECT',
                'badge.syncing': 'SYNCING',

                // Metrics
                'metric.ai_interrogations': 'AI Interactions',
                'metric.jiafang': 'Client Mode',
                'metric.ketao': 'Humble Mode',
                'metric.cursor_days': 'Days On Duty',
                'metric.banter_total': 'Banter Output',
                'metric.avg_len': 'Avg Prompt Length',
                'metric.avg_len_unit': 'chars/msg',
                'metric.cursor_days_unit': 'days',

                // Country totals table labels
                'countryTotals.messages': 'AI Interactions',
                'countryTotals.totalChars': 'Total Chars',
                'countryTotals.userChars': 'User Chars',
                'countryTotals.avgLen': 'Avg Len',
                'countryTotals.jiafang': 'Client Mode',
                'countryTotals.ketao': 'Humble Mode',
                'countryTotals.workDays': 'Work Days',

                // Radar / states
                'radar.loading': 'Loading...',
                'radar.insufficient': 'Not enough data yet. Aggregating...',
                'realtime.none': 'No personality distribution yet',
                'lpdef.none': 'No LPDEF ranking yet',

                // Tooltip labels (map: submitted chat record users per country, not online count)
                'tooltip.active_nodes': 'Submitted Users',
                'tooltip.record': 'Record',
                'tooltip.roast': 'Roast',
                'tooltip.answers': 'Answers',

                // Errors
                'error.data_load_failed': 'Failed to load data. Check your connection.'
            }
        };

        const DIMENSION_NAME_I18N = {
            ai: { zh: 'è°ƒæˆAIæ¬¡æ•°', en: 'AI Interactions', icon: 'ğŸ’¬', suffixZh: 'æ¬¡', suffixEn: 'times' },
            word: { zh: 'å¹³å‡é•¿åº¦', en: 'Avg Length', icon: 'ğŸ“', suffixZh: 'å­—/æ¡', suffixEn: 'chars/msg' },
            day: { zh: 'ä¸Šå²—å¤©æ•°', en: 'Days On Duty', icon: 'ğŸ“…', suffixZh: 'å¤©', suffixEn: 'days' },
            no: { zh: 'ç”²æ–¹ä¸Šèº«', en: 'Client Mode', icon: 'ğŸš«', suffixZh: 'æ¬¡', suffixEn: 'times' },
            say: { zh: 'åºŸè¯è¾“å‡º', en: 'Banter Output', icon: 'ğŸ’­', suffixZh: 'å­—', suffixEn: 'chars' },
            please: { zh: 'èµ›åšç£•å¤´', en: 'Humble Mode', icon: 'ğŸ™', suffixZh: 'æ¬¡', suffixEn: 'times' }
        };

        const getI18nText = (key, fallback = '') => {
            try {
                const lang = currentLang === 'en' ? 'en' : 'zh';
                const fallbackLang = lang === 'zh' ? 'en' : 'zh';
                const fromMap = (I18N_MAP && I18N_MAP[lang] && I18N_MAP[lang][key]) || (I18N_MAP && I18N_MAP[fallbackLang] && I18N_MAP[fallbackLang][key]);
                const fromI18n = (i18n && i18n[lang] && i18n[lang][key]) || (i18n && i18n[fallbackLang] && i18n[fallbackLang][key]);
                return fromMap || fromI18n || (fallback != null ? String(fallback) : '') || '';
            } catch (e) {
                return (fallback != null ? String(fallback) : '') || '';
            }
        };

        // å…¨å±€ HTML è½¬ä¹‰ï¼ˆå†å²ä»£ç é‡Œæœ‰å¤šå¤„å¼•ç”¨ escapeHtmlï¼‰
        // æ³¨æ„ï¼šåº•å±‚å®ç°ä½¿ç”¨ _escapeHtmlï¼ˆå‡½æ•°å£°æ˜ä¼šè¢«æå‡ï¼Œå¯å®‰å…¨åœ¨å…¶å®šä¹‰å‰è°ƒç”¨ï¼‰
        function escapeHtml(s) {
            try { return _escapeHtml(String(s ?? '')); } catch { return String(s ?? ''); }
        }

        function translatePage() {
            const lang = currentLang === 'en' ? 'en' : 'zh';
            try {
                // æŒ‰ç”¨æˆ·è¦æ±‚ï¼šä¼˜å…ˆ data-t
                document.querySelectorAll('[data-t]').forEach((el) => {
                    const k = el.getAttribute('data-t');
                    if (!k) return;
                    const v = getI18nText(k, '');
                    if (v) el.textContent = v;
                });
            } catch { /* ignore */ }
            // å±æ€§å¼ç¿»è¯‘ï¼šæŠ½å±‰å†…ç»Ÿè®¡å¡ç‰‡ç­‰æ‰€æœ‰å¸¦ data-i18n çš„å…ƒç´ 
            try {
                document.querySelectorAll('[data-i18n]').forEach((el) => {
                    const k = el.getAttribute('data-i18n');
                    if (!k) return;
                    const v = getI18nText(k, '');
                    if (v) el.textContent = v;
                });
            } catch { /* ignore */ }

            // å…¼å®¹ç°å­˜å®ç°ï¼šlang-key + data-key
            try {
                document.querySelectorAll('.lang-key').forEach((el) => {
                    const k = el.getAttribute('data-key');
                    if (!k) return;
                    const v = (i18n[lang] && i18n[lang][k]) ? i18n[lang][k] : '';
                    if (v) el.textContent = v;
                });
            } catch { /* ignore */ }
        }

        // ============================================
        // å¯é€‰ï¼šåŠ è½½è‹±æ–‡ç§°å·/æ ‡ç­¾é…ç½®ï¼ˆå¦‚ rank_en.jsonï¼‰
        // ============================================
        let __languageConfigLoaded = false;
        async function loadLanguageConfig() {
            if (__languageConfigLoaded) return;
            __languageConfigLoaded = true;
            try {
                const tryFetchJson = async (paths) => {
                    for (const p of paths) {
                        try {
                            const resp = await fetch(p + (p.indexOf('?') >= 0 ? '&' : '?') + '_t=' + Date.now());
                            if (!resp.ok) continue;
                            const ct = resp.headers.get('content-type') || '';
                            if (!ct.includes('json')) continue;
                            return await resp.json();
                        } catch { /* ignore */ }
                    }
                    return null;
                };

                // è¿™äº›æ–‡ä»¶ä¸æ˜¯å¼ºä¾èµ–ï¼šä¸å­˜åœ¨æ—¶é™é»˜è·³è¿‡
                const rankEn = await tryFetchJson([
                    './rank_en.json',
                    './src/rank_en.json',
                    './rank-en.json',
                    './src/rank-en.json'
                ]);

                const personalityNamesEn = await tryFetchJson([
                    './personalityNames_en.json',
                    './src/personalityNames_en.json',
                    './personality-names-en.json',
                    './src/personality-names-en.json'
                ]);
                const personalityNamesZh = await tryFetchJson([
                    './personalityNames.json',
                    './src/personalityNames.json',
                    './personality-names.json',
                    './src/personality-names.json'
                ]);

                // ç­”æ¡ˆä¹‹ä¹¦ï¼šä¸­è‹±æ–‡å…±ç”¨åŒä¸€ä»½ JSONï¼ˆ{[vibeIndex]: {title_zh,content_zh,title_en,content_en}}ï¼‰
                const answerBookByVibeIndex = await tryFetchJson([
                    './answerBookByVibeIndex.json',
                    './src/answerBookByVibeIndex.json',
                    './answer-book-by-vibe-index.json',
                    './src/answer-book-by-vibe-index.json'
                ]);

                window.__LANG_CONFIG = { rankEn, personalityNamesEn, personalityNamesZh, answerBookByVibeIndex };
            } catch { /* ignore */ }
        }

        const translateDimensionName = (dimId) => {
            const x = DIMENSION_NAME_I18N[dimId];
            if (!x) return String(dimId || '');
            return currentLang === 'en' ? x.en : x.zh;
        };
        const translateDimensionSuffix = (dimId) => {
            const x = DIMENSION_NAME_I18N[dimId];
            if (!x) return '';
            return currentLang === 'en' ? (x.suffixEn || '') : (x.suffixZh || '');
        };

        // â€œç å†œâ€è‹±æ–‡æ˜ å°„ï¼šæŒ‰åˆ†æ•°æ®µåˆ‡æ¢ Code Monkey / Architect
        const mapCoderTitleToEn = (userData) => {
            try {
                const totalUsers = Number(window.lastData?.totalUsers) || 0;
                const vibeRank = Number(userData?.vibe_rank || userData?.vibeRank || NaN);
                const vibePercentile = Number(userData?.vibe_percentile || userData?.vibePercentile || NaN);
                const avgRank = Number(userData?.avg_rank || userData?.avgRank || NaN); // 0-100ï¼Œè¶Šå¤§è¶Šå¼º

                // è§„åˆ™ï¼šTop 10% æˆ– percentile>=90 æˆ– avgRank>=80 => Architectï¼Œå¦åˆ™ Code Monkey
                if (Number.isFinite(vibeRank) && totalUsers > 0) {
                    if (vibeRank <= Math.max(1, Math.floor(totalUsers * 0.10))) return 'Architect';
                }
                if (Number.isFinite(vibePercentile) && vibePercentile >= 90) return 'Architect';
                if (Number.isFinite(avgRank) && avgRank >= 80) return 'Architect';
                return 'Code Monkey';
            } catch {
                return 'Code Monkey';
            }
        };

        const translatePersonalityName = (name, userData) => {
            const raw = String(name || '').trim();
            if (currentLang !== 'en') return raw;
            if (!raw) return raw;
            if (raw.includes('ç å†œ')) return mapCoderTitleToEn(userData);
            // è‹¥å¤–éƒ¨è‹±æ–‡ç§°å·è¡¨å­˜åœ¨ï¼Œä¼˜å…ˆä½¿ç”¨ï¼ˆvibe_index_str -> nameï¼‰
            try {
                const idx = String(userData?.vibe_index_str || userData?.vibeIndexStr || userData?.vibeIndex || '').trim();
                const cfg = window.__LANG_CONFIG;
                if (cfg && cfg.personalityNamesEn && idx && idx.length === 5) {
                    const hit = cfg.personalityNamesEn[idx];
                    if (typeof hit === 'string' && hit.trim()) return hit.trim();
                    if (hit && typeof hit === 'object' && (hit.name || hit.title)) return String(hit.name || hit.title).trim();
                }
            } catch { /* ignore */ }
            return raw;
        };

        const translateRankFeedbackLabel = (dimId, label, value) => {
            const raw = String(label || '').trim();
            if (currentLang !== 'en') return raw;
            if (!raw) return raw;
            try {
                const cfg = window.__LANG_CONFIG;
                const rankEn = cfg && cfg.rankEn ? cfg.rankEn : null;
                const d = String(dimId || '').trim();
                if (rankEn && d) {
                    // æ”¯æŒå¤šç§å¯èƒ½ç»“æ„ï¼šrankEn[dimId][label] / rankEn[dimId].labels[label]
                    const direct = rankEn?.[d]?.[raw];
                    if (typeof direct === 'string' && direct.trim()) return direct.trim();
                    const nested = rankEn?.[d]?.labels?.[raw];
                    if (typeof nested === 'string' && nested.trim()) return nested.trim();
                }
            } catch { /* ignore */ }

            // å°èŒƒå›´å…œåº•ï¼šè‹¥æŸäº› label æ°å¥½æ˜¯ä¸­æ–‡ç§°å·
            if (raw.includes('ç å†œ')) {
                return (Number(value) >= 80) ? 'Architect' : 'Code Monkey';
            }
            return raw;
        };

        function updateLanguageContext() {
            // åªå‡†ç¿»è¯‘ï¼Œä¸å‡†è¯·æ±‚ï¼šä»…æ‰§è¡Œ data-t / data-i18n æ–‡æœ¬æ›¿æ¢ï¼Œç¦æ­¢è§¦å‘ refreshCountryRightPanel æˆ– updateCountryDashboard
            let next = currentLang;
            try {
                next = normalizeLang(localStorage.getItem(LANG_STORAGE_KEY) || localStorage.getItem('appLanguage') || currentLang);
            } catch { /* ignore */ }
            currentLang = next === 'en' ? 'en' : 'zh';

            try { localStorage.setItem(LANG_STORAGE_KEY, currentLang); } catch { /* ignore */ }
            try { localStorage.setItem('appLanguage', currentLang === 'en' ? 'en' : 'zh-CN'); } catch { /* ignore */ }
            try { document.documentElement.setAttribute('lang', currentLang === 'en' ? 'en' : 'zh-CN'); } catch { /* ignore */ }

            const btnZh = document.getElementById('btn-zh');
            const btnEn = document.getElementById('btn-en');
            if (btnZh) btnZh.classList.toggle('active', currentLang === 'zh');
            if (btnEn) btnEn.classList.toggle('active', currentLang === 'en');

            try {
                const sub = document.getElementById('sub-title');
                if (sub) sub.innerText = (i18n[currentLang] && i18n[currentLang]['sub-title']) ? i18n[currentLang]['sub-title'] : (sub.innerText || '');
            } catch { /* ignore */ }
            // ä»…ç¿»è¯‘ï¼šdata-t + data-i18n + lang-keyï¼Œä¸è°ƒç”¨ä»»ä½• refresh/updateCountryDashboard
            document.querySelectorAll('[data-t]').forEach((el) => {
                const k = el.getAttribute('data-t');
                if (!k) return;
                const v = getI18nText(k, '');
                if (v) el.textContent = v;
            });
            document.querySelectorAll('[data-i18n]').forEach((el) => {
                const k = el.getAttribute('data-i18n');
                if (!k) return;
                const v = getI18nText(k, '');
                if (v) el.textContent = v;
            });
            document.querySelectorAll('.lang-key').forEach((el) => {
                const k = el.getAttribute('data-key');
                if (!k) return;
                const lang = currentLang === 'en' ? 'en' : 'zh';
                const v = (i18n[lang] && i18n[lang][k]) ? i18n[lang][k] : '';
                if (v) el.textContent = v;
            });

            updateHeaderViewToggleBtn();
        }

        const countryNameMap = {
            'CN': { zh: 'ä¸­å›½', en: 'China' },
            // æ³¨æ„ï¼šECharts world åœ°å›¾å¯¹ç¾å›½çš„æ ‡å‡†åç§°é€šå¸¸æ˜¯ 'United States' / 'United States of America'
            // è¿™é‡Œç”¨ 'United States' ä½œä¸º enï¼Œä¾¿äºåœ°å›¾ name åŒ¹é…ä¸ç‚¹å‡»è§£æ
            'US': { zh: 'ç¾å›½', en: 'United States' },
            'JP': { zh: 'æ—¥æœ¬', en: 'Japan' },
            'GB': { zh: 'è‹±å›½', en: 'UK' },
            'DE': { zh: 'å¾·å›½', en: 'Germany' },
            'SG': { zh: 'æ–°åŠ å¡', en: 'Singapore' },
            'HK': { zh: 'ä¸­å›½é¦™æ¸¯', en: 'Hong Kong' },
            'TW': { zh: 'ä¸­å›½å°æ¹¾', en: 'Taiwan' },
            // æ‰©å±•æ›´å¤šå¸¸è§å›½å®¶çš„ä¸­æ–‡åç§°
            'AF': { zh: 'é˜¿å¯Œæ±—', en: 'Afghanistan' },
            'AX': { zh: 'å¥¥å…°ç¾¤å²›', en: 'Ã…land Islands' },
            'AL': { zh: 'é˜¿å°”å·´å°¼äºš', en: 'Albania' },
            'DZ': { zh: 'é˜¿å°”åŠåˆ©äºš', en: 'Algeria' },
            'AS': { zh: 'ç¾å±è¨æ‘©äºš', en: 'American Samoa' },
            'AD': { zh: 'å®‰é“å°”', en: 'Andorra' },
            'AO': { zh: 'å®‰å“¥æ‹‰', en: 'Angola' },
            'AI': { zh: 'å®‰åœ­æ‹‰', en: 'Anguilla' },
            'AQ': { zh: 'å—ææ´²', en: 'Antarctica' },
            'AG': { zh: 'å®‰æç“œå’Œå·´å¸ƒè¾¾', en: 'Antigua and Barbuda' },
            'AR': { zh: 'é˜¿æ ¹å»·', en: 'Argentina' },
            'AM': { zh: 'äºšç¾å°¼äºš', en: 'Armenia' },
            'AW': { zh: 'é˜¿é²å·´', en: 'Aruba' },
            'AU': { zh: 'æ¾³å¤§åˆ©äºš', en: 'Australia' },
            'AT': { zh: 'å¥¥åœ°åˆ©', en: 'Austria' },
            'AZ': { zh: 'é˜¿å¡æ‹œç–†', en: 'Azerbaijan' },
            'BS': { zh: 'å·´å“ˆé©¬', en: 'Bahamas' },
            'BH': { zh: 'å·´æ—', en: 'Bahrain' },
            'BD': { zh: 'å­ŸåŠ æ‹‰å›½', en: 'Bangladesh' },
            'BB': { zh: 'å·´å·´å¤šæ–¯', en: 'Barbados' },
            'BY': { zh: 'ç™½ä¿„ç½—æ–¯', en: 'Belarus' },
            'BE': { zh: 'æ¯”åˆ©æ—¶', en: 'Belgium' },
            'BZ': { zh: 'ä¼¯åˆ©å…¹', en: 'Belize' },
            'BJ': { zh: 'è´å®', en: 'Benin' },
            'BM': { zh: 'ç™¾æ…•å¤§', en: 'Bermuda' },
            'BT': { zh: 'ä¸ä¸¹', en: 'Bhutan' },
            'BO': { zh: 'ç»åˆ©ç»´äºš', en: 'Bolivia' },
            'BA': { zh: 'æ³¢é»‘', en: 'Bosnia and Herzegovina' },
            'BW': { zh: 'åšèŒ¨ç“¦çº³', en: 'Botswana' },
            'BV': { zh: 'å¸ƒéŸ¦å²›', en: 'Bouvet Island' },
            'BR': { zh: 'å·´è¥¿', en: 'Brazil' },
            'IO': { zh: 'è‹±å±å°åº¦æ´‹é¢†åœ°', en: 'British Indian Ocean Territory' },
            'BN': { zh: 'æ–‡è±', en: 'Brunei Darussalam' },
            'BG': { zh: 'ä¿åŠ åˆ©äºš', en: 'Bulgaria' },
            'BF': { zh: 'å¸ƒåŸºçº³æ³•ç´¢', en: 'Burkina Faso' },
            'BI': { zh: 'å¸ƒéš†è¿ª', en: 'Burundi' },
            'KH': { zh: 'æŸ¬åŸ”å¯¨', en: 'Cambodia' },
            'CM': { zh: 'å–€éº¦éš†', en: 'Cameroon' },
            'CA': { zh: 'åŠ æ‹¿å¤§', en: 'Canada' },
            'CV': { zh: 'ä½›å¾—è§’', en: 'Cape Verde' },
            'KY': { zh: 'å¼€æ›¼ç¾¤å²›', en: 'Cayman Islands' },
            'CF': { zh: 'ä¸­é', en: 'Central African Republic' },
            'TD': { zh: 'ä¹å¾—', en: 'Chad' },
            'CL': { zh: 'æ™ºåˆ©', en: 'Chile' },
            'CX': { zh: 'åœ£è¯å²›', en: 'Christmas Island' },
            'CC': { zh: 'ç§‘ç§‘æ–¯ç¾¤å²›', en: 'Cocos (Keeling) Islands' },
            'CO': { zh: 'å“¥ä¼¦æ¯”äºš', en: 'Colombia' },
            'KM': { zh: 'ç§‘æ‘©ç½—', en: 'Comoros' },
            'CG': { zh: 'åˆšæœ', en: 'Congo' },
            'CD': { zh: 'åˆšæœæ°‘ä¸»å…±å’Œå›½', en: 'Congo, Democratic Republic of the' },
            'CK': { zh: 'åº“å…‹ç¾¤å²›', en: 'Cook Islands' },
            'CR': { zh: 'å“¥æ–¯è¾¾é»åŠ ', en: 'Costa Rica' },
            'CI': { zh: 'ç§‘ç‰¹è¿ªç“¦', en: "CÃ´te d'Ivoire" },
            'HR': { zh: 'å…‹ç½—åœ°äºš', en: 'Croatia' },
            'CU': { zh: 'å¤å·´', en: 'Cuba' },
            'CY': { zh: 'å¡æµ¦è·¯æ–¯', en: 'Cyprus' },
            'CZ': { zh: 'æ·å…‹', en: 'Czechia' },
            'DK': { zh: 'ä¸¹éº¦', en: 'Denmark' },
            'DJ': { zh: 'å‰å¸ƒæ', en: 'Djibouti' },
            'DM': { zh: 'å¤šç±³å°¼å…‹', en: 'Dominica' },
            'DO': { zh: 'å¤šç±³å°¼åŠ ', en: 'Dominican Republic' },
            'EC': { zh: 'å„ç“œå¤šå°”', en: 'Ecuador' },
            'EG': { zh: 'åŸƒåŠ', en: 'Egypt' },
            'SV': { zh: 'è¨å°”ç“¦å¤š', en: 'El Salvador' },
            'GQ': { zh: 'èµ¤é“å‡ å†…äºš', en: 'Equatorial Guinea' },
            'ER': { zh: 'å„ç«‹ç‰¹é‡Œäºš', en: 'Eritrea' },
            'EE': { zh: 'çˆ±æ²™å°¼äºš', en: 'Estonia' },
            'ET': { zh: 'åŸƒå¡ä¿„æ¯”äºš', en: 'Ethiopia' },
            'FK': { zh: 'ç¦å…‹å…°ç¾¤å²›', en: 'Falkland Islands (Malvinas)' },
            'FO': { zh: 'æ³•ç½—ç¾¤å²›', en: 'Faroe Islands' },
            'FJ': { zh: 'æ–æµ', en: 'Fiji' },
            'FI': { zh: 'èŠ¬å…°', en: 'Finland' },
            'FR': { zh: 'æ³•å›½', en: 'France' },
            'GF': { zh: 'æ³•å±åœ­äºšé‚£', en: 'French Guiana' },
            'PF': { zh: 'æ³•å±æ³¢åˆ©å°¼è¥¿äºš', en: 'French Polynesia' },
            'TF': { zh: 'æ³•å±å—éƒ¨é¢†åœ°', en: 'French Southern Territories' },
            'GA': { zh: 'åŠ è“¬', en: 'Gabon' },
            'GM': { zh: 'å†ˆæ¯”äºš', en: 'Gambia' },
            'GE': { zh: 'æ ¼é²å‰äºš', en: 'Georgia' },
            'GH': { zh: 'åŠ çº³', en: 'Ghana' },
            'GI': { zh: 'ç›´å¸ƒç½—é™€', en: 'Gibraltar' },
            'GR': { zh: 'å¸Œè…Š', en: 'Greece' },
            'GL': { zh: 'æ ¼é™µå…°', en: 'Greenland' },
            'GD': { zh: 'æ ¼æ—çº³è¾¾', en: 'Grenada' },
            'GP': { zh: 'ç“œå¾·ç½—æ™®', en: 'Guadeloupe' },
            'GU': { zh: 'å…³å²›', en: 'Guam' },
            'GT': { zh: 'å±åœ°é©¬æ‹‰', en: 'Guatemala' },
            'GG': { zh: 'æ ¹è¥¿å²›', en: 'Guernsey' },
            'GN': { zh: 'å‡ å†…äºš', en: 'Guinea' },
            'GW': { zh: 'å‡ å†…äºšæ¯”ç»', en: 'Guinea-Bissau' },
            'GY': { zh: 'åœ­äºšé‚£', en: 'Guyana' },
            'HT': { zh: 'æµ·åœ°', en: 'Haiti' },
            'HM': { zh: 'èµ«å¾·å²›å’Œéº¦å…‹å”çº³ç¾¤å²›', en: 'Heard Island and McDonald Islands' },
            'VA': { zh: 'æ¢µè’‚å†ˆ', en: 'Holy See (Vatican City State)' },
            'HN': { zh: 'æ´ªéƒ½æ‹‰æ–¯', en: 'Honduras' },
            'HU': { zh: 'åŒˆç‰™åˆ©', en: 'Hungary' },
            'IS': { zh: 'å†°å²›', en: 'Iceland' },
            'IN': { zh: 'å°åº¦', en: 'India' },
            'ID': { zh: 'å°åº¦å°¼è¥¿äºš', en: 'Indonesia' },
            'IR': { zh: 'ä¼Šæœ—', en: 'Iran, Islamic Republic of' },
            'IQ': { zh: 'ä¼Šæ‹‰å…‹', en: 'Iraq' },
            'IE': { zh: 'çˆ±å°”å…°', en: 'Ireland' },
            'IM': { zh: 'é©¬æ©å²›', en: 'Isle of Man' },
            'IL': { zh: 'ä»¥è‰²åˆ—', en: 'Israel' },
            'IT': { zh: 'æ„å¤§åˆ©', en: 'Italy' },
            'JM': { zh: 'ç‰™ä¹°åŠ ', en: 'Jamaica' },
            'JE': { zh: 'æ³½è¥¿å²›', en: 'Jersey' },
            'JO': { zh: 'çº¦æ—¦', en: 'Jordan' },
            'KZ': { zh: 'å“ˆè¨å…‹æ–¯å¦', en: 'Kazakhstan' },
            'KE': { zh: 'è‚¯å°¼äºš', en: 'Kenya' },
            'KI': { zh: 'åŸºé‡Œå·´æ–¯', en: 'Kiribati' },
            'KP': { zh: 'æœé²œ', en: "Korea, Democratic People's Republic of" },
            'KR': { zh: 'éŸ©å›½', en: 'Korea, Republic of' },
            'KW': { zh: 'ç§‘å¨ç‰¹', en: 'Kuwait' },
            'KG': { zh: 'å‰å°”å‰æ–¯æ–¯å¦', en: 'Kyrgyzstan' },
            'LA': { zh: 'è€æŒ', en: "Lao People's Democratic Republic" },
            'LV': { zh: 'æ‹‰è„±ç»´äºš', en: 'Latvia' },
            'LB': { zh: 'é»å·´å«©', en: 'Lebanon' },
            'LS': { zh: 'è±ç´¢æ‰˜', en: 'Lesotho' },
            'LR': { zh: 'åˆ©æ¯”é‡Œäºš', en: 'Liberia' },
            'LY': { zh: 'åˆ©æ¯”äºš', en: 'Libya' },
            'LI': { zh: 'åˆ—æ”¯æ•¦å£«ç™»', en: 'Liechtenstein' },
            'LT': { zh: 'ç«‹é™¶å®›', en: 'Lithuania' },
            'LU': { zh: 'å¢æ£®å ¡', en: 'Luxembourg' },
            'MO': { zh: 'ä¸­å›½æ¾³é—¨', en: 'Macao' },
            'MK': { zh: 'åŒ—é©¬å…¶é¡¿', en: 'Macedonia, the Former Yugoslav Republic of' },
            'MG': { zh: 'é©¬è¾¾åŠ æ–¯åŠ ', en: 'Madagascar' },
            'MW': { zh: 'é©¬æ‹‰ç»´', en: 'Malawi' },
            'MY': { zh: 'é©¬æ¥è¥¿äºš', en: 'Malaysia' },
            'MV': { zh: 'é©¬å°”ä»£å¤«', en: 'Maldives' },
            'ML': { zh: 'é©¬é‡Œ', en: 'Mali' },
            'MT': { zh: 'é©¬è€³ä»–', en: 'Malta' },
            'MH': { zh: 'é©¬ç»å°”ç¾¤å²›', en: 'Marshall Islands' },
            'MQ': { zh: 'é©¬æå°¼å…‹', en: 'Martinique' },
            'MR': { zh: 'æ¯›é‡Œå¡”å°¼äºš', en: 'Mauritania' },
            'MU': { zh: 'æ¯›é‡Œæ±‚æ–¯', en: 'Mauritius' },
            'YT': { zh: 'é©¬çº¦ç‰¹', en: 'Mayotte' },
            'MX': { zh: 'å¢¨è¥¿å“¥', en: 'Mexico' },
            'FM': { zh: 'å¯†å…‹ç½—å°¼è¥¿äºš', en: 'Micronesia, Federated States of' },
            'MD': { zh: 'æ‘©å°”å¤šç“¦', en: 'Moldova, Republic of' },
            'MC': { zh: 'æ‘©çº³å“¥', en: 'Monaco' },
            'MN': { zh: 'è’™å¤', en: 'Mongolia' },
            'ME': { zh: 'é»‘å±±', en: 'Montenegro' },
            'MS': { zh: 'è’™ç‰¹å¡æ‹‰ç‰¹', en: 'Montserrat' },
            'MA': { zh: 'æ‘©æ´›å“¥', en: 'Morocco' },
            'MZ': { zh: 'è«æ¡‘æ¯”å…‹', en: 'Mozambique' },
            'MM': { zh: 'ç¼…ç”¸', en: 'Myanmar' },
            'NA': { zh: 'çº³ç±³æ¯”äºš', en: 'Namibia' },
            'NR': { zh: 'ç‘™é²', en: 'Nauru' },
            'NP': { zh: 'å°¼æ³Šå°”', en: 'Nepal' },
            'NL': { zh: 'è·å…°', en: 'Netherlands' },
            'NC': { zh: 'æ–°å–€é‡Œå¤šå°¼äºš', en: 'New Caledonia' },
            'NZ': { zh: 'æ–°è¥¿å…°', en: 'New Zealand' },
            'NI': { zh: 'å°¼åŠ æ‹‰ç“œ', en: 'Nicaragua' },
            'NE': { zh: 'å°¼æ—¥å°”', en: 'Niger' },
            'NG': { zh: 'å°¼æ—¥åˆ©äºš', en: 'Nigeria' },
            'NU': { zh: 'çº½åŸƒ', en: 'Niue' },
            'NF': { zh: 'è¯ºç¦å…‹å²›', en: 'Norfolk Island' },
            'MP': { zh: 'åŒ—é©¬é‡Œäºšçº³ç¾¤å²›', en: 'Northern Mariana Islands' },
            'NO': { zh: 'æŒªå¨', en: 'Norway' },
            'OM': { zh: 'é˜¿æ›¼', en: 'Oman' },
            'PK': { zh: 'å·´åŸºæ–¯å¦', en: 'Pakistan' },
            'PW': { zh: 'å¸•åŠ³', en: 'Palau' },
            'PS': { zh: 'å·´å‹’æ–¯å¦', en: 'Palestine, State of' },
            'PA': { zh: 'å·´æ‹¿é©¬', en: 'Panama' },
            'PG': { zh: 'å·´å¸ƒäºšæ–°å‡ å†…äºš', en: 'Papua New Guinea' },
            'PY': { zh: 'å·´æ‹‰åœ­', en: 'Paraguay' },
            'PE': { zh: 'ç§˜é²', en: 'Peru' },
            'PH': { zh: 'è²å¾‹å®¾', en: 'Philippines' },
            'PN': { zh: 'çš®ç‰¹å‡¯æ©', en: 'Pitcairn' },
            'PL': { zh: 'æ³¢å…°', en: 'Poland' },
            'PT': { zh: 'è‘¡è„ç‰™', en: 'Portugal' },
            'PR': { zh: 'æ³¢å¤šé»å„', en: 'Puerto Rico' },
            'QA': { zh: 'å¡å¡”å°”', en: 'Qatar' },
            'RE': { zh: 'ç•™å°¼æ±ª', en: 'RÃ©union' },
            'RO': { zh: 'ç½—é©¬å°¼äºš', en: 'Romania' },
            'RU': { zh: 'ä¿„ç½—æ–¯', en: 'Russian Federation' },
            'RW': { zh: 'å¢æ—ºè¾¾', en: 'Rwanda' },
            'BL': { zh: 'åœ£å·´æ³°å‹’ç±³', en: 'Saint BarthÃ©lemy' },
            'SH': { zh: 'åœ£èµ«å‹’æ‹¿', en: 'Saint Helena, Ascension and Tristan da Cunha' },
            'KN': { zh: 'åœ£åŸºèŒ¨å’Œå°¼ç»´æ–¯', en: 'Saint Kitts and Nevis' },
            'LC': { zh: 'åœ£å¢è¥¿äºš', en: 'Saint Lucia' },
            'MF': { zh: 'æ³•å±åœ£é©¬ä¸', en: 'Saint Martin (French part)' },
            'PM': { zh: 'åœ£çš®åŸƒå°”å’Œå¯†å…‹éš†', en: 'Saint Pierre and Miquelon' },
            'VC': { zh: 'åœ£æ–‡æ£®ç‰¹å’Œæ ¼æ—çº³ä¸æ–¯', en: 'Saint Vincent and the Grenadines' },
            'WS': { zh: 'è¨æ‘©äºš', en: 'Samoa' },
            'SM': { zh: 'åœ£é©¬åŠ›è¯º', en: 'San Marino' },
            'ST': { zh: 'åœ£å¤šç¾å’Œæ™®æ—è¥¿æ¯”', en: 'Sao Tome and Principe' },
            'SA': { zh: 'æ²™ç‰¹é˜¿æ‹‰ä¼¯', en: 'Saudi Arabia' },
            'SN': { zh: 'å¡å†…åŠ å°”', en: 'Senegal' },
            'RS': { zh: 'å¡å°”ç»´äºš', en: 'Serbia' },
            'SC': { zh: 'å¡èˆŒå°”', en: 'Seychelles' },
            'SL': { zh: 'å¡æ‹‰åˆ©æ˜‚', en: 'Sierra Leone' },
            'SK': { zh: 'æ–¯æ´›ä¼å…‹', en: 'Slovakia' },
            'SI': { zh: 'æ–¯æ´›æ–‡å°¼äºš', en: 'Slovenia' },
            'SB': { zh: 'æ‰€ç½—é—¨ç¾¤å²›', en: 'Solomon Islands' },
            'SO': { zh: 'ç´¢é©¬é‡Œ', en: 'Somalia' },
            'ZA': { zh: 'å—é', en: 'South Africa' },
            'GS': { zh: 'å—ä¹”æ²»äºšå’Œå—æ¡‘å¨å¥‡ç¾¤å²›', en: 'South Georgia and the South Sandwich Islands' },
            'SS': { zh: 'å—è‹ä¸¹', en: 'South Sudan' },
            'ES': { zh: 'è¥¿ç­ç‰™', en: 'Spain' },
            'LK': { zh: 'æ–¯é‡Œå…°å¡', en: 'Sri Lanka' },
            'SD': { zh: 'è‹ä¸¹', en: 'Sudan' },
            'SR': { zh: 'è‹é‡Œå—', en: 'Suriname' },
            'SJ': { zh: 'æ–¯ç“¦å°”å·´å’Œæ‰¬é©¬å»¶', en: 'Svalbard and Jan Mayen' },
            'SZ': { zh: 'æ–¯å¨å£«å…°', en: 'Swaziland' },
            'SE': { zh: 'ç‘å…¸', en: 'Sweden' },
            'CH': { zh: 'ç‘å£«', en: 'Switzerland' },
            'SY': { zh: 'å™åˆ©äºš', en: 'Syrian Arab Republic' },
            'TJ': { zh: 'å¡”å‰å…‹æ–¯å¦', en: 'Tajikistan' },
            'TZ': { zh: 'å¦æ¡‘å°¼äºš', en: 'Tanzania, United Republic of' },
            'TH': { zh: 'æ³°å›½', en: 'Thailand' },
            'TL': { zh: 'ä¸œå¸æ±¶', en: 'Timor-Leste' },
            'TG': { zh: 'å¤šå“¥', en: 'Togo' },
            'TK': { zh: 'æ‰˜å…‹åŠ³', en: 'Tokelau' },
            'TO': { zh: 'æ±¤åŠ ', en: 'Tonga' },
            'TT': { zh: 'ç‰¹ç«‹å°¼è¾¾å’Œå¤šå·´å“¥', en: 'Trinidad and Tobago' },
            'TN': { zh: 'çªå°¼æ–¯', en: 'Tunisia' },
            'TR': { zh: 'åœŸè€³å…¶', en: 'Turkey' },
            'TM': { zh: 'åœŸåº“æ›¼æ–¯å¦', en: 'Turkmenistan' },
            'TC': { zh: 'ç‰¹å…‹æ–¯å’Œå‡¯ç§‘æ–¯ç¾¤å²›', en: 'Turks and Caicos Islands' },
            'TV': { zh: 'å›¾ç“¦å¢', en: 'Tuvalu' },
            'UG': { zh: 'ä¹Œå¹²è¾¾', en: 'Uganda' },
            'UA': { zh: 'ä¹Œå…‹å…°', en: 'Ukraine' },
            'AE': { zh: 'é˜¿è”é…‹', en: 'United Arab Emirates' },
            'UM': { zh: 'ç¾å›½æœ¬åœŸå¤–å°å²›å±¿', en: 'United States Minor Outlying Islands' },
            'UY': { zh: 'ä¹Œæ‹‰åœ­', en: 'Uruguay' },
            'UZ': { zh: 'ä¹Œå…¹åˆ«å…‹æ–¯å¦', en: 'Uzbekistan' },
            'VU': { zh: 'ç“¦åŠªé˜¿å›¾', en: 'Vanuatu' },
            'VE': { zh: 'å§”å†…ç‘æ‹‰', en: 'Venezuela, Bolivarian Republic of' },
            'VN': { zh: 'è¶Šå—', en: 'Viet Nam' },
            'VG': { zh: 'è‹±å±ç»´å°”äº¬ç¾¤å²›', en: 'Virgin Islands, British' },
            'VI': { zh: 'ç¾å±ç»´å°”äº¬ç¾¤å²›', en: 'Virgin Islands, U.S.' },
            'WF': { zh: 'ç“¦åˆ©æ–¯å’Œå¯Œå›¾çº³', en: 'Wallis and Futuna' },
            'EH': { zh: 'è¥¿æ’’å“ˆæ‹‰', en: 'Western Sahara' },
            'YE': { zh: 'ä¹Ÿé—¨', en: 'Yemen' },
            'ZM': { zh: 'èµæ¯”äºš', en: 'Zambia' },
            'ZW': { zh: 'æ´¥å·´å¸ƒéŸ¦', en: 'Zimbabwe' }
        };

        /**
         * å°†å›½å®¶åæ ‡å‡†åŒ–ä¸ºå¯æ¯”å¯¹ key
         * - å»æ‹¬å·å†…å®¹ã€æ ‡ç‚¹ã€è¿å­—ç¬¦ã€é‡éŸ³ç¬¦ã€å‹ç¼©ç©ºç™½
         * @param {string} s
         * @returns {string}
         */
        function normalizeCountryKey(s) {
            try {
                return String(s || '')
                    .trim()
                    .toLowerCase()
                    // å»æ‹¬å·å†…å®¹ï¼šBolivia (Plurinational State of) -> Bolivia
                    .replace(/\s*\([^)]*\)\s*/g, ' ')
                    // é€—å·/ç‚¹/æ’‡å·ç­‰
                    .replace(/[.,'â€™]/g, ' ')
                    // è¿æ¥ç¬¦
                    .replace(/[-_/]/g, ' ')
                    // å»é‡éŸ³ç¬¦ï¼ˆCÃ´te d'Ivoire -> Cote d Ivoireï¼‰
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            } catch {
                return String(s || '').trim().toLowerCase();
            }
        }

        /**
         * é¢„åŠ è½½ ISO3166 è‹±æ–‡å -> ISO2 æ˜ å°„ï¼ˆç”¨äº ECharts çš„ world.js æœªåŒ…å« iso_a2 çš„æƒ…å†µï¼‰
         * - ä¼˜å…ˆ localStorage ç¼“å­˜ï¼Œå¤±è´¥å†èµ°ç½‘ç»œæ‹‰å–
         * - ç½‘ç»œæ•°æ®æ¥æºï¼šlukes/ISO-3166-Countries-with-Regional-Codes slim-2ï¼ˆä»… name + alpha-2ï¼‰
         */
        async function ensureIsoNameToIso2MapLoaded() {
            try {
                if (window.__isoNameToIso2 instanceof Map && window.__isoNameToIso2.size > 50) return;
            } catch { /* ignore */ }

            // 1) localStorage ç¼“å­˜ï¼ˆå‹æˆå¯¹è±¡å­˜å‚¨ï¼Œæ¢å¤ä¸º Mapï¼‰
            try {
                const cached = localStorage.getItem('__isoNameToIso2_v1');
                if (cached) {
                    const obj = JSON.parse(cached);
                    if (obj && typeof obj === 'object') {
                        const m = new Map(Object.entries(obj));
                        if (m.size > 50) {
                            window.__isoNameToIso2 = m;
                            return;
                        }
                    }
                }
            } catch { /* ignore */ }

            // 2) ç½‘ç»œæ‹‰å–ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼šå¤±è´¥å°±é™çº§ï¼‰
            try {
                const url = 'https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/slim-2/slim-2.json';
                const res = await fetch(url, { cache: 'force-cache' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const arr = await res.json();
                const m = new Map();

                const setIfMissing = (k, v) => {
                    const key = normalizeCountryKey(k);
                    const val = String(v || '').trim().toUpperCase();
                    if (!key || !/^[A-Z]{2}$/.test(val)) return;
                    if (!m.has(key)) m.set(key, val);
                };

                if (Array.isArray(arr)) {
                    for (const row of arr) {
                        const name = row && (row.name || row['name']);
                        const iso2 = row && (row['alpha-2'] || row.alpha2 || row['alpha2']);
                        if (!name || !iso2) continue;

                        // å®Œæ•´å
                        setIfMissing(name, iso2);

                        // é€—å·å‰ï¼ˆMoldova, Republic of -> Moldovaï¼‰
                        try {
                            const beforeComma = String(name).split(',')[0].trim();
                            if (beforeComma && beforeComma !== name) setIfMissing(beforeComma, iso2);
                        } catch { /* ignore */ }

                        // æ‹¬å·å‰ï¼ˆIran (Islamic Republic of) -> Iranï¼‰
                        try {
                            const beforeParen = String(name).split('(')[0].trim();
                            if (beforeParen && beforeParen !== name) setIfMissing(beforeParen, iso2);
                        } catch { /* ignore */ }
                    }
                }

                // âœ… é¢å¤–åˆ«åï¼ˆé€‚é… ECharts world.js å¸¸è§ç¼©å†™/å†™æ³•ï¼‰
                // æ³¨æ„ï¼šè¿™äº› key èµ° normalizeCountryKeyï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥å†™â€œäººç±»å¯è¯»â€çš„åŸå§‹å½¢å¼å³å¯
                const extraAliases = {
                    'W. Sahara': 'EH',
                    'Bosnia and Herz.': 'BA',
                    'Antigua and Barb.': 'AG',
                    'Fr. S. Antarctic Lands': 'TF',
                    'Aland': 'AX',
                    'S. Korea': 'KR',
                    'N. Korea': 'KP',
                    'Russia': 'RU',
                    'Iran': 'IR',
                    'Laos': 'LA',
                    'Syria': 'SY',
                    'Palestine': 'PS',
                    'Czech Rep.': 'CZ',
                    'Macedonia': 'MK',
                    'Venezuela': 'VE',
                    'Bolivia': 'BO',
                    'Tanzania': 'TZ',
                    'Moldova': 'MD',
                    'Brunei': 'BN',
                    'Vietnam': 'VN',
                    'Ivory Coast': 'CI',
                };
                for (const [k, v] of Object.entries(extraAliases)) setIfMissing(k, v);

                window.__isoNameToIso2 = m;

                // å†™å›ç¼“å­˜ï¼ˆé¿å…æ¯æ¬¡åŠ è½½éƒ½ fetchï¼‰
                try {
                    const obj = Object.fromEntries(m.entries());
                    localStorage.setItem('__isoNameToIso2_v1', JSON.stringify(obj));
                } catch { /* ignore */ }
            } catch (e) {
                // é™é»˜é™çº§ï¼šä¸å½±å“é¡µé¢å…¶ä»–åŠŸèƒ½
                try { console.warn('[ISO] âš ï¸ ISO åç§°æ˜ å°„åŠ è½½å¤±è´¥ï¼Œå›½å®¶é€è§†å¯èƒ½é™çº§ä¸ºä»…æ”¯æŒå°‘æ•°å›½å®¶:', e?.message || e); } catch { /* ignore */ }
            }
        }

        /**
         * å°† ECharts world åœ°å›¾çš„å›½å®¶åç§°è§£æä¸º ISO2 å›½å®¶ç ï¼ˆå¦‚ 'United States of America' -> 'US'ï¼‰
         * ä»…åš UI å±‚è·¯ç”±ç”¨ï¼ˆæŠ½å±‰/å›½å®¶é€è§†ï¼‰ï¼Œå¤±è´¥æ—¶è¿”å› nullã€‚
         */
        function resolveCountryCodeFromMapName(name) {
            const raw = String(name || '').trim();
            if (!raw) return null;
            // ç›´æ¥æ˜¯ ISO2
            if (/^[A-Za-z]{2}$/.test(raw)) return raw.toUpperCase();

            // 1) ä¼˜å…ˆï¼šä» ECharts world geoJson ä¸­è¯»å– iso2ï¼ˆè¦†ç›–å…¨çƒå›½å®¶ï¼Œæœ€å¯é ï¼‰
            try {
                if (!window.__worldGeoNameToIso2) {
                    const m = new Map();
                    const mapObj = (typeof echarts !== 'undefined' && echarts && typeof echarts.getMap === 'function')
                        ? echarts.getMap('world')
                        : null;
                    const geoJson = mapObj?.geoJson || mapObj?.geoJSON || mapObj?.geojson || null;
                    const feats = geoJson?.features;
                    if (Array.isArray(feats)) {
                        for (const f of feats) {
                            const props = f?.properties || {};
                            const iso2 =
                                props.iso_a2 ||
                                props.iso2 ||
                                props.ISO2 ||
                                props['ISO_A2'] ||
                                props['iso_3166_1_alpha_2'] ||
                                null;
                            const iso2Upper = String(iso2 || '').trim().toUpperCase();
                            if (!/^[A-Z]{2}$/.test(iso2Upper) || iso2Upper === '-99') continue;
                            const names = [
                                props.name,
                                props.name_long,
                                props.name_en,
                                props.admin,
                                f?.name,
                            ].filter(Boolean);
                            for (const nm of names) {
                                const k = normalizeCountryKey(nm);
                                if (k) m.set(k, iso2Upper);
                                // é¢å¤–ï¼šé€—å·å‰åŠæ®µï¼ˆ"Korea, Republic of" -> "Korea"ï¼‰
                                try {
                                    const beforeComma = String(nm).split(',')[0].trim();
                                    const kc = normalizeCountryKey(beforeComma);
                                    if (kc) m.set(kc, iso2Upper);
                                } catch { /* ignore */ }
                            }
                        }
                    }
                    window.__worldGeoNameToIso2 = m;
                }
                const hit = window.__worldGeoNameToIso2.get(normalizeCountryKey(raw));
                if (hit) return String(hit).toUpperCase();
            } catch { /* ignore */ }

            const n = normalizeCountryKey(raw);

            // 2) é«˜ä¼˜å…ˆçº§åˆ«åï¼šECharts world å¸¸è§å‘½åå·®å¼‚
            const alias = {
                'usa': 'US',
                'u s a': 'US',
                'u s': 'US',
                'united states': 'US',
                'united states of america': 'US',
                'uk': 'GB',
                'united kingdom': 'GB',
                'russian federation': 'RU',
                'iran islamic republic of': 'IR',
                'korea republic of': 'KR',
                'korea democratic peoples republic of': 'KP',
                'viet nam': 'VN',
                'cote d ivoire': 'CI',
                'cote divoire': 'CI',
                'bolivia': 'BO',
                'tanzania': 'TZ',
                'venezuela': 'VE',
                'syrian arab republic': 'SY',
                'moldova republic of': 'MD',
                'lao peoples democratic republic': 'LA',
                'brunei darussalam': 'BN',
                'cabo verde': 'CV',
                'swaziland': 'SZ',
                'eswatini': 'SZ',
                'czechia': 'CZ',
                'myanmar': 'MM',
                'palestine': 'PS',
                'state of palestine': 'PS',
                'micronesia federated states of': 'FM',
                'congo': 'CG',
                'democratic republic of the congo': 'CD',
            };
            if (alias[n]) return alias[n];
            // contains è§„åˆ™
            if (n.includes('united states')) return 'US';
            if (n.includes('united kingdom')) return 'GB';
            if (n.includes('democratic republic of the congo')) return 'CD';

            // 2.5) ä½¿ç”¨ ISO3166 å›½å®¶åæ˜ å°„ï¼ˆé€‚é… world.js ä»…æœ‰ name å­—æ®µçš„æƒ…å†µï¼‰
            try {
                const m = window.__isoNameToIso2;
                if (m instanceof Map) {
                    const hit = m.get(n);
                    if (hit) return String(hit).toUpperCase();
                }
            } catch { /* ignore */ }

            // 3) ä» countryNameMap åæŸ¥ï¼ˆen/zh éƒ½æ”¯æŒï¼›ä»…è¦†ç›–ä½ æ‰‹å·¥ç»´æŠ¤çš„å›½å®¶ï¼‰
            try {
                for (const [code, names] of Object.entries(countryNameMap || {})) {
                    if (!names) continue;
                    const en = normalizeCountryKey(names.en || '');
                    const zh = normalizeCountryKey(names.zh || '');
                    if (en && en === n) return String(code).toUpperCase();
                    if (zh && zh === n) return String(code).toUpperCase();
                }
            } catch { /* ignore */ }
            return null;
        }

        // é¢„çƒ­ï¼šå°½é‡åœ¨ç”¨æˆ·ç‚¹å‡»åœ°å›¾å‰æŠŠæ˜ å°„å‡†å¤‡å¥½
        try { ensureIsoNameToIso2MapLoaded(); } catch { /* ignore */ }

        let mapChart, radarChart;
        let currentViewState = 'GLOBAL'; // GLOBAL / COUNTRY / RANKINGï¼ˆå³ä¾§æŠ½å±‰ä¸‰è§†å›¾ï¼‰
        let isGlobalInitializing = true;
        let lastRequestCountry = null;
        /** è°ƒåº¦ä¸­å¿ƒï¼šé˜²æ­¢ updateCountryDashboard å¹¶å‘ä¸æ­»å¾ªç¯ */
        let isProcessingUpdate = false;
        let lastFetchedCountry = null;
        /** åˆå§‹åŒ–ä¿æŠ¤é”ï¼šåœ¨ window.onload å®Œæˆæœ€ç»ˆ switchView ä¹‹å‰ï¼Œæ‹¦æˆª storage/resize ç­‰è§¦å‘çš„é‡å¤åˆ·æ–° */
        let isInitialLayoutPending = true;
        
        // ã€é‡æ„ã€‘åˆå§‹åŒ–å³ä¾§æŠ½å±‰é¢æ¿ - æ”¯æŒä¸‰ Tab ç»“æ„
        function initRightDrawerPanels() {
            try {
                // é»˜è®¤æ˜¾ç¤ºæ’è¡Œæ¦œè§†å›¾
                switchView('ranking');
                console.log('[Init] å³ä¾§æŠ½å±‰å·²åˆå§‹åŒ–ä¸ºæ’è¡Œæ¦œè§†å›¾');
            } catch (e) {
                console.warn('[Init] åˆå§‹åŒ–å³ä¾§æŠ½å±‰é¢æ¿çŠ¶æ€å¤±è´¥:', e);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initRightDrawerPanels();
            });
        } else {
            initRightDrawerPanels();
        }
        let selectedCountry = null; // å½“å‰é€‰ä¸­çš„å›½å®¶
        let isGlobalTopMode = false; // å…¨çƒæœ€å¼ºæ¨¡å¼ï¼Œå®¹é”™ç”¨å…¨å±€å…œåº•
        let currentChampionInfo = null; // å½“å‰é€‰ä¸­çš„å† å†›ä¿¡æ¯ï¼ˆç”¨äºåœ°å›¾ tooltip å±•ç¤ºï¼‰
        /** æ ¡å‡†æ¨¡å¼ï¼šç‚¹å‡»ã€ŒCurrent Locationã€å…‰æ ‡åä¸º trueï¼Œåœæ­¢æ“ä½œ 1.5 ç§’åæ¢å¤ false */
        let isCalibrating = false;
        let isAnchorMode = false; // é”šå®šæ¨¡å¼æ ‡å¿—
        
        // ==========================================
        // å•ä¾‹å…‰æ ‡ç®¡ç†å™¨ï¼ˆMap Cursor Managerï¼‰
        // ==========================================
        window.mapCursorManager = {
            // å½“å‰å…‰æ ‡å®ä¾‹çš„å”¯ä¸€æ ‡è¯†
            currentCursorId: null,
            // é”šå®šçŠ¶æ€
            isAnchored: false,
            // é”å®šçš„åæ ‡
            anchoredCoords: { lng: null, lat: null },
            // å…‰æ ‡çŠ¶æ€ç¼“å­˜
            cursorState: {
                lng: null,
                lat: null,
                color: '#00ff41',
                avatarUrl: null,
                username: null,
                updatedAt: null
            },
            
            /**
             * åˆå§‹åŒ–ï¼šä» localStorage æ¢å¤é”šå®šçŠ¶æ€
             */
            init() {
                try {
                    const isLocked = localStorage.getItem('loc_locked') === 'true' || localStorage.getItem('loc_fixed') === 'true';
                    const manualLat = localStorage.getItem('manual_lat');
                    const manualLng = localStorage.getItem('manual_lng');
                    
                    if (isLocked && manualLat && manualLng) {
                        this.isAnchored = true;
                        this.anchoredCoords.lat = Number(manualLat);
                        this.anchoredCoords.lng = Number(manualLng);
                        console.log('[CursorManager] âœ… æ¢å¤é”šå®šçŠ¶æ€:', this.anchoredCoords);
                    }
                } catch (e) {
                    console.warn('[CursorManager] âš ï¸ åˆå§‹åŒ–å¤±è´¥:', e);
                }
            },
            
            /**
             * è®¾ç½®é”šå®šçŠ¶æ€
             * @param {boolean} anchored - æ˜¯å¦é”šå®š
             * @param {number} lng - ç»åº¦ï¼ˆå¯é€‰ï¼‰
             * @param {number} lat - çº¬åº¦ï¼ˆå¯é€‰ï¼‰
             */
            setAnchored(anchored, lng = null, lat = null) {
                this.isAnchored = !!anchored;
                if (anchored && lng !== null && lat !== null) {
                    this.anchoredCoords.lng = Number(lng);
                    this.anchoredCoords.lat = Number(lat);
                } else if (!anchored) {
                    this.anchoredCoords.lng = null;
                    this.anchoredCoords.lat = null;
                }
                console.log('[CursorManager] ğŸ”’ é”šå®šçŠ¶æ€:', this.isAnchored, this.anchoredCoords);
            },
            
            /**
             * æ£€æŸ¥æ˜¯å¦å…è®¸æ›´æ–°åæ ‡
             * @param {number} lng - ç»åº¦
             * @param {number} lat - çº¬åº¦
             * @param {boolean} force - æ˜¯å¦å¼ºåˆ¶æ›´æ–°
             * @returns {boolean} æ˜¯å¦å…è®¸æ›´æ–°
             */
            canUpdate(lng, lat, force = false) {
                if (force) return true;
                if (!this.isAnchored) return true;
                
                // å¦‚æœå·²é”šå®šï¼Œåªå…è®¸æ›´æ–°åˆ°é”šå®šåæ ‡ï¼ˆå…è®¸å°çš„æµ®ç‚¹è¯¯å·®ï¼‰
                if (this.anchoredCoords.lng !== null && this.anchoredCoords.lat !== null) {
                    const deltaLng = Math.abs(lng - this.anchoredCoords.lng);
                    const deltaLat = Math.abs(lat - this.anchoredCoords.lat);
                    // å…è®¸ 0.0001 åº¦çš„è¯¯å·®ï¼ˆçº¦ 11 ç±³ï¼‰
                    return deltaLng <= 0.0001 && deltaLat <= 0.0001;
                }
                
                return false;
            },
            
            /**
             * æ¸…é™¤å…‰æ ‡å®ä¾‹ï¼ˆLeaflet å®ç°ï¼šç§»é™¤ markerï¼‰
             */
            clearCursor() {
                // ä¼˜å…ˆä½¿ç”¨ Leaflet marker æ¸…é™¤
                if (window.userMarker) {
                    try {
                        const map = window.map;
                        if (map && typeof map.removeLayer === 'function') {
                            map.removeLayer(window.userMarker);
                            window.userMarker = null;
                            this.currentCursorId = null;
                            console.log('[CursorManager] ğŸ—‘ï¸ å·²æ¸…é™¤ Leaflet marker');
                            return;
                        }
                    } catch (e) {
                        console.warn('[CursorManager] âš ï¸ æ¸…é™¤ Leaflet marker å¤±è´¥:', e);
                    }
                }

                // é™çº§ï¼šECharts å®ç°ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
                if (mapChart && typeof mapChart.isDisposed === 'function' && !mapChart.isDisposed()) {
                    try {
                        const currentOption = mapChart.getOption();
                        if (currentOption && currentOption.series && Array.isArray(currentOption.series)) {
                            // ç§»é™¤æ‰€æœ‰ "Current Location" ç³»åˆ—
                            const otherSeries = currentOption.series.filter(s => s && s.name !== 'Current Location');
                            mapChart.setOption({ series: otherSeries }, { notMerge: false, lazyUpdate: false });
                            this.currentCursorId = null;
                            console.log('[CursorManager] ğŸ—‘ï¸ å·²æ¸…é™¤ ECharts å…‰æ ‡å®ä¾‹');
                        }
                    } catch (e) {
                        console.warn('[CursorManager] âš ï¸ æ¸…é™¤ ECharts å…‰æ ‡å¤±è´¥:', e);
                    }
                }
            },
            
            /**
             * æ›´æ–°å…‰æ ‡çŠ¶æ€ç¼“å­˜
             */
            updateState(lng, lat, color, avatarUrl, username) {
                this.cursorState = {
                    lng: Number(lng),
                    lat: Number(lat),
                    color: color || '#00ff41',
                    avatarUrl: avatarUrl || null,
                    username: username || null,
                    updatedAt: Date.now()
                };
            }
        };
        
        // åˆå§‹åŒ–å…‰æ ‡ç®¡ç†å™¨
        try {
            window.mapCursorManager.init();
        } catch (e) {
            console.warn('[CursorManager] âš ï¸ åˆå§‹åŒ–å¤±è´¥:', e);
        }
        /** å¾…ç¡®è®¤çš„æ ¡å‡†æ•°æ®ï¼ˆlng, lat, countryCode, countryNameï¼‰ */
        let pendingCalibration = { lng: null, lat: null, countryCode: null, countryName: null };
        /** å›½å®¶è‹±æ–‡å -> è¿‘ä¼¼ä¸­å¿ƒ [lng, lat]ï¼ˆç”¨äºæ ¡å‡†æ—¶å…‰æ ‡ç§»åŠ¨ï¼‰ */
        const countryCenterMap = {
            'China': [105, 35], 'United States': [-95, 38], 'United States of America': [-95, 38],
            'Japan': [138, 36], 'United Kingdom': [-2, 54], 'Germany': [10, 51], 'France': [2, 46],
            'Singapore': [104, 1.3], 'Hong Kong': [114, 22.3], 'Taiwan': [121, 24],
            'Canada': [-106, 56], 'Australia': [134, -25], 'India': [78, 21], 'Brazil': [-55, -10],
            'South Korea': [128, 36], 'Russia': [100, 60], 'Italy': [12, 43], 'Spain': [-3, 40],
            'Netherlands': [5, 52], 'Sweden': [15, 62], 'Poland': [20, 52], 'Indonesia': [118, -5],
            'Mexico': [-102, 23], 'South Africa': [25, -29], 'Turkey': [35, 39], 'Vietnam': [108, 16],
            'Thailand': [100, 15], 'Malaysia': [112, 4], 'Philippines': [122, 13], 'Pakistan': [68, 30],
            'Egypt': [30, 27], 'Nigeria': [8, 10], 'Argentina': [-64, -34], 'Colombia': [-72, 4],
            'USA': [-95, 38], 'UK': [-2, 54], 'Korea': [128, 36]
        };

        // ==========================================
        // åœ°åŸŸé”šå®šï¼ˆæ‰‹åŠ¨åœ°åŸŸä¿®æ­£ï¼‰ï¼šanchored_countryï¼ˆå…¼å®¹æ—§é”® selected_countryï¼‰
        // - ç”¨äºï¼šä¸‹ä¸€æ¬¡æ‰«æä¸ŠæŠ¥æ—¶ Analyzer è¯»å–å¹¶ä½œä¸º manual_region
        // - ç”¨äºï¼šå³ä¾§æŠ½å±‰æç¤ºâ€œä½ æ­£åœ¨ä¸ºå“ªä¸ªå›½å®¶è´¡çŒ®â€
        // ==========================================
        function _getAnchoredCountryFromStorage() {
            try {
                const v =
                    String(localStorage.getItem('anchored_country') || '').trim().toUpperCase() ||
                    String(localStorage.getItem('selected_country') || '').trim().toUpperCase();
                return /^[A-Z]{2}$/.test(v) ? v : null;
            } catch {
                return null;
            }
        }

        function _setAnchoredCountry(countryCode) {
            const cc = String(countryCode || '').trim().toUpperCase();
            if (!/^[A-Z]{2}$/.test(cc)) return null;
            try { localStorage.setItem('anchored_country', cc); } catch { /* ignore */ }
            // å…¼å®¹æ—§é”®ï¼šéƒ¨åˆ†è€é€»è¾‘ä»è¯»å– selected_country
            try { localStorage.setItem('selected_country', cc); } catch { /* ignore */ }
            try { window.__anchoredCountry = cc; } catch { /* ignore */ }
            _renderAnchoredCountryBadge(cc);
            return cc;
        }

        function _renderAnchoredCountryBadge(countryCode) {
            try {
                const cc = String(countryCode || '').trim().toUpperCase();
                const badge = document.getElementById('anchor-country-badge');
                if (!badge) return;
                badge.textContent = `é”šå®š: ${/^[A-Z]{2}$/.test(cc) ? cc : '--'}`;
                badge.classList.toggle('border-[#00ff41]/30', true);
            } catch { /* ignore */ }
        }

        // é¡µé¢åŠ è½½æ—¶å›å¡«ä¸€æ¬¡
        try { _renderAnchoredCountryBadge(_getAnchoredCountryFromStorage()); } catch { /* ignore */ }

        // ==========================================
        // ã€æ–°åŠŸèƒ½ã€‘å…‰æ ‡å›ºå®šåœ¨æ¯å›½æœºåˆ¶
        // ==========================================

        /** å…¨å±€æ ‡å¿—ï¼šå…‰æ ‡æ˜¯å¦å·²å›ºå®šåœ¨æ¯å›½ */
        let __cursorFixedToHomeland = false;

        /**
         * è½»é‡åæ ‡åˆ¤å›½ï¼ˆä»…è¦†ç›–æ ¸å¿ƒåŒºåŸŸï¼šCN / USï¼‰
         * - CN: 73.5E~134.8E, 18N~53.6Nï¼ˆç²—ç•¥åŒ…å›´ç›’ï¼‰
         * - US: è¦†ç›– CONUS + Alaska + Hawaiiï¼ˆç²—ç•¥åŒ…å›´ç›’ï¼‰
         * @returns {string|null} 'CN' | 'US' | null
         */
        function getCountryByCoords(lng, lat) {
            const x = Number(lng);
            const y = Number(lat);
            if (!Number.isFinite(x) || !Number.isFinite(y)) return null;

            // CN (approx bounding box)
            if (y >= 18.0 && y <= 53.6 && x >= 73.5 && x <= 134.8) return 'CN';

            // US (CONUS)
            if (y >= 24.4 && y <= 49.6 && x >= -125.0 && x <= -66.5) return 'US';
            // US (Alaska)
            if (y >= 50.0 && y <= 72.5 && x >= -170.0 && x <= -130.0) return 'US';
            // US (Hawaii)
            if (y >= 18.8 && y <= 22.6 && x >= -160.6 && x <= -154.5) return 'US';

            return null;
        }

        /** å…¼å®¹æ—§è°ƒç”¨ç‚¹ï¼šè¿”å› {code,name,enName} æˆ– null */
        function getCountryAtCoordinates(lng, lat) {
            const cc = getCountryByCoords(lng, lat);
            if (!cc) return null;
            const name = countryNameMap?.[cc]
                ? (currentLang === 'zh' ? countryNameMap[cc].zh : countryNameMap[cc].en)
                : cc;
            return { code: cc, name, enName: countryNameMap?.[cc]?.en || cc };
        }

        function setRightDrawerLoading(isLoading) {
            try {
                const d = document.getElementById('right-drawer');
                if (!d) return;
                d.classList.toggle('drawer-loading', !!isLoading);
            } catch { /* ignore */ }
        }

        function onCountrySwitch(newCode, meta = {}) {
            const cc = String(newCode || '').trim().toUpperCase();
            if (!/^[A-Z]{2}$/.test(cc)) return;
            const prev = _getAnchoredCountryFromStorage();
            if (prev === cc && !meta?.force) return;

            // æ¯å›½é”šå®šæ›´æ–°ï¼šå†™å…¥ anchored_countryï¼ˆå…¼å®¹ selected_countryï¼‰
            _setAnchoredCountry(cc);

            // è®°å½•â€œåˆ‡æ¢å›½ç±â€æ—¶é—´ï¼ˆç”¨äº location_weight å¹³æ»‘è¿ç§»ï¼‰
            try {
                localStorage.setItem('country_switch_from', String(prev || '').toUpperCase());
                localStorage.setItem('country_switch_to', cc);
                localStorage.setItem('country_switch_ts', String(Date.now()));
            } catch { /* ignore */ }

            // ç¼“å­˜æ¸…ç†ï¼šåˆ‡æ¢åæ¸…é™¤æ—§çš„â€œå›½å®¶/å…¨å±€å¹³å‡å€¼â€ç¼“å­˜ï¼Œé¿å…æ—§å£å¾„æ®‹ç•™
            try {
                if (window.__countryDashboardCache && typeof window.__countryDashboardCache.delete === 'function') {
                    window.__countryDashboardCache.delete('GLOBAL');
                    window.__countryDashboardCache.delete(cc);
                }
            } catch { /* ignore */ }
            try {
                if (window.__countrySummaryCache && typeof window.__countrySummaryCache.delete === 'function') {
                    window.__countrySummaryCache.delete(cc);
                }
            } catch { /* ignore */ }
            try { localStorage.removeItem('vibe_global_stats'); } catch { /* ignore */ }

            // æŠ½å±‰æ‰‹åŠ¨åˆ‡æ¢å›½ç±ï¼šé€šçŸ¥åç«¯æ›´æ–°ç”¨æˆ·ç”»åƒ current_locationï¼ˆä¸å½±å“å†å²å¿«ç…§èšåˆï¼‰
            try {
                const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || '';
                const base = apiEndpoint.endsWith('/') ? apiEndpoint : (apiEndpoint ? `${apiEndpoint}/` : '');
                var _ufp = '';
                try { _ufp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                const url = base ? `${base}api/v2/update_location?fingerprint=${encodeURIComponent(_ufp)}&_t=${Date.now()}` : '/api/v2/update_location?fingerprint=' + encodeURIComponent(_ufp) + '&_t=' + Date.now();
                const fp = (() => {
                    try { return localStorage.getItem('user_fingerprint') || window.fpId || null; } catch { return null; }
                })();
                if (fp) {
                    fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        keepalive: true,
                        body: JSON.stringify({
                            fingerprint: fp,
                            current_location: cc,
                            switched_at: new Date().toISOString(),
                        }),
                    }).catch(() => {});
                }
            } catch { /* ignore */ }

            // ä¸ªäººåˆ†æè®°å½•ï¼šè·¨å›½åˆ‡æ¢æ—¶è§¦å‘ä¸€æ¬¡é‡æ–°ä¸ŠæŠ¥ï¼ˆé¿å…ä¾èµ–æŠ½å±‰æ˜¯å¦æ‰“å¼€ï¼‰
            try {
                if (!window.__countrySwitchRefreshUserStatsTimer) window.__countrySwitchRefreshUserStatsTimer = null;
                if (window.__countrySwitchRefreshUserStatsTimer) clearTimeout(window.__countrySwitchRefreshUserStatsTimer);
                if (!meta?.silent && typeof window.refreshUserStats === 'function') {
                    window.__countrySwitchRefreshUserStatsTimer = setTimeout(() => {
                        window.__countrySwitchRefreshUserStatsTimer = null;
                        try { window.refreshUserStats(); } catch { /* ignore */ }
                    }, 0);
                }
            } catch { /* ignore */ }

            // æ´¾å‘äº‹ä»¶ï¼šRight Drawer & å…¶ä»–æ¨¡å—è‡ªåŠ¨è¿ç§»
            try {
                window.dispatchEvent(new CustomEvent('country:switch', {
                    detail: {
                        code: cc,
                        prevCode: prev || null,
                        name: meta?.name || null,
                        source: meta?.source || 'unknown',
                        coords: meta?.coords || null,
                        ts: Date.now(),
                        silent: !!meta?.silent,
                    }
                }));
            } catch { /* ignore */ }
        }

        /**
         * å…¨å±€è°ƒåº¦ï¼šå›½å®¶åˆ‡æ¢å”¯ä¸€å…¥å£ã€‚UIã€ç¼“å­˜ã€æ•°æ®è¯·æ±‚ä¸‰ä½ä¸€ä½“ã€‚
         * æ— è®ºä»å·¦ä¸Šè§’ä¸‹æ‹‰ã€ä¾§è¾¹æ ã€åœ°å›¾ç‚¹å‡»è§¦å‘ï¼Œå‡æ‰§è¡Œï¼šlocalStorage -> æ›´æ–° UI -> POST /api/v2/analyze -> 800ms -> refreshUserStats + å³ä¾§æŠ½å±‰åˆ·æ–°ã€‚
         * @param {string} countryCode - ISO 2 ä½å›½å®¶ç ï¼ˆä¼š toUpperCaseï¼‰
         * @param {string} source - 'select' | 'map' | 'left-drawer-country-list' | 'country-select-dropdown' ç­‰
         * @param {Object} [opts] - { showLoading?: boolean } å¯é€‰ï¼Œé»˜è®¤ select ä¸º true
         */
        window.switchGlobalCountry = async function(countryCode, source, opts) {
            const code = String(countryCode || '').trim().toUpperCase();
            if (!/^[A-Z]{2}$/.test(code)) return;
            source = source || 'unknown';
            const showLoading = (opts && opts.showLoading !== undefined) ? opts.showLoading : (source === 'select' || source === 'country-select-dropdown');
            window.isLogicProcessing = true;
            try {
            // ç¬¬ä¸€æ­¥ï¼šPOST /api/update-location åŒæ­¥åˆ°æ•°æ®åº“ï¼ˆç”¨æˆ·ä¸»åŠ¨åˆ‡æ¢ä½ç½®ï¼Œå¿…é¡»å¼ºåˆ¶æ‰§è¡Œå†™å…¥ï¼Œä¸å— AUTO_REPORT ç­‰é™åˆ¶ï¼‰ï¼›å¤±è´¥åˆ™ Toast å¹¶ return
            try {
                const base = (document.querySelector('meta[name="api-endpoint"]')?.content || '').trim();
                const apiBase = base.endsWith('/') ? base.slice(0, -1) : base;
                let fp = '';
                try { fp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (e) {}
                const res = await fetch(apiBase ? apiBase + '/api/update-location' : '/api/update-location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Intent': 'manual_location_update' },
                    body: JSON.stringify({ fingerprint: fp, new_cc: code })
                });
                if (res.ok) {
                    try { localStorage.setItem('user_country_fixed', code); } catch (e) {}
                    window.currentCountryCode = code;
                } else {
                    if (typeof showNotification === 'function') showNotification('ä½ç½®åŒæ­¥å¤±è´¥');
                    else try { alert('ä½ç½®åŒæ­¥å¤±è´¥'); } catch (_) {}
                    return;
                }
            } catch (e) {
                console.warn('[CountrySwitch] update-location å¤±è´¥:', e);
                if (typeof showNotification === 'function') showNotification('ä½ç½®åŒæ­¥å¤±è´¥');
                else try { alert('ä½ç½®åŒæ­¥å¤±è´¥'); } catch (_) {}
                return;
            }

            const COUNTRY_CODE_TO_ZH = {
                CN: 'ä¸­å›½', US: 'ç¾å›½', JP: 'æ—¥æœ¬', GB: 'è‹±å›½', DE: 'å¾·å›½', FR: 'æ³•å›½',
                SG: 'æ–°åŠ å¡', HK: 'ä¸­å›½é¦™æ¸¯', TW: 'ä¸­å›½å°æ¹¾', AU: 'æ¾³å¤§åˆ©äºš', KR: 'éŸ©å›½',
                IN: 'å°åº¦', CA: 'åŠ æ‹¿å¤§', RU: 'ä¿„ç½—æ–¯', BR: 'å·´è¥¿', IT: 'æ„å¤§åˆ©', ES: 'è¥¿ç­ç‰™'
            };
            const getDisplayName = () => {
                if (typeof countryNameMap === 'object' && countryNameMap && countryNameMap[code]) {
                    return (currentLang === 'zh' ? countryNameMap[code].zh : countryNameMap[code].en) || code;
                }
                return (currentLang === 'zh' ? COUNTRY_CODE_TO_ZH[code] : null) || code;
            };
            const displayName = getDisplayName();

            // Step Aï¼šç¼“å­˜ + UI å³æ—¶åé¦ˆï¼ˆçŠ¶æ€åŒæ­¥ä¸­å¿ƒï¼šuser_manual_location å¿…é¡»ä¸º toUpperCaseï¼‰
            try {
                window.currentUserCountry = code;
                localStorage.setItem('user_manual_location', code.toUpperCase());
                localStorage.setItem('user_selected_country', code);
                localStorage.setItem('manual_location', code);
            } catch (e) { console.warn('[CountrySwitch] localStorage å†™å…¥å¤±è´¥:', e); }

            const leftTitle = document.getElementById('left-drawer-title');
            const rightTitle = document.getElementById('right-drawer-title');
            const rtNodeName = document.getElementById('rtNodeName');
            if (leftTitle) leftTitle.textContent = displayName;
            if (rightTitle) rightTitle.textContent = displayName;
            if (rtNodeName) rtNodeName.textContent = displayName;

            const dropdown = document.getElementById('country-select-dropdown');
            if (dropdown) dropdown.value = code;

            const dropdownParent = dropdown?.closest('.top-header-card');
            const dropdownLabel = dropdownParent?.querySelector('.top-header-card-label');
            const originalLabelText = dropdownLabel ? dropdownLabel.textContent : '';
            if (showLoading && dropdown) {
                dropdown.disabled = true;
                if (dropdownLabel) dropdownLabel.textContent = (currentLang === 'zh' ? 'åˆ‡æ¢ä¸­...' : 'Switching...');
            }
            setRightDrawerLoading(true);

            // å…³é”®å®¹é”™ï¼šè°ƒç”¨ migrate æ—¶ try/catchï¼Œå³ä½¿ 404 ä¹Ÿå¿…é¡»ç»§ç»­æ‰§è¡Œ updateCountryDashboard
            try {
                const userId = localStorage.getItem('github_username') || 'anonymous';
                const base = (document.querySelector('meta[name="api-endpoint"]')?.content || '').replace(/\/$/, '');
                const _fp = localStorage.getItem('user_fingerprint') || window.fpId || '';
                const session = (typeof supabaseClient !== 'undefined' && supabaseClient) ? (await supabaseClient.auth.getSession()).data?.session : null;
                const migrateUrl = (base || '') + '/api/fingerprint/migrate';
                await fetch(migrateUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...(session?.access_token ? { 'Authorization': 'Bearer ' + session.access_token } : {}) },
                    body: JSON.stringify({ fingerprint: _fp || '', userId: session?.user?.id || userId })
                });
            } catch (migrateErr) {
                if (migrateErr?.message || String(migrateErr)) console.warn('[CountrySwitch] migrate å¿½ç•¥ï¼ˆå« 404ï¼‰:', migrateErr?.message || migrateErr);
            }

            try {
                if (typeof setOrUpdateCurrentLocationCursor === 'function') setOrUpdateCurrentLocationCursor(code);
                if (typeof saveCountryToSupabase === 'function') await saveCountryToSupabase(code);

                const base = (document.querySelector('meta[name="api-endpoint"]')?.content || '').replace(/\/$/, '');
                const _fp = localStorage.getItem('user_fingerprint') || window.fpId || '';
                const analyzeUrl = base ? base + '/api/v2/analyze?fingerprint=' + encodeURIComponent(_fp) + '&_t=' + Date.now() : '/api/v2/analyze?fingerprint=' + encodeURIComponent(_fp) + '&_t=' + Date.now();
                const authHeader = supabaseClient ? (await supabaseClient.auth.getSession()).data?.session?.access_token : null;
                const res = await fetch(analyzeUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...(authHeader ? { 'Authorization': 'Bearer ' + authHeader } : {}) },
                    body: JSON.stringify({
                        chatData: [{ role: 'USER', text: '.' }],
                        manual_location: code,
                        fingerprint: _fp || null
                    })
                });
                if (!res.ok) console.warn('[CountrySwitch] analyze ä¸ŠæŠ¥é 2xx:', res.status);
                await new Promise(r => setTimeout(r, 800));
            } catch (reportErr) {
                console.warn('[CountrySwitch] ä¸ŠæŠ¥æˆ–å»¶æ—¶å¤±è´¥:', reportErr);
                await new Promise(r => setTimeout(r, 500));
            }

            try {
                // ä»…è°ƒç”¨ updateCountryDashboardï¼šå…¶æˆåŠŸåä¼šæ³¨å…¥ payload å¹¶å®šå‘è°ƒç”¨ renderUserStatsCards/æ’åæ›´æ–°ï¼Œä¸å†è°ƒç”¨ refreshUserStats é¿å…æ­»å¾ªç¯
                if (typeof updateCountryDashboard === 'function') {
                    await updateCountryDashboard(code, null, { preferCache: false, silent: false });
                }
                const eventSource = (source === 'map') ? 'map-country-click' : source;
                if (typeof onCountrySwitch === 'function') {
                    onCountrySwitch(code, { source: eventSource, name: displayName, silent: true });
                }
                if (typeof window.highlightSelectedCountry === 'function') window.highlightSelectedCountry();
                if (typeof updateUserCountryFlag === 'function') {
                    const countries = typeof getAllCountries === 'function' ? getAllCountries() : [];
                    const c = countries.find(x => (x.code || '').toUpperCase() === code);
                    if (c) {
                        const cn = (currentLang === 'zh' && c.nameZh) ? c.nameZh : c.nameEn;
                        updateUserCountryFlag(code, cn, true);
                    }
                }
                const leftSearch = document.getElementById('left-drawer-country-search');
                if (leftSearch && typeof window.__leftDrawerCountryRender === 'function') {
                    window.__leftDrawerCountryRender(leftSearch.value);
                }
            } catch (e) {
                console.warn('[CountrySwitch] åˆ·æ–°å¤±è´¥:', e);
            } finally {
                setRightDrawerLoading(false);
                if (dropdown) dropdown.disabled = false;
                if (dropdownLabel) dropdownLabel.textContent = originalLabelText;
            }
            } finally {
                window.isLogicProcessing = false;
            }
        };

        /**
         * æ‰‹åŠ¨å›½å®¶åˆ‡æ¢ç»Ÿä¸€å¤„ç†ï¼šå§”æ‰˜ç»™ switchGlobalCountryï¼Œä¿æŒæ—§è°ƒç”¨æ–¹å…¼å®¹ã€‚
         * @param {string} newCode - ISO 2 ä½å›½å®¶ç 
         * @param {Object} [opts] - { source?: string, showLoading?: boolean }
         */
        window.handleManualLocationChange = async function(newCode, opts = {}) {
            const code = String(newCode || '').trim().toUpperCase();
            if (!/^[A-Z]{2}$/.test(code)) return;
            await window.switchGlobalCountry(code, opts?.source || 'unknown', { showLoading: opts?.showLoading !== false });
        };

        // Geo-Fencingï¼šç§»åŠ¨å…‰æ ‡æ—¶ 300ms é˜²æŠ–
        let __geoFenceDebounceTimer = null;
        function scheduleGeoFenceByCoords(lng, lat, meta = {}) {
            try {
                if (__geoFenceDebounceTimer) clearTimeout(__geoFenceDebounceTimer);
            } catch { /* ignore */ }
            __geoFenceDebounceTimer = setTimeout(() => {
                __geoFenceDebounceTimer = null;
                const cc = getCountryByCoords(lng, lat);
                if (!cc) return;
                onCountrySwitch(cc, { ...meta, coords: { lng, lat } });
            }, 300);
        }

        // Right Drawerï¼šç›‘å¬å›½å®¶åˆ‡æ¢ï¼Œè‡ªåŠ¨è¿ç§»ä¸Šä¸‹æ–‡ï¼ˆç¼“å­˜ä¼˜å…ˆ + é™é»˜æ›´æ–°ï¼‰
        try {
            if (!window.__countrySwitchListenerBound) {
                window.__countrySwitchListenerBound = true;
                window.addEventListener('country:switch', (ev) => {
                    const d = ev?.detail || {};
                    const cc = String(d.code || '').trim().toUpperCase();
                    if (!/^[A-Z]{2}$/.test(cc)) return;
                    // é˜²æŠ–ï¼šåŒå›½å®¶ 500ms å†…ä¸é‡å¤åˆ·æ–°ï¼Œé¿å…å…‰æ ‡æ‹–æ‹½/åœ°å›¾äº¤äº’å¯¼è‡´ä¸€ç›´åˆ·æ–°
                    const now = Date.now();
                    if (window.__lastCountrySwitchCc === cc && (now - (window.__lastCountrySwitchTs || 0)) < 500) return;
                    window.__lastCountrySwitchCc = cc;
                    window.__lastCountrySwitchTs = now;

                    const leftDrawer = document.getElementById('left-drawer');
                    const rightDrawer = document.getElementById('right-drawer');
                    const shouldRender =
                        (leftDrawer && leftDrawer.classList.contains('active')) ||
                        (rightDrawer && rightDrawer.classList.contains('active')) ||
                        (localStorage.getItem('left_drawer_open') === 'true') ||
                        (localStorage.getItem('right_drawer_open') === 'true');
                    // åœ°å›¾ç‚¹å‡»å›½å®¶ï¼šå³ä¾¿æŠ½å±‰æœªæ‰“å¼€ï¼Œä¹Ÿå¿…é¡»â€œæ— æ„Ÿæ‰“å¼€å¹¶åˆ‡æ¢â€
                    const forceRender = String(d.source || '') === 'map-country-click';
                    if (!shouldRender && !forceRender) return;

                    const displayName = countryNameMap?.[cc]
                        ? (currentLang === 'zh' ? countryNameMap[cc].zh : countryNameMap[cc].en)
                        : (d.name || cc);

                    setRightDrawerLoading(true);
                    // ISO2 å›½å®¶ï¼šç­‰å¾…å›½å®¶é€è§†æ•°æ®è¯·æ±‚å®Œæˆåå†ç»“æŸ loadingï¼ˆç”± updateCountryDashboard æ”¶å°¾ï¼‰
                    // é ISO2ï¼ˆå…œåº•å±•ç¤ºï¼‰ï¼šç”¨çŸ­å»¶è¿Ÿç»“æŸ loading
                    if (!/^[A-Z]{2}$/.test(cc)) {
                        setTimeout(() => setRightDrawerLoading(false), 220);
                    } else {
                        // å®‰å…¨å…œåº•ï¼š15 ç§’åå¼ºåˆ¶æ¸…é™¤ loadingï¼Œé¿å… fetch æŒ‚èµ·æ—¶ä¸€ç›´å¡åœ¨éª¨æ¶
                        setTimeout(() => setRightDrawerLoading(false), 15000);
                    }

                    // æŠ½å±‰å®æ—¶ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šåªè¦æ˜¯ ISO2ï¼Œå°±è¿›å…¥â€œå›½å®¶é€è§†ï¼ˆå³ä¾§æ¨¡æ¿ï¼‰â€
                    if (/^[A-Z]{2}$/.test(cc)) {
                        switchToCountryView(cc, displayName);
                        if (typeof switchView === 'function') {
                            switchView('country');
                        }
                    } else {
                        showDrawersWithCountryData(cc, displayName);
                    }

                    // æ•°æ®æµé‡å®šå‘
                    try { window.refreshVibeCard && window.refreshVibeCard(cc); } catch { /* ignore */ }
                });
            }
        } catch { /* ignore */ }

        /**
         * æ˜¾ç¤ºæ¯å›½ç¡®è®¤å¼¹çª—
         * @param {string} countryName - å›½å®¶åç§°
         * @param {Function} onConfirm - ç¡®è®¤å›è°ƒ
         * @param {Function} onCancel - å–æ¶ˆå›è°ƒ
         */
        function showHomelandConfirmation(countryName, onConfirm, onCancel) {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¼¹çª—ï¼Œé¿å…é‡å¤æ˜¾ç¤º
            const existingDialog = document.getElementById('homeland-confirm-dialog');
            if (existingDialog) {
                existingDialog.remove();
            }

            const dialog = document.createElement('div');
            dialog.id = 'homeland-confirm-dialog';
            dialog.className = 'fixed inset-0 flex items-center justify-center bg-black/70 z-50';
            dialog.innerHTML = `
                <div class="bg-zinc-900 border border-[#00ff41]/30 rounded-lg p-6 max-w-sm mx-4 shadow-[0_0_20px_rgba(0,255,65,0.3)]">
                    <h3 class="text-white text-lg font-bold mb-3">ğŸ  è®¾ç½®ä¸ºæ¯å›½</h3>
                    <p class="text-zinc-300 text-sm mb-4">æ˜¯å¦å°† <span class="text-[#00ff41] font-bold">${countryName}</span> è®¾ç½®ä¸ºæ‚¨çš„æ¯å›½ï¼Ÿ</p>
                    <p class="text-zinc-500 text-xs mb-6">è®¾ç½®åï¼Œå…‰æ ‡å°†å›ºå®šåœ¨æ­¤ä½ç½®ï¼Œä¸å†éšåœ°å›¾ç§»åŠ¨ã€‚</p>
                    <div class="flex gap-3">
                        <button id="homeland-confirm-cancel" class="flex-1 px-4 py-2 rounded border border-zinc-600 text-zinc-300 hover:bg-zinc-800 transition-colors text-sm">
                            å–æ¶ˆ
                        </button>
                        <button id="homeland-confirm-ok" class="flex-1 px-4 py-2 rounded bg-[#00ff41] text-black font-bold hover:bg-[#00ff41]/80 transition-colors text-sm">
                            ç¡®è®¤
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);

            // ç»‘å®šäº‹ä»¶
            document.getElementById('homeland-confirm-ok').onclick = () => {
                dialog.remove();
                if (typeof onConfirm === 'function') onConfirm();
            };
            document.getElementById('homeland-confirm-cancel').onclick = () => {
                dialog.remove();
                if (typeof onCancel === 'function') onCancel();
            };
            dialog.onclick = (e) => {
                if (e.target === dialog) {
                    dialog.remove();
                    if (typeof onCancel === 'function') onCancel();
                }
            };
        }

        /**
         * æ˜¾ç¤ºè§£é™¤å›ºå®šå¼¹çª—
         * @param {Function} onConfirm - ç¡®è®¤å›è°ƒ
         * @param {Function} onCancel - å–æ¶ˆå›è°ƒ
         */
        function showUnfixConfirmation(onConfirm, onCancel) {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰å¼¹çª—ï¼Œé¿å…é‡å¤æ˜¾ç¤º
            const existingDialog = document.getElementById('unfix-confirm-dialog');
            if (existingDialog) {
                existingDialog.remove();
            }

            const dialog = document.createElement('div');
            dialog.id = 'unfix-confirm-dialog';
            dialog.className = 'fixed inset-0 flex items-center justify-center bg-black/70 z-50';
            dialog.innerHTML = `
                <div class="bg-zinc-900 border border-[#00ff41]/30 rounded-lg p-6 max-w-sm mx-4 shadow-[0_0_20px_rgba(0,255,65,0.3)]">
                    <h3 class="text-white text-lg font-bold mb-3">ğŸ—ºï¸ é‡æ–°å¯»æ‰¾æ¯å›½</h3>
                    <p class="text-zinc-300 text-sm mb-4">ç¡®å®šè¦è§£é™¤å½“å‰æ¯å›½è®¾ç½®ï¼Œé‡æ–°å¯»æ‰¾æ¯å›½å—ï¼Ÿ</p>
                    <p class="text-zinc-500 text-xs mb-6">è§£é™¤åï¼Œå…‰æ ‡å°†å¯ä»¥è‡ªç”±ç§»åŠ¨ã€‚</p>
                    <div class="flex gap-3">
                        <button id="unfix-confirm-cancel" class="flex-1 px-4 py-2 rounded border border-zinc-600 text-zinc-300 hover:bg-zinc-800 transition-colors text-sm">
                            å–æ¶ˆ
                        </button>
                        <button id="unfix-confirm-ok" class="flex-1 px-4 py-2 rounded bg-[#00ff41] text-black font-bold hover:bg-[#00ff41]/80 transition-colors text-sm">
                            ç¡®å®š
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);

            // ç»‘å®šäº‹ä»¶
            document.getElementById('unfix-confirm-ok').onclick = () => {
                dialog.remove();
                if (typeof onConfirm === 'function') onConfirm();
            };
            document.getElementById('unfix-confirm-cancel').onclick = () => {
                dialog.remove();
                if (typeof onCancel === 'function') onCancel();
            };
            dialog.onclick = (e) => {
                if (e.target === dialog) {
                    dialog.remove();
                    if (typeof onCancel === 'function') onCancel();
                }
            };
        }

        /**
         * ä½¿ç”¨ graphic ç»„ä»¶åœ¨å±å¹•ä¸Šå›ºå®šå…‰æ ‡ä½ç½®
         * @param {number} lng - ç»åº¦
         * @param {number} lat - çº¬åº¦
         * @param {string} color - é¢œè‰²
         * @param {string} avatarUrl - å¤´åƒ URL
         * @param {string} username - ç”¨æˆ·å
         */
        function setFixedCursorOnScreen(lng, lat, color = '#00ff41', avatarUrl = null, username = null) {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;

            try {
                // ã€ä¿®æ”¹ã€‘å®Œå…¨ç§»é™¤ "Current Location" effectScatter ç³»åˆ—
                const currentOption = mapChart.getOption();
                if (currentOption && currentOption.series && Array.isArray(currentOption.series)) {
                    const newSeries = currentOption.series.filter(s => s.name !== 'Current Location');
                    mapChart.setOption({ series: newSeries }, { notMerge: false, lazyUpdate: false });
                }

                // å°†åœ°ç†åæ ‡è½¬æ¢ä¸ºå±å¹•åæ ‡
                const px = mapChart.convertToPixel('geo', [lng, lat]);
                if (!px || !Array.isArray(px) || px.length < 2) return;

                const screenX = px[0];
                const screenY = px[1];

                // ä½¿ç”¨ graphic ç»„ä»¶åœ¨å±å¹•ä¸Šå›ºå®šæ˜¾ç¤º
                const existingGraphic = currentOption.graphic || { elements: [] };

                // ç§»é™¤æ—§çš„å…‰æ ‡ graphic
                const newElements = (existingGraphic.elements || []).filter(el => el.id !== 'fixed-cursor');

                // ã€ä¿®æ”¹ã€‘ä½¿ç”¨æ·±è‰²å…‰æ ‡ï¼Œé¿å…ä¸åœ°å›¾æ··æ·†
                const fixedColor = '#ffffff'; // ç™½è‰²å…‰æ ‡ï¼Œåœ¨æ·±è‰²åœ°å›¾ä¸Šæ›´æ˜æ˜¾
                const fixedTextColor = '#ffffff'; // ç™½è‰²æ–‡æœ¬

                // æ·»åŠ æ–°çš„å›ºå®šå…‰æ ‡
                newElements.push({
                    id: 'fixed-cursor',
                    type: 'group',
                    // ä½¿ç”¨ x/yï¼ˆè€Œé left/topï¼‰é¿å… bbox/layout å¯¼è‡´çš„â€œé£˜ç§»â€
                    x: screenX,
                    y: screenY,
                    children: [
                        {
                            type: 'circle',
                            shape: { cx: 0, cy: 0, r: 10 },
                            style: {
                                fill: fixedColor,
                                stroke: '#000000',
                                lineWidth: 2,
                                shadowBlur: 20,
                                shadowColor: 'rgba(0, 0, 0, 0.8)'
                            }
                        },
                        {
                            type: 'text',
                            style: {
                                text: 'YOU',
                                fill: fixedTextColor,
                                fontSize: 12,
                                fontWeight: 'bold',
                                fontFamily: 'JetBrains Mono',
                                x: 0,
                                y: -20
                            }
                        }
                    ]
                });

                mapChart.setOption({ graphic: { elements: newElements } }, { notMerge: false, lazyUpdate: false });

                // ä¿å­˜å›ºå®šçŠ¶æ€
                localStorage.setItem('cursor_fixed_to_homeland', 'true');
                localStorage.setItem('fixed_cursor_lng', String(lng));
                localStorage.setItem('fixed_cursor_lat', String(lat));
                localStorage.setItem('fixed_cursor_color', color);

                // ç»‘å®šè·Ÿéšåœ°å›¾çš„åŒæ­¥é€»è¾‘ï¼Œä¿è¯æ‹–æ‹½/ç¼©æ”¾/é‡ç»˜åä»å®šä½åœ¨ä¿å­˜åæ ‡
                try {
                    bindFixedCursorFollowMap();
                    syncFixedCursorGraphicPosition('setFixedCursorOnScreen');
                } catch { /* ignore */ }

                console.log('[Homeland] âœ… å…‰æ ‡å·²å›ºå®šåœ¨å±å¹•ä½ç½®ï¼ˆæ·±è‰²ï¼‰:', { lng, lat, screenX, screenY });
            } catch (e) {
                console.warn('[Homeland] è®¾ç½®å›ºå®šå…‰æ ‡å¤±è´¥:', e);
            }
        }

        /**
         * ç§»é™¤å›ºå®šçš„å±å¹•å…‰æ ‡
         */
        function removeFixedCursor() {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;

            try {
                const currentOption = mapChart.getOption();
                const existingGraphic = currentOption.graphic || { elements: [] };
                const newElements = (existingGraphic.elements || []).filter(el => el.id !== 'fixed-cursor');

                mapChart.setOption({ graphic: { elements: newElements } }, { notMerge: false, lazyUpdate: false });

                // ã€ä¿®æ”¹ã€‘æ¢å¤ effectScatter ç³»åˆ—å…‰æ ‡
                const fixedLng = localStorage.getItem('fixed_cursor_lng');
                const fixedLat = localStorage.getItem('fixed_cursor_lat');
                const fixedColor = localStorage.getItem('fixed_cursor_color') || '#00ff41';

                if (fixedLng && fixedLat && !isNaN(Number(fixedLng)) && !isNaN(Number(fixedLat))) {
                    const lng = Number(fixedLng);
                    const lat = Number(fixedLat);

                    // è¯»å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¤´åƒã€ç”¨æˆ·åï¼‰
                    let githubUsername = 'YOU';
                    let avatarUrl = DEFAULT_AVATAR;
                    try {
                        githubUsername = localStorage.getItem('github_username') || 'YOU';
                        if (githubUsername && isValidGitHubUsername(githubUsername)) {
                            avatarUrl = getGitHubAvatarUrl(githubUsername);
                        }
                    } catch (e) { /* ignore */ }

                    // æ¢å¤ effectScatter ç³»åˆ—å…‰æ ‡
                    if (currentOption && currentOption.series && Array.isArray(currentOption.series)) {
                        const otherSeries = currentOption.series.filter(s => s.name !== 'Current Location');
                        const pulseSeries = {
                            name: 'Current Location',
                            type: 'effectScatter',
                            coordinateSystem: 'geo',
                            data: [{ value: [lng, lat], name: 'YOU', avatarUrl: avatarUrl || null, username: username || null }],
                            symbolSize: 20,
                            showEffectOn: 'render',
                            rippleEffect: { brushType: 'stroke', scale: 5, period: 4, color: fixedColor },
                            itemStyle: { color: fixedColor, shadowBlur: 20, shadowColor: fixedColor },
                            label: { show: true, formatter: 'YOU', position: 'top', color: fixedColor, fontSize: 10, fontFamily: 'JetBrains Mono' },
                            avatarUrl: avatarUrl || null,
                            username: username || null,
                            zlevel: 10,
                            z: 10
                        };
                        mapChart.setOption({ series: [...otherSeries, pulseSeries] }, { notMerge: false, lazyUpdate: false });
                    }

                    // è®°å½•å½“å‰å…‰æ ‡çŠ¶æ€
                    try {
                        window.__currentLocationCursorState = {
                            lng,
                            lat,
                            color: fixedColor,
                            avatarUrl: avatarUrl || null,
                            username: username || null,
                            updatedAt: Date.now()
                        };
                        window.currentUserLocation = { lng, lat, color: fixedColor };
                    } catch { /* ignore */ }
                }

                // æ¸…é™¤å›ºå®šçŠ¶æ€
                localStorage.removeItem('cursor_fixed_to_homeland');
                localStorage.removeItem('fixed_cursor_lng');
                localStorage.removeItem('fixed_cursor_lat');
                localStorage.removeItem('fixed_cursor_color');

                console.log('[Homeland] âœ… å·²ç§»é™¤å›ºå®šçš„å±å¹•å…‰æ ‡å¹¶æ¢å¤ effectScatter å…‰æ ‡');
            } catch (e) {
                console.warn('[Homeland] ç§»é™¤å›ºå®šå…‰æ ‡å¤±è´¥:', e);
            }
        }

        /**
         * æ¢å¤å›ºå®šçš„å±å¹•å…‰æ ‡
         */
        function restoreFixedCursor() {
            if (localStorage.getItem('cursor_fixed_to_homeland') === 'true') {
                const lng = localStorage.getItem('fixed_cursor_lng');
                const lat = localStorage.getItem('fixed_cursor_lat');
                const color = localStorage.getItem('fixed_cursor_color') || '#00ff41';

                if (lng && lat && !isNaN(Number(lng)) && !isNaN(Number(lat))) {
                    __cursorFixedToHomeland = true;
                    setFixedCursorOnScreen(Number(lng), Number(lat), color);
                    console.log('[Homeland] âœ… å·²æ¢å¤å›ºå®šçš„å±å¹•å…‰æ ‡');
                }
            }
        }

        // ==========================================================
        // å›ºå®šå…‰æ ‡ä½ç½®åŒæ­¥ï¼ˆæ‹–æ‹½/ç¼©æ”¾/é‡ç»˜/åˆ·æ–°åä»å®šåœ¨ä¿å­˜åæ ‡ï¼‰
        // ==========================================================
        let __fixedCursorSyncRaf = 0;
        let __fixedCursorFollowHandlers = null;

        function _normalizeGraphicElements(graphicOpt) {
            if (!graphicOpt) return { elements: [] };
            // æŸäº›æƒ…å†µä¸‹ getOption() å¯èƒ½è¿”å›æ•°ç»„å½¢å¼
            if (Array.isArray(graphicOpt)) return { elements: graphicOpt };
            if (typeof graphicOpt === 'object' && Array.isArray(graphicOpt.elements)) return { elements: graphicOpt.elements };
            return { elements: [] };
        }

        function syncFixedCursorGraphicPosition(reason = '') {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return false;
            if (localStorage.getItem('cursor_fixed_to_homeland') !== 'true') return false;

            const lngStr = localStorage.getItem('fixed_cursor_lng');
            const latStr = localStorage.getItem('fixed_cursor_lat');
            if (!lngStr || !latStr) return false;
            const lng = Number(lngStr);
            const lat = Number(latStr);
            if (isNaN(lng) || isNaN(lat)) return false;

            try {
                const px = mapChart.convertToPixel('geo', [lng, lat]);
                if (!px || !Array.isArray(px) || px.length < 2) return false;
                const x = Number(px[0]);
                const y = Number(px[1]);
                if (!isFinite(x) || !isFinite(y)) return false;

                const opt = mapChart.getOption();
                const { elements } = _normalizeGraphicElements(opt?.graphic);
                if (!elements || !Array.isArray(elements) || elements.length === 0) return false;

                const next = elements.map((el) => {
                    if (!el || el.id !== 'fixed-cursor') return el;
                    // å¼ºåˆ¶ä½¿ç”¨ x/yï¼Œæ¸…é™¤ left/topï¼ˆé¿å…å¸ƒå±€è®¡ç®—å¯¼è‡´æ¼‚ç§»ï¼‰
                    const { left, top, ...rest } = el;
                    return { ...rest, x, y };
                });

                mapChart.setOption({ graphic: { elements: next } }, { notMerge: false, lazyUpdate: false });
                if (reason) console.log('[Homeland] ğŸ“Œ åŒæ­¥å›ºå®šå…‰æ ‡ä½ç½®:', reason, { lng, lat, x, y });
                return true;
            } catch (e) {
                console.warn('[Homeland] åŒæ­¥å›ºå®šå…‰æ ‡ä½ç½®å¤±è´¥:', reason, e);
                return false;
            }
        }

        function bindFixedCursorFollowMap() {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;

            // è§£ç»‘æ—§ handlerï¼Œé¿å…é‡å¤ç»‘å®š
            try {
                if (__fixedCursorFollowHandlers) {
                    try { mapChart.off('georoam', __fixedCursorFollowHandlers.georoam); } catch { /* ignore */ }
                    try { mapChart.off('finished', __fixedCursorFollowHandlers.finished); } catch { /* ignore */ }
                }
            } catch { /* ignore */ }

            const scheduleSync = (reason) => {
                if (__fixedCursorSyncRaf) return;
                __fixedCursorSyncRaf = requestAnimationFrame(() => {
                    __fixedCursorSyncRaf = 0;
                    syncFixedCursorGraphicPosition(reason);
                });
            };

            const georoam = () => scheduleSync('echarts.georoam');
            const finished = () => scheduleSync('echarts.finished');
            __fixedCursorFollowHandlers = { georoam, finished };

            try { mapChart.on('georoam', georoam); } catch { /* ignore */ }
            try { mapChart.on('finished', finished); } catch { /* ignore */ }

            // åˆæ¬¡ç»‘å®šåç«‹å³å¯¹é½ä¸€æ¬¡ï¼ˆå°¤å…¶æ˜¯åˆ·æ–°/é¦–æ¬¡æ¸²æŸ“å®Œæˆåï¼‰
            scheduleSync('bindFixedCursorFollowMap.init');
        }

        // ğŸ” LPDEF 5ç»´åº¦ç§°å·ä¸è¯´æ˜ï¼ˆä¸­è‹±åŒè¯­ï¼‰
        const DIMENSION_TITLES = {
            L: {
                zh: { title: 'æ¶æ„å¸ˆçš„ç›´è§‰', description: 'åœ¨é€»è¾‘è¿·å®«ä¸­ä¸€çœ¼çœ‹ç©¿æœ¬è´¨' },
                en: { title: "Architect's Intuition", description: 'Spot the core through any logic maze' }
            },
            P: {
                zh: { title: 'æ·±æµ·æ½œèˆªè€…', description: 'é¢å¯¹å¤æ‚é€»è¾‘æ‹¥æœ‰æè‡´çš„é™æ°”' },
                en: { title: 'Deep Sea Diver', description: 'Stay calm under complex logic' }
            },
            D: {
                zh: { title: 'åƒç´ çº§ä¾¦æ¢', description: 'ä»»ä½•å¾®å°çš„ä»£ç ç‘•ç–µéƒ½æ— æ‰€éå½¢' },
                en: { title: 'Pixel-level Detective', description: 'Catch even the tiniest bug' }
            },
            E: {
                zh: { title: 'å…±æƒ…æ¶æ„å¸ˆ', description: 'ä»£ç ä¸­æµæ·Œç€å¯¹ç”¨æˆ·ä½“éªŒçš„æè‡´ç†è§£' },
                en: { title: 'Empathy Architect', description: 'Build with user experience in mind' }
            },
            F: {
                zh: { title: 'æŒ‡å°–æ‰“å‡»ä¹æ‰‹', description: 'æè‡´çš„è¾“å…¥é¢‘ç‡ä¸‹ä¿æŒç€æƒŠäººçš„å‡†ç¡®ç‡' },
                en: { title: 'Finger Drummer', description: 'High-frequency input, high accuracy' }
            }
        };

        const getLpdefTitle = (dim) => {
            const d = DIMENSION_TITLES[dim];
            if (!d) return '';
            return currentLang === 'en' ? (d.en?.title || '') : (d.zh?.title || '');
        };
        const getLpdefDescription = (dim) => {
            const d = DIMENSION_TITLES[dim];
            if (!d) return '';
            return currentLang === 'en' ? (d.en?.description || '') : (d.zh?.description || '');
        };
        
        let lpdefExperts = { L: null, P: null, D: null, E: null, F: null }; // å­˜å‚¨å½“å‰äº”ä¸ªç»´åº¦çš„ä¸“å®¶ä¿¡æ¯
        // åœ°å›¾æ¸²æŸ“ä»¤ç‰Œï¼šé˜²æ­¢å¹¶å‘ init / dispose å¯¼è‡´ getZr ä¸ºç©º
        let mapRenderSeq = 0;
        
        // å…¨å±€æ•°æ®å­˜å‚¨ï¼šç”¨äº Realtime æ›´æ–°
        let latestRecords = [];

        /**
         * æ•°å­—æ ¼å¼åŒ–å‡½æ•°ï¼ˆæ™ºèƒ½å¤„ç†å¤§æ•°å­—ï¼‰
         * @param {number} num - è¦æ ¼å¼åŒ–çš„æ•°å­—
         * @returns {string} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼ˆå¦‚ 1.2M, 3.5Kï¼‰
         */
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) {
                return '0';
            }
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        /**
         * æ•°å­—æ»šåŠ¨åŠ¨ç”»ï¼ˆrequestAnimationFrameï¼‰
         * éœ€æ±‚ï¼šanimateValue(id, end, duration) + åƒåˆ†ä½æ ¼å¼åŒ–
         * @param {string} id - ç›®æ ‡å…ƒç´  id
         * @param {number} end - ç»“æŸå€¼
         * @param {number} duration - åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
         * @param {Object} options - å¯é€‰é¡¹
         */
        function animateValue(id, end, duration = 1200, options = {}) {
            const el = document.getElementById(id);
            if (!el) return;

            const { start = 0, decimals = 0, useThousands = true } = options;
            const s = Number(start) || 0;
            const e = Number(end) || 0;
            const startTime = performance.now();

            const format = (val) => {
                const n = Number(val) || 0;
                if (useThousands) {
                    return n.toLocaleString(undefined, {
                        minimumFractionDigits: decimals,
                        maximumFractionDigits: decimals
                    });
                }
                return decimals > 0 ? n.toFixed(decimals) : String(Math.round(n));
            };

            const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

            function tick(now) {
                const t = Math.min((now - startTime) / duration, 1);
                const eased = easeOutCubic(t);
                const current = s + (e - s) * eased;
                el.textContent = format(decimals > 0 ? current : Math.floor(current));
                if (t < 1) requestAnimationFrame(tick);
                else el.textContent = format(e);
            }

            requestAnimationFrame(tick);
        }

        /**
         * åŠ è½½æ€éª¨æ¶å±æ³¨å…¥/ç§»é™¤
         */
        const numericIds = [
            'totalUsers',
            'totalAnalysis',
            'totalChars',
            'avgPerUser',
            'avgPerScan',
            'systemDays',
            'cityCount',
        ];

        function setLoadingState(isLoading) {
            const scan = document.getElementById('scanLine');
            if (scan) scan.classList.toggle('active', !!isLoading);

            numericIds.forEach((id) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('skeleton', !!isLoading);
                if (isLoading) {
                    el.textContent = '000000';
                }
            });
        }

        function switchLang(lang) {
            const next = (String(lang || '').trim().toLowerCase() === 'en') ? 'en' : 'zh';
            try { localStorage.setItem(LANG_STORAGE_KEY, next); } catch { /* ignore */ }
            updateLanguageContext();
        }

        // å³ä¸Šè§’å›½æ——ï¼šç‚¹å‡»åˆ‡æ¢ä¸­/è‹±ï¼ˆå¹¶å†™å…¥ localStorage.langï¼‰
        function toggleLangByUSFlag() {
            try { switchLang(currentLang === 'en' ? 'zh' : 'en'); } catch { /* ignore */ }
        }

        // åŠ¨æ€åŒæ­¥é¡¶éƒ¨æ ‡é¢˜æ é«˜åº¦ï¼ˆé¿å…æŠ½å±‰/å†…å®¹é®æŒ¡ï¼‰
        function syncTopHeaderHeight() {
            try {
                const header = document.querySelector('.top-header');
                if (!header) return;
                const h = Math.max(0, Math.round(header.getBoundingClientRect().height || header.offsetHeight || 0));
                if (h > 0) {
                    document.documentElement.style.setProperty('--top-header-height', `${h}px`);
                }
            } catch { /* ignore */ }
        }
        try {
            // é¦–æ¬¡æ¸²æŸ“
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', async () => {
                    // ç»‘å®šå›½æ——äº¤äº’ï¼šç‚¹å‡»å†™å…¥ localStorage.langï¼Œå¹¶åˆ·æ–°è¯­è¨€ä¸Šä¸‹æ–‡
                    try {
                        const btnZh = document.getElementById('btn-zh');
                        const btnEn = document.getElementById('btn-en');
                        const setLangAndReload = (next) => {
                            const v = (String(next || '').trim().toLowerCase() === 'en') ? 'en' : 'zh';
                            try { localStorage.setItem(LANG_STORAGE_KEY, v); } catch { /* ignore */ }
                            // å…¼å®¹ï¼šéƒ¨åˆ†é¡µé¢/æ—§é€»è¾‘è¯»å– localStorage.lang/appLanguage
                            try { localStorage.setItem('lang', v); } catch { /* ignore */ }
                            try { localStorage.setItem('appLanguage', v === 'en' ? 'en' : 'zh-CN'); } catch { /* ignore */ }
                            try { location.reload(); } catch { /* ignore */ }
                        };
                        if (btnZh) btnZh.addEventListener('click', () => setLangAndReload('zh'));
                        if (btnEn) btnEn.addEventListener('click', () => setLangAndReload('en'));
                    } catch { /* ignore */ }

                    // åˆå§‹åŒ–è¯­è¨€é…ç½®ï¼ˆå¯é€‰ï¼‰+ é¦–æ¬¡åˆ·æ–°è¯­è¨€ä¸Šä¸‹æ–‡
                    try { await loadLanguageConfig(); } catch { /* ignore */ }
                    try { updateLanguageContext(); } catch { /* ignore */ }
                    syncTopHeaderHeight();
                    setTimeout(syncTopHeaderHeight, 60);
                    if (typeof window.reportManualLocationIfCached === 'function') window.reportManualLocationIfCached().catch(function() {});
                });
            } else {
                try {
                    const btnZh = document.getElementById('btn-zh');
                    const btnEn = document.getElementById('btn-en');
                    const setLangAndReload = (next) => {
                        const v = (String(next || '').trim().toLowerCase() === 'en') ? 'en' : 'zh';
                        try { localStorage.setItem(LANG_STORAGE_KEY, v); } catch { /* ignore */ }
                        try { localStorage.setItem('lang', v); } catch { /* ignore */ }
                        try { localStorage.setItem('appLanguage', v === 'en' ? 'en' : 'zh-CN'); } catch { /* ignore */ }
                        try { location.reload(); } catch { /* ignore */ }
                    };
                    if (btnZh) btnZh.addEventListener('click', () => setLangAndReload('zh'));
                    if (btnEn) btnEn.addEventListener('click', () => setLangAndReload('en'));
                } catch { /* ignore */ }
                try { loadLanguageConfig().then(() => updateLanguageContext()).catch(() => updateLanguageContext()); } catch { /* ignore */ }
                syncTopHeaderHeight();
                setTimeout(syncTopHeaderHeight, 60);
                if (typeof window.reportManualLocationIfCached === 'function') window.reportManualLocationIfCached().catch(function() {});
            }
            // resize é€‚é…
            let __topHeaderResizeTimer = null;
            window.addEventListener('resize', () => {
                try { if (__topHeaderResizeTimer) clearTimeout(__topHeaderResizeTimer); } catch { /* ignore */ }
                __topHeaderResizeTimer = setTimeout(() => syncTopHeaderHeight(), 80);
            });
        } catch { /* ignore */ }

        /**
         * æ£€æŸ¥åœ°å›¾æ•°æ®æ˜¯å¦å·²åŠ è½½
         * world.js åŠ è½½åä¼šåœ¨ echarts ä¸­æ³¨å†Œ 'world' åœ°å›¾
         */
        async function checkMapLoaded() {
            if (typeof echarts === 'undefined') {
                return false;
            }
            
            // æ£€æŸ¥åœ°å›¾æ˜¯å¦å·²æ³¨å†Œ
            // ECharts 5.x ä½¿ç”¨ getMap æ–¹æ³•æ£€æŸ¥
            try {
                if (typeof echarts.getMap === 'function') {
                    const mapData = echarts.getMap('world');
                    if (mapData) {
                        console.log('[Map] âœ… åœ°å›¾æ•°æ®å·²æ³¨å†Œ');
                        return true;
                    }
                }
                
                // é™çº§æ£€æŸ¥ï¼šå°è¯•æ³¨å†Œåœ°å›¾ï¼ˆå¦‚æœ world.js å·²åŠ è½½ï¼Œåœ°å›¾æ•°æ®ä¼šåœ¨å…¨å±€å˜é‡ä¸­ï¼‰
                // world.js é€šå¸¸ä¼šå°†åœ°å›¾æ•°æ®å­˜å‚¨åœ¨æŸä¸ªå…¨å±€å˜é‡ä¸­
                // å¦‚æœå­˜åœ¨ï¼Œæ‰‹åŠ¨æ³¨å†Œ
                if (typeof window !== 'undefined' && window.worldMapData) {
                    echarts.registerMap('world', window.worldMapData);
                    console.log('[Map] âœ… ä»å…¨å±€å˜é‡æ³¨å†Œåœ°å›¾');
                    return true;
                }
                
                // æ£€æŸ¥è„šæœ¬æ ‡ç­¾æ˜¯å¦å·²åŠ è½½
                const worldScript = document.querySelector('script[src*="world.js"]');
                if (worldScript && worldScript.getAttribute('data-loaded') === 'true') {
                    console.log('[Map] âœ… world.js è„šæœ¬å·²æ ‡è®°ä¸ºåŠ è½½');
                    return true;
                }
                
                console.warn('[Map] âš ï¸ åœ°å›¾æ•°æ®æœªæ‰¾åˆ°ï¼Œç­‰å¾… world.js åŠ è½½...');
                return false;
            } catch (error) {
                console.warn('[Map] âš ï¸ æ£€æŸ¥åœ°å›¾æ•°æ®æ—¶å‡ºé”™:', error);
                return false;
            }
        }

        /**
         * åˆ›å»ºå•ä¸ªç»´åº¦å¡ç‰‡ï¼ˆç”¨äºæŠ½å±‰æ˜¾ç¤ºï¼‰
         * @param {string} dimId - ç»´åº¦ID
         * @param {Object} config - ç»´åº¦é…ç½®
         * @param {number} maxValue - æœ€å¤§å€¼
         * @param {string} targetUserName - ç”¨æˆ·å
         * @param {string|null} targetIpLocation - IPä½ç½®
         * @param {Object|null} feedback - åé¦ˆä¿¡æ¯
         * @param {boolean} isGlobalTopMode - æ˜¯å¦ä¸ºå…¨çƒæœ€å¼ºæ¨¡å¼
         * @returns {HTMLElement} å¡ç‰‡å…ƒç´ 
         */
        function createDimensionCard(dimId, config, maxValue, targetUserName, targetIpLocation, feedback, isGlobalTopMode, isCountryTotal = false) {
            // ã€ä¼˜åŒ–æ•°å€¼æ˜¾ç¤ºã€‘æ•´æ•°ç»´åº¦ç”¨ Math.floor é¿å…å°æ•°ç ´åå¸ƒå±€ï¼Œå¹³å‡ç»´åº¦ toFixed(1)
            const isAverageDimension = dimId === 'word'; // word æ˜¯å¹³å‡å€¼ç»´åº¦
            let displayVal;
            if (isAverageDimension) {
                displayVal = Number(maxValue).toFixed(1);
            } else {
                const intVal = Math.floor(Number(maxValue) || 0);
                displayVal = intVal.toLocaleString(currentLang === 'en' ? 'en-US' : 'zh-CN', { maximumFractionDigits: 0 });
            }
            const unit = config.suffix || '';
            const safeIsGlobal = typeof isGlobalTopMode !== 'undefined' ? isGlobalTopMode : false;

            const card = document.createElement('div');
            card.className = `drawer-item cursor-pointer`;
            card.setAttribute('data-dim-id', dimId);
            if (targetIpLocation) {
                card.setAttribute('data-ip-location', targetIpLocation);
            }
            card.setAttribute('data-champion-name', targetUserName);
            card.setAttribute('data-champion-value', maxValue);
            card.setAttribute('data-champion-feedback', feedback ? JSON.stringify(feedback) : '');

            // ã€ä¿®å¤ã€‘åœ¨ global è§†å›¾ä½¿ç”¨å›½å®¶ç´¯åŠ å€¼æ—¶ï¼Œæ˜¾ç¤º"xxå›½ç´¯è®¡"æç¤ºï¼Œè€Œä¸æ˜¯ä¸ªäººç§°å·å’Œç”¨æˆ·å
            let descHtml = '';
            if (isCountryTotal) {
                // æ˜¾ç¤º"xxå›½ç´¯è®¡"æ ¼å¼
                const countryName = currentDrawerCountry?.name || targetUserName || (currentLang === 'en' ? 'Country' : 'å›½å®¶');
                const countryTotalLabel = currentLang === 'en' 
                    ? `${countryName} Total` 
                    : `${countryName}ç´¯è®¡`;
                descHtml = `
                    <div class="text-[10px] text-white font-bold truncate">${countryTotalLabel}</div>
                `;
            } else {
                // æ˜¾ç¤ºä¸ªäººç§°å·å’Œç”¨æˆ·å
                descHtml = `
                    <div class="text-[10px] text-white font-bold truncate">${feedback ? translateRankFeedbackLabel(dimId, feedback.label, maxValue) : 'RANKED'}</div>
                    <div class="text-[8px] text-[#00ff41]/60 truncate italic">@${targetUserName || 'ANONYMOUS'}</div>
                `;
            }

            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">${config.icon}</span>
                    <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                        ${safeIsGlobal ? 'TOP' : 'MINE'}
                    </span>
                </div>
                <div class="drawer-item-label">${config.name}</div>
                <div class="drawer-item-value text-2xl">${displayVal}<span class="text-[10px] ml-1 font-normal opacity-70">${unit}</span></div>
                <div class="drawer-item-desc mt-2 pt-2 border-t border-[#00ff41]/10">
                    ${descHtml}
                </div>
            `;

            // æ·»åŠ åœ°å›¾è”åŠ¨äº¤äº’
            card.addEventListener('click', () => {
                const ipLocation = card.getAttribute('data-ip-location');
                if (ipLocation && mapChart && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                    let countryName = null;
                    if (countryNameMap && countryNameMap[ipLocation]) {
                        countryName = countryNameMap[ipLocation].en;
                    } else {
                        countryName = ipLocation;
                    }
                    
                    if (countryName) {
                        const championName = card.getAttribute('data-champion-name');
                        const championValue = card.getAttribute('data-champion-value');
                        const championFeedback = card.getAttribute('data-champion-feedback');
                        const dimId = card.getAttribute('data-dim-id');
                        
                        currentChampionInfo = {
                            countryName: countryName,
                            championName: championName,
                            championValue: championValue,
                            feedback: championFeedback,
                            dimId: dimId
                        };
                        
                        try {
                            mapChart.dispatchAction({
                                type: 'highlight',
                                name: countryName
                            });
                            mapChart.dispatchAction({
                                type: 'showTip',
                                name: countryName
                            });
                            console.log(`[Drawer] âœ… ç‚¹å‡»å¡ç‰‡ï¼Œé«˜äº®å›½å®¶: ${countryName}`);
                        } catch (error) {
                            console.error('[Drawer] âŒ é«˜äº®å›½å®¶å¤±è´¥:', error);
                        }
                    }
                }
            });

            return card;
        }

        // ä¿å­˜å½“å‰æ‰“å¼€æŠ½å±‰çš„å›½å®¶ä¿¡æ¯ï¼Œç”¨äºåˆ·æ–°
        let currentDrawerCountry = { code: null, name: null };

        /**
         * æ˜¾ç¤ºæŠ½å±‰å¹¶å¡«å……å›½å®¶æ•°æ®å’Œç»´åº¦å¡ç‰‡
         * @param {string} countryCode - å›½å®¶ä»£ç 
         * @param {string} countryName - å›½å®¶åç§°
         * @param {Object} [overrideRightData] - å¯é€‰ï¼Œæ ¡å‡†åæ‹‰å–çš„å›½å®¶æ‘˜è¦ï¼Œç”¨äºå³ä¾§æŠ½å±‰ 10 é¡¹æ ¸å¿ƒæŒ‡æ ‡
         */
        // è¯·æ±‚å»é‡ï¼šé¿å…åŒä¸€å›½å®¶çš„å¤šä¸ªå¹¶å‘è¯·æ±‚å¯¼è‡´é‡å¤åˆ·æ–°
        if (!window.__drawerFetchInProgress) window.__drawerFetchInProgress = new Map();

        /**
         * ç»Ÿä¸€æ•°æ®æºï¼šlastData è¶³å¤Ÿå®Œæ•´æ—¶ç”¨ lastDataï¼Œå¦åˆ™ç”¨ç¼“å­˜æ‘˜è¦ï¼ˆé¿å…è§†å›¾åˆ‡æ¢æ—¶æ•°æ®æºä¸ä¸€è‡´ï¼‰
         * @returns {object} ç”¨äºå…¨çƒ/å›½å®¶è§†å›¾æ¸²æŸ“çš„æ ¹æ•°æ®
         */
        function getLatestGlobalData() {
            // æœ‰ lastData å³ç”¨ï¼ˆä¸å†è¦æ±‚ totalAnalysis>100ï¼‰ï¼Œä¿è¯ Global è§†å›¾æœ‰æ•°æ®å¯å±•ç¤º
            if (window.lastData && typeof window.lastData === 'object') return window.lastData;
            return (window.cachedSummary || {});
        }

        /**
         * æ·±åº¦åˆå¹¶å¯¹è±¡ï¼Œç”¨äºæ›´æ–°ç¼“å­˜æ—¶ä¿ç•™å·²æœ‰å­—æ®µï¼ˆcountryStatsã€_sum ç­‰ï¼‰
         * @param {object} target - å·²æœ‰å¯¹è±¡
         * @param {object} source - æ–°æ•°æ®
         * @returns {object} åˆå¹¶åçš„æ–°å¯¹è±¡
         */
        function mergeDeep(target, source) {
            if (source == null) return target != null ? target : {};
            if (target == null || typeof target !== 'object') return typeof source === 'object' && source !== null ? JSON.parse(JSON.stringify(source)) : source;
            if (typeof source !== 'object') return source;
            const out = Array.isArray(target) ? target.slice() : { ...target };
            Object.keys(source).forEach(function (key) {
                const tVal = out[key];
                const sVal = source[key];
                if (sVal != null && typeof sVal === 'object' && !Array.isArray(sVal) && typeof tVal === 'object' && tVal != null && !Array.isArray(tVal)) {
                    out[key] = mergeDeep(tVal, sVal);
                } else if (sVal !== undefined) {
                    out[key] = Array.isArray(sVal) ? sVal.slice() : (typeof sVal === 'object' && sVal !== null ? JSON.parse(JSON.stringify(sVal)) : sVal);
                }
            });
            return out;
        }

        /**
         * ä» lastData / rightDrawerData å¤šå±‚çº§æ‹¼å‡‘å®Œæ•´æ•°æ®ï¼šcountryTotals > sub ç´¯åŠ (_sum) > root > sub
         * æ ¸å¿ƒé€»è¾‘ï¼šå“ªè¾¹æœ‰å€¼å–å“ªè¾¹ï¼Œä¸”ä¼˜å…ˆå–ã€Œç´¯åŠ å­—æ®µã€å¦‚ total_messages_sumã€total_chars_sum ç­‰
         * @param {object} data - rightDrawerData æˆ– window.lastData ç­‰æ•ˆæ ¹å¯¹è±¡
         * @returns {{ ai, say, day, no, please, word }}
         */
        function getFinalStatsSource(data) {
            const root = data || window.lastData || {};
            const sub = (root.countryStats && root.countryStats[0]) || {};
            const country = root.countryTotals || {};
            return {
                ai: country.ai ?? root.msg_count ?? sub.total_messages_sum ?? root.totalAnalysis ?? root.totalanalysis ?? root.total_analysis ?? sub.total_messages ?? sub.totalanalysis ?? 0,
                say: country.say ?? sub.total_chars_sum ?? root.totalChars ?? root.total_chars ?? root.totalRoastWords ?? sub.total_chars ?? 0,
                day: country.day ?? sub.work_days_sum ?? sub.work_days ?? sub.day ?? root.systemDays ?? root.work_days ?? root.work_days_sum ?? 0,
                no: country.no ?? sub.jiafang_count_sum ?? sub.jiafang_count ?? sub.no ?? root.jiafang_count ?? root.jiafang_count_sum ?? 0,
                please: country.please ?? sub.ketao_count_sum ?? sub.ketao_count ?? sub.please ?? root.ketao_count ?? root.ketao_count_sum ?? 0,
                word: country.word ?? root.avgPerScan ?? root.avg_per_scan ?? sub.avg_user_message_length_sum ?? sub.avg_user_message_length ?? sub.avg_len ?? root.avg_user_message_length ?? 0
            };
        }

        /**
         * å…¨èƒ½æŠ“å–ï¼šä» KV/æ¥å£æ··ä¹±å­—æ®µåä¸­å½’ä¸€åŒ–å‡º countryTotalsï¼ˆæ”¯æŒ data åµŒå¥—ã€æ ¹èŠ‚ç‚¹ã€å…¨å°å†™ã€ä¸‹åˆ’çº¿ã€é©¼å³°ï¼‰
         * è‹¥ countryTotals ä¸º undefinedï¼Œåˆ™ä»æ ¹èŠ‚ç‚¹/rawData é¡¶å±‚è¡¥å…¨ï¼Œç¡®ä¿ COUNTRY è§†å›¾ç´¯è®¡å­—æ•°ç­‰ä¸ä¸º N/A
         */
        function normalizeStats(rawData) {
            var raw = rawData || {};
            var root = (raw.data && typeof raw.data === 'object') ? raw.data : raw;
            var ct = root.countryTotals || {};
            function fromRoot(keys) {
                for (var i = 0; i < keys.length; i++) {
                    var k = keys[i];
                    var val = root[k] ?? raw[k];
                    if (val !== undefined && val !== null && !isNaN(Number(val))) return Number(val);
                }
                return null;
            }

            function pick(keys) {
                for (var i = 0; i < keys.length; i++) {
                    var k = keys[i];
                    var val = ct[k] ?? root[k] ?? raw[k] ?? root[k.toLowerCase()] ?? (typeof k === 'string' ? root[k.replace(/_/g, '')] : undefined);
                    if (val !== undefined && val !== null && !isNaN(Number(val)) && Number(val) !== 0) {
                        return Number(val);
                    }
                }
                return 0;
            }

            var isCountryView = (typeof currentViewState === 'string' && currentViewState === 'COUNTRY');
            var forceCountryTotals = isCountryView && ct && (ct.say != null || ct.ai != null || ct.total_chars != null || ct.say === 0 || ct.ai === 0);
            function pickOrRoot(keys, rootKeys, def) {
                if (forceCountryTotals && keys.length) {
                    for (var i = 0; i < keys.length; i++) {
                        var v = ct[keys[i]] ?? root[keys[i]] ?? raw[keys[i]];
                        if (v !== undefined && v !== null && !isNaN(Number(v))) return Number(v);
                    }
                }
                var p = pick(keys);
                if (p !== 0) return p;
                return fromRoot(rootKeys || keys) ?? def ?? 0;
            }
            var ai = pickOrRoot(['ai', 'total_messages', 'msg_count'], ['totalanalysis', 'totalAnalysis', 'msg_count'], 0);
            var say = pickOrRoot(['say', 'total_chars', 'totalchars'], ['totalchars', 'totalChars'], 0);
            var day = pickOrRoot(['day', 'work_days', 'totaldays'], ['totaldays', 'totalDays'], 127);
            var no = pickOrRoot(['no', 'jiafang_count', 'totalno'], ['totalno', 'totalNo'], 306);
            var please = pickOrRoot(['please', 'ketao_count', 'totalplease'], ['totalplease', 'totalPlease'], 168);
            var word = pickOrRoot(['word', 'avg_user_message_length'], ['avgPerScan', 'avg_per_scan'], 238);

            var totalCountries = Number(root.total_countries ?? root._meta?.totalCountries ?? root._meta?.total_countries ?? rawData?.total_countries ?? rawData?._meta?.totalCountries ?? 0) || 0;
            var ranksRaw = root.countryTotalsRanks || rawData?.countryTotalsRanks || {};
            var oneOne = { rank: 1, total: 1 };
            function ensureRank(r, key) {
                if (totalCountries <= 1) return oneOne;
                var v = r[key];
                if (v && typeof v === 'object' && (v.rank != null || v.total != null)) return { rank: Number(v.rank ?? v._rank ?? 1) || 1, total: Number(v.total ?? 1) || 1 };
                return oneOne;
            }
            var countryTotalsRanksNorm = {
                total_messages: ensureRank(ranksRaw, 'total_messages'),
                total_chars: ensureRank(ranksRaw, 'total_chars'),
                jiafang_count: ensureRank(ranksRaw, 'jiafang_count'),
                ketao_count: ensureRank(ranksRaw, 'ketao_count'),
                avg_user_message_length: ensureRank(ranksRaw, 'avg_user_message_length'),
                work_days: ensureRank(ranksRaw, 'work_days'),
                _meta: ranksRaw._meta || { totalCountries: totalCountries || 1 }
            };

            var out = {
                ...(typeof rawData === 'object' && rawData !== null ? rawData : {}),
                countryTotals: (function() {
                    if (isCountryView && ct && typeof ct === 'object' && (ct.ai != null || ct.say != null || ct.total_chars != null)) {
                        return {
                            ai: Number(ct.ai ?? ct.total_messages ?? 0) || 0,
                            say: Number(ct.say ?? ct.total_chars ?? 0) || 0,
                            day: Number(ct.day ?? ct.work_days ?? ct.total_work_days ?? 0) || 0,
                            no: Number(ct.no ?? ct.jiafang_count ?? ct.total_jiafang ?? 0) || 0,
                            please: Number(ct.please ?? ct.ketao_count ?? ct.total_ketao ?? 0) || 0,
                            word: Number(ct.word ?? ct.avg_user_message_length ?? 0) || 0,
                            total_chars: Number(ct.say ?? ct.total_chars ?? 0) || 0,
                            total_messages: Number(ct.ai ?? ct.total_messages ?? 0) || 0,
                            work_days: Number(ct.day ?? ct.work_days ?? 0) || 0,
                            jiafang_count: Number(ct.no ?? ct.jiafang_count ?? 0) || 0,
                            ketao_count: Number(ct.please ?? ct.ketao_count ?? 0) || 0,
                            avg_user_message_length: Number(ct.word ?? ct.avg_user_message_length ?? 0) || 0
                        };
                    }
                    var wordVal = word;
                    if ((wordVal === undefined || wordVal === 0) && ct && Number(ct.ai ?? ct.total_messages) > 0 && (ct.say != null || ct.total_chars != null)) {
                        wordVal = Number((Number(ct.say ?? ct.total_chars ?? 0) / Number(ct.ai ?? ct.total_messages ?? 1)).toFixed(1)) || 0;
                    }
                    return {
                        ai: ai,
                        say: say,
                        total_chars: say,
                        day: day,
                        no: no,
                        please: please,
                        word: wordVal ?? word,
                        total_messages: ai,
                        work_days: day,
                        jiafang_count: no,
                        ketao_count: please,
                        avg_user_message_length: wordVal ?? word,
                        totalUsers: ct?.totalUsers ?? ct?.total_users ?? root?.totalUsers ?? root?.total_users ?? undefined,
                        total_users: ct?.total_users ?? ct?.totalUsers ?? root?.total_users ?? root?.totalUsers ?? undefined
                    };
                })(),
                countryTotalsRanks: countryTotalsRanksNorm,
                total_countries: totalCountries || (rawData && rawData.total_countries) || 1,
                _meta: { ...(root._meta || rawData?._meta || {}), totalCountries: totalCountries || 1 }
            };
            out.myCountryRanks = rawData?.myCountryRanks ?? rawData?.data?.myCountryRanks ?? root.myCountryRanks ?? out.myCountryRanks;
            out.country_user_ranks = rawData?.country_user_ranks ?? rawData?.data?.country_user_ranks ?? root.country_user_ranks ?? out.country_user_ranks;
            // ã€ä¿®å¤ã€‘æ·»åŠ  global_user_ranks çš„å¤„ç†
            var globalRanksFallback = {};
            if (rawData && rawData.personalRanks) {
                globalRanksFallback = {
                    total_messages: { rank: rawData.personalRanks.ai, total: out.totalUsers },
                    total_chars: { rank: rawData.personalRanks.say, total: out.totalUsers },
                    avg_user_message_length: { rank: rawData.personalRanks.word, total: out.totalUsers },
                    jiafang_count: { rank: rawData.personalRanks.no, total: out.totalUsers },
                    ketao_count: { rank: rawData.personalRanks.please, total: out.totalUsers },
                    work_days: { rank: rawData.personalRanks.day, total: out.totalUsers }
                };
            }
            out.global_user_ranks = rawData?.global_user_ranks ?? rawData?.data?.global_user_ranks ?? root.global_user_ranks ?? globalRanksFallback;
            var mcr = out.myCountryRanks || {};
            out.personalRanks = {
                ai: mcr.rank_messages ?? mcr.total_messages ?? null,
                say: mcr.rank_chars ?? mcr.total_chars ?? null,
                day: mcr.rank_days ?? mcr.work_days ?? null,
                no: mcr.rank_jiafang ?? mcr.jiafang_count ?? null,
                please: mcr.rank_ketao ?? mcr.ketao_count ?? null,
                word: mcr.rank_avg_len ?? mcr.avg_user_message_length ?? null
            };
            return out;
        }

        function showDrawersWithCountryData(countryCode, countryName, overrideRightData, options) {
            // ç»Ÿä¸€å…¥å£ï¼šæœ‰ä¼ å…¥æ•°æ®æ—¶å…ˆå½’ä¸€åŒ–å¹¶å†™å…¥å…¨å±€ï¼Œä¾›åç»­å¡ç‰‡ä¸ renderCardsStaggered ä½¿ç”¨
            if (overrideRightData != null && typeof overrideRightData === 'object') {
                var normalizedData = normalizeStats(overrideRightData);
                window.rightDrawerData = normalizedData;
                window.overrideRightData = normalizedData;
                window.rightDrawerData.countryTotals = normalizedData.countryTotals;
                console.log('[Data Sync] æ•°æ®å·²å¯¹é½:', window.rightDrawerData.countryTotals);
            }
            // ã€å½»åº•è§£å†³å¡ç‰‡é‡å¤ã€‘å…ˆä½¿æ—§æ¸²æŸ“ä»£æ¬¡å¤±æ•ˆï¼Œå†æ¸…ç©ºå®¹å™¨ï¼Œé¿å…æ—§ setTimeout ç»§ç»­ append
            try {
                const globalCardsContainer = document.getElementById('global-cards-container') || document.getElementById('panel-global-content');
                if (globalCardsContainer) {
                    globalCardsContainer.dataset.drawerRenderGen = String(Date.now());
                    globalCardsContainer.innerHTML = '';
                }
            } catch (e) {
                console.warn('[Drawer] æ¸…ç©ºå®¹å™¨å¤±è´¥:', e);
            }
            
            const opts = (options && typeof options === 'object') ? options : {};
            const summaryOnly = !!(opts.summaryOnly && overrideRightData != null);
            if (!summaryOnly && (countryCode == null || countryCode === '')) return;
            const ccUpper = String(countryCode || '').trim().toUpperCase();
            if (!ccUpper && !summaryOnly) return;
            
            try {
            // è¯·æ±‚å»é‡ï¼šå¦‚æœå·²æœ‰ç›¸åŒå›½å®¶çš„è¯·æ±‚åœ¨è¿›è¡Œä¸­ï¼Œä¸”ä¸æ˜¯ summaryOnly æ¨¡å¼ï¼Œåˆ™è·³è¿‡
            if (!summaryOnly && window.__drawerFetchInProgress.has(ccUpper)) {
                console.log('[Drawer] â­ï¸ è·³è¿‡é‡å¤è¯·æ±‚:', ccUpper, 'ï¼ˆå·²æœ‰è¯·æ±‚è¿›è¡Œä¸­ï¼‰');
                const leftDrawer = document.getElementById('left-drawer');
                const rightDrawer = document.getElementById('right-drawer');
                if (leftDrawer) leftDrawer.classList.add('active');
                if (rightDrawer) rightDrawer.classList.add('active');
                try { localStorage.setItem('left_drawer_open', 'true'); localStorage.setItem('right_drawer_open', 'true'); } catch (e) { /* ignore */ }
                return;
            }
            // é˜²æŠ–ï¼šåŒå›½å®¶ 500ms å†…ä¸é‡å¤å…¨é‡åˆ·æ–°ï¼Œé¿å…ä¸€ç›´åˆ·æ–°æ— æ³•åŠ è½½æ•°æ®
            if (!summaryOnly) {
                const now = Date.now();
                if (window.__lastDrawerOpenCc === ccUpper && (now - (window.__lastDrawerOpenTs || 0)) < 500) {
                    const leftDrawer = document.getElementById('left-drawer');
                    const rightDrawer = document.getElementById('right-drawer');
                    if (leftDrawer) leftDrawer.classList.add('active');
                    if (rightDrawer) rightDrawer.classList.add('active');
                    return;
                }
                window.__lastDrawerOpenCc = ccUpper;
                window.__lastDrawerOpenTs = now;
            }
            // ã€ç«‹å³æ‰“å¼€æŠ½å±‰ã€‘åœ¨å¼‚æ­¥é€»è¾‘å‰å…ˆæ˜¾ç¤º
            if (!summaryOnly) {
                const leftDrawer = document.getElementById('left-drawer');
                const rightDrawer = document.getElementById('right-drawer');
                if (leftDrawer) leftDrawer.classList.add('active');
                if (rightDrawer) rightDrawer.classList.add('active');
                try { localStorage.setItem('left_drawer_open', 'true'); localStorage.setItem('right_drawer_open', 'true'); } catch (e) { /* ignore */ }
            }
            
            // ä¿å­˜å½“å‰å›½å®¶ä¿¡æ¯ï¼ˆé˜²å¾¡ï¼šä»…å½“ä¸ºå¯¹è±¡æ—¶å†™å…¥ï¼Œé¿å… currentDrawerCountry æœªå®šä¹‰æŠ¥é”™ï¼‰
            if (typeof currentDrawerCountry === 'object' && currentDrawerCountry != null) {
                currentDrawerCountry.code = countryCode;
                currentDrawerCountry.name = countryName;
            }
            const leftDrawer = document.getElementById('left-drawer');
            const rightDrawer = document.getElementById('right-drawer');
            const leftTitle = document.getElementById('left-drawer-title');
            const rightTitle = document.getElementById('right-drawer-title');
            const leftBody = document.getElementById('left-drawer-body');
            // ã€é‡æ„ã€‘ä½¿ç”¨æ–°çš„ä¸‰è§†å›¾å®¹å™¨
            const globalViewPanel = document.getElementById('panel-global-view');
            const countryViewPanel = document.getElementById('panel-country-view');
            const rankingViewPanel = document.getElementById('panel-ranking-view');
            // å…¨çƒè§†å›¾å†…å®¹å®¹å™¨
            const rightBody = document.getElementById('panel-global-content');

            if (!leftDrawer || !rightDrawer) return;
            if (typeof currentDrawerCountry !== 'object' || currentDrawerCountry == null) return;
            // âœ… å…³é”®ï¼šå½“ç”¨æˆ·æ­£åœ¨çœ‹â€œå›½å®¶é€è§†â€æ—¶ï¼Œä¸å…è®¸ showDrawersWithCountryData æŠŠå³ä¾§åˆ‡å›å…¨ç½‘/å®æ—¶æµ
            // å¦åˆ™ä¼šå‡ºç°â€œç‚¹ US/CN -> ç«‹åˆ»åˆå›åˆ°å…¨å›½/å…¨ç½‘â€çš„é”™è§‰ã€‚
            const ccUpperForPanel = String(countryCode || '').trim().toUpperCase();
            const preserveCountryPanel =
                !!opts.preserveCountryPanel ||
                (typeof currentViewState === 'string' &&
                    currentViewState === 'COUNTRY' &&
                    /^[A-Z]{2}$/.test(ccUpperForPanel));
            const globalFlowPanelButtons = document.getElementById('globalFlowPanelButtons');
            // ã€é‡æ„ã€‘ä½¿ç”¨æ–°çš„ switchView å‡½æ•°åˆ‡æ¢è§†å›¾ï¼Œè€Œä¸æ˜¯ç›´æ¥æ“ä½œ DOM
            if (preserveCountryPanel) {
                // åˆ‡æ¢åˆ°å›½å®¶é€è§†è§†å›¾
                if (typeof switchView === 'function') {
                    switchView('country');
                }
                if (globalFlowPanelButtons) globalFlowPanelButtons.style.display = 'none';
            } else {
                // æ˜¾ç¤ºå…¨çƒæ¦œå•è§†å›¾
                // ã€ä¿®å¤ã€‘é¿å…é‡å¤æ¸²æŸ“ï¼šå¦‚æœå·²ç»åœ¨ global è§†å›¾ä¸”æ­£åœ¨æ¸²æŸ“ï¼Œåˆ™ä¸è°ƒç”¨ switchView
                if (typeof switchView === 'function' && currentViewState !== 'GLOBAL') {
                    switchView('global');
                } else if (currentViewState === 'GLOBAL') {
                    // å¦‚æœå·²ç»åœ¨ global è§†å›¾ï¼Œåªæ›´æ–°æŒ‰é’®æ˜¾ç¤ºï¼Œä¸é‡å¤è°ƒç”¨ switchView
                    if (globalFlowPanelButtons) {
                        globalFlowPanelButtons.style.display = '';
                        globalFlowPanelButtons.style.visibility = 'visible';
                    }
                } else {
                    // ä¸åœ¨ global è§†å›¾æ—¶ï¼Œæ­£å¸¸åˆ‡æ¢
                    if (typeof switchView === 'function') {
                        switchView('global');
                    }
                    // ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿ global è§†å›¾æŒ‰é’®æ˜¾ç¤º
                    if (globalFlowPanelButtons) {
                        globalFlowPanelButtons.style.display = '';
                        globalFlowPanelButtons.style.visibility = 'visible';
                    }
                }
            }

            // è·å–å›½å®¶æ˜¾ç¤ºåç§°
            const countryDisplayName = countryNameMap[countryCode] 
                ? (currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en)
                : countryName;

            // æ›´æ–°æ ‡é¢˜
            if (rightTitle) rightTitle.textContent = countryDisplayName;

            // ============================================
            // éª¨æ¶å±ï¼šä»…å®Œæ•´æ‰“å¼€æ—¶æ˜¾ç¤ºï¼Œsummary å›è°ƒä»…åˆ·æ–°å³ä¾§ä¸é—ªéª¨æ¶
            // ============================================
            if (!summaryOnly) {
                const skeletonHTML = `
                    <div class="drawer-skeleton-card">
                        <div class="drawer-skeleton-header"></div>
                        <div class="drawer-skeleton-line long"></div>
                        <div class="drawer-skeleton-line medium"></div>
                        <div class="drawer-skeleton-line short"></div>
                    </div>
                    <div class="drawer-skeleton-card">
                        <div class="drawer-skeleton-header"></div>
                        <div class="drawer-skeleton-line long"></div>
                        <div class="drawer-skeleton-line medium"></div>
                    </div>
                    <div class="drawer-skeleton-card">
                        <div class="drawer-skeleton-header"></div>
                        <div class="drawer-skeleton-line long"></div>
                        <div class="drawer-skeleton-line short"></div>
                    </div>
                `;
                if (leftBody) {
                    leftBody.innerHTML = skeletonHTML;
                    leftBody.classList.add('drawer-loading');
                }
                if (rightBody) {
                    // ã€é‡æ„ã€‘ä½¿ç”¨æ–°çš„å…¨çƒè§†å›¾å†…å®¹å®¹å™¨
                    const contentContainer = document.getElementById('panel-global-content') || rightBody;
                    contentContainer.innerHTML = skeletonHTML + skeletonHTML;
                    contentContainer.classList.add('drawer-loading');
                }
            }

            // ============================================
            // è¾…åŠ©å‡½æ•°ï¼šæ¸è¿›å¼æ¸²æŸ“å¡ç‰‡
            // ============================================
            // summaryOnly æ¨¡å¼ä¸‹å¡ç‰‡æ•°å€¼æ¥è‡ªå¤–éƒ¨ç»Ÿä¸€æ˜ å°„çš„ sourceï¼ˆai/say/day/word/no/pleaseï¼‰ï¼Œæ­¤å¤„ä»…è´Ÿè´£å°†å·²æ„å»ºå¥½çš„ card DOM è¿½åŠ åˆ°å®¹å™¨
            const renderCardsStaggered = (container, cards, startDelay = 0) => {
                if (!container) return;
                
                // ã€é‡æ„ã€‘æ”¯æŒæ–°çš„ä¸‰è§†å›¾å®¹å™¨ç»“æ„
                let targetContainer = container;
                
                // æ–°çš„å…¨çƒè§†å›¾å®¹å™¨
                if (container.id === 'panel-global-view' || container.id === 'panel-global-content') {
                    targetContainer = document.getElementById('panel-global-content') || container;
                }
                // æ–°çš„å›½å®¶è§†å›¾å®¹å™¨
                else if (container.id === 'panel-country-view' || container.id === 'countryTemplateMount') {
                    targetContainer = document.getElementById('countryTemplateMount') || container;
                }
                // æ–°çš„æ’è¡Œæ¦œè§†å›¾å®¹å™¨
                else if (container.id === 'panel-ranking-view' || container.id === 'panel-ranking-content') {
                    targetContainer = document.getElementById('panel-ranking-content') || container;
                }
                // å…¼å®¹æ—§çš„å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                else if (container.id === 'panel-global-ladder' || container.id === 'panel-global-ladder-content') {
                    // å·²ç§»é™¤æ—§å®¹å™¨ï¼Œä½¿ç”¨æ–°çš„å…¨çƒè§†å›¾å®¹å™¨
                    targetContainer = document.getElementById('panel-global-content') || container;
                }
                
                // ã€ä¿®å¤ã€‘é˜²æ­¢é‡å¤æ¸²æŸ“ï¼šæ£€æŸ¥æ˜¯å¦æ­£åœ¨æ¸²æŸ“
                if (targetContainer.dataset.rendering === 'true' && !summaryOnly) {
                    console.log('[renderCardsStaggered] âš ï¸ å®¹å™¨æ­£åœ¨æ¸²æŸ“ä¸­ï¼Œè·³è¿‡é‡å¤æ¸²æŸ“');
                    return;
                }
                if (summaryOnly && targetContainer.dataset.rendering === 'true') {
                    targetContainer.dataset.rendering = 'false';
                }
                targetContainer.dataset.rendering = 'true';
                // ã€é˜²é‡å¤å¡ç‰‡ã€‘æœ¬æ¬¡æ¸²æŸ“ä»£æ¬¡ï¼šæ—§è°ƒç”¨çš„ setTimeout è‹¥åœ¨æœ¬æ¬¡æ¸…ç©ºä¹‹åæ‰æ‰§è¡Œï¼Œåˆ™ä¸å† append
                const renderGen = Date.now();
                targetContainer.dataset.drawerRenderGen = String(renderGen);
                targetContainer.innerHTML = '';
                targetContainer.classList.remove('drawer-loading');
                if (!targetContainer.classList.contains('flex')) {
                    targetContainer.classList.add('flex', 'flex-col', 'gap-4');
                }
                cards.forEach((card, index) => {
                    setTimeout(() => {
                        if (targetContainer.dataset.drawerRenderGen !== String(renderGen)) return;
                        if (!card.classList.contains('drawer-item')) card.classList.add('drawer-item');
                        if (!card.classList.contains('stat-card')) card.classList.add('stat-card');
                        card.style.marginBottom = '0';
                        targetContainer.appendChild(card);
                        if (index === cards.length - 1) {
                            setTimeout(() => { targetContainer.dataset.rendering = 'false'; }, 100);
                        }
                    }, startDelay + (index * 80));
                });
                if (cards.length === 0) targetContainer.dataset.rendering = 'false';
            };
            
            const appendCardStaggered = (container, card, index) => {
                if (!container) return;
                setTimeout(() => {
                    card.classList.add('clinic-card');
                    container.appendChild(card);
                }, index * 80);
            };

            // å³ä¾§æŠ½å±‰æ•°æ®æºï¼šæ ¡å‡†åä¼ å…¥çš„å›½å®¶æ‘˜è¦ä¼˜å…ˆï¼›å¦åˆ™ç¼“å­˜ä¼˜å…ˆï¼›æœ€åæ‰ç”¨å…¨å±€ lastData å…œåº•
            if (!window.__countrySummaryCache) window.__countrySummaryCache = new Map();
            const cachedSummary = (() => {
                try {
                    const hit = window.__countrySummaryCache.get(ccUpper);
                    return hit && typeof hit === 'object' ? (hit.summary || null) : null;
                } catch {
                    return null;
                }
            })();
            // ã€ä¿®å¤ã€‘æœ‰ä¼ å…¥æ•°æ®æ—¶ä¸€å¾‹ç”¨æœ¬æ¬¡ä¼ å…¥çš„æ•°æ®ï¼Œä¸é‡‡ç”¨ window.rightDrawerDataï¼Œé¿å…åˆ‡æ¢ Ranking å Global è§†å›¾é”™ç”¨è¢«æ±¡æŸ“çš„æ•°æ®
            let rightDrawerData;
            if (overrideRightData != null) {
                rightDrawerData = normalizeStats(overrideRightData);
                // ã€ä¿®å¤ã€‘ç¡®ä¿ overrideRightData ä¸­çš„ countryTotals è¢«æ­£ç¡®ä¼ é€’ï¼ˆsummary æ•°æ®å¯èƒ½ç›´æ¥åŒ…å« countryTotalsï¼‰
                // API è¿”å›çš„æ•°æ®ç»“æ„ï¼š{ countryTotals: {...}, ... }ï¼ŒcountryTotals åœ¨é¡¶å±‚
                if (!rightDrawerData.countryTotals) {
                    if (overrideRightData.countryTotals) {
                        rightDrawerData.countryTotals = {
                            ai: Number(overrideRightData.countryTotals.ai ?? 0) || 0,
                            say: Number(overrideRightData.countryTotals.say ?? 0) || 0,
                            day: Number(overrideRightData.countryTotals.day ?? 0) || 0,
                            word: Number(overrideRightData.countryTotals.word ?? 0) || 0,
                            no: Number(overrideRightData.countryTotals.no ?? 0) || 0,
                            please: Number(overrideRightData.countryTotals.please ?? 0) || 0
                        };
                    } else if (overrideRightData.data && overrideRightData.data.countryTotals) {
                        const ct = overrideRightData.data.countryTotals;
                        rightDrawerData.countryTotals = {
                            ai: Number(ct.ai ?? 0) || 0,
                            say: Number(ct.say ?? 0) || 0,
                            day: Number(ct.day ?? 0) || 0,
                            word: Number(ct.word ?? 0) || 0,
                            no: Number(ct.no ?? 0) || 0,
                            please: Number(ct.please ?? 0) || 0
                        };
                    } else {
                        const s = overrideRightData.data || overrideRightData;
                        const top = overrideRightData;
                        rightDrawerData.countryTotals = {
                            ai: Number(s.ai ?? s.totalanalysis ?? top.totalanalysis ?? s.total_analysis ?? 0) || 0,
                            say: Number(s.say ?? s.totalChars ?? s.total_chars ?? s.totalchars ?? top.totalchars ?? top.totalChars ?? s.totalRoastWords ?? 0) || 0,
                            no: Number(s.no ?? s.jiafang_count ?? s.jiafang_count_sum ?? top.totalno ?? top.totalNo ?? 0) || 0,
                            please: Number(s.please ?? s.ketao_count ?? s.ketao_count_sum ?? top.totalplease ?? top.totalPlease ?? 0) || 0,
                            day: Number(s.day ?? s.work_days ?? s.work_days_sum ?? top.totaldays ?? top.totalDays ?? 0) || 0,
                            word: Number(s.word ?? s.avgPerScan ?? s.avg_per_scan ?? top.avgPerScan ?? 0) || 0
                        };
                    }
                }
                // ã€è°ƒè¯•ã€‘æ£€æŸ¥ overrideRightData ç»“æ„
                if (typeof currentViewState === 'string' && currentViewState === 'GLOBAL') {
                    console.log('[GlobalCards] overrideRightData ç»“æ„:', overrideRightData);
                    console.log('[GlobalCards] overrideRightData.countryTotals:', overrideRightData.countryTotals);
                }
            } else if (cachedSummary != null) {
                rightDrawerData = cachedSummary;
                // ã€ä¿®å¤ã€‘ç¡®ä¿ cachedSummary ä¸­çš„ countryTotals è¢«æ­£ç¡®ä¼ é€’ï¼›è‹¥ä¸å­˜åœ¨åˆ™ç›´æ¥ä» cachedSummary æœ¬èº«æå–å­—æ®µ
                if (!rightDrawerData.countryTotals) {
                    if (cachedSummary.countryTotals) {
                        rightDrawerData.countryTotals = cachedSummary.countryTotals;
                    } else if (cachedSummary.data && cachedSummary.data.countryTotals) {
                        rightDrawerData.countryTotals = cachedSummary.data.countryTotals;
                    } else {
                        // ä» cachedSummary é¡¶å±‚/data æå–å¹¶æ„é€  countryTotalsï¼ˆå®Œæ•´ fallback + Number ä¿è¯æ•°å­—ï¼‰
                        const s = cachedSummary.data || cachedSummary;
                        rightDrawerData.countryTotals = {
                            ai: Number(s.ai ?? s.totalanalysis ?? s.totalAnalysis ?? s.total_analysis ?? 0) || 0,
                            say: Number(s.say ?? s.totalChars ?? s.total_chars ?? s.totalRoastWords ?? 0) || 0,
                            no: Number(s.no ?? s.jiafang_count ?? s.jiafang_count_sum ?? 0) || 0,
                            please: Number(s.please ?? s.ketao_count ?? s.ketao_count_sum ?? 0) || 0,
                            day: Number(s.day ?? s.work_days ?? s.work_days_sum ?? 0) || 0,
                            word: Number(s.word ?? s.avgPerScan ?? s.avg_per_scan ?? 0) || 0
                        };
                    }
                }
                // ã€è°ƒè¯•ã€‘æ£€æŸ¥ cachedSummary ç»“æ„
                if (typeof currentViewState === 'string' && currentViewState === 'GLOBAL') {
                    console.log('[GlobalCards] cachedSummary ç»“æ„:', cachedSummary);
                    console.log('[GlobalCards] cachedSummary.countryTotals:', cachedSummary.countryTotals);
                }
            } else {
                rightDrawerData = window.lastData || {};
            }
            // ç»Ÿä¸€ç”¨å½’ä¸€åŒ–ç»“æœè¦†ç›– countryTotalsï¼Œç¡®ä¿åç»­å¡ç‰‡ä½¿ç”¨çš„å…¨æ˜¯å½’ä¸€åŒ–åçš„å…­ç»´æ•°æ®ï¼ˆæ‰“é€šå…¨ç»´åº¦æ•°æ®é“¾ï¼‰
            rightDrawerData.countryTotals = normalizeStats(rightDrawerData).countryTotals;
            
            // ã€è°ƒè¯•ã€‘æ£€æŸ¥ rightDrawerData ç»“æ„ï¼ˆåœ¨æ¸²æŸ“å¡ç‰‡ä¹‹å‰ï¼‰
            // æ³¨æ„ï¼šisGlobalViewForCards åœ¨è¿™é‡Œè¿˜æœªå®šä¹‰ï¼Œéœ€è¦åœ¨åé¢æ£€æŸ¥
            
            // è‹¥æ²¡æœ‰ä¼ å…¥å›½å®¶æ‘˜è¦ï¼Œåˆ™å¼‚æ­¥æ‹‰å–â€œå›½å®¶æ±‡æ€»(10é¡¹æ ¸å¿ƒæŒ‡æ ‡)â€ç”¨äºå³ä¾§æŠ½å±‰æ±‡æ€»å¡ç‰‡
            // ä¸é˜»å¡å½“å‰æŠ½å±‰æ¸²æŸ“ï¼šå…ˆç”¨å…¨å±€ lastData å…œåº•å±•ç¤ºï¼Œæ‹‰å–å®Œæˆåè‡ªåŠ¨åˆ·æ–°ä¸ºå›½å®¶å£å¾„ï¼ˆä»…åˆ·æ–°å³ä¾§ï¼Œä¸é‡ç»˜å·¦ä¾§ï¼‰
            try {
                const cc = ccUpper;
                const isGlobalView = typeof currentViewState === 'string' && currentViewState === 'GLOBAL';
                // ã€ä¿®å¤ã€‘åœ¨ global è§†å›¾æ—¶ï¼Œå¿…é¡»è·å–å›½å®¶æ•°æ®ï¼Œç¡®ä¿å¡ç‰‡æ˜¾ç¤ºçš„æ˜¯å›½å®¶æ€»æ•°è€Œä¸æ˜¯å…¨çƒæ€»æ•°
                const shouldFetchSummary =
                    !summaryOnly &&
                    overrideRightData == null &&
                    cc.length === 2 &&
                    typeof fetchCountrySummaryV3 === 'function' &&
                    (isGlobalView || cachedSummary == null); // global è§†å›¾æˆ–æ²¡æœ‰ç¼“å­˜æ—¶éƒ½è¦è·å–
                if (shouldFetchSummary) {
                    // æ ‡è®°è¯·æ±‚è¿›è¡Œä¸­
                    window.__drawerFetchInProgress.set(cc, true);
                    fetchCountrySummaryV3(countryCode)
                        .then((summary) => {
                            window.__drawerFetchInProgress.delete(cc);
                            
                            // ã€ä¿®å¤ã€‘å¦‚æœå›½å®¶æ•°æ®ä¸ºç©ºæˆ–æ— æ•ˆï¼Œä¸”æ˜¯ Global è§†å›¾ï¼Œå°è¯• fallback åˆ° global-aggregate
                            if ((!summary || !summary.countryTotals || Object.keys(summary.countryTotals).length === 0) && isGlobalView) {
                                const baseEndpoint = window.API_ENDPOINT_MANAGER ? window.API_ENDPOINT_MANAGER.getCurrent() : (document.querySelector('meta[name="api-endpoint"]')?.content || '');
                                const base = baseEndpoint.endsWith('/') ? baseEndpoint.slice(0, -1) : baseEndpoint;
                                const url = `${base}/api/global-aggregate?_t=${Date.now()}`;
                                
                                return fetch(url, { headers: { 'Accept': 'application/json' }, mode: 'cors', credentials: 'omit' })
                                    .then(res => res.ok ? res.json() : null)
                                    .then(data => {
                                        if (data && data.success && typeof data === 'object') {
                                            return {
                                                ...summary,
                                                countryTotals: {
                                                    total_messages: Number(data.total_messages ?? data.ai ?? 0) || 0,
                                                    avg_user_message_length: Number(data.avg_user_message_length ?? data.word ?? 0) || 0,
                                                    work_days: Number(data.work_days ?? data.work_days_sum ?? data.day ?? 0) || 0,
                                                    jiafang_count: Number(data.jiafang_count ?? data.jiafang_count_sum ?? data.no ?? 0) || 0,
                                                    total_chars: Number(data.total_chars ?? data.say ?? 0) || 0,
                                                    ketao_count: Number(data.ketao_count ?? data.ketao_count_sum ?? data.please ?? 0) || 0,
                                                    ai: Number(data.ai ?? data.totalanalysis ?? data.totalAnalysis ?? data.total_messages ?? 0) || 0,
                                                    word: Number(data.word ?? data.avg_user_message_length ?? 0) || 0,
                                                    day: Number(data.day ?? data.work_days ?? data.work_days_sum ?? 0) || 0,
                                                    no: Number(data.no ?? data.jiafang_count ?? data.jiafang_count_sum ?? 0) || 0,
                                                    say: Number(data.say ?? data.total_chars ?? 0) || 0,
                                                    please: Number(data.please ?? data.ketao_count ?? data.ketao_count_sum ?? 0) || 0,
                                                }
                                            };
                                        }
                                        return summary || {};
                                    })
                                    .catch(() => summary || {});
                            }
                            
                            if (!summary || typeof summary !== 'object') {
                                // å¦‚æœæ•°æ®ä¸ºç©ºï¼Œæ¸…é™¤åŠ è½½çŠ¶æ€ï¼Œé¿å…ä¸€ç›´"è®¡ç®—ä¸­"
                                if (currentDrawerCountry && String(currentDrawerCountry.code || '').toUpperCase() === cc) {
                                    showDrawersWithCountryData(cc, countryName, { countryTotals: {} }, { summaryOnly: true });
                                }
                                return;
                            }
                            try { window.__countrySummaryCache.set(cc, { summary, ts: Date.now() }); } catch { /* ignore */ }
                            if (!currentDrawerCountry || String(currentDrawerCountry.code || '').toUpperCase() !== cc) return;
                            // å…³é”®ä¿æŠ¤ï¼šè‹¥å½“å‰å¤„äºå›½å®¶é€è§†ï¼ˆCOUNTRYï¼‰æ¨¡å¼ï¼Œä¸å…è®¸è¿™æ¡â€œå…¨çƒæµé¢æ¿â€çš„åˆ·æ–°è¦†ç›–å³æŠ½å±‰
                            if (typeof currentViewState === 'string' && currentViewState === 'COUNTRY') return;
                            // ä»…åˆ·æ–°å³ä¾§æŠ½å±‰æ•°æ®ï¼Œä¸é‡è®¾éª¨æ¶ã€ä¸é‡å»ºå·¦ä¾§ï¼Œé¿å…åå¤å åŠ ä¸é”™ä¹±
                            showDrawersWithCountryData(cc, countryName, summary, { summaryOnly: true });
                        })
                        .catch(() => {
                            // æ¸…é™¤è¯·æ±‚æ ‡è®°ï¼ˆå³ä½¿å¤±è´¥ä¹Ÿè¦æ¸…é™¤ï¼‰
                            window.__drawerFetchInProgress.delete(cc);
                            
                            // ã€ä¿®å¤ã€‘å¤±è´¥æ—¶ï¼Œå¦‚æœæ˜¯ Global è§†å›¾ï¼Œå°è¯• fallback åˆ° global-aggregate
                            if (isGlobalView) {
                                const baseEndpoint = window.API_ENDPOINT_MANAGER ? window.API_ENDPOINT_MANAGER.getCurrent() : (document.querySelector('meta[name="api-endpoint"]')?.content || '');
                                const base = baseEndpoint.endsWith('/') ? baseEndpoint.slice(0, -1) : baseEndpoint;
                                const url = `${base}/api/global-aggregate?_t=${Date.now()}`;
                                
                                fetch(url, { headers: { 'Accept': 'application/json' }, mode: 'cors', credentials: 'omit' })
                                    .then(res => res.ok ? res.json() : null)
                                    .then(data => {
                                        if (data && data.success && typeof data === 'object') {
                                            const globalData = {
                                                countryTotals: {
                                                    total_messages: Number(data.total_messages ?? data.ai ?? 0) || 0,
                                                    avg_user_message_length: Number(data.avg_user_message_length ?? data.word ?? 0) || 0,
                                                    work_days: Number(data.work_days ?? data.work_days_sum ?? data.day ?? 0) || 0,
                                                    jiafang_count: Number(data.jiafang_count ?? data.jiafang_count_sum ?? data.no ?? 0) || 0,
                                                    total_chars: Number(data.total_chars ?? data.say ?? 0) || 0,
                                                    ketao_count: Number(data.ketao_count ?? data.ketao_count_sum ?? data.please ?? 0) || 0,
                                                    ai: Number(data.ai ?? data.totalanalysis ?? data.totalAnalysis ?? data.total_messages ?? 0) || 0,
                                                    word: Number(data.word ?? data.avg_user_message_length ?? 0) || 0,
                                                    day: Number(data.day ?? data.work_days ?? data.work_days_sum ?? 0) || 0,
                                                    no: Number(data.no ?? data.jiafang_count ?? data.jiafang_count_sum ?? 0) || 0,
                                                    say: Number(data.say ?? data.total_chars ?? 0) || 0,
                                                    please: Number(data.please ?? data.ketao_count ?? data.ketao_count_sum ?? 0) || 0,
                                                }
                                            };
                                            if (currentDrawerCountry && String(currentDrawerCountry.code || '').toUpperCase() === cc) {
                                                showDrawersWithCountryData(cc, countryName, globalData, { summaryOnly: true });
                                            }
                                        } else {
                                            // å³ä½¿ fallback ä¹Ÿå¤±è´¥ï¼Œä¹Ÿè¦æ¸…é™¤åŠ è½½çŠ¶æ€ï¼Œæ˜¾ç¤ºç©ºæ•°æ®è€Œä¸æ˜¯ä¸€ç›´"è®¡ç®—ä¸­"
                                            if (currentDrawerCountry && String(currentDrawerCountry.code || '').toUpperCase() === cc) {
                                                showDrawersWithCountryData(cc, countryName, { countryTotals: {} }, { summaryOnly: true });
                                            }
                                        }
                                    })
                                    .catch(() => {
                                        // æœ€ç»ˆå¤±è´¥ï¼Œæ¸…é™¤åŠ è½½çŠ¶æ€
                                        if (currentDrawerCountry && String(currentDrawerCountry.code || '').toUpperCase() === cc) {
                                            showDrawersWithCountryData(cc, countryName, { countryTotals: {} }, { summaryOnly: true });
                                        }
                                    });
                            } else {
                                // é Global è§†å›¾ï¼Œç›´æ¥æ¸…é™¤åŠ è½½çŠ¶æ€
                                if (currentDrawerCountry && String(currentDrawerCountry.code || '').toUpperCase() === cc) {
                                    showDrawersWithCountryData(cc, countryName, { countryTotals: {} }, { summaryOnly: true });
                                }
                            }
                        });
                }
            } catch (e) {
                // ignore
            }

            // å®šä¹‰ç»´åº¦é…ç½®ï¼ˆåç§°/å•ä½éšè¯­è¨€åˆ‡æ¢ï¼‰
            const dimensionConfig = {
                ai: { name: translateDimensionName('ai'), icon: DIMENSION_NAME_I18N.ai?.icon || 'ğŸ’¬', suffix: translateDimensionSuffix('ai') },
                word: { name: translateDimensionName('word'), icon: DIMENSION_NAME_I18N.word?.icon || 'ğŸ“', suffix: translateDimensionSuffix('word') },
                day: { name: translateDimensionName('day'), icon: DIMENSION_NAME_I18N.day?.icon || 'ğŸ“…', suffix: translateDimensionSuffix('day') },
                no: { name: translateDimensionName('no'), icon: DIMENSION_NAME_I18N.no?.icon || 'ğŸš«', suffix: translateDimensionSuffix('no') },
                say: { name: translateDimensionName('say'), icon: DIMENSION_NAME_I18N.say?.icon || 'ğŸ’­', suffix: translateDimensionSuffix('say') },
                please: { name: translateDimensionName('please'), icon: DIMENSION_NAME_I18N.please?.icon || 'ğŸ™', suffix: translateDimensionSuffix('please') }
            };

            // å®šä¹‰å·¦å³æŠ½å±‰çš„ç»´åº¦åˆ†é…
            // å·¦è¾¹æŠ½å±‰ï¼šuser_identity_config å¡ç‰‡
            // å³è¾¹æŠ½å±‰ï¼šæ‰€æœ‰ç»´åº¦å¡ç‰‡ï¼ˆai, word, day, no, say, pleaseï¼‰
            const leftDrawerDimensions = []; // å·¦è¾¹åªæ˜¾ç¤º user_identity_config
            const rightDrawerDimensions = ['ai', 'word', 'day', 'no', 'say', 'please']; // æ‰€æœ‰ç»´åº¦å¡ç‰‡

            // è·å–å½“å‰ç”¨æˆ·æ•°æ®ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºå…¨çƒæœ€å¼ºæ¨¡å¼ï¼‰
            let currentUser = null;
            if (summaryOnly) {
                currentUser = window.currentUser || null;
                if (!currentUser && Array.isArray(window.allData) && window.allData.length > 0) {
                    const norm = (fp) => String(fp || '').trim().toLowerCase();
                    const localFp = (localStorage.getItem('user_fingerprint') || '').trim();
                    const localGh = (localStorage.getItem('github_username') || '').trim();
                    currentUser = window.allData.find(item => {
                        const ifp = norm(item.fingerprint || item.user_fingerprint);
                        const iid = norm(item.user_identity);
                        return (ifp && (ifp === norm(localFp) || iid === norm(localFp))) || (iid && iid === norm(localFp)) || (localGh && norm(String(item.github_username || item.user_name || '')) === norm(localGh));
                    }) || null;
                }
            } else {
            try {
                // æ–¹æ³•1: ä»å…¨å±€å˜é‡è·å–
                if (window.currentUser) {
                    currentUser = window.currentUser;
                    console.log('[Drawer] âœ… ä»å…¨å±€å˜é‡è·å–åˆ°ç”¨æˆ·æ•°æ®:', currentUser.user_name || currentUser.name);
                } else {
                    // æ–¹æ³•2: ä» localStorage å’Œ URL å‚æ•°è·å–ï¼Œä¸ renderRankCards é€»è¾‘ä¸€è‡´
                    // è¾…åŠ©å‡½æ•°ï¼šè§„èŒƒåŒ–æŒ‡çº¹å­—ç¬¦ä¸²ï¼ˆå¿½ç•¥å¤§å°å†™å¹¶å‰”é™¤é¦–å°¾ç©ºæ ¼ï¼‰
                    const normalizeFingerprint = (fp) => {
                        if (!fp) return '';
                        return String(fp).trim().toLowerCase();
                    };
                    
                    let localGitHubName = null;
                    let currentFingerprint = null;
                    try {
                        localGitHubName = localStorage.getItem('github_username');
                        currentFingerprint = localStorage.getItem('user_fingerprint');
                        console.log('[Drawer] ğŸ” ä» localStorage è¯»å–:', {
                            hasFingerprint: !!currentFingerprint,
                            fingerprintPrefix: currentFingerprint ? currentFingerprint.substring(0, 8) : null,
                            hasGitHub: !!localGitHubName
                        });
                    } catch (e) {
                        console.warn('[Drawer] âš ï¸ è¯»å– localStorage å¤±è´¥:', e);
                    }
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlFingerprint = urlParams.get('fingerprint');
                    const urlGitHubName = urlParams.get('github');
                    
                    // è§„èŒƒåŒ–å½“å‰æŒ‡çº¹
                    const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                    const normalizedUrlFingerprint = normalizeFingerprint(urlFingerprint);
                    
                    // æŸ¥æ‰¾åŒ¹é…çš„ç”¨æˆ·æ•°æ®ï¼ˆä¼˜å…ˆçº§ï¼šæŒ‡çº¹ä¼˜å…ˆ > GitHub IDï¼‰
                    let allData = window.allData || [];
                    console.log('[Drawer] ğŸ“Š allData æ•°æ®é‡:', allData.length);
                    
                    // å¦‚æœ allData ä¸ºç©ºæˆ–å¾ˆå°‘ï¼Œå°è¯•é‡æ–°è·å–æ•°æ®
                    if (allData.length === 0 && normalizedCurrentFingerprint) {
                        console.log('[Drawer] âš ï¸ allData ä¸ºç©ºï¼Œå°è¯•é‡æ–°è·å–æ•°æ®...');
                        // å¼‚æ­¥é‡æ–°è·å–æ•°æ®ï¼ˆä¸é˜»å¡æŠ½å±‰æ˜¾ç¤ºï¼‰
                        fetchData().then(() => {
                            allData = window.allData || [];
                            console.log('[Drawer] âœ… é‡æ–°è·å–æ•°æ®å®Œæˆï¼ŒallData æ•°æ®é‡:', allData.length);
                            
                            // é‡æ–°å°è¯•åŒ¹é…ç”¨æˆ·
                            const matchedUser = allData.find(item => {
                                const itemFingerprint = normalizeFingerprint(item.fingerprint || item.user_fingerprint);
                                const itemIdentity = normalizeFingerprint(item.user_identity);
                                return (itemFingerprint && itemFingerprint === normalizedCurrentFingerprint) ||
                                       (itemIdentity && itemIdentity === normalizedCurrentFingerprint);
                            });
                            
                            if (matchedUser) {
                                console.log('[Drawer] âœ… é‡æ–°åŒ¹é…åˆ°ç”¨æˆ·:', matchedUser.user_name || matchedUser.name);
                                // æ›´æ–°å…¨å±€å˜é‡
                                window.currentUser = matchedUser;
                                // é‡æ–°æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
                                const leftBody = document.getElementById('left-drawer-body');
                                if (leftBody) {
                                    renderUserStatsCards(leftBody, matchedUser);
                                }
                            }
                        }).catch(err => {
                            console.error('[Drawer] âŒ é‡æ–°è·å–æ•°æ®å¤±è´¥:', err);
                        });
                    }

                    // âœ… GitHub å…œåº•ï¼šå¦‚æœ allData ä¸ºç©ºä½†æœ¬æœºæœ‰ GitHub IDï¼Œä¹Ÿåº”å°è¯• fetchData() å†åŒ¹é…
                    if (allData.length === 0 && !currentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                        console.log('[Drawer] âš ï¸ allData ä¸ºç©ºï¼ˆGitHub ç”¨æˆ·ï¼‰ï¼Œå°è¯•é‡æ–°è·å–æ•°æ®...');
                        fetchData().then(() => {
                            allData = window.allData || [];
                            console.log('[Drawer] âœ… é‡æ–°è·å–æ•°æ®å®Œæˆï¼ˆGitHub å…œåº•ï¼‰ï¼ŒallData æ•°æ®é‡:', allData.length);

                            const normalizedLocalGitHub = normalizeFingerprint(localGitHubName);
                            const normalizedUrlGitHub = normalizeFingerprint(urlGitHubName);
                            const matchedUser = allData.find(item => {
                                const itemGitHub = normalizeFingerprint(item.github_username || item.github_id || item.user_name || item.name);
                                return itemGitHub && (itemGitHub === normalizedLocalGitHub || itemGitHub === normalizedUrlGitHub);
                            });

                            if (matchedUser) {
                                console.log('[Drawer] âœ… é‡æ–°åŒ¹é…åˆ° GitHub ç”¨æˆ·:', matchedUser.user_name || matchedUser.name);
                                window.currentUser = matchedUser;
                                const leftBody = document.getElementById('left-drawer-body');
                                if (leftBody) {
                                    renderUserStatsCards(leftBody, getBestUserRecordForStats(matchedUser));
                                }
                                return;
                            }

                            // äºŒçº§å…œåº•ï¼šç›´æ¥ä» Supabase æŸ¥è¯¢ GitHub ç”¨æˆ·ï¼ˆé¿å…ä¸åœ¨ latestRecords æ—¶ä¸€ç›´ WAITï¼‰
                            try {
                                if (typeof supabaseClient !== 'undefined' && supabaseClient && typeof supabaseClient.from === 'function') {
                                    supabaseClient
                                        .from('v_user_analysis_extended')
                                        .select('*')
                                        // GitHub ç”¨æˆ·åå¤§å°å†™ä¸æ•æ„Ÿï¼šé¿å… user_name å¤§å°å†™ä¸ä¸€è‡´å¯¼è‡´æŸ¥ä¸åˆ°
                                        .ilike('user_name', String(localGitHubName).trim())
                                        .maybeSingle()
                                        .then(({ data: dbUser }) => {
                                            if (!dbUser) return;
                                            console.log('[Drawer] âœ… Supabase å…œåº•æ‰¾åˆ° GitHub ç”¨æˆ·:', dbUser.user_name || dbUser.name);
                                            window.currentUser = dbUser;
                                            const leftBody2 = document.getElementById('left-drawer-body');
                                            if (leftBody2) {
                                                renderUserStatsCards(leftBody2, getBestUserRecordForStats(dbUser));
                                            }
                                        })
                                        .catch(() => {});
                                }
                            } catch (e) { /* ignore */ }
                        }).catch(err => {
                            console.error('[Drawer] âŒ é‡æ–°è·å–æ•°æ®å¤±è´¥ï¼ˆGitHub å…œåº•ï¼‰:', err);
                        });
                    }
                    
                    // ä¼˜å…ˆé€šè¿‡æŒ‡çº¹åŒ¹é…
                    if (normalizedCurrentFingerprint || normalizedUrlFingerprint) {
                        console.log('[Drawer] ğŸ” å¼€å§‹æŒ‡çº¹åŒ¹é…ï¼Œç›®æ ‡æŒ‡çº¹:', normalizedCurrentFingerprint || normalizedUrlFingerprint);
                        currentUser = allData.find(item => {
                            const itemFingerprint = normalizeFingerprint(item.fingerprint || item.user_fingerprint);
                            const itemIdentity = normalizeFingerprint(item.user_identity);
                            
                            const matchFingerprint = itemFingerprint && (itemFingerprint === normalizedCurrentFingerprint || itemFingerprint === normalizedUrlFingerprint);
                            const matchIdentity = itemIdentity && (itemIdentity === normalizedCurrentFingerprint || itemIdentity === normalizedUrlFingerprint);
                            
                            if (matchFingerprint || matchIdentity) {
                                console.log('[Drawer] âœ… æŒ‡çº¹åŒ¹é…æˆåŠŸ:', {
                                    itemFingerprint: itemFingerprint ? itemFingerprint.substring(0, 8) : null,
                                    itemIdentity: itemIdentity ? itemIdentity.substring(0, 8) : null,
                                    userName: item.user_name || item.name
                                });
                            }
                            
                            return matchFingerprint || matchIdentity;
                        });
                        
                        if (!currentUser) {
                            console.log('[Drawer] âš ï¸ æŒ‡çº¹åŒ¹é…å¤±è´¥ï¼ŒallData ä¸­çš„æŒ‡çº¹æ ·æœ¬:', 
                                allData.slice(0, 3).map(item => ({
                                    fingerprint: item.fingerprint ? item.fingerprint.substring(0, 8) : null,
                                    user_identity: item.user_identity ? item.user_identity.substring(0, 8) : null,
                                    user_name: item.user_name || item.name
                                }))
                            );
                        }
                    }
                    
                    // å¦‚æœæŒ‡çº¹æœªåŒ¹é…ï¼Œå†é€€è€Œæ±‚å…¶æ¬¡å¯»æ‰¾ github_username
                    if (!currentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                        console.log('[Drawer] ğŸ” å¼€å§‹ GitHub ID åŒ¹é…:', localGitHubName);
                        const normalizedLocalGitHub = normalizeFingerprint(localGitHubName);
                        const normalizedUrlGitHub = normalizeFingerprint(urlGitHubName);
                        
                        currentUser = allData.find(item => {
                            const itemGitHub = normalizeFingerprint(item.github_username || item.user_name || item.name);
                            return itemGitHub && (itemGitHub === normalizedLocalGitHub || itemGitHub === normalizedUrlGitHub);
                        });
                        
                        if (currentUser) {
                            console.log('[Drawer] âœ… é€šè¿‡ GitHub ID æ‰¾åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                        }
                    }

                    // âœ… æœ€ç»ˆå…œåº•ï¼šallData é‡Œæ²¡æœ‰ä½†æœ¬æœºæœ‰ GitHub ID æ—¶ï¼Œç›´æ¥æŸ¥ç»Ÿä¸€è§†å›¾
                    if (!currentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                        try {
                            if (typeof supabaseClient !== 'undefined' && supabaseClient && typeof supabaseClient.from === 'function') {
                                supabaseClient
                                    .from('v_user_analysis_extended')
                                    .select('*')
                                    // GitHub ç”¨æˆ·åå¤§å°å†™ä¸æ•æ„Ÿï¼šé¿å… user_name å¤§å°å†™ä¸ä¸€è‡´å¯¼è‡´æŸ¥ä¸åˆ°
                                    .ilike('user_name', String(localGitHubName).trim())
                                    .maybeSingle()
                                    .then(({ data: dbUser }) => {
                                        if (!dbUser) return;
                                        console.log('[Drawer] âœ… Supabase æœ€ç»ˆå…œåº•æ‰¾åˆ° GitHub ç”¨æˆ·:', dbUser.user_name || dbUser.name);
                                        window.currentUser = dbUser;
                                        const leftBody = document.getElementById('left-drawer-body');
                                        if (leftBody) {
                                            renderUserStatsCards(leftBody, getBestUserRecordForStats(dbUser));
                                        }
                                    })
                                    .catch(() => {});
                            }
                        } catch (e) { /* ignore */ }
                    }
                }
            } catch (e) {
                console.error('[Drawer] âŒ è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', e);
            }
            
            const isGlobalTopMode = (typeof currentUser !== 'undefined') ? !currentUser : (typeof window.isGlobalTopMode !== 'undefined' ? window.isGlobalTopMode : false);
            window.isGlobalTopMode = isGlobalTopMode;
            var drawerCurrentUser = (typeof currentUser !== 'undefined' && currentUser != null) ? currentUser : null;
            if (!drawerCurrentUser && !summaryOnly && leftBody) {
                try { leftBody.classList.remove('drawer-loading'); } catch (_) {}
            }
            if (!currentUser) {
                console.log('[Drawer] âš ï¸ æœªæ‰¾åˆ°å½“å‰ç”¨æˆ·æ•°æ®ï¼Œå°†æ˜¾ç¤ºå…¨çƒæœ€å¼ºæ¨¡å¼');
            } else {
                console.log('[Drawer] âœ… æ‰¾åˆ°å½“å‰ç”¨æˆ·æ•°æ®ï¼Œå°†æ˜¾ç¤ºä¸ªäººç»Ÿè®¡:', drawerCurrentUser?.user_name || drawerCurrentUser?.name);
            }

            // å¡«å……å·¦ä¾§æŠ½å±‰ - user_identity_config å¡ç‰‡
            if (leftBody) {
                // è·å– GitHub ç”¨æˆ·åå’ŒæŒ‡çº¹ï¼ˆå¢åŠ å¼‚å¸¸å¤„ç†ï¼‰
                let githubUsername = '';
                let currentFingerprint = null;
                try {
                    githubUsername = localStorage.getItem('github_username') || '';
                    currentFingerprint = localStorage.getItem('user_fingerprint');
                } catch (e) {
                    console.warn('[Drawer] âš ï¸ è¯»å– localStorage å¤±è´¥:', e);
                }
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºçº¯æŒ‡çº¹ç”¨æˆ·ï¼ˆæ—  GitHub IDï¼‰
                // ã€Task 3ã€‘ä¼ å…¥ user_identity å‚æ•°ï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                const userIdentity = currentUser?.user_identity || null;
                const isFingerprintOnlyUser = !githubUsername || !isValidGitHubUsername(githubUsername, userIdentity);
                const fingerprintPrefix = currentFingerprint ? currentFingerprint.substring(0, 6).toUpperCase() : '';
                
                // ç¡®å®šæ˜¾ç¤ºçš„ç”¨æˆ·åå’Œå¤´åƒ
                let displayName = '';
                let displayLabel = '';
                let avatarUrl = DEFAULT_AVATAR;
                
                if (isFingerprintOnlyUser && currentFingerprint) {
                    // çº¯æŒ‡çº¹ç”¨æˆ·ï¼šæ˜¾ç¤º"åŒ¿åä¸“å®¶ [æŒ‡çº¹å‰6ä½]"
                    displayName = `åŒ¿åä¸“å®¶ ${fingerprintPrefix}`;
                    displayLabel = 'è®¾å¤‡æŒ‡çº¹';
                    // ä½¿ç”¨åŸºäºæŒ‡çº¹çš„ Identicon
                    avatarUrl = `https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(currentFingerprint)}`;
                } else if (githubUsername && isValidGitHubUsername(githubUsername, userIdentity)) {
                    // æœ‰ GitHub ID çš„ç”¨æˆ·
                    displayName = githubUsername;
                    displayLabel = 'GitHub ID';
                    avatarUrl = getGitHubAvatarUrl(githubUsername);
                } else {
                    // é»˜è®¤çŠ¶æ€
                    displayName = 'æœªè®¾ç½®';
                    displayLabel = 'GitHub ID';
                    avatarUrl = DEFAULT_AVATAR;
                }

                // å·¦ä¾§æŠ½å±‰æ ‡é¢˜ï¼šå§‹ç»ˆæ˜¾ç¤ºâ€œå½“å‰ç”¨æˆ·â€ï¼Œé¿å…åœ°å›¾ç‚¹å‡»åå·¦ä¾§çœ‹èµ·æ¥åƒä¸¢äº†ä¸ªäººæ•°æ®
                try {
                    if (leftTitle) leftTitle.textContent = displayName || 'æˆ‘çš„æ•°æ®';
                } catch (e) { /* ignore */ }
                
                // èµ›åšç—…ç†å‹‹ç« ï¼šç—…å…¥è†è‚“(>=500) / ç—…æƒ…å¯æ§(<10)
                const totalMsgsForBadge = Number(currentUser?.total_messages ?? currentUser?.totalMessages ?? 0) || 0;
                const badgeHtml = totalMsgsForBadge >= 500
                    ? `<span class="inline-flex items-center ml-1 animate-pulse" style="filter: drop-shadow(0 0 5px rgba(255,0,0,0.6));" title="ç—…å…¥è†è‚“">ğŸ†</span>`
                    : (totalMsgsForBadge < 10 && totalMsgsForBadge > 0)
                        ? `<span class="inline-flex items-center ml-1 text-[#00ff41]/50" title="ç—…æƒ…å¯æ§">ğŸŒ±</span>`
                        : '';
                
                // è·å–å½“å‰çŠ¶æ€
                const currentStatus = localStorage.getItem('user_status') || 'idle';
                const statusConfig = USER_STATUSES[currentStatus] || USER_STATUSES.idle;
                
                // åˆ›å»º user_identity_config å¡ç‰‡
                const identityCard = document.createElement('div');
                identityCard.className = 'drawer-item';
                identityCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">ğŸ•¶ï¸</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                            ${escapeHtml(getI18nText('badge.config') || 'CONFIG')}
                        </span>
                    </div>
                    
                    <div class="drawer-item-label mb-2">ç”¨æˆ·èº«ä»½é…ç½®</div>
                    
                    <!-- ç”¨æˆ·ä¿¡æ¯ï¼ˆGitHub æˆ–æŒ‡çº¹ï¼‰ -->
                    <div class="mb-3 pb-3 border-b border-[#00ff41]/10">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full overflow-hidden border border-[#00ff41]/30 flex-shrink-0">
                                <img 
                                    src="${avatarUrl}" 
                                    alt="Avatar" 
                                    class="w-full h-full object-cover"
                                    onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                />
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="drawer-item-value text-sm truncate flex items-center">${displayName}${badgeHtml}</div>
                                <div class="drawer-item-desc text-[8px]">${displayLabel}</div>
                            </div>
                            <button 
                                onclick="typeof openInboxDrawer === 'function' && openInboxDrawer()"
                                class="inbox-indicator w-9 h-9 flex items-center justify-center bg-transparent border-none text-[#00ff41] hover:text-[#00ff41]/80 transition-colors flex-shrink-0 cursor-pointer p-0 relative"
                                title="${currentLang === 'zh' ? 'æ”¶ä»¶ç®±' : 'Inbox'}"
                            >âœ‰</button>
                            ${githubUsername && isValidGitHubUsername(githubUsername, userIdentity)
                                ? `
                                <button 
                                    onclick="logout()"
                                    class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-[8px] text-zinc-300 hover:text-white transition-colors rounded"
                                    title="é€€å‡ºç™»å½•"
                                >
                                    é€€å‡º
                                </button>
                                `
                                : ''
                            }
                        </div>
                        <!-- ç”¨æˆ·å›½å®¶/åœ°åŒºï¼šå›½æ—— + è‡ªåŠ¨è¯†åˆ« / ç”¨æˆ·æ ¡å‡† -->
                        <div id="user-country-flag" class="flex items-center gap-2 mt-2 text-[10px]"></div>
                        ${githubUsername && isValidGitHubUsername(githubUsername, userIdentity)
                            ? `
                            <a 
                                href="https://github.com/${githubUsername}" 
                                target="_blank"
                                rel="noopener noreferrer"
                                class="mt-2 inline-block text-[9px] text-[#00ff41]/70 hover:text-[#00ff41] transition-colors font-mono"
                            >
                                github.com/${githubUsername}
                            </a>
                            `
                            : ''
                        }
                    </div>
                    
                    <!-- çŠ¶æ€åˆ‡æ¢æŒ‰é’®ï¼ˆç®€çº¦ï¼šä»…ç”¨é€‰ä¸­æ€è¡¨è¾¾å½“å‰çŠ¶æ€ï¼‰ -->
                    <div class="drawer-item-label mb-2">${currentLang === 'zh' ? 'çŠ¶æ€' : 'Status'}</div>
                    <div class="flex gap-1.5">
                        <button 
                            title="${(USER_STATUSES.idle && (currentLang === 'zh' ? USER_STATUSES.idle.descZh : USER_STATUSES.idle.descEn)) || ''}"
                            onclick="setUserStatus('idle'); if(currentDrawerCountry.code) showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);"
                            class="flex-1 px-2 py-1.5 bg-zinc-900/50 border ${currentStatus === 'idle' ? 'border-[#00ff41]' : 'border-zinc-800'} text-[10px] font-bold uppercase tracking-wider hover:border-[#00ff41] transition-colors"
                            style="color: ${currentStatus === 'idle' ? '#00ff41' : '#71717a'};"
                        >
                            ğŸŸ¢ ${currentLang === 'zh' ? 'åœ¨çº¿' : 'Online'}
                        </button>
                        <button 
                            title="${(USER_STATUSES.busy && (currentLang === 'zh' ? USER_STATUSES.busy.descZh : USER_STATUSES.busy.descEn)) || ''}"
                            onclick="setUserStatus('busy'); if(currentDrawerCountry.code) showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);"
                            class="flex-1 px-2 py-1.5 bg-zinc-900/50 border ${currentStatus === 'busy' ? 'border-[#ff8c00]' : 'border-zinc-800'} text-[10px] font-bold uppercase tracking-wider hover:border-[#ff8c00] transition-colors"
                            style="color: ${currentStatus === 'busy' ? '#ff8c00' : '#71717a'};"
                        >
                            ğŸŸ  ${currentLang === 'zh' ? 'å¿™ç¢Œ' : 'Busy'}
                        </button>
                        <button 
                            title="${(USER_STATUSES.sprint && (currentLang === 'zh' ? USER_STATUSES.sprint.descZh : USER_STATUSES.sprint.descEn)) || ''}"
                            onclick="setUserStatus('sprint'); if(currentDrawerCountry.code) showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);"
                            class="flex-1 px-2 py-1.5 bg-zinc-900/50 border ${currentStatus === 'sprint' ? 'border-[#71717a]' : 'border-zinc-800'} text-[10px] font-bold uppercase tracking-wider hover:border-[#71717a] transition-colors"
                            style="color: ${currentStatus === 'sprint' ? '#71717a' : '#71717a'};"
                        >
                            âš« ${currentLang === 'zh' ? 'ç¦»çº¿' : 'Offline'}
                        </button>
                    </div>
                    
                    <!-- GitHub OAuth ç™»å½•åŒºåŸŸ -->
                    <div class="mt-3 pt-3 border-t border-[#00ff41]/10" id="auth-login-section">
                        ${githubUsername && isValidGitHubUsername(githubUsername, userIdentity) 
                            ? ''
                            : `
                            <!-- æœªç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤º GitHub ç™»å½•æŒ‰é’® -->
                            <div class="drawer-item-label mb-2">GitHub ç™»å½•</div>
                            <button 
                                onclick="loginWithGitHub()"
                                class="w-full px-4 py-3 bg-[#24292e] hover:bg-[#2f363d] border border-[#444d56] rounded-md text-white text-sm font-semibold flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl"
                            >
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path>
                                </svg>
                                <span>ä½¿ç”¨ GitHub ç™»å½•</span>
                            </button>
                            <div class="text-[8px] text-[#00ff41]/40 mt-2 text-center">
                                å®‰å…¨ã€å¿«é€Ÿã€ä¸€é”®ç™»å½•
                            </div>
                            `
                        }
                    </div>
                `;
                
                // ç§»é™¤éª¨æ¶å±å¹¶æ·»åŠ æ¸å…¥åŠ¨ç”»
                if (leftBody) {
                    leftBody.classList.remove('drawer-loading');
                    const skeletons = leftBody.querySelectorAll('.drawer-skeleton-card');
                    skeletons.forEach(s => s.remove());
                }
                
                identityCard.classList.add('clinic-card');
                identityCard.style.opacity = '0';
                identityCard.style.transform = 'translateY(12px)';
                leftBody.appendChild(identityCard);
                
                // è§¦å‘æ¸å…¥åŠ¨ç”»
                requestAnimationFrame(() => {
                    identityCard.style.transition = 'opacity 0.35s ease-out, transform 0.35s ease-out';
                    identityCard.style.opacity = '1';
                    identityCard.style.transform = 'translateY(0)';
                });

                // å¡«å……ç”¨æˆ·å›½å®¶/åœ°åŒºï¼šä¼˜å…ˆä½¿ç”¨ä¸‹æ‹‰èœå•é€‰æ‹©çš„å›½å®¶
                if (typeof updateUserCountryFlag === 'function') {
                    let countryCode = '';
                    let countryName = '';
                    let isManual = false;

                    // ä¼˜å…ˆçº§ 1: ä¸‹æ‹‰èœå•é€‰æ‹©çš„å›½å®¶ï¼ˆuser_selected_countryï¼‰
                    const selectedCountry = localStorage.getItem('user_selected_country');
                    if (selectedCountry) {
                        countryCode = selectedCountry.toUpperCase();
                        if (countryNameMap[countryCode]) {
                            countryName = currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en;
                        } else {
                            countryName = countryCode;
                        }
                        isManual = true; // ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©çš„å›½å®¶è§†ä¸ºç”¨æˆ·æ ¡å‡†
                    }

                    // ä¼˜å…ˆçº§ 2: localStorage ä¸­çš„æ‰‹åŠ¨æ ¡å‡†ä¿¡æ¯ï¼ˆæ—§é€»è¾‘ï¼Œå…¼å®¹æ€§ä¿ç•™ï¼‰
                    if (!countryCode && localStorage.getItem('loc_fixed') === 'true' && localStorage.getItem('loc_locked') === 'true') {
                        countryCode = localStorage.getItem('manual_location') || '';
                        if (countryCode) {
                            countryCode = countryCode.toUpperCase();
                            if (countryNameMap[countryCode]) {
                                countryName = currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en;
                            } else {
                                countryName = countryCode;
                            }
                            isManual = true;
                        }
                    }

                    // ä¼˜å…ˆçº§ 3: currentUser ä¸­çš„æ‰‹åŠ¨æ ¡å‡†ä¿¡æ¯
                    if (!countryCode && currentUser) {
                        countryCode = currentUser.manual_location || '';
                        if (countryCode) {
                            countryCode = countryCode.toUpperCase();
                            if (countryNameMap[countryCode]) {
                                countryName = currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en;
                            } else {
                                countryName = countryCode;
                            }
                            isManual = true;
                        }
                    }

                    // ä¼˜å…ˆçº§ 4: currentUser ä¸­çš„å›½å®¶ä»£ç ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼‰
                    if (!countryCode && currentUser) {
                        countryCode = currentUser.country_code || currentUser.ip_location || '';
                        if (countryCode) {
                            countryCode = countryCode.toUpperCase();
                            if (countryNameMap[countryCode]) {
                                countryName = currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en;
                            } else {
                                countryName = countryCode;
                            }
                            isManual = !!(currentUser.manual_location || currentUser.manual_lat != null);
                        }
                    }

                    if (countryCode) {
                        updateUserCountryFlag(countryCode, countryName, isManual);
                    }
                }

                // æ·»åŠ å®æ—¶è¯Šæ–­æ´»åŠ¨å¡ç‰‡ï¼ˆå¸¦æ¸å…¥åŠ¨ç”»ï¼‰
                const activityCard = document.createElement('div');
                activityCard.className = 'drawer-item clinic-card';
                activityCard.style.opacity = '0';
                activityCard.style.transform = 'translateY(12px)';
                activityCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">ğŸ“¡</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                            ${escapeHtml(getI18nText('badge.live') || 'LIVE')}
                        </span>
                    </div>
                    <div class="drawer-item-label mb-3">${escapeHtml((i18n[currentLang] && i18n[currentLang]['recent-activity']) ? i18n[currentLang]['recent-activity'] : (currentLang === 'en' ? 'Live Activity Feed' : 'å®æ—¶è¯Šæ–­æ´»åŠ¨'))}</div>
                    <div id="drawer-recentActivity" class="flex-1 overflow-y-auto max-h-[400px] text-[10px] font-mono space-y-3 pr-2"></div>
                `;
                leftBody.appendChild(activityCard);
                
                // è§¦å‘æ¸å…¥åŠ¨ç”»
                requestAnimationFrame(() => {
                    activityCard.style.transition = 'opacity 0.35s ease-out, transform 0.35s ease-out';
                    activityCard.style.opacity = '1';
                    activityCard.style.transform = 'translateY(0)';
                });
                
                // æ¸²æŸ“å®æ—¶è¯Šæ–­æ´»åŠ¨
                const data = window.lastData || {};
                const activityData = data.latestRecords || data.recentVictims || [];
                const drawerActivityList = document.getElementById('drawer-recentActivity');
                if (drawerActivityList) {
                    if (activityData.length === 0) {
                        drawerActivityList.innerHTML = `<div class="text-zinc-500 text-center py-4 text-[10px]">${escapeHtml(getI18nText('common.no_data') || (currentLang === 'en' ? 'No data' : 'æš‚æ— æ•°æ®'))}</div>`;
                    } else {
                        drawerActivityList.innerHTML = activityData.map((v, index) => {
                            const time = v.time || v.created_at || new Date().toISOString();
                            const type = v.type || v.personality_type || 'UNKNOWN';
                            const location = v.location || v.ip_location || (currentLang === 'en' ? 'Unknown' : 'æœªçŸ¥');
                            const name = v.name || (currentLang === 'en' ? `Record ${index + 1}` : `è®°å½•${index + 1}`);
                            
                            const avatarUrl = v.avatar_url || null;
                            // æ´»è·ƒèŠ‚ç‚¹ï¼šä¼˜å…ˆ github_usernameï¼Œæ— åˆ™ç”¨ user_nameï¼ˆCloudflare ä¸Š API å¯èƒ½åªè¿”å› user_nameï¼‰
                            const githubUsername = v.github_username || v.user_name || null;
                            
                            // ã€ä¿®å¤ã€‘å°† recordUserIdentity å®šä¹‰ç§»åˆ° if å—å¤–ï¼Œç¡®ä¿åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½èƒ½è®¿é—®
                            const recordUserIdentity = v.user_identity || null;
                            
                            let finalAvatarUrl = avatarUrl;
                            if (!finalAvatarUrl && githubUsername) {
                                // ã€Task 3ã€‘ä¼ å…¥ user_identityï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                                if (isValidGitHubUsername(githubUsername, recordUserIdentity)) {
                                    finalAvatarUrl = getGitHubAvatarUrl(githubUsername);
                                } else {
                                    finalAvatarUrl = DEFAULT_AVATAR;
                                }
                            }
                            if (!finalAvatarUrl) {
                                finalAvatarUrl = DEFAULT_AVATAR;
                            }
                            
                            const finalUsername = githubUsername || name;
                            // ã€ä¿®å¤ã€‘ä¼ å…¥ user_identityï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                            // åªä¼ æœ‰æ•ˆçš„ GitHub ç”¨æˆ·åï¼Œé¿å…"è®°å½•1"è¿™æ ·çš„å€¼è§¦å‘æ ¡éªŒè­¦å‘Š
                            const usernameForAvatar = githubUsername && isValidGitHubUsername(githubUsername, recordUserIdentity) 
                                ? githubUsername 
                                : null;
                            const avatarHtml = createAvatarHtml(finalAvatarUrl, usernameForAvatar, 24, recordUserIdentity);
                            
                            return `
                                <div class="border-l-2 border-[#00ff41]/20 pl-2 py-1.5 flex items-start gap-2">
                                    <div class="flex-shrink-0 mt-0.5">
                                        ${avatarHtml}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-zinc-500 text-[9px]">${new Date(time).toLocaleTimeString(currentLang === 'en' ? 'en-US' : 'zh-CN')}</div>
                                        <div class="text-white text-[10px] font-bold">${name.length > 8 ? name.slice(0,8) + '...' : name}</div>
                                        <div class="text-[#00ff41] text-[9px]">${type} @ ${location}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
                // ç§»é™¤å·¦ä¾§éª¨æ¶å±
                if (leftBody) {
                    leftBody.classList.remove('drawer-loading');
                    const skeletons = leftBody.querySelectorAll('.drawer-skeleton-card');
                    skeletons.forEach(s => s.remove());
                }
                
                // å¦‚æœæ£€æµ‹åˆ°å½“å‰ç”¨æˆ·æ•°æ®ï¼Œè‡ªåŠ¨åŠ è½½ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ï¼ˆä¼˜å…ˆä½¿ç”¨ allData ä¸­åŒäººçš„å®Œæ•´è®°å½•ï¼Œä»¥æ˜¾ç¤ºæäº¤èŠå¤©è®°å½•å¯¹åº”çš„æ•°å€¼ï¼‰
                if (currentUser) {
                    const userForStats = getBestUserRecordForStats(currentUser);
                    console.log('[Drawer] ğŸ“Š å¼€å§‹æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ï¼Œä½¿ç”¨', userForStats !== currentUser ? 'allData ä¸­çš„å®Œæ•´è®°å½•' : 'å½“å‰ç”¨æˆ·è®°å½•');
                    renderUserStatsCards(leftBody, userForStats);
                } else {
                    console.log('[Drawer] âš ï¸ æœªæ‰¾åˆ°ç”¨æˆ·æ•°æ®ï¼Œè·³è¿‡ç»Ÿè®¡å¡ç‰‡æ¸²æŸ“');
                    // å³ä½¿æ²¡æœ‰åŒ¹é…åˆ°ç”¨æˆ·ï¼Œå¦‚æœ localStorage ä¸­æœ‰ fingerprintï¼š
                    // - å…ˆå°è¯•ç›´æ¥ä» v_unified_analysis_v2 æŒ‰ fingerprint æ‹‰å–ï¼ˆé¿å…ä¸€ç›´ WAITï¼‰
                    // - å¤±è´¥åˆ™æœ‰é™æ¬¡æ•°é‡è¯•ï¼Œæœ€ç»ˆç»™å‡ºæ˜ç¡®æç¤ºï¼ˆé¿å…æ— é™â€œå¤„ç†ä¸­â€ï¼‰
                    try {
                        const currentFingerprint = localStorage.getItem('user_fingerprint');
                        const canQuerySupabase = (typeof supabaseClient !== 'undefined' && supabaseClient && typeof supabaseClient.from === 'function');
                        const attemptKey = '__drawerUserWaitAttempts';
                        const attempts = Number(window[attemptKey] || 0);

                        const showWaitCard = (mode = 'WAIT') => {
                            const waitingCard = document.createElement('div');
                            waitingCard.className = 'drawer-item';
                            waitingCard.innerHTML = `
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">â³</span>
                                    <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                                        ${mode}
                                    </span>
                                </div>
                                <div class="drawer-item-label mb-2">${escapeHtml(getI18nText('common.loading') || (currentLang === 'en' ? 'Loading...' : 'æ•°æ®åŠ è½½ä¸­'))}</div>
                                <div class="text-[10px] text-[#00ff41]/60">
                                    ${escapeHtml(attempts >= 6
                                        ? (currentLang === 'en'
                                            ? 'No cloud summary found yet. Upload once on index.html, then refresh this page.'
                                            : 'æš‚æœªæ‰¾åˆ°äº‘ç«¯æ±‡æ€»æ•°æ®ã€‚è¯·å…ˆåœ¨ index.html ä¸Šä¼ ä¸€æ¬¡èŠå¤©è®°å½•åå†åˆ·æ–°ã€‚')
                                        : (currentLang === 'en'
                                            ? 'Syncing cloud data...'
                                            : 'æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®ï¼Œè¯·ç¨å€™â€¦'))}
                                </div>
                                <div class="text-[8px] text-[#00ff41]/40 mt-2">
                                    ${escapeHtml(currentLang === 'en' ? 'Fingerprint' : 'æŒ‡çº¹')}: ${currentFingerprint ? currentFingerprint.substring(0, 8) : 'N/A'}...
                                </div>
                            `;
                            leftBody.appendChild(waitingCard);
                        };

                        const localGh = (localStorage.getItem('github_username') || '').trim();
                        const hasFingerprintOrGh = currentFingerprint || (localGh && /^[a-zA-Z0-9_-]+$/.test(localGh));

                        if (hasFingerprintOrGh) {
                            showWaitCard(attempts >= 6 ? 'EMPTY' : 'WAIT');

                            if (canQuerySupabase && attempts < 6) {
                                window[attemptKey] = attempts + 1;
                                const onUserFound = (dbUser) => {
                                    if (!dbUser) return;
                                    console.log('[Drawer] âœ… ä» v_unified_analysis_v2 æ‰¾åˆ°ç”¨æˆ·:', dbUser.user_name || dbUser.name);
                                    window.currentUser = dbUser;
                                    const lb = document.getElementById('left-drawer-body');
                                    if (lb) renderUserStatsCards(lb, getBestUserRecordForStats(dbUser));
                                };
                                // 1) æŒ‰ fingerprint æŸ¥ï¼ˆä½¿ç”¨ v_unified_analysis_v2 è·å– vibe_rankï¼‰
                                if (currentFingerprint) {
                                    supabaseClient
                                        .from('v_unified_analysis_v2')
                                        .select('*')
                                        .eq('fingerprint', currentFingerprint)
                                        .maybeSingle()
                                        .then(({ data: dbUser }) => onUserFound(dbUser))
                                        .catch(() => {});
                                }
                                // 2) æœªå‘½ä¸­æ—¶æŒ‰ GitHub ç”¨æˆ·åæŸ¥ï¼ˆå·²ä¸Šä¼ è¿‡ä¸”å·²ç™»å½•æ—¶ï¼Œå¯è·¨è®¾å¤‡çœ‹åˆ°æ•°æ®ï¼‰
                                if (localGh && !window.currentUser) {
                                    supabaseClient
                                        .from('v_unified_analysis_v2')
                                        .select('*')
                                        .ilike('user_name', localGh)
                                        .limit(1)
                                        .then(({ data: rows }) => {
                                            if (rows && rows[0]) onUserFound(rows[0]);
                                        })
                                        .catch(() => {});
                                }

                                const delayMs = 600 + attempts * 600;
                                setTimeout(() => {
                                    try {
                                        if (typeof fetchData === 'function') fetchData();
                                        if (currentDrawerCountry?.code) {
                                            showDrawersWithCountryData(currentDrawerCountry.code, currentDrawerCountry.name);
                                        }
                                    } catch { /* ignore */ }
                                }, delayMs);
                            }
                        }
                    } catch (e) {
                        console.warn('[Drawer] âš ï¸ æ˜¾ç¤º/é‡è¯•ç­‰å¾…å¡ç‰‡å¤±è´¥:', e);
                    }
                }
            }
            }

            // å¡«å……å³ä¾§æŠ½å±‰ - ç»´åº¦å¡ç‰‡å’Œç»Ÿè®¡å¡ç‰‡
            const rightCards = []; // æ”¶é›†æ‰€æœ‰å³ä¾§å¡ç‰‡ç”¨äºæ¸è¿›å¼æ¸²æŸ“
            // å‡çº§æ¸²æŸ“å¼•æ“ï¼šåœ¨æ‰€æœ‰ UI æ¸²æŸ“å’Œæ’åè®¡ç®—ä¹‹å‰å½’ä¸€åŒ–å­—æ®µï¼ˆtotal_messages_sum/totalAnalysis/ai -> ai ç­‰ï¼‰
            const normalizedData = normalizeStats(rightDrawerData);
            
            if (rightBody) {
                // å…ˆæ·»åŠ ç»´åº¦å¡ç‰‡ï¼ˆå³ä½¿æ²¡æœ‰ RANK_RESOURCES ä¹Ÿè¦æ˜¾ç¤ºï¼‰
                // ã€ä¿®å¤ã€‘åœ¨ global è§†å›¾æ—¶ï¼Œç»´åº¦å¡ç‰‡åº”æ˜¾ç¤ºå›½å®¶ç´¯åŠ å€¼ï¼Œè€Œä¸æ˜¯ä¸ªäººæ•°æ®
                const isGlobalViewForCards = typeof currentViewState === 'string' && currentViewState === 'GLOBAL';
                // ä½¿ç”¨å¤šçº§ Fallback æ˜ å°„ï¼ˆcountryTotals > root > countryStats[0]ï¼‰ï¼Œè¾“å‡ºå‰å¼ºåˆ¶æ•´æ•°é¿å…å°æ•°ç ´åå¸ƒå±€
                const source = getFinalStatsSource(normalizedData);
                const safeNum = (v) => Math.floor(Number(v) || 0);
                const safeWord = (v) => Number(v) || 0; // å¹³å‡é•¿åº¦å¯ä¿ç•™å°æ•°
                let countryTotalsForCards = {
                    ai: safeNum(source.ai),
                    say: safeNum(source.say),
                    day: safeNum(source.day),
                    word: safeWord(source.word),
                    no: safeNum(source.no),
                    please: safeNum(source.please)
                };
                
                // ã€ç§»é™¤è°ƒè¯•æ—¥å¿—ã€‘é¿å…æ§åˆ¶å°å™ªéŸ³ï¼Œä»…åœ¨éœ€è¦æ—¶å¯ç”¨è°ƒè¯•
                // å¦‚éœ€è°ƒè¯•ï¼Œå¯é€šè¿‡ localStorage.setItem('debug_global_cards', 'true') å¯ç”¨
                const debugMode = localStorage.getItem('debug_global_cards') === 'true';
                if (isGlobalViewForCards && debugMode) {
                    console.log('[GlobalCards] rightDrawerData å®Œæ•´ç»“æ„:', rightDrawerData);
                    console.log('[GlobalCards] countryTotalsForCards è¯¦ç»†å†…å®¹:', JSON.stringify(countryTotalsForCards, null, 2));
                }
                
                // ã€ä¿®å¤ã€‘åœ¨ global è§†å›¾æ—¶ï¼Œå¦‚æœ countryTotals ä¸ºç©ºä¸”ä¸æ˜¯ summaryOnly æ¨¡å¼
                // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ï¼Œå¦‚æœæœ‰åˆ™æ˜¾ç¤º"è®¡ç®—ä¸­..."ï¼Œå¦åˆ™ç›´æ¥æ¸²æŸ“ç©ºæ•°æ®ï¼ˆé¿å…ä¸€ç›´å¡ä½ï¼‰
                if (isGlobalViewForCards && Object.keys(countryTotalsForCards).length === 0 && !summaryOnly) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
                    const isFetching = window.__drawerFetchInProgress && window.__drawerFetchInProgress.has(ccUpper);
                    if (isFetching) {
                        // æ˜¾ç¤º"è®¡ç®—ä¸­..."çŠ¶æ€ï¼Œä½†è®¾ç½®è¶…æ—¶ï¼Œé¿å…ä¸€ç›´å¡ä½
                        // æ³¨æ„ï¼šè¿™é‡Œä¸é˜»æ­¢åç»­å¡ç‰‡çš„æ¸²æŸ“ï¼Œè®©ç”¨æˆ·è‡³å°‘èƒ½çœ‹åˆ°éƒ¨åˆ†å†…å®¹
                    } else {
                        // å¦‚æœæ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚ï¼Œè¯´æ˜æ•°æ®ç¡®å®ä¸ºç©ºæˆ–è¯·æ±‚å·²å¤±è´¥ï¼Œç›´æ¥æ¸²æŸ“ç©ºæ•°æ®ï¼ˆæ˜¾ç¤º 0ï¼‰
                        // ä¸æ˜¾ç¤º"è®¡ç®—ä¸­..."ï¼Œé¿å…è¯¯å¯¼ç”¨æˆ·
                    }
                }
                
                rightDrawerDimensions.forEach((dimId) => {
                        const config = dimensionConfig[dimId];
                        if (!config) return;

                        // è·å–ç»´åº¦æ•°æ®
                        let targetData = null;
                        let maxValue = 0;
                        let targetUserName = '';
                        let targetIpLocation = null;
                        let useCountryTotals = false;

                        // ã€ä¿®å¤ã€‘åœ¨ global è§†å›¾æ—¶ï¼Œå¼ºåˆ¶ä½¿ç”¨å›½å®¶ç´¯åŠ å€¼æ¨¡å¼ï¼ˆæ˜¾ç¤ºå›½å®¶æ€»æ•°æç¤ºï¼‰
                        if (isGlobalViewForCards) {
                            // ã€å¼ºåˆ¶ç®€çº¦ keyã€‘å…­ä¸ªç»Ÿè®¡å¡ç‰‡æ•°æ®æºä»…ä» data.countryTotals ä¸‹çš„ç®€çº¦ key è¯»å–
                            const dimToCountryTotalMap = {
                                'ai': ['ai'],       // è°ƒæˆAIæ¬¡æ•° -> countryTotals.ai
                                'say': ['say'],     // å¯¹è¯å­—ç¬¦æ•° -> countryTotals.say
                                'no': ['no'],       // ç”²æ–¹ä¸Šèº« -> countryTotals.no
                                'please': ['please'], // ç£•å¤´ -> countryTotals.please
                                'day': ['day'],     // ä¸Šå²—å¤©æ•° -> countryTotals.day
                                'word': ['word']    // å¹³å‡é•¿åº¦ -> countryTotals.word
                            };
                            
                            const possibleKeys = dimToCountryTotalMap[dimId] || [];
                            let foundValue = null;
                            
                            // ã€å¼ºåŒ–æ¸²æŸ“å–å€¼ã€‘å°è¯•æ‰€æœ‰å¯èƒ½çš„å­—æ®µåï¼ˆä¼˜å…ˆçŸ­ç¼©åï¼‰ï¼Œä½¿ç”¨ Number(val) || 0 è¿›è¡Œè½¬æ¢
                            for (const key of possibleKeys) {
                                if (countryTotalsForCards[key] !== undefined && countryTotalsForCards[key] !== null) {
                                    // ã€å¼ºåŒ–å–å€¼ã€‘ä½¿ç”¨ Number(val) || 0 ç¡®ä¿æ­£ç¡®è½¬æ¢å’Œé»˜è®¤å€¼å¤„ç†
                                    const rawValue = countryTotalsForCards[key];
                                    const val = Number(rawValue) || 0;
                                    if (val >= 0) {
                                        foundValue = val;
                                        // ã€éªŒè¯é—­ç¯ã€‘åœ¨è°ƒè¯•æ¨¡å¼ä¸‹è¾“å‡ºå­—æ®µåŒ¹é…ä¿¡æ¯
                                        if (debugMode && dimId === 'please') {
                                            console.log(`[GlobalCards] âœ… please å­—æ®µåŒ¹é…æˆåŠŸ: ${key} = ${val} (raw: ${rawValue})`);
                                        }
                                        break;
                                    }
                                }
                            }
                            
                            if (foundValue !== null) {
                                maxValue = foundValue;
                            } else {
                                // å¦‚æœæ‰€æœ‰å­—æ®µéƒ½æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨ 0
                                // ä»…åœ¨è°ƒè¯•æ¨¡å¼ä¸‹è¾“å‡ºä¿¡æ¯
                                if (debugMode) {
                                    console.log(`[GlobalCards] ${dimId} å­—æ®µæœªæ‰¾åˆ°ï¼Œå¯ç”¨å­—æ®µ:`, Object.keys(countryTotalsForCards));
                                }
                                maxValue = 0;
                            }
                            
                            // å¼ºåˆ¶è®¾ç½®å›½å®¶ä¿¡æ¯
                            targetUserName = currentDrawerCountry?.name || 'å›½å®¶æ•°æ®';
                            targetIpLocation = currentDrawerCountry?.code || null;
                            useCountryTotals = true; // å¼ºåˆ¶ä½¿ç”¨å›½å®¶ç´¯åŠ å€¼æ¨¡å¼
                        }
                        
                        // å¦‚æœæ²¡æœ‰ä½¿ç”¨å›½å®¶ç´¯åŠ å€¼ï¼Œåˆ™ä½¿ç”¨åŸæœ‰é€»è¾‘
                        if (!useCountryTotals) {
                            if (typeof isGlobalTopMode !== 'undefined' && isGlobalTopMode) {
                                const allData = window.allData || [];
                                if (allData.length > 0) {
                                    targetData = allData.reduce((maxUser, currentUser) => {
                                        const currentValues = extractDimensionValues(currentUser);
                                        const maxValues = extractDimensionValues(maxUser);
                                        const currentValue = currentValues[dimId] || 0;
                                        const maxValue = maxValues[dimId] || 0;
                                        return currentValue > maxValue ? currentUser : maxUser;
                                    }, allData[0]);
                                    
                                    const targetValues = extractDimensionValues(targetData);
                                    maxValue = targetValues[dimId] || 0;
                                    targetUserName = targetData.user_name || targetData.name || targetData.github_username || 'æœªçŸ¥ç”¨æˆ·';
                                    targetIpLocation = targetData.ip_location || null;
                                } else {
                                    maxValue = 0;
                                    targetUserName = 'æš‚æ— æ•°æ®';
                                    targetIpLocation = null;
                                }
                            } else {
                                var item = (typeof drawerCurrentUser !== 'undefined' && drawerCurrentUser != null) ? drawerCurrentUser : null;
                                targetData = item;
                                const values = item ? extractDimensionValues(item) : {};
                                maxValue = values[dimId] || 0;
                                targetUserName = item ? (item.user_name || item.name || item.github_username || 'æˆ‘çš„æ•°æ®') : 'æˆ‘çš„æ•°æ®';
                                targetIpLocation = item ? (item.ip_location || null) : null;
                            }
                        }

                        const feedback = useCountryTotals ? null : getRankFeedback(dimId, maxValue); // ä½¿ç”¨å›½å®¶ç´¯åŠ å€¼æ—¶ä¸éœ€è¦ä¸ªäººåé¦ˆ
                        // ã€ä¿®å¤ã€‘åœ¨ global è§†å›¾ä½¿ç”¨å›½å®¶ç´¯åŠ å€¼æ—¶ï¼Œæ˜¾ç¤ºä¸º TOP æ¨¡å¼ï¼ˆæ˜¾ç¤ºå›½å®¶ç´¯åŠ å€¼ï¼‰
                        const cardIsGlobalTopMode = useCountryTotals ? true : (typeof isGlobalTopMode !== 'undefined' ? isGlobalTopMode : false);
                        // ã€ä¿®å¤ã€‘ä¼ é€’æ ‡å¿—ï¼Œè¡¨ç¤ºä½¿ç”¨çš„æ˜¯å›½å®¶ç´¯åŠ å€¼
                        const card = createDimensionCard(dimId, config, maxValue, targetUserName, targetIpLocation, feedback, cardIsGlobalTopMode, useCountryTotals);
                        rightCards.push(card);
                    });

                // ============================================
                // æ¸è¿›å¼æ¸²æŸ“å³ä¾§å¡ç‰‡
                // ============================================
                
                // æ·»åŠ ç»Ÿè®¡å¡ç‰‡ï¼ˆä½¿ç”¨å½’ä¸€åŒ–åçš„æ•°æ®ï¼Œä¸ç»´åº¦å¡ç‰‡ä¸€è‡´ï¼‰
                const data = normalizedData;
                const nfDrawer = new Intl.NumberFormat(currentLang === 'en' ? 'en-US' : 'zh-CN');
                
                // ã€ä¿®å¤ã€‘åœ¨ global è§†å›¾æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ countryTotals ä¸­çš„ç´¯åŠ å€¼ï¼ˆè¯¥å›½ç”¨æˆ·ç´¯åŠ çš„æ•°å€¼ï¼‰
                const isGlobalView = typeof currentViewState === 'string' && currentViewState === 'GLOBAL';
                const countryTotals = data.countryTotals || {};
                
                // å·²è¯Šæ–­å¼€å‘è€…ï¼šglobal è§†å›¾ä½¿ç”¨è¯¥å›½æ€»ç”¨æˆ·æ•°ï¼Œå¦åˆ™ä½¿ç”¨å…¨å±€æ€»ç”¨æˆ·æ•°
                const totalUsers = isGlobalView && (countryTotals.totalUsers !== undefined && countryTotals.totalUsers !== null || countryTotals.total_users !== undefined && countryTotals.total_users !== null)
                    ? Number(countryTotals.totalUsers ?? countryTotals.total_users)
                    : (data.totalUsers !== undefined && data.totalUsers !== null ? Number(data.totalUsers) : undefined);
                const totalUsersCard = document.createElement('div');
                totalUsersCard.className = 'drawer-item stat-card';
                totalUsersCard.innerHTML = `
                    <div class="drawer-item-label">${(i18n[currentLang] && i18n[currentLang]['total-victims']) ? i18n[currentLang]['total-victims'] : (currentLang === 'en' ? 'Total Developers' : 'å·²è¯Šæ–­å¼€å‘è€…')}</div>
                    <div class="drawer-item-value text-3xl">${totalUsers !== undefined ? nfDrawer.format(Math.floor(Number(totalUsers))) : 'N/A'}</div>
                    <div class="drawer-item-desc">USERS_RECOGNIZED_SUCCESSFULLY</div>
                `;
                rightCards.push(totalUsersCard);

                // ã€ä¿®å¤ã€‘æ‰«ææ¬¡æ•°ï¼šåœ¨ global è§†å›¾æ—¶ä½¿ç”¨å›½å®¶ç´¯åŠ å€¼ï¼ˆtotal_messages ä½œä¸ºæ‰«ææ¬¡æ•°ï¼‰
                // æ³¨æ„ï¼štotal_messages æ˜¯è¯¥å›½æ‰€æœ‰ç”¨æˆ·çš„æ¶ˆæ¯æ€»æ•°ï¼ˆç´¯åŠ å€¼ï¼‰
                const totalAnalysis = isGlobalView && countryTotals.total_messages !== undefined && countryTotals.total_messages !== null
                    ? Number(countryTotals.total_messages)
                    : (data.totalAnalysis !== undefined && data.totalAnalysis !== null ? Number(data.totalAnalysis) : undefined);
                const totalAnalysisCard = document.createElement('div');
                totalAnalysisCard.className = 'drawer-item stat-card';
                const isGlobalViewForLabel = typeof currentViewState === 'string' && currentViewState === 'GLOBAL';
                const analysisLabel = isGlobalViewForLabel 
                    ? (currentLang === 'en' ? 'Country AI Conversations' : 'è¯¥å›½ç”¨æˆ·ä¸AIå¯¹è¯æ€»æ¬¡æ•°')
                    : ((i18n[currentLang] && i18n[currentLang]['total-analysis']) ? i18n[currentLang]['total-analysis'] : (currentLang === 'en' ? 'Total Scans' : 'æ‰«ææ¬¡æ•°'));
                totalAnalysisCard.innerHTML = `
                    <div class="drawer-item-label">${analysisLabel}</div>
                    <div class="drawer-item-value text-3xl">${totalAnalysis !== undefined ? nfDrawer.format(Math.floor(Number(totalAnalysis))) : 'N/A'}</div>
                    <div class="drawer-item-desc">TOTAL_SCAN_COUNT</div>
                `;
                rightCards.push(totalAnalysisCard);

                // ã€ä¿®å¤ã€‘Global è§†å›¾æ—¶åŒæ­¥æ›´æ–°å·¦ä¾§æŠ½å±‰å¤´éƒ¨ã€Œå·²è¯Šæ–­å¼€å‘è€…ã€ã€Œè¯Šæ–­æ¬¡æ•°ã€ï¼Œé¿å…ä¸€ç›´æ˜¾ç¤º N/A
                try {
                    const rtDiagnosed = document.getElementById('rtDiagnosedTotal');
                    const rtScan = document.getElementById('rtScanTotal');
                    if (rtDiagnosed) rtDiagnosed.textContent = totalUsers !== undefined ? nfDrawer.format(Math.floor(Number(totalUsers))) : 'N/A';
                    if (rtScan) rtScan.textContent = totalAnalysis !== undefined ? nfDrawer.format(Math.floor(Number(totalAnalysis))) : 'N/A';
                } catch (e) { /* ignore */ }

                // ã€ä¿®å¤ã€‘ç´¯è®¡åæ§½å­—æ•°ï¼šCOUNTRY è§†å›¾ä½¿ç”¨è¯¥å›½å…¨é‡ total_charsï¼ˆcountryTotals.say / total_charsï¼‰
                const totalChars = (countryTotals && (countryTotals.total_chars !== undefined && countryTotals.total_chars !== null || countryTotals.say !== undefined && countryTotals.say !== null))
                    ? Number(countryTotals.total_chars ?? countryTotals.say ?? 0)
                    : (data.totalChars !== undefined && data.totalChars !== null ? Number(data.totalChars) : (data.totalRoastWords !== undefined && data.totalRoastWords !== null ? Number(data.totalRoastWords) : undefined));
                const totalCharsCard = document.createElement('div');
                totalCharsCard.className = 'drawer-item stat-card';
                totalCharsCard.innerHTML = `
                    <div class="drawer-item-label">${(i18n[currentLang] && i18n[currentLang]['total-roast']) ? i18n[currentLang]['total-roast'] : (currentLang === 'en' ? 'Total Roast Words' : 'ç´¯è®¡åæ§½å­—æ•°')}</div>
                    <div class="drawer-item-value text-3xl">${totalChars !== undefined ? nfDrawer.format(Math.floor(Number(totalChars))) : 'N/A'}</div>
                    <div class="drawer-item-desc">ç´¯è®¡æ€»å­—æ•°ç»Ÿè®¡</div>
                `;
                rightCards.push(totalCharsCard);

                // ã€ä¿®å¤ã€‘Global è§†å›¾=è¯¥å›½å£å¾„ï¼šäººå‡=è¯¥å›½ total_chars/total_usersï¼ˆå…¨å›½äººå‡æ¯æ¬¡å­—ç¬¦æ•°ï¼‰ï¼Œå•æ¬¡=è¯¥å›½ total_chars/total_messagesï¼ˆæ¯äººå•æ¬¡å¯¹è¯å­—ç¬¦æ•°ï¼‰
                let avgPerUser = data.avgPerUser !== undefined && data.avgPerUser !== null ? Number(data.avgPerUser) : undefined;
                if ((avgPerUser === undefined || avgPerUser === 0) && totalChars !== undefined && totalUsers !== undefined && totalUsers > 0) {
                    avgPerUser = Number(totalChars) / Number(totalUsers);
                }
                if (isGlobalView && totalChars !== undefined && totalUsers !== undefined && totalUsers > 0) {
                    avgPerUser = Number(totalChars) / Number(totalUsers);
                }
                let avgPerScan = data.avgPerScan !== undefined && data.avgPerScan !== null ? Number(data.avgPerScan) : undefined;
                if ((avgPerScan === undefined || avgPerScan === 0) && totalChars !== undefined && totalAnalysis !== undefined && totalAnalysis !== null && totalAnalysis > 0) {
                    avgPerScan = Number(totalChars) / Number(totalAnalysis);
                }
                if (isGlobalView && totalChars !== undefined && totalAnalysis !== undefined && totalAnalysis > 0) {
                    avgPerScan = Number(totalChars) / Number(totalAnalysis);
                }
                if (isGlobalView && (countryTotals.word != null && Number(countryTotals.word) > 0)) {
                    avgPerScan = Number(countryTotals.word);
                }
                const avgCard = document.createElement('div');
                avgCard.className = 'drawer-item stat-card';
                avgCard.innerHTML = `
                    <div class="drawer-item-label mb-2">${escapeHtml(currentLang === 'en' ? 'Average Length' : 'å¹³å‡ç¯‡å¹…ç»Ÿè®¡')}</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <div class="drawer-item-value text-xl">${avgPerUser !== undefined ? Number(avgPerUser).toFixed(1) : 'N/A'}</div>
                            <div class="drawer-item-desc text-[8px]">${escapeHtml(isGlobalView ? (currentLang === 'en' ? 'Per user (chars)' : 'å…¨å›½äººå‡æ¯æ¬¡å­—ç¬¦æ•°') : (currentLang === 'en' ? 'Per User' : 'äººå‡å¹³å‡ç¯‡å¹…'))}</div>
                        </div>
                        <div>
                            <div class="drawer-item-value text-xl">${avgPerScan !== undefined ? Number(avgPerScan).toFixed(1) : 'N/A'}</div>
                            <div class="drawer-item-desc text-[8px]">${escapeHtml(isGlobalView ? (currentLang === 'en' ? 'Per message (chars)' : 'æ¯äººå•æ¬¡å¯¹è¯å­—ç¬¦æ•°') : (currentLang === 'en' ? 'Per Scan' : 'å•æ¬¡å¹³å‡ç¯‡å¹…'))}</div>
                        </div>
                    </div>
                `;
                rightCards.push(avgCard);

                // å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒï¼ˆé›·è¾¾å›¾ï¼‰
                const radarData = data.globalAverage || data.averages;
                const radarCard = document.createElement('div');
                radarCard.className = 'drawer-item stat-card';
                radarCard.innerHTML = `
                    <div class="drawer-item-label mb-3">${escapeHtml((i18n[currentLang] && i18n[currentLang]['radar-title']) ? i18n[currentLang]['radar-title'] : (currentLang === 'en' ? 'Global Developer Persona' : 'å…¨ç½‘å¹³å‡å¼€å‘è€…ç”»åƒ'))}</div>
                    <div class="aspect-square">
                        <canvas id="drawer-radarChart"></canvas>
                    </div>
                `;
                // é›·è¾¾å›¾éœ€è¦ç‰¹æ®Šå¤„ç†ï¼šæ¸²æŸ“åå†åˆå§‹åŒ–å›¾è¡¨
                radarCard.dataset.hasChart = 'true';
                rightCards.push(radarCard);

                // åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ
                const locationCard = document.createElement('div');
                locationCard.className = 'drawer-item stat-card';
                const locationListHtml = data.locationRank && Array.isArray(data.locationRank) 
                    ? data.locationRank.slice(0, 5).map((item, i) => {
                        const name = countryNameMap[item.name] ? countryNameMap[item.name][currentLang] : item.name;
                        return `
                            <div class="flex justify-between items-center text-[10px] border-b border-[#00ff41]/10 pb-2">
                                <span class="text-zinc-500 font-mono">0${i+1}</span>
                                <span class="font-bold uppercase tracking-tighter text-white">${name}</span>
                                <span class="text-[#00ff41] font-bold">${item.value}</span>
                            </div>`;
                    }).join('')
                    : '';
                locationCard.innerHTML = `
                    <div class="drawer-item-label mb-3">${escapeHtml((i18n[currentLang] && i18n[currentLang]['hot-list']) ? i18n[currentLang]['hot-list'] : (currentLang === 'en' ? 'Geographic Hotspots' : 'åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œ'))}</div>
                    <div id="drawer-locationList" class="space-y-2">${locationListHtml}</div>
                `;
                rightCards.push(locationCard);

                // äººæ ¼åˆ†å¸ƒæ’è¡Œï¼šç«–å‘æŸ±çŠ¶å›¾ + äººæ ¼æ–‡å­—åç§°
                const personalityCard = document.createElement('div');
                personalityCard.className = 'drawer-item stat-card';
                let personalityListHtml = '';
                if (data.personalityRank && Array.isArray(data.personalityRank)) {
                    const total = data.personalityRank.reduce((s, it) => s + (Number(it.count) || 0), 0);
                    const maxPct = total > 0 ? Math.max(...data.personalityRank.map((it) => (Number(it.count) || 0) / total * 100)) : 0;
                    personalityListHtml = data.personalityRank.map((item) => {
                        const count = Number(item.count) || 0;
                        const pctVal = total > 0 ? (count / total) * 100 : 0;
                        const pct = pctVal.toFixed(1);
                        const heightPct = maxPct > 0 ? Math.max(4, (pctVal / maxPct) * 100) : 0;
                        const title = getPersonalityTitle(item, currentLang);
                        return `<div class="personality-vbar-col"><div class="personality-vbar-bar-wrap"><div class="personality-vbar-fill" style="height: ${heightPct}%;"></div></div><span class="personality-vbar-name" title="${escapeHtml(title)}">${escapeHtml(title)}</span><span class="personality-vbar-pct">${pct}%</span></div>`;
                    }).join('');
                }
                personalityCard.innerHTML = `
                    <div class="drawer-item-label mb-3">${escapeHtml((i18n[currentLang] && i18n[currentLang]['personality-dist']) ? i18n[currentLang]['personality-dist'] : (currentLang === 'en' ? 'Personality Distribution' : 'äººæ ¼åˆ†å¸ƒæ’è¡Œ'))}</div>
                    <div id="drawer-personalityDistribution" class="personality-vbar-chart">${personalityListHtml}</div>
                `;
                rightCards.push(personalityCard);
                
                // æ¸è¿›å¼æ¸²æŸ“å³ä¾§å¡ç‰‡
                renderCardsStaggered(rightBody, rightCards, 100);
                try { setRightDrawerLoading(false); } catch { /* ignore */ }
                
                // æ¸²æŸ“é›·è¾¾å›¾ï¼ˆåœ¨å¡ç‰‡æ¸²æŸ“å®Œæˆåï¼‰
                if (radarData) {
                    setTimeout(() => {
                        const drawerRadarCanvas = document.getElementById('drawer-radarChart');
                        if (drawerRadarCanvas && typeof Chart !== 'undefined') {
                            const normalizedRadarData = {
                                L: radarData.L !== undefined && radarData.L !== null ? Number(radarData.L) : undefined,
                                P: radarData.P !== undefined && radarData.P !== null ? Number(radarData.P) : undefined,
                                D: radarData.D !== undefined && radarData.D !== null ? Number(radarData.D) : undefined,
                                E: radarData.E !== undefined && radarData.E !== null ? Number(radarData.E) : undefined,
                                F: radarData.F !== undefined && radarData.F !== null ? Number(radarData.F) : undefined,
                            };
                            renderRadarChartToCanvas(drawerRadarCanvas, normalizedRadarData);
                        }
                    }, 600);
                }
                
                // æ¸²æŸ“äººæ ¼åˆ†å¸ƒï¼šç«–å‘æŸ±çŠ¶å›¾ + äººæ ¼æ–‡å­—åç§°ï¼ˆä¸ä¸»é¡µé¢ä¸€è‡´ï¼‰
                if (data.personalityRank && Array.isArray(data.personalityRank)) {
                    const drawerPersonalityList = document.getElementById('drawer-personalityDistribution');
                    if (drawerPersonalityList) {
                        const total = data.personalityRank.reduce((s, it) => s + (Number(it.count) || 0), 0);
                        const maxPct = total > 0 ? Math.max(...data.personalityRank.map((it) => (Number(it.count) || 0) / total * 100)) : 0;
                        drawerPersonalityList.className = 'personality-vbar-chart';
                        drawerPersonalityList.innerHTML = data.personalityRank.map((item) => {
                            const count = Number(item.count) || 0;
                            const pctVal = total > 0 ? (count / total) * 100 : 0;
                            const pct = pctVal.toFixed(1);
                            const heightPct = maxPct > 0 ? Math.max(4, (pctVal / maxPct) * 100) : 0;
                            const title = getPersonalityTitle(item, currentLang);
                            return `<div class="personality-vbar-col"><div class="personality-vbar-bar-wrap"><div class="personality-vbar-fill" style="height: ${heightPct}%;"></div></div><span class="personality-vbar-name" title="${escapeHtml(title)}">${escapeHtml(title)}</span><span class="personality-vbar-pct">${pct}%</span></div>`;
                        }).join('');
                    }
                }
            }

            // æ˜¾ç¤ºæŠ½å±‰ï¼ˆä»…å®Œæ•´æ‰“å¼€æ—¶ï¼Œsummary ä»…åˆ·æ–°å³ä¾§ä¸é‡å¤æ‰“å¼€ï¼‰
            if (!summaryOnly) {
                if (leftDrawer) leftDrawer.classList.add('active');
                if (rightDrawer) rightDrawer.classList.add('active');
                try {
                    localStorage.setItem('left_drawer_open', 'true');
                    localStorage.setItem('right_drawer_open', 'true');
                } catch (e) { /* ignore */ }
                // UI åˆ·æ–°ï¼šæŠ½å±‰æ‰“å¼€å 1) ä» v_user_analysis_extended é‡æ–°æ‹‰å–å½“å‰ç”¨æˆ·æœ€æ–°æ’å 2) å›¾è°±é‡ç»˜ä¸ ECharts å°ºå¯¸è‡ªé€‚åº”
                setTimeout(function () {
                    try {
                        var cu = window.currentUser || window.currentUserData;
                        if (supabaseClient && cu && (cu.id || cu.fingerprint)) {
                            var q = supabaseClient.from('v_user_analysis_extended').select('*');
                            if (cu.id) q = q.eq('id', cu.id); else q = q.eq('fingerprint', cu.fingerprint);
                            q.maybeSingle().then(function (r) {
                                if (r && r.data) {
                                    window.currentUser = r.data;
                                    window.currentUserData = r.data;
                                    if (typeof renderRankCards === 'function') renderRankCards(r.data);
                                }
                            }).catch(function () {});
                        }
                        // ã€é‡æ„ã€‘åªæœ‰åœ¨æ’è¡Œæ¦œè§†å›¾å¯è§æ—¶æ‰æ¸²æŸ“é«˜åˆ†å›¾è°±
                        if (typeof drawHighScores === 'function' && currentViewState === 'RANKING') {
                            var topBy = (window.lastData && window.lastData.topByMetrics) ? window.lastData.topByMetrics : [];
                            if (Array.isArray(topBy) && topBy.length > 0) {
                                console.log('[showDrawersWithCountryData] å‡†å¤‡æ¸²æŸ“é«˜åˆ†å›¾è°±åˆ°æ’è¡Œæ¦œè§†å›¾');
                                drawHighScores(topBy);
                            } else {
                                console.log('[showDrawersWithCountryData] ç¼ºå°‘ topByMetrics æ•°æ®');
                            }
                        }
                        if (typeof echarts !== 'undefined') {
                            var charts = document.querySelectorAll('#right-drawer [data-_ec_instance_]');
                            charts.forEach(function (el) {
                                var inst = echarts.getInstanceByDom(el);
                                if (inst && typeof inst.resize === 'function') inst.resize();
                            });
                        }
                    } catch (e) { /* ignore */ }
                }, 150);
            }
            localStorage.setItem('selected_country', countryCode);
            console.log('[Drawer] æŠ½å±‰å·²æ‰“å¼€:', countryDisplayName);
            } catch (drawerErr) {
                console.warn('[Drawer] showDrawersWithCountryData å¼‚å¸¸:', drawerErr);
            }
        }

        /**
         * åˆ‡æ¢åˆ°ã€Œå›½å®¶æ•°æ®é€è§†ã€æ¨¡å¼ï¼ˆå³ä¾§æŠ½å±‰æ˜¾ç¤ºè¯¥å›½é›·è¾¾å›¾ + æˆ˜ç¥æ¦œï¼‰
         * å…ˆè°ƒç”¨ showDrawersWithCountryData å¡«å……å·¦ä¾§ä¸ªäººæ•°æ®ï¼Œå†æŠŠå³ä¾§åˆ‡ä¸ºå›½å®¶é€è§†ã€‚
         * @param {string} code - å›½å®¶ä»£ç ï¼Œå¦‚ 'US'
         * @param {string} name - å›½å®¶åç§°ï¼Œå¦‚ 'United States'
         */
        function switchToCountryView(code, name) {
            showDrawersWithCountryData(code, name);
            currentViewState = 'COUNTRY';
            const rightDrawer = document.getElementById('right-drawer');
            const globalFlowPanelButtons = document.getElementById('globalFlowPanelButtons');
            if (!rightDrawer) return;
            
            // ã€é‡æ„ã€‘è§†å›¾åˆ‡æ¢ç”±è°ƒç”¨æ–¹å¤„çš„ switchView å‡½æ•°å¤„ç†ï¼Œè¿™é‡Œåªå¤„ç†é¢æ¿æ¸²æŸ“
            if (globalFlowPanelButtons) globalFlowPanelButtons.style.display = 'none';

            const leftTitle = document.getElementById('left-drawer-title');
            const rightTitle = document.getElementById('right-drawer-title');
            const displayName = countryNameMap[String(code || '').toUpperCase()]
                ? (currentLang === 'zh'
                    ? countryNameMap[String(code || '').toUpperCase()].zh
                    : countryNameMap[String(code || '').toUpperCase()].en)
                : name;
            if (leftTitle) leftTitle.textContent = displayName;
            if (rightTitle) rightTitle.textContent = displayName;

            renderCountryRightPanel(code, displayName);
            // è§¦å‘å›½å®¶æŠ½å±‰æ•°æ®æ‹‰å–ï¼ˆç¼“å­˜ä¼˜å…ˆ + é™é»˜æ›´æ–°ï¼‰
            try { updateCountryDashboard(code, null, { preferCache: true, silent: true }); } catch (e) { /* ignore */ }

            selectedCountry = code === 'US' ? 'US' : code;
            currentDrawerCountry.code = code;
            currentDrawerCountry.name = displayName;
            try { window.currentUserCountry = String(code || '').trim().toUpperCase(); } catch (e) { /* ignore */ }
            // ã€æ–°å¢ã€‘æ›´æ–°é¡¶éƒ¨è§†å›¾åˆ‡æ¢æŒ‰é’®
            updateHeaderViewToggleBtn();
            console.log('[Drawer] å›½å®¶é€è§†å·²æ‰“å¼€:', name);
        }

        // ============================
        // å›½å®¶é€è§†ï¼ˆright.html æ¨¡æ¿æ¸²æŸ“ï¼Œæ— æ‰“å­—æœºï¼‰
        // ============================
        function clamp(n, min, max) {
            const x = Number(n);
            if (isNaN(x)) return min;
            return Math.max(min, Math.min(max, x));
        }

        function pct(n) {
            const x = clamp(n, 0, 100);
            return `${x.toFixed(1)}%`;
        }

        function renderCountryRightPanel(code, name) {
            const mount = document.getElementById('countryTemplateMount');
            const tpl = document.getElementById('rightDrawerTemplate');
            if (!mount || !tpl) return;

            mount.innerHTML = '';
            const node = tpl.content.cloneNode(true);
            mount.appendChild(node);

            // å…ˆæ¸²æŸ“åŸºç¡€éª¨æ¶ï¼ˆä¸å†ç¡¬ç¼–ç ç¾å›½æ•°æ®ï¼›æ•°æ®ç”± updateCountryDashboard(countryName) æ‹‰å–ï¼‰
            const cc = String(code || '').trim().toUpperCase();
            const coordPrefix = (typeof getI18nText === 'function' ? getI18nText('panel.coord_prefix') : null) || (currentLang === 'zh' ? 'åæ ‡' : 'COORD');
            const model = {
                coord: (cc === 'US' || name === 'United States')
                    ? coordPrefix + ': 37.0902Â° N, 95.7129Â° W'
                    : (cc === 'CN' || name === 'China' || name === 'ä¸­å›½')
                        ? coordPrefix + ': 35.8617Â° N, 104.1954Â° E'
                        : (coordPrefix + ': --'),
                dataStatus: (typeof getI18nText === 'function' ? getI18nText('panel.data_ready') : null) || (currentLang === 'zh' ? 'æ•°æ®ï¼šå°±ç»ª' : 'DATA: READY'),
                flag: (cc === 'US' || name === 'United States')
                    ? 'ğŸ‡ºğŸ‡¸'
                    : (cc === 'CN' || name === 'China' || name === 'ä¸­å›½')
                        ? 'ğŸ‡¨ğŸ‡³'
                        : (countryCodeToFlagEmoji(code) || 'ğŸ³ï¸'),
                nodeName: (currentLang === 'zh' && countryNameMap && countryNameMap[cc]) ? (countryNameMap[cc].zh || name) : (name || (countryNameMap && countryNameMap[cc] ? countryNameMap[cc].en : code) || '--'),
                diagnosedTotal: '--',
                scanTotal: '--',
                pk: {
                    leftLabel: currentLang === 'en' ? 'Tsundere' : 'å‚²å¨‡',
                    rightLabel: currentLang === 'en' ? 'Bootlick' : 'è·ªèˆ”',
                    leftPct: 50,
                    rightPct: 50,
                    quote: ''
                },
                meltdown: {
                    words: (typeof getI18nText === 'function' ? getI18nText('panel.meltdown_words') : 'å­—æ•°') + ': --',
                    fillPct: 0,
                    level: (typeof getI18nText === 'function' ? getI18nText('panel.meltdown_pending') : null) || (currentLang === 'zh' ? 'å¾…è®¡ç®—' : 'PENDING'),
                    victims: '--'
                },
                semantic: {
                    tags: [],
                    mostUsed: (typeof getI18nText === 'function' ? getI18nText('panel.most_used') : 'MOST_USED') + ': --',
                    freq: (typeof getI18nText === 'function' ? getI18nText('panel.freq') : 'FREQ') + ': --'
                },
                elite: [],
                ratio: []
            };

            const q = (sel) => mount.querySelector(sel);
            const setText = (sel, v) => { const el = q(sel); if (el) el.textContent = String(v); };

            setText('#rtCoord', model.coord);
            setText('#rtDataStatus', model.dataStatus);
            setText('#rtFlag', model.flag);
            setText('#rtNodeName', model.nodeName);
            setText('#rtDiagnosedTotal', model.diagnosedTotal);
            setText('#rtScanTotal', model.scanTotal);
            setText('#rtMeritBoard', currentLang === 'en' ? 'Analyzed -- Ã—10k chars' : 'å·²ç´¯è®¡åˆ†æ -- ä¸‡å­—');

            setText('#rtPkLeftLabel', `${model.pk.leftLabel}`);
            setText('#rtPkRightLabel', `${model.pk.rightLabel}`);
            setText('#rtPkLeftPct', pct(model.pk.leftPct));
            setText('#rtPkRightPct', pct(model.pk.rightPct));
            // å…¼å®¹ï¼šrtPkQuote å·²éšè—ï¼Œä¸å†æ¸²æŸ“å ä½æ–‡æ¡ˆ
            setText('#rtPkQuote', model.pk.quote || '');
            const pkLeftFill = q('#rtPkLeftFill');
            const pkRightFill = q('#rtPkRightFill');
            if (pkLeftFill) pkLeftFill.style.width = `${clamp(model.pk.leftPct, 0, 100)}%`;
            if (pkRightFill) pkRightFill.style.width = `${clamp(model.pk.rightPct, 0, 100)}%`;

            setText('#rtMeltdownWords', model.meltdown.words);
            setText('#rtMeltdownLevel', model.meltdown.level);
            setText('#rtMeltdownVictims', model.meltdown.victims);
            const meltdownFill = q('#rtMeltdownFill');
            if (meltdownFill) meltdownFill.style.width = `${clamp(model.meltdown.fillPct, 0, 100)}%`;

            // æ³¨æ„ï¼š#rtSemanticTags ç°åœ¨åŒ…å«å®Œæ•´çš„â€œè¯­ä¹‰çˆ†å‘â€æ¨¡æ¿ï¼ˆå«è¯äº‘å®¹å™¨ï¼‰ï¼Œä¸è¦åœ¨è¿™é‡Œè¦†ç›– innerHTML
            setText('#rtSemanticMostUsed', model.semantic.mostUsed);
            setText('#rtSemanticFreq', model.semantic.freq);

            // æ³¨æ„ï¼š#rtEliteList å†…åŒ…å« #rtTopTalentsListï¼ˆé«˜åˆ†å›¾è°±å®¹å™¨ï¼‰ï¼Œ
            // éª¨æ¶æ¸²æŸ“é˜¶æ®µä¸è¦è¦†ç›–å…¶ innerHTMLï¼Œå¦åˆ™ä¼šæŠŠæ¦œå• DOM åˆ æ‰å¯¼è‡´ä¸€ç›´ç©ºç™½ã€‚

            const ratioEl = q('#rtRatioList');
            if (ratioEl) {
                ratioEl.innerHTML = (model.ratio || []).map((r) => `
                    <div class="flex justify-between text-xs ${r.dim ? 'text-zinc-500' : ''}">
                        <span class="flex items-center gap-2"><div class="w-2 h-2 ${r.dotClass}"></div> ${String(r.label)}</span>
                        <span class="font-bold">${Number(r.pct).toFixed(1)}%</span>
                    </div>
                `).join('');
            }

            // åˆå§‹åŒ– Lucide å›¾æ ‡ï¼ˆåªè¦åº“åŠ è½½å®Œæˆå³å¯ï¼‰
            try {
                if (typeof lucide !== 'undefined' && lucide && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }
            } catch (e) {
                // ignore
            }

            // åˆå§‹åŒ–è¯äº‘ï¼šéæ ¸å¿ƒå›¾è¡¨ä½¿ç”¨ requestIdleCallbackï¼Œé¿å…æ»šåŠ¨å¡é¡¿
            try {
                const ric = window.requestIdleCallback || ((cb) => setTimeout(() => cb({ timeRemaining: () => 0 }), 0));
                ric(() => { try { loadWordCloud(); } catch (e) { /* ignore */ } }, { timeout: 1500 });
            } catch (e) {
                try { setTimeout(() => { loadWordCloud(); }, 50); } catch (e2) { /* ignore */ }
            }

            // å°†â€œæš‚æ— æ•°æ®â€çš„å ä½æ¸²æŸ“å‡ºæ¥ï¼Œé¿å…ç©ºç™½
            const realtimeBox = q('#rtRealtimeList');
            if (realtimeBox && !realtimeBox.innerHTML.trim()) {
                realtimeBox.innerHTML = `<div class="text-zinc-500 text-xs">${escapeHtml(getI18nText('realtime.none') || (currentLang === 'en' ? 'No personality distribution yet' : 'æš‚æ— äººæ ¼åˆ†å¸ƒæ•°æ®'))}</div>`;
            }

            // å…³é”®ï¼šå›½å®¶é€è§†æ¨¡æ¿æ¸²æŸ“å®Œæ¯•åï¼Œç«‹å³æ‰§è¡Œé¡µé¢ç¿»è¯‘ï¼ˆé¿å…è‹±æ–‡æ¨¡å¼ä»æ˜¾ç¤ºä¸­æ–‡ç¡¬ç¼–ç ï¼‰
            try { translatePage(); } catch { /* ignore */ }
        }

        function refreshCountryRightPanel() {
            if (currentViewState !== 'COUNTRY') return;
            if (!currentDrawerCountry || !currentDrawerCountry.code) return;
            renderCountryRightPanel(currentDrawerCountry.code, currentDrawerCountry.name);
            try { updateCountryDashboard(currentDrawerCountry.code); } catch (e) { /* ignore */ }
        }

        /**
         * ã€æ–°å¢ã€‘ä¸‰ Tab è§†å›¾åˆ‡æ¢å‡½æ•°
         * å¤„ç†å…¨çƒã€å›½å®¶ã€æ’è¡Œæ¦œä¸‰ä¸ªè§†å›¾çš„åˆ‡æ¢
         * @param {string} view - 'global' | 'country' | 'ranking'
         */
        function switchView(view, initialCountryCode) {
            if (isGlobalInitializing && !window.__allowInitCall) return;
            console.log('[switchView] åˆ‡æ¢åˆ°è§†å›¾:', view);
            var targetView = (view || '').toUpperCase();
            // è§†å›¾æ‹¦æˆªï¼šç›®æ ‡è§†å›¾ä¸ç›®æ ‡å›½å®¶å‡ä¸å½“å‰ä¸€è‡´æ—¶è·³è¿‡æ•°æ®æ‹‰å–ï¼Œé¿å…æ­»å¾ªç¯
            if (currentViewState === targetView) {
                if (targetView !== 'COUNTRY') return;
                var targetCode = (initialCountryCode && /^[A-Z]{2}$/i.test(String(initialCountryCode))) ? String(initialCountryCode).trim().toUpperCase() : (currentDrawerCountry && currentDrawerCountry.code);
                if (targetCode && currentDrawerCountry && String(currentDrawerCountry.code || '').toUpperCase() === String(targetCode).toUpperCase()) return;
            }
            if (initialCountryCode && /^[A-Z]{2}$/i.test(String(initialCountryCode))) {
                var cc = String(initialCountryCode).trim().toUpperCase();
                currentDrawerCountry.code = cc;
                currentDrawerCountry.name = (countryNameMap && countryNameMap[cc]) ? (currentLang === 'zh' ? countryNameMap[cc].zh : countryNameMap[cc].en) : cc;
                try { window.currentUserCountry = cc; } catch (e) { /* ignore */ }
            }
            // æ›´æ–°å½“å‰è§†å›¾çŠ¶æ€
            currentViewState = targetView;
            
            // è·å–æ‰€æœ‰é¢æ¿å’Œ Tab æŒ‰é’®
            const panels = {
                global: document.getElementById('panel-global-view'),
                country: document.getElementById('panel-country-view'),
                ranking: document.getElementById('panel-ranking-view')
            };
            const tabs = document.querySelectorAll('.drawer-tab');
            
            // éšè—æ‰€æœ‰é¢æ¿
            Object.values(panels).forEach(panel => {
                if (panel) {
                    panel.classList.remove('active');
                    panel.classList.add('hidden');
                }
            });
            
            // ç§»é™¤æ‰€æœ‰ Tab çš„æ¿€æ´»çŠ¶æ€
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡é¢æ¿
            if (panels[view]) {
                panels[view].classList.remove('hidden');
                panels[view].classList.add('active');
            }
            
            // æ¿€æ´»å¯¹åº” Tab
            const activeTab = document.querySelector(`.drawer-tab[data-tab="${view}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // æ ¹æ®è§†å›¾ç±»å‹æ‰§è¡Œå¯¹åº”é€»è¾‘
            switch(view) {
                case 'global':
                    // å…¨çƒè§†å›¾ï¼šç”¨å·²å¯¹é½çš„ cachedSummary è§¦å‘ renderCardsStaggeredï¼Œç¡®ä¿å­—æ®µ fallback ä¸ Number() å·²ç”Ÿæ•ˆ
                    let globalCode = currentDrawerCountry && currentDrawerCountry.code ? currentDrawerCountry.code : null;
                    let globalName = currentDrawerCountry && currentDrawerCountry.name ? currentDrawerCountry.name : null;
                    if (!globalCode) {
                        const userCountry = window.currentUserCountry ||
                            (window.currentUser && (window.currentUser.country_code || window.currentUser.ip_location)) ||
                            (window.currentUserData && (window.currentUserData.country_code || window.currentUserData.ip_location)) ||
                            'US';
                        if (userCountry && /^[A-Z]{2}$/.test(String(userCountry).trim().toUpperCase())) {
                            globalCode = String(userCountry).trim().toUpperCase();
                            const countryInfo = countryNameMap[globalCode];
                            globalName = countryInfo ? (currentLang === 'zh' ? countryInfo.zh : countryInfo.en) : globalCode;
                        }
                    }
                    if (globalCode && globalName) {
                        // Global è§†å›¾åº”æ˜¾ç¤ºã€Œè¯¥å›½ã€å£å¾„ï¼šè°ƒæˆAIæ¬¡æ•°=è¯¥å›½ç”¨æˆ·ä¸AIå¯¹è¯æ€»æ¬¡æ•°ï¼Œå¹³å‡é•¿åº¦=è¯¥å›½äººå‡æ¯æ¬¡å¯¹è¯å­—ç¬¦æ•°ï¼Œå¹³å‡ç¯‡å¹…=è¯¥å›½äººå‡/å•æ¬¡å­—ç¬¦æ•°
                        if (typeof fetchCountrySummaryV3 === 'function') {
                            fetchCountrySummaryV3(globalCode).then(function (summary) {
                                if (summary && (summary.countryTotals || (summary.data && summary.data.countryTotals))) {
                                    showDrawersWithCountryData(globalCode, globalName, summary, { summaryOnly: true });
                                } else {
                                    showDrawersWithCountryData(globalCode, globalName, getLatestGlobalData(), { summaryOnly: true });
                                }
                            }).catch(function () {
                                showDrawersWithCountryData(globalCode, globalName, getLatestGlobalData(), { summaryOnly: true });
                            });
                        } else {
                            showDrawersWithCountryData(globalCode, globalName, getLatestGlobalData(), { summaryOnly: true });
                        }
                    }
                    break;
                    
                case 'country':
                    // å›½å®¶è§†å›¾ï¼šå•ä¸€è¯·æ±‚æºï¼Œä»…é€šè¿‡ switchToCountryView è§¦å‘ updateCountryDashboardï¼›æ­¤å¤„ä»…æ¸²æŸ“éª¨æ¶ï¼Œä¸é‡å¤è¯·æ±‚
                    const countryMount = document.getElementById('countryTemplateMount');
                    if (currentDrawerCountry.code && currentDrawerCountry.name) {
                        if (countryMount && !countryMount.innerHTML.trim() && !window.__renderingCountryView) {
                            window.__renderingCountryView = true;
                            switchToCountryView(currentDrawerCountry.code, currentDrawerCountry.name);
                            setTimeout(() => { window.__renderingCountryView = false; }, 100);
                        }
                    }
                    break;
                    
                case 'ranking':
                    // æ’è¡Œæ¦œè§†å›¾ï¼šæ¸²æŸ“å…­ä¸ªå¤©æ¢¯è¡¨
                    console.log('[switchView] è§¦å‘ ranking è§†å›¾');
                    console.log('[switchView] window.renderGlobalLadders:', typeof window.renderGlobalLadders);
                    console.log('[switchView] window.renderGreenLadders:', typeof window.renderGreenLadders);
                    console.log('[switchView] window.stats2AppLoaded:', window.stats2AppLoaded);
                    renderRankingView();
                    break;
            }
            
            console.log('[switchView] å·²åˆ‡æ¢åˆ°:', view);
        }

        /**
         * ã€æ–°å¢ã€‘æ¸²æŸ“æ’è¡Œæ¦œè§†å›¾
         * ä½¿ç”¨ drawHighScores å‡½æ•°æ¸²æŸ“å…­ä¸ªå¤©æ¢¯è¡¨åˆ°æ’è¡Œæ¦œå®¹å™¨
         */
        function renderRankingView() {
            console.log('[renderRankingView] å¼€å§‹æ¸²æŸ“æ’è¡Œæ¦œè§†å›¾');
            
            var gridsEl = document.querySelector('#panel-ranking-view #global-ranking-grids') || document.getElementById('global-ranking-grids');
            console.log('[renderRankingView] gridsEl:', gridsEl);
            if (gridsEl) {
                gridsEl.innerHTML = '<div class="col-span-full text-center text-[#00ff41] text-sm py-6">åŠ è½½ä¸­...</div>';
            }
            
            // è¯¦ç»†è°ƒè¯•ä¿¡æ¯
            console.log('[renderRankingView] window.renderGlobalLadders:', typeof window.renderGlobalLadders);
            console.log('[renderRankingView] window.renderGreenLadders:', typeof window.renderGreenLadders);
            console.log('[renderRankingView] typeof renderGreenLadders:', typeof renderGreenLadders);
            console.log('[renderRankingView] window.stats2AppLoaded:', window.stats2AppLoaded);
            
            var loadRanking = (window.renderGlobalLadders || window.renderGreenLadders || (typeof renderGreenLadders === 'function' ? renderGreenLadders : null));
            console.log('[renderRankingView] loadRanking:', typeof loadRanking);
            
            if (typeof loadRanking === 'function') {
                console.log('[renderRankingView] æ‰¾åˆ°æ’è¡Œæ¦œå‡½æ•°ï¼Œå¼€å§‹æ¸²æŸ“...');
                var fn = loadRanking === window.renderGlobalLadders ? function() { return window.renderGlobalLadders(); } : function() { return (window.renderGreenLadders || renderGreenLadders)(true); };
                fn().then(function() {
                    console.log('[renderRankingView] æ¸²æŸ“æˆåŠŸ');
                }).catch(function(err) {
                    console.error('[renderRankingView] æ¸²æŸ“å…­ä¸ªå…¨çƒæ’è¡Œæ¦œå¤±è´¥:', err);
                    if (gridsEl) gridsEl.innerHTML = '<div class="col-span-full text-center text-red-400 text-sm py-4">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                });
            } else {
                console.error('[renderRankingView] æœªæ‰¾åˆ°æ’è¡Œæ¦œå‡½æ•°ï¼');
                console.log('[renderRankingView] è¯·æ£€æŸ¥ stats2.app.js æ˜¯å¦æ­£ç¡®åŠ è½½');
                if (gridsEl) gridsEl.innerHTML = '<div class="col-span-full text-center text-zinc-500 text-sm py-4">æ’è¡Œæ¦œè„šæœ¬æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢</div>';
            }
            
            var topBy = window.lastData && window.lastData.topByMetrics ? window.lastData.topByMetrics : [];
            var vibeContainer = document.querySelector('#panel-ranking-view .vibe-index-leaderboard');
            if (!topBy.length) {
                if (vibeContainer) {
                    vibeContainer.innerHTML = '<div class="text-zinc-500 text-xs text-center py-8">æš‚æ— é«˜åˆ†å›¾è°±æ•°æ®</div>';
                }
            } else {
                if (typeof drawHighScores === 'function') {
                    drawHighScores(topBy);
                }
            }
            
            console.log('[renderRankingView] æ’è¡Œæ¦œæ¸²æŸ“å®Œæˆ');
        }

        // ==========================================
        // çŸ©é˜µç»¿å¤©æ¢¯æ¦œç›¸å…³å‡½æ•°å’Œå¸¸é‡
        // ==========================================

        const MATRIX_LADDER_TYPES = [
            { key: 'ketao_count', label: 'ç£•å¤´æ¦œ', field: 'ketao_count', desc: 'é¡¶çº§ç¤¼è²Œå¤§æˆ·' },
            { key: 'jiafang_count', label: 'éœ¸æ€»æ¦œ', field: 'jiafang_count', desc: 'å¯¹ AI æé™å¦å®š' },
            { key: 'work_days', label: 'æ‰“å·¥æ¦œ', field: 'work_days', desc: 'ä¸Šå²—å¤©æ•°' },
            { key: 'total_messages', label: 'è¯ç—¨æ¦œ', field: 'total_messages', desc: 'å¯¹è¯å›åˆ' },
            { key: 'avg_user_message_length', label: 'çº ç»“æ¦œ', field: 'avg_user_message_length', desc: 'å•æ¬¡æŒ‡ä»¤åšåº¦' },
            { key: 'total_chars', label: 'ç¤¾ç•œæ¦œ', field: 'total_chars', desc: 'Token éœ¸æƒ' }
        ];

        /**
         * æ¸²æŸ“å…¨å±€çŸ©é˜µç»¿å¤©æ¢¯æ¦œï¼ˆå¼ºåˆ¶é™æ€æŒ‚è½½ï¼Œæ— æ¡ä»¶æ‰§è¡Œï¼‰
         * ä¼˜å…ˆå†™å…¥å³ä¾§ Ranking è§†å›¾çš„ ladders-containerï¼Œå¦åˆ™å†™å…¥å·¦ä¾§ global-ranking-area
         */
        async function renderGlobalLadders() {
            console.log('[MatrixLadders] ğŸš€ renderGlobalLadders è¢«è°ƒç”¨');
            let isRankingLoading = true;
            const container = document.getElementById('ladders-container') || document.getElementById('global-ranking-area');
            console.log('[MatrixLadders] container:', container?.id);
            const contentTarget = (container && container.id === 'ladders-container')
                ? (container.querySelector('#global-ranking-grids') || container)
                : container;
            console.log('[MatrixLadders] contentTarget:', contentTarget?.id || contentTarget?.className);

            if (!container || !contentTarget) {
                console.warn('[MatrixLadders] âš ï¸ ladders-container / global-ranking-area ä¸å­˜åœ¨ï¼Œç­‰å¾… DOM å°±ç»ª');
                isRankingLoading = false;
                setTimeout(() => {
                    renderGlobalLadders().catch(err => console.error('[MatrixLadders] é‡è¯•å¤±è´¥:', err));
                }, 500);
                return;
            }
            console.log('[MatrixLadders] âœ… æ‰¾åˆ°å®¹å™¨ï¼Œå¼€å§‹åŠ è½½æ•°æ®');

            // å¼ºåˆ¶æ¸…ç©ºå¹¶æ˜¾ç¤ºåŠ è½½æ€ï¼ˆç‚¹å‡»åˆ·æ–°å¿…é¡»é‡æ–° fetchï¼Œä¸ä¾èµ–å·²æœ‰å†…å®¹ï¼‰
            contentTarget.innerHTML = '<div class="col-span-full text-green-500 animate-pulse">>> æ­£åœ¨åŒæ­¥å…¨çƒæ•°æ®æµ...</div>';

            const useRankingPanel = (container.id === 'ladders-container');
            if (useRankingPanel && typeof fetchGlobalRankings === 'function') {
                try {
                    const rankings = await fetchGlobalRankings(10, true);
                    isRankingLoading = false;
                    if (!rankings) {
                        contentTarget.innerHTML = '<div class="col-span-full text-center text-red-400 text-sm">åŠ è½½å¤±è´¥</div>';
                        return;
                    }
                    renderGreenLaddersToContainer(contentTarget, rankings);
                    console.log('[MatrixLadders] âœ… Ranking è§†å›¾å…­æ¦œæ¸²æŸ“å®Œæˆ');
                } catch (err) {
                    console.error('[MatrixLadders] âŒ Ranking è§†å›¾åŠ è½½å¤±è´¥:', err);
                    isRankingLoading = false;
                    contentTarget.innerHTML = '<div class="col-span-full text-center text-red-400 text-sm">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                }
                return;
            }

            // å·¦ä¾§æŠ½å±‰ï¼šç­‰å¾… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–ï¼ˆæœ€å¤š 10 ç§’ï¼‰
            let attempts = 0;
            while ((!supabaseClient || typeof supabaseClient.rpc !== 'function') && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            if (!supabaseClient || typeof supabaseClient.rpc !== 'function') {
                console.warn('[MatrixLadders] âš ï¸ Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–è¶…æ—¶ï¼Œä½¿ç”¨ç›´æ¥æŸ¥è¯¢');
                isRankingLoading = false;
                await renderMatrixLaddersFromDirectQuery(contentTarget);
                return;
            }

            try {
                // PostgREST å‚æ•°åä¸ SQL å‡½æ•°ä¸€è‡´ï¼šcountry_code / top_nï¼›å…¨å±€ä¼  null
                const { data, error } = await supabaseClient.rpc('get_country_top_metrics_v1', {
                    p_country_code: null,
                    p_top_n: 10
                });
                let rpcData = data;
                if (error && (!rpcData || !rpcData.length)) {
                    const alt = await supabaseClient.rpc('get_country_top_metrics_v1', { country_code: null, top_n: 10 });
                    if (!alt.error && alt.data && alt.data.length) rpcData = alt.data;
                }
                if (error && (!rpcData || !rpcData.length)) {
                    console.error('[MatrixLadders] âŒ RPC è°ƒç”¨å¤±è´¥:', error);
                    isRankingLoading = false;
                    await renderMatrixLaddersFromDirectQuery(contentTarget);
                    return;
                }
                if (!rpcData || !Array.isArray(rpcData) || rpcData.length === 0) {
                    console.warn('[MatrixLadders] âš ï¸ RPC è¿”å›ç©ºæ•°æ®ï¼Œä½¿ç”¨ç›´æ¥æŸ¥è¯¢');
                    isRankingLoading = false;
                    await renderMatrixLaddersFromDirectQuery(contentTarget);
                    return;
                }
                renderMatrixLaddersFromRPC(contentTarget, rpcData);
                isRankingLoading = false;
            } catch (err) {
                console.error('[MatrixLadders] âŒ åˆå§‹åŒ–å¤±è´¥:', err);
                isRankingLoading = false;
                contentTarget.innerHTML = '<div class="col-span-full text-center text-red-400 text-sm">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }
        window.renderGlobalLadders = renderGlobalLadders;
        console.log('[Stats2.App] âœ… renderGlobalLadders å·²æŒ‚è½½åˆ° window');

        /**
         * ä» RPC è¿”å›çš„æ•°æ®æ¸²æŸ“çŸ©é˜µç»¿å¤©æ¢¯æ¦œ
         */
        function renderMatrixLaddersFromRPC(container, rpcData) {
            container.innerHTML = '';

            MATRIX_LADDER_TYPES.forEach((ladderType) => {
                // ä» RPC æ•°æ®ä¸­æ‰¾åˆ°å¯¹åº”çš„ç»´åº¦æ•°æ®
                const keyMap = {
                    'work_days': ['work_days'],
                    'total_chars': ['total_chars'],
                    'jiafang_count': ['jiafang_count'],
                    'ketao_count': ['ketao_count'],
                    'total_messages': ['total_messages'],
                    'avg_user_message_length': ['avg_user_message_length']
                };
                
                const possibleKeys = keyMap[ladderType.key] || [ladderType.field];
                const metricData = rpcData.find(m => {
                    const mKey = m.key || m.col || '';
                    return possibleKeys.includes(mKey);
                });

                if (!metricData || !metricData.leaders || !Array.isArray(metricData.leaders) || metricData.leaders.length === 0) {
                    renderEmptyMatrixLadder(container, ladderType);
                    return;
                }

                const leaders = metricData.leaders.slice(0, 10);
                renderMatrixLadderTable(container, ladderType, leaders);
            });
        }

        /**
         * ç›´æ¥ä» Supabase æŸ¥è¯¢æ¸²æŸ“çŸ©é˜µç»¿å¤©æ¢¯æ¦œï¼ˆé™çº§æ–¹æ¡ˆï¼‰
         */
        async function renderMatrixLaddersFromDirectQuery(container) {
            container.innerHTML = '<div class="col-span-full text-green-500 animate-pulse text-center py-6">>> æ­£åœ¨åŒæ­¥å…¨çƒæ•°æ®æµ...</div>';

            try {
                const promises = MATRIX_LADDER_TYPES.map(async (ladderType) => {
                    try {
                        // åŒ…å« country_code å’Œ vibe_index_str å­—æ®µä»¥æ”¯æŒå›½æ——å’Œäººæ ¼ç§°å·æ˜¾ç¤º
                        // æ³¨æ„ï¼šgithub_username å­—æ®µåœ¨ user_analysis è¡¨ä¸­ä¸å­˜åœ¨ï¼Œä½¿ç”¨ user_name ä»£æ›¿
                        let selectFields = 'id, fingerprint, user_name, country_code, vibe_index_str, ' + ladderType.field;
                        
                        let query = supabaseClient
                            .from('user_analysis')
                            .select(selectFields)
                            .not(ladderType.field, 'is', null)
                            .gt(ladderType.field, 0)
                            .order(ladderType.field, { ascending: false })
                            .limit(10);

                        const { data, error } = await query;
                        if (error) throw error;

                        return {
                            type: ladderType,
                            leaders: (data || []).map((item, idx) => {
                                const countryCode = getRankingCountryCode(item.ip_location, item.country_code);
                                const vibeIndexStr = item.vibe_index_str || '';
                                const personalityTitle = getPersonalityTitle(vibeIndexStr, item.user_identity);
                                return {
                                    rank: idx + 1,
                                    score: item[ladderType.field] || 0,
                                    countryCode: countryCode,
                                    vibe_index_str: vibeIndexStr,
                                    personality_title: personalityTitle,
                                    user: {
                                        fingerprint: item.fingerprint || '',
                                        user_name: item.user_name || '',
                                        github_username: item.user_name || '' // ä½¿ç”¨ user_name ä½œä¸º github_username çš„æ›¿ä»£
                                    }
                                };
                            })
                        };
                    } catch (err) {
                        console.error(`[MatrixLadders] âŒ æŸ¥è¯¢ ${ladderType.key} å¤±è´¥:`, err);
                        return { type: ladderType, leaders: [] };
                    }
                });

                const results = await Promise.all(promises);
                container.innerHTML = '';

                results.forEach(result => {
                    if (result.leaders && result.leaders.length > 0) {
                        renderMatrixLadderTable(container, result.type, result.leaders);
                    } else {
                        renderEmptyMatrixLadder(container, result.type);
                    }
                });
            } catch (err) {
                console.error('[MatrixLadders] âŒ ç›´æ¥æŸ¥è¯¢å¤±è´¥:', err);
                container.innerHTML = '<div class="col-span-full text-center text-red-400 text-sm py-4">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        /**
         * æ¸²æŸ“å•ä¸ªçŸ©é˜µç»¿å¤©æ¢¯æ¦œè¡¨æ ¼
         */
        function renderMatrixLadderTable(container, ladderType, leaders) {
            const card = document.createElement('div');
            card.className = 'matrix-ladder-card';

            const rows = leaders.map(leader => {
                const user = leader.user || {};
                const fingerprint = user.fingerprint || '';
                // å¤´åƒä¸ç”¨æˆ·ååŒæºï¼šä¼˜å…ˆ github_usernameï¼ˆGitHub å±•ç¤ºï¼‰ï¼Œå¦åˆ™ user_nameï¼Œé¿å…ç¬¬ä¸€åå¤´åƒå’Œåå­—å¼„æ··
                const canonicalName = (user.github_username && String(user.github_username).trim()) || (user.user_name && String(user.user_name).trim()) || '';
                const display = canonicalName ? `@${canonicalName}` : `user_${(fingerprint || '').slice(0, 6)}`;
                const avatar = (user.user_identity === 'github' && canonicalName)
                    ? `https://github.com/${encodeURIComponent(canonicalName)}.png?size=64`
                    : DEFAULT_AVATAR;

                const value = ladderType.key === 'avg_user_message_length' 
                    ? Number(leader.score || 0).toFixed(1)
                    : Number(leader.score || 0).toLocaleString();

                // å›½æ——å’Œäººæ ¼ç§°å·
                const flagEmoji = (typeof countryCodeToFlagEmoji === 'function' && leader.countryCode) ? countryCodeToFlagEmoji(leader.countryCode) : '';
                const personalityTitle = escapeHtml(leader.personality_title || leader.vibe_index_str || '--');

                return `
                    <tr>
                        <td>${leader.rank || ''}</td>
                        <td>
                            <img 
                                src="${escapeHtml(avatar)}" 
                                alt="" 
                                class="matrix-avatar"
                                onclick="handleMatrixAvatarClick('${escapeHtml(fingerprint)}')"
                                onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                            />
                        </td>
                        <td class="truncate max-w-[100px]" title="${escapeHtml(display)}">${escapeHtml(display)}</td>
                        <td class="truncate max-w-[100px]" title="${personalityTitle}">${flagEmoji ? flagEmoji + ' ' : ''}${personalityTitle}</td>
                        <td class="text-right">${value}</td>
                    </tr>
                `;
            }).join('');

            card.innerHTML = `
                <div class="matrix-ladder-title">${ladderType.label}</div>
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th class="text-right w-10">æ’å</th>
                            <th class="w-8">å¤´åƒ</th>
                            <th>ç”¨æˆ·å</th>
                            <th>ç§°å·</th>
                            <th class="text-right">æ•°å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;

            container.appendChild(card);
        }

        /**
         * æ¸²æŸ“ç©ºçš„çŸ©é˜µç»¿å¤©æ¢¯æ¦œï¼ˆæ— æ•°æ®ï¼‰
         */
        function renderEmptyMatrixLadder(container, ladderType) {
            const card = document.createElement('div');
            card.className = 'matrix-ladder-card';
            card.innerHTML = `
                <div class="matrix-ladder-title">${ladderType.label}</div>
                <div class="text-green-400/50 text-xs text-center py-4">æš‚æ— æ•°æ®</div>
            `;
            container.appendChild(card);
        }

        /**
         * è·å–å…¨å±€æ’è¡Œæ¦œæ•°æ®
         */
        async function fetchGlobalRankings(topN = 10, forceRefresh = false) {
            console.log('[GlobalRankings] ğŸš€ fetchGlobalRankings è¢«è°ƒç”¨, topN:', topN, 'forceRefresh:', forceRefresh);
            try {
                if (!forceRefresh && __globalRankingsCache.data && (Date.now() - __globalRankingsCache.ts) < __globalRankingsCacheTtlMs) {
                    console.log('[GlobalRankings] âœ… è¿”å›ç¼“å­˜æ•°æ®');
                    return __globalRankingsCache.data;
                }
                if (!supabaseClient || typeof supabaseClient.from !== 'function') {
                    console.warn('[GlobalRankings] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–, supabaseClient:', typeof supabaseClient);
                    // è¿”å›ç©ºæ’è¡Œæ¦œç»“æ„ï¼Œè€Œä¸æ˜¯ null
                    return {
                        ketao_count: { key: 'ketao_count', data: [], label: 'ç£•å¤´æ¦œ', desc: 'é¡¶çº§ç¤¼è²Œå¤§æˆ·' },
                        jiafang_count: { key: 'jiafang_count', data: [], label: 'éœ¸æ€»æ¦œ', desc: 'å¯¹ AI æé™å¦å®š' },
                        work_days: { key: 'work_days', data: [], label: 'æ‰“å·¥æ¦œ', desc: 'ä¸Šå²—å¤©æ•°' },
                        total_messages: { key: 'total_messages', data: [], label: 'è¯ç—¨æ¦œ', desc: 'å¯¹è¯å›åˆ' },
                        avg_user_message_length: { key: 'avg_user_message_length', data: [], label: 'çº ç»“æ¦œ', desc: 'å•æ¬¡æŒ‡ä»¤åšåº¦' },
                        total_chars: { key: 'total_chars', data: [], label: 'ç¤¾ç•œæ¦œ', desc: 'Token éœ¸æƒ' }
                    };
                }
                console.log('[GlobalRankings] âœ… Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–ï¼Œå¼€å§‹ä» v_unified_analysis_v2 è·å–æ’è¡Œæ¦œæ•°æ®');

                // å®šä¹‰6ä¸ªç»´åº¦çš„é…ç½®ï¼ˆä¸ rank-content.ts å¯¹é½ï¼šç£•å¤´æ¦œï¼Œéœ¸æ€»æ¦œï¼Œæ‰“å·¥æ¦œï¼Œè¯ç—¨æ¦œï¼Œçº ç»“æ¦œï¼Œç¤¾ç•œæ¦œï¼‰
                const dimensions = [
                    { key: 'ketao_count', label: 'ç£•å¤´æ¦œ', field: 'ketao_count', desc: 'é¡¶çº§ç¤¼è²Œå¤§æˆ·' },
                    { key: 'jiafang_count', label: 'éœ¸æ€»æ¦œ', field: 'jiafang_count', desc: 'å¯¹ AI æé™å¦å®š' },
                    { key: 'work_days', label: 'æ‰“å·¥æ¦œ', field: 'work_days', desc: 'ä¸Šå²—å¤©æ•°' },
                    { key: 'total_messages', label: 'è¯ç—¨æ¦œ', field: 'total_messages', desc: 'å¯¹è¯å›åˆ' },
                    { key: 'avg_user_message_length', label: 'çº ç»“æ¦œ', field: 'avg_user_message_length', desc: 'å•æ¬¡æŒ‡ä»¤åšåº¦' },
                    { key: 'total_chars', label: 'ç¤¾ç•œæ¦œ', field: 'total_chars', desc: 'Token éœ¸æƒ' }
                ];

                const rankings = {};

                // å¹¶è¡Œè·å–æ‰€æœ‰ç»´åº¦çš„æ’è¡Œæ¦œï¼ˆå¢å¼ºå®¹é”™ï¼šå•ä¸ªç»´åº¦å¤±è´¥ä¸å½±å“å…¶ä»–ç»´åº¦ï¼‰
                const promises = dimensions.map(async (dim) => {
                    try {
                        // ä» v_unified_analysis_v2 è¡¨æŸ¥è¯¢ï¼ˆå…¨çƒæ¦œå•ï¼‰
                        // åŸºç¡€å­—æ®µå« manual_locationï¼šå±•ç¤ºã€Œç”¨æˆ·æœ€åé€‰æ‹©çš„å›½ç±ã€
                        let selectFields = 'id, fingerprint, user_name, user_identity, country_code, manual_location, vibe_index_str';
                        
                        // å¯¹äº avg_user_message_lengthï¼Œéœ€è¦è®¡ç®—ï¼Œæ‰€ä»¥éœ€è¦ total_chars å’Œ total_messages
                        if (dim.key === 'avg_user_message_length') {
                            selectFields += ', total_chars, total_messages';
                        } else {
                            // ç¡®ä¿å­—æ®µåä½¿ç”¨å°å†™ä¸‹åˆ’çº¿æ ¼å¼
                            selectFields += ', ' + dim.field;
                        }

                        let query = supabaseClient
                            .from('v_unified_analysis_v2')
                            .select(selectFields);

                        // å¯¹äº avg_user_message_lengthï¼Œéœ€è¦è¿‡æ»¤æœ‰æœ‰æ•ˆæ•°æ®çš„è®°å½•
                        if (dim.key === 'avg_user_message_length') {
                            query = query
                                .not('total_messages', 'is', null)
                                .gt('total_messages', 0)
                                .not('total_chars', 'is', null)
                                .gt('total_chars', 0);
                        } else {
                            // ç¡®ä¿å­—æ®µåä½¿ç”¨å°å†™ä¸‹åˆ’çº¿æ ¼å¼ï¼Œè¿‡æ»¤ null å’Œ 0 å€¼
                            query = query
                                .not(dim.field, 'is', null)
                                .gt(dim.field, 0);
                        }

                        // æ’åºå­—æ®µä¹Ÿä½¿ç”¨å°å†™ä¸‹åˆ’çº¿æ ¼å¼ï¼Œä½¿ç”¨ nullsFirst: false ç¡®ä¿æœ‰æ•°æ®çš„æ’åœ¨å‰é¢
                        const orderField = dim.key === 'avg_user_message_length' ? 'total_chars' : dim.field;
                        query = query.order(orderField, { ascending: false, nullsFirst: false })
                            .limit(topN);

                        const { data, error } = await query;

                        if (error) {
                            console.error(`[GlobalRankings] âŒ è·å– ${dim.key} æ’è¡Œæ¦œå¤±è´¥:`, error);
                            console.error(`[GlobalRankings] é”™è¯¯è¯¦æƒ…:`, error.message, error.code, error.details);
                            console.error(`[GlobalRankings] æŸ¥è¯¢å­—æ®µ:`, selectFields);
                            // è¿”å›ç©ºæ•°ç»„ï¼Œè€Œä¸æ˜¯ nullï¼Œä¸ä¸­æ–­å…¶ä»–å¡ç‰‡çš„åŠ è½½
                            return { key: dim.key, data: [], label: dim.label, desc: dim.desc };
                        }

                        // ä¸¥æ ¼å®¹é”™å¤„ç†ï¼šå¦‚æœ data ä¸ºç©ºæˆ–ä¸æ˜¯æ•°ç»„ï¼Œè¿”å›ç©ºæ•°ç»„
                        if (!data || !Array.isArray(data) || data.length === 0) {
                            console.warn(`[GlobalRankings] âš ï¸ ${dim.key} æ’è¡Œæ¦œæ•°æ®ä¸ºç©º`);
                            return { key: dim.key, data: [], label: dim.label, desc: dim.desc };
                        }

                        // å¤„ç†æ•°æ®ï¼Œæ·»åŠ æ’åå’Œç”¨æˆ·ä¿¡æ¯
                        let processedData = data.map((item, index) => {
                            try {
                                // å®‰å…¨è·å–å­—æ®µå€¼ï¼Œå¤„ç† null/undefined
                                const user_name = (item.user_name && String(item.user_name).trim()) || '';
                                const user_identity = (item.user_identity && String(item.user_identity).trim()) || '';
                                const fingerprint = (item.fingerprint && String(item.fingerprint)) || '';
                                // æ¦œå•å›½ç±ï¼šä¼˜å…ˆç”¨æˆ·æœ€åé€‰æ‹©çš„å›½ç±ï¼ˆmanual_locationï¼Œä»… ISO2 ä¸¤å­—æ¯æ—¶é‡‡ç”¨ï¼‰ï¼Œå¦åˆ™ country_codeï¼Œå…¨çƒæ¦œå•ç»Ÿä¸€
                                const manual_loc = (item.manual_location && String(item.manual_location).trim()) || '';
                                const country_code_raw = item.country_code;
                                const country_code_fallback = (country_code_raw && String(country_code_raw).trim()) || (country_code_raw === null ? 'UN' : '');
                                const country_code = (manual_loc.length === 2 && /^[A-Za-z]{2}$/.test(manual_loc)) ? manual_loc.toUpperCase() : country_code_fallback;
                                // vibe_index_str ä½œä¸ºç§°å·/ç»´åº¦æ˜¾ç¤º
                                const vibe_index_str = (item.vibe_index_str && String(item.vibe_index_str).trim()) || '';

                                // å¤´åƒä¸ç”¨æˆ·ååŒæºï¼šåŒä¸€è¡Œåªç”¨åŒä¸€ identityï¼Œé¿å…ç¬¬ä¸€åå¤´åƒå’Œåå­—å¼„æ··
                                const displayName = user_name || `user_${fingerprint.slice(0, 6)}`;
                                const display = user_name ? `@${user_name}` : `user_${fingerprint.slice(0, 6)}`;

                                let avatar = DEFAULT_AVATAR;
                                if (user_identity === 'github' && displayName) {
                                    avatar = `https://github.com/${encodeURIComponent(displayName)}.png?size=64`;
                                }

                                // è®¡ç®— avg_user_message_length
                                let value = 0;
                                if (dim.key === 'avg_user_message_length') {
                                    const totalMessages = Number(item.total_messages || 0);
                                    const totalChars = Number(item.total_chars || 0);
                                    value = totalMessages > 0 ? (totalChars / totalMessages) : 0;
                                } else {
                                    // å®‰å…¨è·å–å­—æ®µå€¼
                                    const fieldValue = item[dim.field];
                                    value = (fieldValue !== null && fieldValue !== undefined) ? Number(fieldValue) : 0;
                                }

                                const countryCode = country_code || 'UN';
                                
                                // è·å–å›½æ—— Emojiï¼ˆä½¿ç”¨ getFlagEmoji å‡½æ•°ï¼Œæœ‰ fallback é€»è¾‘ï¼‰
                                const flagEmoji = typeof getFlagEmoji === 'function' ? getFlagEmoji(countryCode) : '';
                                
                                // è·å–äººæ ¼ç§°å·ï¼šä½¿ç”¨ vibe_index_str ä½œä¸ºç§°å·/ç»´åº¦æ˜¾ç¤º
                                // getPersonalityTitle å‡½æ•°ç­¾åæ˜¯ getPersonalityTitle(item, lang)ï¼Œéœ€è¦é€‚é…
                                let personalityTitle = vibe_index_str || '--';
                                if (typeof getPersonalityTitle === 'function' && vibe_index_str) {
                                    try {
                                        // å°è¯•å°† vibe_index_str ä½œä¸º item å¯¹è±¡ä¼ å…¥
                                        const titleResult = getPersonalityTitle({ vibe_index_str: vibe_index_str, user_identity: user_identity }, currentLang || 'zh');
                                        if (titleResult && titleResult.trim()) {
                                            personalityTitle = titleResult;
                                        }
                                    } catch (titleErr) {
                                        // å¦‚æœè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨ vibe_index_str
                                        console.warn(`[GlobalRankings] getPersonalityTitle è°ƒç”¨å¤±è´¥:`, titleErr);
                                    }
                                }

                                return {
                                    rank: index + 1,
                                    fingerprint: fingerprint,
                                    username: display,
                                    avatar: avatar,
                                    github_username: (user_identity === 'github' ? user_name : '') || '',
                                    user_name: user_name,
                                    value: value,
                                    user_identity: user_identity || null,
                                    vibe_index_str: vibe_index_str,
                                    personality_title: personalityTitle,
                                    countryCode: countryCode,
                                    manual_location: manual_loc || null,
                                    country_code: country_code,
                                    flagEmoji: flagEmoji
                                };
                            } catch (itemErr) {
                                console.error(`[GlobalRankings] âŒ å¤„ç† ${dim.key} æ’è¡Œæ¦œé¡¹æ—¶å‡ºé”™:`, itemErr, item);
                                // è¿”å›ä¸€ä¸ªå®‰å…¨çš„é»˜è®¤é¡¹
                                return {
                                    rank: index + 1,
                                    fingerprint: (item.fingerprint && String(item.fingerprint)) || '',
                                    username: '--',
                                    avatar: DEFAULT_AVATAR,
                                    github_username: '',
                                    user_name: '',
                                    value: 0,
                                    user_identity: null,
                                    vibe_index_str: '',
                                    personality_title: '--',
                                    countryCode: 'UN',
                                    flagEmoji: ''
                                };
                            }
                        }).filter(item => item !== null && item !== undefined); // è¿‡æ»¤æ‰æ— æ•ˆé¡¹

                        // å¯¹äº avg_user_message_lengthï¼Œéœ€è¦é‡æ–°æ’åº
                        if (dim.key === 'avg_user_message_length') {
                            processedData = processedData.sort((a, b) => b.value - a.value);
                            processedData = processedData.map((item, index) => ({ ...item, rank: index + 1 }));
                        }

                        return { key: dim.key, data: processedData, label: dim.label, desc: dim.desc };
                    } catch (err) {
                        console.error(`[GlobalRankings] âŒ å¤„ç† ${dim.key} æ—¶å‡ºé”™:`, err);
                        // è¿”å›ç©ºæ•°ç»„ï¼Œè€Œä¸æ˜¯ nullï¼Œä¸ä¸­æ–­å…¶ä»–å¡ç‰‡çš„åŠ è½½
                        return { key: dim.key, data: [], label: dim.label, desc: dim.desc };
                    }
                });

                const results = await Promise.all(promises);
                results.forEach(result => {
                    rankings[result.key] = result;
                });
                
                // ç¡®ä¿æ‰€æœ‰ç»´åº¦éƒ½æœ‰æ•°æ®ï¼ˆå³ä½¿ä¸ºç©ºæ•°ç»„ï¼‰
                dimensions.forEach(dim => {
                    if (!rankings[dim.key]) {
                        rankings[dim.key] = { key: dim.key, data: [], label: dim.label, desc: dim.desc };
                    }
                });
                
                __globalRankingsCache = { data: rankings, ts: Date.now() };
                console.log('[GlobalRankings] âœ… æ•°æ®è·å–æˆåŠŸ:', Object.keys(rankings));
                return rankings;
            } catch (error) {
                console.error('[GlobalRankings] âŒ è·å–å…¨å±€æ’è¡Œæ¦œå¤±è´¥:', error);
                // è¿”å›ç©ºæ’è¡Œæ¦œç»“æ„ï¼Œè€Œä¸æ˜¯ nullï¼Œç¡®ä¿ UI èƒ½æ­£å¸¸æ¸²æŸ“
                return {
                    ketao_count: { key: 'ketao_count', data: [], label: 'ç£•å¤´æ¦œ', desc: 'é¡¶çº§ç¤¼è²Œå¤§æˆ·' },
                    jiafang_count: { key: 'jiafang_count', data: [], label: 'éœ¸æ€»æ¦œ', desc: 'å¯¹ AI æé™å¦å®š' },
                    work_days: { key: 'work_days', data: [], label: 'æ‰“å·¥æ¦œ', desc: 'ä¸Šå²—å¤©æ•°' },
                    total_messages: { key: 'total_messages', data: [], label: 'è¯ç—¨æ¦œ', desc: 'å¯¹è¯å›åˆ' },
                    avg_user_message_length: { key: 'avg_user_message_length', data: [], label: 'çº ç»“æ¦œ', desc: 'å•æ¬¡æŒ‡ä»¤åšåº¦' },
                    total_chars: { key: 'total_chars', data: [], label: 'ç¤¾ç•œæ¦œ', desc: 'Token éœ¸æƒ' }
                };
            }
        }

        /**
         * æ¸²æŸ“å…­ä¸ªç»¿è‰²ä¸»é¢˜æ’è¡Œæ¦œè¡¨æ ¼
         */
        async function renderGreenLadders(forceRefresh) {
            console.log('[GreenLadders] ğŸš€ renderGreenLadders è¢«è°ƒç”¨, forceRefresh:', forceRefresh);
            // ä¼˜å…ˆä½¿ç”¨ ranking æ ‡ç­¾å†…çš„å®¹å™¨ï¼Œé¿å…ä¸å…¶å®ƒé¢æ¿å†²çª
            const container = document.querySelector('#panel-ranking-view #global-ranking-grids') || document.getElementById('global-ranking-grids');
            console.log('[GreenLadders] container:', container);
            if (!container) {
                console.warn('[GreenLadders] âš ï¸ global-ranking-grids å®¹å™¨ä¸å­˜åœ¨');
                return;
            }
            console.log('[GreenLadders] âœ… æ‰¾åˆ°å®¹å™¨');

            if (!forceRefresh && __globalRankingsCache.data && (Date.now() - __globalRankingsCache.ts) < __globalRankingsCacheTtlMs) {
                renderGreenLaddersToContainer(container, __globalRankingsCache.data);
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            container.innerHTML = '<div class="col-span-full text-center text-[#00ff41] text-sm py-6">åŠ è½½ä¸­...</div>';

            try {
                const rankings = await fetchGlobalRankings(10, !!forceRefresh);
                if (!rankings) {
                    container.innerHTML = '<div class="col-span-full text-center text-red-400 text-sm">åŠ è½½å¤±è´¥</div>';
                    return;
                }
                renderGreenLaddersToContainer(container, rankings);
                console.log('[GreenLadders] âœ… å…­ä¸ªæ’è¡Œæ¦œæ¸²æŸ“å®Œæˆ');
            } catch (error) {
                console.error('[GreenLadders] âŒ æ¸²æŸ“æ’è¡Œæ¦œå¤±è´¥:', error);
                container.innerHTML = '<div class="col-span-full text-center text-red-400 text-sm">æ¸²æŸ“å¤±è´¥</div>';
            }
        }

        function renderGreenLaddersToContainer(container, rankings) {
            console.log('[GreenLaddersToContainer] ğŸš€ æ¸²æŸ“å®¹å™¨:', container?.id || container);
            console.log('[GreenLaddersToContainer] rankings:', rankings ? Object.keys(rankings) : null);
            // å…­ç»´ä¸ rank-content æ–‡æ¡ˆå¯¹é½ï¼šç£•å¤´æ¦œï¼Œéœ¸æ€»æ¦œï¼Œæ‰“å·¥æ¦œï¼Œè¯ç—¨æ¦œï¼Œçº ç»“æ¦œï¼Œç¤¾ç•œæ¦œ
            const dimensionOrder = [
                { key: 'ketao_count', label: 'ç£•å¤´æ¦œ', desc: 'é¡¶çº§ç¤¼è²Œå¤§æˆ·', unit: 'Total Pts' },
                { key: 'jiafang_count', label: 'éœ¸æ€»æ¦œ', desc: 'å¯¹ AI æé™å¦å®š', unit: 'Total Pts' },
                { key: 'work_days', label: 'æ‰“å·¥æ¦œ', desc: 'ä¸Šå²—å¤©æ•°', unit: 'Days' },
                { key: 'total_messages', label: 'è¯ç—¨æ¦œ', desc: 'å¯¹è¯å›åˆ', unit: 'Messages' },
                { key: 'avg_user_message_length', label: 'çº ç»“æ¦œ', desc: 'å•æ¬¡æŒ‡ä»¤åšåº¦', unit: 'Chars/Msg' },
                { key: 'total_chars', label: 'ç¤¾ç•œæ¦œ', desc: 'Token éœ¸æƒ', unit: 'Total Chars' }
            ];
            
            // ç”¨æˆ·èº«ä»½æ˜¾ç¤ºæ–‡æœ¬æ˜ å°„
            const identityLabelMap = {
                'github': 'GitHub User',
                'fingerprint': 'åŒ¿å',
                '': 'åŒ¿å'
            };
            
            // å¼ºåˆ¶æ¸…ç©ºå®¹å™¨ï¼Œç¡®ä¿åˆ·æ–°æ—¶é‡æ–°æ¸²æŸ“
            container.innerHTML = '<div class="col-span-full text-green-500 animate-pulse text-center py-6">>> æ­£åœ¨åŒæ­¥å…¨çƒæ•°æ®æµ...</div>';
            let html = '';
            dimensionOrder.forEach((dim) => {
                const rankingData = rankings[dim.key];
                if (!rankingData || !rankingData.data || rankingData.data.length === 0) {
                    html += `
                        <div class="border border-green-500/30 bg-gray-900/50 p-4" style="width: 100%;">
                            <div class="text-[#00ff41] text-xs font-mono mb-2 bg-[#003b00]/50 px-3 py-2">${dim.label}</div>
                            <div class="text-zinc-500 text-xs text-center py-4">æš‚æ— æ•°æ®</div>
                        </div>
                    `;
                    return;
                }
                // ç”Ÿæˆå•è¡Œ Grid å¸ƒå±€çš„åˆ—è¡¨é¡¹ï¼ˆé‡‘èAppæ¦œå•é£æ ¼ï¼‰
                const rows = rankingData.data.map((item, index) => {
                    // å®‰å…¨å¤„ç†æ•°å€¼ï¼Œå®¹é”™å¤„ç†ï¼Œç¡®ä¿æ¯ä¸‰ä½æœ‰é€—å·åˆ†éš”
                    const itemValue = item.value !== null && item.value !== undefined ? Number(item.value) : 0;
                    let value = '';
                    if (dim.key === 'avg_user_message_length') {
                        value = isNaN(itemValue) ? '0.0' : itemValue.toFixed(1);
                    } else {
                        // ç¡®ä¿æ•°å­—æ¯ä¸‰ä½æœ‰é€—å·åˆ†éš”
                        value = isNaN(itemValue) ? '0' : itemValue.toLocaleString('en-US');
                    }
                    
                    // å®‰å…¨å¤„ç†ç”¨æˆ·åï¼Œå®¹é”™å¤„ç†ï¼ˆä½¿ç”¨ user_nameï¼Œä¸æ˜¯ usernameï¼‰
                    const user_name = (item.user_name && String(item.user_name).trim()) || '';
                    
                    // å®‰å…¨å¤„ç†æŒ‡çº¹ï¼Œå®¹é”™å¤„ç†
                    const fingerprint = (item.fingerprint && String(item.fingerprint).trim()) || '';
                    
                    // å®‰å…¨å¤„ç†æ’åï¼Œå®¹é”™å¤„ç†
                    const rank = (item.rank !== null && item.rank !== undefined) ? Number(item.rank) : (index + 1);
                    
                    // ç”¨æˆ·èº«ä»½
                    const user_identity = (item.user_identity && String(item.user_identity).trim()) || '';
                    
                    // å¤´åƒé€»è¾‘ï¼šå¦‚æœ user_identity === 'github'ï¼Œä½¿ç”¨ GitHub å¤´åƒ
                    let avatar = DEFAULT_AVATAR;
                    if (user_identity === 'github' && user_name) {
                        avatar = `https://github.com/${encodeURIComponent(user_name)}.png?size=64`;
                    } else if (item.avatar && String(item.avatar).trim()) {
                        avatar = String(item.avatar).trim();
                    }
                    
                    // æ¦œå•å›½ç±ï¼šä¼˜å…ˆç”¨æˆ·æœ€åé€‰æ‹©çš„å›½ç±ï¼ˆmanual_locationï¼Œä»… ISO2 æ—¶é‡‡ç”¨ï¼‰ï¼Œå† country_code
                    const manual_loc = (item.manual_location && String(item.manual_location).trim()) || '';
                    const fallback = (item.country_code && String(item.country_code).trim()) || (item.countryCode && String(item.countryCode).trim()) || null;
                    const country_code = (manual_loc.length === 2 && /^[A-Za-z]{2}$/.test(manual_loc)) ? manual_loc.toUpperCase() : fallback;
                    const countryCode = country_code || 'UN';
                    
                    // ä½¿ç”¨ getFlagEmoji å‡½æ•°å°† country_code è½¬æ¢ä¸ºå›½æ—— Emoji
                    // è°ƒç”¨ getFlagEmoji(item.country_code) åçš„ Emoji
                    const flagEmoji = typeof getFlagEmoji === 'function' 
                        ? getFlagEmoji(countryCode) 
                        : 'ğŸ³ï¸';
                    
                    // äººæ ¼ç§°å·ï¼šä½¿ç”¨ vibe_index_str ä½œä¸ºç§°å·/ç»´åº¦æ˜¾ç¤ºï¼ˆä»…ç”¨äºå¼¹çª—ï¼‰
                    const vibe_index_str = escapeHtml(
                        (item.vibe_index_str && String(item.vibe_index_str).trim()) || ''
                    );
                    
                    // ç”¨æˆ·èº«ä»½æ˜¾ç¤ºæ–‡æœ¬
                    const identityLabel = identityLabelMap[user_identity] || 'åŒ¿å';
                    
                    // GitHub é“¾æ¥ï¼ˆä»…ç”¨äºå¼¹çª—ï¼‰
                    const githubUrl = (user_identity === 'github' && user_name) 
                        ? `https://github.com/${user_name}` 
                        : null;
                    
                    // å‡†å¤‡å¼¹çª—æ•°æ®ï¼ˆJSONå­—ç¬¦ä¸²ï¼Œç”¨äºç‚¹å‡»äº‹ä»¶ï¼‰
                    // å¼¹çª—åŒ–æ¬¡è¦ä¿¡æ¯ï¼šå°† github.com/ç”¨æˆ·å é“¾æ¥å’Œ vibe_index_strï¼ˆä»£ç ç§°å·ï¼‰ä»ä¸»åˆ—è¡¨ä¸­ç§»é™¤
                    const detailData = {
                        fingerprint: fingerprint,
                        user_name: user_name || '--',
                        user_identity: user_identity || 'åŒ¿å',
                        avatar: avatar,
                        country_code: country_code,
                        flagEmoji: flagEmoji,
                        githubUrl: githubUrl,
                        vibe_index_str: item.vibe_index_str || '', // åŸå§‹å€¼ï¼Œç”¨äºè½¬æ¢ç§°å·
                        currentDimension: dim.key,
                        currentValue: value
                    };
                    
                    // é‡‘èAppæ¦œå•é£æ ¼ - Gridå¸ƒå±€ï¼š50px 50px 1fr 100pxï¼ˆå›½æ——ã€å¤´åƒã€ç”¨æˆ·ä¿¡æ¯ã€åˆ†å€¼ï¼‰
                    // åæ¬¡å·²ç§»é™¤ï¼Œå›½æ——å æ®æœ€å·¦ä¾§ä½ç½®
                    return `
                        <div class="ranking-item-row" onclick="showUserRankingDetail(${escapeHtml(JSON.stringify(detailData))})">
                            <!-- ç¬¬ä¸€åˆ—ï¼šå›½æ—— Emojiï¼ˆåŠ å¤§å­—å·ï¼Œæœ€å·¦ä¾§ï¼‰ -->
                            <div class="ranking-flag-column">
                                <span class="ranking-flag-large">${flagEmoji}</span>
                            </div>
                            
                            <!-- ç¬¬äºŒåˆ—ï¼šç”¨æˆ·å¤´åƒï¼ˆåœ†å½¢ï¼Œw-10 h-10ï¼‰ -->
                            <div class="ranking-avatar-wrapper">
                                <img 
                                    src="${escapeHtml(avatar)}" 
                                    alt="" 
                                    class="ranking-avatar"
                                    onerror="this.onerror=null; this.src='${escapeHtml(DEFAULT_AVATAR)}';"
                                />
                            </div>
                            
                            <!-- ç¬¬ä¸‰åˆ—ï¼šç”¨æˆ·ä¿¡æ¯åŒºï¼ˆflex-col å¸ƒå±€ï¼‰ -->
                            <div class="ranking-user-info">
                                <!-- ä¸Šè¡Œï¼šuser_nameï¼ˆä¸æˆªæ–­ï¼Œç»¿è‰²åŠ ç²—ï¼Œå…è®¸æ¢è¡Œï¼‰ -->
                                <div class="ranking-username-row">
                                    <div class="ranking-username">${escapeHtml(user_name || '--')}</div>
                                </div>
                                <!-- ä¸‹è¡Œï¼šèº«ä»½æ¥æº -->
                                <div class="ranking-identity-row">
                                    <span class="ranking-identity-text">${escapeHtml(identityLabel)}</span>
                                </div>
                            </div>
                            
                            <!-- ç¬¬å››åˆ—ï¼šåˆ†å€¼åŒºï¼ˆå³å¯¹é½ï¼Œflex-col items-endï¼‰ -->
                            <div class="ranking-value-section">
                                <!-- ä¸Šè¡Œï¼šå¤§å­—å·åˆ†å€¼ -->
                                <div class="ranking-value">${value}</div>
                                <!-- ä¸‹è¡Œï¼šç»´åº¦æ ‡ç­¾ -->
                                <div class="ranking-value-label">${escapeHtml(dim.unit)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                html += `
                    <div class="border border-green-500/30 bg-gray-900/50" style="width: 100%;">
                        <div class="bg-[#003b00]/50 px-4 py-3 border-b border-green-500/30">
                            <div class="text-[#00ff41] text-xs font-mono font-bold">${dim.label}</div>
                            <div class="text-[#00ff41]/70 text-[10px] font-mono mt-0.5">${dim.desc}</div>
                        </div>
                        <div class="ranking-list">
                            ${rows}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            console.log('[GreenLaddersToContainer] âœ… HTML å·²æ¸²æŸ“åˆ°å®¹å™¨');
        }
        
        /**
         * æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…å¼¹çª—ï¼ˆåŒ…å«ç”¨æˆ·å¤´åƒã€å…­ä¸ªç»´åº¦æ•°æ®å’Œæ’åï¼‰
         * @param {Object} data - æ’è¡Œæ¦œé¡¹æ•°æ®
         */
        async function showUserRankingDetail(data) {
            if (!data || !data.fingerprint) {
                console.warn('[UserRankingDetail] âš ï¸ ç¼ºå°‘å¿…è¦æ•°æ®');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å¼¹çª—
            let existingModal = document.getElementById('user-ranking-detail-modal');
            if (existingModal) {
                existingModal.remove();
            }

            try {
                // è·å–ç”¨æˆ·çš„æ‰€æœ‰å…­ä¸ªç»´åº¦æ•°æ®
                if (!supabaseClient || typeof supabaseClient.from !== 'function') {
                    console.warn('[UserRankingDetail] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                    return;
                }

                // ä» v_unified_analysis_v2 è·å–ç”¨æˆ·æ•°æ®
                const { data: userData, error: userError } = await supabaseClient
                    .from('v_unified_analysis_v2')
                    .select('fingerprint, user_name, user_identity, country_code, vibe_index_str, ketao_count, jiafang_count, work_days, total_messages, avg_user_message_length, total_chars')
                    .eq('fingerprint', data.fingerprint)
                    .limit(1)
                    .single();

                if (userError || !userData) {
                    console.error('[UserRankingDetail] âŒ è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', userError);
                    return;
                }

                // è·å–ç”¨æˆ·åœ¨æ‰€æœ‰å…­ä¸ªç»´åº¦ä¸­çš„æ’å
                const dimensions = [
                    { key: 'ketao_count', label: 'ç£•å¤´æ¦œ', desc: 'é¡¶çº§ç¤¼è²Œå¤§æˆ·', field: 'ketao_count' },
                    { key: 'jiafang_count', label: 'éœ¸æ€»æ¦œ', desc: 'å¯¹ AI æé™å¦å®š', field: 'jiafang_count' },
                    { key: 'work_days', label: 'æ‰“å·¥æ¦œ', desc: 'ä¸Šå²—å¤©æ•°', field: 'work_days' },
                    { key: 'total_messages', label: 'è¯ç—¨æ¦œ', desc: 'å¯¹è¯å›åˆ', field: 'total_messages' },
                    { key: 'avg_user_message_length', label: 'çº ç»“æ¦œ', desc: 'å•æ¬¡æŒ‡ä»¤åšåº¦', field: 'avg_user_message_length' },
                    { key: 'total_chars', label: 'ç¤¾ç•œæ¦œ', desc: 'Token éœ¸æƒ', field: 'total_chars' }
                ];

                // å¹¶è¡Œè·å–æ‰€æœ‰ç»´åº¦çš„æ’åï¼ˆä¼˜åŒ–ï¼šåªæŸ¥è¯¢æ¯”ç”¨æˆ·å€¼å¤§çš„è®°å½•æ•°é‡ï¼‰
                const rankingPromises = dimensions.map(async (dim) => {
                    try {
                        // è®¡ç®—ç”¨æˆ·åœ¨è¯¥ç»´åº¦çš„å€¼
                        const userValue = dim.field === 'avg_user_message_length' 
                            ? (userData.total_chars && userData.total_messages ? userData.total_chars / userData.total_messages : 0)
                            : (userData[dim.field] || 0);

                        // æ ¼å¼åŒ–æ•°å€¼
                        let formattedValue = '';
                        if (dim.key === 'avg_user_message_length') {
                            formattedValue = isNaN(userValue) ? '0.0' : userValue.toFixed(1);
                        } else {
                            formattedValue = isNaN(userValue) ? '0' : userValue.toLocaleString('en-US');
                        }

                        // å¦‚æœç”¨æˆ·å€¼ä¸º0ï¼Œæ’åä¸ºnull
                        if (userValue <= 0) {
                            return { 
                                key: dim.key, 
                                label: dim.label, 
                                desc: dim.desc,
                                rank: null, 
                                value: formattedValue,
                                hasRanking: false
                            };
                        }

                        // æŸ¥è¯¢æ¯”ç”¨æˆ·å€¼å¤§çš„è®°å½•æ•°é‡ï¼ˆæ’å = æ•°é‡ + 1ï¼‰
                        let countQuery = supabaseClient
                            .from('v_unified_analysis_v2')
                            .select('id', { count: 'exact', head: true });

                        if (dim.field === 'avg_user_message_length') {
                            // å¯¹äºå¹³å‡é•¿åº¦ï¼Œéœ€è¦è®¡ç®— total_chars / total_messages > userValue
                            // ä½¿ç”¨ PostgREST çš„è¡¨è¾¾å¼ï¼štotal_chars::numeric / NULLIF(total_messages, 0) > userValue
                            countQuery = countQuery
                                .not('total_chars', 'is', null)
                                .not('total_messages', 'is', null)
                                .gt('total_chars', 0)
                                .gt('total_messages', 0);
                            // æ³¨æ„ï¼šPostgREST ä¸æ”¯æŒå¤æ‚çš„è¡¨è¾¾å¼æŸ¥è¯¢ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
                            // å®é™…æ’åè®¡ç®—éœ€è¦æŸ¥è¯¢æ‰€æœ‰æ•°æ®
                        } else {
                            countQuery = countQuery
                                .not(dim.field, 'is', null)
                                .gt(dim.field, userValue);
                        }

                        const { count, error: countError } = await countQuery;

                        if (countError) {
                            console.warn(`[UserRankingDetail] âš ï¸ è·å– ${dim.key} æ’åæ•°é‡å¤±è´¥:`, countError);
                            // é™çº§ï¼šæŸ¥è¯¢å‰100æ¡è®°å½•æ¥è®¡ç®—æ’å
                            let query = supabaseClient
                                .from('v_unified_analysis_v2')
                                .select(dim.field === 'avg_user_message_length' ? 'total_chars, total_messages' : dim.field)
                                .not(dim.field === 'avg_user_message_length' ? 'total_chars' : dim.field, 'is', null)
                                .gt(dim.field === 'avg_user_message_length' ? 'total_chars' : dim.field, 0)
                                .order(dim.field === 'avg_user_message_length' ? 'total_chars' : dim.field, { ascending: false, nullsFirst: false })
                                .limit(100);

                            const { data: rankingData, error: rankingError } = await query;

                            if (rankingError || !rankingData) {
                                return { key: dim.key, rank: null, value: formattedValue, hasRanking: false };
                            }

                            let rank = 1;
                            for (const item of rankingData) {
                                const itemValue = dim.field === 'avg_user_message_length'
                                    ? (item.total_chars && item.total_messages ? item.total_chars / item.total_messages : 0)
                                    : (item[dim.field] || 0);
                                
                                if (itemValue > userValue) {
                                    rank++;
                                } else {
                                    break;
                                }
                            }

                            return { 
                                key: dim.key, 
                                label: dim.label, 
                                desc: dim.desc,
                                rank: rank, 
                                value: formattedValue,
                                hasRanking: rank <= 10
                            };
                        }

                        // æ’å = æ¯”ç”¨æˆ·å€¼å¤§çš„è®°å½•æ•° + 1
                        const rank = (count || 0) + 1;

                        return { 
                            key: dim.key, 
                            label: dim.label, 
                            desc: dim.desc,
                            rank: rank, 
                            value: formattedValue,
                            hasRanking: rank <= 10 // æ ‡è®°æ˜¯å¦åœ¨å‰10å
                        };
                    } catch (e) {
                        console.error(`[UserRankingDetail] âŒ è·å– ${dim.key} æ’åå¤±è´¥:`, e);
                        // è¿”å›ç”¨æˆ·å€¼ï¼Œä½†ä¸æ˜¾ç¤ºæ’å
                        const userValue = dim.field === 'avg_user_message_length' 
                            ? (userData.total_chars && userData.total_messages ? userData.total_chars / userData.total_messages : 0)
                            : (userData[dim.field] || 0);
                        let formattedValue = '';
                        if (dim.key === 'avg_user_message_length') {
                            formattedValue = isNaN(userValue) ? '0.0' : userValue.toFixed(1);
                        } else {
                            formattedValue = isNaN(userValue) ? '0' : userValue.toLocaleString('en-US');
                        }
                        return { key: dim.key, label: dim.label, desc: dim.desc, rank: null, value: formattedValue, hasRanking: false };
                    }
                });

                const rankings = await Promise.all(rankingPromises);

                // è·å–ä»£ç ç§°å·ï¼ˆè½¬æ¢ä¸ºæ–‡å­—ï¼‰
                let personalityTitle = '--';
                if (userData.vibe_index_str && typeof getPersonalityTitle === 'function') {
                    try {
                        const titleResult = getPersonalityTitle({ vibe_index_str: userData.vibe_index_str, user_identity: userData.user_identity }, currentLang || 'zh');
                        if (titleResult && titleResult.trim()) {
                            personalityTitle = titleResult.trim();
                        }
                    } catch (e) {
                        console.warn('[UserRankingDetail] getPersonalityTitle è°ƒç”¨å¤±è´¥:', e);
                    }
                }

                // åˆ›å»ºå¼¹çª—
                const modal = document.createElement('div');
                modal.id = 'user-ranking-detail-modal';
                modal.className = 'ranking-detail-modal';
                
                // æ„å»ºå…­ä¸ªç»´åº¦æ•°æ®HTML
                const dimensionsHtml = rankings.map(r => {
                    const isCurrent = r.key === data.currentDimension;
                    const rankBadge = r.hasRanking ? `<span class="ranking-badge" style="display: inline-block; padding: 2px 6px; background: rgba(0, 255, 65, 0.2); border: 1px solid rgba(0, 255, 65, 0.5); border-radius: 3px; font-size: 9px; color: rgba(0, 255, 65, 1); margin-left: 6px;">#${r.rank}</span>` : '';
                    const currentMark = isCurrent ? `<span style="color: rgba(0, 255, 65, 1); font-size: 10px; margin-left: 4px;">â—</span>` : '';
                    return `
                        <div class="ranking-detail-item" style="${isCurrent ? 'background: rgba(0, 255, 65, 0.05); padding: 8px; border-radius: 4px;' : ''}">
                            <div class="ranking-detail-label">${escapeHtml(r.label)}</div>
                            <div class="ranking-detail-value" style="display: flex; align-items: center;">
                                <span>${escapeHtml(r.value || '0')}</span>
                                ${rankBadge}
                                ${currentMark}
                            </div>
                        </div>
                    `;
                }).join('');

                modal.innerHTML = `
                    <div class="ranking-detail-card" style="max-width: 600px;">
                        <div class="ranking-detail-header">
                            <div class="ranking-detail-title">ç”¨æˆ·è¯¦æƒ…</div>
                            <button class="ranking-detail-close" onclick="closeUserRankingDetail()">Ã—</button>
                        </div>
                        <div class="ranking-detail-content" id="user-ranking-detail-content">
                            <!-- ç”¨æˆ·å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯ -->
                            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid rgba(0, 255, 65, 0.2);">
                                <img 
                                    src="${escapeHtml(data.avatar || DEFAULT_AVATAR)}" 
                                    alt="" 
                                    style="width: 64px; height: 64px; border-radius: 50%; border: 2px solid rgba(0, 255, 65, 0.3); object-fit: cover;"
                                    onerror="this.onerror=null; this.src='${escapeHtml(DEFAULT_AVATAR)}';"
                                />
                                <div style="flex: 1;">
                                    <div style="color: rgba(74, 222, 128, 1); font-size: 16px; font-weight: 700; margin-bottom: 4px;">${escapeHtml(data.user_name || '--')}</div>
                                    <div style="color: rgba(255, 255, 255, 0.5); font-size: 11px; margin-bottom: 4px;">${escapeHtml(data.user_identity || 'åŒ¿å')}</div>
                                    ${personalityTitle !== '--' ? `<div style="color: rgba(0, 255, 65, 0.8); font-size: 12px;">${escapeHtml(personalityTitle)}</div>` : ''}
                                    ${data.githubUrl ? `<a href="${escapeHtml(data.githubUrl)}" target="_blank" rel="noopener noreferrer" class="ranking-detail-link" style="font-size: 11px; margin-top: 4px; display: inline-block;">ğŸ”— ${escapeHtml(data.githubUrl)}</a>` : ''}
                                </div>
                            </div>
                            
                            <!-- å…­ä¸ªç»´åº¦æ•°æ® -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                ${dimensionsHtml}
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // æ˜¾ç¤ºå¼¹çª—
                modal.classList.add('active');

                // ESCé”®å…³é—­ï¼ˆä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿ä¼˜å…ˆæ‰§è¡Œï¼‰
                const escHandler = function(e) {
                    if (e.key === 'Escape') {
                        e.stopImmediatePropagation(); // é˜»æ­¢åŒä¸€å…ƒç´ ä¸Šçš„å…¶ä»–ç›‘å¬å™¨æ‰§è¡Œ
                        e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
                        closeUserRankingDetail();
                        document.removeEventListener('keydown', escHandler, true);
                    }
                };
                document.addEventListener('keydown', escHandler, true); // ä½¿ç”¨æ•è·é˜¶æ®µ

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeUserRankingDetail();
                    }
                });

            } catch (error) {
                console.error('[UserRankingDetail] âŒ æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        /**
         * å…³é—­ç”¨æˆ·è¯¦æƒ…å¼¹çª—ï¼ˆä¸å½±å“æŠ½å±‰çŠ¶æ€ï¼‰
         */
        function closeUserRankingDetail() {
            const modal = document.getElementById('user-ranking-detail-modal');
            if (modal) {
                modal.classList.remove('active');
                // å»¶è¿Ÿç§»é™¤ï¼Œç¡®ä¿åŠ¨ç”»å®Œæˆ
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                }, 200);
            }
        }

        /**
         * æ˜¾ç¤ºç®€å•çš„æ’è¡Œæ¦œè¯¦æƒ…å¼¹çª—ï¼ˆä»…æ˜¾ç¤º GitHub é“¾æ¥å’Œä»£ç ç§°å·ï¼‰
         * @param {Object} data - æ’è¡Œæ¦œé¡¹æ•°æ®
         */
        function showRankingDetailSimple(data) {
            // åˆ›å»ºæˆ–è·å–å¼¹çª—å…ƒç´ 
            let modal = document.getElementById('ranking-detail-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'ranking-detail-modal';
                modal.className = 'ranking-detail-modal';
                modal.innerHTML = `
                    <div class="ranking-detail-card">
                        <div class="ranking-detail-header">
                            <div class="ranking-detail-title">ç”¨æˆ·è¯¦æƒ…</div>
                            <button class="ranking-detail-close" onclick="closeRankingDetail()">Ã—</button>
                        </div>
                        <div class="ranking-detail-content" id="ranking-detail-content"></div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeRankingDetail();
                    }
                });
            }
            
            // å¡«å……å†…å®¹ï¼ˆä»…æ˜¾ç¤º GitHub é“¾æ¥å’Œä»£ç ç§°å·ï¼‰
            const content = document.getElementById('ranking-detail-content');
            let html = '';
            
            // ç”¨æˆ·ä¿¡æ¯
            html += `
                <div class="ranking-detail-item">
                    <div class="ranking-detail-label">ç”¨æˆ·å</div>
                    <div class="ranking-detail-value">${escapeHtml(data.user_name || '--')}</div>
                </div>
            `;
            
            // GitHubé“¾æ¥ï¼ˆå¦‚æœæœ‰ï¼‰
            if (data.githubUrl) {
                html += `
                    <div class="ranking-detail-item">
                        <div class="ranking-detail-label">GitHub é“¾æ¥</div>
                        <div class="ranking-detail-value">
                            <a href="${escapeHtml(data.githubUrl)}" target="_blank" rel="noopener noreferrer" class="ranking-detail-link">
                                ğŸ”— ${escapeHtml(data.githubUrl)}
                            </a>
                        </div>
                    </div>
                `;
            }
            
            // ä»£ç ç§°å·ï¼ˆå¦‚æœæœ‰ï¼‰
            if (data.vibe_index_str) {
                html += `
                    <div class="ranking-detail-item">
                        <div class="ranking-detail-label">ä»£ç ç§°å·</div>
                        <div class="ranking-detail-value">${escapeHtml(data.vibe_index_str)}</div>
                    </div>
                `;
            }
            
            // å¦‚æœæ²¡æœ‰é¢å¤–ä¿¡æ¯
            if (!data.githubUrl && !data.vibe_index_str) {
                html += `
                    <div class="ranking-detail-item">
                        <div class="ranking-detail-value" style="color: rgba(255, 255, 255, 0.5);">æš‚æ— é¢å¤–ä¿¡æ¯</div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            
            // æ˜¾ç¤ºå¼¹çª—
            modal.classList.add('active');
            
            // ESCé”®å…³é—­
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    closeRankingDetail();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        /**
         * æ˜¾ç¤ºæ’è¡Œæ¦œè¯¦æƒ…å¼¹çª—ï¼ˆå®Œæ•´ç‰ˆï¼‰
         * @param {Object} data - æ’è¡Œæ¦œé¡¹æ•°æ®
         */
        function showRankingDetail(data) {
            // åˆ›å»ºæˆ–è·å–å¼¹çª—å…ƒç´ 
            let modal = document.getElementById('ranking-detail-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'ranking-detail-modal';
                modal.className = 'ranking-detail-modal';
                modal.innerHTML = `
                    <div class="ranking-detail-card">
                        <div class="ranking-detail-header">
                            <div class="ranking-detail-title">ç”¨æˆ·è¯¦æƒ…</div>
                            <button class="ranking-detail-close" onclick="closeRankingDetail()">Ã—</button>
                        </div>
                        <div class="ranking-detail-content" id="ranking-detail-content"></div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeRankingDetail();
                    }
                });
            }
            
            // å¡«å……å†…å®¹
            const content = document.getElementById('ranking-detail-content');
            let html = '';
            
            // ç”¨æˆ·ä¿¡æ¯
            html += `
                <div class="ranking-detail-item">
                    <div class="ranking-detail-label">ç”¨æˆ·å</div>
                    <div class="ranking-detail-value">${escapeHtml(data.user_name || '--')}</div>
                </div>
            `;
            
            // ç”¨æˆ·èº«ä»½
            html += `
                <div class="ranking-detail-item">
                    <div class="ranking-detail-label">ç”¨æˆ·èº«ä»½</div>
                    <div class="ranking-detail-value">${escapeHtml(data.user_identity || 'åŒ¿å')}</div>
                </div>
            `;
            
            // GitHubé“¾æ¥ï¼ˆå¦‚æœæœ‰ï¼‰
            if (data.githubUrl) {
                html += `
                    <div class="ranking-detail-item">
                        <div class="ranking-detail-label">GitHub ä»“åº“</div>
                        <div class="ranking-detail-value">
                            <a href="${escapeHtml(data.githubUrl)}" target="_blank" rel="noopener noreferrer" class="ranking-detail-link">
                                ğŸ”— ${escapeHtml(data.githubUrl)}
                            </a>
                        </div>
                    </div>
                `;
            }
            
            // ä»£ç ç§°å·
            if (data.vibe_index_str) {
                html += `
                    <div class="ranking-detail-item">
                        <div class="ranking-detail-label">ä»£ç ç§°å·</div>
                        <div class="ranking-detail-value">${escapeHtml(data.vibe_index_str)}</div>
                    </div>
                `;
            }
            
            // æ’åå’Œåˆ†å€¼
            html += `
                <div class="ranking-detail-item">
                    <div class="ranking-detail-label">æ’å</div>
                    <div class="ranking-detail-value">#${data.rank}</div>
                </div>
                <div class="ranking-detail-item">
                    <div class="ranking-detail-label">${escapeHtml(data.dimension)}</div>
                    <div class="ranking-detail-value">${escapeHtml(data.value)} ${escapeHtml(data.dimensionDesc || '')}</div>
                </div>
            `;
            
            // å›½å®¶ä¿¡æ¯
            html += `
                <div class="ranking-detail-item">
                    <div class="ranking-detail-label">å›½å®¶/åœ°åŒº</div>
                    <div class="ranking-detail-value">${data.flagEmoji || 'ğŸ³ï¸'} ${escapeHtml(data.countryCode || 'UN')}</div>
                </div>
            `;
            
            // å”¯ä¸€è¯†åˆ«ç 
            if (data.fingerprint) {
                html += `
                    <div class="ranking-detail-item">
                        <div class="ranking-detail-label">å”¯ä¸€è¯†åˆ«ç </div>
                        <div class="ranking-detail-value" style="font-size: 11px; word-break: break-all;">${escapeHtml(data.fingerprint)}</div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            
            // æ˜¾ç¤ºå¼¹çª—
            modal.classList.add('active');
            
            // ESCé”®å…³é—­
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    closeRankingDetail();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        /**
         * å…³é—­æ’è¡Œæ¦œè¯¦æƒ…å¼¹çª—
         */
        function closeRankingDetail() {
            const modal = document.getElementById('ranking-detail-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        // æŒ‚è½½åˆ°windowå¯¹è±¡
        if (typeof window !== 'undefined') {
            window.renderGreenLadders = renderGreenLadders;
            window.showRankingDetail = showRankingDetail;
            window.showRankingDetailSimple = showRankingDetailSimple;
            window.showUserRankingDetail = showUserRankingDetail;
            window.closeRankingDetail = closeRankingDetail;
            window.closeUserRankingDetail = closeUserRankingDetail;
            console.log('[Stats2.App] âœ… renderGreenLadders å·²æŒ‚è½½åˆ° window');
        }

        // ==========================================
        // çŸ©é˜µç»¿å¤©æ¢¯æ¦œç›¸å…³å‡½æ•°ç»“æŸ
        // ==========================================

        /**
         * ã€æ–°å¢ã€‘æ ¼å¼åŒ–æ’è¡Œæ¦œæ•°å€¼
         */
        function formatRankingValue(value, key) {
            const n = Number(value);
            if (!Number.isFinite(n)) return '--';
            
            if (key === 'total_chars' && n >= 1000) {
                return (n / 1000).toFixed(1) + 'k';
            }
            if (key === 'avg_message_length') {
                return n.toFixed(1);
            }
            return new Intl.NumberFormat('zh-CN').format(Math.round(n));
        }

        /**
         * ã€å·²åºŸå¼ƒï¼Œä¿ç•™å…¼å®¹ã€‘ä»å›½å®¶é€è§†åˆ‡å›ã€Œå®æ—¶åŠ¨æ€æµã€è§†å›¾
         */
        function switchBackToGlobalView() {
            switchView('global');
        }

        /**
         * ã€å·²åºŸå¼ƒï¼Œä¿ç•™å…¼å®¹ã€‘ä»ã€Œå®æ—¶åŠ¨æ€æµã€è§†å›¾åˆ‡æ¢åˆ°ã€Œå›½å®¶æ•°æ®é€è§†ã€æ¨¡å¼
         */
        function switchToCountryViewFromGlobal() {
            // ä¼˜å…ˆä½¿ç”¨ currentDrawerCountry ä¸­ä¿å­˜çš„å›½å®¶ä¿¡æ¯
            let countryCode = null;
            let countryName = null;

            if (currentDrawerCountry && currentDrawerCountry.code && currentDrawerCountry.name) {
                countryCode = String(currentDrawerCountry.code).trim().toUpperCase();
                countryName = currentDrawerCountry.name;
            } else {
                // å°è¯•ä»å…¨å±€å˜é‡è·å–ç”¨æˆ·å›½å®¶ä»£ç 
                const userCountry = window.currentUserCountry || 
                    (window.currentUser && (window.currentUser.country_code || window.currentUser.ip_location)) ||
                    (window.currentUserData && (window.currentUserData.country_code || window.currentUserData.ip_location));
                
                if (userCountry && /^[A-Z]{2}$/.test(String(userCountry).trim().toUpperCase())) {
                    countryCode = String(userCountry).trim().toUpperCase();
                    // ä» countryNameMap è·å–å›½å®¶åç§°
                    const countryInfo = countryNameMap[countryCode];
                    countryName = countryInfo 
                        ? (currentLang === 'zh' ? countryInfo.zh : countryInfo.en)
                        : countryCode;
                }
            }

            // å¦‚æœä»ç„¶æ²¡æœ‰å›½å®¶ä»£ç ï¼Œä½¿ç”¨é»˜è®¤å€¼æˆ–æç¤ºç”¨æˆ·
            if (!countryCode || !/^[A-Z]{2}$/.test(countryCode)) {
                // å¦‚æœæ²¡æœ‰å›½å®¶ä¿¡æ¯ï¼Œå¯ä»¥æç¤ºç”¨æˆ·é€‰æ‹©å›½å®¶ï¼Œæˆ–è€…ä½¿ç”¨é»˜è®¤å€¼
                console.warn('[Drawer] âš ï¸ æ— æ³•è·å–å›½å®¶ä»£ç ï¼Œæ— æ³•åˆ‡æ¢åˆ°å›½å®¶é€è§†');
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ªé€‰æ‹©å›½å®¶çš„ UIï¼Œæˆ–è€…ä½¿ç”¨é»˜è®¤å€¼
                // æš‚æ—¶ä½¿ç”¨ US ä½œä¸ºé»˜è®¤å€¼
                countryCode = 'US';
                const countryInfo = countryNameMap[countryCode];
                countryName = countryInfo 
                    ? (currentLang === 'zh' ? countryInfo.zh : countryInfo.en)
                    : 'United States';
            }

            // ã€ä¿®å¤ã€‘å…ˆè°ƒç”¨ switchToCountryView æ¸²æŸ“é¢æ¿ï¼Œç„¶åè°ƒç”¨ switchView åˆ‡æ¢è§†å›¾
            if (typeof switchToCountryView === 'function') {
                switchToCountryView(countryCode, countryName);
                if (typeof switchView === 'function') {
                    switchView('country');
                }
            } else {
                console.error('[Drawer] âŒ switchToCountryView å‡½æ•°ä¸å­˜åœ¨');
            }
        }

        /**
         * ã€æ–°å¢ã€‘åˆ‡æ¢ Global å’Œ Country è§†å›¾
         * æ ¹æ®å½“å‰è§†å›¾çŠ¶æ€è‡ªåŠ¨åˆ¤æ–­æ‰§è¡Œå“ªä¸ªåˆ‡æ¢
         */
        function toggleGlobalCountryView() {
            if (currentViewState === 'GLOBAL') {
                // å½“å‰æ˜¯ Global è§†å›¾ï¼Œåˆ‡æ¢åˆ° Country è§†å›¾
                switchToCountryViewFromGlobal();
            } else {
                // å½“å‰æ˜¯ Country è§†å›¾ï¼Œåˆ‡æ¢å› Global è§†å›¾
                switchBackToGlobalView();
            }
        }

        /**
         * ã€æ–°å¢ã€‘æ›´æ–°é¡¶éƒ¨è§†å›¾åˆ‡æ¢æŒ‰é’®çš„æ–‡æœ¬
         * åœ¨è§†å›¾åˆ‡æ¢æ—¶è‡ªåŠ¨è°ƒç”¨ä»¥æ›´æ–°æŒ‰é’®æ˜¾ç¤º
         */
        function updateHeaderViewToggleBtn() {
            const btn = document.getElementById('headerViewToggleBtn');
            if (!btn) return;
            
            if (currentViewState === 'GLOBAL') {
                // Global è§†å›¾æ—¶æ˜¾ç¤º"å›½å®¶é€è§†"
                btn.textContent = currentLang === 'en' ? '[Country Panel]' : '[å›½å®¶é€è§†]';
                btn.title = currentLang === 'en' ? 'Switch to Country Panel' : 'åˆ‡æ¢åˆ°å›½å®¶é€è§†';
            } else {
                // Country è§†å›¾æ—¶æ˜¾ç¤º"è¿”å›å…¨ç½‘"
                btn.textContent = currentLang === 'en' ? '[Back to Global]' : '[è¿”å›å…¨ç½‘]';
                btn.title = currentLang === 'en' ? 'Back to Global View' : 'è¿”å›å…¨ç½‘è§†å›¾';
            }
        }

        /**
         * å…³é—­æŠ½å±‰
         * @param {boolean} clearSelection - æ˜¯å¦æ¸…é™¤é€‰ä¸­çŠ¶æ€ï¼Œé»˜è®¤ä¸º true
         */
        function closeDrawers(clearSelection = true) {
            const leftDrawer = document.getElementById('left-drawer');
            const rightDrawer = document.getElementById('right-drawer');

            if (leftDrawer) {
                leftDrawer.classList.remove('active');
                localStorage.setItem('left_drawer_open', 'false');
            }
            if (rightDrawer) {
                rightDrawer.classList.remove('active');
                localStorage.setItem('right_drawer_open', 'false');
            }

            if (clearSelection) {
                selectedCountry = null;
                localStorage.removeItem('selected_country');
                // æ³¨æ„ï¼šanchored_country æ˜¯â€œåœ°ç†æ ‡ç­¾/æ¯å›½é”šå®šâ€ï¼Œä¸éšå…³é—­æŠ½å±‰æ¸…é™¤ï¼ˆåˆ·æ–°åä»åº”ä¿æŒï¼‰
            }
            console.log('[Drawer] æŠ½å±‰å·²å…³é—­, selectedCountry =', selectedCountry);
        }

        // æ·»åŠ  ESC é”®å…³é—­æŠ½å±‰ï¼ˆå½“æ²¡æœ‰å¼¹çª—æ‰“å¼€æ—¶ï¼‰
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¼¹çª—æ‰“å¼€ï¼Œå¦‚æœæœ‰åˆ™ä¸å…³é—­æŠ½å±‰
                const userDetailModal = document.getElementById('user-ranking-detail-modal');
                const rankingDetailModal = document.getElementById('ranking-detail-modal');
                // æ£€æŸ¥å¼¹çª—æ˜¯å¦å­˜åœ¨ä¸”å¯è§ï¼ˆactive ç±»ï¼‰
                if (userDetailModal && userDetailModal.classList.contains('active')) {
                    return; // æœ‰å¼¹çª—æ‰“å¼€æ—¶ï¼Œä¸å…³é—­æŠ½å±‰
                }
                if (rankingDetailModal && rankingDetailModal.classList.contains('active')) {
                    return; // æœ‰å¼¹çª—æ‰“å¼€æ—¶ï¼Œä¸å…³é—­æŠ½å±‰
                }
                closeDrawers();
            }
        });

        // ç‚¹å‡»æŠ½å±‰å¤–éƒ¨åŒºåŸŸå…³é—­æŠ½å±‰ï¼ˆç®€åŒ–ç‰ˆï¼‰
        // åªå¤„ç†ç‚¹å‡» UI å…ƒç´ å¤–éƒ¨çš„æƒ…å†µï¼Œåœ°å›¾ç‚¹å‡»äº‹ä»¶å·²ç»å¤„ç†äº†åœ°å›¾åŒºåŸŸçš„ç‚¹å‡»
        document.addEventListener('click', (e) => {
            const leftDrawer = document.getElementById('left-drawer');
            const rightDrawer = document.getElementById('right-drawer');
            
            if (!leftDrawer || !rightDrawer) return;
            
            // å¦‚æœæŠ½å±‰æ˜¯æ¿€æ´»çŠ¶æ€
            const isDrawerActive = leftDrawer.classList.contains('active') || rightDrawer.classList.contains('active');
            
            if (!isDrawerActive) return;
            
            // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨æŠ½å±‰å†…éƒ¨
            const isClickInsideDrawer = leftDrawer.contains(e.target) || rightDrawer.contains(e.target);
            
            // å¦‚æœç‚¹å‡»åœ¨æŠ½å±‰å†…éƒ¨ï¼Œä¸å¤„ç†
            if (isClickInsideDrawer) return;
            
            // ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ç”¨æˆ·å¤´åƒæˆ–å¼¹çª—
            const isUserAvatarClick = e.target.closest('.user-avatar-compact') || 
                                      e.target.closest('.user-popup') ||
                                      e.target.closest('#live-nodes-drawer');
            if (isUserAvatarClick) {
                // ç”¨æˆ·å¤´åƒç‚¹å‡»ç”± toggleUserPopup å¤„ç†ï¼Œä¸å…³é—­æŠ½å±‰
                return;
            }
            
            // ã€ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ç”¨æˆ·è¯¦æƒ…å¼¹çª—æˆ–å…¶ä»–å¼¹çª—
            const userDetailModal = document.getElementById('user-ranking-detail-modal');
            const rankingDetailModal = document.getElementById('ranking-detail-modal');
            const isModalClick = (userDetailModal && (userDetailModal.contains(e.target) || e.target === userDetailModal)) ||
                                 (rankingDetailModal && (rankingDetailModal.contains(e.target) || e.target === rankingDetailModal));
            if (isModalClick) {
                // ç‚¹å‡»å¼¹çª—æ—¶ä¸å…³é—­æŠ½å±‰
                return;
            }
            
            // ã€ä¿®å¤åœ°å›¾ç‚¹å‡»ã€‘æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†åœ°å›¾å®¹å™¨ï¼ˆåŒ…æ‹¬ ECharts canvas å…ƒç´ ï¼‰
            // ECharts æ¸²æŸ“åï¼Œç‚¹å‡»ç›®æ ‡å¯èƒ½æ˜¯ canvas å…ƒç´ ï¼Œéœ€è¦æ£€æŸ¥å…¶çˆ¶å®¹å™¨
            const mapContainer = document.getElementById('map-container');
            const isMapClick = mapContainer && (
                e.target === mapContainer || 
                e.target.closest('#map-container') ||
                (e.target.tagName === 'CANVAS' && mapContainer.contains(e.target)) ||
                e.target.closest('canvas')
            );
            if (isMapClick) {
                // åœ°å›¾ç‚¹å‡»äº‹ä»¶ç”± ECharts å¤„ç†ï¼Œè¿™é‡Œä¸é‡å¤å¤„ç†ï¼ˆé¿å…å…³é—­æŠ½å±‰ï¼‰
                console.log('[Drawer] æ£€æµ‹åˆ°åœ°å›¾ç‚¹å‡»ï¼Œè·³è¿‡å…³é—­æŠ½å±‰é€»è¾‘');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº† UI äº¤äº’å…ƒç´ ï¼ˆæŒ‰é’®ã€è¾“å…¥æ¡†ç­‰ï¼‰
            const isUIClick = e.target.closest('.max-w-\\[1600px\\]') && 
                             (e.target.tagName === 'BUTTON' || 
                              e.target.tagName === 'INPUT' || 
                              e.target.tagName === 'SELECT' ||
                              e.target.tagName === 'TEXTAREA' ||
                              e.target.tagName === 'A' ||
                              e.target.closest('button') ||
                              e.target.closest('input') ||
                              e.target.closest('select') ||
                              e.target.closest('a'));
            
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ UI å…ƒç´ ï¼Œä¹Ÿä¸æ˜¯åœ°å›¾ï¼Œåˆ™å…³é—­æŠ½å±‰
            if (!isUIClick) {
                console.log('[Drawer] ç‚¹å‡»å¤–éƒ¨åŒºåŸŸï¼Œå…³é—­æŠ½å±‰');
                selectedCountry = null;
                closeDrawers();
            }
        });

        /**
         * ç­‰å¾…åœ°å›¾æ•°æ®åŠ è½½å®Œæˆ
         */
        async function waitForMapData(maxWait = 10000) {
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWait) {
                if (await checkMapLoaded()) {
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.warn('[Map] âš ï¸ ç­‰å¾…åœ°å›¾æ•°æ®è¶…æ—¶');
            return false;
        }

        // ä¿å­˜å…¨å±€åœ°å›¾æ•°æ®ï¼Œä¾›æŠ½å±‰ä½¿ç”¨
        let globalLocationData = [];

        /**
         * ISO2 å›½å®¶ä»£ç  -> ECharts world.js åœ°å›¾åç§°æ˜ å°„ï¼ˆç¡®ä¿åç«¯ CN ç­‰èƒ½ç²¾å‡†å¯¹åº”åœ°å›¾ï¼‰
         * ISO_NAME_MAP ä¹‹å¤–çš„ç”± Intl.DisplayNames è¡¥å…¨
         */
        const ISO_NAME_MAP = {
            'CN': 'China', 'US': 'United States of America', 'GB': 'United Kingdom', 'UK': 'United Kingdom',
            'JP': 'Japan', 'KR': 'South Korea', 'DE': 'Germany', 'FR': 'France', 'IN': 'India', 'BR': 'Brazil',
            'RU': 'Russia', 'IT': 'Italy', 'CA': 'Canada', 'AU': 'Australia', 'ES': 'Spain', 'MX': 'Mexico',
            'ID': 'Indonesia', 'NL': 'Netherlands', 'PL': 'Poland', 'TR': 'Turkey', 'SA': 'Saudi Arabia',
            'TW': 'Taiwan', 'HK': 'Hong Kong', 'SG': 'Singapore', 'MY': 'Malaysia', 'TH': 'Thailand',
            'VN': 'Vietnam', 'PH': 'Philippines', 'PK': 'Pakistan', 'BD': 'Bangladesh', 'EG': 'Egypt',
            'ZA': 'South Africa', 'AR': 'Argentina', 'CL': 'Chile', 'CO': 'Colombia', 'SE': 'Sweden',
            'CH': 'Switzerland', 'BE': 'Belgium', 'AT': 'Austria', 'PT': 'Portugal', 'IL': 'Israel',
            'UA': 'Ukraine', 'RO': 'Romania', 'CZ': 'Czech Republic', 'HU': 'Hungary', 'GR': 'Greece',
            'IE': 'Ireland', 'NZ': 'New Zealand', 'NO': 'Norway', 'FI': 'Finland', 'DK': 'Denmark',
        };
        // åŠ¨æ€åˆ†æ¯ï¼šç”± initGlobalMap å†… processedData.length æä¾›ï¼Œç¦æ­¢ç¡¬ç¼–ç  195
        function getMapNameFromIso2(code) {
            if (!code || !/^[A-Z]{2}$/.test(String(code).toUpperCase())) return code || '';
            const upper = String(code).toUpperCase();
            if (ISO_NAME_MAP[upper]) return ISO_NAME_MAP[upper];
            try {
                var dn = typeof Intl !== 'undefined' && Intl.DisplayNames ? new Intl.DisplayNames(['en'], { type: 'region' }) : null;
                if (dn) return dn.of(upper) || upper;
            } catch (_) { /* ignore */ }
            return upper;
        }

        /**
         * åˆå§‹åŒ–å…¨çƒ 2D åœ°å›¾ï¼ˆæ”¯æŒç¼©æ”¾ä¸æ‹–åŠ¨ï¼‰
         * @param {Array} locationData - åœ°ç†ä½ç½®æ•°æ® [{name: string, value: number}]ï¼ˆå…¼å®¹æ—§ APIï¼‰
         * @param {Object} opts - å¯é€‰ { countryStats: Array, updatedAt: string } å›½å®¶ç´¯ç§¯æ’åï¼ˆGLOBAL_COUNTRY_STATSï¼‰
         */
        async function initGlobalMap(locationData, opts) {
            // ã€ä¼˜å…ˆåˆ¤æ–­ã€‘åœ¨åœ°å›¾åˆå§‹åŒ–æ—¶æ£€æŸ¥ localStorage é”å®šçŠ¶æ€
            try {
                if (window.mapCursorManager) {
                    // é‡æ–°åˆå§‹åŒ–å…‰æ ‡ç®¡ç†å™¨ï¼ˆä» localStorage æ¢å¤çŠ¶æ€ï¼‰
                    window.mapCursorManager.init();
                    
                    // å¦‚æœå·²é”šå®šï¼Œä¼˜å…ˆä½¿ç”¨é”šå®šåæ ‡æ˜¾ç¤ºå…‰æ ‡
                    if (window.mapCursorManager.isAnchored && 
                        window.mapCursorManager.anchoredCoords.lng !== null && 
                        window.mapCursorManager.anchoredCoords.lat !== null) {
                        const anchored = window.mapCursorManager.anchoredCoords;
                        console.log('[InitMap] ğŸ”’ æ£€æµ‹åˆ°é”šå®šçŠ¶æ€ï¼Œä¼˜å…ˆä½¿ç”¨é”šå®šåæ ‡:', anchored);
                        
                        // å»¶è¿Ÿæ˜¾ç¤ºå…‰æ ‡ï¼Œç¡®ä¿åœ°å›¾å®Œå…¨åˆå§‹åŒ–
                        setTimeout(() => {
                            if (typeof setOrUpdateCurrentLocationCursor === 'function') {
                                try {
                                    const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                                    const statusColor = statusConfig.status_color;
                                    const githubUsername = localStorage.getItem('github_username') || null;
                                    const avatarUrl = isValidGitHubUsername(githubUsername) 
                                        ? getGitHubAvatarUrl(githubUsername) 
                                        : DEFAULT_AVATAR;
                                    
                                    setOrUpdateCurrentLocationCursor(
                                        anchored.lng, 
                                        anchored.lat, 
                                        statusColor, 
                                        avatarUrl, 
                                        githubUsername,
                                        true // force: trueï¼Œå¼ºåˆ¶æ›´æ–°
                                    );
                                } catch (e) {
                                    console.warn('[InitMap] âš ï¸ æ˜¾ç¤ºé”šå®šå…‰æ ‡å¤±è´¥:', e);
                                }
                            }
                        }, 500);
                    }
                }
            } catch (e) {
                console.warn('[InitMap] âš ï¸ æ£€æŸ¥é”å®šçŠ¶æ€å¤±è´¥:', e);
            }
            try {
                // ä¿å­˜åˆ°å…¨å±€å˜é‡
                globalLocationData = locationData || [];
                const chartDom = document.getElementById('map-container');
                if (!chartDom) {
                    console.warn('[Map] âš ï¸ æ‰¾ä¸åˆ°åœ°å›¾å®¹å™¨å…ƒç´ ');
                    return;
                }
                
                // æ£€æŸ¥ ECharts å’Œ ECharts GL æ˜¯å¦å·²åŠ è½½
                if (typeof echarts === 'undefined') {
                    console.warn('[Map] âš ï¸ ECharts æœªåŠ è½½ï¼Œæ— æ³•æ¸²æŸ“åœ°å›¾');
                    return;
                }
                
                // æ¸²æŸ“ä»¤ç‰Œï¼ˆåªå…è®¸æœ€åä¸€æ¬¡è°ƒç”¨ç»§ç»­æ‰§è¡Œï¼‰
                const seq = ++mapRenderSeq;
                // å¦‚æœè¿™æ¬¡è°ƒç”¨å·²ç»è¿‡æœŸï¼Œç›´æ¥é€€å‡ºï¼ˆé¿å… dispose åè¿˜ç»§ç»­ setOptionï¼‰
                if (seq !== mapRenderSeq) return;

                // ç­‰å¾…åœ°å›¾æ•°æ®åŠ è½½å®Œæˆï¼ˆå°½é‡ç­‰å¾…ï¼Œä½†ä¸å¼ºåˆ¶é˜»æ–­æ¸²æŸ“ï¼‰
                try {
                    await waitForMapData(5000);
                } catch (e) {
                    console.warn('[Map] âš ï¸ åœ°å›¾æ•°æ®æ£€æŸ¥è¶…æ—¶ï¼Œç»§ç»­å°è¯•æ¸²æŸ“');
                }

                // å¤ç”¨å®ä¾‹ï¼šä¸å­˜åœ¨åˆ™ initï¼Œå­˜åœ¨åˆ™ clearï¼ˆé¿å… dispose å¹¶å‘é—®é¢˜ï¼‰
                try {
                    if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                        mapChart = echarts.init(chartDom, null, { renderer: 'canvas' });
                    } else {
                        mapChart.clear();
                    }
                } catch (e) {
                    // å…œåº•ï¼šå¦‚æœå®ä¾‹å¼‚å¸¸ï¼Œå°è¯•é‡æ–°åˆ›å»º
                    mapChart = echarts.init(chartDom, null, { renderer: 'canvas' });
                }
                
                // åœ°å›¾æ•°æ®å¿…é¡»å·²æ³¨å†Œï¼Œå¦åˆ™ç­‰å¾…å¹¶é‡è¯•
                if (!echarts.getMap || !echarts.getMap('world')) {
                    console.warn('[Map] âš ï¸ world åœ°å›¾æ•°æ®æœªæ³¨å†Œï¼ˆworld.js æœªåŠ è½½å®Œæˆï¼‰ï¼Œç­‰å¾…é‡è¯•...');
                    // ç­‰å¾… world.js åŠ è½½ï¼Œæœ€å¤šç­‰å¾… 5 ç§’
                    let retryCount = 0;
                    const maxRetries = 50; // 50 * 100ms = 5ç§’
                    while (retryCount < maxRetries && (!echarts.getMap || !echarts.getMap('world'))) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        retryCount++;
                    }
                    
                    if (!echarts.getMap || !echarts.getMap('world')) {
                        console.error('[Map] âŒ world åœ°å›¾æ•°æ®åŠ è½½è¶…æ—¶');
                        chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">åœ°å›¾æ•°æ®åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢</div>';
                        return;
                    }
                    console.log('[Map] âœ… world åœ°å›¾æ•°æ®å·²åŠ è½½');
                }

                // æ•°æ®æºä¼˜å…ˆçº§ï¼šcountryStatsï¼ˆGLOBAL_COUNTRY_STATSï¼‰> locationDataï¼ˆå…¼å®¹æ—§ APIï¼‰
                const countryStats = opts && opts.countryStats;
                const mapUpdatedAt = opts && opts.updatedAt;
                let processedData;
                if (countryStats && Array.isArray(countryStats) && countryStats.length > 0) {
                    const totalCnt = countryStats.length;
                    const top10Pct = Math.max(3, Math.ceil(totalCnt * 0.1));
                    processedData = countryStats.map(item => {
                        const code = String(item.country_code || item.code || '').trim().toUpperCase();
                        const mapName = getMapNameFromIso2(code) || (countryNameMap && countryNameMap[code] && countryNameMap[code].en) || code;
                        const totalMessages = Number(item.total_messages_sum ?? item.total_messages ?? 0) || 0;
                        const rank = Number(item.rank_total_messages ?? item.rank ?? 0) || null;
                        let rankCategory = 0;
                        if (rank === 1) rankCategory = 3;
                        else if (rank >= 2 && rank <= 3) rankCategory = 2;
                        else if (rank >= 4 && rank <= top10Pct) rankCategory = 1;
                        return {
                            name: mapName,
                            value: rankCategory,
                            rankCategory: rankCategory,
                            totalMessages: totalMessages,
                            rank: rank,
                            countryCode: code
                        };
                    }).filter(d => d.name && (d.totalMessages > 0 || d.rank));
                } else {
                    processedData = (locationData || []).map(item => ({
                        name: (countryNameMap && countryNameMap[item.name] ? countryNameMap[item.name].en : (item.name === 'USA' ? 'United States of America' : item.name)),
                        value: item.value || 0,
                        totalMessages: item.value || 0,
                        rank: item.rank || null
                    }));
                }
                const useRankColors = !!(countryStats && countryStats.length > 0);
                const maxVal = Math.max(20, ...processedData.map(d => d.value || 0));
                const totalCountries = processedData.length;

                const option2D = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'item',
                        confine: false,
                        position: function (point, params, dom, rect, size) {
                            var tipH = (size && size.contentSize) ? size.contentSize[1] : 60;
                            return [point[0], point[1] - tipH - 12];
                        },
                        backgroundColor: '#18181b',
                        borderColor: '#27272a',
                        textStyle: { color: '#00ff41', fontFamily: 'JetBrains Mono' },
                        formatter: function(params) {
                            if (!params) return '<div class="font-mono text-xs">æœªçŸ¥åŒºåŸŸ</div>';
                            if (params.seriesType === 'map') {
                                const name = params.name || params.data?.name || 'æœªçŸ¥åŒºåŸŸ';
                                const dataItem = params.data || {};
                                const totalMessages = Number(dataItem.totalMessages ?? dataItem.value ?? 0) || 0;
                                const rank = dataItem.rank;
                                const code = dataItem.countryCode || (typeof resolveCountryCodeFromMapName === 'function' ? resolveCountryCodeFromMapName(name) : null);
                                var label = (code && countryNameMap && countryNameMap[code] && countryNameMap[code].zh) ? countryNameMap[code].zh : name;
                                if (code && label === name && typeof Intl !== 'undefined' && Intl.DisplayNames) {
                                    try {
                                        var dnLabel = new Intl.DisplayNames([currentLang === 'en' ? 'en' : 'zh-CN'], { type: 'region' }).of(String(code).toUpperCase());
                                        if (dnLabel) label = dnLabel;
                                    } catch (_) { /* ignore */ }
                                }
                                const isProxy = dataItem.is_proxy || dataItem.isProxy || false;
                                const proxyLabel = isProxy ? '<span style="color: #ef4444; font-weight: bold;"> [Proxy]</span>' : '';
                                const msgsLabel = currentLang === 'en' ? 'Total Messages' : 'ç´¯è®¡åæ§½èƒ½é‡';
                                const rankLabel = currentLang === 'en' ? 'Global Rank' : 'å…¨çƒæ’å';
                                const dimLabel = currentLang === 'en' ? 'Top Dimension' : 'æœ€çªå‡ºç»´åº¦';
                                const activeNodesLabel = getI18nText('tooltip.active_nodes') || (currentLang === 'en' ? 'Active Nodes' : 'æ´»è·ƒèŠ‚ç‚¹');
                                let tooltipContent;
                                if (currentChampionInfo && currentChampionInfo.countryName === name) {
                                    const feedback = currentChampionInfo.feedback ? JSON.parse(currentChampionInfo.feedback) : null;
                                    const recordLabel = getI18nText('tooltip.record') || (currentLang === 'en' ? 'Record' : 'æˆ˜ç»©');
                                    const roastLabel = getI18nText('tooltip.roast') || (currentLang === 'en' ? 'Roast' : 'åæ§½');
                                    const translatedFbLabel = feedback ? translateRankFeedbackLabel(currentChampionInfo.dimId, feedback.label, currentChampionInfo.championValue) : '';
                                    tooltipContent = `<div class="font-mono text-xs"><div class="text-[#00ff41] font-bold mb-1">ğŸ† ${currentChampionInfo.championName}</div><div class="text-white mb-1">${label}${proxyLabel}</div><div class="text-zinc-400 text-[10px] mb-1">${escapeHtml(activeNodesLabel)}: ${totalMessages}</div><div class="text-zinc-400 text-[10px] mb-1">${escapeHtml(recordLabel)}: ${currentChampionInfo.championValue}</div>${feedback ? `<div class="text-zinc-500 text-[9px] mt-2 pt-2 border-t border-zinc-700"><div class="text-[#00ff41]">${escapeHtml(roastLabel)}${translatedFbLabel ? ' Â· ' + escapeHtml(translatedFbLabel) : ''}</div><div class="text-white">${escapeHtml(String(feedback.title || '').trim())}</div></div>` : ''}</div>`;
                                } else if (useRankColors) {
                                    tooltipContent = `<div class="font-mono text-xs"><b>${label}</b>${proxyLabel}<br/>${msgsLabel}: ${new Intl.NumberFormat().format(totalMessages)}`;
                                    const denom = (typeof totalCountries !== 'undefined' && totalCountries > 0) ? totalCountries : 195;
                                    if (rank != null && rank > 0) tooltipContent += `<br/>${rankLabel}: #${rank}/${denom}`;
                                    tooltipContent += `<br/>${dimLabel}: --</div>`;
                                } else {
                                    tooltipContent = `<div class="font-mono text-xs">${label}${proxyLabel}<br/>${escapeHtml(activeNodesLabel)}: ${totalMessages}</div>`;
                                }
                                return tooltipContent;
                            }
                            // å¦‚æœæ˜¯è„‰å†²ç‚¹ï¼ˆeffectScatterï¼‰ï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«å¤´åƒé¢„è§ˆï¼‰
                            if (params.seriesType === 'effectScatter' && params.data) {
                                const pointData = params.data;
                                // ä»æ•°æ®ç‚¹ä¸­è·å–å¤´åƒä¿¡æ¯
                                const avatarUrl = pointData.avatarUrl || params.series?.avatarUrl || null;
                                const username = pointData.username || params.series?.username || null;
                                const userName = params.name || username || 'ç”¨æˆ·';
                                
                                if (avatarUrl || username) {
                                    // åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœ username æ— æ•ˆï¼Œä½¿ç”¨ DEFAULT_AVATAR
                                    let finalAvatarUrl = avatarUrl;
                                    if (!finalAvatarUrl && username) {
                                        // ã€Task 3ã€‘å¯¹äºåœ°å›¾ä¸Šçš„ç”¨æˆ·ç‚¹ï¼Œå¦‚æœæ˜¯ fingerprint ç”¨æˆ·åˆ™è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                                        // æ³¨æ„ï¼šè¿™é‡Œæ— æ³•è·å– user_identityï¼Œæ‰€ä»¥ä¿æŒåŸé€»è¾‘ï¼ˆåªæ£€æŸ¥ GitHub ç”¨æˆ·åæ ¼å¼ï¼‰
                                        if (isValidGitHubUsername(username)) {
                                            finalAvatarUrl = getGitHubAvatarUrl(username);
                                        } else {
                                            finalAvatarUrl = DEFAULT_AVATAR;
                                        }
                                    }
                                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒURLï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                                    if (!finalAvatarUrl) {
                                        finalAvatarUrl = DEFAULT_AVATAR;
                                    }
                                    
                                    // ä½¿ç”¨HTMLæ ¼å¼è¿”å›ï¼ŒåŒ…å«å¤´åƒå›¾ç‰‡
                                    // ECharts tooltipæ”¯æŒHTMLï¼Œå¯ä»¥ç›´æ¥åµŒå…¥imgæ ‡ç­¾
                                    return `
                                        <div style="display: flex; align-items: center; gap: 8px; padding: 4px;">
                                            <img 
                                                src="${finalAvatarUrl}" 
                                                alt="avatar" 
                                                style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #27272a;"
                                                onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                                            />
                                            <div>
                                                <div style="color: #00ff41; font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: bold;">${userName}</div>
                                                <div style="color: #71717a; font-family: 'JetBrains Mono', monospace; font-size: 10px;">ç”¨æˆ·</div>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                return `<div style="color: #00ff41; font-family: 'JetBrains Mono', monospace;">ğŸ‘¤ ${userName}</div>`;
                            }
                            return params.name || '';
                        },
                        // å¯ç”¨HTMLæ¸²æŸ“æ¨¡å¼
                        extraCssText: 'box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);'
                    },
                    visualMap: useRankColors ? {
                        type: 'piecewise',
                        show: true,
                        orient: 'horizontal',
                        left: 'center',
                        bottom: 8,
                        pieces: [
                            { min: 3, max: 3, label: (currentLang === 'en' ? 'Champion' : 'å† å†›'), color: '#ffd700' },
                            { min: 2, max: 2, label: (currentLang === 'en' ? 'Top 3' : 'å‰ä¸‰å¼º'), color: '#c0c0c0' },
                            { min: 1, max: 1, label: (currentLang === 'en' ? 'Top 10%' : 'å‰10%'), color: '#7021d2' },
                            { min: 0, max: 0, label: (currentLang === 'en' ? 'Others' : 'å…¶ä»–åœ°åŒº'), color: '#a0aec0' }
                        ],
                        textStyle: { color: '#94a3b8', fontSize: 10 },
                        dimension: 'rankCategory'
                    } : {
                        min: 0,
                        max: maxVal,
                        show: false,
                        inRange: { color: ['#064e3b', '#065f46', '#00ff41', '#34d399'] }
                    },
                    geo: {
                        map: 'world',
                        roam: true, // å¯ç”¨æ‹–åŠ¨å’Œç¼©æ”¾
                        scaleLimit: { min: 1, max: 8 },
                        zoom: 1.2,
                        itemStyle: {
                            areaColor: 'transparent',
                            borderColor: 'transparent',
                            borderWidth: 0
                        },
                        silent: true // é™é»˜æ¨¡å¼ï¼Œä¸å“åº”é¼ æ ‡äº‹ä»¶ï¼Œè®© map ç³»åˆ—å¤„ç†
                    },
                    series: [{
                        type: 'map',
                        map: 'world',
                        // å¯ç”¨æ‹–åŠ¨å’Œç¼©æ”¾
                        roam: true,
                        // é™åˆ¶ç¼©æ”¾èŒƒå›´ï¼Œé¿å…æ— é™æ”¾å¤§/ç¼©å°
                        scaleLimit: { min: 1, max: 8 },
                        zoom: 1.2,
                        itemStyle: {
                            areaColor: 'transparent',
                            borderColor: 'rgba(0, 255, 65, 0.2)',
                            borderWidth: 1
                        },
                        emphasis: {
                            itemStyle: { 
                                areaColor: 'rgba(0, 255, 65, 0.4)',
                                borderColor: '#00ff41',
                                borderWidth: 2
                            },
                            label: { show: false }
                        },
                        data: processedData
                    }]
                };

                // notMerge: true å½»åº•æ›¿æ¢ï¼Œé¿å…æ®‹ç•™æ—§é…ç½®
                mapChart.setOption(option2D, { notMerge: true, lazyUpdate: false });
                // æ˜¾ç¤ºæ•°æ®æ›´æ–°æ—¶é—´ï¼ˆæ¯å°æ—¶å¿«ç…§ï¼‰
                const updatedEl = document.getElementById('map-updated-at');
                if (updatedEl && mapUpdatedAt) {
                    try {
                        const d = new Date(mapUpdatedAt);
                        const fmt = isNaN(d.getTime()) ? mapUpdatedAt : d.toLocaleString(currentLang === 'en' ? 'en-US' : 'zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                        updatedEl.textContent = (currentLang === 'en' ? 'Data updated: ' : 'æ•°æ®æ›´æ–°äºï¼š') + fmt;
                        updatedEl.style.display = '';
                    } catch (_) { updatedEl.style.display = 'none'; }
                } else if (updatedEl) updatedEl.style.display = 'none';

                // æ·»åŠ é¼ æ ‡æ‚¬æµ®é«˜äº®æ•ˆæœ
                mapChart.off('mouseover');
                mapChart.on('mouseover', (params) => {
                    if (params.seriesType === 'map' && params.name) {
                        try {
                            // é«˜äº®å½“å‰æ‚¬æµ®çš„å›½å®¶
                            mapChart.dispatchAction({
                                type: 'highlight',
                                name: params.name
                            });
                        } catch (e) {
                            console.warn('[Map] âš ï¸ æ‚¬æµ®é«˜äº®å¤±è´¥:', e);
                        }
                    }
                });

                mapChart.off('mouseout');
                mapChart.on('mouseout', (params) => {
                    if (params.seriesType === 'map' && params.name) {
                        try {
                            // å–æ¶ˆé«˜äº®
                            mapChart.dispatchAction({
                                type: 'downplay',
                                name: params.name
                            });
                            // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„å›½å®¶ï¼Œé‡æ–°é«˜äº®å®ƒ
                            const selectedCountry = localStorage.getItem('user_selected_country');
                            if (selectedCountry) {
                                // å°è¯•è·å–å›½å®¶åç§°
                                const countryName = countryNameMap?.[selectedCountry]?.en || selectedCountry;
                                if (countryName && countryName !== params.name) {
                                    setTimeout(() => {
                                        try {
                                            mapChart.dispatchAction({
                                                type: 'highlight',
                                                name: countryName
                                            });
                                        } catch (e) {
                                            // ignore
                                        }
                                    }, 100);
                                }
                            }
                        } catch (e) {
                            console.warn('[Map] âš ï¸ å–æ¶ˆé«˜äº®å¤±è´¥:', e);
                        }
                    }
                });

                // é€‰æ‹©å›½å®¶åé«˜äº®æ˜¾ç¤º
                function highlightSelectedCountry() {
                    try {
                        const selectedCountry = localStorage.getItem('user_selected_country');
                        if (selectedCountry && mapChart && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                            // å…ˆå–æ¶ˆæ‰€æœ‰é«˜äº®
                            try {
                                mapChart.dispatchAction({
                                    type: 'downplay'
                                });
                            } catch (e) {
                                // ignore
                            }

                            // è·å–å›½å®¶åç§°ï¼ˆå°è¯•å¤šç§æ–¹å¼ï¼‰
                            let countryName = null;
                            
                            // æ–¹å¼1ï¼šä» countryNameMap è·å–
                            if (countryNameMap && countryNameMap[selectedCountry]) {
                                countryName = countryNameMap[selectedCountry].en || countryNameMap[selectedCountry].zh;
                            }
                            
                            // æ–¹å¼2ï¼šå¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•ä½¿ç”¨ resolveCountryCodeFromMapName åå‘æŸ¥æ‰¾
                            if (!countryName && typeof resolveCountryCodeFromMapName === 'function') {
                                // éœ€è¦åå‘æŸ¥æ‰¾ï¼šä»ä»£ç æ‰¾åç§°
                                // è¿™é‡Œå…ˆå°è¯•ç›´æ¥ä½¿ç”¨ä»£ç ä½œä¸ºåç§°
                                countryName = selectedCountry;
                            }
                            
                            // æ–¹å¼3ï¼šå°è¯•ä» ISO æ˜ å°„æŸ¥æ‰¾
                            if (!countryName && window.__isoNameToIso2 instanceof Map) {
                                for (const [name, code] of window.__isoNameToIso2.entries()) {
                                    if (String(code).toUpperCase() === String(selectedCountry).toUpperCase()) {
                                        countryName = name;
                                        break;
                                    }
                                }
                            }

                            if (countryName) {
                                setTimeout(() => {
                                    try {
                                        // é«˜äº®é€‰ä¸­çš„å›½å®¶
                                        mapChart.dispatchAction({
                                            type: 'highlight',
                                            name: countryName
                                        });
                                        console.log('[Map] âœ… å·²é«˜äº®é€‰ä¸­çš„å›½å®¶:', countryName, 'ä»£ç :', selectedCountry);
                                    } catch (e) {
                                        console.warn('[Map] âš ï¸ é«˜äº®é€‰ä¸­å›½å®¶å¤±è´¥:', e, 'å›½å®¶åç§°:', countryName);
                                    }
                                }, 300);
                            } else {
                                console.warn('[Map] âš ï¸ æ— æ³•æ‰¾åˆ°å›½å®¶åç§°ï¼Œä»£ç :', selectedCountry);
                            }
                        }
                    } catch (e) {
                        console.warn('[Map] âš ï¸ highlightSelectedCountry å¤±è´¥:', e);
                    }
                }

                // é¡µé¢åŠ è½½æ—¶é«˜äº®é€‰ä¸­çš„å›½å®¶
                highlightSelectedCountry();
                // ä¿å­˜å‡½æ•°åˆ°å…¨å±€ï¼Œä¾›é€‰æ‹©å›½å®¶åè°ƒç”¨
                window.highlightSelectedCountry = highlightSelectedCountry;

                // é¡µé¢åŠ è½½æ—¶æ¢å¤é€‰æ‹©çš„å›½å®¶å¹¶æ˜¾ç¤ºå…‰æ ‡
                setTimeout(() => {
                    try {
                        const savedCountry = localStorage.getItem('user_selected_country');
                        if (savedCountry) {
                            setOrUpdateCurrentLocationCursor(savedCountry);
                            highlightSelectedCountry();
                        }
                    } catch (e) {
                        console.warn('[Map] âš ï¸ æ¢å¤é€‰æ‹©çš„å›½å®¶å¤±è´¥:', e);
                    }
                }, 500);

                // ====== è‡ªæ„ˆï¼šåœ°å›¾é‡ç»˜åï¼Œç¡®ä¿ã€ŒCurrent Locationã€å…‰æ ‡ä¸ä¼šè¢« notMerge:true æ¸…æ‰ ======
                try {
                    bindMapCursorSelfHeal();
                    // å¦‚æœæœ¬åœ°/å…¨å±€å·²æœ‰åæ ‡ï¼Œæ¸²æŸ“åç«‹å³æ¢å¤å…‰æ ‡ï¼ˆè§£å†³â€œéšæœºæ¶ˆå¤±ä¸”åˆ·æ–°æ— æ•ˆâ€ï¼‰
                    // ã€ä¿®å¤ã€‘å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿åœ°å›¾å®Œå…¨æ¸²æŸ“å®Œæˆ
                    setTimeout(() => {
                        try {
                            if (typeof ensureCurrentLocationCursorIfMissing === 'function') {
                                ensureCurrentLocationCursorIfMissing('initGlobalMap-after-setOption');
                            }
                        } catch (e) {
                            console.warn('[Map] âš ï¸ æ¢å¤å…‰æ ‡å¤±è´¥:', e);
                        }
                    }, 300);
                    // ç»‘å®šæ ¡å‡†æ‹–æ‹½äº¤äº’ï¼ˆä»…æ ¡å‡†æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼‰
                    bindCurrentLocationDragHandlers();
                 } catch (e) {
                     console.warn('[Map] âš ï¸ ç»‘å®šå…‰æ ‡è‡ªæ„ˆ/æ‹–æ‹½å¤±è´¥:', e);
                 }

                  // ã€æ–°åŠŸèƒ½ã€‘æ¢å¤å›ºå®šçš„å±å¹•å…‰æ ‡
                  try {
                      restoreFixedCursor();
                      // ç»‘å®š roam/finished åŒæ­¥ï¼Œé¿å…æ‹–åŠ¨åœ°å›¾æˆ–åˆ·æ–°é‡ç»˜åâ€œé£˜ç§»â€
                      bindFixedCursorFollowMap();
                      syncFixedCursorGraphicPosition('initGlobalMap-after-restoreFixedCursor');
                  } catch (e) {
                      console.warn('[Map] âš ï¸ æ¢å¤å›ºå®šå…‰æ ‡å¤±è´¥:', e);
                  }

                  // ã€æ–°å¢ã€‘ç»‘å®š graphic å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºå›ºå®šå…‰æ ‡çš„ç‚¹å‡»å¤„ç†ï¼‰
                  try {
                      const zr = typeof mapChart.getZr === 'function' ? mapChart.getZr() : null;
                      if (zr) {
                          // è§£ç»‘æ—§ handlerï¼Œé¿å…é‡å¤ç»‘å®š
                          try {
                              if (window.__graphicClickHandler) {
                                  zr.off('click', window.__graphicClickHandler);
                              }
                          } catch { /* ignore */ }

                          window.__graphicClickHandler = (evt) => {
                              console.log('[Homeland] ğŸ–±ï¸ æ£€æµ‹åˆ° zr click äº‹ä»¶:', evt);
                              if (!__cursorFixedToHomeland) return;

                              // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯å›ºå®šå…‰æ ‡
                              try {
                                  const target = evt.target;
                                  console.log('[Homeland] ç‚¹å‡»ç›®æ ‡:', target);

                                  // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å›ºå®šå…‰æ ‡ç›¸å…³çš„å…ƒç´ 
                                  let isFixedCursorClick = false;
                                  if (target && target.type === 'group' && target.id === 'fixed-cursor') {
                                      isFixedCursorClick = true;
                                  } else if (target && target.parent && target.parent.id === 'fixed-cursor') {
                                      isFixedCursorClick = true;
                                  } else if (evt.relatedTarget && evt.relatedTarget.id === 'fixed-cursor') {
                                      isFixedCursorClick = true;
                                  }

                                  if (isFixedCursorClick) {
                                      console.log('[Homeland] ğŸ–±ï¸ ç‚¹å‡»å›ºå®šå…‰æ ‡ï¼Œå¼¹å‡ºè§£é™¤å›ºå®šæç¤º');
                                      showUnfixConfirmation(() => {
                                          // ç¡®è®¤è§£é™¤å›ºå®š
                                          removeFixedCursor();
                                          __cursorFixedToHomeland = false;
                                          localStorage.removeItem('cursor_fixed_to_homeland');
                                          console.log('[Homeland] âœ… å·²è§£é™¤æ¯å›½å›ºå®š');
                                      }, () => {
                                          // å–æ¶ˆ
                                          console.log('[Homeland] âš ï¸ å–æ¶ˆè§£é™¤å›ºå®š');
                                      });
                                  }
                              } catch (e) {
                                  console.warn('[Homeland] å¤„ç† graphic ç‚¹å‡»äº‹ä»¶å¤±è´¥:', e);
                              }
                          };

                          zr.on('click', window.__graphicClickHandler);
                          console.log('[Homeland] âœ… å·²ç»‘å®š graphic å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶');
                      }
                  } catch (e) {
                      console.warn('[Homeland] âš ï¸ ç»‘å®š graphic ç‚¹å‡»äº‹ä»¶å¤±è´¥:', e);
                  }

                  // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶å¤„ç† - é‡æ–°è®¾è®¡é€»è¾‘ï¼ˆå«æ ¡å‡†æ¨¡å¼ï¼‰
                mapChart.off('click'); // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                mapChart.on('click', async (params) => {
                    console.log('[Map] âœ… åœ°å›¾ç‚¹å‡»äº‹ä»¶å·²è§¦å‘:', params);
                    
                     // ========== ç‚¹å‡»ã€ŒCurrent Locationã€å…‰æ ‡ï¼šè¿›å…¥æ ¡å‡†æ¨¡å¼æˆ–è§£é™¤å›ºå®š ==========
                     const isCurrentLocationClick = params.seriesType === 'effectScatter' && params.seriesName === 'Current Location';
                     if (isCurrentLocationClick) {
                         // ã€æ–°åŠŸèƒ½ã€‘å¦‚æœå…‰æ ‡å·²å›ºå®šåœ¨æ¯å›½ï¼Œå¼¹å‡ºè§£é™¤å›ºå®šæç¤º
                         if (__cursorFixedToHomeland) {
                             showUnfixConfirmation(() => {
                                 // ç¡®è®¤è§£é™¤å›ºå®š
                                 removeFixedCursor();
                                 __cursorFixedToHomeland = false;
                                 localStorage.removeItem('cursor_fixed_to_homeland');
                                 console.log('[Homeland] âœ… å·²è§£é™¤æ¯å›½å›ºå®š');
                             }, () => {
                                 // å–æ¶ˆ
                                 console.log('[Homeland] âš ï¸ å–æ¶ˆè§£é™¤å›ºå®š');
                             });
                             return;
                         }

                         // åŸæœ‰é€»è¾‘ï¼šè¿›å…¥æ ¡å‡†æ¨¡å¼
                         if (!isCalibrating) {
                             isCalibrating = true;
                             updateCurrentLocationCursorColor('#3b82f6');
                             console.log('[Map] ğŸ“ è¿›å…¥æ ¡å‡†æ¨¡å¼ï¼Œå…‰æ ‡å·²å˜è“');
                         }
                         return;
                     }
                    
                    // ========== é”šå®šæ¨¡å¼ä¸‹ç‚¹å‡»åœ°å›¾ä»»æ„ä½ç½®ï¼šç«‹å³ç§»åŠ¨å…‰æ ‡å¹¶é”å®š ==========
                    if (isAnchorMode) {
                        try {
                            const dom = mapChart.getDom();
                            if (dom && params.event) {
                                const rect = dom.getBoundingClientRect();
                                const x = (params.event.clientX != null ? params.event.clientX : params.event.offsetX) - rect.left;
                                const y = (params.event.clientY != null ? params.event.clientY : params.event.offsetY) - rect.top;
                                const point = mapChart.convertFromPixel('geo', [x, y]);
                                if (point && Array.isArray(point) && point.length >= 2) {
                                    const lng = Number(point[0]), lat = Number(point[1]);
                                    if (!isNaN(lng) && !isNaN(lat)) {
                                        // ç«‹å³ç§»åŠ¨å…‰æ ‡
                                        moveCurrentLocationCursor(lng, lat);
                                        
                                        // è·å–å›½å®¶ä»£ç 
                                        let countryCode = null;
                                        let countryName = null;
                                        const hasValidName = params.name && typeof params.name === 'string' && params.name.trim() !== '';
                                        if (params.seriesType === 'map' && hasValidName) {
                                            countryName = params.name;
                                            countryCode = typeof resolveCountryCodeFromMapName === 'function'
                                                ? resolveCountryCodeFromMapName(countryName)
                                                : null;
                                            if (!countryCode) {
                                                for (const [code, names] of Object.entries(countryNameMap || {})) {
                                                    if (names.en === countryName || names.zh === countryName || code === countryName) {
                                                        countryCode = code;
                                                        break;
                                                    }
                                                }
                                            }
                                        } else {
                                            // æ— å›½å®¶åç§°ï¼ˆç‚¹åˆ°æµ·ä¸Šç­‰ï¼‰ï¼šä½¿ç”¨è½»é‡åˆ¤å›½
                                            countryCode = typeof getCountryByCoords === 'function' ? getCountryByCoords(lng, lat) : null;
                                            if (countryCode) {
                                                countryName = countryNameMap?.[countryCode]?.en || countryCode;
                                            }
                                        }
                                        
                                        // ç«‹å³ä¿å­˜å¹¶é”å®š
                                        saveManualLocation(countryCode || '', lng, lat);
                                        
                                        // é€€å‡ºé”šå®šæ¨¡å¼
                                        setAnchorMode(false);
                                        
                                        console.log('[Anchor] âœ… å·²é”šå®šä½ç½®:', { lng, lat, countryCode, countryName });
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('[Anchor] âš ï¸ é”šå®šå¤±è´¥:', e);
                        }
                        return;
                    }
                    
                    // ========== æ ¡å‡†æ¨¡å¼ä¸‹ç‚¹å‡»åœ°å›¾ä»»æ„ä½ç½®ï¼šconvertFromPixel æ•è·ç»çº¬åº¦å¹¶ç§»åŠ¨å…‰æ ‡ ==========
                    if (isCalibrating) {
                        try {
                            const dom = mapChart.getDom();
                            if (dom && params.event) {
                                const rect = dom.getBoundingClientRect();
                                const x = (params.event.clientX != null ? params.event.clientX : params.event.offsetX) - rect.left;
                                const y = (params.event.clientY != null ? params.event.clientY : params.event.offsetY) - rect.top;
                                const point = mapChart.convertFromPixel('geo', [x, y]);
                                if (point && Array.isArray(point) && point.length >= 2) {
                                    const lng = Number(point[0]), lat = Number(point[1]);
                                    if (!isNaN(lng) && !isNaN(lat)) {
                                        pendingCalibration.lng = lng;
                                        pendingCalibration.lat = lat;
                                        // Geo-Fencingï¼ˆ300ms é˜²æŠ–ï¼‰ï¼šæŒ‰åæ ‡è‡ªåŠ¨åˆ¤å›½å¹¶è§¦å‘æ¯å›½é”šå®šè¿ç§»
                                        scheduleGeoFenceByCoords(lng, lat, { source: 'map-click-calibrating' });
                                        const hasValidName = params.name && typeof params.name === 'string' && params.name.trim() !== '';
                                        if (params.seriesType === 'map' && hasValidName) {
                                            const countryName = params.name;
                                            let countryCode = null;
                                            for (const [code, names] of Object.entries(countryNameMap)) {
                                                if (names.en === countryName || names.zh === countryName || code === countryName) {
                                                    countryCode = code;
                                                    break;
                                                }
                                            }
                                            pendingCalibration.countryCode = countryCode || getCountryByCoords(lng, lat) || countryName;
                                            pendingCalibration.countryName = countryName;
                                        } else {
                                            // æ— å›½å®¶åç§°ï¼ˆç‚¹åˆ°æµ·ä¸Šç­‰ï¼‰ï¼šä»å¯ç”¨è½»é‡åˆ¤å›½å…œåº•
                                            const ccGuess = getCountryByCoords(lng, lat);
                                            if (ccGuess) {
                                                pendingCalibration.countryCode = ccGuess;
                                                pendingCalibration.countryName = countryNameMap?.[ccGuess]?.en || ccGuess;
                                            }
                                        }
                                        moveCurrentLocationCursor(lng, lat);
                                        if (calibrationDebounceTimer) {
                                            clearTimeout(calibrationDebounceTimer);
                                            calibrationDebounceTimer = null;
                                        }
                                        calibrationDebounceTimer = setTimeout(() => {
                                            calibrationDebounceTimer = null;
                                            confirmCalibrationAndLock(
                                                pendingCalibration.countryCode,
                                                pendingCalibration.countryName,
                                                pendingCalibration.lng,
                                                pendingCalibration.lat
                                            );
                                        }, 1500);
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn('[Map] convertFromPixel å¤±è´¥:', e);
                        }
                        return;
                    }
                    
                    // åˆ¤æ–­æ˜¯å¦ç‚¹å‡»åˆ°äº†å›½å®¶
                    const hasValidName = params.name && typeof params.name === 'string' && params.name.trim() !== '';
                    const isCountryClick = params.seriesType === 'map' && hasValidName;
                    console.log('[Map] ç‚¹å‡»äº‹ä»¶è¯¦æƒ…:', { seriesType: params.seriesType, name: params.name, isCountryClick, selectedCountryBefore: selectedCountry });

                    if (isCountryClick) {
                        const countryName = params.name;
                        // ä¼˜å…ˆç”¨ç»Ÿä¸€è§£æå‡½æ•°ï¼šé€‚é… world åœ°å›¾çš„è‹±æ–‡å…¨ç§°/åˆ«åï¼ˆå°¤å…¶æ˜¯ç¾å›½ï¼‰
                        let countryCode = typeof resolveCountryCodeFromMapName === 'function'
                            ? resolveCountryCodeFromMapName(countryName)
                            : null;
                        if (!countryCode) {
                            // å…œåº•ï¼šæ—§é€»è¾‘ï¼ˆISO2 æ˜ å°„è¡¨ en/zhï¼‰
                            try {
                                for (const [code, names] of Object.entries(countryNameMap || {})) {
                                    if (names.en === countryName || names.zh === countryName || code === countryName) {
                                        countryCode = code;
                                        break;
                                    }
                                }
                            } catch (e) {}
                        }
                        if (!countryCode) countryCode = countryName;
                        console.log(`[Map] ğŸ—ºï¸ ç‚¹å‡»å›½å®¶æŸ¥çœ‹å½“åœ°æƒ…å†µ: ${countryName} (${countryCode})`);
                        selectedCountry = countryCode;
                        const ccUpper = String(countryCode || '').trim().toUpperCase();
                        // ã€ä¿®æ”¹ã€‘åœ°å›¾ç‚¹å‡»å›½å®¶æ—¶åªæŸ¥çœ‹å½“åœ°æƒ…å†µï¼Œä¸åˆ‡æ¢å›½ç±
                        // åªæœ‰ä»å·¦æŠ½å±‰é€‰æ‹©å›½å®¶æ—¶æ‰åˆ‡æ¢å›½ç±ï¼ˆidentityï¼‰
                        if (/^[A-Z]{2}$/.test(ccUpper)) {
                            try {
                                // åªæ˜¾ç¤ºå›½å®¶æ•°æ®ï¼Œä¸åˆ‡æ¢å›½ç±
                                if (typeof showDrawersWithCountryData === 'function') {
                                    showDrawersWithCountryData(ccUpper, countryName);
                                }
                                // è¿›å…¥å›½å®¶é€è§†è§†å›¾ï¼ˆä½†ä¸åˆ‡æ¢å›½ç±ï¼‰
                                if (typeof switchToCountryView === 'function') {
                                    switchToCountryView(ccUpper, countryName);
                                }
                                // åˆ‡æ¢è§†å›¾åˆ°å›½å®¶é€è§†
                                if (typeof switchView === 'function') {
                                    switchView('country');
                                }
                            } catch (e) {
                                console.warn('[Map] âš ï¸ æ˜¾ç¤ºå›½å®¶æ•°æ®å¤±è´¥:', e);
                            }
                        } else {
                            console.warn('[Map] âš ï¸ æ— æ³•è§£æ ISO2 å›½å®¶ç ï¼Œæš‚æ— æ³•è¿›å…¥å›½å®¶é€è§†å³æŠ½å±‰:', { countryName, countryCode });
                            try {
                                if (typeof showDrawersWithCountryData === 'function') showDrawersWithCountryData(countryCode, countryName);
                            } catch { /* ignore */ }
                        }
                        return;
                    } else {
                        console.log('[Map] ğŸŒŠ ç‚¹å‡»ç©ºç™½å¤„ï¼Œæ¸…é™¤é€‰ä¸­çŠ¶æ€å¹¶å…³é—­æŠ½å±‰');
                        selectedCountry = null;
                        closeDrawers(false);
                    }
                });

                
                // æ·»åŠ åŒå‡»äº‹ä»¶ï¼Œé‡ç½®ä¸ºå…¨çƒè§†å›¾
                mapChart.off('dblclick');
                mapChart.on('dblclick', (params) => {
                    if (params.seriesType === 'map') {
                        selectedCountry = null;
                        console.log('[Map] ğŸŒ åŒå‡»é‡ç½®ä¸ºå…¨çƒè§†å›¾');
                        closeDrawers();
                        
                        // åœ°å›¾åŒå‡»åä¸å†éœ€è¦é‡æ–°æ¸²æŸ“ LPDEF å¡ç‰‡ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ rank-cards-containerï¼‰
                    }
                });
                
                // å“åº”å¼è°ƒæ•´ï¼ˆç§»é™¤æ—§ handlerï¼Œé¿å…å¤šæ¬¡ç»‘å®š + å¹¶å‘ resizeï¼‰
                try {
                    if (window.mapResizeHandler) {
                        window.removeEventListener('resize', window.mapResizeHandler);
                    }
                } catch (e) {
                    // ignore
                }
                const resizeHandler = () => {
                    if (mapChart && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                        mapChart.resize();
                        // resize å convertToPixel çš„ç»“æœä¼šå˜åŒ–ï¼Œå¿…é¡»åŒæ­¥ fixed-cursor
                        try { syncFixedCursorGraphicPosition('window.resize'); } catch { /* ignore */ }
                    }
                };
                window.mapResizeHandler = resizeHandler;
                window.addEventListener('resize', resizeHandler);

                // é˜²æ­¢æ»šè½®ç¼©æ”¾åœ°å›¾æ—¶é¡µé¢è·Ÿç€æ»šåŠ¨ï¼ˆä»…åœ¨æŒ‡é’ˆåœç•™åœ°å›¾åŒºåŸŸæ—¶ç”Ÿæ•ˆï¼‰
                if (!chartDom.dataset.wheelLocked) {
                    chartDom.addEventListener('wheel', (e) => {
                        // ECharts è‡ªå·±ä¼šæ¶ˆè´¹æ»šè½®ç”¨äºç¼©æ”¾ï¼Œè¿™é‡Œé˜»æ­¢é¡µé¢æ»šåŠ¨
                        e.preventDefault();
                    }, { passive: false });
                    chartDom.dataset.wheelLocked = 'true';
                }

                console.log('[Map] âœ… 2D åœ°å›¾æ¸²æŸ“å®Œæˆï¼ˆå·²å¯ç”¨ç¼©æ”¾/æ‹–åŠ¨ï¼‰');
            } catch (error) {
                console.error('[Map] âŒ 2D åœ°å›¾æ¸²æŸ“å¤±è´¥:', error);
                chartDom.innerHTML = '<div class="flex items-center justify-center h-full text-zinc-500 text-sm">åœ°å›¾æ¸²æŸ“å¤±è´¥</div>';
            }
        }

        /**
         * åœ°å›¾è„‰å†²ç‰¹æ•ˆï¼šåœ¨åœ°å›¾ä¸ŠåŠ¨æ€æ·»åŠ æ¶Ÿæ¼ªç‰¹æ•ˆç‚¹ï¼ˆæ”¯æŒåŠ¨æ€é¢œè‰²ï¼‰
         * @param {number} lng - ç»åº¦
         * @param {number} lat - çº¬åº¦
         * @param {string} label - æ˜¾ç¤ºçš„æ ‡ç­¾æ–‡å­—
         * @param {string} color - é¢œè‰²å€¼ï¼ˆåå…­è¿›åˆ¶ï¼Œå¦‚ '#00ff41' æˆ– '#ffffff'ï¼‰
         */
        /**
         * è®¾ç½®æˆ–æ›´æ–°ã€Œå½“å‰ç”¨æˆ·ã€æŒä¹…å…‰æ ‡ï¼ˆseriesName: 'Current Location'ï¼‰ï¼Œä¸è‡ªåŠ¨ç§»é™¤
         * ã€é‡æ„ã€‘ä½¿ç”¨å•ä¾‹å…‰æ ‡ç®¡ç†å™¨ï¼Œå®ç°æ‹¦æˆªå™¨æœºåˆ¶
         * @param {number} lng - ç»åº¦
         * @param {number} lat - çº¬åº¦
         * @param {string} color - é¢œè‰²
         * @param {string} avatarUrl - å¤´åƒ URL
         * @param {string} username - ç”¨æˆ·å
         * @param {boolean} force - æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥é”šå®šçŠ¶æ€ï¼‰
         */
        /**
         * æ ¹æ®é€‰æ‹©çš„å›½å®¶æ˜¾ç¤ºå…‰æ ‡ï¼ˆå›ºå®šä½ç½®ï¼Œä¸å¯ç§»åŠ¨ï¼Œå¸¦è„‰åŠ¨é—ªå…‰æ•ˆæœï¼‰
         * @param {string|number} countryCodeOrLng - å›½å®¶ä»£ç ï¼ˆå¦‚ 'CN','US'ï¼‰æˆ–ç»åº¦ï¼ˆå½“ä¸ lat ä¸€èµ·ä¼ å…¥æ—¶ï¼‰
         * @param {number} [lat] - çº¬åº¦ï¼ˆä»…å½“ç¬¬ä¸€å‚ä¸ºç»åº¦æ—¶æœ‰æ•ˆï¼‰
         */
        function setOrUpdateCurrentLocationCursor(countryCodeOrLng = null, lat = null) {
            // é˜²å¾¡ï¼šåœ°å›¾å®ä¾‹å°šæœªåˆ›å»ºæ—¶é™é»˜é€€å‡ºï¼Œä¸é˜»æ–­åç»­é€»è¾‘
            const hasMap = (mapChart && typeof mapChart.setOption === 'function' && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed()))
                || (window.map && typeof L !== 'undefined' && window.map && typeof window.map.removeLayer === 'function');
            if (!hasMap) {
                console.log('[MapCursor] åœ°å›¾å®ä¾‹å°šæœªå°±ç»ªï¼Œè·³è¿‡å…‰æ ‡æ›´æ–°');
                return;
            }
            let countryCode = countryCodeOrLng;
            if (typeof countryCodeOrLng === 'number' && typeof lat === 'number' && Number.isFinite(countryCodeOrLng) && Number.isFinite(lat)) {
                countryCode = typeof getCountryByCoords === 'function' ? getCountryByCoords(countryCodeOrLng, lat) : null;
                if (!countryCode) {
                    try { countryCode = (localStorage.getItem('manual_location') || '').trim().toUpperCase(); } catch { /* ignore */ }
                    if (!countryCode || !/^[A-Z]{2}$/.test(countryCode)) {
                        console.warn('[MapCursor] âš ï¸ æ— æ³•ä»åæ ‡è§£æå›½å®¶ç ï¼Œè·³è¿‡å…‰æ ‡:', { lng: countryCodeOrLng, lat });
                        return;
                    }
                }
            } else if (typeof countryCodeOrLng === 'number' || (typeof countryCodeOrLng === 'string' && /^-?\d+(\.\d+)?$/.test(String(countryCodeOrLng)))) {
                console.warn('[MapCursor] âš ï¸ ä¼ å…¥çš„å¯èƒ½æ˜¯ç»çº¬åº¦ï¼Œè¯·ä½¿ç”¨ ISO å›½å®¶ä»£ç ï¼ˆå¦‚ CN, USï¼‰:', countryCodeOrLng);
                return;
            }
            countryCode = countryCode ? String(countryCode).trim().toUpperCase() : null;
            if (countryCode && !/^[A-Z]{2}$/.test(countryCode)) countryCode = null;
            if (mapChart && typeof mapChart.setOption === 'function' && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                return setOrUpdateCurrentLocationCursorECharts(countryCode);
            }
            const map = window.map;
            if (map && typeof L !== 'undefined' && typeof map.removeLayer === 'function') {
                return setOrUpdateCurrentLocationCursorLeaflet(countryCode, map);
            }
        }

        /**
         * ä½¿ç”¨ ECharts æ˜¾ç¤ºå…‰æ ‡
         * @param {string} countryCode - å›½å®¶ä»£ç 
         */
        function setOrUpdateCurrentLocationCursorECharts(countryCode = null) {
            // å¦‚æœæ²¡æœ‰ä¼ å…¥å›½å®¶ä»£ç ï¼Œå°è¯•ä»ä¸‹æ‹‰èœå•æˆ– localStorage è·å–
            if (!countryCode) {
                const dropdown = document.getElementById('country-select-dropdown');
                countryCode = dropdown ? dropdown.value : null;
                if (!countryCode) {
                    try {
                        countryCode = localStorage.getItem('user_selected_country');
                    } catch (e) {
                        console.warn('[MapCursor] âš ï¸ æ— æ³•ä» localStorage è·å–å›½å®¶ä»£ç ');
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰å›½å®¶ä»£ç ï¼Œç§»é™¤å…‰æ ‡
            if (!countryCode) {
                try {
                    const currentOption = mapChart.getOption();
                    if (currentOption && currentOption.series && Array.isArray(currentOption.series)) {
                        const otherSeries = currentOption.series.filter(s => s && s.name !== 'Current Location');
                        mapChart.setOption({ series: otherSeries }, { notMerge: false, lazyUpdate: false });
                    }
                } catch (e) {
                    console.warn('[MapCursor] âš ï¸ ç§»é™¤å…‰æ ‡å¤±è´¥:', e);
                }
                return;
            }

            // è·å–å›½å®¶ä¸­å¿ƒåæ ‡
            let countryName = null;
            let coords = null;

            if (typeof countryNameMap !== 'undefined' && countryNameMap[countryCode]) {
                countryName = countryNameMap[countryCode].en || countryNameMap[countryCode].zh || countryCode;
                if (typeof countryCenterMap !== 'undefined' && countryCenterMap[countryName]) {
                    coords = countryCenterMap[countryName];
                }
            }

            if (!coords) {
                for (const [name, coord] of Object.entries(countryCenterMap || {})) {
                    if (countryNameMap && countryNameMap[countryCode]) {
                        const names = countryNameMap[countryCode];
                        if (names.en === name || names.zh === name) {
                            coords = coord;
                            countryName = name;
                            break;
                        }
                    }
                }
            }

            if (!coords) {
                console.warn('[MapCursor] âš ï¸ æ— æ³•æ‰¾åˆ°å›½å®¶åæ ‡:', countryCode);
                return;
            }

            const [lng, lat] = coords;
            const color = '#00ff41';

            try {
                const currentOption = mapChart.getOption();
                if (!currentOption || !currentOption.series || !Array.isArray(currentOption.series)) return;

                // ç§»é™¤æ—§çš„ Current Location ç³»åˆ—
                const otherSeries = currentOption.series.filter(s => s && s.name !== 'Current Location');

                // åˆ›å»ºæ–°çš„å…‰æ ‡ç³»åˆ—ï¼ˆå¸¦è„‰åŠ¨æ•ˆæœï¼‰
                const pulseSeries = {
                    name: 'Current Location',
                    type: 'effectScatter',
                    coordinateSystem: 'geo',
                    data: [{ value: [lng, lat], name: 'YOU' }],
                    symbolSize: 20,
                    showEffectOn: 'render',
                    rippleEffect: { 
                        brushType: 'stroke', 
                        scale: 5, 
                        period: 4, 
                        color: color 
                    },
                    itemStyle: { 
                        color: color, 
                        shadowBlur: 20, 
                        shadowColor: color 
                    },
                    label: { 
                        show: true, 
                        formatter: 'YOU', 
                        position: 'top', 
                        color: color, 
                        fontSize: 10, 
                        fontFamily: 'JetBrains Mono' 
                    },
                    zlevel: 10,
                    z: 10
                };

                mapChart.setOption({ series: [...otherSeries, pulseSeries] }, { notMerge: false, lazyUpdate: false });
                console.log('[MapCursor] âœ… ECharts å…‰æ ‡å·²æ˜¾ç¤º:', { countryCode, lng, lat });
            } catch (e) {
                console.warn('[MapCursor] âš ï¸ setOrUpdateCurrentLocationCursorECharts å¤±è´¥:', e);
            }
        }

        /**
         * ä½¿ç”¨ Leaflet æ˜¾ç¤ºå…‰æ ‡
         * @param {string} countryCode - å›½å®¶ä»£ç 
         * @param {Object} map - Leaflet map å®ä¾‹
         */
        function setOrUpdateCurrentLocationCursorLeaflet(countryCode = null, map) {

            // å¦‚æœæ²¡æœ‰ä¼ å…¥å›½å®¶ä»£ç ï¼Œå°è¯•ä»ä¸‹æ‹‰èœå•æˆ– localStorage è·å–
            if (!countryCode) {
                const dropdown = document.getElementById('country-select-dropdown');
                countryCode = dropdown ? dropdown.value : null;
                if (!countryCode) {
                    // å°è¯•ä» localStorage è·å–
                    try {
                        countryCode = localStorage.getItem('user_selected_country');
                    } catch (e) {
                        console.warn('[MapCursor] âš ï¸ æ— æ³•ä» localStorage è·å–å›½å®¶ä»£ç ');
                    }
                }
            }

            // å¦‚æœæ²¡æœ‰å›½å®¶ä»£ç ï¼Œä¸æ˜¾ç¤ºå…‰æ ‡
            if (!countryCode) {
                // ç§»é™¤ç°æœ‰å…‰æ ‡
                if (window.userMarker) {
                    try {
                        map.removeLayer(window.userMarker);
                        window.userMarker = null;
                    } catch (e) {
                        console.warn('[MapCursor] âš ï¸ ç§»é™¤å…‰æ ‡å¤±è´¥:', e);
                    }
                }
                return;
            }

            // è·å–å›½å®¶ä¸­å¿ƒåæ ‡
            let countryName = null;
            let coords = null;

            // ä» countryNameMap è·å–å›½å®¶åç§°å’Œåæ ‡
            if (typeof countryNameMap !== 'undefined' && countryNameMap[countryCode]) {
                countryName = countryNameMap[countryCode].en || countryNameMap[countryCode].zh || countryCode;
                // ä» countryCenterMap è·å–åæ ‡
                if (typeof countryCenterMap !== 'undefined' && countryCenterMap[countryName]) {
                    coords = countryCenterMap[countryName];
                }
            }

            // å¦‚æœæ‰¾ä¸åˆ°åæ ‡ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨å›½å®¶ä»£ç æŸ¥æ‰¾
            if (!coords) {
                // å°è¯•é€šè¿‡å›½å®¶ä»£ç æŸ¥æ‰¾ï¼ˆéœ€è¦åå‘æ˜ å°„ï¼‰
                for (const [name, coord] of Object.entries(countryCenterMap || {})) {
                    if (countryNameMap && countryNameMap[countryCode]) {
                        const names = countryNameMap[countryCode];
                        if (names.en === name || names.zh === name) {
                            coords = coord;
                            countryName = name;
                            break;
                        }
                    }
                }
            }

            // å¦‚æœä»ç„¶æ‰¾ä¸åˆ°åæ ‡ï¼Œä½¿ç”¨é»˜è®¤åæ ‡
            if (!coords) {
                console.warn('[MapCursor] âš ï¸ æ— æ³•æ‰¾åˆ°å›½å®¶åæ ‡ï¼Œä½¿ç”¨é»˜è®¤åæ ‡');
                coords = [0, 0]; // é»˜è®¤åæ ‡ï¼ˆéæ´²ä¸­éƒ¨ï¼‰
            }

            const [lng, lat] = coords;
            const color = '#00ff41'; // ä¸»é¢˜ç»¿è‰²

            try {
                // ã€å•ä¾‹ç®¡ç†ã€‘æ£€æµ‹å¹¶ç§»é™¤æ—§çš„ marker
                if (window.userMarker) {
                    try {
                        map.removeLayer(window.userMarker);
                        console.log('[MapCursor] ğŸ—‘ï¸ å·²ç§»é™¤æ—§çš„å…‰æ ‡ marker');
                    } catch (e) {
                        console.warn('[MapCursor] âš ï¸ ç§»é™¤æ—§ marker å¤±è´¥:', e);
                    }
                    window.userMarker = null;
                }

                // åˆ›å»ºå…‰æ ‡ HTML å†…å®¹ï¼ˆå¸¦è„‰åŠ¨é—ªå…‰æ•ˆæœï¼‰
                const iconSize = 20; // å…‰æ ‡å¤§å°ï¼ˆåƒç´ ï¼‰
                const iconHtml = `
                    <div class="pulse-marker" style="
                        width: ${iconSize}px;
                        height: ${iconSize}px;
                        border-radius: 50%;
                        background-color: ${color};
                        border: 2px solid #000000;
                        box-shadow: 0 0 20px ${color}, 0 0 10px rgba(0, 0, 0, 0.8);
                        position: relative;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        <div style="
                            position: absolute;
                            top: -20px;
                            left: 50%;
                            transform: translateX(-50%);
                            color: ${color};
                            font-size: 10px;
                            font-family: 'JetBrains Mono', monospace;
                            white-space: nowrap;
                            text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
                        ">YOU</div>
                    </div>
                `;

                // åˆ›å»º Leaflet divIconï¼Œè®¾ç½®æ­£ç¡®çš„ iconAnchor ç¡®ä¿å…‰æ ‡ä¸­å¿ƒä¸ç»çº¬åº¦å®Œå…¨é‡åˆ
                const customIcon = L.divIcon({
                    html: iconHtml,
                    className: 'custom-user-marker pulse-marker', // æ·»åŠ è„‰åŠ¨åŠ¨ç”»ç±»
                    iconSize: [iconSize, iconSize], // å›¾æ ‡å°ºå¯¸
                    iconAnchor: [iconSize / 2, iconSize / 2], // é”šç‚¹è®¾ç½®ä¸ºå›¾æ ‡ä¸­å¿ƒï¼Œç¡®ä¿å…‰æ ‡ä¸­å¿ƒä¸ç»çº¬åº¦å®Œå…¨é‡åˆ
                    popupAnchor: [0, -iconSize / 2 - 5] // å¼¹å‡ºæ¡†é”šç‚¹
                });

                // åˆ›å»º Leaflet markerï¼ˆä¸å¯æ‹–æ‹½ï¼‰
                const marker = L.marker([lat, lng], {
                    icon: customIcon,
                    zIndexOffset: 1000, // ç¡®ä¿å…‰æ ‡åœ¨æœ€ä¸Šå±‚
                    draggable: false, // ç¦æ­¢æ‹–æ‹½
                    interactive: false // ç¦æ­¢äº¤äº’
                });

                // æ·»åŠ åˆ°åœ°å›¾
                marker.addTo(map);
                window.userMarker = marker;

                console.log('[MapCursor] âœ… å…‰æ ‡å·²æ˜¾ç¤ºåœ¨å›½å®¶ä¸­å¿ƒ:', { countryCode, countryName, lng, lat });
                
            } catch (e) { 
                console.warn('[MapCursor] âš ï¸ setOrUpdateCurrentLocationCursor å¤±è´¥:', e); 
            }
        }

        /**
         * åˆå§‹åŒ– Leaflet map çš„ zoom/move äº‹ä»¶ç›‘å¬å™¨
         * ç”¨äºé˜²æ­¢åœ¨ç¼©æ”¾/ç§»åŠ¨æœŸé—´æ›´æ–°å…‰æ ‡åæ ‡
         */
        function initLeafletMapEventHandlers() {
            const map = window.map;
            if (!map || typeof L === 'undefined' || typeof map.on !== 'function') {
                return;
            }

            // åˆå§‹åŒ–çŠ¶æ€æ ‡å¿—
            window.__isMapZooming = false;
            window.__isMapMoving = false;
            window.__isUserManualClick = false;

            // ç¼©æ”¾å¼€å§‹äº‹ä»¶
            map.on('zoomstart', function() {
                window.__isMapZooming = true;
            });

            // ç¼©æ”¾ç»“æŸäº‹ä»¶
            map.on('zoomend', function() {
                window.__isMapZooming = false;
            });

            // ç§»åŠ¨å¼€å§‹äº‹ä»¶
            map.on('movestart', function() {
                window.__isMapMoving = true;
            });

            // ç§»åŠ¨ç»“æŸäº‹ä»¶
            map.on('moveend', function() {
                window.__isMapMoving = false;
            });

            // ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºæ ‡è®°ç”¨æˆ·æ˜¾å¼æ“ä½œï¼‰
            map.on('click', function(e) {
                window.__isUserManualClick = true;
                // 500ms åé‡ç½®æ ‡å¿—ï¼Œå…è®¸åç»­æ›´æ–°
                setTimeout(() => {
                    window.__isUserManualClick = false;
                }, 500);
            });

            console.log('[MapCursor] âœ… Leaflet map äº‹ä»¶ç›‘å¬å™¨å·²åˆå§‹åŒ–');
        }

        // å¦‚æœ Leaflet map å·²å­˜åœ¨ï¼Œç«‹å³åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        if (typeof window !== 'undefined' && (window.map || typeof L !== 'undefined')) {
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿ map å®ä¾‹å·²å®Œå…¨åˆ›å»º
            setTimeout(() => {
                initLeafletMapEventHandlers();
            }, 100);
        }

        /** ä»…æ›´æ–°ã€ŒCurrent Locationã€ç³»åˆ—é¢œè‰²ï¼ˆæ ¡å‡†æ¨¡å¼è“ / æ­£å¸¸ç»¿ï¼‰ */
        function updateCurrentLocationCursorColor(color) {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;
            try {
                const opt = mapChart.getOption();
                if (!opt || !opt.series) return;
                const series = opt.series.map(s => {
                    if (s.name === 'Current Location') {
                        return {
                            ...s,
                            rippleEffect: { ...(s.rippleEffect || {}), color },
                            itemStyle: { ...(s.itemStyle || {}), color, shadowColor: color },
                            label: { ...(s.label || {}), color }
                        };
                    }
                    return s;
                });
                mapChart.setOption({ series }, { notMerge: false, lazyUpdate: false });
            } catch (e) { console.warn('[MapPulse] updateCurrentLocationCursorColor:', e); }
        }

        /** å°†ã€ŒCurrent Locationã€å…‰æ ‡ç§»åŠ¨åˆ° [lng, lat]ï¼ˆECharts åŠ¨ç”»ï¼‰ */
        function moveCurrentLocationCursor(lng, lat) {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;
            try {
                const opt = mapChart.getOption();
                if (!opt || !opt.series) return;
                const series = opt.series.map(s => {
                    if (s.name === 'Current Location' && s.data && s.data.length > 0) {
                        return { ...s, data: [{ ...s.data[0], value: [lng, lat] }] };
                    }
                    return s;
                });
                mapChart.setOption({ series }, { notMerge: false, lazyUpdate: false });
                try {
                    // åŒæ­¥è®°å½•ï¼Œä¿è¯æ‹–æ‹½/ç‚¹å‡»ç§»åŠ¨åä¾æ—§å¯è¢«è‡ªæ„ˆé€»è¾‘æ¢å¤
                    const prev = window.__currentLocationCursorState || {};
                    window.__currentLocationCursorState = {
                        ...prev,
                        lng,
                        lat,
                        updatedAt: Date.now()
                    };
                    window.currentUserLocation = { lng, lat, color: prev.color || '#00ff41' };

                    // ã€æ–°å¢ã€‘åŒæ­¥æ›´æ–° localStorage ä¸­çš„åæ ‡ï¼ˆç”¨äºæŒä¹…åŒ–ï¼‰
                    if (localStorage.getItem('loc_fixed') === 'true' && localStorage.getItem('loc_locked') === 'true') {
                        localStorage.setItem('manual_lat', String(lat));
                        localStorage.setItem('manual_lng', String(lng));
                        console.log('[MapCursor] âœ… å·²åŒæ­¥æ›´æ–° localStorage ä¸­çš„åæ ‡:', { lat, lng });
                    }
                } catch { /* ignore */ }
            } catch (e) { console.warn('[MapPulse] moveCurrentLocationCursor:', e); }
        }

        // ==========================================================
        // åœ°å›¾å…‰æ ‡è‡ªæ„ˆ + å¯æ‹–æ‹½æ ¡å‡†ï¼ˆè§£å†³å…‰æ ‡/è„‰å†²éšæœºæ¶ˆå¤± & æå‡å¯ç”¨æ€§ï¼‰
        // ==========================================================
        function _getBestKnownUserCoords() {
            // ã€ä¿®å¤ã€‘æœ€é«˜ä¼˜å…ˆçº§ï¼šæœ¬åœ°å·²é”å®šæ ¡å‡†åæ ‡ï¼ˆloc_fixed + loc_locked åŒé‡ä¿æŠ¤ï¼‰
            try {
                if (localStorage.getItem('loc_fixed') === 'true' && localStorage.getItem('loc_locked') === 'true') {
                    const lat = localStorage.getItem('manual_lat') ? Number(localStorage.getItem('manual_lat')) : null;
                    const lng = localStorage.getItem('manual_lng') ? Number(localStorage.getItem('manual_lng')) : null;
                    if (lat != null && lng != null && !isNaN(lat) && !isNaN(lng)) {
                        console.log('[MapCursor] ğŸ”’ ä½¿ç”¨é”å®šçš„æ ¡å‡†åæ ‡:', { lat, lng, source: 'localStorage.manual_locked' });
                        return { lng, lat, source: 'localStorage.manual_locked' };
                    }
                }
            } catch { /* ignore */ }

            // æ¬¡ä¼˜ï¼šæœ¬åœ°å·²é”å®šæ ¡å‡†åæ ‡ï¼ˆloc_fixed + manual_lat/manual_lngï¼Œå…¼å®¹æ—§é€»è¾‘ï¼‰
            try {
                if (localStorage.getItem('loc_fixed') === 'true') {
                    const lat = localStorage.getItem('manual_lat') ? Number(localStorage.getItem('manual_lat')) : null;
                    const lng = localStorage.getItem('manual_lng') ? Number(localStorage.getItem('manual_lng')) : null;
                    if (lat != null && lng != null && !isNaN(lat) && !isNaN(lng)) return { lng, lat, source: 'localStorage.manual' };
                }
            } catch { /* ignore */ }

            // ç¬¬ä¸‰ä¼˜ï¼šå…¨å±€ç”¨æˆ·æ•°æ®ï¼ˆmanual ä¼˜å…ˆï¼‰
            try {
                const u = window.currentUserData || window.currentUser || null;
                if (u) {
                    const lat = (u.manual_lat != null && !isNaN(Number(u.manual_lat))) ? Number(u.manual_lat)
                        : (u.lat != null && !isNaN(Number(u.lat)) ? Number(u.lat) : null);
                    const lng = (u.manual_lng != null && !isNaN(Number(u.manual_lng))) ? Number(u.manual_lng)
                        : (u.lng != null && !isNaN(Number(u.lng)) ? Number(u.lng) : null);
                    if (lat != null && lng != null) return { lng, lat, source: 'currentUser' };
                }
            } catch { /* ignore */ }

            // å…œåº•ï¼šæœ€è¿‘ä¸€æ¬¡åœ¨é¡µé¢å†…ç»˜åˆ¶è¿‡çš„å…‰æ ‡
            try {
                const s = window.__currentLocationCursorState;
                if (s && typeof s.lng === 'number' && typeof s.lat === 'number' && !isNaN(s.lng) && !isNaN(s.lat)) {
                    return { lng: s.lng, lat: s.lat, source: 'window.__currentLocationCursorState' };
                }
            } catch { /* ignore */ }
            return null;
        }

        function _getBestKnownCursorMeta() {
            // é¢œè‰²ï¼šè·Ÿéšå½“å‰ç”¨æˆ·çŠ¶æ€
            let color = '#00ff41';
            try {
                const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                if (statusConfig && statusConfig.status_color) color = statusConfig.status_color;
            } catch { /* ignore */ }

            // ç”¨æˆ·å + å¤´åƒï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ° GitHub ç”¨æˆ·å
            let username = 'YOU';
            let avatarUrl = DEFAULT_AVATAR;
            try {
                const gh = localStorage.getItem('github_username') || null;
                if (gh) username = gh;
                avatarUrl = isValidGitHubUsername(gh) ? getGitHubAvatarUrl(gh) : DEFAULT_AVATAR;
            } catch { /* ignore */ }

            // å¦‚æœå·²æœ‰ç¼“å­˜çŠ¶æ€ï¼Œä¼˜å…ˆä¿ç•™ï¼ˆé¿å…é¢œè‰²/å¤´åƒæŠ–åŠ¨ï¼‰
            try {
                const s = window.__currentLocationCursorState || null;
                if (s) {
                    if (s.color) color = s.color;
                    if (s.username) username = s.username;
                    if (s.avatarUrl) avatarUrl = s.avatarUrl;
                }
            } catch { /* ignore */ }

            return { color, avatarUrl, username };
        }

        function ensureCurrentLocationCursor(reason = '') {
            const coords = _getBestKnownUserCoords();
            if (!coords) return false;
            const meta = _getBestKnownCursorMeta();
            try {
                setOrUpdateCurrentLocationCursor(coords.lng, coords.lat, meta.color, meta.avatarUrl, meta.username);
                if (reason) console.log('[MapCursor] âœ… å·²ç¡®ä¿å…‰æ ‡å­˜åœ¨:', reason, coords.source);
                return true;
            } catch (e) {
                console.warn('[MapCursor] âš ï¸ ensureCurrentLocationCursor å¤±è´¥:', e);
                return false;
            }
        }

        // å…¨å±€æ ‡å¿—ï¼šè¡¨ç¤ºå…‰æ ‡å·²è¢«é”å®šï¼Œé˜»æ­¢å…¶ä»–æ“ä½œæ›´æ–°
        window.__cursorLocked = false;

        // ã€æ–°å¢ã€‘å¼ºåˆ¶æ¢å¤é”å®šçš„å…‰æ ‡ä½ç½®ï¼ˆæ›´å¼ºçš„é”å®šä¿æŠ¤ï¼‰
        function forceRestoreLockedCursor() {
            if (localStorage.getItem('loc_locked') === 'true' && localStorage.getItem('loc_fixed') === 'true') {
                const manualLat = localStorage.getItem('manual_lat');
                const manualLng = localStorage.getItem('manual_lng');
                if (manualLat && manualLng && !isNaN(Number(manualLat)) && !isNaN(Number(manualLng))) {
                    const lat = Number(manualLat);
                    const lng = Number(manualLng);
                    // è¯»å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¤´åƒã€ç”¨æˆ·åï¼‰
                    let githubUsername = 'YOU';
                    let avatarUrl = DEFAULT_AVATAR;
                    try {
                        githubUsername = localStorage.getItem('github_username') || 'YOU';
                        if (githubUsername && isValidGitHubUsername(githubUsername)) {
                            avatarUrl = getGitHubAvatarUrl(githubUsername);
                        }
                    } catch (e) { /* ignore */ }
                    // å¼ºåˆ¶æ¢å¤å…‰æ ‡ä½ç½®
                    if (typeof setOrUpdateCurrentLocationCursor === 'function') {
                        const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                        const pulseColor = statusConfig.status_color || '#00ff41';
                        setOrUpdateCurrentLocationCursor(lng, lat, pulseColor, avatarUrl, githubUsername);
                        window.__cursorLocked = true;
                        console.log('[MapCursor] ğŸ”’ å·²å¼ºåˆ¶æ¢å¤é”å®šçš„å…‰æ ‡ä½ç½®:', { lat, lng });
                        return true;
                    }
                }
            }
            return false;
        }

        function ensureCurrentLocationCursorIfMissing(reason = '') {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return false;
            try {
                const opt = mapChart.getOption();
                const has = !!(opt && Array.isArray(opt.series) && opt.series.some(s => s && s.name === 'Current Location'));
                // ã€æ–°å¢ã€‘å¦‚æœå…‰æ ‡å·²è¢«é”å®šï¼Œä¸æ‰§è¡Œæ¢å¤é€»è¾‘ï¼ˆé¿å…è¢«è¦†ç›–ï¼‰
                if (has && window.__cursorLocked) {
                    console.log('[MapCursor] ğŸ”’ å…‰æ ‡å·²é”å®šï¼Œè·³è¿‡è‡ªæ„ˆæ¢å¤:', reason);
                    return true;
                }
                if (!has) return ensureCurrentLocationCursor(reason || 'missing');
                return true;
            } catch (e) {
                console.warn('[MapCursor] âš ï¸ ensureCurrentLocationCursorIfMissing å¤±è´¥:', e);
                return false;
            }
        }

        function bindMapCursorSelfHeal() {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;
            try {
                if (window.__mapCursorSelfHealHandler) {
                    try { mapChart.off('finished', window.__mapCursorSelfHealHandler); } catch { /* ignore */ }
                }
                window.__mapCursorSelfHealHandler = () => {
                    try {
                        if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;
                        ensureCurrentLocationCursorIfMissing('echarts.finished-self-heal');
                    } catch { /* ignore */ }
                };
                mapChart.on('finished', window.__mapCursorSelfHealHandler);
            } catch (e) {
                console.warn('[MapCursor] âš ï¸ bindMapCursorSelfHeal å¤±è´¥:', e);
            }
        }

        function _setMapRoamEnabled(enabled) {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;
            try {
                const opt = mapChart.getOption();
                if (!opt) return;
                const nextGeo = Array.isArray(opt.geo) ? opt.geo.map(g => ({ ...g, roam: !!enabled })) : opt.geo;
                const nextSeries = Array.isArray(opt.series) ? opt.series.map(s => {
                    if (s && s.type === 'map') return { ...s, roam: !!enabled };
                    return s;
                }) : opt.series;
                mapChart.setOption({ geo: nextGeo, series: nextSeries }, { notMerge: false, lazyUpdate: false });
            } catch { /* ignore */ }
        }

        // æ ¡å‡†æ‹–æ‹½çŠ¶æ€
        let __isDraggingCurrentLocation = false;

        function bindCurrentLocationDragHandlers() {
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;
            const zr = typeof mapChart.getZr === 'function' ? mapChart.getZr() : null;
            if (!zr) return;

            // è§£ç»‘æ—§ handlerï¼Œé¿å…é‡å¤ç»‘å®šå¯¼è‡´â€œæ¦‚ç‡æ€§å¤±æ•ˆâ€
            try {
                const prev = window.__currentLocationDragHandlers;
                if (prev) {
                    zr.off('mousedown', prev.mousedown);
                    zr.off('mousemove', prev.mousemove);
                    zr.off('mouseup', prev.mouseup);
                    zr.off('globalout', prev.mouseup);
                }
            } catch { /* ignore */ }

            const getXY = (evt) => {
                const x = (evt && (evt.offsetX ?? evt.zrX ?? evt.event?.offsetX ?? evt.event?.clientX)) ?? null;
                const y = (evt && (evt.offsetY ?? evt.zrY ?? evt.event?.offsetY ?? evt.event?.clientY)) ?? null;
                if (x == null || y == null) return null;
                // å¦‚æœæ˜¯ clientX/clientYï¼Œéœ€è¦å‡å» canvas çš„ bounding rect
                if (evt && evt.event && evt.event.clientX != null && evt.event.clientY != null) {
                    try {
                        const dom = mapChart.getDom();
                        const rect = dom ? dom.getBoundingClientRect() : null;
                        if (rect) return { x: evt.event.clientX - rect.left, y: evt.event.clientY - rect.top };
                    } catch { /* ignore */ }
                }
                return { x, y };
            };

            const getCurrentCursorPixel = () => {
                try {
                    const opt = mapChart.getOption();
                    const s = Array.isArray(opt?.series) ? opt.series.find(ss => ss && ss.name === 'Current Location') : null;
                    const v = s?.data?.[0]?.value;
                    if (!v || !Array.isArray(v) || v.length < 2) return null;
                    const lng = Number(v[0]), lat = Number(v[1]);
                    if (isNaN(lng) || isNaN(lat)) return null;
                    const px = mapChart.convertToPixel('geo', [lng, lat]);
                    if (!px || !Array.isArray(px) || px.length < 2) return null;
                    return { x: Number(px[0]), y: Number(px[1]), lng, lat };
                } catch {
                    return null;
                }
            };

            const mousedown = (evt) => {
                if (!isCalibrating) return;

                // ã€æ–°åŠŸèƒ½ã€‘å¦‚æœå…‰æ ‡å·²å›ºå®šåœ¨æ¯å›½ï¼Œç¦æ­¢æ‹–åŠ¨
                if (__cursorFixedToHomeland) {
                    console.log('[Homeland] ğŸ”’ å…‰æ ‡å·²å›ºå®šåœ¨æ¯å›½ï¼Œç¦æ­¢æ‹–åŠ¨');
                    return;
                }

                const xy = getXY(evt);
                if (!xy) return;
                const cur = getCurrentCursorPixel();
                if (!cur) return;
                const dx = xy.x - cur.x, dy = xy.y - cur.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                // å‘½ä¸­é˜ˆå€¼ï¼šç•¥å¤§äº symbolSizeï¼ˆ20ï¼‰ï¼Œæ–¹ä¾¿æ‹–æ‹½
                if (dist <= 26) {
                    __isDraggingCurrentLocation = true;
                    _setMapRoamEnabled(false); // æ‹–æ‹½æ—¶æš‚æ—¶ç¦ç”¨æ¼«æ¸¸ï¼Œé¿å…åœ°å›¾è·Ÿç€è·‘
                    try { evt.event && evt.event.preventDefault && evt.event.preventDefault(); } catch { /* ignore */ }
                }
            };

            const mousemove = (evt) => {
                if (!isCalibrating || !__isDraggingCurrentLocation) return;
                const xy = getXY(evt);
                if (!xy) return;
                try {
                    const point = mapChart.convertFromPixel('geo', [xy.x, xy.y]);
                    if (!point || !Array.isArray(point) || point.length < 2) return;
                    const lng = Number(point[0]), lat = Number(point[1]);
                    if (isNaN(lng) || isNaN(lat)) return;
                    pendingCalibration.lng = lng;
                    pendingCalibration.lat = lat;
                    // Geo-Fencingï¼ˆ300ms é˜²æŠ–ï¼‰ï¼šæ‹–æ‹½å…‰æ ‡æ—¶è‡ªåŠ¨åˆ¤å›½ï¼›è·¨å¢ƒæ—¶è§¦å‘ onCountrySwitch
                    scheduleGeoFenceByCoords(lng, lat, { source: 'cursor-drag-calibrating' });
                    // å›½å®¶ä¼˜å…ˆæ²¿ç”¨é”šå®šå›½å®¶ï¼ˆå¯å…ˆç‚¹å›½å®¶ï¼Œå†æ‹–å…‰æ ‡ï¼‰
                    if (!pendingCalibration.countryCode) {
                        const anchored = _getAnchoredCountryFromStorage();
                        if (anchored) {
                            pendingCalibration.countryCode = anchored;
                            pendingCalibration.countryName = (countryNameMap[anchored]?.en || anchored);
                        }
                    }
                    moveCurrentLocationCursor(lng, lat);
                } catch { /* ignore */ }
            };

            const mouseup = () => {
                if (!__isDraggingCurrentLocation) return;
                __isDraggingCurrentLocation = false;
                _setMapRoamEnabled(true);
                // æ¾æ‰‹åå¿«é€Ÿç¡®è®¤ä¸€æ¬¡ï¼ˆé¿å…é¢‘ç¹è¯·æ±‚ï¼‰
                try {
                    if (pendingCalibration && pendingCalibration.lng != null && pendingCalibration.lat != null) {
                        const anchored = _getAnchoredCountryFromStorage();
                        const cc = pendingCalibration.countryCode || anchored || (window.currentUser?.manual_location || window.currentUser?.country_code) || null;
                        const cn = pendingCalibration.countryName ||
                            (cc && countryNameMap[String(cc).toUpperCase()] ? countryNameMap[String(cc).toUpperCase()].en : null) ||
                            cc;

                        // ã€æ–°åŠŸèƒ½ã€‘å¼¹å‡ºæ¯å›½ç¡®è®¤æç¤º
                        if (cn) {
                            showHomelandConfirmation(cn, () => {
                                // ç¡®è®¤åï¼šå›ºå®šå…‰æ ‡åœ¨å±å¹•ä¸Š
                                const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                                const pulseColor = statusConfig.status_color || '#00ff41';
                                setFixedCursorOnScreen(pendingCalibration.lng, pendingCalibration.lat, pulseColor);
                                __cursorFixedToHomeland = true;

                                // ä¿å­˜åˆ° localStorage
                                localStorage.setItem('manual_location', cc || '');
                                localStorage.setItem('manual_lat', String(pendingCalibration.lat));
                                localStorage.setItem('manual_lng', String(pendingCalibration.lng));
                                localStorage.setItem('loc_fixed', 'true');
                                localStorage.setItem('loc_locked', 'true');

                                // æ›´æ–° UI
                                updateUserCountryFlag(cc || '', cn || '', true);
                                if (typeof renderRankCards === 'function') {
                                    var _cu = window.currentUser;
                                    if (_cu && typeof _cu === 'object') {
                                        _cu.manual_location = cc;
                                        _cu.country_code = cc;
                                        _cu.manual_lat = pendingCalibration.lat;
                                        _cu.manual_lng = pendingCalibration.lng;
                                    }
                                    if (window.currentUser) renderRankCards(window.currentUser);
                                }

                                console.log('[Homeland] âœ… å·²å°†', cn, 'è®¾ç½®ä¸ºæ¯å›½');
                            }, () => {
                                // å–æ¶ˆåï¼šç»§ç»­åŸæ¥çš„é€»è¾‘ï¼ˆä½¿ç”¨ effectScatterï¼‰
                                confirmCalibrationAndLock(cc, cn, pendingCalibration.lng, pendingCalibration.lat);
                            });
                        } else {
                            // å¦‚æœæ²¡æœ‰å›½å®¶åç§°ï¼Œç›´æ¥ä½¿ç”¨åŸæ¥çš„é€»è¾‘
                            confirmCalibrationAndLock(cc, cn, pendingCalibration.lng, pendingCalibration.lat);
                        }
                    }
                } catch (e) {
                    console.warn('[MapCursor] âš ï¸ æ‹–æ‹½ç¡®è®¤å¤±è´¥:', e);
                }
            };

            zr.on('mousedown', mousedown);
            zr.on('mousemove', mousemove);
            zr.on('mouseup', mouseup);
            zr.on('globalout', mouseup);
            window.__currentLocationDragHandlers = { mousedown, mousemove, mouseup };
        }

        function setCalibrationMode(enabled) {
            isCalibrating = !!enabled;
            try {
                const hintEl = document.getElementById('map-cursor-hint');
                if (hintEl) hintEl.style.display = isCalibrating ? '' : 'none';
                const dot = document.querySelector('#btn-calibrate-location span');
                if (dot) dot.style.background = isCalibrating ? '#3b82f6' : '#00ff41';
                const t = document.getElementById('btn-calibrate-location-text');
                if (t) t.textContent = isCalibrating ? 'é€€å‡ºæ ¡å‡†' : 'æ ¡å‡†ä½ç½®';
            } catch { /* ignore */ }

            // è¿›å…¥æ ¡å‡†æ¨¡å¼ï¼šç¡®ä¿å…‰æ ‡å­˜åœ¨å¹¶å˜è“ï¼›é€€å‡ºåˆ™æ¢å¤ç»¿è‰²
            try {
                ensureCurrentLocationCursorIfMissing('toggle-calibration');
                updateCurrentLocationCursorColor(isCalibrating ? '#3b82f6' : '#00ff41');
            } catch { /* ignore */ }
        }

        /**
         * è·å–å®Œæ•´çš„å›½å®¶åˆ—è¡¨ï¼ˆä» ISO æ˜ å°„å’Œ countryNameMapï¼‰
         * @returns {Array} å›½å®¶åˆ—è¡¨ [{code, nameZh, nameEn}]
         */
        function getAllCountries() {
            const countries = [];
            const codeSet = new Set();

            // 1. ä» countryNameMap è·å–ï¼ˆä¼˜å…ˆï¼Œæœ‰ä¸­æ–‡åç§°ï¼‰
            if (typeof countryNameMap !== 'undefined') {
                for (const [code, names] of Object.entries(countryNameMap)) {
                    if (!codeSet.has(code)) {
                        countries.push({
                            code: code,
                            nameZh: names.zh || '',
                            nameEn: names.en || code
                        });
                        codeSet.add(code);
                    }
                }
            }

            // 2. ä» ISO æ˜ å°„è·å–æ›´å¤šå›½å®¶
            try {
                if (window.__isoNameToIso2 instanceof Map) {
                    const isoMap = window.__isoNameToIso2;
                    for (const [name, code] of isoMap.entries()) {
                        const codeUpper = String(code).toUpperCase();
                        if (!codeSet.has(codeUpper) && /^[A-Z]{2}$/.test(codeUpper)) {
                            countries.push({
                                code: codeUpper,
                                nameZh: '', // ISO æ˜ å°„é€šå¸¸åªæœ‰è‹±æ–‡å
                                nameEn: name
                            });
                            codeSet.add(codeUpper);
                        }
                    }
                }
            } catch (e) {
                console.warn('[CountrySelect] âš ï¸ ä» ISO æ˜ å°„è·å–å›½å®¶å¤±è´¥:', e);
            }

            // 3. æ’åº
            countries.sort((a, b) => {
                const nameA = (currentLang === 'zh' && a.nameZh) ? a.nameZh : a.nameEn;
                const nameB = (currentLang === 'zh' && b.nameZh) ? b.nameZh : b.nameEn;
                return nameA.localeCompare(nameB);
            });

            return countries;
        }

        /**
         * åˆå§‹åŒ–å·¦ä¾§æŠ½å±‰å›½å®¶é€‰æ‹©èœå•
         */
        function initLeftDrawerCountrySelector() {
            try {
                const searchInput = document.getElementById('left-drawer-country-search');
                const listContainer = document.getElementById('left-drawer-country-list');
                
                if (!searchInput || !listContainer) {
                    console.warn('[LeftDrawerCountry] âš ï¸ æ‰¾ä¸åˆ°å›½å®¶é€‰æ‹©èœå•å…ƒç´ ');
                    return;
                }

                // æ¸²æŸ“å›½å®¶åˆ—è¡¨ï¼ˆæ”¯æŒå€™é€‰é€‰ä¸­åæŒ‰å›½å®¶ç /åç§°è¿‡æ»¤ï¼‰
                const renderCountryList = (searchQuery = '') => {
                    const countries = getAllCountries();
                    const rawQuery = String(searchQuery || '').trim();
                    const query = rawQuery.toLowerCase();
                    
                    // è¿‡æ»¤å›½å®¶ï¼šè‹¥è¾“å…¥å« (XX) åˆ™ä¼˜å…ˆæŒ‰å›½å®¶ç ç²¾ç¡®åŒ¹é…ï¼Œå†æŒ‰åç§°éƒ¨åˆ†åŒ¹é…
                    let filtered = countries;
                    if (query) {
                        const codeMatch = rawQuery.match(/\(([A-Za-z]{2})\)\s*$/);
                        const codePart = codeMatch ? codeMatch[1].toLowerCase() : null;
                        const namePart = rawQuery.replace(/\s*\([A-Za-z]{2}\)\s*$/, '').trim().toLowerCase();
                        filtered = countries.filter(country => {
                            const nameZh = (country.nameZh || '').toLowerCase();
                            const nameEn = (country.nameEn || '').toLowerCase();
                            const code = (country.code || '').toLowerCase();
                            if (codePart && code === codePart) return true;
                            if (namePart && (nameZh.includes(namePart) || nameEn.includes(namePart))) return true;
                            return nameZh.includes(query) || nameEn.includes(query) || code.includes(query);
                        });
                    }

                    // æ¸…ç©ºå¹¶å¡«å……åˆ—è¡¨
                    listContainer.innerHTML = '';
                    
                    if (filtered.length === 0) {
                        listContainer.innerHTML = `
                            <div style="padding: 16px; text-align: center; color: rgba(113, 113, 122, 0.8); font-size: 12px;">
                                æœªæ‰¾åˆ°åŒ¹é…çš„å›½å®¶
                            </div>
                        `;
                        return;
                    }

                    filtered.forEach(country => {
                        const item = document.createElement('div');
                        item.className = 'country-select-item';
                        item.style.cssText = `
                            padding: 10px 12px;
                            border-bottom: 1px solid rgba(0, 255, 65, 0.1);
                            cursor: pointer;
                            transition: all 0.2s;
                            color: #ffffff;
                            font-family: 'JetBrains Mono', monospace;
                            font-size: 12px;
                        `;
                        
                        const displayName = (currentLang === 'zh' && country.nameZh) 
                            ? `${country.nameZh} (${country.code})` 
                            : `${country.nameEn} (${country.code})`;
                        
                        item.textContent = displayName;
                        
                        // é«˜äº®å½“å‰é€‰æ‹©çš„å›½å®¶
                        try {
                            const currentCountry = localStorage.getItem('user_selected_country');
                            if (currentCountry && currentCountry.toUpperCase() === country.code.toUpperCase()) {
                                item.style.background = 'rgba(0, 255, 65, 0.15)';
                                item.style.borderLeft = '3px solid #00ff41';
                            }
                        } catch (e) {
                            // ignore
                        }
                        
                        // æ‚¬åœæ•ˆæœ
                        item.addEventListener('mouseenter', () => {
                            item.style.background = 'rgba(0, 255, 65, 0.2)';
                            item.style.borderLeft = '3px solid #00ff41';
                        });
                        
                        item.addEventListener('mouseleave', () => {
                            try {
                                const currentCountry = localStorage.getItem('user_selected_country');
                                if (currentCountry && currentCountry.toUpperCase() === country.code.toUpperCase()) {
                                    item.style.background = 'rgba(0, 255, 65, 0.15)';
                                } else {
                                    item.style.background = 'transparent';
                                    item.style.borderLeft = 'none';
                                }
                            } catch (e) {
                                item.style.background = 'transparent';
                                item.style.borderLeft = 'none';
                            }
                        });
                        
                        // ç‚¹å‡»é€‰æ‹©å›½å®¶ï¼ˆUI å³æ—¶åé¦ˆ + handleManualLocationChange å…¨é‡æµç¨‹ï¼‰
                        item.addEventListener('click', async () => {
                            const displayName = (currentLang === 'zh' && country.nameZh) ? country.nameZh + ' (' + country.code + ')' : country.nameEn + ' (' + country.code + ')';
                            searchInput.value = displayName;
                            listContainer.classList.remove('left-drawer-country-list-visible');
                            searchInput.blur();
                            renderCountryList(displayName);
                            const dropdown = document.getElementById('country-select-dropdown');
                            if (dropdown) dropdown.value = country.code;
                            const countryName = (currentLang === 'zh' && country.nameZh) ? country.nameZh : country.nameEn;
                            const leftDrawer = document.getElementById('left-drawer');
                            const rightDrawer = document.getElementById('right-drawer');
                            if (leftDrawer) leftDrawer.classList.add('active');
                            if (rightDrawer) rightDrawer.classList.add('active');
                            try { localStorage.setItem('left_drawer_open', 'true'); localStorage.setItem('right_drawer_open', 'true'); } catch (e) { /* ignore */ }
                            try {
                                if (typeof window.switchGlobalCountry === 'function') {
                                    await window.switchGlobalCountry(country.code, 'left-drawer-country-list', { showLoading: false });
                                } else if (typeof window.handleManualLocationChange === 'function') {
                                    await window.handleManualLocationChange(country.code, { source: 'left-drawer-country-list', showLoading: false });
                                } else {
                                    try { localStorage.setItem('user_selected_country', country.code); } catch (e) {}
                                    if (typeof setOrUpdateCurrentLocationCursor === 'function') setOrUpdateCurrentLocationCursor(country.code);
                                    if (typeof updateUserCountryFlag === 'function') updateUserCountryFlag(country.code, countryName, true);
                                    if (typeof onCountrySwitch === 'function') onCountrySwitch(country.code, { source: 'left-drawer-country-list', name: countryName });
                                    await (typeof saveCountryToSupabase === 'function' ? saveCountryToSupabase(country.code) : Promise.resolve());
                                }
                            } catch (e) { console.warn('[LeftDrawerCountry] âš ï¸ åˆ‡æ¢å¤±è´¥:', e); }
                            if (typeof window.highlightSelectedCountry === 'function') window.highlightSelectedCountry();
                            console.log('[LeftDrawerCountry] âœ… å·²é€‰æ‹©å›½å®¶:', country.code);
                        });
                        
                        listContainer.appendChild(item);
                    });
                };

                // åˆ—è¡¨å±•å¼€/æ”¶èµ·ï¼šé»˜è®¤æ”¶èµ·ï¼Œä»…ç‚¹å‡»æœç´¢æ¡†åå±•å¼€
                const showCountryList = () => {
                    listContainer.classList.add('left-drawer-country-list-visible');
                    renderCountryList(searchInput.value);
                };
                const hideCountryList = () => {
                    listContainer.classList.remove('left-drawer-country-list-visible');
                };

                let listCloseTimer = null;
                const setSearchInputToCurrentCountry = () => {
                    try {
                        const code = localStorage.getItem('user_selected_country');
                        if (!code) { searchInput.value = ''; return; }
                        const countries = getAllCountries();
                        const c = countries.find(x => (x.code || '').toUpperCase() === code.toUpperCase());
                        if (c) {
                            searchInput.value = (currentLang === 'zh' && c.nameZh) ? c.nameZh + ' (' + c.code + ')' : c.nameEn + ' (' + c.code + ')';
                        } else { searchInput.value = code; }
                    } catch (e) { searchInput.value = ''; }
                };

                searchInput.addEventListener('focus', () => {
                    if (listCloseTimer) clearTimeout(listCloseTimer);
                    listCloseTimer = null;
                    searchInput.value = '';
                    searchInput.placeholder = (typeof i18n !== 'undefined' && i18n[currentLang] && i18n[currentLang]['search-countries']) ? i18n[currentLang]['search-countries'] : (currentLang === 'zh' ? 'æœç´¢å›½å®¶...' : 'Search countries...');
                    showCountryList();
                });
                searchInput.addEventListener('blur', () => {
                    listCloseTimer = setTimeout(() => {
                        hideCountryList();
                        setSearchInputToCurrentCountry();
                        updateSearchPlaceholder();
                    }, 200);
                });

                // æœç´¢åŠŸèƒ½
                let searchTimeout = null;
                searchInput.addEventListener('input', (e) => {
                    if (searchTimeout) clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        renderCountryList(e.target.value);
                    }, 200);
                });

                // ä¿å­˜æ¸²æŸ“å‡½æ•°åˆ°å…¨å±€ï¼Œä¾›é¡¶éƒ¨ä¸‹æ‹‰èœå•åŒæ­¥ä½¿ç”¨
                window.__leftDrawerCountryRender = renderCountryList;

                // æ›´æ–°æœç´¢æ¡†å ä½ç¬¦æ–‡æœ¬ï¼ˆå›½é™…åŒ–ï¼‰
                const updateSearchPlaceholder = () => {
                    if (searchInput) {
                        const placeholderText = (typeof i18n !== 'undefined' && i18n[currentLang] && i18n[currentLang]['search-countries']) 
                            ? i18n[currentLang]['search-countries'] 
                            : (currentLang === 'zh' ? 'æœç´¢å›½å®¶...' : 'Search countries...');
                        searchInput.placeholder = placeholderText;
                    }
                };
                updateSearchPlaceholder();
                // ç›‘å¬è¯­è¨€åˆ‡æ¢ï¼ˆé€šè¿‡ç›‘å¬ localStorage å˜åŒ–ï¼‰
                if (typeof window.addEventListener === 'function') {
                    window.addEventListener('storage', (e) => {
                        if (e.key === LANG_STORAGE_KEY || e.key === 'appLanguage') {
                            const newLang = normalizeLang(e.newValue || localStorage.getItem(LANG_STORAGE_KEY) || localStorage.getItem('appLanguage') || 'zh');
                            if (newLang !== currentLang) {
                                currentLang = newLang;
                                updateSearchPlaceholder();
                                // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°æ˜¾ç¤ºè¯­è¨€
                                renderCountryList(searchInput.value);
                            }
                        }
                    });
                    // ä¹Ÿç›‘å¬è‡ªå®šä¹‰è¯­è¨€åˆ‡æ¢äº‹ä»¶
                    window.addEventListener('languagechange', () => {
                        currentLang = normalizeLang(localStorage.getItem(LANG_STORAGE_KEY) || localStorage.getItem('appLanguage') || 'zh');
                        updateSearchPlaceholder();
                        renderCountryList(searchInput.value);
                    });
                }

                // åˆå§‹æ¸²æŸ“ï¼ˆåˆ—è¡¨é»˜è®¤æ”¶èµ·ï¼Œä»…æ˜¾ç¤ºå½“å‰å·²é€‰å›½å®¶åœ¨æœç´¢æ¡†ï¼‰
                setTimeout(() => {
                    ensureIsoNameToIso2MapLoaded().then(() => {
                        renderCountryList('');
                        setSearchInputToCurrentCountry();
                    }).catch(() => {
                        renderCountryList('');
                        setSearchInputToCurrentCountry();
                    });
                }, 500);

                console.log('[LeftDrawerCountry] âœ… å·¦ä¾§æŠ½å±‰å›½å®¶é€‰æ‹©èœå•å·²åˆå§‹åŒ–');
            } catch (e) {
                console.warn('[LeftDrawerCountry] âš ï¸ initLeftDrawerCountrySelector å¤±è´¥:', e);
            }
        }

        /**
         * åˆå§‹åŒ–å›½å®¶é€‰æ‹©ä¸‹æ‹‰èœå•
         */
        function initCountrySelectDropdown() {
            try {
                const dropdown = document.getElementById('country-select-dropdown');
                if (!dropdown) {
                    console.warn('[CountrySelect] âš ï¸ æ‰¾ä¸åˆ°å›½å®¶é€‰æ‹©ä¸‹æ‹‰èœå•');
                    return;
                }

                // ä½¿ç”¨å®Œæ•´çš„å›½å®¶åˆ—è¡¨
                const updateDropdown = () => {
                    const countries = getAllCountries();

                    // æ¸…ç©ºå¹¶å¡«å……é€‰é¡¹
                    const placeholderText = (typeof i18n !== 'undefined' && i18n[currentLang] && i18n[currentLang]['select-country']) 
                        ? `-- ${i18n[currentLang]['select-country']} --` 
                        : (currentLang === 'zh' ? '-- é€‰æ‹©å›½å®¶ --' : '-- Select Country --');
                    dropdown.innerHTML = `<option value="">${placeholderText}</option>`;
                    countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country.code;
                        // ä¸­æ–‡ç‰ˆæ˜¾ç¤ºä¸­æ–‡å›½å®¶åï¼Œè‹±æ–‡ç‰ˆæ˜¾ç¤ºè‹±æ–‡å›½å®¶å
                        const displayName = (currentLang === 'zh' && country.nameZh) 
                            ? `${country.nameZh} (${country.code})` 
                            : `${country.nameEn} (${country.code})`;
                        option.textContent = displayName;
                        dropdown.appendChild(option);
                    });

                    // ä» localStorage æ¢å¤é€‰æ‹©
                    try {
                        const savedCountry = localStorage.getItem('user_selected_country');
                        if (savedCountry) {
                            dropdown.value = savedCountry;
                            // æ˜¾ç¤ºå…‰æ ‡
                            setOrUpdateCurrentLocationCursor(savedCountry);
                        }
                    } catch (e) {
                        console.warn('[CountrySelect] âš ï¸ æ¢å¤é€‰æ‹©å¤±è´¥:', e);
                    }
                };

                // ç­‰å¾… ISO æ˜ å°„åŠ è½½å®Œæˆåå†æ›´æ–°
                ensureIsoNameToIso2MapLoaded().then(() => {
                    updateDropdown();
                }).catch(() => {
                    updateDropdown(); // å³ä½¿å¤±è´¥ä¹Ÿæ›´æ–°ï¼ˆä½¿ç”¨ countryNameMapï¼‰
                });

                // ç›‘å¬è¯­è¨€åˆ‡æ¢ï¼Œæ›´æ–°ä¸‹æ‹‰èœå•
                if (typeof window.addEventListener === 'function') {
                    window.addEventListener('storage', (e) => {
                        if (e.key === LANG_STORAGE_KEY || e.key === 'appLanguage') {
                            const newLang = normalizeLang(e.newValue || localStorage.getItem(LANG_STORAGE_KEY) || localStorage.getItem('appLanguage') || 'zh');
                            if (newLang !== currentLang) {
                                currentLang = newLang;
                                updateDropdown();
                            }
                        }
                    });
                    // ä¹Ÿç›‘å¬è‡ªå®šä¹‰è¯­è¨€åˆ‡æ¢äº‹ä»¶
                    window.addEventListener('languagechange', () => {
                        currentLang = normalizeLang(localStorage.getItem(LANG_STORAGE_KEY) || localStorage.getItem('appLanguage') || 'zh');
                        updateDropdown();
                    });
                }

                // ç›‘å¬é€‰æ‹©å˜åŒ–ï¼ˆä¸è‡ªåŠ¨æ‰“å¼€æŠ½å±‰ï¼‰
                dropdown.addEventListener('change', async (e) => {
                    const countryCode = e.target.value;
                    if (!countryCode) {
                        // æ¸…é™¤å…‰æ ‡
                        if (window.userMarker) {
                            try {
                                const map = window.map;
                                if (map && typeof map.removeLayer === 'function') {
                                    map.removeLayer(window.userMarker);
                                    window.userMarker = null;
                                }
                            } catch (err) {
                                console.warn('[CountrySelect] âš ï¸ æ¸…é™¤å…‰æ ‡å¤±è´¥:', err);
                            }
                        }
                        // æ¸…é™¤ ECharts å…‰æ ‡
                        try {
                            if (mapChart && typeof mapChart.setOption === 'function') {
                                const currentOption = mapChart.getOption();
                                if (currentOption && currentOption.series && Array.isArray(currentOption.series)) {
                                    const otherSeries = currentOption.series.filter(s => s && s.name !== 'Current Location');
                                    mapChart.setOption({ series: otherSeries }, { notMerge: false, lazyUpdate: false });
                                }
                            }
                        } catch (e) {
                            // ignore
                        }
                        localStorage.removeItem('user_selected_country');
                        // åŒæ­¥æ›´æ–°å·¦ä¾§æŠ½å±‰
                        const leftSearch = document.getElementById('left-drawer-country-search');
                        if (leftSearch) {
                            leftSearch.value = '';
                            const renderFn = window.__leftDrawerCountryRender;
                            if (typeof renderFn === 'function') {
                                renderFn('');
                            }
                        }
                        // å–æ¶ˆé«˜äº®
                        try {
                            if (mapChart && typeof mapChart.dispatchAction === 'function') {
                                mapChart.dispatchAction({ type: 'downplay' });
                            }
                        } catch (e) {
                            // ignore
                        }
                        return;
                    }

                    // ç›‘å¬å™¨ç»Ÿä¸€æŒ‡å‘ window.switchGlobalCountryï¼ˆå·¦ä¸Šè§’ä¸‹æ‹‰æ¡†ï¼‰
                    try {
                        if (typeof window.switchGlobalCountry === 'function') {
                            await window.switchGlobalCountry(countryCode, 'country-select-dropdown', { showLoading: true });
                        } else if (typeof window.handleManualLocationChange === 'function') {
                            await window.handleManualLocationChange(countryCode, { source: 'country-select-dropdown', showLoading: true });
                        } else {
                            try {
                                localStorage.setItem('user_selected_country', countryCode);
                                if (countryCode && /^[A-Z]{2}$/i.test(countryCode)) {
                                    localStorage.setItem('manual_location', countryCode.toUpperCase());
                                }
                            } catch (e) {}
                            setOrUpdateCurrentLocationCursor(countryCode);
                            await saveCountryToSupabase(countryCode);
                            if (typeof window.refreshUserStats === 'function') await window.refreshUserStats();
                        }
                    } catch (err) {
                        console.warn('[CountrySelect] âš ï¸ åˆ‡æ¢å¤±è´¥:', err);
                    }

                    // æ³¨æ„ï¼šä¸è‡ªåŠ¨æ‰“å¼€æŠ½å±‰ï¼Œåªä¿å­˜é€‰æ‹©
                });

                console.log('[CountrySelect] âœ… å›½å®¶é€‰æ‹©ä¸‹æ‹‰èœå•å·²åˆå§‹åŒ–');
            } catch (e) {
                console.warn('[CountrySelect] âš ï¸ initCountrySelectDropdown å¤±è´¥:', e);
            }
        }

        /**
         * ä¿å­˜å›½å®¶é€‰æ‹©åˆ° Supabaseï¼ˆç»‘å®šåˆ° GitHub è´¦æˆ·ï¼‰
         * @param {string} countryCode - å›½å®¶ä»£ç 
         */
        async function saveCountryToSupabase(countryCode) {
            try {
                // ä¼ é€’ç»™ Supabase çš„å‚æ•°æ°¸è¿œæ˜¯ toUpperCase() åçš„ 2 ä½ä»£ç 
                const code = String(countryCode || '').trim().toUpperCase();
                if (!/^[A-Z]{2}$/.test(code)) return;

                if (!supabaseClient) {
                    console.warn('[CountrySelect] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                    return;
                }

                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session || !session.user) {
                    console.warn('[CountrySelect] âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•ä¿å­˜åˆ° Supabase');
                    return;
                }

                const userId = session.user.id;
                console.log('[CountrySelect] ğŸ’¾ ä¿å­˜å›½å®¶é€‰æ‹©åˆ° Supabase:', { userId, countryCode: code });

                // æ›´æ–° user_analysis è¡¨ï¼ˆå§‹ç»ˆä½¿ç”¨ 2 ä½å¤§å†™ä»£ç ï¼‰
                const { data, error } = await supabaseClient
                    .from('user_analysis')
                    .update({
                        current_location: code,
                        location_switched_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId)
                    .select();

                if (error) {
                    console.error('[CountrySelect] âŒ ä¿å­˜åˆ° Supabase å¤±è´¥:', error);
                    // å°è¯•ä½¿ç”¨ API æ¥å£
                    try {
                        const fingerprint = localStorage.getItem('user_fingerprint') || '';
                        var __ufp = '';
                        try { __ufp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                        const _updateUrl = (document.querySelector('meta[name="api-endpoint"]')?.content || '').replace(/\/$/, '') + '/api/v2/update_location?fingerprint=' + encodeURIComponent(__ufp) + '&_t=' + Date.now();
                        const response = await fetch(_updateUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${session.access_token}`
                            },
                            body: JSON.stringify({
                                fingerprint: fingerprint,
                                current_location: countryCode.toUpperCase(),
                                switched_at: new Date().toISOString()
                            })
                        });
                        const result = await response.json();
                        if (result.status === 'success') {
                            console.log('[CountrySelect] âœ… é€šè¿‡ API ä¿å­˜æˆåŠŸ');
                        } else {
                            console.warn('[CountrySelect] âš ï¸ API ä¿å­˜å¤±è´¥:', result);
                        }
                    } catch (apiError) {
                        console.error('[CountrySelect] âŒ API ä¿å­˜å¼‚å¸¸:', apiError);
                    }
                } else {
                    console.log('[CountrySelect] âœ… ä¿å­˜åˆ° Supabase æˆåŠŸ:', data);
                }
            } catch (e) {
                console.error('[CountrySelect] âŒ saveCountryToSupabase å¼‚å¸¸:', e);
            }
        }

        function initMapCursorTools() {
            try {
                // åˆå§‹åŒ–å›½å®¶é€‰æ‹©ä¸‹æ‹‰èœå•ï¼ˆé¡¶éƒ¨ï¼‰
                initCountrySelectDropdown();
                
                // åˆå§‹åŒ–å·¦ä¾§æŠ½å±‰å›½å®¶é€‰æ‹©èœå•
                initLeftDrawerCountrySelector();
                
                // åˆå§‹åŒ–èº«ä»½è®¾ç½®å¼¹çª—ï¼ˆå›½å®¶åˆ—è¡¨ã€æœç´¢ã€å…³é—­ï¼‰
                initCountrySelector();
                
                // ç§»é™¤æ‰€æœ‰æ—§çš„æ‹–æ‹½å’Œç§»åŠ¨ç›¸å…³åŠŸèƒ½
                // ï¼ˆä¸å†éœ€è¦æ ¡å‡†ã€é”šå®šç­‰åŠŸèƒ½ï¼‰
                
                console.log('[MapCursor] âœ… åœ°å›¾å…‰æ ‡å·¥å…·å·²åˆå§‹åŒ–ï¼ˆä»…å›½å®¶é€‰æ‹©ï¼‰');
            } catch (e) {
                console.warn('[MapCursor] âš ï¸ initMapCursorTools å¤±è´¥:', e);
            }
        }
        
        /**
         * è®¾ç½®é”šå®šæ¨¡å¼
         * @param {boolean} enabled - æ˜¯å¦å¯ç”¨é”šå®šæ¨¡å¼
         */
        function setAnchorMode(enabled) {
            isAnchorMode = !!enabled;
            try {
                const btn = document.getElementById('btn-anchor-location');
                if (btn) {
                    btn.classList.toggle('active', isAnchorMode);
                }
                const hintEl = document.getElementById('map-anchor-hint');
                if (hintEl) hintEl.style.display = isAnchorMode ? '' : 'none';
                const textEl = document.getElementById('btn-anchor-location-text');
                if (textEl) textEl.textContent = isAnchorMode ? 'é€€å‡ºé”šå®š' : 'å®šä½é”šç‚¹';
                
                // å¦‚æœå¯ç”¨é”šå®šæ¨¡å¼ï¼Œé€€å‡ºæ ¡å‡†æ¨¡å¼
                if (isAnchorMode && isCalibrating) {
                    setCalibrationMode(false);
                }
                // å¦‚æœå¯ç”¨æ ¡å‡†æ¨¡å¼ï¼Œé€€å‡ºé”šå®šæ¨¡å¼
                if (isCalibrating && isAnchorMode) {
                    isAnchorMode = false;
                    if (btn) btn.classList.remove('active');
                    if (hintEl) hintEl.style.display = 'none';
                    if (textEl) textEl.textContent = 'å®šä½é”šç‚¹';
                }
                
                console.log('[Anchor] é”šå®šæ¨¡å¼:', isAnchorMode ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨');
            } catch (e) {
                console.warn('[Anchor] âš ï¸ setAnchorMode å¤±è´¥:', e);
            }
        }
        
        /**
         * åˆå§‹åŒ–å›½å®¶é€‰æ‹©å™¨æµ®çª—
         */
        function initCountrySelector() {
            try {
                const modal = document.getElementById('country-selector-modal');
                const closeBtn = document.getElementById('country-selector-close');
                const searchInput = document.getElementById('country-search-input');
                const listContainer = document.getElementById('country-list-container');
                
                if (!modal || !closeBtn || !searchInput || !listContainer) return;
                
                // å…³é—­æŒ‰é’®ï¼ˆä¸æ—©æœŸè„šæœ¬ä¸­çš„äº‹ä»¶å§”æ‰˜äº’è¡¥ï¼Œç¡®ä¿æ¢å¤æ»šåŠ¨ï¼‰
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                    try { document.body.style.overflow = ''; document.documentElement.style.overflow = ''; } catch (e) {}
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                        try { document.body.style.overflow = ''; document.documentElement.style.overflow = ''; } catch (e) {}
                    }
                });
                
                // æœç´¢åŠŸèƒ½
                let searchTimeout = null;
                searchInput.addEventListener('input', (e) => {
                    if (searchTimeout) clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        renderCountryList(e.target.value.trim());
                    }, 200);
                });
                
                // æ¸²æŸ“å›½å®¶åˆ—è¡¨
                renderCountryList('');
            } catch (e) {
                console.warn('[CountrySelector] âš ï¸ initCountrySelector å¤±è´¥:', e);
            }
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() { initCountrySelector(); });
        } else {
            initCountrySelector();
        }
        
        /**
         * æ¸²æŸ“å›½å®¶åˆ—è¡¨
         * @param {string} searchQuery - æœç´¢å…³é”®è¯
         */
        function renderCountryList(searchQuery) {
            try {
                const listContainer = document.getElementById('country-list-container');
                if (!listContainer) return;
                
                // è·å–æ‰€æœ‰å›½å®¶ï¼ˆä» countryNameMap å’Œ ISO æ˜ å°„ï¼‰
                const countries = [];
                
                // ä» countryNameMap è·å–
                if (typeof countryNameMap !== 'undefined') {
                    for (const [code, names] of Object.entries(countryNameMap)) {
                        countries.push({
                            code: code,
                            nameZh: names.zh || '',
                            nameEn: names.en || code
                        });
                    }
                }
                
                // ä» ISO æ˜ å°„è·å–æ›´å¤šå›½å®¶ï¼ˆå¦‚æœæœ‰ï¼‰
                if (window.__isoNameToIso2 instanceof Map) {
                    const isoMap = window.__isoNameToIso2;
                    for (const [name, code] of isoMap.entries()) {
                        if (!countries.find(c => c.code === code)) {
                            countries.push({
                                code: code,
                                nameZh: '',
                                nameEn: name
                            });
                        }
                    }
                }
                
                // æ’åº
                countries.sort((a, b) => {
                    const nameA = (currentLang === 'zh' && a.nameZh) ? a.nameZh : a.nameEn;
                    const nameB = (currentLang === 'zh' && b.nameZh) ? b.nameZh : b.nameEn;
                    return nameA.localeCompare(nameB);
                });
                
                // è¿‡æ»¤ï¼ˆæ”¯æŒä¸­æ–‡/è‹±æ–‡/å›½å®¶ç ï¼Œç©ºåç§°æŒ‰ç©ºå­—ç¬¦ä¸²å‚ä¸åŒ¹é…ï¼‰
                const query = String(searchQuery || '').trim().toLowerCase();
                const filtered = !query
                    ? countries
                    : countries.filter(c => {
                        const nameZh = (c.nameZh != null ? String(c.nameZh) : '').toLowerCase();
                        const nameEn = (c.nameEn != null ? String(c.nameEn) : '').toLowerCase();
                        const code = (c.code != null ? String(c.code) : '').toLowerCase();
                        return nameZh.includes(query) || nameEn.includes(query) || code.includes(query);
                    });
                
                // æ¸²æŸ“
                listContainer.innerHTML = filtered.map(c => {
                    const displayName = (currentLang === 'zh' && c.nameZh) ? `${c.nameZh} (${c.code})` : `${c.nameEn} (${c.code})`;
                    const isSelected = (window.currentUser?.manual_location || localStorage.getItem('manual_location') || '').toUpperCase() === c.code.toUpperCase();
                    return `
                        <div class="country-item ${isSelected ? 'selected' : ''}" data-code="${c.code}" data-name="${c.nameEn}">
                            ${displayName}
                        </div>
                    `;
                }).join('');
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                listContainer.querySelectorAll('.country-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const code = item.getAttribute('data-code');
                        const name = item.getAttribute('data-name');
                        selectCountryFromSelector(code, name);
                    });
                });
            } catch (e) {
                console.warn('[CountrySelector] âš ï¸ renderCountryList å¤±è´¥:', e);
            }
        }
        
        /**
         * ä»é€‰æ‹©å™¨é€‰æ‹©å›½å®¶
         * @param {string} countryCode - å›½å®¶ä»£ç 
         * @param {string} countryName - å›½å®¶åç§°
         */
        async function selectCountryFromSelector(countryCode, countryName) {
            try {
                // ã€å¼ºåˆ¶é€‰ç±ã€‘å¼¹çª—åˆé€‰å®Œæˆï¼šå…ˆåŒæ­¥åç«¯ â†’ æŒä¹…åŒ– user_country_fixed â†’ å…³å¼¹çª—è§£é” â†’ å†åˆ·æ–°ä»ªè¡¨ç›˜ä¸å·¦ä¾§å¡ç‰‡
                if (window.__countryPickerForced) {
                    window.__countryPickerForced = false;
                    const code = String(countryCode || '').trim().toUpperCase();
                    if (!/^[A-Z]{2}$/.test(code)) return;
                    const base = (document.querySelector('meta[name="api-endpoint"]')?.content || '').trim();
                    const apiBase = base.endsWith('/') ? base.slice(0, -1) : base;
                    let fp = '';
                    try { fp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (e) {}
                    try {
                        // ç”¨æˆ·ä¸»åŠ¨é€‰ç±ï¼Œå¼ºåˆ¶æ‰§è¡Œå†™å…¥ï¼Œä¸å— AUTO_REPORT é™åˆ¶
                        const res = await fetch(apiBase ? apiBase + '/api/update-location' : '/api/update-location', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-Intent': 'manual_location_update' },
                            body: JSON.stringify({ fingerprint: fp, new_cc: code })
                        });
                        if (!res.ok) {
                            if (typeof showNotification === 'function') showNotification('ä½ç½®åŒæ­¥å¤±è´¥');
                            else try { alert('ä½ç½®åŒæ­¥å¤±è´¥'); } catch (_) {}
                            window.__countryPickerForced = true;
                            return;
                        }
                        try { localStorage.setItem('user_country_fixed', code); } catch (e) {}
                        window.currentCountryCode = code;
                    } catch (e) {
                        console.warn('[CountryPicker] update-location å¤±è´¥:', e);
                        if (typeof showNotification === 'function') showNotification('ä½ç½®åŒæ­¥å¤±è´¥');
                        else try { alert('ä½ç½®åŒæ­¥å¤±è´¥'); } catch (_) {}
                        window.__countryPickerForced = true;
                        return;
                    }
                    const modal = document.getElementById('country-selector-modal');
                    if (modal) modal.style.display = 'none';
                    try { document.body.style.overflow = ''; document.documentElement.style.overflow = ''; } catch (e) {}
                    if (typeof updateCountryDashboard === 'function') await updateCountryDashboard(code, { force: true });
                    if (typeof window.refreshUserStats === 'function') try { window.refreshUserStats(); } catch (e) {}
                    try { localStorage.setItem('user_manual_location', code); localStorage.setItem('user_selected_country', code); } catch (e) {}
                    return;
                }
                const modal = document.getElementById('country-selector-modal');
                if (modal) modal.style.display = 'none';
                
                // è·å–å›½å®¶ä¸­å¿ƒåæ ‡
                const center = countryCenterMap[countryName] || null;
                if (!center) {
                    console.warn('[CountrySelector] âš ï¸ æœªæ‰¾åˆ°å›½å®¶ä¸­å¿ƒåæ ‡:', countryName);
                    return;
                }
                
                const [lng, lat] = center;
                
                // ç§»åŠ¨åˆ°å›½å®¶ä¸­å¿ƒ
                if (mapChart && typeof moveCurrentLocationCursor === 'function') {
                    moveCurrentLocationCursor(lng, lat);
                }
                
                // å¹³æ»‘ç§»åŠ¨åœ°å›¾è§†å›¾
                if (mapChart && typeof mapChart.setOption === 'function') {
                    const currentOption = mapChart.getOption();
                    if (currentOption && currentOption.geo && Array.isArray(currentOption.geo) && currentOption.geo.length > 0) {
                        mapChart.setOption({
                            geo: currentOption.geo.map(geo => ({
                                ...geo,
                                center: [lng, lat],
                                zoom: 3
                            }))
                        }, { notMerge: false, lazyUpdate: false });
                    }
                }
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                await saveManualLocation(countryCode, lng, lat);
                
                console.log('[CountrySelector] âœ… å·²é€‰æ‹©å›½å®¶:', countryCode, countryName);
            } catch (e) {
                console.warn('[CountrySelector] âš ï¸ selectCountryFromSelector å¤±è´¥:', e);
            }
        }
        
        /**
         * ä¿å­˜æ‰‹åŠ¨ä½ç½®åˆ°æ•°æ®åº“
         * @param {string} countryCode - å›½å®¶ä»£ç 
         * @param {number} lng - ç»åº¦
         * @param {number} lat - çº¬åº¦
         */
        async function saveManualLocation(countryCode, lng, lat) {
            try {
                const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || '';
                const base = apiEndpoint.endsWith('/') ? apiEndpoint.slice(0, -1) : apiEndpoint;
                var _afp = '';
                try { _afp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                const analyzeUrl = base ? `${base}/api/v2/analyze?fingerprint=${encodeURIComponent(_afp)}&_t=${Date.now()}` : '/api/v2/analyze?fingerprint=' + encodeURIComponent(_afp) + '&_t=' + Date.now();
                
                let fingerprint = null;
                try {
                    fingerprint = localStorage.getItem('user_fingerprint') || window.fpId || null;
                } catch (e) {}
                
                const payload = {
                    chatData: [{ role: 'USER', text: '.' }],
                    manual_location: countryCode || null,
                    manual_lat: lat,
                    manual_lng: lng,
                    fingerprint: fingerprint
                };
                
                // å¦‚æœå·²ç™»å½• GitHubï¼Œæ·»åŠ  id
                if (supabaseClient) {
                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        if (session && session.user) {
                            payload.id = session.user.id;
                            payload.user_identity = 'github';
                        }
                    } catch (e) {}
                }
                
                const res = await fetch(analyzeUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (res.ok) {
                    // ã€åæ ‡æ ¼å¼åŒ–ã€‘ä½¿ç”¨ toFixed(6) æ ¼å¼åŒ–åæ ‡
                    const formattedLat = Number(lat).toFixed(6);
                    const formattedLng = Number(lng).toFixed(6);
                    
                    // ä¿å­˜åˆ° localStorageï¼ˆæ ¼å¼åŒ–åçš„åæ ‡ï¼‰
                    localStorage.setItem('loc_locked', 'true');
                    localStorage.setItem('loc_fixed', 'true');
                    localStorage.setItem('manual_lat', formattedLat);
                    localStorage.setItem('manual_lng', formattedLng);
                    if (countryCode) localStorage.setItem('manual_location', String(countryCode).trim());
                    
                    window.__cursorLocked = true;
                    
                    // ã€å•ä¾‹ç®¡ç†ã€‘æ›´æ–°å…‰æ ‡ç®¡ç†å™¨çš„é”šå®šçŠ¶æ€
                    if (window.mapCursorManager) {
                        window.mapCursorManager.setAnchored(true, Number(formattedLng), Number(formattedLat));
                    }
                    
                    // æ›´æ–°é€€å‡ºé”šå®šæŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
                    updateResetButtonVisibility();
                    
                    // æ›´æ–°å…¨å±€ç”¨æˆ·æ•°æ®ï¼ˆé˜²å¾¡ï¼šä»…å½“ target ä¸ºå¯¹è±¡æ—¶è®¾ç½® location ç­‰å±æ€§ï¼‰
                    if (!window.currentUserData) window.currentUserData = window.currentUser || {};
                    var _cud = window.currentUserData;
                    if (_cud && typeof _cud === 'object') {
                        _cud.manual_lat = Number(formattedLat);
                        _cud.manual_lng = Number(formattedLng);
                        _cud.manual_location = countryCode;
                    }
                    var _cu = window.currentUser;
                    if (_cu && typeof _cu === 'object') {
                        _cu.manual_location = countryCode;
                        _cu.country_code = countryCode;
                        _cu.manual_lat = Number(formattedLat);
                        _cu.manual_lng = Number(formattedLng);
                    }
                    
                    // ã€UI åŒæ­¥ã€‘ç«‹å³æ›´æ–°å…‰æ ‡æ˜¾ç¤º
                    if (typeof setOrUpdateCurrentLocationCursor === 'function') {
                        try {
                            const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                            const statusColor = statusConfig.status_color;
                            const githubUsername = localStorage.getItem('github_username') || null;
                            const avatarUrl = isValidGitHubUsername(githubUsername) 
                                ? getGitHubAvatarUrl(githubUsername) 
                                : DEFAULT_AVATAR;
                            
                            setOrUpdateCurrentLocationCursor(
                                Number(formattedLng), 
                                Number(formattedLat), 
                                statusColor, 
                                avatarUrl, 
                                githubUsername,
                                true // force: trueï¼Œå¼ºåˆ¶æ›´æ–°
                            );
                        } catch (e) {
                            console.warn('[SaveLocation] âš ï¸ æ›´æ–°å…‰æ ‡æ˜¾ç¤ºå¤±è´¥:', e);
                        }
                    }
                    
                    // åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡
                    if (typeof window.refreshUserStats === 'function') {
                        setTimeout(() => window.refreshUserStats(), 300);
                    }
                    
                    console.log('[SaveLocation] âœ… å·²ä¿å­˜æ‰‹åŠ¨ä½ç½®:', { countryCode, lng: formattedLng, lat: formattedLat });
                } else {
                    console.warn('[SaveLocation] âš ï¸ ä¿å­˜å¤±è´¥:', res.status);
                }
            } catch (e) {
                console.warn('[SaveLocation] âš ï¸ saveManualLocation å¤±è´¥:', e);
            }
        }
        
        /**
         * é‡ç½®åˆ°è‡ªåŠ¨å®šä½ï¼ˆé€€å‡ºé”šå®šï¼‰
         * æ¸…é™¤ manual_lat/lng ç¼“å­˜ï¼Œå°† isAnchored è®¾ä¸º falseï¼Œå¹¶è§¦å‘ä¸€æ¬¡åŸºäº IP çš„å³æ—¶å®šä½åˆ·æ–°
         */
        async function resetToAutoLocation() {
            try {
                console.log('[ResetLocation] ğŸ”„ å¼€å§‹é‡ç½®åˆ°è‡ªåŠ¨å®šä½...');
                
                // æ¸…é™¤ localStorage ä¸­çš„é”å®šæ ‡è®°å’Œåæ ‡
                localStorage.removeItem('loc_locked');
                localStorage.removeItem('loc_fixed');
                localStorage.removeItem('manual_lat');
                localStorage.removeItem('manual_lng');
                localStorage.removeItem('manual_location');
                
                // ã€å•ä¾‹ç®¡ç†ã€‘æ¸…é™¤é”šå®šçŠ¶æ€
                if (window.mapCursorManager) {
                    window.mapCursorManager.setAnchored(false);
                }
                
                window.__cursorLocked = false;
                
                // æ›´æ–°é€€å‡ºé”šå®šæŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
                updateResetButtonVisibility();
                
                // æ¸…é™¤å…¨å±€ç”¨æˆ·æ•°æ®ä¸­çš„æ‰‹åŠ¨åæ ‡
                if (window.currentUserData) {
                    delete window.currentUserData.manual_lat;
                    delete window.currentUserData.manual_lng;
                    delete window.currentUserData.manual_location;
                }
                
                if (window.currentUser) {
                    delete window.currentUser.manual_lat;
                    delete window.currentUser.manual_lng;
                    delete window.currentUser.manual_location;
                }
                
                // æ¸…é™¤å…‰æ ‡
                if (window.mapCursorManager) {
                    window.mapCursorManager.clearCursor();
                }
                
                // è§¦å‘ä¸€æ¬¡åŸºäº IP çš„å³æ—¶å®šä½åˆ·æ–°
                if (typeof autoReportSelf === 'function') {
                    try {
                        const reportResult = await autoReportSelf();
                        console.log('[ResetLocation] âœ… è‡ªåŠ¨å®šä½åˆ·æ–°å®Œæˆ:', reportResult);
                    } catch (e) {
                        console.warn('[ResetLocation] âš ï¸ è‡ªåŠ¨å®šä½åˆ·æ–°å¤±è´¥:', e);
                    }
                }
                
                // åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡
                if (typeof window.refreshUserStats === 'function') {
                    setTimeout(() => window.refreshUserStats(), 300);
                }
                
                console.log('[ResetLocation] âœ… å·²é‡ç½®åˆ°è‡ªåŠ¨å®šä½');
            } catch (e) {
                console.warn('[ResetLocation] âš ï¸ resetToAutoLocation å¤±è´¥:', e);
            }
        }
        
        /**
         * æ›´æ–°é€€å‡ºé”šå®šæŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
         */
        function updateResetButtonVisibility() {
            try {
                const resetBtn = document.getElementById('btn-reset-location');
                if (resetBtn) {
                    const isAnchored = window.mapCursorManager?.isAnchored || 
                                      localStorage.getItem('loc_locked') === 'true' || 
                                      localStorage.getItem('loc_fixed') === 'true';
                    resetBtn.style.display = isAnchored ? 'inline-flex' : 'none';
                }
            } catch (e) {
                console.warn('[ResetButton] âš ï¸ æ›´æ–°æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€å¤±è´¥:', e);
            }
        }
        
        /**
         * æ‰“å¼€å›½å®¶é€‰æ‹©å™¨æµ®çª—
         */
        function openCountrySelector() {
            try {
                const modal = document.getElementById('country-selector-modal');
                if (modal) {
                    modal.style.display = 'block';
                    const searchInput = document.getElementById('country-search-input');
                    if (searchInput) {
                        searchInput.value = '';
                        searchInput.focus();
                    }
                    renderCountryList('');
                }
            } catch (e) {
                console.warn('[CountrySelector] âš ï¸ openCountrySelector å¤±è´¥:', e);
            }
        }

        /**
         * æ ¡å‡†ç¡®è®¤ï¼šè°ƒç”¨ /api/v2/analyze æŒä¹…åŒ– manual_locationï¼ˆå›½å®¶ä»£ç ï¼‰ã€manual_latã€manual_lngï¼Œé€€å‡ºæ ¡å‡†å¹¶æ›´æ–° UI
         * @param {string} countryCode - å›½å®¶ä»£ç ï¼ˆå¦‚ CNã€USï¼‰ï¼Œç”¨äº manual_location
         * @param {string} countryName - å›½å®¶åç§°ï¼ˆç”¨äºå±•ç¤ºï¼‰
         * @param {number} lng - ç»åº¦
         * @param {number} lat - çº¬åº¦
         */
        async function confirmCalibrationAndLock(countryCode, countryName, lng, lat) {
            if (calibrationDebounceTimer) {
                clearTimeout(calibrationDebounceTimer);
                calibrationDebounceTimer = null;
            }
            isCalibrating = false;
            updateCurrentLocationCursorColor('#00ff41');

            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || '';
            const base = apiEndpoint.endsWith('/') ? apiEndpoint.slice(0, -1) : apiEndpoint;
            let fingerprint = null;
            try {
                fingerprint = localStorage.getItem('user_fingerprint') || window.fpId || null;
            } catch (e) {}
            const analyzeUrl = base ? `${base}/api/v2/analyze?fingerprint=${encodeURIComponent(fingerprint || '')}&_t=${Date.now()}` : '/api/v2/analyze?fingerprint=' + encodeURIComponent(fingerprint || '') + '&_t=' + Date.now();
            const payload = {
                chatData: [{ role: 'USER', text: '.' }],
                manual_location: countryCode || null,
                manual_lat: lat,
                manual_lng: lng,
                fingerprint: fingerprint
            };
            try {
                const res = await fetch(analyzeUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    console.warn('[Calibration] âš ï¸ æ ¡å‡†æ¥å£è¿”å›é 2xx:', res.status);
                } else {
                    const data = await res.json().catch(() => ({}));
                    // ã€æ–°å¢ã€‘é”å®šæ ‡å¿—ï¼šé˜²æ­¢åç»­å¼‚æ­¥æ“ä½œè¦†ç›–
                    localStorage.setItem('loc_locked', 'true');
                    window.__cursorLocked = true; // è®¾ç½®å…¨å±€é”å®šæ ‡å¿—
                    // çŠ¶æ€æŒä¹…åŒ–ï¼šç¡®è®¤å®šå±…åç«‹å³å†™å…¥é”å®šæ ‡è®°ä¸åæ ‡ï¼Œå¹¶é‡ç»˜åœ°å›¾å…‰æ ‡ä¸ºç»¿è‰²
                    localStorage.setItem('loc_fixed', 'true');
                    if (!window.currentUserData) window.currentUserData = window.currentUser || {};
                    var _cud2 = window.currentUserData;
                    if (_cud2 && typeof _cud2 === 'object') {
                        _cud2.manual_lat = lat;
                        _cud2.manual_lng = lng;
                        _cud2.manual_location = countryCode;
                    }
                    localStorage.setItem('manual_lat', String(lat));
                    localStorage.setItem('manual_lng', String(lng));
                    if (countryCode && String(countryCode).trim() !== '') localStorage.setItem('manual_location', String(countryCode).trim());
                    try { _setAnchoredCountry(countryCode); } catch { /* ignore */ }
                    updateCurrentLocationCursorColor('#00ff41');
                    window.__cursorLocked = true;
                    setTimeout(() => forceRestoreLockedCursor(), 100);
                    var _cu2 = window.currentUser;
                    if (_cu2 && typeof _cu2 === 'object') {
                        _cu2.manual_location = countryCode;
                        _cu2.country_code = countryCode;
                        _cu2.manual_lat = lat;
                        _cu2.manual_lng = lng;
                    }
                    updateUserCountryFlag(countryCode, countryName, true);
                    if (typeof renderRankCards === 'function' && window.currentUser) renderRankCards(window.currentUser);
                    if (typeof window.refreshUserStats === 'function') {
                        setTimeout(() => window.refreshUserStats(), 300);
                    }
                    // æ ¡å‡†ç¡®è®¤åç«‹å³é‡è½½é»‘è¯æ¦œï¼ˆå³ä¾§æŠ½å±‰ï¼‰
                    try { window.refreshVibeCard && window.refreshVibeCard(String(countryCode).toUpperCase()); } catch { /* ignore */ }
                    if (countryCode && typeof fetchCountrySummaryV3 === 'function') {
                        fetchCountrySummaryV3(countryCode).then((summary) => {
                            // ä»…åˆ·æ–°å³ä¾§æŠ½å±‰æ•°æ®ï¼Œä¸é‡è®¾éª¨æ¶ã€ä¸é‡å»ºå·¦ä¾§ï¼Œé¿å…åå¤å åŠ ä¸é”™ä¹±
                            if (summary) showDrawersWithCountryData(countryCode, countryName || countryCode, summary, { summaryOnly: true });
                        }).catch(() => {});
                    } else if (countryCode) {
                        showDrawersWithCountryData(countryCode, countryName || countryCode);
                    }
                    console.log('[Calibration] âœ… æ ¡å‡†å·²ç¡®è®¤å¹¶æŒä¹…åŒ–ï¼ˆå·²é”å®šï¼‰:', { countryCode, countryName, lng, lat });
                }
            } catch (err) {
                console.warn('[Calibration] âš ï¸ æ ¡å‡†è¯·æ±‚å¤±è´¥:', err);
            }
        }

        /**
         * æ‹‰å–æŸå›½å®¶çš„ 10 é¡¹æ ¸å¿ƒæŒ‡æ ‡ï¼ˆget_country_summary_v3ï¼‰ï¼Œç”¨äºæ ¡å‡†åå³ä¾§æŠ½å±‰æ¸²æŸ“
         * @param {string} countryCode - 2 ä½å›½å®¶ä»£ç ï¼ˆå¦‚ CNã€USï¼‰
         * @returns {Promise<Object|null>} ä¸ lastData ç»“æ„å…¼å®¹çš„æ‘˜è¦å¯¹è±¡
         */
        async function fetchCountrySummaryV3(countryCode, attempt = 0) {
            if (!countryCode || String(countryCode).trim().length !== 2) return null;
            
            const maxAttempts = 2; // æœ€å¤šå°è¯•2ä¸ªç«¯ç‚¹
            const cc = String(countryCode).toUpperCase();
            
            const fp = (() => {
                try {
                    var p = new URLSearchParams(window.location.search);
                    var fromUrl = p.get('fingerprint') || p.get('fp') || '';
                    if (fromUrl) return String(fromUrl).trim();
                    return localStorage.getItem('user_fingerprint') || window.fpId || '';
                } catch { return ''; }
            })();
            const uid = (window.currentUser && window.currentUser.id) || (window.currentUserData && window.currentUserData.id) || '';
            
            const apiManager = window.API_ENDPOINT_MANAGER;
            const baseEndpoint = apiManager ? apiManager.getCurrent() : (document.querySelector('meta[name="api-endpoint"]')?.content || '');
            const base = baseEndpoint.endsWith('/') ? baseEndpoint.slice(0, -1) : baseEndpoint;
            let url = `${base}/api/country-summary?country=${encodeURIComponent(cc)}`;
            if (uid) url += `&user_id=${encodeURIComponent(uid)}`;
            if (fp) url += `&fingerprint=${encodeURIComponent(fp)}`;
            url += `&_ts=${Date.now()}`;
            
            // æ£€æŸ¥æœ¬åœ°ç¼“å­˜ï¼ˆ5åˆ†é’Ÿå†…æœ‰æ•ˆï¼‰ï¼›ç¼º countryTotals çš„æ—§ç¼“å­˜è§†ä¸ºæ— æ•ˆï¼Œé¿å… Global è§†å›¾é”™æ•°
            const cacheKey = `country_summary_${cc}`;
            try {
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    const { data, time } = JSON.parse(cached);
                    if (Date.now() - time < 300000 && data && typeof data === 'object' && data.countryTotals && typeof data.countryTotals === 'object') {
                        console.log(`[CountrySummary] ğŸ“¦ ä½¿ç”¨ç¼“å­˜æ•°æ®: ${cc}`);
                        return data;
                    }
                }
            } catch (e) { /* å¿½ç•¥ç¼“å­˜é”™è¯¯ */ }
            
            // æ·»åŠ è¶…æ—¶æ§åˆ¶ï¼šæ­£å¸¸ 10 ç§’ã€å¿«é€Ÿå¤±è´¥ 4 ç§’ï¼Œé€‚åº”å›½å†…æ³¢åŠ¨ä¸è¾¹ç¼˜ç½‘å…³
            const fastFail = document.querySelector('meta[name="api-fast-fail"]')?.content === 'true';
            const timeoutMs = fastFail ? 4000 : 10000;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            try {
                const res = await fetch(url, {
                    signal: controller.signal,
                    headers: { 'Accept': 'application/json' },
                    mode: 'cors',
                    credentials: 'omit'
                });
                clearTimeout(timeoutId);
                
                if (!res.ok) {
                    console.warn(`[CountrySummary] HTTP ${res.status}: ${cc}`);
                    throw new Error(`HTTP ${res.status}`);
                }
                
                const payload = await res.json();
                if (payload && typeof payload === 'object' && 'success' in payload && payload.success !== true) {
                    return null;
                }
                
                const raw = payload?.data ?? payload?.result ?? payload?.summary ?? payload?.payload ?? payload;
                let normalized = typeof normalizeData === 'function' ? normalizeData(raw) : raw;
                if (normalized && typeof normalized === 'object') {
                    normalized.countryCode = cc;
                    // ã€ä¿®å¤ã€‘normalizeData ä¸è¿”å› countryTotalsï¼Œå¿…é¡»ä» raw ä¿ç•™ï¼Œå¦åˆ™ Global è§†å›¾ä¼šé”™ç”¨ root å¯¼è‡´è°ƒæˆAIæ¬¡æ•°/å¹³å‡ç¯‡å¹…é”™ä¹±
                    if (raw && typeof raw === 'object' && raw.countryTotals && typeof raw.countryTotals === 'object') {
                        normalized.countryTotals = raw.countryTotals;
                        normalized.totalUsers = normalized.totalUsers ?? raw.countryTotals.totalUsers ?? raw.countryTotals.total_users;
                        normalized.totalAnalysis = normalized.totalAnalysis ?? raw.countryTotals.ai ?? raw.countryTotals.total_messages;
                        normalized.totalChars = normalized.totalChars ?? raw.countryTotals.say ?? raw.countryTotals.total_chars;
                    }
                    // ã€è°ƒè¯•ã€‘è¾“å‡º API è¿”å›çš„æ•°æ®ç»“æ„
                    console.log(`[CountrySummary] âœ… ${cc} API è¿”å›æ•°æ®ç»“æ„:`, {
                        hasCountryTotals: !!normalized.countryTotals,
                        countryTotalsKeys: normalized.countryTotals ? Object.keys(normalized.countryTotals) : [],
                        fullStructure: normalized
                    });
                }
                
                // ç¼“å­˜æˆåŠŸæ•°æ®
                try {
                    localStorage.setItem(cacheKey, JSON.stringify({ data: normalized, time: Date.now() }));
                } catch (e) { /* å¿½ç•¥å­˜å‚¨é”™è¯¯ */ }
                
                // æ ‡è®°ç«¯ç‚¹å¥åº·
                if (apiManager) apiManager.markHealthy(baseEndpoint, true);
                
                console.log(`[CountrySummary] âœ… ${cc} åŠ è½½æˆåŠŸ`);
                return normalized && typeof normalized === 'object' ? normalized : null;
                
            } catch (e) {
                clearTimeout(timeoutId);

                // æ ‡è®°ç«¯ç‚¹ä¸å¥åº·
                if (apiManager) apiManager.markHealthy(baseEndpoint, false);

                // å°è¯•åˆ‡æ¢ç«¯ç‚¹é‡è¯•
                if (attempt < maxAttempts - 1 && apiManager && apiManager.endpoints.length > 1) {
                    apiManager.switchNext();
                    console.log(`[CountrySummary] ğŸ”„ åˆ‡æ¢ç«¯ç‚¹é‡è¯• ${cc}...`);
                    return fetchCountrySummaryV3(countryCode, attempt + 1);
                }

                // è¶…æ—¶/ç½‘ç»œé”™è¯¯æ—¶åœ¨å³ä¾§æŠ½å±‰æ˜¾ç¤ºå‹å¥½æç¤ºï¼ˆä¸åªåœ¨æ§åˆ¶å°ï¼‰
                const statusEl = document.getElementById('rtDataStatus');
                if (statusEl) statusEl.textContent = (currentLang === 'en' ? 'Network unstable, retry or refresh' : 'ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œè¯·ç¨åæˆ–åˆ·æ–°');

                // é”™è¯¯åˆ†ç±»æç¤º
                if (e.name === 'AbortError') {
                    console.warn(`[CountrySummary] â±ï¸ è¯·æ±‚è¶…æ—¶: ${cc} (APIå¯èƒ½åœ¨å›½å†…æ— æ³•è®¿é—®)`);
                } else if (e.message?.includes('Failed to fetch') || e.message?.includes('NetworkError')) {
                    console.warn(`[CountrySummary] ğŸŒ ç½‘ç»œé”™è¯¯: ${cc} (APIç«¯ç‚¹å¯èƒ½è¢«å¢™)`);
                } else {
                    console.warn(`[CountrySummary] âŒ ${cc}:`, e.message || e);
                }

                // æœ€åé™çº§ï¼šå°è¯•ä¸å¸¦ country æ‹‰å– global-averageï¼Œè¿”å›å½’ä¸€åŒ–ç»“æ„ä¾›æŠ½å±‰å±•ç¤º
                if (attempt >= maxAttempts - 1) {
                    try {
                        const globalUrl = `${base}/api/global-average`;
                        const fallbackController = new AbortController();
                        const fallbackTimer = setTimeout(() => fallbackController.abort(), 8000);
                        const fallbackRes = await fetch(globalUrl, { signal: fallbackController.signal, headers: { 'Accept': 'application/json' }, mode: 'cors', credentials: 'omit' });
                        clearTimeout(fallbackTimer);
                        if (fallbackRes.ok) {
                            const globalPayload = await fallbackRes.json();
                            const raw = globalPayload?.data ?? globalPayload?.result ?? globalPayload;
                            if (raw && typeof raw === 'object') {
                                const normalized = typeof normalizeData === 'function' ? normalizeData(raw) : raw;
                                if (normalized && typeof normalized === 'object') {
                                    normalized.countryCode = cc;
                                    normalized.countryTotals = raw.countryTotals || (raw.globalAverage ? { totalUsers: raw.totalUsers, ai: raw.total_messages, say: raw.total_chars } : {});
                                    console.log(`[CountrySummary] ğŸ“¦ ${cc} è¶…æ—¶ï¼Œå·²ç”¨å…¨çƒæ±‡æ€»é™çº§`);
                                    return normalized;
                                }
                            }
                        }
                    } catch (fallbackErr) { /* ignore */ }
                }

                // å°è¯•è¿”å›è¿‡æœŸç¼“å­˜
                try {
                    const cached = localStorage.getItem(cacheKey);
                    if (cached) {
                        const { data } = JSON.parse(cached);
                        console.log(`[CountrySummary] ğŸ“¦ ä½¿ç”¨è¿‡æœŸç¼“å­˜: ${cc}`);
                        return data;
                    }
                } catch (e) { }
                
                return null;
            }
        }

        /** å›½å®¶ä»£ç è½¬å›½æ—— Emojiï¼ˆå¦‚ CN -> ğŸ‡¨ğŸ‡³ï¼‰ */
        function countryCodeToFlagEmoji(code) {
            if (!code || typeof code !== 'string') return '';
            const s = code.toUpperCase().trim();
            if (s.length !== 2) return '';
            const a = s.charCodeAt(0), b = s.charCodeAt(1);
            if (a < 65 || a > 90 || b < 65 || b > 90) return '';
            return String.fromCodePoint(0x1F1E6 + a - 65, 0x1F1E6 + b - 65);
        }

        /**
         * è·å–å›½æ—— Emojiï¼ˆgetFlagEmoji ä½œä¸º countryCodeToFlagEmoji çš„åˆ«åï¼‰
         * @param {string} code - å›½å®¶ä»£ç ï¼ˆå¦‚ 'US', 'CN'ï¼‰
         * @returns {string} å›½æ—— Emoji æˆ–ç©ºå­—ç¬¦ä¸²
         */
        /**
         * ä½¿ç”¨ Unicode åç§»é‡é€»è¾‘å°† country_code è½¬æ¢ä¸ºå›½æ—— Emoji
         * @param {string} code - å›½å®¶ä»£ç ï¼ˆå¦‚ "US", "CN"ï¼‰
         * @returns {string} - å›½æ—— Emoji
         */
        function getFlagEmoji(code) {
            if (!code || code === 'UN' || code === null || code === '') {
                return 'ğŸ³ï¸'; // é»˜è®¤æ˜¾ç¤ºä¸­ç«‹æ——
            }
            
            // ä½¿ç”¨ Unicode åç§»é‡é€»è¾‘ï¼šString.fromCodePoint(...[...code].map(char => char.charCodeAt(0) + 127397))
            const codeStr = String(code).toUpperCase().trim();
            if (codeStr.length < 2) {
                return 'ğŸ³ï¸';
            }
            
            try {
                // ä½¿ç”¨ map æ–¹æ³•å¤„ç†æ¯ä¸ªå­—ç¬¦
                const codePoints = [...codeStr].map(char => char.charCodeAt(0) + 127397);
                const flagEmoji = String.fromCodePoint(...codePoints);
                return flagEmoji;
            } catch (e) {
                // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œfallback åˆ°ä¸­ç«‹æ——
                console.warn('[getFlagEmoji] è½¬æ¢å¤±è´¥:', code, e);
                return 'ğŸ³ï¸';
            }
        }

        /**
         * æ›´æ–°å·¦ä¾§æŠ½å±‰ä¸­çš„ç”¨æˆ·å›½å®¶/åœ°åŒºå±•ç¤ºï¼šå›½æ—— Emoji + æ–‡æ¡ˆï¼ˆè‡ªåŠ¨è¯†åˆ« / ç”¨æˆ·æ ¡å‡†ï¼‰
         * åˆ©ç”¨ v_unified_analysis_v2 çš„ country_codeï¼Œç”¨ JS è½¬ä¸ºå›½æ—— Emoji
         */
        function updateUserCountryFlag(countryCode, countryName, isManual) {
            const el = document.getElementById('user-country-flag');
            if (!el) return;
            const code = (countryCode || '').toUpperCase();
            const flagEmoji = countryCodeToFlagEmoji(code);
            const desc = isManual ? (currentLang === 'zh' ? 'ç”¨æˆ·æ ¡å‡†' : 'User calibrated') : (currentLang === 'zh' ? 'è‡ªåŠ¨è¯†åˆ«' : 'Auto detected');
            if (flagEmoji) {
                el.innerHTML = `<span class="text-lg" aria-hidden="true">${flagEmoji}</span> <span class="text-[10px] text-zinc-400">${desc}</span>`;
            } else {
                el.innerHTML = `<span class="text-[10px] text-zinc-400">${countryName || code || ''} Â· ${desc}</span>`;
            }
        }

        /**
         * åœ°å›¾è„‰å†²ç‰¹æ•ˆï¼šåœ¨åœ°å›¾ä¸ŠåŠ¨æ€æ·»åŠ æ¶Ÿæ¼ªç‰¹æ•ˆç‚¹ï¼ˆæ”¯æŒåŠ¨æ€é¢œè‰²å’Œå¤´åƒï¼‰
         * å½“ label ä¸º 'YOU' æ—¶ï¼Œæ”¹ä¸ºæ›´æ–°æŒä¹…ã€ŒCurrent Locationã€å…‰æ ‡ï¼Œä¸è‡ªåŠ¨ç§»é™¤
         */
        function triggerMapPulse(lng, lat, label = '', color = '#00ff41', avatarUrl = null, username = null) {
            // å‚æ•°éªŒè¯
            if (typeof lng !== 'number' || typeof lat !== 'number' || isNaN(lng) || isNaN(lat)) {
                console.warn('[MapPulse] âš ï¸ ç»çº¬åº¦æ•°æ®æ ¼å¼æ— æ•ˆï¼Œè·³è¿‡è„‰å†²ç‰¹æ•ˆ');
                return;
            }
            if (!color || typeof color !== 'string') color = '#00ff41';
            
            // åœ°å›¾å®ä¾‹æ£€æŸ¥ - å¦‚æœæœªåˆå§‹åŒ–ï¼Œå»¶è¿Ÿé‡è¯•
            if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                // æœ€å¤šé‡è¯•5æ¬¡ï¼Œæ¯æ¬¡é—´éš”500ms
                if (!window._mapPulseRetryCount) window._mapPulseRetryCount = {};
                const key = `${lng.toFixed(4)},${lat.toFixed(4)}`;
                if (!window._mapPulseRetryCount[key]) window._mapPulseRetryCount[key] = 0;
                
                if (window._mapPulseRetryCount[key] < 5) {
                    window._mapPulseRetryCount[key]++;
                    console.log(`[MapPulse] â³ åœ°å›¾æœªåˆå§‹åŒ–ï¼Œç¬¬${window._mapPulseRetryCount[key]}æ¬¡å»¶è¿Ÿé‡è¯•...`);
                    setTimeout(() => {
                        triggerMapPulse(lng, lat, label, color, avatarUrl, username);
                    }, 500);
                } else {
                    console.warn('[MapPulse] âš ï¸ åœ°å›¾å®ä¾‹å§‹ç»ˆæœªåˆå§‹åŒ–ï¼Œæ”¾å¼ƒè„‰å†²ç‰¹æ•ˆ');
                    delete window._mapPulseRetryCount[key];
                }
                return;
            }
            
            // æ¸…ç†é‡è¯•è®¡æ•°
            const key = `${lng.toFixed(4)},${lat.toFixed(4)}`;
            if (window._mapPulseRetryCount && window._mapPulseRetryCount[key]) {
                delete window._mapPulseRetryCount[key];
            }

            // å½“å‰ç”¨æˆ·ä½ç½®ï¼šä½¿ç”¨æŒä¹…ã€ŒCurrent Locationã€ç³»åˆ—ï¼Œä¸ 5 ç§’ç§»é™¤
            if (label === 'YOU' || label === 'ç”¨æˆ·') {
                // ã€æ–°å¢ã€‘å¦‚æœå…‰æ ‡å·²è¢«é”å®šï¼Œæ£€æŸ¥æ˜¯å¦å…è®¸æ›´æ–°
                if (window.__cursorLocked) {
                    const lockedLat = localStorage.getItem('manual_lat');
                    const lockedLng = localStorage.getItem('manual_lng');
                    if (lockedLat && lockedLng && !isNaN(Number(lockedLat)) && !isNaN(Number(lockedLng))) {
                        const lockedLatNum = Number(lockedLat);
                        const lockedLngNum = Number(lockedLng);
                        // å…è®¸å°çš„æµ®ç‚¹è¯¯å·®ï¼ˆ0.0001 åº¦çº¦ç­‰äº 11 ç±³ï¼‰
                        if (Math.abs(lat - lockedLatNum) > 0.0001 || Math.abs(lng - lockedLngNum) > 0.0001) {
                            console.warn('[MapPulse] ğŸ”’ å…‰æ ‡å·²é”å®šï¼Œæ‹’ç»ä½ç½®æ›´æ–°:', {
                                requested: { lat, lng },
                                locked: { lat: lockedLatNum, lng: lockedLngNum }
                            });
                            return;
                        }
                    }
                }

                setOrUpdateCurrentLocationCursor(lng, lat, color, avatarUrl, username);
                console.log(`[MapPulse] âœ… å½“å‰ç”¨æˆ·å…‰æ ‡å·²æ›´æ–°: [${lng}, ${lat}] (é¢œè‰²: ${color})`);
                return;
            }

            try {
                const currentOption = mapChart.getOption();
                if (!currentOption || !currentOption.series || !Array.isArray(currentOption.series)) return;

                const pulseSeries = {
                    type: 'effectScatter',
                    coordinateSystem: 'geo',
                    data: [{ value: [lng, lat], name: label || 'ç”¨æˆ·', avatarUrl: avatarUrl || null, username: username || null }],
                    symbolSize: 20,
                    showEffectOn: 'render',
                    rippleEffect: { brushType: 'stroke', scale: 5, period: 4, color: color },
                    itemStyle: { color: color, shadowBlur: 20, shadowColor: color },
                    label: { show: !!label, formatter: label || '', position: 'top', color: color, fontSize: 10, fontFamily: 'JetBrains Mono' },
                    avatarUrl: avatarUrl || null,
                    username: username || null,
                    zlevel: 10,
                    z: 10
                };
                const updatedSeries = [...currentOption.series, pulseSeries];
                mapChart.setOption({ series: updatedSeries }, { notMerge: false, lazyUpdate: false });
                console.log(`[MapPulse] âœ… è„‰å†²ç‰¹æ•ˆå·²æ·»åŠ : [${lng}, ${lat}] ${label || ''} (é¢œè‰²: ${color})`);

                setTimeout(() => {
                    try {
                        if (!mapChart || (typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) return;
                        const currentOpt = mapChart.getOption();
                        if (!currentOpt || !currentOpt.series || !Array.isArray(currentOpt.series)) return;
                        const filteredSeries = currentOpt.series.filter((s) => {
                            if (s.type === 'effectScatter' && s.name !== 'Current Location' && s.data && s.data.length > 0) {
                                const point = s.data[0];
                                if (point && Array.isArray(point.value) && point.value.length >= 2) {
                                    if (Math.abs(point.value[0] - lng) < 0.0001 && Math.abs(point.value[1] - lat) < 0.0001) return false;
                                }
                            }
                            return true;
                        });
                        mapChart.setOption({ series: filteredSeries }, { notMerge: false, lazyUpdate: false });
                    } catch (err) { console.warn('[MapPulse] âš ï¸ ç§»é™¤è„‰å†²ç‰¹æ•ˆæ—¶å‡ºé”™:', err); }
                }, 5000);
            } catch (error) {
                console.error('[MapPulse] âŒ æ·»åŠ è„‰å†²ç‰¹æ•ˆå¤±è´¥:', error);
            }
        }

        /**
         * æ¸²æŸ“é›·è¾¾å›¾åˆ°æŒ‡å®šçš„ canvas
         * @param {HTMLCanvasElement} canvas - Canvas å…ƒç´ 
         * @param {Object} averages - å¹³å‡å€¼æ•°æ®
         */
        function renderRadarChartToCanvas(canvas, averages) {
            if (!canvas) {
                console.warn('[é›·è¾¾å›¾] âŒ Canvas å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.warn('[é›·è¾¾å›¾] âŒ æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡');
                return;
            }
            // ä¿®å¤é¢„è§ˆï¼šåˆ›å»ºæ–° Chart å‰å¿…é¡»è°ƒç”¨ window.myRadarChart.destroy()
            if (window.myRadarChart) {
                try { window.myRadarChart.destroy(); } catch (e) { /* å¿½ç•¥ */ }
                window.myRadarChart = null;
            }
            
            const labels = currentLang === 'zh' ? ['è¯­è¨€', 'æ¨¡å¼', 'æ·±åº¦', 'æ•ˆç‡', 'é¢‘ç‡'] : ['Lang', 'Pattern', 'Depth', 'Effi', 'Freq'];
            const targetData = [
                averages.L !== undefined && averages.L !== null ? Number(averages.L) : 0,
                averages.P !== undefined && averages.P !== null ? Number(averages.P) : 0,
                averages.D !== undefined && averages.D !== null ? Number(averages.D) : 0,
                averages.E !== undefined && averages.E !== null ? Number(averages.E) : 0,
                averages.F !== undefined && averages.F !== null ? Number(averages.F) : 0
            ];
            const zeroData = [0, 0, 0, 0, 0];

            window.myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: zeroData,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        borderWidth: 1,
                        pointRadius: 2
                    }]
                },
                options: {
                    animation: {
                        duration: 900,
                        easing: 'easeOutQuart',
                        animateScale: true,
                        animateRotate: true
                    },
                    scales: {
                        r: {
                            angleLines: { color: '#27272a' },
                            grid: { color: '#27272a' },
                            pointLabels: { color: '#71717a', font: { size: 9 } },
                            ticks: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // è§¦å‘ä¸€æ¬¡ updateï¼Œè®©é›·è¾¾å›¾ä»ä¸­å¿ƒæ‰©å¼ åˆ°çœŸå®å€¼
            try {
                window.myRadarChart.data.datasets[0].data = targetData;
                window.myRadarChart.update();
            } catch (e) {
                console.warn('[é›·è¾¾å›¾] âš ï¸ update åŠ¨ç”»è§¦å‘å¤±è´¥:', e);
            }
            
            return window.myRadarChart;
        }

        function renderRadarChart(averages) {
            // ã€ID å­˜åœ¨æ€§æ£€æŸ¥ã€‘åœ¨æ‰§è¡Œå‰ï¼Œå¿…é¡»æ£€æŸ¥ document.getElementById æ˜¯å¦éç©º
            const radarCanvas = document.getElementById('radarChart');
            if (!radarCanvas) {
                console.warn('[é›·è¾¾å›¾] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            const ctx = radarCanvas.getContext('2d');
            if (!ctx) {
                console.warn('[é›·è¾¾å›¾] âŒ æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡');
                return;
            }
            
            if (radarChart) radarChart.destroy();

            const labels = currentLang === 'zh' ? ['è¯­è¨€', 'æ¨¡å¼', 'æ·±åº¦', 'æ•ˆç‡', 'é¢‘ç‡'] : ['Lang', 'Pattern', 'Depth', 'Effi', 'Freq'];
            // ã€é›·è¾¾å›¾æ•°æ®æ ¼å¼ã€‘æ›´æ–° globalRadarChart æ—¶ï¼Œä¼ å…¥ [stats.L, stats.P, stats.D, stats.E, stats.F]
            // å½»åº•åˆ é™¤ç¡¬ç¼–ç ï¼Œå¦‚æœæ¥å£æœ‰å€¼åˆ™å¿…é¡»æ˜¾ç¤ºæ¥å£çš„å€¼
            const targetData = [
                averages.L !== undefined && averages.L !== null ? Number(averages.L) : 0,
                averages.P !== undefined && averages.P !== null ? Number(averages.P) : 0,
                averages.D !== undefined && averages.D !== null ? Number(averages.D) : 0,
                averages.E !== undefined && averages.E !== null ? Number(averages.E) : 0,
                averages.F !== undefined && averages.F !== null ? Number(averages.F) : 0
            ];
            const zeroData = [0, 0, 0, 0, 0];

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: zeroData,
                        borderColor: '#00ff41',
                        backgroundColor: 'rgba(0, 255, 65, 0.1)',
                        borderWidth: 1,
                        pointRadius: 2
                    }]
                },
                options: {
                    animation: {
                        duration: 900,
                        easing: 'easeOutQuart',
                        animateScale: true,
                        animateRotate: true
                    },
                    scales: {
                        r: {
                            angleLines: { color: '#27272a' },
                            grid: { color: '#27272a' },
                            pointLabels: { color: '#71717a', font: { size: 9 } },
                            ticks: { display: false },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // è§¦å‘ä¸€æ¬¡ updateï¼Œè®©é›·è¾¾å›¾ä»ä¸­å¿ƒæ‰©å¼ åˆ°çœŸå®å€¼
            try {
                radarChart.data.datasets[0].data = targetData;
                radarChart.update();
            } catch (e) {
                console.warn('[é›·è¾¾å›¾] âš ï¸ update åŠ¨ç”»è§¦å‘å¤±è´¥:', e);
            }
        }

        function renderLocationList(data) {
            const list = document.getElementById('locationList');
            if (!data || data.length === 0) return;
            
            list.innerHTML = data.slice(0, 5).map((item, i) => {
                const name = countryNameMap[item.name] ? countryNameMap[item.name][currentLang] : item.name;
                return `
                <div class="flex justify-between items-center text-[11px] border-b border-zinc-800 pb-2">
                    <span class="text-zinc-500 font-mono">0${i+1}</span>
                    <span class="font-bold uppercase tracking-tighter">${name}</span>
                    <span class="text-[var(--accent-terminal)] font-bold">${item.value}</span>
                </div>`;
            }).join('');

            // ä¿®å¤ï¼štop-country å…ƒç´ å·²ç§»é™¤ï¼Œæ·»åŠ  null æ£€æŸ¥
            const topCountryEl = document.getElementById('top-country');
            if (topCountryEl && data.length > 0) {
                const top = data[0];
                topCountryEl.innerText = countryNameMap[top.name] ? countryNameMap[top.name][currentLang] : top.name;
            }
        }

        /**
         * åˆ¤æ–­ç”¨æˆ·åæ˜¯å¦ä¸ºæœ‰æ•ˆGitHubç”¨æˆ·å
         * @param {string} username - ç”¨æˆ·å
         * @returns {boolean} æ˜¯å¦ä¸ºæœ‰æ•ˆç”¨æˆ·å
         */
        function isValidGitHubUsername(username, userIdentity = null) {
            if (!username || typeof username !== 'string') {
                return false;
            }
            const trimmed = username.trim();
            if (trimmed === '') {
                return false;
            }
            
            // ã€Task 3ã€‘ä¼˜åŒ–ç”¨æˆ·ååˆæ³•æ€§æ ¡éªŒï¼šå¦‚æœæ˜¯ fingerprint ç”¨æˆ·ï¼ˆåŒ¿åç”¨æˆ·ï¼‰ï¼Œè·³è¿‡ä¸¥æ ¼çš„ GitHub æ ¼å¼æ ¡éªŒ
            if (userIdentity === 'fingerprint' || userIdentity === 'anonymous') {
                // å¯¹äºåŒ¿åç”¨æˆ·ï¼ŒåªåšåŸºæœ¬æ£€æŸ¥ï¼Œå…è®¸ä¸­æ–‡ç­‰ç‰¹æ®Šå­—ç¬¦
                console.log('[GitHub] â„¹ï¸ æ£€æµ‹åˆ° fingerprint ç”¨æˆ·ï¼Œè·³è¿‡ä¸¥æ ¼æ ¼å¼æ ¡éªŒ:', trimmed);
                // åªæ£€æŸ¥æ˜¯å¦ä¸ºæ— æ•ˆçš„é»˜è®¤å€¼
                if (INVALID_USERNAME_VALUES.includes(trimmed)) {
                    return false;
                }
                // å…è®¸åŒ…å«ä¸­æ–‡å’Œå…¶ä»–å­—ç¬¦
                return trimmed.length > 0;
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ— æ•ˆçš„é»˜è®¤å€¼
            if (INVALID_USERNAME_VALUES.includes(trimmed)) {
                return false;
            }
            // æ£€æŸ¥æ˜¯å¦ä»¥ 'Guest_' å¼€å¤´ï¼ˆè‡ªåŠ¨ç”Ÿæˆçš„è®¿å®¢ç”¨æˆ·åï¼‰
            if (trimmed.startsWith('Guest_')) {
                return false;
            }
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼ˆGitHub ç”¨æˆ·åä¸æ”¯æŒä¸­æ–‡ï¼Œä¸å¼¹è­¦å‘Šï¼Œç”± sanitizeGitHubIdForApi åš API æ¸…æ´—ï¼‰
            if (/[\u4e00-\u9fa5]/.test(trimmed)) {
                return false;
            }
            // GitHubç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦å’Œä¸‹åˆ’çº¿
            // å¿…é¡»ä»¥å­—æ¯æˆ–æ•°å­—å¼€å¤´ï¼Œé•¿åº¦åœ¨1-39ä¹‹é—´
            const githubUsernamePattern = /^[a-zA-Z0-9]([a-zA-Z0-9]|-(?![.-])){0,38}$/;
            if (!githubUsernamePattern.test(trimmed)) {
                console.warn('[GitHub] âš ï¸ GitHubç”¨æˆ·åæ ¼å¼æ— æ•ˆ:', trimmed);
                return false;
            }
            return true;
        }

        /**
         * å°†æ˜¾ç¤ºåæ¸…æ´—ä¸ºå¯è¯·æ±‚ GitHub API çš„ IDï¼šè‹¥å«ä¸­æ–‡æˆ–éæ³•å­—ç¬¦ï¼Œåˆ™è½¬ä¸º Anonymous- + æŒ‡çº¹å‰ 4 ä½ï¼ˆæ— æŒ‡çº¹æ—¶ç”¨åç§°å“ˆå¸Œå‰ 4 ä½ï¼‰ã€‚
         * ä»…ç”¨äºè¯·æ±‚ GitHub ä»£ç†ç­‰ APIï¼Œç•Œé¢ Display Name ä»ä¿ç•™åŸæ–‡ã€‚
         */
        function sanitizeGitHubIdForApi(displayId, fingerprint) {
            if (!displayId || typeof displayId !== 'string') return 'Anonymous-0000';
            var trimmed = displayId.trim();
            if (trimmed === '') return 'Anonymous-0000';
            if (typeof isValidGitHubUsername === 'function' && isValidGitHubUsername(trimmed)) return trimmed;
            var fp = (fingerprint && typeof fingerprint === 'string') ? fingerprint.trim() : '';
            if (fp.length >= 4) return 'Anonymous-' + fp.substring(0, 4);
            var hash = 0;
            for (var i = 0; i < trimmed.length; i++) { hash = ((hash << 5) - hash) + trimmed.charCodeAt(i); hash |= 0; }
            var hex = (hash < 0 ? 0x100000000 + hash : hash).toString(16);
            return 'Anonymous-' + (hex.substring(0, 4) || '0000');
        }

        /**
         * è·å–GitHubå¤´åƒURL
         * @param {string} username - GitHubç”¨æˆ·å
         * @returns {string|null} å¤´åƒURLï¼Œå¦‚æœç”¨æˆ·åæ— æ•ˆåˆ™è¿”å›null
         */
        function getGitHubAvatarUrl(username) {
            // å¦‚æœç”¨æˆ·åæ— æ•ˆï¼Œè¿”å›nullï¼ˆä¸è¯·æ±‚GitHubå›¾ç‰‡ï¼‰
            if (!isValidGitHubUsername(username)) {
                return null;
            }
            // GitHubå¤´åƒURLæ ¼å¼: https://github.com/[ç”¨æˆ·å].png
            return `https://github.com/${username.trim()}.png`;
        }

        /**
         * åˆ›å»ºå¤´åƒHTMLï¼ŒåŒ…å«onerrorå…œåº•é€»è¾‘
         * @param {string} avatarUrl - å¤´åƒURL
         * @param {string} username - GitHubç”¨æˆ·åï¼ˆç”¨äºidenticonï¼‰
         * @param {number} size - å¤´åƒå°ºå¯¸ï¼ˆåƒç´ ï¼‰
         * @returns {string} å¤´åƒHTMLå­—ç¬¦ä¸²
         */
        function createAvatarHtml(avatarUrl, username, size = 32, userIdentity = null) {
            var dataUserId = String(username || userIdentity || '').trim() || 'unknown';
            var wrap = function(img) {
                return '<div class="user-avatar-trigger cursor-pointer inline-block" data-user-id="' + escapeHtml(dataUserId) + '">' + img + '</div>';
            };
            // ã€ä¿®å¤ã€‘å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒURLï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤å¤´åƒ
            // å¦‚æœ username ä¸º null æˆ–æ— æ•ˆï¼Œä¹Ÿä½¿ç”¨é»˜è®¤å¤´åƒï¼ˆä¸è¿›è¡Œä¸¥æ ¼æ ¡éªŒï¼‰
            if (!avatarUrl) {
                return wrap('<img src="' + DEFAULT_AVATAR + '" alt="avatar" class="rounded-full" width="' + size + '" height="' + size + '" loading="lazy" style="object-fit: cover;" onerror="this.onerror=null; this.src=\'' + DEFAULT_AVATAR + '\';" />');
            }
            // åªæœ‰å½“ username å­˜åœ¨ä¸”éœ€è¦æ ¡éªŒæ—¶æ‰è¿›è¡Œæ ¡éªŒ
            if (username && !isValidGitHubUsername(username, userIdentity)) {
                return wrap('<img src="' + DEFAULT_AVATAR + '" alt="avatar" class="rounded-full" width="' + size + '" height="' + size + '" loading="lazy" style="object-fit: cover;" onerror="this.onerror=null; this.src=\'' + DEFAULT_AVATAR + '\';" />');
            }
            // æœ‰æ•ˆå¤´åƒURLï¼ŒreferrerPolicy="no-referrer" é¿å… Cloudflare æ‹¦æˆª
            return wrap('<img src="' + avatarUrl + '" alt="avatar" class="rounded-full" width="' + size + '" height="' + size + '" loading="lazy" style="object-fit: cover;" referrerpolicy="no-referrer" onerror="this.onerror=null; this.src=\'' + DEFAULT_AVATAR + '\';" />');
        }

        function renderRecentActivity(victims) {
            const box = document.getElementById('recentActivity');
            if (!box) return;
            
            // ä¼˜å…ˆä½¿ç”¨ latestRecordsï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ recentVictims
            const records = victims || [];
            
            if (records.length === 0) {
                box.innerHTML = `<div class="text-zinc-500 text-center py-4">${escapeHtml(getI18nText('common.no_data') || (currentLang === 'en' ? 'No data' : 'æš‚æ— æ•°æ®'))}</div>`;
                return;
            }
            
            box.innerHTML = records.map((v, index) => {
                // å…¼å®¹ä¸¤ç§æ•°æ®æ ¼å¼ï¼šlatestRecords å’Œ recentVictims
                const time = v.time || v.created_at || new Date().toISOString();
                const type = v.type || v.personality_type || 'UNKNOWN';
                const location = v.location || v.ip_location || (currentLang === 'en' ? 'Unknown' : 'æœªçŸ¥');
                const name = v.name || (currentLang === 'en' ? `Record ${index + 1}` : `è®°å½•${index + 1}`);
                
                // è·å–å¤´åƒä¿¡æ¯ï¼ˆCloudflareï¼šæ—  github_username æ—¶ç”¨ user_name ä½œä¸º GitHub ç™»å½•åå›é€€ï¼‰
                const avatarUrl = v.avatar_url || null;
                const githubUsername = v.github_username || v.user_name || null;
                
                // åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœ github_username ä¸ºç©ºã€æˆ–è€…æ˜¯é»˜è®¤å€¼ï¼Œåˆ™ä¸è¦è¯·æ±‚ GitHub å›¾ç‰‡
                // ã€Task 3ã€‘ä¼ å…¥ user_identityï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                const recordUserIdentity = v.user_identity || null;
                let finalAvatarUrl = avatarUrl;
                if (!finalAvatarUrl && githubUsername) {
                    if (isValidGitHubUsername(githubUsername, recordUserIdentity)) {
                        // åªæœ‰æœ‰æ•ˆçš„GitHubç”¨æˆ·åæ‰ç”Ÿæˆå¤´åƒURL
                        finalAvatarUrl = getGitHubAvatarUrl(githubUsername);
                    } else {
                        // æ— æ•ˆç”¨æˆ·åæ—¶ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                        finalAvatarUrl = DEFAULT_AVATAR;
                    }
                }
                // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒURLï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                if (!finalAvatarUrl) {
                    finalAvatarUrl = DEFAULT_AVATAR;
                }
                
                // ã€ä¿®å¤ã€‘finalUsername åº”è¯¥ä½¿ç”¨ githubUsernameï¼ˆå¦‚æœæœ‰æ•ˆï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ name
                // ä½†ä¼ ç»™ createAvatarHtml æ—¶ï¼Œåº”è¯¥åªä¼ æœ‰æ•ˆçš„ GitHub ç”¨æˆ·åæˆ– null
                // å› ä¸º createAvatarHtml ä¼šæ ¡éªŒç”¨æˆ·åï¼Œè€Œ name å¯èƒ½æ˜¯"è®°å½•1"è¿™æ ·çš„å€¼
                const finalUsername = githubUsername || name;
                const usernameForAvatar = githubUsername && isValidGitHubUsername(githubUsername, recordUserIdentity) 
                    ? githubUsername 
                    : null;
                
                // ç”Ÿæˆå¤´åƒHTMLï¼ˆåªä¼ æœ‰æ•ˆçš„ GitHub ç”¨æˆ·åï¼Œé¿å…æ ¡éªŒè­¦å‘Šï¼‰
                // ã€ä¿®å¤ã€‘ä¼ å…¥ user_identity å‚æ•°ï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                const avatarHtml = createAvatarHtml(finalAvatarUrl, usernameForAvatar, 32, recordUserIdentity);
                
                return `
                <div class="border-l-2 border-zinc-800 pl-3 py-1 flex items-start gap-2">
                    <div class="flex-shrink-0 mt-0.5">
                        ${avatarHtml}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-zinc-500">${new Date(time).toLocaleTimeString(currentLang === 'en' ? 'en-US' : 'zh-CN')}</div>
                        <div class="text-white">${name.length > 6 ? name.slice(0,6) + '...' : name}</div>
                        <div class="text-[var(--accent-terminal)]">${type} @ ${location}</div>
                    </div>
                </div>
            `;
            }).join('');
        }


        /**
         * æ›´æ–°ä¸“å®¶å¡ç‰‡ UI
         * @param {string} dim - ç»´åº¦æ ‡è¯† (L, P, D, E, F)
         * @param {Object|null} expert - ä¸“å®¶æ•°æ®å¯¹è±¡
         * @param {boolean} isNoDataArea - æ˜¯å¦ä¸ºæ— äººåŒºçŠ¶æ€ï¼ˆtrue æ—¶æ˜¾ç¤º"å¾…æ‹›å‹Ÿ"ï¼‰
         */
        function updateExpertCard(dim, expert, isNoDataArea = false) {
            // é˜²å¾¡æ€§ç¼–ç¨‹ï¼šæ‰€æœ‰ DOM æ“ä½œå‰å…ˆæ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const card = document.getElementById(`card-${dim}`);
            if (!card) {
                console.warn(`[LPDEF] âš ï¸ å¡ç‰‡ card-${dim} ä¸å­˜åœ¨`);
                return;
            }
            
            const avatarEl = document.getElementById(`expert-avatar-${dim}`);
            const nameEl = document.getElementById(`expert-name-${dim}`);
            const titleEl = document.getElementById(`expert-title-${dim}`);
            const scoreEl = document.getElementById(`expert-score-${dim}`);
            const labelEl = document.getElementById(`expert-label-${dim}`);
            const descEl = document.getElementById(`expert-desc-${dim}`);

            if (expert) {
                // æ›´æ–°å¤´åƒ
                if (avatarEl) {
                    let avatarUrl = DEFAULT_AVATAR;
                    
                    // ä¼˜å…ˆçº§ 1: å¦‚æœæœ‰ GitHub IDï¼Œä½¿ç”¨ GitHub å¤´åƒ
                    // ã€Task 3ã€‘ä¼ å…¥ user_identityï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                    const expertUserIdentity = expert.user?.user_identity || null;
                    if (expert.githubUsername && isValidGitHubUsername(expert.githubUsername, expertUserIdentity)) {
                        avatarUrl = getGitHubAvatarUrl(expert.githubUsername);
                    } else if (expert.user?.github_username && isValidGitHubUsername(expert.user.github_username, expertUserIdentity)) {
                        // é™çº§ï¼šä» user å¯¹è±¡ä¸­è·å–
                        avatarUrl = getGitHubAvatarUrl(expert.user.github_username);
                    }
                    // ä¼˜å…ˆçº§ 2: å¦‚æœæœ‰ fingerprintï¼Œä½¿ç”¨åŸºäºæŒ‡çº¹çš„å”¯ä¸€å¤´åƒ
                    else if (expert.fingerprint) {
                        avatarUrl = `https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(expert.fingerprint)}`;
                    }
                    // å¦åˆ™ä½¿ç”¨é»˜è®¤å¤´åƒ
                    
                    avatarEl.innerHTML = `<img 
                        src="${avatarUrl}" 
                        alt="${expert.username || 'Expert'}"
                        class="w-full h-full object-cover rounded-full"
                        onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                    />`;
                }

                // æ›´æ–°ç”¨æˆ·å
                if (nameEl) {
                    nameEl.textContent = expert.username || 'Unknown';
                }

                // æ›´æ–°ç§°å·ï¼ˆå·¦ä¸Šè§’ï¼‰- ä½¿ç”¨ç»´åº¦ä¸“å±ç§°å·ï¼ˆä¸­è‹±åˆ‡æ¢ï¼‰
                if (labelEl) {
                    labelEl.textContent = getLpdefTitle(dim) || labelEl.textContent || '';
                }
                
                // æ›´æ–°è¯´æ˜ï¼ˆåˆ†æ•°ä¸‹æ–¹ï¼‰- ä½¿ç”¨ç»´åº¦ä¸“å±è¯´æ˜ï¼ˆä¸­è‹±åˆ‡æ¢ï¼‰
                if (descEl) {
                    descEl.textContent = getLpdefDescription(dim) || descEl.textContent || '';
                }
                
                // æ›´æ–° personality_typeï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼Œä½†ä¸åœ¨ä¸»è¦ä½ç½®æ˜¾ç¤ºï¼‰
                if (titleEl) {
                    titleEl.textContent = expert.personalityType || 'UNKNOWN';
                }

                // æ›´æ–°åˆ†æ•°ï¼ˆä½¿ç”¨æå–åˆ°çš„ scoreï¼‰
                if (scoreEl) {
                    scoreEl.textContent = Math.round(expert.score || 0);
                }
                
                // æ¢å¤ç‚¹å‡»äº‹ä»¶ï¼ˆå¦‚æœæœ‰ä¸“å®¶æ•°æ®ï¼‰
                if (card) {
                    card.onclick = () => openExpertGitHub(dim);
                    card.style.cursor = 'pointer';
                }
            } else {
                // æ— æ•°æ®æ—¶çš„æ˜¾ç¤ºï¼ˆåŒ…æ‹¬æ— äººåŒºçŠ¶æ€ï¼‰
                // ä¿æŒç§°å·å’Œè¯´æ˜ï¼ˆç»´åº¦ä¸“å±ï¼Œä¸­è‹±åˆ‡æ¢ï¼‰
                if (labelEl) {
                    labelEl.textContent = getLpdefTitle(dim) || labelEl.textContent || '';
                }
                
                if (descEl) {
                    descEl.textContent = getLpdefDescription(dim) || descEl.textContent || '';
                }
                
                if (avatarEl) {
                    // æ— äººåŒºçŠ¶æ€ï¼šä½¿ç”¨é»˜è®¤å¤´åƒ
                    avatarEl.innerHTML = `<img 
                        src="${DEFAULT_AVATAR}" 
                        alt="å¾…æ‹›å‹Ÿ"
                        class="w-full h-full object-cover rounded-full opacity-50"
                    />`;
                }
                
                if (nameEl) {
                    nameEl.textContent = isNoDataArea
                        ? (getI18nText('common.recruiting') || 'Recruiting')
                        : (getI18nText('common.no_data') || 'No data');
                }
                
                if (titleEl) {
                    titleEl.textContent = isNoDataArea
                        ? (getI18nText('common.waiting') || 'Waiting')
                        : '...';
                }
                
                if (scoreEl) {
                    scoreEl.textContent = '0';
                }
                
                // æ— äººåŒºçŠ¶æ€ï¼šå–æ¶ˆç‚¹å‡»è·³è½¬äº‹ä»¶
                if (card) {
                    card.onclick = null;
                    card.style.cursor = 'default';
                }
            }
        }

        /**
         * æ‰“å¼€ä¸“å®¶çš„ GitHub ä¸»é¡µ
         * @param {string} dim - ç»´åº¦æ ‡è¯† (L, P, D, E, F)
         */
        function openExpertGitHub(dim) {
            const expert = lpdefExperts[dim];
            if (expert && expert.githubUsername && isValidGitHubUsername(expert.githubUsername)) {
                window.open(`https://github.com/${expert.githubUsername}`, '_blank');
            } else if (expert && expert.user && expert.user.github_username && isValidGitHubUsername(expert.user.github_username)) {
                window.open(`https://github.com/${expert.user.github_username}`, '_blank');
            } else {
                console.warn(`[LPDEF] âš ï¸ ç»´åº¦ ${dim} çš„ä¸“å®¶æ²¡æœ‰æœ‰æ•ˆçš„ GitHub ç”¨æˆ·å`);
            }
        }

        /** 16 å‹äººæ ¼ç¼©å†™ â†’ ä¸­æ–‡/è‹±æ–‡çŸ­åï¼ˆä»…ä½œç§°å·ç¼ºå¤±æ—¶çš„å›é€€ï¼‰ */
        const PERSONALITY_TYPE_NAMES = {
            zh: { INTJ: 'å»ºç­‘å¸ˆ', INTP: 'é€»è¾‘å­¦å®¶', ENTJ: 'æŒ‡æŒ¥å®˜', ENTP: 'è¾©è®ºå®¶', INFJ: 'æå€¡è€…', INFP: 'è°ƒåœè€…', ENFJ: 'ä¸»äººå…¬', ENFP: 'ç«é€‰è€…', ISTJ: 'ç‰©æµå¸ˆ', ISFJ: 'å®ˆå«è€…', ESTJ: 'æ€»ç»ç†', ESFJ: 'æ‰§æ”¿å®˜', ISTP: 'é‰´èµå®¶', ISFP: 'æ¢é™©å®¶', ESTP: 'ä¼ä¸šå®¶', ESFP: 'è¡¨æ¼”è€…' },
            en: { INTJ: 'Architect', INTP: 'Logician', ENTJ: 'Commander', ENTP: 'Debater', INFJ: 'Advocate', INFP: 'Mediator', ENFJ: 'Protagonist', ENFP: 'Campaigner', ISTJ: 'Logistician', ISFJ: 'Defender', ESTJ: 'Executive', ESFJ: 'Consul', ISTP: 'Virtuoso', ISFP: 'Adventurer', ESTP: 'Entrepreneur', ESFP: 'Entertainer' }
        };
        function getPersonalityTypeName(type, lang) {
            const key = String(type || '').toUpperCase();
            const L = (lang === 'en' ? 'en' : 'zh');
            return (PERSONALITY_TYPE_NAMES[L] && PERSONALITY_TYPE_NAMES[L][key]) ? PERSONALITY_TYPE_NAMES[L][key] : key;
        }
        /** äººæ ¼åˆ†å¸ƒå›¾æ˜¾ç¤ºåç§°ï¼šä¼˜å…ˆæ¥å£/ç§°å·è¡¨çš„ä¸­è‹±æ–‡ç§°å·ï¼Œé¿å… LPDEF å­—æ¯ */
        function getPersonalityTitle(item, lang) {
            const L = (lang === 'en' ? 'en' : 'zh');
            const nameZh = item.name_zh || item.personality_name_zh || item.title_zh || item.name || item.personality_name || item.title;
            const nameEn = item.name_en || item.personality_name_en || item.title_en || item.name || item.personality_name || item.title;
            const direct = L === 'en' ? (nameEn || nameZh) : (nameZh || nameEn);
            if (typeof direct === 'string' && direct.trim()) return direct.trim();
            const idx = String(item.vibe_index_str || item.vibe_index || item.vibeIndexStr || item.vibeIndex || '').trim();
            if (idx.length === 5) {
                const cfg = window.__LANG_CONFIG || {};
                const names = L === 'en' ? (cfg.personalityNamesEn || {}) : (cfg.personalityNamesZh || {});
                const hit = names[idx];
                if (typeof hit === 'string' && hit.trim()) return hit.trim();
            }
            return getPersonalityTypeName(item.type || item.personality_type, lang);
        }

        /**
         * æ¸²æŸ“äººæ ¼åˆ†å¸ƒï¼šç«–å‘æŸ±çŠ¶å›¾ï¼Œæ¯äººæ ¼å¸¦ç¼©å†™ + æ–‡å­—åç§° + ç™¾åˆ†æ¯”
         * @param {Array} distribution - äººæ ¼åˆ†å¸ƒæ•°æ® [{type: string, count: number}]
         */
        function renderPersonalityDistribution(distribution) {
            const list = document.getElementById('personalityDistribution');
            if (!list) return;
            
            if (!distribution || !Array.isArray(distribution) || distribution.length === 0) {
                list.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            const total = distribution.reduce((sum, item) => sum + (Number(item.count) || 0), 0);
            const maxPct = total > 0 ? Math.max(...distribution.map((item) => (Number(item.count) || 0) / total * 100)) : 0;
            
            list.className = 'personality-vbar-chart';
            list.innerHTML = distribution.map((item) => {
                const count = Number(item.count) || 0;
                const pctVal = total > 0 ? (count / total) * 100 : 0;
                const pct = pctVal.toFixed(1);
                const heightPct = maxPct > 0 ? Math.max(4, (pctVal / maxPct) * 100) : 0;
                const title = getPersonalityTitle(item, currentLang);
                return `
                <div class="personality-vbar-col">
                    <div class="personality-vbar-bar-wrap">
                        <div class="personality-vbar-fill" style="height: ${heightPct}%;"></div>
                    </div>
                    <span class="personality-vbar-name" title="${escapeHtml(title)}">${escapeHtml(title)}</span>
                    <span class="personality-vbar-pct">${pct}%</span>
                </div>`;
            }).join('');
        }

        /**
         * ã€é€‚é…å±‚é‡å†™ã€‘å¼ºåˆ¶æ˜ å°„å±‚ï¼šä»å¤šä¸ªå¯èƒ½çš„å­—æ®µè·¯å¾„æå–æ•°æ®
         * @param {Object} result - API è¿”å›çš„åŸå§‹æ•°æ®
         * @returns {Object} æ ‡å‡†åŒ–åçš„æ•°æ®å¯¹è±¡
         */
        function normalizeData(result) {
            // å…¼å®¹ï¼šæŸäº›æ¥å£æŠŠçœŸå®æ•°æ®åŒ…åœ¨ {success, data/result/...} ä¸­
            const unwrap = (v) => {
                if (!v || typeof v !== 'object') return v;
                // ä»…åœ¨å‡ºç° success æ ‡è®°æ—¶å°è¯•è§£åŒ…ï¼Œé¿å…è¯¯æŠŠæ™®é€š data å­—æ®µå½“æˆåŒ…è£¹å±‚
                if ('success' in v) {
                    return v.data ?? v.result ?? v.summary ?? v.payload ?? v;
                }
                return v;
            };
            const data = unwrap(result) || {};
            
            // ã€æ ¸å¿ƒæŒ‡æ ‡æå–ã€‘ä» json.totalAnalysis æå–æ€»æ‰«ææ•°ï¼Œä» json.totalUsers æå–æ€»äººæ•°
            let totalAnalysis =
                data.totalAnalysis ??
                data.total_analysis ??
                data.data?.totalAnalysis ??
                data.data?.total_analysis ??
                undefined;
            if (totalAnalysis === undefined || totalAnalysis === null) {
                const recentVictims = data.recentVictims || data.latestRecords || data.latest_records || [];
                if (Array.isArray(recentVictims)) totalAnalysis = recentVictims.length;
            }
            const totalAnalysisNum = Number(totalAnalysis);
            totalAnalysis = Number.isFinite(totalAnalysisNum) ? totalAnalysisNum : undefined;
            
            // ã€æ€»äººæ•°æå–ã€‘ä» json.totalUsers æå–
            const totalUsersRaw =
                data.totalUsers ??
                data.total_users ??
                data.data?.totalUsers ??
                data.data?.total_users ??
                data.us_stats?.totalUsers ??
                data.us_stats?.total_users ??
                undefined;
            const totalUsersNum = Number(totalUsersRaw);
            const totalUsers = Number.isFinite(totalUsersNum) ? totalUsersNum : undefined;
            
            // ã€ç´¯è®¡åæ§½å­—æ•°ä¿®å¤ã€‘ä¸è¦è¯»å– json.totalRoastWordsï¼ˆå®ƒæ˜¯ 0ï¼‰ï¼Œè¯·å°è¯•ä» json.totalChars æˆ– json.latestRecords[0].total_chars è·å–æ•°æ®
            let totalRoastWords =
                data.totalChars ??
                data.total_chars ??
                data.totalCharsSum ??
                data.total_chars_sum ??
                data.totalCharsTotal ??
                data.total_chars_total ??
                undefined;
            if (totalRoastWords === undefined || totalRoastWords === null || totalRoastWords === 0) {
                // å°è¯•ä» latestRecords ä¸­è·å–
                const latestRecords =
                    data.latestRecords ||
                    data.latest_records ||
                    data.recentVictims ||
                    data.recent_victims ||
                    [];
                if (Array.isArray(latestRecords) && latestRecords.length > 0) {
                    const first = latestRecords[0] || {};
                    if (first.total_chars !== undefined && first.total_chars !== null) {
                        totalRoastWords = first.total_chars;
                    } else if (first.totalChars !== undefined && first.totalChars !== null) {
                        totalRoastWords = first.totalChars;
                    }
                }
            }
            // æœ€åå…œåº•ï¼šå¦‚æœè¿˜æ˜¯ 0 æˆ–æœªå®šä¹‰ï¼Œå°è¯•å…¶ä»–è·¯å¾„
            if (totalRoastWords === undefined || totalRoastWords === null || totalRoastWords === 0) {
                totalRoastWords =
                    data.totalRoastWords ??
                    data.total_roast_words ??
                    data.data?.totalRoastWords ??
                    data.data?.total_roast_words ??
                    undefined;
            }
            
            // ã€ç´¯è®¡åæ§½å­—æ•°ä¿®å¤ã€‘ç»‘å®šåˆ° json.totalChars
            const totalCharsRaw =
                data.totalChars ??
                data.total_chars ??
                data.totalCharsSum ??
                data.total_chars_sum ??
                totalRoastWords;
            const totalCharsNum = Number(totalCharsRaw);
            const totalChars = Number.isFinite(totalCharsNum) ? totalCharsNum : undefined;
            
            // ã€å¼ºåˆ¶æ˜ å°„å±‚ã€‘avgPerUser å’Œ avgPerScanï¼šä¾æ¬¡å°è¯• result.avgPerUser/avgPerScan, result.data.avgPerUser/avgPerScan
            let avgPerUser =
                data.avgPerUser ??
                data.avg_per_user ??
                data.data?.avgPerUser ??
                data.data?.avg_per_user ??
                undefined;
            // å…¼å®¹æ—§å­—æ®µå
            if (avgPerUser === undefined || avgPerUser === null) {
                avgPerUser = data.avgChars ?? data.avg_chars ?? undefined;
            }
            // å¦‚æœ avgPerUser ä¸º 0 æˆ–æ— æ•ˆï¼Œä¸” totalChars å’Œ totalUsers éƒ½å­˜åœ¨ï¼Œåˆ™è®¡ç®—ï¼štotalChars / totalUsers
            const avgPerUserNum = Number(avgPerUser);
            if ((!Number.isFinite(avgPerUserNum) || avgPerUserNum === 0) && totalChars !== undefined && totalUsers !== undefined && totalUsers > 0) {
                avgPerUser = totalChars / totalUsers;
            } else {
                avgPerUser = Number.isFinite(avgPerUserNum) ? avgPerUserNum : undefined;
            }
            
            let avgPerScan =
                data.avgPerScan ??
                data.avg_per_scan ??
                data.data?.avgPerScan ??
                data.data?.avg_per_scan ??
                undefined;
            // å¦‚æœ avgPerScan ä¸º 0 æˆ–æ— æ•ˆï¼Œä¸” totalChars å’Œ totalAnalysis éƒ½å­˜åœ¨ï¼Œåˆ™è®¡ç®—ï¼štotalChars / totalAnalysis
            const avgPerScanNum = Number(avgPerScan);
            if ((!Number.isFinite(avgPerScanNum) || avgPerScanNum === 0) && totalChars !== undefined && totalAnalysis !== undefined && totalAnalysis !== null && totalAnalysis > 0) {
                avgPerScan = totalChars / totalAnalysis;
            } else {
                avgPerScan = Number.isFinite(avgPerScanNum) ? avgPerScanNum : undefined;
            }
            
            // ã€äº”ç»´å¹³å‡åˆ†æå–ã€‘å¿…é¡»ä» json.averages æˆ– json.globalAverage å¯¹è±¡ä¸­æå–ï¼ˆä¾‹å¦‚ï¼šjson.averages.Lï¼‰
            // å½»åº•åˆ é™¤ç¡¬ç¼–ç ï¼Œå¦‚æœæ¥å£æœ‰å€¼åˆ™å¿…é¡»æ˜¾ç¤ºæ¥å£çš„å€¼
            let averages = data.averages || data.globalAverage || data.global_average;
            if (!averages || typeof averages !== 'object') {
                // å…¼å®¹ï¼šæœ‰äº›æ¥å£è¿”å› avg_l/avg_p/... è€Œä¸æ˜¯å¯¹è±¡
                const avgL = data.avg_l ?? data.avgL ?? data.data?.avg_l ?? data.data?.avgL ?? undefined;
                const avgP = data.avg_p ?? data.avgP ?? data.data?.avg_p ?? data.data?.avgP ?? undefined;
                const avgD = data.avg_d ?? data.avgD ?? data.data?.avg_d ?? data.data?.avgD ?? undefined;
                const avgE = data.avg_e ?? data.avgE ?? data.data?.avg_e ?? data.data?.avgE ?? undefined;
                const avgF = data.avg_f ?? data.avgF ?? data.data?.avg_f ?? data.data?.avgF ?? undefined;
                const hasAny = [avgL, avgP, avgD, avgE, avgF].some((v) => v !== undefined && v !== null && v !== '');
                averages = hasAny ? { L: avgL, P: avgP, D: avgD, E: avgE, F: avgF } : {};
            }
            // ç¡®ä¿æ‰€æœ‰ç»´åº¦éƒ½æœ‰å€¼ï¼Œä½†ä¸ä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼
            averages = {
                L: averages.L !== undefined && averages.L !== null ? Number(averages.L) : undefined,
                P: averages.P !== undefined && averages.P !== null ? Number(averages.P) : undefined,
                D: averages.D !== undefined && averages.D !== null ? Number(averages.D) : undefined,
                E: averages.E !== undefined && averages.E !== null ? Number(averages.E) : undefined,
                F: averages.F !== undefined && averages.F !== null ? Number(averages.F) : undefined
            };
            
            // ä¸ºäº†å…¼å®¹æ€§ï¼ŒåŒæ—¶è®¾ç½® globalAverage
            const globalAverage = averages;
            
            // ã€ä¸Šå²—å¤©æ•°ä¿®å¤ã€‘ä» json.systemDays æˆ– json.latestRecords[0].work_days æå–ï¼Œä¸ç¡¬ç¼–ç 
            let systemDays = data.systemDays;
            if (systemDays === undefined || systemDays === null) {
                const latestRecords =
                    data.latestRecords ||
                    data.latest_records ||
                    data.recentVictims ||
                    data.recent_victims ||
                    [];
                if (Array.isArray(latestRecords) && latestRecords.length > 0) {
                    const first = latestRecords[0] || {};
                    if (first.work_days !== undefined && first.work_days !== null) systemDays = first.work_days;
                    else if (first.workDays !== undefined && first.workDays !== null) systemDays = first.workDays;
                }
            }
            
            return {
                ...data, // âš¡ï¸ ä¿ç•™æ‰€æœ‰åŸå§‹å­—æ®µï¼Œé¿å…è¢«è¿‡æ»¤æ‰
                totalUsers: totalUsers !== undefined && totalUsers !== null ? totalUsers : undefined,
                totalAnalysis: totalAnalysis !== undefined && totalAnalysis !== null ? totalAnalysis : undefined,
                totalRoastWords: totalRoastWords !== undefined && totalRoastWords !== null ? totalRoastWords : undefined,
                totalChars: totalChars,
                avgPerUser: avgPerUser !== undefined && avgPerUser !== null ? avgPerUser : undefined,
                avgPerScan: avgPerScan !== undefined && avgPerScan !== null ? avgPerScan : undefined,
                cityCount: data.cityCount !== undefined && data.cityCount !== null ? data.cityCount : undefined,
                systemDays: systemDays !== undefined && systemDays !== null ? systemDays : undefined,
                personalityRank:
                    data.personalityRank ||
                    data.personality_rank ||
                    data.personalityDistribution ||
                    data.personality_distribution ||
                    [],
                personalityDistribution:
                    data.personalityDistribution ||
                    data.personality_distribution ||
                    data.personalityRank ||
                    data.personality_rank ||
                    [],
                globalAverage: globalAverage,
                averages: averages,
                // å…¼å®¹åç«¯ snake_case (location_rank) ä¸ camelCase (locationRank)
                locationRank: data.locationRank || data.location_rank || [],
                recentVictims:
                    data.recentVictims ||
                    data.recent_victims ||
                    data.latestRecords ||
                    data.latest_records ||
                    [],
                latestRecords:
                    data.latestRecords ||
                    data.latest_records ||
                    data.recentVictims ||
                    data.recent_victims ||
                    [],
                // ã€æ–°å¢ã€‘ä¿å­˜å„ç»´åº¦çš„æœ€é«˜è®°å½•ï¼ˆç”¨äº"å…¨çƒæœ€å¼ºæ¨¡å¼"ï¼‰
                topRecords: data.topRecords || {},
            };
        }

        /**
         * ã€åŠ¨ç”»å®¹é”™ã€‘å®‰å…¨çš„åŠ¨ç”»å‡½æ•°ï¼Œé˜²æ­¢ NaN æˆ– undefined å¯¼è‡´å´©æºƒ
         * @param {HTMLElement} element - ç›®æ ‡å…ƒç´ 
         * @param {number} start - èµ·å§‹å€¼
         * @param {number} end - ç»“æŸå€¼
         * @param {number} duration - åŠ¨ç”»æŒç»­æ—¶é—´
         * @param {boolean} useFormat - æ˜¯å¦ä½¿ç”¨æ ¼å¼åŒ–
         */
        function safeAnimateValue(element, start, end, duration = 1500, useFormat = true) {
            if (!element) {
                console.warn('[åŠ¨ç”»] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // ã€åŠ¨ç”»å®¹é”™ã€‘åœ¨è°ƒç”¨ animateValue ä¹‹å‰ï¼Œæ·»åŠ  if (isNaN(value)) value = 0; çš„åˆ¤æ–­
            if (isNaN(start)) start = 0;
            if (isNaN(end)) end = 0;
            
            start = Number(start) || 0;
            end = Number(end) || 0;
            
            animateValue(element, start, end, duration, useFormat);
        }

        /**
         * ã€äººæ ¼æ’è¡Œæ¸²æŸ“å‡½æ•°ã€‘ç‹¬ç«‹çš„ renderPersonalityRank å‡½æ•°ï¼ŒåŒ…å«å‰ç«¯è‡ªè®¡ç®—é™çº§é€»è¾‘
         * @param {Array} rankData - äººæ ¼æ’è¡Œæ•°æ® [{type, count, percentage}]
         * @param {Array} recentVictims - æœ€è¿‘å—å®³è€…æ•°æ®ï¼ˆç”¨äºé™çº§è®¡ç®—ï¼‰
         */
        function renderPersonalityRank(rankData, recentVictims = []) {
            const personalityEl = document.getElementById('personalityDistribution');
            if (!personalityEl) {
                console.warn('[äººæ ¼æ’è¡Œ] âŒ DOM å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            // å¦‚æœåç«¯ personalityRank å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œç›´æ¥æ¸²æŸ“
            if (rankData && Array.isArray(rankData) && rankData.length > 0) {
                personalityEl.innerHTML = rankData.map((item, i) => {
                    const type = item.type || 'æœªçŸ¥';
                    const count = Number(item.count || 0);
                    const percentage = Number(item.percentage || 0);
                    return `
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                <span class="text-zinc-400">${i+1}. ${type}</span>
                                <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                            </div>
                            <div class="w-full bg-zinc-800/50 h-1">
                                <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                console.log(`[äººæ ¼æ’è¡Œ] âœ… æ¸²æŸ“æˆåŠŸ (${rankData.length} æ¡)`);
                return;
            }
            
            // ã€å‰ç«¯è‡ªè®¡ç®—é™çº§é€»è¾‘ã€‘è‹¥åç«¯ personalityRank ä¸ºç©ºï¼Œåˆ™æ ¹æ® recentVictims å®æ—¶è®¡ç®—å æ¯”å¹¶æ¸²æŸ“è¿›åº¦æ¡
            if (recentVictims && recentVictims.length > 0) {
                console.log('[äººæ ¼æ’è¡Œ] âš ï¸ personalityRank ä¸ºç©ºï¼Œä½¿ç”¨ recentVictims é™çº§æ–¹æ¡ˆ');
                const typeMap = new Map();
                recentVictims.forEach((v) => {
                    const type = v.type || v.personality_type || 'UNKNOWN';
                    typeMap.set(type, (typeMap.get(type) || 0) + 1);
                });
                
                const total = recentVictims.length;
                const personalityRank = Array.from(typeMap.entries())
                    .map(([type, count]) => ({
                        type: type,
                        count: Number(count) || 0,
                        percentage: Math.round((Number(count) / total) * 100) || 0,
                    }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                personalityEl.innerHTML = personalityRank.map((item, i) => {
                    const type = item.type || 'æœªçŸ¥';
                    const count = Number(item.count || 0);
                    const percentage = Number(item.percentage || 0);
                    return `
                        <div class="mb-3">
                            <div class="flex justify-between text-[10px] mb-1 uppercase tracking-widest">
                                <span class="text-zinc-400">${i+1}. ${type}</span>
                                <span class="text-[var(--accent-terminal)]">${count} Hits</span>
                            </div>
                            <div class="w-full bg-zinc-800/50 h-1">
                                <div class="bg-[var(--accent-terminal)] h-full shadow-[0_0_8px_rgba(0,255,65,0.4)]" 
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                console.log(`[äººæ ¼æ’è¡Œ] âœ… é™çº§æ–¹æ¡ˆæ¸²æŸ“æˆåŠŸ (${personalityRank.length} æ¡)`);
                return;
            }
            
            // å¦‚æœéƒ½æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            personalityEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
            console.warn('[äººæ ¼æ’è¡Œ] âŒ æ— å¯ç”¨æ•°æ®');
        }

        /**
         * å¯åŠ¨ Supabase Realtime ç›‘å¬
         * ç›‘å¬ user_analysis è¡¨çš„ INSERT äº‹ä»¶
         * ã€Cloudflareã€‘åœ¨ pages.dev / workers.dev ç­‰ç¯å¢ƒä¸‹ WebSocket æ˜“è¶…æ—¶æˆ–å¤±è´¥ï¼Œç›´æ¥è·³è¿‡é¿å…æŠ¥é”™
         */
        async function startRealtimeListener() {
            // Cloudflare éƒ¨ç½²ç¯å¢ƒï¼šä¸å‘èµ· Realtime/Presenceï¼Œé¿å… CHANNEL_ERROR / TIMED_OUTï¼ˆæœ¬åœ°æ­£å¸¸ã€çº¿ä¸Šå¤±è´¥ï¼‰
            // Cloudflare éƒ¨ç½²ç¯å¢ƒï¼šä¸å†è·³è¿‡ Realtime/Presenceï¼Œå°è¯•è¿æ¥
            // const host = typeof window !== 'undefined' && window.location && window.location.hostname ? window.location.hostname : '';
            // const isCloudflareHost = /\.pages\.dev$/.test(host) || /\.workers\.dev$/.test(host) || host === 'pages.dev' || host === 'workers.dev';
            // if (isCloudflareHost) {
            //    console.log('[Realtime] â„¹ï¸ Cloudflare ç¯å¢ƒï¼šä¸å†å¼ºåˆ¶è·³è¿‡ï¼Œå°è¯•è¿æ¥ Supabase Realtime...');
            // }

            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ– (å¢åŠ ç­‰å¾…é‡è¯•æœºåˆ¶, æœ€å¤šç­‰å¾… 15 ç§’)
            if (!supabaseClient) {
                console.log('[Realtime] â³ Supabase å®¢æˆ·ç«¯å°šæœªå°±ç»ªï¼Œç­‰å¾…ä¸­...');
                let attempts = 0;
                while (!supabaseClient && attempts < 30) {
                    await new Promise(r => setTimeout(r, 500));
                    attempts++;
                }
                
                if (!supabaseClient) {
                    console.warn('[Realtime] âš ï¸ Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–è¶…æ—¶ï¼Œè™½ç„¶è·³è¿‡ Realtime ç›‘å¬ï¼Œä½†å°è¯•åç»­æ‡’åŠ è½½...');
                    // ä¸ç›´æ¥ returnï¼Œå…è®¸åç»­é‡è¯•
                }
            }
            
            // æ¯æ¬¡å¯åŠ¨å‰ï¼Œè®°å½•å¯åŠ¨æ—¶é—´
            window.__realtimeStartedAt = Date.now();

            // å¦‚æœå·²æœ‰ç›‘å¬é€šé“ï¼Œå…ˆå–æ¶ˆè®¢é˜…
            if (realtimeChannel) {
                try {
                    await supabaseClient.removeChannel(realtimeChannel);
                    console.log('[Realtime] âœ… å·²å–æ¶ˆæ—§çš„ç›‘å¬é€šé“ (é‡å¯)');
                    realtimeChannel = null;
                } catch (error) {
                    console.warn('[Realtime] âš ï¸ å–æ¶ˆæ—§é€šé“æ—¶å‡ºé”™:', error);
                }
            }

            try {
                // åˆ›å»ºæ–°çš„ç›‘å¬é€šé“
                realtimeChannel = supabaseClient
                    .channel('user_analysis_changes')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'user_analysis'
                        },
                        (payload) => {
                            console.log('[Realtime] ğŸ“¨ æ”¶åˆ°æ–°æ•°æ®:', payload);
                            
                            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ payload å’Œ payload.new å­˜åœ¨
                            if (!payload || !payload.new) {
                                console.warn('[Realtime] âš ï¸ æ•°æ®æ ¼å¼ä¸å®Œæ•´ï¼Œè·³è¿‡å¤„ç†');
                                return;
                            }

                            const newRecord = payload.new;
                            
                            // å±€éƒ¨æ›´æ–°ï¼šå°†æ–°æ•°æ®æ’å…¥åˆ° latestRecords æœ€å‰é¢
                            if (!Array.isArray(latestRecords)) {
                                latestRecords = [];
                            }
                            
                            latestRecords.unshift(newRecord);
                            
                            // é•¿åº¦æ§åˆ¶ï¼šä¿æŒæ•°ç»„é•¿åº¦ä¸è¶…è¿‡ 10
                            if (latestRecords.length > 10) {
                                latestRecords = latestRecords.slice(0, 10);
                            }

                            // åŒæ­¥æ›´æ–° window.allDataï¼ˆç”¨äº LPDEF ä¸“å®¶ç­›é€‰ï¼‰
                            if (!window.allData) {
                                window.allData = [];
                            }
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
                            const exists = window.allData.some(item => 
                                (item.id && newRecord.id && item.id === newRecord.id) ||
                                (item.name === newRecord.name && item.created_at === newRecord.created_at)
                            );
                            if (!exists) {
                                window.allData.unshift(newRecord);
                                // é™åˆ¶ allData é•¿åº¦ï¼ˆä¿ç•™æœ€è¿‘ 1000 æ¡ï¼Œé¿å…å†…å­˜è¿‡å¤§ï¼‰
                                if (window.allData.length > 1000) {
                                    window.allData = window.allData.slice(0, 1000);
                                }
                            }
                            
                            console.log(`[Realtime] âœ… å·²æ›´æ–° latestRecords (å½“å‰é•¿åº¦: ${latestRecords.length})ï¼Œwindow.allData (å½“å‰é•¿åº¦: ${window.allData.length})`);

                            // é‡æ–°æ¸²æŸ“å³ä¾§å¡ç‰‡åˆ—è¡¨
                            try {
                                renderRecentActivity(latestRecords);
                                console.log('[Realtime] âœ… å·²åˆ·æ–°å®æ—¶è¯Šæ–­æ´»åŠ¨åˆ—è¡¨');
                            } catch (error) {
                                console.error('[Realtime] âŒ æ¸²æŸ“æ´»åŠ¨åˆ—è¡¨å¤±è´¥:', error);
                            }
                            
                            // Realtime æ›´æ–°åä¸å†éœ€è¦é‡æ–°æ¸²æŸ“ LPDEF å¡ç‰‡ï¼ˆå·²åºŸå¼ƒï¼‰

                            // åœ°å›¾è”åŠ¨ç‰¹æ•ˆï¼šå¦‚æœæ–°æ•°æ®åŒ…å«åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œè§¦å‘åœ°å›¾è„‰å†²
                            try {
                                // å°è¯•ä»æ–°æ•°æ®ä¸­æå–ç»çº¬åº¦ä¿¡æ¯
                                // æ ¹æ®å®é™…æ•°æ®å­—æ®µè°ƒæ•´ï¼ˆå¯èƒ½æ˜¯ lng/lat, longitude/latitude, location ç­‰ï¼‰
                                let lng = null;
                                let lat = null;
                                let vibeName = '';

                                // æ–¹å¼1ï¼šç›´æ¥å­—æ®µï¼ˆä¼˜å…ˆæ£€æŸ¥ç»çº¬åº¦å­—æ®µï¼‰
                                if (newRecord.lng !== undefined && newRecord.lat !== undefined) {
                                    lng = Number(newRecord.lng);
                                    lat = Number(newRecord.lat);
                                } else if (newRecord.longitude !== undefined && newRecord.latitude !== undefined) {
                                    lng = Number(newRecord.longitude);
                                    lat = Number(newRecord.latitude);
                                }
                                // æ–¹å¼2ï¼šä» location æˆ– ip_location å­—æ®µè§£æï¼ˆå¦‚æœåŒ…å«åæ ‡ï¼‰
                                else {
                                    const locationSource = newRecord.location || newRecord.ip_location;
                                    if (locationSource) {
                                        // å°è¯•è§£æ "lng,lat" æ ¼å¼çš„åæ ‡å­—ç¬¦ä¸²
                                        const locationStr = String(locationSource);
                                        const coords = locationStr.split(',');
                                        if (coords.length >= 2) {
                                            const parsedLng = Number(coords[0].trim());
                                            const parsedLat = Number(coords[1].trim());
                                            if (!isNaN(parsedLng) && !isNaN(parsedLat)) {
                                                lng = parsedLng;
                                                lat = parsedLat;
                                            }
                                        }
                                    }
                                }

                                // æå–åç§°ï¼ˆå¯èƒ½æ˜¯ name, vibe_name, personality_type ç­‰ï¼‰
                                const baseName = newRecord.name || newRecord.vibe_name || newRecord.personality_type || '';

                                // VPN ç©¿é€æ£€æµ‹åˆ¤å®šé€»è¾‘ï¼ˆå·²ç§»é™¤VPNå…³é”®å­—æ˜¾ç¤ºï¼‰
                                // =========================
                                let pulseColor = '#ffffff'; // é»˜è®¤ç™½è‰²ï¼ˆæ­£å¸¸ç”¨æˆ·ï¼‰
                                let pulseLabel = baseName ? `${baseName}` : 'ç”¨æˆ·';

                                // è·å–åˆ¤å®šæ‰€éœ€å­—æ®µ
                                const ipLocation = String(newRecord.ip_location || '').toUpperCase().trim();
                                const timezone = String(newRecord.timezone || '').trim();

                                // åˆ¤å®šæ¡ä»¶ï¼šå¦‚æœ ip_location ä¸å±äº 'CN'ï¼Œä½† timezone æ˜¯ 'Asia/Shanghai'ï¼Œåˆ™ä½¿ç”¨ç‰¹æ®Šé¢œè‰²
                                const isNotChina = ipLocation !== 'CN' && ipLocation !== '';
                                const isShanghaiTimezone = timezone === 'Asia/Shanghai';

                                if (isNotChina && isShanghaiTimezone) {
                                    // ç‰¹æ®Šç”¨æˆ·ï¼šæµ·å¤– IP + ä¸Šæµ·æ—¶åŒº
                                    pulseColor = '#00ff41'; // ç»ˆç«¯ç»¿
                                    pulseLabel = baseName ? `${baseName}` : 'ç”¨æˆ·';
                                    console.log('[Realtime] ğŸ” ç”¨æˆ·åˆ¤å®š: æ£€æµ‹åˆ°ç‰¹æ®Šç”¨æˆ·', {
                                        ipLocation,
                                        timezone,
                                        reason: 'æµ·å¤–IPä½†æ—¶åŒºä¸ºAsia/Shanghai'
                                    });
                                } else {
                                    // æ­£å¸¸ç”¨æˆ·ï¼šç›´æ¥è¿æ¥
                                    pulseColor = '#ffffff'; // æ­£å¸¸ç”¨æˆ·ï¼šçº¯ç™½è‰²
                                    pulseLabel = baseName ? `${baseName}` : 'ç”¨æˆ·';
                                    console.log('[Realtime] ğŸ” ç”¨æˆ·åˆ¤å®š: æ­£å¸¸ç”¨æˆ·', {
                                        ipLocation,
                                        timezone,
                                        reason: isNotChina ? 'æ—¶åŒºä¸åŒ¹é…' : 'IPä½ç½®æ­£å¸¸'
                                    });
                                }

                                // å¦‚æœæˆåŠŸæå–åˆ°ç»çº¬åº¦ï¼Œè§¦å‘åœ°å›¾è„‰å†²ï¼ˆä½¿ç”¨åˆ¤å®šåçš„é¢œè‰²å’Œæ ‡ç­¾ï¼‰
                                if (lng !== null && lat !== null && !isNaN(lng) && !isNaN(lat)) {
                                    // æå–å¤´åƒä¿¡æ¯
                                    let avatarUrl = newRecord.avatar_url || null;
                                    const githubUsername = newRecord.github_username || newRecord.github_id || null;
                                    const userName = newRecord.name || newRecord.vibe_name || newRecord.personality_type || '';
                                    
                                    // åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœ github_username ä¸ºç©ºã€æˆ–è€…æ˜¯é»˜è®¤å€¼ï¼Œåˆ™ä¸è¦è¯·æ±‚ GitHub å›¾ç‰‡
                                    // ã€Task 3ã€‘ä¼ å…¥ user_identityï¼Œå¯¹ fingerprint ç”¨æˆ·è·³è¿‡ä¸¥æ ¼æ ¡éªŒ
                                    const recordUserIdentity = newRecord.user_identity || null;
                                    if (!avatarUrl && githubUsername) {
                                        if (isValidGitHubUsername(githubUsername, recordUserIdentity)) {
                                            // åªæœ‰æœ‰æ•ˆçš„GitHubç”¨æˆ·åæ‰ç”Ÿæˆå¤´åƒURL
                                            avatarUrl = getGitHubAvatarUrl(githubUsername);
                                        } else {
                                            // æ— æ•ˆç”¨æˆ·åæ—¶ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                                            avatarUrl = DEFAULT_AVATAR;
                                        }
                                    }
                                    // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æœ‰æ•ˆçš„å¤´åƒURLï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
                                    if (!avatarUrl) {
                                        avatarUrl = DEFAULT_AVATAR;
                                    }
                                    
                                    // è·å–ç”¨æˆ·çŠ¶æ€é¢œè‰²ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤é¢œè‰²
                                    const statusColor = newRecord.status_color || pulseColor;
                                    
                                    triggerMapPulse(lng, lat, pulseLabel, statusColor, avatarUrl, githubUsername || userName);
                                    console.log(`[Realtime] âœ… å·²è§¦å‘åœ°å›¾è„‰å†²: [${lng}, ${lat}] ${pulseLabel} (é¢œè‰²: ${statusColor}, å¤´åƒ: ${avatarUrl}, ç”¨æˆ·å: ${githubUsername || userName})`);
                                } else {
                                    console.log('[Realtime] â„¹ï¸ æ–°æ•°æ®æœªåŒ…å«æœ‰æ•ˆçš„åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œè·³è¿‡åœ°å›¾è„‰å†²');
                                }
                            } catch (error) {
                                console.warn('[Realtime] âš ï¸ å¤„ç†åœ°å›¾è”åŠ¨ç‰¹æ•ˆæ—¶å‡ºé”™:', error);
                            }
                        }
                    )
                    .on(
                        'postgres_changes',
                        {
                            event: 'UPDATE',
                            schema: 'public',
                            table: 'user_analysis'
                        },
                        (payload) => {
                            console.log('[Realtime] ğŸ”„ æ”¶åˆ°æ•°æ®æ›´æ–°:', payload);
                            
                            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ payload å’Œ payload.new å­˜åœ¨
                            if (!payload || !payload.new) {
                                console.warn('[Realtime] âš ï¸ æ›´æ–°æ•°æ®æ ¼å¼ä¸å®Œæ•´ï¼Œè·³è¿‡å¤„ç†');
                                return;
                            }

                            const updatedRecord = payload.new;
                            
                            // åŒæ­¥æ›´æ–° window.allDataï¼ˆç”¨äºèº«ä»½åŒ¹é…å’Œæ’åå¡ç‰‡ï¼‰
                            if (!window.allData) {
                                window.allData = [];
                            }

                            // ã€ä¿®å¤ã€‘ç”¨â€œè§„èŒƒåŒ–åŒ¹é… + upsertâ€æ›¿ä»£ç®€å• push/unshiftï¼Œé¿å…é‡å¤ç´¯åŠ 
                            const normalizeFp = (fp) => {
                                if (!fp) return '';
                                return String(fp).trim().toLowerCase();
                            };
                            const recordId = (updatedRecord.id != null) ? String(updatedRecord.id) : '';
                            const recordFp = normalizeFp(updatedRecord.fingerprint || updatedRecord.user_fingerprint);
                            const recordIdentity = normalizeFp(updatedRecord.user_identity);

                            const index = window.allData.findIndex((item) => {
                                if (!item) return false;
                                const itemId = (item.id != null) ? String(item.id) : '';
                                if (recordId && itemId && itemId === recordId) return true;
                                const itemFp = normalizeFp(item.fingerprint || item.user_fingerprint);
                                const itemIdentity = normalizeFp(item.user_identity);
                                return (
                                    (recordFp && itemFp && itemFp === recordFp) ||
                                    (recordIdentity && itemIdentity && itemIdentity === recordIdentity) ||
                                    (recordFp && itemIdentity && itemIdentity === recordFp) ||
                                    (recordIdentity && itemFp && itemFp === recordIdentity)
                                );
                            });

                            if (index !== -1) {
                                window.allData[index] = { ...window.allData[index], ...updatedRecord };
                                console.log(`[Realtime] âœ… å·²æ›´æ–° window.allData ä¸­çš„è®°å½• (ç´¢å¼•: ${index})`);
                            } else {
                                window.allData.unshift(updatedRecord);
                                if (window.allData.length > 1000) window.allData = window.allData.slice(0, 1000);
                                console.log(`[Realtime] âœ… å·² upsert æ›´æ–°è®°å½•åˆ° window.allData`);
                            }
                            
                            // æ£€æŸ¥æ›´æ–°çš„è®°å½•æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·ï¼Œå¦‚æœæ˜¯åˆ™åˆ·æ–°æ’åå¡ç‰‡
                            // å®æ—¶æ›´æ–°ï¼šç¡®ä¿å†æ¬¡è§¦å‘ renderRankCards(currentUser)ï¼Œè®©å¡ç‰‡æ•°å­—èƒ½å¤Ÿéšç€æ•°æ®åº“å®æ—¶å˜åŠ¨
                            try {
                                // è¾…åŠ©å‡½æ•°ï¼šè§„èŒƒåŒ–æŒ‡çº¹å­—ç¬¦ä¸²ï¼ˆå¿½ç•¥å¤§å°å†™å¹¶å‰”é™¤é¦–å°¾ç©ºæ ¼ï¼‰
                                const normalizeFingerprint = (fp) => {
                                    if (!fp) return '';
                                    return String(fp).trim().toLowerCase();
                                };
                                
                                // è·å–å½“å‰ç”¨æˆ·çš„æ ‡è¯†ä¿¡æ¯ï¼ˆå¢åŠ å¼‚å¸¸å¤„ç†ï¼‰
                                let localGitHubName = null;
                                let currentFingerprint = null;
                                try {
                                    localGitHubName = localStorage.getItem('github_username');
                                    currentFingerprint = localStorage.getItem('user_fingerprint');
                                } catch (e) {
                                    console.warn('[Realtime] âš ï¸ è¯»å– localStorage å¤±è´¥:', e);
                                }
                                
                                const urlParams = new URLSearchParams(window.location.search);
                                const urlId = urlParams.get('id');
                                
                                // è§„èŒƒåŒ–å½“å‰æŒ‡çº¹
                                const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                                
                                // åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·çš„è®°å½•ï¼ˆä¼˜å…ˆçº§åŒ¹é…ç­–ç•¥ï¼šæŒ‡çº¹ä¼˜å…ˆ > GitHub IDï¼‰
                                let isCurrentUser = false;
                                let matchedByFingerprint = false;
                                
                                // æ–¹å¼1ï¼šé€šè¿‡ URL å‚æ•°åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œç”¨äºè°ƒè¯•ï¼‰
                                if (urlId) {
                                    const recordId = (updatedRecord.id || '').toString();
                                    const recordFingerprint = (updatedRecord.fingerprint || updatedRecord.user_identity || '').toString();
                                    if (recordId === urlId || recordFingerprint === urlId) {
                                        isCurrentUser = true;
                                    }
                                }
                                
                                // æ–¹å¼2ï¼šé€šè¿‡ Fingerprint åŒ¹é…ï¼ˆä¼˜å…ˆäºGitHub IDï¼Œå¿½ç•¥å¤§å°å†™å’Œç©ºæ ¼ï¼‰
                                if (!isCurrentUser && normalizedCurrentFingerprint) {
                                    const recordFingerprint = normalizeFingerprint(updatedRecord.fingerprint || updatedRecord.user_fingerprint);
                                    const recordIdentity = normalizeFingerprint(updatedRecord.user_identity);
                                    
                                    if ((recordFingerprint && recordFingerprint === normalizedCurrentFingerprint) ||
                                        (recordIdentity && recordIdentity === normalizedCurrentFingerprint)) {
                                        isCurrentUser = true;
                                        matchedByFingerprint = true;
                                    }
                                }
                                
                                // æ–¹å¼3ï¼šé€šè¿‡ GitHub ID åŒ¹é…ï¼ˆåœ¨æŒ‡çº¹åŒ¹é…å¤±è´¥åå°è¯•ï¼‰
                                if (!isCurrentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                                    // ã€ä¿®å¤ã€‘ç»Ÿä¸€ä½¿ç”¨ user_name å­—æ®µï¼Œä¸ä½¿ç”¨ github_username
                                    const recordGithubId = normalizeFingerprint(updatedRecord.user_name || updatedRecord.github_id || '');
                                    const normalizedLocalGitHub = normalizeFingerprint(localGitHubName);
                                    if (recordGithubId && recordGithubId === normalizedLocalGitHub) {
                                        isCurrentUser = true;
                                    }
                                }
                                
                                // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·çš„è®°å½•ï¼Œåˆ·æ–°æ’åå¡ç‰‡å’Œå…¨å±€å˜é‡
                                if (isCurrentUser) {
                                    console.log('[Realtime] âœ… æ£€æµ‹åˆ°å½“å‰ç”¨æˆ·æ•°æ®æ›´æ–°ï¼Œåˆ·æ–°æ’åå¡ç‰‡');
                                    
                                    // æ›´æ–°å…¨å±€å˜é‡
                                    window.currentUser = updatedRecord;
                                    window.currentUserMatchedByFingerprint = matchedByFingerprint;
                                    
                                    // æ›´æ–° window.allData ä¸­çš„å¯¹åº”è®°å½•
                                    const allData = window.allData || [];
                                    const updateIndex = allData.findIndex(item => {
                                        const itemFingerprint = normalizeFingerprint(item.fingerprint || item.user_fingerprint);
                                        const itemIdentity = normalizeFingerprint(item.user_identity);
                                        const recordFingerprint = normalizeFingerprint(updatedRecord.fingerprint || updatedRecord.user_fingerprint);
                                        const recordIdentity = normalizeFingerprint(updatedRecord.user_identity);
                                        
                                        return (itemFingerprint && itemFingerprint === recordFingerprint) ||
                                               (itemIdentity && itemIdentity === recordIdentity) ||
                                               (item.id && item.id === updatedRecord.id);
                                    });
                                    
                                    if (updateIndex !== -1) {
                                        allData[updateIndex] = updatedRecord;
                                        window.allData = allData;
                                    } else {
                                        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¯´æ˜ä¸Šé¢çš„ upsert å·²åšè¿‡ï¼ˆæˆ–åŒ¹é…æ¡ä»¶ä¸åŒï¼‰ï¼›è¿™é‡Œä¸å† pushï¼Œé¿å…é‡å¤
                                        window.allData = allData;
                                    }
                                    
                                    // ä½¿ç”¨æ›´æ–°åçš„è®°å½•ç›´æ¥æ¸²æŸ“ï¼Œç¡®ä¿å¡ç‰‡æ•°å­—èƒ½å¤Ÿå®æ—¶å˜åŠ¨
                                    renderRankCards(updatedRecord);
                                } else {
                                    console.debug('[Realtime] â„¹ï¸ æ›´æ–°çš„è®°å½•ä¸æ˜¯å½“å‰ç”¨æˆ·ï¼Œè·³è¿‡æ’åå¡ç‰‡åˆ·æ–°');
                                }
                            } catch (error) {
                                console.error('[Realtime] âŒ åˆ·æ–°æ’åå¡ç‰‡å¤±è´¥:', error);
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('[Realtime] âœ… å·²æˆåŠŸè®¢é˜… user_analysis è¡¨çš„ INSERT å’Œ UPDATE äº‹ä»¶');
                        } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                            // é€šé“é”™è¯¯/è¶…æ—¶å¸¸è§äºï¼šRealtime æœªå¼€å¯ã€ç½‘ç»œ/é˜²ç«å¢™é™åˆ¶ WebSocketï¼Œé™çº§ä¸ºè­¦å‘Šé¿å…åˆ·å±
                            console.warn('[Realtime] âš ï¸ è®¢é˜…æœªå°±ç»ªï¼ˆ' + status + 'ï¼‰ï¼Œå°†ä½¿ç”¨é™æ€æ•°æ®æ›´æ–°');
                        } else {
                            console.log(`[Realtime] â„¹ï¸ è®¢é˜…çŠ¶æ€: ${status}`);
                        }
                    });

                console.log('[Realtime] ğŸš€ Realtime ç›‘å¬å·²å¯åŠ¨');

                // =========================
                // Supabase Presence åŠŸèƒ½ï¼šç»Ÿè®¡å®æ—¶åœ¨çº¿äººæ•°
                // =========================
                
                // å¦‚æœå·²æœ‰ Presence é¢‘é“ï¼Œå…ˆå–æ¶ˆè®¢é˜…
                if (presenceChannel) {
                    try {
                        supabaseClient.removeChannel(presenceChannel);
                        console.log('[Presence] âœ… å·²å–æ¶ˆæ—§çš„ Presence é¢‘é“');
                    } catch (error) {
                        console.warn('[Presence] âš ï¸ å–æ¶ˆæ—§ Presence é¢‘é“æ—¶å‡ºé”™:', error);
                    }
                }

                try {
                    // åˆ›å»ºåä¸º online_users çš„ Presence é¢‘é“
                    presenceChannel = supabaseClient
                        .channel('online_users')
                        .on('presence', { event: 'sync' }, () => {
                            // sync å›è°ƒï¼šè·å–å½“å‰åœ¨çº¿çš„æ‰€æœ‰çŠ¶æ€å¯¹è±¡
                            const newState = presenceChannel.presenceState();
                            
                            // è°ƒè¯•æ—¥å¿—ï¼šè¾“å‡ºæ‰€æœ‰åŒæ­¥åˆ°çš„ç”¨æˆ·
                            console.log('[Presence] å½“å‰åŒæ­¥åˆ°çš„æ‰€æœ‰ç”¨æˆ·:', newState);
                            
                            // è®¡ç®—åœ¨çº¿äººæ•°ï¼šéå†æ‰€æœ‰çŠ¶æ€å¯¹è±¡å¹¶è®¡ç®—æ€»æ•°ï¼ˆä½¿ç”¨ user_name å»é‡ï¼‰
                            const userMap = new Map();
                            if (newState) {
                                Object.keys(newState).forEach((key) => {
                                    const presenceEntries = newState[key];
                                    const entries = Array.isArray(presenceEntries) ? presenceEntries : [presenceEntries];
                                    
                                    entries.forEach(entry => {
                                        if (!entry || !entry.online_at) return;
                                        // ä½¿ç”¨ user_name ä½œä¸ºå»é‡é”®
                                        const userName = entry.user_name || entry.github_id || entry.github_username || 'Guest';
                                        if (!userMap.has(userName) || new Date(entry.online_at) > new Date(userMap.get(userName).online_at)) {
                                            userMap.set(userName, entry);
                                        }
                                    });
                                });
                            }
                            
                            // æ³¨æ„ï¼šä¸æ’é™¤å½“å‰ç”¨æˆ·è‡ªå·±ï¼Œå› ä¸ºç”¨æˆ·è¦æ±‚åœ¨åˆ—è¡¨ä¸­å¯è§
                            const onlineCount = userMap.size;
                            console.log('[Presence] ğŸ‘¥ åœ¨çº¿äººæ•°åŒæ­¥ï¼ˆå»é‡åï¼ŒåŒ…å«è‡ªå·±ï¼‰:', onlineCount);

                            // æ›´æ–°é¡µé¢ä¸Š #online-count-value çš„æ•°å­—ï¼ˆåœ°å›¾ä¸Šçš„ï¼‰
                            const onlineCountElement = document.getElementById('online-count-value');
                            if (onlineCountElement) {
                                // æ·»åŠ ç¼©æ”¾åŠ¨ç”»ç±»
                                onlineCountElement.classList.add('online-count-update');
                                
                                // æ›´æ–°æ•°å­—
                                onlineCountElement.textContent = onlineCount;
                                
                                // åŠ¨ç”»ç»“æŸåç§»é™¤ç±»ï¼ˆä»¥ä¾¿ä¸‹æ¬¡æ›´æ–°æ—¶å¯ä»¥å†æ¬¡è§¦å‘åŠ¨ç”»ï¼‰
                                setTimeout(() => {
                                    onlineCountElement.classList.remove('online-count-update');
                                }, 400); // ä¸ CSS åŠ¨ç”»æ—¶é•¿ä¸€è‡´
                                
                                console.log('[Presence] âœ… å·²æ›´æ–°åœ¨çº¿äººæ•°æ˜¾ç¤ºï¼ˆåœ°å›¾ï¼‰:', onlineCount);
                            } else {
                                console.warn('[Presence] âš ï¸ æ‰¾ä¸åˆ° #online-count-value å…ƒç´ ');
                            }
                            
                            // æ›´æ–°æŠ½å±‰ä¸­çš„åœ¨çº¿äººæ•°ï¼ˆå³ä½¿æŠ˜å çŠ¶æ€ä¹Ÿè¦æ›´æ–°ï¼‰
                            const onlineCountText = document.getElementById('online-count-text');
                            if (onlineCountText) {
                                onlineCountText.textContent = onlineCount;
                            }
                            
                            // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨ï¼ˆä½¿ç”¨ updateOnlineList ç¡®ä¿è·å–æœ€æ–°çŠ¶æ€ï¼‰
                            updateOnlineList();
                        })
                        .on('broadcast', { event: 'burn_msg' }, ({ payload }) => {
                            // æ¥æ”¶ç§ä¿¡ï¼ˆé˜…åå³ç„šæ¶ˆæ¯ï¼‰
                            console.log('[Message] æ”¶åˆ°åŸå§‹å¹¿æ’­:', payload);
                            
                            const githubUsername = localStorage.getItem('github_username') || null;
                            const myId = githubUsername;
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯å‘ç»™å½“å‰ç”¨æˆ·çš„æ¶ˆæ¯
                            // ç»Ÿä¸€ä½¿ç”¨ target_id æˆ– to å­—æ®µè¿›è¡ŒåŒ¹é…ï¼Œæ”¯æŒ GitHub ID å’Œ user_name
                            const targetId = payload.target_id || payload.to;
                            const isForMe = targetId === myId || 
                                          targetId === githubUsername || 
                                          (!myId && targetId === 'Guest');
                            
                            if (payload && isForMe) {
                                console.log('[Message] ğŸ“¨ æ”¶åˆ°ç§ä¿¡:', payload);
                                const content = payload.content || payload.message || '';
                                const fromId = payload.from || 'Unknown';
                                const statusColor = payload.status_color || '#00ff41';
                                const displayName = payload.username || (fromId && fromId.length > 8 ? fromId.substring(0, 8) : fromId) || 'åŒ¿å';
                                const avatar = payload.avatar || '';
                                showBurnMsg(content, displayName, statusColor, avatar);
                            } else {
                                console.log('[Message] âš ï¸ æ¶ˆæ¯ä¸æ˜¯å‘ç»™æˆ‘çš„:', { targetId, myId, githubUsername });
                            }
                        })
                        .on('broadcast', { event: 'private_message' }, ({ payload }) => {
                            // å…¼å®¹æ—§çš„äº‹ä»¶å
                            console.log('[Message] æ”¶åˆ°åŸå§‹å¹¿æ’­ (private_message):', payload);
                            
                            const githubUsername = localStorage.getItem('github_username') || null;
                            const myId = githubUsername;
                            
                            const targetId = payload.target_id || payload.to;
                            const isForMe = targetId === myId || 
                                          targetId === githubUsername || 
                                          (!myId && targetId === 'Guest');
                            
                            if (payload && isForMe) {
                                console.log('[Message] ğŸ“¨ æ”¶åˆ°ç§ä¿¡ (å…¼å®¹æ¨¡å¼):', payload);
                                const content = payload.content || payload.message || '';
                                const fromId = payload.from || 'Unknown';
                                const statusColor = payload.status_color || '#00ff41';
                                const displayName = payload.username || (fromId && fromId.length > 8 ? fromId.substring(0, 8) : fromId) || 'åŒ¿å';
                                const avatar = payload.avatar || '';
                                showBurnMsg(content, displayName, statusColor, avatar);
                            }
                        })
                        .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                            console.log('[Presence] â• ç”¨æˆ·åŠ å…¥:', key, newPresences);
                        })
                        .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                            console.log('[Presence] â– ç”¨æˆ·ç¦»å¼€:', key, leftPresences);
                        })
                        .subscribe(async (status, err) => {
                            if (status === 'SUBSCRIBED') {
                                console.log('[Presence] âœ… å·²æˆåŠŸè®¢é˜… online_users é¢‘é“');
                                
                                // å¼ºåˆ¶åŒæ­¥è‡ªèº«çŠ¶æ€ï¼ˆå¿…é¡»æ˜¾å¼è°ƒç”¨ï¼‰
                                await trackSelf();
                                // åœ¨ Presence è®¢é˜…æˆåŠŸåå†åˆå§‹åŒ–çŠ¶æ€æŒ‰é’®ï¼Œé¿å…ä¸ subscribe é€»è¾‘å†²çª
                                try { initStatusButtons(); } catch (e) { console.log('[Presence] initStatusButtons:', e); }
                            } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                                // ä¸ Realtime ä¸€è‡´ï¼šé™çº§ä¸ºè­¦å‘Šï¼Œé¿å…æ§åˆ¶å°åˆ·çº¢
                                console.warn('[Presence] âš ï¸ è®¢é˜…æœªå°±ç»ªï¼ˆ' + status + 'ï¼‰ï¼Œè¯¦æƒ…:', err);
                                if (status === 'CHANNEL_ERROR') {
                                    console.warn('[Presence] â„¹ï¸ æç¤º: è¯·æ£€æŸ¥ Supabase åå° -> App -> Realtime æ˜¯å¦å¼€å¯äº† Presence å’Œ Broadcast åŠŸèƒ½');
                                }
                                renderOnlineUsersListUnavailable();
                            } else {
                                console.log(`[Presence] â„¹ï¸ Presence è®¢é˜…çŠ¶æ€: ${status}`);
                            }
                        });

                    console.log('[Presence] ğŸš€ Presence ç›‘å¬å·²å¯åŠ¨');
                } catch (presenceError) {
                    console.warn('[Presence] âš ï¸ å¯åŠ¨ Presence ç›‘å¬å¤±è´¥ï¼ˆå°†ä¸æ˜¾ç¤ºå®æ—¶åœ¨çº¿ï¼‰:', presenceError);
                }

            } catch (error) {
                console.warn('[Realtime] âš ï¸ å¯åŠ¨ Realtime ç›‘å¬å¤±è´¥ï¼ˆå°†ä½¿ç”¨é™æ€æ•°æ®ï¼‰:', error);
            }
        }

        /**
         * åœæ­¢ Supabase Realtime ç›‘å¬
         */
        function stopRealtimeListener() {
            // åœæ­¢ postgres_changes ç›‘å¬
            if (realtimeChannel && supabaseClient) {
                try {
                    supabaseClient.removeChannel(realtimeChannel);
                    realtimeChannel = null;
                    console.log('[Realtime] âœ… å·²åœæ­¢ Realtime ç›‘å¬');
                } catch (error) {
                    console.warn('[Realtime] âš ï¸ åœæ­¢ç›‘å¬æ—¶å‡ºé”™:', error);
                }
            }

            // åœæ­¢ Presence ç›‘å¬
                    if (presenceChannel) {
                try {
                    // å…ˆå–æ¶ˆè·Ÿè¸ªï¼Œç„¶åç§»é™¤é¢‘é“
                    const channelToRemove = presenceChannel;
                    presenceChannel = null; // ç«‹å³ç½®ç©ºé˜²æ­¢ç«æ€
                    
                    channelToRemove.untrack().then(() => {
                        if (supabaseClient) supabaseClient.removeChannel(channelToRemove);
                    }).catch(e => {
                         if (supabaseClient) supabaseClient.removeChannel(channelToRemove);
                    });
                    
                    console.log('[Presence] âœ… å·²åœæ­¢ Presence ç›‘å¬');
                } catch (error) {
                    console.warn('[Presence] âš ï¸ åœæ­¢ Presence ç›‘å¬æ—¶å‡ºé”™:', error);
                }
            }
        }

        /**
         * è®¾ç½®ç”¨æˆ·çŠ¶æ€
         * @param {string} status - çŠ¶æ€ç±»å‹ ('idle', 'busy', 'sprint')
         */
        function setUserStatus(status) {
            if (!USER_STATUSES[status]) {
                console.warn('[Status] âš ï¸ æ— æ•ˆçš„çŠ¶æ€ç±»å‹:', status);
                return;
            }
            
            currentUserStatus = status;
            localStorage.setItem('user_status', status);
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnStatus = btn.getAttribute('data-status');
                if (btnStatus === status) {
                    btn.classList.add('active');
                    const statusConfig = USER_STATUSES[status];
                    btn.style.borderColor = statusConfig.color;
                    btn.style.color = statusConfig.color;
                } else {
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }
            });
            
            // ç«‹å³åŒæ­¥çŠ¶æ€åˆ°Presenceï¼ˆå¼‚æ­¥ï¼‰
            syncPresenceState().then(() => {
                // åŒæ­¥å®Œæˆåç«‹å³æ›´æ–°ç”¨æˆ·åˆ—è¡¨
                if (presenceChannel) {
                    const state = presenceChannel.presenceState();
                    renderOnlineUsersList(state);
                }
            }).catch(() => {
                // å³ä½¿åŒæ­¥å¤±è´¥ï¼Œä¹Ÿå°è¯•æ›´æ–°åˆ—è¡¨
                if (presenceChannel) {
                    const state = presenceChannel.presenceState();
                    renderOnlineUsersList(state);
                }
            });
            
            // å¦‚æœæ˜¯åˆ‡æ¢åˆ°ç¦»çº¿çŠ¶æ€ï¼Œç«‹å³æ›´æ–°åˆ—è¡¨ï¼ˆä¸ç­‰å¾…åŒæ­¥å®Œæˆï¼‰
            if (status === 'sprint') {
                setTimeout(() => {
                    if (presenceChannel) {
                        const state = presenceChannel.presenceState();
                        renderOnlineUsersList(state);
                    }
                }, 100);
            }
            
            console.log('[Status] âœ… ç”¨æˆ·çŠ¶æ€å·²æ›´æ–°:', status, USER_STATUSES[status]);
        }
        
        /**
         * åˆå§‹åŒ–çŠ¶æ€æŒ‰é’®æ ·å¼
         */
        function initStatusButtons() {
            const savedStatus = localStorage.getItem('user_status') || 'idle';
            setUserStatus(savedStatus);
        }
        
        /**
         * è·å–ç”¨æˆ·åœ°ç†ä½ç½®ï¼ˆç”±åç«¯ CF æ¥ç®¡ï¼Œå‰ç«¯ä¸å†è¯·æ±‚ ipapi.co/ip-api.comï¼Œé¿å… 429ï¼‰ã€‚
         * è¿”å›é»˜è®¤ç»“æ„ï¼Œå®é™…å›½å®¶ç”±åç«¯ /api/v2/analyze æ ¹æ® CF æˆ– manual_location å†™å…¥ã€‚
         */
        function getUserLocation() {
            var defaultResult = { lat: null, lng: null, countryCode: 'US' };
            return Promise.resolve(defaultResult);
        }
        /**
         * å¼ºåˆ¶åŒæ­¥è‡ªèº«çŠ¶æ€ï¼ˆtrackSelfï¼‰
         * åœ¨ SUBSCRIBED å›è°ƒä¸­æ˜¾å¼è°ƒç”¨
         */
        async function trackSelf() {
            if (!presenceChannel) {
                if (window.__PRESENCE_SKIPPED) return; // Cloudflare å·²è·³è¿‡ Presenceï¼Œé™é»˜è¿”å›
                console.warn('[Presence] âš ï¸ Presenceé¢‘é“æœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                // è·å– GitHub ç”¨æˆ·å
                const ghUsername = localStorage.getItem('github_username') || null;
                
                // ç”Ÿæˆ user_name
                const userName = ghUsername && isValidGitHubUsername(ghUsername) 
                    ? ghUsername 
                    : `Guest_${Math.floor(Math.random() * 1000)}`;
                
                // ç”Ÿæˆ avatar_url
                const avatarUrl = ghUsername && isValidGitHubUsername(ghUsername)
                    ? `https://github.com/${ghUsername}.png`
                    : DEFAULT_AVATAR;
                
                // è·å–çŠ¶æ€ä¿¡æ¯
                const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                const status = statusConfig.status || 'idle';
                const statusColor = statusConfig.status_color || '#00ff41';
                
                // è·å–ç»çº¬åº¦
                const location = await getUserLocation();
                
                // å¦‚æœç”¨æˆ·çŠ¶æ€æ˜¯ç¦»çº¿ï¼ˆsprintï¼‰ï¼Œä¸è·Ÿè¸ªåˆ° Presenceï¼ˆå®Œå…¨éšèº«ï¼‰
                if (status === 'sprint') {
                    console.log('[Presence] âš ï¸ ç”¨æˆ·çŠ¶æ€ä¸ºç¦»çº¿ï¼Œä¸è·Ÿè¸ªåˆ° Presenceï¼ˆå®Œå…¨éšèº«ï¼‰');
                    // å¦‚æœä¹‹å‰æœ‰è·Ÿè¸ªï¼Œå…ˆå–æ¶ˆè·Ÿè¸ª
                    try {
                        await presenceChannel.untrack();
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯
                    }
                    return;
                }
                
                // æ„å»º Presence æ•°æ®ï¼ˆå« fingerprint ä¾›ç§ä¿¡ toId ç²¾å‡†æŠ•é€’ï¼‰
                var myFp = '';
                try { myFp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                const myPresence = {
                    user_name: userName,
                    avatar_url: avatarUrl,
                    github_id: ghUsername || null,
                    github_username: ghUsername || null,
                    fingerprint: myFp || null,
                    user_fingerprint: myFp || null,
                    status: status,
                    status_color: statusColor,
                    online_at: new Date().toISOString(),
                    lat: location.lat,
                    lng: location.lng,
                    last_vibe: new Date().toISOString()
                };
                
                // æ˜¾å¼è°ƒç”¨ track å‰å†æ¬¡æ£€æŸ¥å®ä¾‹ï¼ˆé˜²æ­¢å¼‚æ­¥ç«æ€å¯¼è‡´ presenceChannel å·²è¢«ç½®ç©ºï¼‰
                if (!presenceChannel) {
                    if (window.__PRESENCE_SKIPPED) return;
                    console.warn('[Presence] âš ï¸ presenceChannel å®ä¾‹å·²å¤±æ•ˆï¼Œè·³è¿‡ track');
                    return;
                }
                await presenceChannel.track(myPresence);
                
                console.log('[Presence] âœ… è‡ªèº«çŠ¶æ€å·²åŒæ­¥:', myPresence);
            } catch (error) {
                console.error('[Presence] âŒ åŒæ­¥è‡ªèº«çŠ¶æ€å¤±è´¥:', error);
            }
        }

        /**
         * åŒæ­¥PresenceçŠ¶æ€ï¼ˆåŒ…å«æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ï¼‰
         * å…¼å®¹æ—§ä»£ç ï¼Œå†…éƒ¨è°ƒç”¨ trackSelf
         */
        async function syncPresenceState() {
            await trackSelf();
        }
        
        /**
         * åˆ‡æ¢æŠ½å±‰å±•å¼€/æŠ˜å çŠ¶æ€
         */
        function toggleDrawer() {
            drawerExpanded = !drawerExpanded;
            const drawer = document.getElementById('live-nodes-drawer');
            if (!drawer) return;
            
            if (drawerExpanded) {
                drawer.classList.remove('collapsed');
                drawer.classList.add('expanded');
            } else {
                drawer.classList.remove('expanded');
                drawer.classList.add('collapsed');
            }
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('drawer_expanded', drawerExpanded.toString());
            console.log('[Drawer] âœ… æŠ½å±‰çŠ¶æ€å·²åˆ‡æ¢:', drawerExpanded ? 'å±•å¼€' : 'æŠ˜å ');
        }
        
        /**
         * åˆå§‹åŒ–æŠ½å±‰çŠ¶æ€
         */
        function initDrawerState() {
            const drawer = document.getElementById('live-nodes-drawer');
            if (!drawer) return;

            if (drawerExpanded) {
                drawer.classList.remove('collapsed');
                drawer.classList.add('expanded');
            } else {
                drawer.classList.remove('expanded');
                drawer.classList.add('collapsed');
            }

            // ã€ä¿®å¤ã€‘æ¢å¤å·¦ä¾§/å³ä¾§æŠ½å±‰çŠ¶æ€
            const leftDrawerOpen = localStorage.getItem('left_drawer_open') === 'true';
            const rightDrawerOpen = localStorage.getItem('right_drawer_open') === 'true';

            const leftDrawer = document.getElementById('left-drawer');
            const rightDrawer = document.getElementById('right-drawer');

            if (leftDrawer && leftDrawerOpen) {
                leftDrawer.classList.add('active');
                // ä¸ä¸‹æ‹‰åˆ—è¡¨ä¸€è‡´ï¼šä¼˜å…ˆä½¿ç”¨ user_selected_countryï¼Œå† manual_location / é”šå®š
                let countryCode = null;
                let countryName = '';

                // ä¼˜å…ˆçº§ 1: ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©çš„å›½å®¶ï¼ˆä¸ç”¨æˆ·æ ¡å‡†ã€Supabase åŒæ­¥ä¸€è‡´ï¼‰
                const selectedCountry = localStorage.getItem('user_selected_country');
                if (selectedCountry) {
                    countryCode = selectedCountry.toUpperCase();
                    if (countryNameMap[countryCode]) {
                        countryName = currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en;
                    } else {
                        countryName = countryCode;
                    }
                }

                // ä¼˜å…ˆçº§ 2: æ—§ç‰ˆæ‰‹åŠ¨æ ¡å‡† (manual_location)
                if (!countryCode && localStorage.getItem('loc_fixed') === 'true') {
                    countryCode = localStorage.getItem('manual_location') || null;
                    if (countryCode && countryNameMap[countryCode]) {
                        countryName = currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en;
                    }
                }

                // ä¼˜å…ˆçº§ 3: é”šå®šå›½å®¶ (anchored_country / selected_country)
                if (!countryCode) {
                    countryCode = _getAnchoredCountryFromStorage() || null;
                    if (countryCode && countryNameMap[countryCode]) {
                        countryName = currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en;
                    }
                }

                // è§£è€¦ï¼šä¸å†åœ¨ initDrawerState å†…è°ƒç”¨ switchToCountryView/switchViewï¼Œç”± window.onload ç»Ÿä¸€ä¸€æ¬¡ switchView('country', savedCC)
                if (countryCode) {
                    try {
                        currentDrawerCountry.code = String(countryCode).toUpperCase();
                        currentDrawerCountry.name = countryName || countryCode;
                    } catch { /* ignore */ }
                }

                // æ¢å¤å·¦ä¾§æŠ½å±‰ã€Œç”¨æˆ·æ ¡å‡†ã€æ˜¾ç¤ºï¼šå¿…é¡»ä¸ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©çš„å›½å®¶ä¸€è‡´ï¼ˆä¼˜å…ˆ user_selected_countryï¼‰
                (function () {
                    const selectedCountry = localStorage.getItem('user_selected_country');
                    let countryCode = '';
                    let countryName = '';
                    let isManual = false;

                    if (selectedCountry) {
                        countryCode = selectedCountry.toUpperCase();
                        if (countryNameMap[countryCode]) {
                            countryName = currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en;
                        } else {
                            countryName = countryCode;
                        }
                        isManual = true;
                    } else if (localStorage.getItem('loc_fixed') === 'true') {
                        const manualLocation = localStorage.getItem('manual_location') || '';
                        const manualLat = localStorage.getItem('manual_lat');
                        const manualLng = localStorage.getItem('manual_lng');
                        if (manualLocation || (manualLat && manualLng)) {
                            countryCode = manualLocation ? manualLocation.toUpperCase() : '';
                            if (countryCode && countryNameMap[countryCode]) {
                                countryName = currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en;
                            } else {
                                countryName = countryCode || manualLocation || '';
                            }
                            isManual = true;
                        }
                    }

                    if (countryCode && typeof updateUserCountryFlag === 'function') {
                        setTimeout(() => {
                            updateUserCountryFlag(countryCode, countryName, isManual);
                            console.log('[Drawer] âœ… å·²æ¢å¤ç”¨æˆ·æ ¡å‡†æ˜¾ç¤ºï¼ˆä¸ä¸‹æ‹‰ä¸€è‡´ï¼‰:', { countryCode, countryName, isManual });
                        }, 200);
                    }
                })();
            }

            if (rightDrawer && rightDrawerOpen) {
                rightDrawer.classList.add('active');
            }
        }
        
        /**
         * æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆæ ¸å¿ƒæ¸²æŸ“é€»è¾‘ï¼‰
         * åœ¨ onlineChannel.on('presence', { event: 'sync' }) å›è°ƒä¸­è°ƒç”¨
         */
        function updateOnlineList() {
            if (!presenceChannel) {
                if (window.__PRESENCE_SKIPPED) {
                    // Cloudflare ç¯å¢ƒï¼šæ˜¾ç¤ºã€Œå½“å‰ç¯å¢ƒä¸æ”¯æŒå®æ—¶åœ¨çº¿ã€å ä½ï¼Œé¿å…åå¤æŠ¥é”™
                    renderOnlineUsersListUnavailable();
                    return;
                }
                console.warn('[UserList] âš ï¸ Presenceé¢‘é“æœªåˆå§‹åŒ–');
                return;
            }
            
            // é€šè¿‡ onlineChannel.presenceState() è·å–æœ€æ–°çŠ¶æ€
            const state = presenceChannel.presenceState();
            renderOnlineUsersList(state);
        }

        /** Cloudflare ç­‰æœªå¯ç”¨ Presence æ—¶ï¼šåœ¨çº¿ç”¨æˆ·åˆ—è¡¨å ä½æ–‡æ¡ˆï¼Œä¸æŠ¥é”™ */
        function renderOnlineUsersListUnavailable() {
            const listContainer = document.getElementById('online-users-list');
            if (!listContainer) return;
            const msg = (typeof getI18nText === 'function' && getI18nText('realtime.unavailable')) || 'å½“å‰ç¯å¢ƒä¸æ”¯æŒå®æ—¶åœ¨çº¿';
            if (!listContainer.dataset.unavailableShown) {
                listContainer.dataset.unavailableShown = '1';
                listContainer.innerHTML = '<div class="text-zinc-500 text-center py-4 text-xs">' + escapeHtml(msg) + '</div>';
            }
        }
        
        /**
         * æ¸²æŸ“åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆç´§å‡‘æ’åˆ—ï¼šå›¾æ ‡å¼ï¼‰
         * @param {Object} presenceState - PresenceçŠ¶æ€å¯¹è±¡
         */
        function renderOnlineUsersList(presenceState) {
            const listContainer = document.getElementById('online-users-list');
            if (!listContainer) {
                console.warn('[UserList] âš ï¸ æ‰¾ä¸åˆ°ç”¨æˆ·åˆ—è¡¨å®¹å™¨');
                return;
            }
            
            // å³æ—¶æ¸…ç©ºå®¹å™¨ï¼Œç§»é™¤ "Scanning..." æç¤º
            listContainer.innerHTML = '';
            
            // æ”¶é›†æ‰€æœ‰ç”¨æˆ·ï¼Œä½¿ç”¨ user_name ä½œä¸ºå»é‡é”®
            const userMap = new Map();
            
            if (presenceState && Object.keys(presenceState).length > 0) {
                Object.keys(presenceState).forEach((key) => {
                    const presenceEntries = presenceState[key];
                    const entries = Array.isArray(presenceEntries) ? presenceEntries : [presenceEntries];
                    
                    entries.forEach(entry => {
                        if (!entry || !entry.online_at) return;
                        
                        // ä½¿ç”¨ user_name ä½œä¸ºå»é‡é”®
                        const userName = entry.user_name || entry.github_id || entry.github_username || 'Guest';
                        
                        // å»é‡é€»è¾‘ï¼šå¦‚æœå·²å­˜åœ¨è¯¥ç”¨æˆ·ï¼Œä¿ç•™æœ€æ–°çš„
                        if (!userMap.has(userName) || new Date(entry.online_at) > new Date(userMap.get(userName).online_at)) {
                            userMap.set(userName, {
                                ...entry,
                                user_name: userName,
                                github_id: entry.github_id || entry.github_username || null,
                                github_username: entry.github_username || entry.github_id || null
                            });
                        }
                    });
                });
            }
            
            // è½¬æ¢ä¸ºæ•°ç»„
            const allUsers = Array.from(userMap.values());
            
            // è¿‡æ»¤æ‰ç¦»çº¿ç”¨æˆ·ï¼ˆsprintçŠ¶æ€ï¼‰
            const visibleUsers = allUsers.filter(user => {
                const status = user.status || 'idle';
                return status !== 'sprint'; // å®Œå…¨éšè—ç¦»çº¿ç”¨æˆ·
            });
            
            // å¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (visibleUsers.length === 0) {
                listContainer.innerHTML = '<div class="text-zinc-500 text-center py-8 text-[10px] w-full">Scanning for nearby nodes...</div>';
                return;
            }
            
            // æ’åºï¼šæŒ‰åœ¨çº¿æ—¶é—´å€’åº
            visibleUsers.sort((a, b) => new Date(b.online_at) - new Date(a.online_at));
            
            // æ¸²æŸ“ç´§å‡‘æ’åˆ—çš„å¤´åƒ
            const html = visibleUsers.map((user, index) => {
                const userName = user.user_name || user.github_id || user.github_username || 'Guest';
                const githubId = user.github_id || user.github_username || userName;
                const avatarUrl = user.avatar_url || DEFAULT_AVATAR;
                const status = user.status || 'idle';
                const statusConfig = USER_STATUSES[status] || USER_STATUSES.idle;
                const isBusy = status === 'busy';
                const currentUserId = localStorage.getItem('github_username') || null;
                const isCurrentUser = userName === currentUserId || githubId === currentUserId;
                
                // å¿™ç¢ŒçŠ¶æ€ï¼šå…¶ä»–ç”¨æˆ·æ— æ³•ç‚¹å‡»å‘é€æ¶ˆæ¯
                const canSendMessage = !isBusy || isCurrentUser;
                
                var toId = user.fingerprint || user.user_fingerprint || user.user_identity || githubId;
                var userFp = (user.fingerprint || user.user_fingerprint || '').toString();
                return `
                    <div 
                        class="user-avatar-trigger user-avatar-compact ${isBusy ? 'busy' : ''}" 
                        data-user-index="${index}"
                        data-user-name="${escapeHtml(userName)}"
                        data-github-id="${escapeHtml(githubId)}"
                        data-fingerprint="${escapeHtml(userFp)}"
                        data-to-id="${escapeHtml(toId)}"
                        data-avatar-url="${escapeHtml(avatarUrl)}"
                        data-status="${status}"
                        data-status-label="${statusConfig.label}"
                        onclick="toggleUserPopup(event, ${index})"
                    >
                        <img 
                            src="${avatarUrl}" 
                            alt="${userName}" 
                            loading="lazy"
                            referrerpolicy="no-referrer"
                            onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';"
                        />
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = html;
        }
        
        // å…¨å±€å˜é‡ï¼šå½“å‰æ˜¾ç¤ºçš„å¼¹çª—
        let currentPopupElement = null;
        
        /**
         * åˆ‡æ¢ç”¨æˆ·å¼¹çª—æ˜¾ç¤º/éšè—ï¼ˆç‚¹å‡»è§¦å‘ï¼‰
         */
        function toggleUserPopup(event, userIndex) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
                
                // ã€ä¿®å¤ã€‘å¦‚æœç‚¹å‡»çš„æ˜¯å¼¹çª—å†…éƒ¨ï¼Œä¸è¿›è¡Œåˆ‡æ¢ï¼ˆé˜²æ­¢ç‚¹å‡»å¼¹çª—å¯¼è‡´å¼¹çª—å…³é—­ï¼‰
                if (event.target.closest('.user-popup')) {
                    return;
                }
            }
            
            const avatarElement = event ? event.currentTarget : document.querySelector(`[data-user-index="${userIndex}"]`);
            if (!avatarElement) {
                console.warn('[Popup] âš ï¸ æ‰¾ä¸åˆ°å¤´åƒå…ƒç´ ');
                return;
            }
            
            const userName = avatarElement.getAttribute('data-user-name');
            
            // æ£€æŸ¥å½“å‰å¼¹çª—æ˜¯å¦å±äºè¿™ä¸ªç”¨æˆ·
            if (currentPopupElement && currentPopupElement.getAttribute('data-user-name') === userName) {
                if (currentPopupElement._cleanup) currentPopupElement._cleanup();
                currentPopupElement.remove();
                currentPopupElement = null;
                return;
            }
            
            const allPopups = document.querySelectorAll('.user-popup');
            allPopups.forEach(popup => {
                if (popup._cleanup) popup._cleanup();
                popup.remove();
            });
            // æ¸²æŸ“ç”¨æˆ·å¼¹çª—å‰å…ˆ destroy æ—§é›·è¾¾å›¾å®ä¾‹ï¼Œé˜²æ­¢æŠ¥é”™ä¸­æ–­
            if (window.myRadarChart) {
                try { window.myRadarChart.destroy(); } catch (e) { /* ignore */ }
                window.myRadarChart = null;
            }
            const githubId = avatarElement.getAttribute('data-github-id');
            const avatarUrl = avatarElement.getAttribute('data-avatar-url');
            const status = avatarElement.getAttribute('data-status');
            const statusLabel = avatarElement.getAttribute('data-status-label');
            const statusConfig = USER_STATUSES[status] || USER_STATUSES.idle;
            const isBusy = status === 'busy';
            const currentUserId = localStorage.getItem('github_username') || null;
            const isCurrentUser = userName === currentUserId || githubId === currentUserId;
            const canSendMessage = !isBusy || isCurrentUser;
            
            // åˆ›å»ºå¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'user-popup';
            popup.setAttribute('data-user-name', userName);
            popup.style.display = 'block';
            popup.style.visibility = 'visible';
            
            // å…ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€çš„å†…å®¹ï¼ˆç‚¹å‡»å¤´åƒå¯è·³è½¬ç”¨æˆ· GitHubï¼‰
            popup.innerHTML = `
                <div class="user-popup-header">
                    <a href="https://github.com/${escapeHtml(githubId)}" target="_blank" rel="noopener" class="user-popup-avatar-link" title="è·³è½¬ GitHub">
                        <img src="${escapeHtml(avatarUrl)}" alt="${escapeHtml(userName)}" class="user-popup-avatar" onerror="this.onerror=null; this.src='${DEFAULT_AVATAR}';" />
                    </a>
                    <div class="user-popup-info">
                        <div class="user-popup-name">${escapeHtml(userName)}</div>
                        <div class="user-popup-status">${escapeHtml(statusLabel)}</div>
                    </div>
                </div>
                <div class="user-popup-repo">
                    <div class="user-popup-repo-title">ä»“åº“é¢„è§ˆ</div>
                    <div class="user-popup-repo-list" id="repo-list-${userIndex}">
                        <div class="user-popup-repo-item" style="color: rgba(255,255,255,0.4);">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                <div class="user-popup-actions">
                    <button 
                        class="user-popup-btn user-popup-btn-icon" 
                        data-action="message"
                        title="${canSendMessage ? (currentLang === 'zh' ? 'å‘é€æ¶ˆæ¯' : 'Send Message') : (currentLang === 'zh' ? 'å¿™ç¢Œä¸­' : 'Busy')}"
                        ${!canSendMessage ? 'disabled' : ''}
                    >âœ‰</button>
                    <button class="inbox-indicator user-popup-btn user-popup-btn-icon" data-action="inbox" title="${currentLang === 'zh' ? 'æ”¶ä»¶ç®±' : 'Inbox'}">ğŸ“¥</button>
                    <button 
                        class="user-popup-btn user-popup-btn-icon repo-btn"
                        data-action="repo"
                        data-github-id="${escapeHtml(githubId)}"
                        title="${currentLang === 'zh' ? 'è·³è½¬ä»“åº“' : 'Open Repo'}"
                    >â†—</button>
                </div>
            `;
            
            // å¼¹çª—æŒ‚è½½åˆ° bodyï¼Œè‡ªé€‚åº”å±å¹•ã€ä¸é®æŒ¡å…³é”®åŒºåŸŸï¼Œä¸”å¤„äºæ´»è·ƒèŠ‚ç‚¹æ¡†å¤–
            document.body.appendChild(popup);
            currentPopupElement = popup;
            
            const GAP = 10;
            const SAFE_MARGIN = 12;
            
            const updatePosition = () => {
                const avatarRect = avatarElement.getBoundingClientRect();
                const pw = popup.offsetWidth;
                const ph = popup.offsetHeight;
                const vw = window.innerWidth;
                const vh = window.innerHeight;
                const drawer = document.getElementById('live-nodes-drawer');
                const drawerRect = drawer ? drawer.getBoundingClientRect() : null;
                
                // æ°´å¹³ï¼šä¸å¤´åƒä¸­å¿ƒå¯¹é½ï¼Œè¶…å‡ºè§†å£åˆ™è´´è¾¹
                let centerX = avatarRect.left + avatarRect.width / 2;
                let leftPx = centerX - pw / 2;
                let useTranslateX = true;
                if (leftPx < SAFE_MARGIN) {
                    leftPx = SAFE_MARGIN;
                    useTranslateX = false;
                } else if (leftPx + pw > vw - SAFE_MARGIN) {
                    leftPx = vw - SAFE_MARGIN - pw;
                    useTranslateX = false;
                }
                popup.style.left = (useTranslateX ? centerX : leftPx) + 'px';
                popup.style.transform = useTranslateX ? 'translateX(-50%)' : 'none';
                if (useTranslateX) popup.classList.remove('edge-position'); else popup.classList.add('edge-position');
                
                // å‚ç›´ï¼šä»æ´»è·ƒèŠ‚ç‚¹æ¡†ä¸Šè¾¹ç¼˜æ¨å‡ºï¼Œå¼¹çª—æ•´ä½“åœ¨æŠ½å±‰ä¸Šæ–¹ï¼Œä¸é®æŒ¡æŠ½å±‰
                let top;
                const aboveDrawerTop = drawerRect ? (drawerRect.top - GAP - ph) : (avatarRect.top - GAP - ph);
                const fitsAboveDrawer = drawerRect && (aboveDrawerTop >= SAFE_MARGIN);
                if (fitsAboveDrawer) {
                    top = drawerRect.top - ph - GAP;
                    if (useTranslateX) popup.classList.add('emerged-from-drawer');
                    else popup.classList.remove('emerged-from-drawer');
                    popup.classList.remove('top-position');
                } else if (drawerRect) {
                    // ä¸Šæ–¹ç©ºé—´ä¸è¶³æ—¶æ”¾åœ¨å¤´åƒä¸‹æ–¹ï¼Œé¿å…é®æŒ¡æ´»è·ƒèŠ‚ç‚¹æ¡†
                    popup.classList.remove('emerged-from-drawer');
                    top = avatarRect.bottom + GAP;
                    if (top + ph > vh - SAFE_MARGIN) top = Math.max(SAFE_MARGIN, vh - SAFE_MARGIN - ph);
                    popup.classList.add('top-position');
                } else {
                    top = aboveDrawerTop;
                    if (top < SAFE_MARGIN) {
                        top = avatarRect.bottom + GAP;
                        popup.classList.add('top-position');
                        if (top + ph > vh - SAFE_MARGIN) top = Math.max(SAFE_MARGIN, vh - SAFE_MARGIN - ph);
                    } else {
                        popup.classList.remove('top-position');
                    }
                    popup.classList.remove('emerged-from-drawer');
                }
                popup.style.top = top + 'px';
                
                // ç®­å¤´å¯¹å‡†å¤´åƒä¸­å¿ƒï¼šåœ¨å¼¹çª—å†…çš„æ°´å¹³åç§»ï¼Œå¹¶é™åˆ¶åœ¨å¼¹çª—å†…
                const popupRect = popup.getBoundingClientRect();
                const avatarCenterX = avatarRect.left + avatarRect.width / 2;
                let arrowLeftPx = avatarCenterX - popupRect.left;
                arrowLeftPx = Math.max(16, Math.min(pw - 16, arrowLeftPx));
                popup.style.setProperty('--arrow-left', arrowLeftPx + 'px');
            };
            
            updatePosition();
            const onUpdate = () => updatePosition();
            window.addEventListener('resize', onUpdate);
            window.addEventListener('scroll', onUpdate, true);
            
            // å¼¹çª—å†…æ»šè½®ä¸å†’æ³¡åˆ°å¤§åœ°å›¾ï¼Œé¿å…å½±å“åœ°å›¾ç¼©æ”¾ï¼›å¼¹çª—å†…åˆ—è¡¨ä»å¯æ­£å¸¸æ»šåŠ¨
            const stopWheel = (e) => {
                e.stopPropagation();
            };
            popup.addEventListener('wheel', stopWheel, { passive: true });
            
            popup._cleanup = () => {
                window.removeEventListener('resize', onUpdate);
                window.removeEventListener('scroll', onUpdate, true);
                popup.removeEventListener('wheel', stopWheel);
            };
            
            // ä¸ºæŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const messageBtn = popup.querySelector('[data-action="message"]');
            const inboxBtn = popup.querySelector('[data-action="inbox"]');
            const repoBtn = popup.querySelector('[data-action="repo"]');
            
            if (messageBtn) {
                messageBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    if (popup._cleanup) popup._cleanup();
                    popup.remove();
                    currentPopupElement = null;
                    var toId = avatarElement.getAttribute('data-to-id') || avatarElement.getAttribute('data-github-id') || userName;
                    openMessageSender(toId, userName);
                });
            }
            
            if (inboxBtn) {
                inboxBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    if (popup._cleanup) popup._cleanup();
                    popup.remove();
                    currentPopupElement = null;
                    if (typeof openInboxDrawer === 'function') openInboxDrawer();
                });
            }
            
            if (repoBtn) {
                repoBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    if (popup._cleanup) popup._cleanup();
                    popup.remove();
                    currentPopupElement = null;
                    const githubIdForRepo = repoBtn.getAttribute('data-github-id');
                    if (githubIdForRepo) {
                        window.open(`https://github.com/${githubIdForRepo}`, '_blank');
                    }
                });
            }
            
            // ä» window.allRankResources ä¸­é€šè¿‡ github_username æ£€ç´¢ä»“åº“åˆ—è¡¨ï¼Œæœ‰åˆ™æ¸²æŸ“ï¼Œæ— åˆ™è¯·æ±‚ API å¹¶å†™å…¥ç¼“å­˜
            function formatRepoUpdatedAt(isoStr) {
                if (!isoStr) return '';
                try {
                    const d = new Date(isoStr);
                    const now = new Date();
                    const diffMs = now - d;
                    const diffDays = Math.floor(diffMs / 86400000);
                    if (diffDays === 0) return 'ä»Šå¤©æ›´æ–°';
                    if (diffDays === 1) return 'æ˜¨å¤©æ›´æ–°';
                    if (diffDays < 7) return diffDays + ' å¤©å‰';
                    if (diffDays < 30) return Math.floor(diffDays / 7) + ' å‘¨å‰';
                    return d.getFullYear() + '/' + (d.getMonth() + 1) + '/' + d.getDate();
                } catch { return ''; }
            }
            function renderRepoList(repos, repoListEl) {
                if (!repoListEl) return;
                try { if (window.myRadarChart) window.myRadarChart.destroy(); window.myRadarChart = null; } catch (e) { /* ignore */ }
                if (!repos || repos.length === 0) {
                    var emptyMsg = (typeof isValidGitHubUsername === 'function' && isValidGitHubUsername(githubId))
                        ? 'è¯¥ç”¨æˆ·æš‚æ— å…¬å¼€ä»“åº“'
                        : 'è¯¥ç”¨æˆ·ä¸ºè®¿å®¢æˆ–æœªç»‘å®š GitHubï¼Œæ— ä»“åº“ä¿¡æ¯';
                    repoListEl.innerHTML = '<div class="user-popup-repo-item user-popup-repo-empty" style="color: rgba(255,255,255,0.4); cursor: default;">' + emptyMsg + '</div>';
                    return;
                }
                var star = function (r) { return r.stargazersCount != null ? r.stargazersCount : (r.stargazers_count != null ? r.stargazers_count : 0); };
                var sorted = repos.slice().sort(function (a, b) { return star(b) - star(a); });
                var top = sorted[0];
                var starsNum = star(top);
                var desc = (top.description || '').trim();
                var updatedStr = formatRepoUpdatedAt(top.updatedAt || top.updated_at);
                var repoUrl = top.url || top.html_url || '#';
                repoListEl.innerHTML = '<a class="user-popup-repo-star-card" href="' + escapeHtml(repoUrl) + '" target="_blank" rel="noopener">' +
                    '<div class="repo-card-name" title="' + escapeHtml(top.name || '') + '">' + escapeHtml(top.name || '') + '</div>' +
                    (desc ? '<div class="repo-card-desc" title="' + escapeHtml(desc) + '">' + escapeHtml(desc) + '</div>' : '') +
                    '<div class="repo-card-meta">' +
                    '<span class="repo-card-stars">' + starsNum + ' â˜…</span>' +
                    (updatedStr ? '<span class="repo-card-updated">' + escapeHtml(updatedStr) + '</span>' : '') +
                    '</div></a>';
            }
            function renderRepoLoadError(repoListEl, githubId) {
                if (!repoListEl || !githubId) return;
                var profileUrl = 'https://github.com/' + encodeURIComponent(githubId) + '?tab=repositories';
                repoListEl.innerHTML = '<div class="user-popup-repo-item user-popup-repo-empty">' +
                    '<span style="color: rgba(255,255,255,0.4);">åŠ è½½å¤±è´¥</span>' +
                    '<a class="user-popup-repo-fallback-link" href="' + escapeHtml(profileUrl) + '" target="_blank" rel="noopener">å‰å¾€ GitHub æŸ¥çœ‹</a>' +
                    '</div>';
            }
            function getCachedReposByUsername(username) {
                if (!window.allRankResources || !username) return undefined;
                var lower = String(username).toLowerCase();
                if (window.allRankResources[lower] !== undefined) return window.allRankResources[lower];
                var key = Object.keys(window.allRankResources).find(function (k) {
                    return String(k).toLowerCase() === lower;
                });
                return key ? window.allRankResources[key] : undefined;
            }
            function setCachedReposByUsername(username, repos) {
                if (!username) return;
                if (!window.allRankResources) window.allRankResources = {};
                window.allRankResources[String(username).toLowerCase()] = repos;
            }
            (function () {
                var repoListEl = popup.querySelector('#repo-list-' + userIndex);
                if (!repoListEl) return;
                var fingerprint = (avatarElement && avatarElement.getAttribute('data-fingerprint')) || '';
                var githubIdForApi = (typeof sanitizeGitHubIdForApi === 'function') ? sanitizeGitHubIdForApi(githubId, fingerprint) : githubId;
                if (!window.allRankResources) window.allRankResources = {};
                var cached = getCachedReposByUsername(githubIdForApi);
                if (cached !== undefined && Array.isArray(cached)) {
                    renderRepoList(cached, repoListEl);
                    return;
                }
                fetchUserRepos(githubIdForApi).then(function (repos) {
                    setCachedReposByUsername(githubIdForApi, repos);
                    renderRepoList(repos, popup.querySelector('#repo-list-' + userIndex));
                }).catch(function () {
                    var el = popup.querySelector('#repo-list-' + userIndex);
                    if (el) renderRepoLoadError(el, githubId);
                });
            })();
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­å¼¹çª—
            setTimeout(() => {
                const closePopupOnClickOutside = (e) => {
                    if (popup.contains(e.target) || avatarElement.contains(e.target)) return;
                    if (popup._cleanup) popup._cleanup();
                    popup.remove();
                    currentPopupElement = null;
                    document.removeEventListener('click', closePopupOnClickOutside, true);
                };
                document.addEventListener('click', closePopupOnClickOutside, true);
            }, 200);
        }
        
        /**
         * è·å–ç”¨æˆ·ä»“åº“åˆ—è¡¨ï¼ˆä¼˜å…ˆç¼“å­˜ï¼Œå¦åˆ™è¯·æ±‚åç«¯ä»£ç† /api/github-proxy/:username é¿å… 403/CSPï¼‰
         */
        async function fetchUserRepos(githubId) {
            if (!githubId || !isValidGitHubUsername(githubId)) {
                return [];
            }
            var base = (document.querySelector('meta[name="api-endpoint"]') && document.querySelector('meta[name="api-endpoint"]').content) || '';
            if (base && !base.endsWith('/')) base = base + '/';
            var proxyUrl = base ? (base + 'api/github-proxy/' + encodeURIComponent(githubId)) : ('/api/github-proxy/' + encodeURIComponent(githubId));
            const response = await fetch(proxyUrl, {
                headers: { 'Accept': 'application/json' }
            });
            if (!response.ok) {
                throw new Error('GitHub proxy ' + response.status);
            }
            const repos = await response.json();
            if (!Array.isArray(repos)) throw new Error('Invalid response');
            return repos.map(function (repo) {
                return {
                    name: repo.name,
                    fullName: repo.full_name,
                    url: repo.html_url,
                    description: repo.description || '',
                    updatedAt: repo.updated_at || '',
                    stargazersCount: typeof repo.stargazers_count === 'number' ? repo.stargazers_count : 0
                };
            });
        }
        
        /**
         * æ‰“å¼€ç§ä¿¡å‘é€æ¨¡æ€æ¡†ï¼ˆAPI ç‰ˆï¼šPOST /api/v2/message/sendï¼‰
         * @param {string} toId - ç›®æ ‡ç”¨æˆ· IDï¼ˆfingerprint æˆ– github_idï¼‰
         * @param {string} toName - ç›®æ ‡ç”¨æˆ·æ˜¾ç¤ºå
         */
        function openMessageSender(toId, toName) {
            var overlay = document.createElement('div');
            overlay.className = 'message-input-overlay';
            overlay.style.zIndex = '1001';
            overlay.onclick = function(e) {
                if (e.target === overlay) overlay.remove();
            };
            var fp = '';
            try { fp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
            var score = 0;
            try {
                var cu = window.currentUser || {};
                var vs = cu.vibe_index || cu.vibeIndex || (cu.detailedStats && cu.detailedStats[0] && cu.detailedStats[0].vibe_index);
                if (typeof vs === 'number' && !isNaN(vs)) score = Math.round(vs);
                else if (typeof vs === 'string') score = parseInt(vs, 10) || 0;
            } catch (_) {}
            overlay.innerHTML = `
                <div class="message-input-box" onclick="event.stopPropagation()">
                    <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest">å‘é€æš—å·ç»™ ${escapeHtml(toName || toId || '')}</div>
                    <textarea id="msgSenderText" maxlength="200" rows="4" placeholder="è¾“å…¥å†…å®¹ï¼ˆé™200å­—ï¼‰" class="w-full bg-zinc-900/50 border border-zinc-800 px-3 py-2 rounded text-sm text-white placeholder-zinc-600 focus:outline-none focus:border-[var(--accent-terminal)] resize-none"></textarea>
                    <div class="text-[10px] text-zinc-600 mt-1 text-right"><span id="msgCharCount">0</span>/200</div>
                    <div class="flex gap-2 mt-3">
                        <button id="msgSenderSendBtn" class="flex-1 px-4 py-2 bg-[var(--accent-terminal)]/20 border border-[var(--accent-terminal)] text-[var(--accent-terminal)] text-xs font-bold uppercase tracking-wider hover:bg-[var(--accent-terminal)]/30 transition-colors">å‘é€</button>
                        <button class="px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-xs font-bold uppercase tracking-wider hover:bg-zinc-700 transition-colors" onclick="this.closest('.message-input-overlay').remove()">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            var ta = document.getElementById('msgSenderText');
            var sendBtn = document.getElementById('msgSenderSendBtn');
            var charCount = document.getElementById('msgCharCount');
            if (ta) ta.focus();
            function updateCount() { if (charCount) charCount.textContent = (ta && ta.value ? ta.value.length : 0); }
            if (ta) { ta.addEventListener('input', updateCount); updateCount(); }
            if (sendBtn) {
                sendBtn.addEventListener('click', async function() {
                    var content = (ta && ta.value || '').trim();
                    if (!content) { alert('è¯·è¾“å…¥å†…å®¹'); return; }
                    sendBtn.disabled = true;
                    var base = (typeof API_ENDPOINT_MANAGER !== 'undefined' && API_ENDPOINT_MANAGER.getCurrent && API_ENDPOINT_MANAGER.getCurrent()) || document.querySelector('meta[name="api-endpoint"]')?.content || '';
                    var url = (base.replace(/\/$/, '') || '') + '/api/v2/message/send?fingerprint=' + encodeURIComponent(fp) + '&_t=' + Date.now();
                    try {
                        var res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                toUserId: toId,
                                toName: toName || toId,
                                content: content,
                                fingerprint: fp,
                                score: score,
                                username: (window.currentUser && (window.currentUser.user_name || window.currentUser.name)) || (typeof localStorage !== 'undefined' ? localStorage.getItem('github_username') : '') || '',
                                avatar: (window.currentUser && (window.currentUser.user_metadata && window.currentUser.user_metadata.avatar_url || window.currentUser.avatar_url)) || (typeof getGitHubAvatarUrl === 'function' ? getGitHubAvatarUrl((window.currentUser && (window.currentUser.user_name || window.currentUser.name)) || (typeof localStorage !== 'undefined' ? localStorage.getItem('github_username') : '') || '') : '') || ''
                            })
                        });
                        var data = res.ok ? (await res.json().catch(function() { return {}; })) : {};
                        if (res.ok && (data.success !== false && data.status !== 'error')) {
                            overlay.remove();
                            if (typeof showNotification === 'function') showNotification('æš—å·å·²é€è¾¾ï¼Œ1å°æ—¶åè‡ªæ¯');
                            else alert('æš—å·å·²é€è¾¾ï¼Œ1å°æ—¶åè‡ªæ¯');
                            if (typeof window.refreshUserStats === 'function') window.refreshUserStats();
                        } else {
                            sendBtn.disabled = false;
                            alert(data.error || data.message || 'å‘é€å¤±è´¥');
                        }
                    } catch (err) {
                        sendBtn.disabled = false;
                        alert('å‘é€å¤±è´¥: ' + (err && err.message || 'ç½‘ç»œé”™è¯¯'));
                    }
                });
            }
        }

        /** ç§ä¿¡æ”¶ä»¶ç®±ï¼šæ‰€æœ‰ await ç½®äº async IIFE å†…ï¼Œé¿å…é¡¶å±‚ await æŠ¥é”™ */
        (async function() {
        window.__inboxReadSecretIds = window.__inboxReadSecretIds || new Set();

        function closeInboxDrawer() {
            var el = document.getElementById('private-inbox-drawer');
            if (el) el.classList.remove('active');
        }
        function openInboxDrawer() {
            var el = document.getElementById('private-inbox-drawer');
            if (el) { el.classList.add('active'); loadInbox(); }
        }
        window.closeInboxDrawer = closeInboxDrawer;
        window.openInboxDrawer = openInboxDrawer;

        function refreshHasNewMessage() {
            var hasNew = (window.__inboxLastList || []).some(function(item) {
                return item.secretId && !window.__inboxReadSecretIds.has(item.secretId);
            });
            document.querySelectorAll('.inbox-indicator').forEach(function(el) {
                if (hasNew) el.classList.add('has-new'); else el.classList.remove('has-new');
            });
        }
        function updateInboxRedDotFromApi(hasNew) {
            try {
                // è‡ªåŠ¨çº¢ç‚¹ï¼šç¬¬ä¸€æ—¶é—´æ›´æ–° #msg-dotï¼ŒhasNew ä¸ºçœŸæ—¶æ— éœ€ç”¨æˆ·ç‚¹å‡»çº¢ç‚¹å¿…é¡»äº®èµ·
                var msgDot = document.getElementById('msg-dot');
                if (msgDot && typeof msgDot.classList !== 'undefined') {
                    if (hasNew) { msgDot.classList.remove('hidden'); msgDot.style.display = ''; }
                    else { msgDot.classList.add('hidden'); msgDot.style.display = 'none'; }
                }
                document.querySelectorAll('.inbox-indicator').forEach(function(el) {
                    if (hasNew) {
                        el.classList.add('has-new');
                        el.classList.remove('hidden');
                    } else {
                        el.classList.remove('has-new', 'hidden');
                    }
                });
            } catch (e) { /* ä¸é˜»å¡ä¸»é€»è¾‘ */ }
        }
        window.updateInboxRedDotFromApi = updateInboxRedDotFromApi;
        window.updateMsgDot = updateInboxRedDotFromApi;

        async function loadInbox() {
            var body = document.getElementById('inbox-body');
            if (!body) return;
            var fp = '';
            try { fp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
            if (!fp) {
                body.innerHTML = '<div class="text-zinc-500 text-center py-8 text-xs">è¯·å…ˆå®Œæˆåˆ†æä»¥è·å–æ”¶ä»¶ç®±</div>';
                return;
            }
            body.innerHTML = '<div class="text-zinc-500 text-center py-8 text-xs">åŠ è½½ä¸­...</div>';
            var base = (typeof API_ENDPOINT_MANAGER !== 'undefined' && API_ENDPOINT_MANAGER.getCurrent && API_ENDPOINT_MANAGER.getCurrent()) || document.querySelector('meta[name="api-endpoint"]')?.content || '';
            var url = (base.replace(/\/$/, '') || '') + '/api/v2/message/inbox?userId=' + encodeURIComponent(fp) + '&_t=' + Date.now();
            try {
                var res = await fetch(url);
                var data = res.ok ? (await res.json().catch(function() { return { list: [] }; })) : { list: [] };
                var list = Array.isArray(data.list) ? data.list : (data.items || data.messages || []);
                window.__inboxLastList = list;
                list = list.filter(function(item) {
                    var sid = item.secretId || item.secret_id || item.id || '';
                    return !window.__inboxReadSecretIds.has(sid);
                });
                refreshHasNewMessage();
                if (list.length === 0) {
                    body.innerHTML = '<div class="text-zinc-500 text-center py-8 text-xs">æš‚æ— ç§ä¿¡</div>';
                    return;
                }
                body.innerHTML = list.map(function(item) {
                    // æ”¶ä»¶ç®±å±•ç¤ºï¼šä¼˜å…ˆè¯»å– item.senderName å’Œ item.senderAvatar
                    var senderName = item.senderName || item.sender_name || item.username || item.from
                        || (item.fromUserId || item.from ? String(item.fromUserId || item.from).substring(0, 8) : null)
                        || 'åŒ¿å';
                    var senderAvatar = item.senderAvatar || item.sender_avatar || item.avatar || '';
                    if (!senderName && (item.fromUserId || item.from)) senderName = String(item.fromUserId || item.from).substring(0, 8);
                    if (!senderName) senderName = 'åŒ¿å';
                    var score = item.score != null ? item.score : (item.senderScore != null ? item.senderScore : '-');
                    var time = item.sentAt || item.sent_at || item.createdAt || item.created_at || '';
                    if (time && /^\d{4}/.test(time)) {
                        try {
                            var d = new Date(time);
                            time = d.getMonth() + 1 + '/' + d.getDate() + ' ' + (d.getHours() < 10 ? '0' : '') + d.getHours() + ':' + (d.getMinutes() < 10 ? '0' : '') + d.getMinutes();
                        } catch (_) {}
                    }
                    var secretId = item.secretId || item.secret_id || item.id || '';
                    var read = window.__inboxReadSecretIds.has(secretId);
                    var avatarHtml = senderAvatar
                        ? '<img src="' + escapeHtml(senderAvatar) + '" alt="" class="w-8 h-8 rounded-full object-cover flex-shrink-0" onerror="this.style.display=\'none\'">'
                        : '<div class="w-8 h-8 rounded-full bg-zinc-700 flex-shrink-0 flex items-center justify-center text-[10px] text-zinc-400">' + escapeHtml(senderName.substring(0, 1)) + '</div>';
                    return '<div class="inbox-item flex items-center gap-3" data-secret-id="' + escapeHtml(secretId) + '">' +
                        avatarHtml +
                        '<div class="flex-1 min-w-0">' +
                        '<div class="inbox-item-info">' + escapeHtml(senderName) + ' Â· ' + escapeHtml(String(score)) + ' Â· ' + escapeHtml(time) + '</div>' +
                        '</div>' +
                        '<button type="button" class="inbox-item-btn" data-action="view" data-secret-id="' + escapeHtml(secretId) + '">' + (read ? 'å·²é˜…' : 'æŸ¥çœ‹') + '</button>' +
                        '</div>';
                }).join('');
                body.querySelectorAll('[data-action="view"]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var sid = btn.getAttribute('data-secret-id');
                        if (sid) openBurnReader(sid, function() {
                            window.__inboxReadSecretIds.add(sid);
                            loadInbox();
                            refreshHasNewMessage();
                        });
                    });
                });
            } catch (err) {
                body.innerHTML = '<div class="text-zinc-500 text-center py-8 text-xs">åŠ è½½å¤±è´¥</div>';
            }
        }
        window.loadInbox = loadInbox;

        function openBurnReader(secretId, onClose) {
            var overlay = document.createElement('div');
            overlay.className = 'burn-reader-overlay';
            overlay.innerHTML = '<div class="burn-reader-box"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><span class="inbox-title" style="margin:0">é˜…åå³ç„š</span><button type="button" class="inbox-close" data-burn-close>âœ•</button></div><div class="burn-reader-content">åŠ è½½ä¸­...</div><div class="burn-reader-countdown">15 ç§’åè‡ªæ¯</div></div>';
            overlay.onclick = function(e) { if (e.target === overlay) { overlay.remove(); if (onClose) onClose(); } };
            overlay.querySelector('[data-burn-close]').addEventListener('click', function() { overlay.remove(); if (onClose) onClose(); });
            document.body.appendChild(overlay);
            var box = overlay.querySelector('.burn-reader-box');
            var contentEl = overlay.querySelector('.burn-reader-content');
            var countEl = overlay.querySelector('.burn-reader-countdown');
            var base = (typeof API_ENDPOINT_MANAGER !== 'undefined' && API_ENDPOINT_MANAGER.getCurrent && API_ENDPOINT_MANAGER.getCurrent()) || document.querySelector('meta[name="api-endpoint"]')?.content || '';
            var fp = '';
            try { fp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
            var url = (base.replace(/\/$/, '') || '') + '/api/v2/message/read?secretId=' + encodeURIComponent(secretId) + (fp ? '&userId=' + encodeURIComponent(fp) : '') + '&_t=' + Date.now();
            fetch(url).then(function(res) { return res.json(); }).catch(function() { return {}; }).then(function(data) {
                var text = data.content || data.message || data.text || (data.error || 'æ— æ³•åŠ è½½');
                if (contentEl) contentEl.textContent = text;
            });
            var sec = 15;
            function tick() {
                if (countEl) countEl.textContent = sec + ' ç§’åè‡ªæ¯';
                if (sec <= 0) {
                    overlay.remove();
                    if (onClose) onClose();
                    return;
                }
                sec--;
                setTimeout(tick, 1000);
            }
            tick();
        }

        })();

        /**
         * æ‰“å¼€ç§ä¿¡è¾“å…¥æ¡†ï¼ˆBroadcast ç‰ˆï¼Œä¿ç•™å…¼å®¹ï¼‰
         * @param {string} targetUserId - ç›®æ ‡ç”¨æˆ·ID
         */
        function openMessageInput(targetUserId) {
                        if (!presenceChannel) {
                 // è‡ªåŠ¨å°è¯•é‡è¿
                 console.log('[Message] âš ï¸ Presence æœªè¿æ¥ï¼Œæ­£åœ¨å°è¯•é‡è¿...');
                 startRealtimeListener().then(() => {
                     // é‡è¿åå»¶è¿Ÿä¸€ç‚¹å†æ‰“å¼€ï¼Œç¡®ä¿ channel ready
                     setTimeout(() => {
                         if (presenceChannel) {
                            openMessageInput(targetUserId);
                         } else {
                            alert('æ— æ³•è¿æ¥åˆ°å³æ—¶é€šè®¯æœåŠ¡ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                         }
                     }, 1000);
                 });
                 return;
            }

            // æ£€æŸ¥ç›®æ ‡ç”¨æˆ·æ˜¯å¦å¿™ç¢Œ
            const presenceState = presenceChannel ? presenceChannel.presenceState() : {};
            let targetUserBusy = false;
            
            Object.keys(presenceState).forEach((key) => {
                const presenceEntries = presenceState[key];
                const entries = Array.isArray(presenceEntries) ? presenceEntries : [presenceEntries];
                entries.forEach(entry => {
                    const userName = entry.user_name || entry.github_id || entry.github_username || '';
                    if (userName === targetUserId && entry.status === 'busy') {
                        targetUserBusy = true;
                    }
                });
            });
            
            if (targetUserBusy) {
                const currentUserId = localStorage.getItem('github_username') || null;
                if (targetUserId !== currentUserId) {
                    alert('è¯¥ç”¨æˆ·å½“å‰å¿™ç¢Œï¼Œæ— æ³•æ¥æ”¶æ¶ˆæ¯');
                    return;
                }
            }
            
            // éšè—å¼¹çª—
            const popup = document.querySelector('.user-popup');
            if (popup) {
                if (popup._cleanup) popup._cleanup();
                popup.remove();
                currentPopupElement = null;
            }
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'message-input-overlay';
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            };
            
            // åˆ›å»ºè¾“å…¥æ¡†
            const inputBox = document.createElement('div');
            inputBox.className = 'message-input-box';
            inputBox.onclick = (e) => e.stopPropagation();
            
            inputBox.innerHTML = `
                <div class="text-[10px] text-zinc-500 mb-2 uppercase tracking-widest">å‘é€ç§ä¿¡ç»™ ${targetUserId}</div>
                <textarea 
                    id="messageTextInput" 
                    placeholder="è¾“å…¥æ¶ˆæ¯ï¼ˆé˜…åå³ç„šï¼Œ5ç§’åè‡ªåŠ¨é”€æ¯ï¼‰"
                    class="w-full bg-zinc-900/50 border border-zinc-800 px-3 py-2 rounded text-sm text-white placeholder-zinc-600 focus:outline-none focus:border-[var(--accent-terminal)] transition-colors resize-none"
                    rows="4"
                ></textarea>
                <div class="flex gap-2 mt-3">
                    <button 
                        onclick="sendMessage('${targetUserId}')"
                        class="flex-1 px-4 py-2 bg-[var(--accent-terminal)]/20 border border-[var(--accent-terminal)] text-[var(--accent-terminal)] text-xs font-bold uppercase tracking-wider hover:bg-[var(--accent-terminal)]/30 transition-colors"
                    >
                        å‘é€
                    </button>
                    <button 
                        onclick="this.closest('.message-input-overlay').remove()"
                        class="px-4 py-2 bg-zinc-800 border border-zinc-700 text-zinc-400 text-xs font-bold uppercase tracking-wider hover:bg-zinc-700 transition-colors"
                    >
                        å–æ¶ˆ
                    </button>
                </div>
            `;
            
            overlay.appendChild(inputBox);
            document.body.appendChild(overlay);
            
            // èšç„¦è¾“å…¥æ¡†
            setTimeout(() => {
                const textarea = document.getElementById('messageTextInput');
                if (textarea) textarea.focus();
            }, 100);
        }
        
        /**
         * æ˜¾ç¤ºå‘é€æˆåŠŸæç¤º
         * @param {string} message - æç¤ºæ¶ˆæ¯
         */
        function showNotification(message) {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-[var(--accent-terminal)]/20 border border-[var(--accent-terminal)] px-4 py-2 rounded text-[var(--accent-terminal)] text-xs font-bold uppercase tracking-wider z-50';
            notification.textContent = message;
            notification.style.animation = 'popup-appear 0.3s ease-out';
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'popup-destroy 0.3s ease-out forwards';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        /**
         * å‘é€ç§ä¿¡ï¼ˆä½¿ç”¨Broadcastï¼‰ã€‚async ä½œç”¨åŸŸå†…è°ƒç”¨ await startRealtimeListener()
         */
        async function sendMessage(targetUserId) {
            const textarea = document.getElementById('messageTextInput');
            const message = textarea?.value.trim();
            
            if (!message) {
                alert('æ¶ˆæ¯ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            if (!presenceChannel) {
                console.warn('[Message] âš ï¸ å‘é€æ—¶å‘ç°è¿æ¥ä¸¢å¤±ï¼Œå°è¯•é‡è¿...');
                await startRealtimeListener();
                if (!presenceChannel) {
                    alert('è¿æ¥æ–­å¼€ï¼Œæ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                    return;
                }
                // è¿æ¥æ¢å¤ï¼Œç»§ç»­æ‰§è¡Œå‘é€
                console.log('[Message] âœ… è¿æ¥å·²æ¢å¤ï¼Œé‡è¯•å‘é€');
            }
            
            const myId = localStorage.getItem('github_username') || null;
            const githubUsername = myId || 'Guest';
            const statusConfig = USER_STATUSES[currentUserStatus];
            const avatarUrl = (typeof getGitHubAvatarUrl === 'function' ? getGitHubAvatarUrl(githubUsername) : null) || (window.currentUser && (window.currentUser.user_metadata && window.currentUser.user_metadata.avatar_url || window.currentUser.avatar_url)) || '';
            
            // ä½¿ç”¨Broadcastå‘é€æ¶ˆæ¯ï¼ˆå« usernameã€avatar ä¾¿äºæ¥æ”¶æ–¹å±•ç¤ºï¼‰
            presenceChannel.send({
                type: 'broadcast',
                event: 'burn_msg',
                payload: {
                    from: githubUsername,
                    to: targetUserId,
                    target_id: targetUserId,
                    content: message,
                    message: message,
                    username: (window.currentUser && (window.currentUser.user_name || window.currentUser.name)) || githubUsername,
                    avatar: avatarUrl,
                    timestamp: new Date().toISOString(),
                    status_color: statusConfig.status_color
                }
            });
            
            console.log('[Message] âœ… ç§ä¿¡å·²å‘é€:', { from: githubUsername, to: targetUserId, message });
            
            // ğŸ’¡ ä¿®å¤é€»è¾‘ï¼šå¦‚æœæ˜¯å‘ç»™è‡ªå·±ï¼Œç›´æ¥åœ¨æœ¬åœ°è¿è¡Œæ˜¾ç¤ºé€»è¾‘
            if (targetUserId === myId || targetUserId === githubUsername) {
                // è‡ªæ¥æ”¶ï¼šç›´æ¥æ˜¾ç¤ºæ¶ˆæ¯
                showBurnMsg(message, githubUsername, statusConfig.status_color);
                console.log('[Message] ğŸ”„ è‡ªæ¥æ”¶æ¶ˆæ¯å·²æ˜¾ç¤º');
            } else {
                // å‘é€ç»™ä»–äººï¼šæ˜¾ç¤ºå‘é€æˆåŠŸæç¤º
                showNotification('å¯†ä¿¡å·²å‘å‡º');
            }
            
            // å…³é—­è¾“å…¥æ¡†
            const overlay = document.querySelector('.message-input-overlay');
            if (overlay) overlay.remove();
        }
        
        // å…¨å±€å˜é‡ï¼šç”¨äºç®¡ç†å€’è®¡æ—¶ï¼Œé˜²æ­¢å¤šä¸ªå¼¹çª—é‡å 
        let currentBurnMsgInterval = null;
        let currentBurnMsgPopup = null;

        /**
         * ç»Ÿä¸€æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°ï¼ˆé˜…åå³ç„šå¼¹çª—ï¼‰
         * @param {string} content - æ¶ˆæ¯å†…å®¹
         * @param {string} displayName - å‘é€è€…æ˜¾ç¤ºåï¼ˆä¼˜å…ˆç”¨æˆ·åï¼Œæ— åˆ™ ID å‰ 8 ä½ï¼‰
         * @param {string} statusColor - çŠ¶æ€é¢œè‰²ï¼ˆå¯é€‰ï¼‰
         * @param {string} avatarUrl - å¤´åƒ URLï¼ˆå¯é€‰ï¼‰
         */
        function showBurnMsg(content, displayName, statusColor = '#00ff41', avatarUrl = '') {
            // å¦‚æœå·²æœ‰å¼¹çª—ï¼Œå…ˆæ¸…é™¤æ—§çš„å€’è®¡æ—¶
            if (currentBurnMsgInterval) {
                clearInterval(currentBurnMsgInterval);
                currentBurnMsgInterval = null;
            }
            
            // å¦‚æœå·²æœ‰å¼¹çª—ï¼Œå…ˆç§»é™¤
            if (currentBurnMsgPopup) {
                currentBurnMsgPopup.classList.add('destroying');
                setTimeout(() => {
                    if (currentBurnMsgPopup && currentBurnMsgPopup.parentNode) {
                        currentBurnMsgPopup.remove();
                    }
                }, 300);
            }
            
            // åˆ›å»ºæ–°å¼¹çª—
            const popup = document.createElement('div');
            popup.className = 'message-popup';
            currentBurnMsgPopup = popup;
            
            let countdown = 5;
            
            const myId = localStorage.getItem('github_username') || null;
            const isSelf = displayName === myId || displayName === 'ç³»ç»Ÿ (è‡ªä¼ )';
            const fromLabel = isSelf ? 'ç³»ç»Ÿ (è‡ªä¼ )' : (displayName || 'åŒ¿å');
            
            const avatarHtml = avatarUrl ? `<img src="${escapeHtml(avatarUrl)}" alt="" class="w-6 h-6 rounded-full object-cover mr-2" onerror="this.style.display='none'">` : '';
            popup.innerHTML = `
                <div class="flex items-center gap-3 mb-3">
                    ${avatarHtml}
                    <div class="text-[10px] text-zinc-500 uppercase tracking-widest">From: ${escapeHtml(fromLabel)}</div>
                    <div class="flex-1"></div>
                    <div class="text-[10px] font-bold" style="color: ${statusColor};" id="countdown-${Date.now()}">5ç§’</div>
                </div>
                <div class="text-white text-sm mb-3 font-mono" style="min-height: 60px; word-break: break-word;">${escapeHtml(content)}</div>
                <div class="text-[9px] text-zinc-600 font-mono">é˜…åå³ç„š // è‡ªåŠ¨é”€æ¯</div>
            `;
            
            document.body.appendChild(popup);
            
            // å€’è®¡æ—¶é€»è¾‘ï¼ˆç¡®ä¿æ¯æ¬¡æ–°æ¶ˆæ¯åˆ°è¾¾æ—¶éƒ½èƒ½æ­£ç¡®é‡ç½®ï¼‰
            const countdownId = `countdown-${Date.now()}`;
            const countdownEl = popup.querySelector(`#${countdownId}`);
            
            currentBurnMsgInterval = setInterval(() => {
                countdown--;
                if (countdownEl) {
                    countdownEl.textContent = `${countdown}ç§’`;
                }
                
                if (countdown <= 0) {
                    clearInterval(currentBurnMsgInterval);
                    currentBurnMsgInterval = null;
                    // é”€æ¯åŠ¨ç”»
                    popup.classList.add('destroying');
                    setTimeout(() => {
                        if (popup && popup.parentNode) {
                            popup.remove();
                        }
                        if (currentBurnMsgPopup === popup) {
                            currentBurnMsgPopup = null;
                        }
                    }, 500);
                }
            }, 1000);
        }

        /**
         * æ˜¾ç¤ºç§ä¿¡å¼¹çª—ï¼ˆæ¥æ”¶ç«¯ï¼‰- å…¼å®¹æ—§å‡½æ•°å
         * @param {Object} messageData - æ¶ˆæ¯æ•°æ®
         */
        function showMessagePopup(messageData) {
            const content = messageData.content || messageData.message || '';
            const fromId = messageData.from || 'Unknown';
            const statusColor = messageData.status_color || '#00ff41';
            const displayName = messageData.username || (fromId && fromId.length > 8 ? fromId.substring(0, 8) : fromId) || 'åŒ¿å';
            showBurnMsg(content, displayName, statusColor, messageData.avatar || '');
        }
        
        /**
         * GitHub OAuth ç™»å½•
         * è°ƒç”¨ Supabase Auth çš„ signInWithOAuth æ–¹æ³•
         */
        async function loginWithGitHub() {
            if (!supabaseClient) {
                console.error('[Auth] âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                alert('æ•°æ®åº“è¿æ¥æœªå°±ç»ªï¼Œè¯·ç¨å€™å†è¯•');
                return;
            }
            
            try {
                console.log('[Auth] ğŸš€ å¼€å§‹ GitHub OAuth ç™»å½•æµç¨‹...');
                // é‡å®šå‘åœ°å€å¿…é¡»ä¸ Supabase æ§åˆ¶å° â†’ Authentication â†’ URL Configuration â†’ Redirect URLs ä¸­é…ç½®ä¸€è‡´
                const redirectTo = window.location.origin + window.location.pathname;
                console.log('[Auth] é‡å®šå‘åœ°å€ï¼ˆè¯·åœ¨ Supabase ä¸­å·²æ·»åŠ ï¼‰:', redirectTo);
                
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'github',
                    options: {
                        redirectTo: redirectTo,
                        scopes: 'read:user user:email',
                    }
                });
                
                if (error) {
                    console.error('[Auth] âŒ GitHub OAuth ç™»å½•å¤±è´¥:', error);
                    alert(`ç™»å½•å¤±è´¥: ${error.message}`);
                    return;
                }
                
                if (data?.url) {
                    window.location.href = data.url;
                } else {
                    console.log('[Auth] âœ… ç™»å½•è¯·æ±‚å·²å‘é€ï¼Œç­‰å¾…é‡å®šå‘...');
                }
            } catch (error) {
                console.error('[Auth] âŒ GitHub OAuth ç™»å½•å¼‚å¸¸:', error);
                alert(`ç™»å½•å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
        }
        window.loginWithGitHub = loginWithGitHub;
        
        /**
         * é€€å‡ºç™»å½•
         * æ¸…ç†ä¼šè¯å’Œæœ¬åœ°æ•°æ®
         */
        async function logout() {
            if (!supabaseClient) {
                console.error('[Auth] âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                console.log('[Auth] ğŸšª å¼€å§‹é€€å‡ºç™»å½•...');
                
                // æ¸…ç† localStorage
                localStorage.removeItem('github_username');
                // ä¿ç•™ fingerprintï¼Œä»¥ä¾¿é™é»˜ç™»å½•
                
                // è°ƒç”¨ Supabase Auth é€€å‡º
                const { error } = await supabaseClient.auth.signOut();
                
                if (error) {
                    console.error('[Auth] âŒ é€€å‡ºç™»å½•å¤±è´¥:', error);
                    alert(`é€€å‡ºå¤±è´¥: ${error.message}`);
                    return;
                }
                
                // æ¸…ç†å…¨å±€å˜é‡
                window.currentUser = null;
                window.currentUserMatchedByFingerprint = false;
                
                // åˆ·æ–° UI
                updateAuthUI(null);
                
                // åˆ·æ–°æ’åå¡ç‰‡ï¼ˆæ˜¾ç¤ºå…¨çƒæœ€å¼ºæ¨¡å¼ï¼‰
                renderRankCards(null);
                
                console.log('[Auth] âœ… å·²é€€å‡ºç™»å½•');
                alert('å·²é€€å‡ºç™»å½•');
                
            } catch (error) {
                console.error('[Auth] âŒ é€€å‡ºç™»å½•å¼‚å¸¸:', error);
                alert(`é€€å‡ºå¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
            }
        }
        
        /**
         * æ˜¾ç¤ºåŒæ­¥é®ç½©
         */
        function showSyncingOverlay() {
            try {
                const leftDrawer = document.getElementById('left-drawer');
                const leftBody = document.getElementById('left-drawer-body');
                
                if (!leftDrawer || !leftBody) {
                    console.warn('[Auth] âš ï¸ æ— æ³•æ‰¾åˆ°æŠ½å±‰å…ƒç´ ï¼Œè·³è¿‡æ˜¾ç¤ºåŒæ­¥é®ç½©');
                    return;
                }
                
                // ç§»é™¤æ—§çš„åŒæ­¥å ä½ç¬¦ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const existingSyncingCards = leftBody.querySelectorAll('.drawer-item');
                existingSyncingCards.forEach(card => {
                    const label = card.querySelector('.drawer-item-label');
                    if (label && label.textContent === 'æ•°æ®åŒæ­¥ä¸­') {
                        card.remove();
                    }
                });
                
                // åˆ›å»º"æ•°æ®åŒæ­¥ä¸­"å ä½ç¬¦å¡ç‰‡
                const loadingCard = document.createElement('div');
                loadingCard.className = 'drawer-item';
                loadingCard.id = 'syncing-overlay-card';
                loadingCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">â³</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                            SYNCING
                        </span>
                    </div>
                    <div class="drawer-item-label mb-2">æ•°æ®åŒæ­¥ä¸­</div>
                    <div class="text-[10px] text-[#00ff41]/60 mb-3">
                        æ­£åœ¨è¿ç§»æŒ‡çº¹æ•°æ®ï¼Œè¯·ç¨å€™...
                    </div>
                    <div class="flex items-center space-x-2 mb-2">
                        <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                `;
                
                // å…ˆç§»é™¤æ—§çš„ç»Ÿè®¡å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const existingStatsCards = leftBody.querySelectorAll('.drawer-item:not(#syncing-overlay-card)');
                existingStatsCards.forEach(card => card.remove());
                
                // æ·»åŠ åŒæ­¥å ä½ç¬¦
                leftBody.appendChild(loadingCard);
                
                // ç¡®ä¿æŠ½å±‰æ‰“å¼€
                if (!leftDrawer.classList.contains('active')) {
                    leftDrawer.classList.add('active');
                }
                
                console.log('[Auth] âœ… å·²æ˜¾ç¤ºåŒæ­¥é®ç½©');
            } catch (error) {
                console.error('[Auth] âŒ æ˜¾ç¤ºåŒæ­¥é®ç½©å¤±è´¥:', error);
            }
        }
        
        /**
         * éšè—åŒæ­¥é®ç½©
         */
        function hideSyncingOverlay() {
            try {
                const leftBody = document.getElementById('left-drawer-body');
                if (!leftBody) {
                    console.warn('[Auth] âš ï¸ æ— æ³•æ‰¾åˆ°æŠ½å±‰ body å…ƒç´ ï¼Œè·³è¿‡éšè—åŒæ­¥é®ç½©');
                    return;
                }
                
                // ç§»é™¤åŒæ­¥å ä½ç¬¦å¡ç‰‡
                const syncingCard = document.getElementById('syncing-overlay-card');
                if (syncingCard) {
                    syncingCard.remove();
                    console.log('[Auth] âœ… å·²ç§»é™¤åŒæ­¥é®ç½©');
                }
                
                // å¦‚æœæœ‰å½“å‰ç”¨æˆ·æ•°æ®ï¼Œé‡æ–°æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡ï¼ˆä¼˜å…ˆä½¿ç”¨ allData ä¸­çš„å®Œæ•´è®°å½•ï¼‰
                if (window.currentUser) {
                    renderUserStatsCards(leftBody, getBestUserRecordForStats(window.currentUser));
                }
            } catch (error) {
                console.error('[Auth] âŒ éšè—åŒæ­¥é®ç½©å¤±è´¥:', error);
            }
        }
        
        /**
         * å¤„ç†è®¤è¯çŠ¶æ€å˜åŒ–
         * å½“ç”¨æˆ·ç™»å½•/é€€å‡ºæ—¶è‡ªåŠ¨è°ƒç”¨
         * @param {Object} session - Supabase ä¼šè¯å¯¹è±¡
         */
        async function handleAuthStateChange(session) {
            console.log('[Auth] ğŸ”” è®¤è¯çŠ¶æ€å˜åŒ–:', session ? 'å·²ç™»å½•' : 'æœªç™»å½•');
            
            // è¶…æ—¶å…œåº•å®šæ—¶å™¨
            let timeoutTimer = null;
            
            // ç¡®ä¿ finally å—ä¸­èƒ½è®¿é—®çš„å˜é‡
            let migrationCompleted = false;
            
            try {
                if (session && session.user) {
                    const user = session.user;
                    console.log('[Auth] ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯:', {
                        id: user.id,
                        email: user.email,
                        user_metadata: user.user_metadata
                    });
                    
                    // ä» user_metadata ä¸­æå– GitHub ä¿¡æ¯
                    // GitHub OAuth è¿”å›çš„æ•°æ®é€šå¸¸åœ¨ user_metadata ä¸­
                    const githubUsername = user.user_metadata?.user_name || 
                                         user.user_metadata?.preferred_username ||
                                         user.user_metadata?.login ||
                                         user.email?.split('@')[0] || // é™çº§ï¼šä½¿ç”¨é‚®ç®±å‰ç¼€
                                         null;
                    
                    const avatarUrl = user.user_metadata?.avatar_url || 
                                    user.user_metadata?.picture ||
                                    (githubUsername ? getGitHubAvatarUrl(githubUsername) : null) ||
                                    DEFAULT_AVATAR;
                    
                    if (!githubUsername) {
                        console.warn('[Auth] âš ï¸ æ— æ³•ä» user_metadata ä¸­æå– GitHub ç”¨æˆ·å');
                        updateAuthUI(null);
                        return;
                    }
                    
                    console.log('[Auth] âœ… æå–åˆ° GitHub ä¿¡æ¯:', {
                        username: githubUsername,
                        avatarUrl: avatarUrl
                    });
                    
                    // ä¿å­˜åˆ° localStorageï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
                    localStorage.setItem('github_username', githubUsername);
                    
                    // ã€å˜é‡ä¿®æ­£ã€‘ç»Ÿä¸€ä½¿ç”¨ currentFp å˜é‡
                    // ã€ä¿®å¤ã€‘ç¡®ä¿åœ¨è°ƒç”¨ migrate æ¥å£å‰ï¼Œä»£ç èƒ½å¤Ÿæ­£ç¡®ä» localStorage è·å– user_fingerprint
                    let currentFp = null;
                    try {
                        // ä¼˜å…ˆå°è¯•ä» localStorage è·å–ï¼Œè¿™æ˜¯åŒ¿åç”¨æˆ·æ•°æ®çš„å”¯ä¸€æ ‡è¯†
                        currentFp = localStorage.getItem('user_fingerprint') || window.fpId;
                    } catch (e) {
                        console.warn('[Auth] âš ï¸ è¯»å– localStorage user_fingerprint å¤±è´¥:', e);
                    }
                    
                    if (!currentFp) {
                        console.warn('[Auth] âš ï¸ æ— æ³•è·å–æŒ‡çº¹ï¼Œå°è¯•ç”Ÿæˆ...');
                        try {
                            const generatedFp = await getCurrentFingerprint();
                            if (generatedFp) {
                                currentFp = generatedFp;
                                window.fpId = generatedFp;
                                try {
                                    localStorage.setItem('user_fingerprint', generatedFp);
                                } catch (e) {
                                    console.warn('[Auth] âš ï¸ å†™å…¥ localStorage user_fingerprint å¤±è´¥:', e);
                                }
                            }
                        } catch (genError) {
                            console.error('[Auth] âŒ ç”ŸæˆæŒ‡çº¹å¤±è´¥:', genError);
                        }
                    }
                    
                    const githubUserId = user.id; // ä» Supabase Auth ç”¨æˆ·å¯¹è±¡è·å– user_id
                    let migrationSuccess = false;
                    
                    // ã€è¿ç§»ä¼˜å…ˆã€‘åœ¨æ£€æµ‹åˆ° GitHub ç™»å½•åï¼Œå…ˆè°ƒç”¨ /api/fingerprint/migrate æ¥å£
                    if (currentFp && githubUserId) {
                        const token = localStorage.getItem('user_fingerprint');
                        if (!token) {
                            console.log('[Auth] çº¯å‡€ç™»å½•ï¼Œæ— åŒ¿åæ•°æ®éœ€è¿ç§»');
                        } else {
                        console.log('[Auth] ğŸ”„ æ£€æµ‹åˆ°æŒ‡çº¹å’Œ GitHub ç”¨æˆ·ï¼Œå¼€å§‹æ•°æ®è¿ç§»...');
                        console.log('[Auth] ğŸ“‹ è¿ç§»ä¿¡æ¯:', {
                            currentFp: currentFp.substring(0, 8) + '...',
                            githubUserId: githubUserId.substring(0, 8) + '...',
                            username: githubUsername
                        });
                        
                        // ã€åˆå¹¶ç¡®è®¤å¼¹çª—ã€‘åœ¨è¿ç§»å‰æ£€æŸ¥æ˜¯å¦éœ€è¦ç”¨æˆ·ç¡®è®¤
                        const claimToken = localStorage.getItem('vibe_claim_token');
                        const hasLocalData = claimToken || currentFp;
                        const localDataExists = localStorage.getItem('last_analysis_data') || claimToken;
                        
                        // ã€è®¤é¢†å¤‡é€‰ã€‘æœ‰ claimToken ç”¨è®¤é¢†ï¼Œæ— åˆ™ç”¨æœ¬åœ° fingerprint ä½œä¸ºå¤‡é€‰ï¼Œç¡®ä¿åŒ¿åæ•°æ®èƒ½åˆå¹¶åˆ° GitHub
                        // å¦‚æœéœ€è¦ç¡®è®¤ï¼Œå…ˆæ˜¾ç¤ºå¼¹çª—
                        if (hasLocalData && localDataExists) {
                            const shouldMerge = await new Promise((resolve) => {
                                const dialog = document.createElement('div');
                                dialog.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
                                dialog.id = 'merge-confirm-dialog';
                                dialog.innerHTML = `
                                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-2">æ•°æ®åˆå¹¶ç¡®è®¤</h3>
                                        <p class="text-sm text-gray-600 mb-4">æ£€æµ‹åˆ°æ‚¨æœ‰æœªå½’æ¡£çš„æˆ˜ç»©ï¼Œæ˜¯å¦åˆå¹¶åˆ° GitHub è´¦å·ï¼Ÿ</p>
                                        <div class="flex gap-3 justify-end">
                                            <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors" id="merge-cancel">å–æ¶ˆ</button>
                                            <button class="px-4 py-2 text-sm font-medium text-black bg-[var(--accent-terminal)] rounded-md hover:bg-[var(--accent-terminal)]/80 transition-colors" id="merge-confirm">åˆå¹¶</button>
                                        </div>
                                    </div>
                                `;
                                document.body.appendChild(dialog);
                                
                                const removeDialog = () => {
                                    const dialogElement = document.getElementById('merge-confirm-dialog');
                                    if (dialogElement && dialogElement.parentNode) {
                                        dialogElement.parentNode.removeChild(dialogElement);
                                    }
                                };
                                
                                dialog.querySelector('#merge-confirm')?.addEventListener('click', () => {
                                    removeDialog();
                                    resolve(true);
                                });
                                
                                dialog.querySelector('#merge-cancel')?.addEventListener('click', () => {
                                    removeDialog();
                                    resolve(false);
                                });
                            });
                            
                            if (!shouldMerge) {
                                console.log('[Auth] â„¹ï¸ ç”¨æˆ·å–æ¶ˆåˆå¹¶ï¼Œè·³è¿‡è¿ç§»');
                                return;
                            }
                        }
                        
                        // æ˜¾ç¤ºåŒæ­¥é®ç½©
                        showSyncingOverlay();
                        
                        // è®¾ç½® 8 ç§’è¶…æ—¶å…œåº•
                        timeoutTimer = setTimeout(() => {
                            if (!migrationCompleted) {
                                console.warn('[Auth] âš ï¸ è¿ç§»æ¥å£è¶…æ—¶ï¼ˆ8ç§’ï¼‰ï¼Œå¼ºåˆ¶æ‰§è¡Œ hideSyncingOverlay()');
                                migrationCompleted = true;
                                hideSyncingOverlay();
                            }
                        }, 8000);
                        
                        try {
                            // ã€Task 1ã€‘è·å– API åŸºå‡†åœ°å€
                            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || 
                                              'https://cursor-clinical-analysis.psterman.workers.dev/';
                            var _mfp = '';
                            try { _mfp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                            const migrateUrl = `${apiEndpoint}api/fingerprint/migrate?fingerprint=${encodeURIComponent(_mfp)}&_t=${Date.now()}`;
                            
                            console.log('[Auth] ğŸ“¡ ä½¿ç”¨ API åœ°å€:', migrateUrl);
                            
                            // ã€ä¿®å¤ AbortErrorã€‘æ·»åŠ  AbortController å’Œè¶…æ—¶å¤„ç†
                            const abortController = new AbortController();
                            const timeoutId = setTimeout(() => {
                                abortController.abort();
                            }, 10000); // 10ç§’è¶…æ—¶
                            
                            let migrateResponse;
                            try {
                                // è°ƒç”¨åç«¯æ¥å£è¿ç§»æ•°æ®
                                // Bodyï¼šuserId å¿…é€‰ï¼›claimToken ä¼˜å…ˆï¼Œæ— åˆ™ç”¨ fingerprint ä½œä¸ºå¤‡é€‰è®¤é¢†
                                const userId = localStorage.getItem('github_username') || 'anonymous';
                                const migrateBody = {
                                    userId: githubUserId || userId
                                };
                                if (claimToken) {
                                    migrateBody.claimToken = claimToken;
                                    console.log('[Auth] ğŸ”‘ ä½¿ç”¨ vibe_claim_token è®¤é¢†:', claimToken.substring(0, 8) + '...');
                                } else {
                                    migrateBody.fingerprint = currentFp;
                                    migrateBody.sourceFp = currentFp;
                                    console.log('[Auth] ğŸ”‘ æ—  claimTokenï¼Œä½¿ç”¨æœ¬åœ° fingerprint è®¤é¢†:', currentFp.substring(0, 8) + '...');
                                }

                                migrateResponse = await fetch(migrateUrl, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${session.access_token}` // ä¼ é€’è®¤è¯ token
                                    },
                                    body: JSON.stringify(migrateBody),
                                    signal: abortController.signal // æ·»åŠ  signal æ”¯æŒå–æ¶ˆ
                                });
                                
                                clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                            } catch (fetchError) {
                                clearTimeout(timeoutId); // ç¡®ä¿æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                                
                                // å¤„ç† AbortError
                                if (fetchError.name === 'AbortError' || fetchError.message?.includes('aborted')) {
                                    console.warn('[Auth] âš ï¸ è¿ç§»è¯·æ±‚è¢«å–æ¶ˆï¼ˆè¶…æ—¶æˆ–é¡µé¢åˆ·æ–°ï¼‰:', fetchError);
                                    throw new Error('è¯·æ±‚è¶…æ—¶æˆ–è¢«å–æ¶ˆï¼Œè¯·ç¨åé‡è¯•');
                                }
                                throw fetchError; // é‡æ–°æŠ›å‡ºå…¶ä»–é”™è¯¯
                            }
                            
                            // æ¸…é™¤è¶…æ—¶å…œåº•å®šæ—¶å™¨
                            if (timeoutTimer) {
                                clearTimeout(timeoutTimer);
                                timeoutTimer = null;
                            }
                            
                            // ã€Task 4ã€‘ä¿®å¤ JSON è§£æå¼‚å¸¸ï¼šæ£€æŸ¥å“åº”çŠ¶æ€å’Œ Content-Type
                            let migrateResult = null;
                            if (migrateResponse.status !== 204) {
                                const contentType = migrateResponse.headers.get('content-type') || '';
                                if (contentType.includes('application/json')) {
                                    try {
                                        migrateResult = await migrateResponse.json();
                                    } catch (jsonError) {
                                        console.error('[Auth] âŒ JSON è§£æå¤±è´¥:', jsonError);
                                        const responseText = await migrateResponse.text();
                                        console.error('[Auth] å“åº”å†…å®¹:', responseText);
                                        throw new Error(`JSON è§£æå¤±è´¥: ${jsonError.message}`);
                                    }
                                } else {
                                    const responseText = await migrateResponse.text();
                                    console.warn('[Auth] âš ï¸ å“åº”ä¸æ˜¯ JSON æ ¼å¼:', {
                                        status: migrateResponse.status,
                                        contentType: contentType,
                                        responseText: responseText.substring(0, 200)
                                    });
                                    throw new Error(`å“åº”æ ¼å¼é”™è¯¯: ${contentType}`);
                                }
                            } else {
                                console.log('[Auth] â„¹ï¸ å“åº”çŠ¶æ€ä¸º 204 No Contentï¼Œè·³è¿‡ JSON è§£æ');
                                migrateResult = { status: 'success', data: null };
                            }
                            
                            // ã€ä¿®å¤ 404 é”™è¯¯å¤„ç†ã€‘æ£€æŸ¥å“åº”çŠ¶æ€
                            if (!migrateResponse.ok) {
                                const errorMsg = migrateResult?.error || `HTTP ${migrateResponse.status}: ${migrateResponse.statusText}`;
                                console.warn('[Auth] âš ï¸ è¿ç§»æ¥å£è¿”å›é”™è¯¯:', {
                                    status: migrateResponse.status,
                                    statusText: migrateResponse.statusText,
                                    error: errorMsg
                                });
                                
                                // å¦‚æœæ˜¯ 404ï¼Œè¯´æ˜è·¯ç”±ä¸å­˜åœ¨æˆ–æœªéƒ¨ç½²ï¼Œç»§ç»­æ­£å¸¸æµç¨‹
                                if (migrateResponse.status === 404) {
                                    console.log('[Auth] â„¹ï¸ è¿ç§»æ¥å£ä¸å­˜åœ¨ï¼ˆ404ï¼‰ï¼Œè·³è¿‡è¿ç§»ï¼Œç»§ç»­æ­£å¸¸æµç¨‹');
                                    // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œåç»­é€»è¾‘
                                } else if (migrateResponse.status === 400 && (errorMsg.includes('claim_token') || errorMsg.includes('æ— æ•ˆ'))) {
                                    // ã€æ ¸å¿ƒä¿®å¤ã€‘ä»¤ç‰Œç¡®å®æ— æ•ˆæˆ–å·²è¿‡æœŸ,å¿…é¡»æ¸…é™¤,å¦åˆ™ç”¨æˆ·æ¯æ¬¡ç™»å½•éƒ½ä¼šæŠ¥é”™
                                    console.warn('[Auth] âš ï¸ æ£€æµ‹åˆ°å¤±æ•ˆçš„å½±å­ä»¤ç‰Œ,æ­£åœ¨å¼ºåˆ¶æ¸…é™¤æœ¬åœ°ç¼“å­˜...');
                                    localStorage.removeItem('vibe_claim_token');
                                    localStorage.removeItem('user_fingerprint'); // åŒæ—¶æ¸…é™¤æŒ‡çº¹
                                } else {
                                    // å…¶ä»–é”™è¯¯ï¼Œè®°å½•ä½†ä¸ä¸­æ–­æµç¨‹ï¼ˆç¡®ä¿ä¸è¾“å‡º undefinedï¼‰
                                    const msg = (errorMsg != null && String(errorMsg).trim() !== '') ? String(errorMsg) : `HTTP ${migrateResponse.status || 0} ${migrateResponse.statusText || ''}`.trim() || 'æœªçŸ¥';
                                    console.warn('[Auth] âš ï¸ æ•°æ®è¿ç§»å¤±è´¥ï¼Œç»§ç»­æ­£å¸¸æµç¨‹:', msg);
                                }

                                // æ— è®ºä»€ä¹ˆé”™è¯¯ï¼Œéƒ½ç»§ç»­æ­£å¸¸æµç¨‹ï¼ˆä¸è¿ç§»ï¼‰ï¼›ä¿è¯ error æœ‰å¯è¯»å…œåº•
                                migrateResult = { status: 'error', error: (errorMsg != null && String(errorMsg).trim() !== '') ? errorMsg : (migrateResponse.status ? `HTTP ${migrateResponse.status} ${migrateResponse.statusText || ''}`.trim() : 'æœªçŸ¥') };
                            }
                            
                            migrationCompleted = true;
                            // migrate è¿”å› 200 åç«‹å³åˆ·æ–°å¸¦æ’åçš„æ•°æ®ï¼ˆskipped æ—¶ä¹Ÿæ‹‰å–æœ€æ–°æ’åï¼‰
                            if (migrateResponse.ok && migrateResult?.status !== 'success' && typeof window.refreshUserStats === 'function') {
                                try { await window.refreshUserStats(); } catch (_) {}
                            }
                            if (migrateResult && migrateResult.status === 'success') {
                                console.log('[Auth] âœ… Step A: æ•°æ®è¿ç§»æˆåŠŸ:', migrateResult.data);
                                migrationSuccess = true;
                                
                                // ã€è®¤é¢†åã€‘æ¸…é™¤æœ¬åœ°åŒ¿åç¼“å­˜ï¼Œç¡®ä¿åç»­æ•°æ®ç»Ÿä¸€æ¥è‡ªè§†å›¾ v_unified_analysis_v2
                                localStorage.removeItem('vibe_claim_token');
                                localStorage.removeItem('user_fingerprint');
                                if (window.fpId) delete window.fpId;
                                if (window.__countryTotalsCache) window.__countryTotalsCache.clear();
                                try { localStorage.removeItem('last_analysis_data'); } catch (_) {}
                                console.log('[Auth] âœ… å·²æ¸…é™¤åŒ¿åç¼“å­˜ï¼Œå°†å¼ºåˆ¶åˆ·æ–°è§†å›¾æ•°æ®');
                                
                                // è¿ç§»æˆåŠŸåï¼Œæ›´æ–° window.allData
                                const allData = window.allData || [];
                                const migratedUser = migrateResult.data;
                                
                                // ç§»é™¤æ—§çš„æŒ‡çº¹è®°å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                                const oldIndex = allData.findIndex(item => 
                                    item.fingerprint === currentFp && item.id !== githubUserId
                                );
                                if (oldIndex !== -1) {
                                    allData.splice(oldIndex, 1);
                                }
                                
                                // æ·»åŠ æˆ–æ›´æ–°è¿ç§»åçš„ç”¨æˆ·æ•°æ®
                                const newIndex = allData.findIndex(item => item.id === githubUserId);
                                if (newIndex !== -1) {
                                    allData[newIndex] = { ...allData[newIndex], ...migratedUser };
                                } else {
                                    allData.push(migratedUser);
                                }
                                window.allData = allData;
                                
                                // è®¾ç½®å½“å‰ç”¨æˆ·ä¸ºè¿ç§»åçš„ç”¨æˆ·
                                window.currentUser = migratedUser;
                                window.currentUserMatchedByFingerprint = false; // ç°åœ¨æ˜¯é€šè¿‡ GitHub OAuth åŒ¹é…çš„
                                
                                console.log('[Auth] âœ… èº«ä»½åˆå¹¶å®Œæˆï¼Œå†å²æ•°æ®å·²è¿ç§»åˆ° GitHub User ID');
                                
                                // ã€é¡ºåºé‡ç»„ã€‘Step B: è°ƒç”¨ autoReportSelfï¼ˆä¸ŠæŠ¥å½“å‰åœ°ç†ä½ç½®ï¼Œç¡®ä¿ GitHub è´¦å·æœ‰äº† lat/lngï¼‰
                                // ã€å»é‡ã€‘è‹¥æœ¬é¡µå·²æ‰§è¡Œè¿‡è‡ªåŠ¨ä¸ŠæŠ¥åˆ™è·³è¿‡ï¼Œé¿å… fingerprint/github æ•°æ®åœ¨åå°ç”Ÿæˆä¸¤æ¬¡
                                if (!window.__autoReportSelfOnce) {
                                    window.__autoReportSelfOnce = true;
                                    console.log('[Auth] ğŸ”„ Step B: å¼€å§‹ä¸ŠæŠ¥åœ°ç†ä½ç½®...');
                                    try {
                                        const reportResult = await autoReportSelf();
                                        if (reportResult.success) {
                                            console.log('[Auth] âœ… Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥æˆåŠŸ');
                                        } else {
                                            console.warn('[Auth] âš ï¸ Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥å¤±è´¥:', reportResult.error);
                                        }
                                    } catch (reportError) {
                                        console.error('[Auth] âŒ Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥å¼‚å¸¸:', reportError);
                                    }
                                } else {
                                    console.log('[Auth] â„¹ï¸ Step B: å·²åœ¨æœ¬é¡µæ‰§è¡Œè¿‡è‡ªåŠ¨ä¸ŠæŠ¥ï¼Œè·³è¿‡');
                                }
                                
                                // ã€è¿ç§»ä¼˜å…ˆã€‘æ¸…é™¤åŒ¿åç¼“å­˜åå¼ºåˆ¶åˆ·æ–°ï¼Œä½¿â€œæˆ‘çš„æ’åâ€ç­‰æ•°æ®ç»Ÿä¸€æ¥è‡ª v_unified_analysis_v2
                                console.log('[Auth] ğŸ”„ Step C: å¼ºåˆ¶åˆ·æ–°è§†å›¾æ•°æ®ï¼ˆfetchData + refreshUserStatsï¼‰...');
                                try {
                                    if (typeof fetchData === 'function') {
                                        await fetchData();
                                        console.log('[Auth] âœ… Step C: fetchData æ‰§è¡Œå®Œæˆ');
                                    }
                                } catch (e) {
                                    if (e?.name !== 'AbortError' && !e?.message?.includes('aborted')) console.warn('[Auth] âš ï¸ fetchData å¤±è´¥:', e);
                                }
                                if (typeof window.refreshUserStats === 'function') {
                                    try {
                                        await window.refreshUserStats();
                                        console.log('[Auth] âœ… Step C: refreshUserStats æ‰§è¡Œå®Œæˆ');
                                    } catch (refreshError) {
                                        if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                            console.log('[Auth] â„¹ï¸ refreshUserStats è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰');
                                        } else {
                                            const sm = (refreshError?.message || '').match(/Status:\s*(\d+)/);
                                            const st = sm ? sm[1] : (refreshError?.status ?? refreshError?.response?.status ?? 'N/A');
                                            console.error('[Auth] âŒ Step C: refreshUserStats æ‰§è¡Œå¤±è´¥ - å®Œæ•´é”™è¯¯:', {
                                                name: refreshError?.name, message: refreshError?.message,
                                                httpStatus: st, hint: st === '404' ? 'ï¼ˆå‡½æ•°/è·¯ç”±å¯èƒ½ä¸å­˜åœ¨ï¼‰' : (st === '403' ? 'ï¼ˆå¯èƒ½æ— æƒé™ï¼‰' : ''),
                                                fullError: refreshError
                                            });
                                        }
                                    }
                                } else {
                                    console.warn('[Auth] âš ï¸ window.refreshUserStats å‡½æ•°ä¸å­˜åœ¨');
                                }
                                
                                // æ›´æ–° UI
                                updateAuthUI({ username: githubUsername, avatarUrl });
                                
                                // éšè—åŒæ­¥é®ç½©
                                hideSyncingOverlay();
                                
                                return; // è¿ç§»æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­çš„æŒ‡çº¹ç»‘å®šé€»è¾‘
                            } else if (migrateResult && (migrateResult.status === 'not_found' || migrateResult.status === 'skipped')) {
                                console.log('[Auth] â„¹ï¸', migrateResult.status === 'skipped' ? 'è¿ç§»å·²è·³è¿‡ï¼ˆæ— å¾…è¿ç§»æ•°æ®ï¼‰ï¼Œç»§ç»­æ­£å¸¸æµç¨‹' : 'æœªæ‰¾åˆ°éœ€è¦è¿ç§»çš„æ•°æ®ï¼Œç»§ç»­æ­£å¸¸æµç¨‹');
                                hideSyncingOverlay();
                            } else {
                                const errMsg = (migrateResult?.error != null && String(migrateResult.error).trim() !== '')
                                    ? String(migrateResult.error)
                                    : (migrateResult?.status ? `è¿ç§»è¿”å› status=${migrateResult.status}` : 'æœªçŸ¥');
                                console.warn('[Auth] âš ï¸ æ•°æ®è¿ç§»å¤±è´¥ï¼Œç»§ç»­æ­£å¸¸æµç¨‹:', errMsg);
                                hideSyncingOverlay();
                            }
                        } catch (migrateError) {
                            migrationCompleted = true;
                            const errMsg = (migrateError && (migrateError.message || migrateError.toString?.())) || String(migrateError) || 'æœªçŸ¥';
                            // ã€ä¿®å¤ AbortErrorã€‘ç‰¹æ®Šå¤„ç† AbortError
                            if (migrateError && (migrateError.name === 'AbortError' || (migrateError.message && migrateError.message.includes('aborted')))) {
                                console.warn('[Auth] âš ï¸ è¿ç§»è¯·æ±‚è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰:', errMsg);
                            } else {
                                console.error('[Auth] âŒ æ•°æ®è¿ç§»å¼‚å¸¸ï¼Œç»§ç»­æ­£å¸¸æµç¨‹:', errMsg);
                            }
                            hideSyncingOverlay();
                        } finally {
                            // å®¹é”™ï¼šæ— è®ºè¿ç§»æˆåŠŸã€400 æˆ–å…¶ä»–é”™è¯¯ï¼Œéƒ½æ‰§è¡Œåˆ·æ–°ï¼Œé¿å…èº«ä»½è¿ç§»é˜»å¡ç•Œé¢
                            try {
                                if (typeof window.refreshUserStats === 'function') window.refreshUserStats();
                            } catch (e) { /* ignore */ }
                        }
                        }
                    } else {
                        console.log('[Auth] â„¹ï¸ æœªæ£€æµ‹åˆ°æŒ‡çº¹æˆ– GitHub ç”¨æˆ· IDï¼Œè·³è¿‡è¿ç§»');
                    }
                    
                    // ã€ä»…åœ¨è¿ç§»æœªæˆåŠŸæ—¶æ‰§è¡Œã€‘å…³é”®ç»‘å®šé€»è¾‘ï¼šç™»å½•åå¿…é¡»ä½¿ç”¨ user_id æ›´æ–°ï¼Œè€Œä¸æ˜¯ fingerprint
                    if (!migrationSuccess) {
                        console.log('[Auth] ğŸ”— è¿ç§»æœªæˆåŠŸï¼Œå¼€å§‹ä½¿ç”¨ GitHub User ID è¿›è¡Œæ•°æ®åŒæ­¥...');
                        
                        // ã€å…³é”®ä¿®å¤ã€‘ç™»å½•åå¿…é¡»ä½¿ç”¨ user_id è¿›è¡Œæ‰€æœ‰æ“ä½œï¼Œè€Œä¸æ˜¯ fingerprint
                        // è¿™æ˜¯"è®¤ç¥–å½’å®—"çš„å…³é”®ï¼šç¡®ä¿æ•°æ®å…³è”åˆ°æ­£ç¡®çš„ GitHub è´¦å·
                        const normalizedUsername = githubUsername.toLowerCase().trim();
                        
                        // ã€å˜é‡ä¿®æ­£ã€‘ç»Ÿä¸€ä½¿ç”¨ currentFp å˜é‡
                        const currentFp = window.fpId || localStorage.getItem('user_fingerprint') || await getCurrentFingerprint();
                        
                        console.log('[Auth] ğŸ”— ä½¿ç”¨ GitHub User ID æ‰§è¡Œ upsert æ“ä½œï¼Œid =', githubUserId.substring(0, 8) + '...');
                        
                        // é¦–å…ˆå°è¯•æ ¹æ® user_id æŸ¥æ‰¾ç°æœ‰ç”¨æˆ·
                        const { data: existingUserById, error: findByIdError } = await supabaseClient
                            .from('v_unified_analysis_v2')
                            .select('*')
                            .eq('id', githubUserId)
                            .maybeSingle();
                        
                        let updatedUser = null;
                        
                        if (existingUserById) {
                            // ç”¨æˆ·å·²å­˜åœ¨ï¼ˆé€šè¿‡ user_idï¼‰ï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯
                            console.log('[Auth] âœ… æ‰¾åˆ°ç°æœ‰ç”¨æˆ·ï¼ˆé€šè¿‡ user_idï¼‰ï¼Œæ›´æ–°ç”¨æˆ·ä¿¡æ¯');
                            
                            const updatePayload = {
                                user_name: normalizedUsername,
                                user_identity: 'github',
                                updated_at: new Date().toISOString()
                            };
                            
                            // å¦‚æœæœ‰ fingerprintï¼Œä¹Ÿæ›´æ–°ï¼ˆä½†ä¸ä½œä¸ºä¸»è¦æ ‡è¯†ï¼‰
                            if (currentFp) {
                                updatePayload.fingerprint = currentFp;
                            }
                            
                            const { data: updateData, error: updateError } = await supabaseClient
                                .from('user_analysis')
                                .update(updatePayload)
                                .eq('id', githubUserId) // ã€å…³é”®ã€‘ä½¿ç”¨ user_id è€Œä¸æ˜¯ fingerprint
                                .select()
                                .single();
                            
                            if (updateError) {
                                console.error('[Auth] âŒ æ›´æ–°ç”¨æˆ·å¤±è´¥:', updateError);
                                // å³ä½¿æ›´æ–°å¤±è´¥ï¼Œä¹Ÿç»§ç»­ä½¿ç”¨ç°æœ‰ç”¨æˆ·æ•°æ®
                                updatedUser = { ...existingUserById, ...updatePayload };
                            } else {
                                updatedUser = updateData;
                                console.log('[Auth] âœ… ç”¨æˆ·ä¿¡æ¯å·²æˆåŠŸæ›´æ–°ï¼ˆä½¿ç”¨ user_idï¼‰');
                            }
                        } else {
                            // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•ï¼ˆä½¿ç”¨ GitHub User IDï¼‰
                            console.log('[Auth] âœ… ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•ï¼ˆä½¿ç”¨ GitHub User IDï¼‰');
                            
                            const newUserData = {
                                id: githubUserId, // ã€å…³é”®ã€‘ä½¿ç”¨ GitHub User ID
                                user_name: normalizedUsername,
                                user_identity: 'github', // æ˜ç¡®è®¾ç½®èº«ä»½
                                fingerprint: currentFp || null, // å¯é€‰ï¼šå¦‚æœæœ‰ fingerprint ä¹Ÿä¿å­˜
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            };
                            
                            const { data: insertData, error: insertError } = await supabaseClient
                                .from('user_analysis')
                                .insert([newUserData])
                                .select()
                                .single();
                            
                            if (insertError) {
                                console.error('[Auth] âŒ åˆ›å»ºç”¨æˆ·å¤±è´¥:', insertError);
                                
                                // ã€RLS é”™è¯¯å¤„ç†ã€‘å¦‚æœæ˜¯ RLS ç­–ç•¥é”™è¯¯ï¼Œå°è¯•ä½¿ç”¨ upsert
                                if (insertError.code === '42501' || insertError.message?.includes('row-level security')) {
                                    console.log('[Auth] ğŸ”„ RLS ç­–ç•¥é˜»æ­¢æ’å…¥ï¼Œå°è¯•ä½¿ç”¨ upsert...');
                                    
                                    const { data: upsertData, error: upsertError } = await supabaseClient
                                        .from('user_analysis')
                                        .upsert([newUserData], { onConflict: 'id' })
                                        .select()
                                        .single();
                                    
                                    if (upsertError) {
                                        console.error('[Auth] âŒ Upsert ä¹Ÿå¤±è´¥:', upsertError);
                                        // å³ä½¿å¤±è´¥ï¼Œä¹Ÿç»§ç»­ä½¿ç”¨æ–°ç”¨æˆ·æ•°æ®
                                        updatedUser = newUserData;
                                    } else {
                                        updatedUser = upsertData;
                                        console.log('[Auth] âœ… é€šè¿‡ upsert åˆ›å»ºç”¨æˆ·æˆåŠŸ');
                                    }
                                } else {
                                    // å…¶ä»–é”™è¯¯ï¼Œç»§ç»­ä½¿ç”¨æ–°ç”¨æˆ·æ•°æ®
                                    updatedUser = newUserData;
                                }
                            } else {
                                updatedUser = insertData;
                                console.log('[Auth] âœ… æ–°ç”¨æˆ·å·²åˆ›å»ºï¼ˆä½¿ç”¨ GitHub User IDï¼‰');
                            }
                        }
                        
                        // æ›´æ–° window.allDataï¼ˆåœ¨ window.currentUser èµ‹å€¼ä¹‹åï¼‰
                        const allData = window.allData || [];
                        const index = allData.findIndex(item => 
                            item.id === updatedUser.id ||
                            (item.fingerprint && item.fingerprint === currentFp) ||
                            (item.user_name && item.user_name.toLowerCase() === normalizedUsername)
                        );
                        
                        if (index !== -1) {
                            allData[index] = { ...allData[index], ...updatedUser };
                        } else {
                            allData.push(updatedUser);
                        }
                        window.allData = allData;
                        
                        // ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨åˆå¹¶åçš„è®°å½•ä½œä¸º currentUserï¼Œç¡®ä¿å·¦ä¾§æŠ½å±‰èƒ½æ˜¾ç¤º allData ä¸­å·²æœ‰çš„ç»´åº¦/äººæ ¼/ç®´è¨€ç­‰å®Œæ•´æ•°æ®ï¼ˆè€Œéä»… upsert è¿”å›çš„ç®€ç•¥å­—æ®µï¼‰
                        window.currentUser = (index !== -1) ? allData[index] : updatedUser;
                        window.currentUserMatchedByFingerprint = true;
                        
                        // ã€Task 1ã€‘æ¸…é™¤æœ¬åœ°çš„ user_fingerprint ç¼“å­˜ï¼Œç»Ÿä¸€ä½¿ç”¨ Supabase User ID
                        localStorage.removeItem('user_fingerprint');
                        console.log('[Auth] âœ… å·²æ¸…é™¤æœ¬åœ° fingerprint ç¼“å­˜');
                        
                        // ã€Task 1ã€‘å¦‚æœå½“å‰ç”¨æˆ·æ˜¯æ–°æ³¨å†Œçš„ï¼ˆdimensions ä¸º nullï¼‰ï¼Œç«‹å³è§¦å‘ä¸€æ¬¡é™é»˜åˆ†æè¯·æ±‚
                        const hasDimensions = updatedUser.dimensions || 
                                            updatedUser.l_score !== null || 
                                            updatedUser.p_score !== null ||
                                            updatedUser.d_score !== null ||
                                            updatedUser.e_score !== null ||
                                            updatedUser.f_score !== null;
                        
                        if (!hasDimensions || 
                            (updatedUser.l_score === 50 && updatedUser.p_score === 50 && 
                             updatedUser.d_score === 50 && updatedUser.e_score === 50 && updatedUser.f_score === 50)) {
                            console.log('[Auth] ğŸ” æ£€æµ‹åˆ°æ–°ç”¨æˆ·ï¼ˆdimensions ä¸ºç©ºæˆ–ä¸ºé»˜è®¤å€¼ï¼‰ï¼Œè§¦å‘é™é»˜åˆ†æ...');
                            
                            // å°è¯•ä» localStorage è·å–æœ€åä¸€æ¬¡åˆ†ææ•°æ®
                            try {
                                const lastAnalysisData = localStorage.getItem('last_analysis_data');
                                if (lastAnalysisData) {
                                    const analysisData = JSON.parse(lastAnalysisData);
                                    console.log('[Auth] ğŸ“Š æ‰¾åˆ°æœ¬åœ°ç¼“å­˜çš„æœ€åä¸€æ¬¡åˆ†ææ•°æ®ï¼Œå‡†å¤‡åŒæ­¥...');
                                    
                                    // è°ƒç”¨åç«¯åˆ†ææ¥å£åŒæ­¥æ•°æ®
                                    if (analysisData.chatData && analysisData.chatData.length > 0) {
                                        try {
                                            // ã€å…³é”®ä¿®å¤ã€‘å¯¹é½ index.html æäº¤é“¾è·¯ï¼šä½¿ç”¨ /api/v2/analyzeï¼ˆä¼šæŒ‰ OAuth user_id æ­£ç¡® upsertï¼‰
                                            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || 
                                                              'https://cursor-clinical-analysis.psterman.workers.dev/';
                                            var _authFp = currentFp || '';
                                            try { if (!_authFp) _authFp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                                            const analyzeUrl = `${apiEndpoint}api/v2/analyze?fingerprint=${encodeURIComponent(_authFp)}&_t=${Date.now()}`;
                                            // å…¼å®¹ï¼šè‹¥ last_analysis_data é‡Œæ²¡æœ‰ lang/fingerprintï¼Œè¿™é‡Œè¡¥é½
                                            const safeLang = (analysisData && analysisData.lang) ? analysisData.lang : (localStorage.getItem('appLanguage') || 'zh-CN');
                                            const safeFp = currentFp || (analysisData && analysisData.fingerprint) || null;
                                            
                                            // å¦‚æœæ²¡æœ‰ chatDataï¼ˆå¯èƒ½å›  localStorage å®¹é‡é™åˆ¶è¢«é™çº§ï¼‰ï¼Œåˆ™åªåšæœ¬åœ°å›å¡«ï¼Œä¸å‘è¯·æ±‚
                                            if (!analysisData.chatData || !Array.isArray(analysisData.chatData) || analysisData.chatData.length === 0) {
                                                console.warn('[Auth] âš ï¸ last_analysis_data.chatData ç¼ºå¤±ï¼Œè·³è¿‡é™é»˜åŒæ­¥ï¼Œæ”¹ä¸ºæœ¬åœ°å›å¡«');
                                                
                                                // ç”¨æœ¬åœ°ç¼“å­˜çš„ç»´åº¦/ç»Ÿè®¡å›å¡«ï¼Œé¿å…ä¸€ç›´æ˜¾ç¤ºé»˜è®¤ 50
                                                try {
                                                    const cachedDims = analysisData.dimensions || null;
                                                    const cachedStats = analysisData.stats || null;
                                                    const patched = { ...updatedUser };
                                                    if (cachedDims) patched.dimensions = cachedDims;
                                                    if (cachedStats) patched.stats = cachedStats;
                                                    window.currentUser = patched;
                                                    
                                                    const allData2 = window.allData || [];
                                                    const userIndex2 = allData2.findIndex(item => item.id === patched.id);
                                                    if (userIndex2 !== -1) allData2[userIndex2] = { ...allData2[userIndex2], ...patched };
                                                    else allData2.push(patched);
                                                    window.allData = allData2;
                                                    
                                                    if (typeof window.refreshUserStats === 'function') {
                                                        try { await window.refreshUserStats(); } catch { /* ignore */ }
                                                    }
                                                } catch { /* ignore */ }
                                                return;
                                            }
                                            
                                            const analyzeResponse = await fetch(analyzeUrl, {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json',
                                                    'Authorization': `Bearer ${session.access_token}`
                                                },
                                                body: JSON.stringify({
                                                    ...analysisData,
                                                    // /api/v2/analyze è¯†åˆ«ç”¨æˆ·åå­—æ®µä¸º userNameï¼ˆé©¼å³°ï¼‰
                                                    userName: normalizedUsername,
                                                    lang: safeLang,
                                                    fingerprint: safeFp
                                                })
                                            });
                                            
                                            if (analyzeResponse.ok) {
                                                const analyzeResult = await analyzeResponse.json();
                                                console.log('[Auth] âœ… é™é»˜åˆ†æåŒæ­¥æˆåŠŸ:', analyzeResult);
                                                
                                                // ã€å¼ºåˆ¶å›ºåŒ–å­˜å‚¨ã€‘ä¿å­˜ claim_token åˆ° localStorage
                                                if (analyzeResult.claim_token) {
                                                    localStorage.setItem('vibe_claim_token', analyzeResult.claim_token);
                                                    console.log('[Auth] ğŸ”‘ å½±å­ä»¤ç‰Œå·²ä¿å­˜åˆ°æœ¬åœ°:', analyzeResult.claim_token.substring(0, 8) + '...');
                                                }
                                                
                                                // æ›´æ–° updatedUser æ•°æ®
                                                if (analyzeResult.dimensions) {
                                                    updatedUser = { ...updatedUser, ...analyzeResult };
                                                    window.currentUser = updatedUser;
                                                    
                                                    // æ›´æ–° allData
                                                    const allData = window.allData || [];
                                                    const userIndex = allData.findIndex(item => item.id === updatedUser.id);
                                                    if (userIndex !== -1) {
                                                        allData[userIndex] = updatedUser;
                                                    } else {
                                                        allData.push(updatedUser);
                                                    }
                                                    window.allData = allData;
                                                    
                                                    // ã€é™é»˜åˆ·æ–°ã€‘è§¦å‘é¡µé¢æ•°å€¼åˆ·æ–°
                                                    if (typeof window.refreshUserStats === 'function') {
                                                        try {
                                                            await window.refreshUserStats();
                                                            console.log('[Auth] âœ… é™é»˜åˆ·æ–°å®Œæˆ');
                                                        } catch (refreshError) {
                                                            console.warn('[Auth] âš ï¸ é™é»˜åˆ·æ–°å¤±è´¥:', refreshError);
                                                        }
                                                    }
                                                }
                                            } else {
                                                console.warn('[Auth] âš ï¸ é™é»˜åˆ†æåŒæ­¥å¤±è´¥:', await analyzeResponse.text());
                                            }
                                        } catch (analyzeError) {
                                            console.warn('[Auth] âš ï¸ é™é»˜åˆ†æåŒæ­¥å¼‚å¸¸:', analyzeError);
                                        }
                                    }
                                } else {
                                    console.log('[Auth] â„¹ï¸ æœªæ‰¾åˆ°æœ¬åœ°ç¼“å­˜çš„æœ€åä¸€æ¬¡åˆ†ææ•°æ®');
                                }
                            } catch (e) {
                                console.warn('[Auth] âš ï¸ è¯»å–æœ¬åœ°åˆ†ææ•°æ®å¤±è´¥:', e);
                            }
                        }
                        
                        // ã€é¡ºåºé‡ç»„ã€‘Step B: è°ƒç”¨ autoReportSelfï¼ˆä¸ŠæŠ¥å½“å‰åœ°ç†ä½ç½®ï¼Œç¡®ä¿ GitHub è´¦å·æœ‰äº† lat/lngï¼‰
                        // ã€å»é‡ã€‘è‹¥æœ¬é¡µå·²æ‰§è¡Œè¿‡è‡ªåŠ¨ä¸ŠæŠ¥åˆ™è·³è¿‡ï¼Œé¿å… fingerprint/github æ•°æ®åœ¨åå°ç”Ÿæˆä¸¤æ¬¡
                        if (!window.__autoReportSelfOnce) {
                            window.__autoReportSelfOnce = true;
                            console.log('[Auth] ğŸ”„ Step B: å¼€å§‹ä¸ŠæŠ¥åœ°ç†ä½ç½®...');
                            try {
                                const reportResult = await autoReportSelf();
                                if (reportResult.success) {
                                    console.log('[Auth] âœ… Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥æˆåŠŸ');
                                } else {
                                    console.warn('[Auth] âš ï¸ Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥å¤±è´¥:', reportResult.error);
                                }
                            } catch (reportError) {
                                console.error('[Auth] âŒ Step B: åœ°ç†ä½ç½®ä¸ŠæŠ¥å¼‚å¸¸:', reportError);
                            }
                        } else {
                            console.log('[Auth] â„¹ï¸ Step B: å·²åœ¨æœ¬é¡µæ‰§è¡Œè¿‡è‡ªåŠ¨ä¸ŠæŠ¥ï¼Œè·³è¿‡');
                        }
                        
                        // ã€é¡ºåºé‡ç»„ã€‘Step C: æœ€åè°ƒç”¨ window.refreshUserStats() åˆ·æ–°è§†å›¾æ•°æ®
                        console.log('[Auth] ğŸ”„ Step C: å¼€å§‹åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡æ•°æ®...');
                        if (typeof window.refreshUserStats === 'function') {
                            try {
                                await window.refreshUserStats();
                                console.log('[Auth] âœ… Step C: refreshUserStats æ‰§è¡Œå®Œæˆ');
                            } catch (refreshError) {
                                // ã€ä¿®å¤ AbortErrorã€‘ç‰¹æ®Šå¤„ç† AbortError
                                if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                    console.log('[Auth] â„¹ï¸ refreshUserStats è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰');
                                } else {
                                    const sm = (refreshError?.message || '').match(/Status:\s*(\d+)/);
                                    const st = sm ? sm[1] : (refreshError?.status ?? refreshError?.response?.status ?? 'N/A');
                                    console.error('[Auth] âŒ Step C: refreshUserStats æ‰§è¡Œå¤±è´¥ - å®Œæ•´é”™è¯¯:', {
                                        name: refreshError?.name, message: refreshError?.message,
                                        httpStatus: st, hint: st === '404' ? 'ï¼ˆå‡½æ•°/è·¯ç”±å¯èƒ½ä¸å­˜åœ¨ï¼‰' : (st === '403' ? 'ï¼ˆå¯èƒ½æ— æƒé™ï¼‰' : ''),
                                        fullError: refreshError
                                    });
                                }
                            }
                            
                            // ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿ refreshUserStats åï¼Œwindow.currentUser å·²æ­£ç¡®è®¾ç½®
                            // å¦‚æœ refreshUserStats æ²¡æœ‰è®¾ç½® currentUserï¼Œä½¿ç”¨ updatedUser
                            if (!window.currentUser && updatedUser) {
                                console.log('[Auth] ğŸ”„ refreshUserStats æœªè®¾ç½® currentUserï¼Œä½¿ç”¨ updatedUser');
                                window.currentUser = updatedUser;
                                
                                // æ›´æ–° allData
                                const allData = window.allData || [];
                                const userIndex = allData.findIndex(item => item.id === updatedUser.id);
                                if (userIndex !== -1) {
                                    allData[userIndex] = updatedUser;
                                } else {
                                    allData.push(updatedUser);
                                }
                                window.allData = allData;
                            }
                            
                            // ã€å…³é”®ä¿®å¤ã€‘å¦‚æœç”¨æˆ·æ•°æ®å·²å­˜åœ¨ä½†æ˜¾ç¤º"æ•°æ®åŒæ­¥ä¸­"ï¼Œå¼ºåˆ¶åˆ·æ–°ç»Ÿè®¡å¡ç‰‡
                            if (window.currentUser) {
                                const leftDrawer = document.getElementById('left-drawer');
                                const leftBody = document.getElementById('left-drawer-body');
                                
                                if (leftBody && typeof renderUserStatsCards === 'function') {
                                    // æ£€æŸ¥æ˜¯å¦æœ‰"æ•°æ®åŒæ­¥ä¸­"å ä½ç¬¦
                                    const syncingCards = leftBody.querySelectorAll('.drawer-item');
                                    let hasSyncingCard = false;
                                    syncingCards.forEach(card => {
                                        const label = card.querySelector('.drawer-item-label');
                                        if (label && (label.textContent === 'æ•°æ®åŒæ­¥ä¸­' || label.textContent.includes('SYNCING'))) {
                                            hasSyncingCard = true;
                                        }
                                    });
                                    
                                    if (hasSyncingCard) {
                                        console.log('[Auth] ğŸ”„ æ£€æµ‹åˆ°"æ•°æ®åŒæ­¥ä¸­"å ä½ç¬¦ï¼Œå¼ºåˆ¶åˆ·æ–°ç»Ÿè®¡å¡ç‰‡...');
                                        // ç§»é™¤æ‰€æœ‰ç»Ÿè®¡å¡ç‰‡ï¼ˆä¿ç•™èº«ä»½é…ç½®å¡ç‰‡ï¼‰
                                        syncingCards.forEach(card => {
                                            const label = card.querySelector('.drawer-item-label');
                                            if (label && (label.textContent === 'æ•°æ®åŒæ­¥ä¸­' || label.textContent.includes('SYNCING') || label.textContent === 'æˆ‘çš„æ•°æ®ç»Ÿè®¡')) {
                                                card.remove();
                                            }
                                        });
                                        // é‡æ–°æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ï¼ˆä¼˜å…ˆä½¿ç”¨ allData ä¸­çš„å®Œæ•´è®°å½•ï¼‰
                                        renderUserStatsCards(leftBody, getBestUserRecordForStats(window.currentUser));
                                        console.log('[Auth] âœ… å·²å¼ºåˆ¶åˆ·æ–°ç»Ÿè®¡å¡ç‰‡');
                                    }
                                }
                                
                                // åˆ·æ–°æ’åå¡ç‰‡
                                if (typeof renderRankCards === 'function') {
                                    renderRankCards(window.currentUser);
                                }
                            }
                        } else {
                            console.warn('[Auth] âš ï¸ window.refreshUserStats å‡½æ•°ä¸å­˜åœ¨');
                        }
                        
                        // æ›´æ–° UIï¼ˆç¡®ä¿åœ¨æ•°æ®åŠ è½½å®Œæˆåè§¦å‘ï¼‰
                        try {
                            updateAuthUI({ username: githubUsername, avatarUrl });
                            console.log('[Auth] âœ… UI å·²æ›´æ–°ä¸ºå·²ç™»å½•çŠ¶æ€');
                        } catch (uiError) {
                            console.error('[Auth] âŒ UI æ›´æ–°å¤±è´¥:', uiError);
                        }
                        
                        // è§¦å‘åœ°å›¾å®šä½è„‰å†²ï¼ˆç­‰å¾… window.allData åŠ è½½å®Œæˆï¼‰
                        try {
                            // ç¡®ä¿ window.allData å·²åŠ è½½
                            if (!window.allData || window.allData.length === 0) {
                                console.log('[Auth] âš ï¸ allData æœªåŠ è½½ï¼Œç­‰å¾…æ•°æ®åŠ è½½å®Œæˆ...');
                                // å»¶è¿Ÿæ‰§è¡Œï¼Œç­‰å¾… fetchData å®Œæˆ
                                setTimeout(async () => {
                                    try {
                                        const location = await getUserLocation();
                                        if (location && location.lat && location.lng && typeof triggerMapPulse === 'function') {
                                            const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                                            const pulseColor = statusConfig.status_color || '#00ff41';
                                            triggerMapPulse(location.lng, location.lat, githubUsername, pulseColor, avatarUrl, githubUsername);
                                            console.log('[Auth] âœ… å·²è§¦å‘åœ°å›¾è„‰å†²ï¼ˆå»¶è¿Ÿï¼‰');
                                        }
                                    } catch (pulseError) {
                                        console.warn('[Auth] âš ï¸ è§¦å‘åœ°å›¾è„‰å†²å¤±è´¥ï¼ˆå»¶è¿Ÿï¼‰:', pulseError);
                                    }
                                }, 1000);
                            } else {
                                const location = await getUserLocation();
                                if (location && location.lat && location.lng && typeof triggerMapPulse === 'function') {
                                    const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                                    const pulseColor = statusConfig.status_color || '#00ff41';
                                    triggerMapPulse(location.lng, location.lat, githubUsername, pulseColor, avatarUrl, githubUsername);
                                    console.log('[Auth] âœ… å·²è§¦å‘åœ°å›¾è„‰å†²');
                                }
                            }
                        } catch (pulseError) {
                            console.warn('[Auth] âš ï¸ è§¦å‘åœ°å›¾è„‰å†²å¤±è´¥:', pulseError);
                        }
                        
                        // è‡ªåŠ¨æ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡ï¼ˆç­‰å¾… window.allData åŠ è½½å®Œæˆï¼‰
                        try {
                            // ç¡®ä¿ window.allData å·²åŠ è½½
                            if (!window.allData || window.allData.length === 0) {
                                console.log('[Auth] âš ï¸ allData æœªåŠ è½½ï¼Œç­‰å¾…æ•°æ®åŠ è½½å®Œæˆåå†æ‰“å¼€æŠ½å±‰...');
                                // å»¶è¿Ÿæ‰§è¡Œï¼Œç­‰å¾… fetchData å®Œæˆ
                                setTimeout(async () => {
                                    try {
                                        const location = await getUserLocation();
                                        const countryCode = location?.countryCode || updatedUser?.ip_location || null;
                                        const countryName = countryCode && countryNameMap[countryCode]
                                            ? (currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en)
                                            : (countryCode || 'å…¨çƒ');
                                        
                                        if (countryCode && countryCode !== 'å…¨çƒ') {
                                            showDrawersWithCountryData(countryCode, countryName);
                                            console.log('[Auth] âœ… å·²æ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç”¨æˆ·æ•°æ®ï¼ˆå»¶è¿Ÿï¼‰');
                                        } else {
                                            const leftDrawer = document.getElementById('left-drawer');
                                            const leftBody = document.getElementById('left-drawer-body');
                                            if (leftDrawer && leftBody) {
                                                if (!leftDrawer.classList.contains('active')) {
                                                    leftDrawer.classList.add('active');
                                                    const rightDrawer = document.getElementById('right-drawer');
                                                    if (rightDrawer) {
                                                        rightDrawer.classList.add('active');
                                                    }
                                                }
                                                renderUserStatsCards(leftBody, getBestUserRecordForStats(updatedUser));
                                                console.log('[Auth] âœ… å·²åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ï¼ˆå»¶è¿Ÿï¼‰');
                                            }
                                        }
                                    } catch (drawerError) {
                                        console.warn('[Auth] âš ï¸ æ‰“å¼€æŠ½å±‰å¤±è´¥ï¼ˆå»¶è¿Ÿï¼‰:', drawerError);
                                    }
                                }, 1000);
                            } else {
                                const location = await getUserLocation();
                                const countryCode = location?.countryCode || updatedUser?.ip_location || null;
                                const countryName = countryCode && countryNameMap[countryCode]
                                    ? (currentLang === 'zh' ? countryNameMap[countryCode].zh : countryNameMap[countryCode].en)
                                    : (countryCode || 'å…¨çƒ');
                                
                                if (countryCode && countryCode !== 'å…¨çƒ') {
                                    showDrawersWithCountryData(countryCode, countryName);
                                    console.log('[Auth] âœ… å·²æ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç”¨æˆ·æ•°æ®');
                                } else {
                                    const leftDrawer = document.getElementById('left-drawer');
                                    const leftBody = document.getElementById('left-drawer-body');
                                    if (leftDrawer && leftBody) {
                                        if (!leftDrawer.classList.contains('active')) {
                                            leftDrawer.classList.add('active');
                                            const rightDrawer = document.getElementById('right-drawer');
                                            if (rightDrawer) {
                                                rightDrawer.classList.add('active');
                                            }
                                        }
                                        renderUserStatsCards(leftBody, getBestUserRecordForStats(updatedUser));
                                        console.log('[Auth] âœ… å·²åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡');
                                    }
                                }
                            }
                        } catch (drawerError) {
                            console.warn('[Auth] âš ï¸ æ‰“å¼€æŠ½å±‰å¤±è´¥:', drawerError);
                        }
                        
                        // åˆ·æ–°æ’åå¡ç‰‡ï¼ˆç¡®ä¿åœ¨æ•°æ®åŠ è½½å®Œæˆåï¼‰
                        try {
                            if (window.currentUser) {
                                renderRankCards(window.currentUser);
                                console.log('[Auth] âœ… å·²åˆ·æ–°æ’åå¡ç‰‡');
                            }
                        } catch (rankError) {
                            console.warn('[Auth] âš ï¸ åˆ·æ–°æ’åå¡ç‰‡å¤±è´¥:', rankError);
                        }
                    }
                } else {
                    // æœªç™»å½•çŠ¶æ€
                    updateAuthUI(null);
                }
            } catch (error) {
                console.error('[Auth] âŒ å¤„ç†è®¤è¯çŠ¶æ€å˜åŒ–å¤±è´¥:', error);
                updateAuthUI(null);
            } finally {
                // ã€å¼‚æ­¥æµä¿æŠ¤ã€‘åœ¨ finally å—ä¸­å¿…é¡»è°ƒç”¨ hideSyncingOverlay()ï¼Œç¡®ä¿æ— è®ºæˆåŠŸå¤±è´¥ï¼ŒUI é®ç½©éƒ½èƒ½æ¶ˆå¤±
                if (timeoutTimer) {
                    clearTimeout(timeoutTimer);
                    timeoutTimer = null;
                }
                hideSyncingOverlay();
                migrationCompleted = true;
            }
        }
        
        /**
         * æ›´æ–°è®¤è¯ UIï¼ˆç™»å½•æŒ‰é’®/ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºï¼‰
         * @param {Object|null} userInfo - ç”¨æˆ·ä¿¡æ¯å¯¹è±¡ { username, avatarUrl } æˆ– null
         */
        function updateAuthUI(userInfo) {
            // æŸ¥æ‰¾è®¤è¯ UI å®¹å™¨ï¼ˆå¯èƒ½åœ¨å¤šä¸ªä½ç½®ï¼‰
            const authContainers = [
                document.getElementById('auth-container'),
                document.querySelector('.auth-container'),
                document.querySelector('[data-auth-container]')
            ].filter(Boolean);
            
            // å¦‚æœæ²¡æœ‰ä¸“é—¨çš„å®¹å™¨ï¼Œåœ¨å·¦ä¾§æŠ½å±‰ä¸­æ›´æ–°
            const leftBody = document.getElementById('left-drawer-body');
            const identityCard = leftBody ? leftBody.querySelector('.drawer-item:first-child') : null;
            
            if (userInfo) {
                // å·²ç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                console.log('[Auth] âœ… æ›´æ–° UI ä¸ºå·²ç™»å½•çŠ¶æ€:', userInfo.username);
                
                    // æ›´æ–°å·¦ä¾§æŠ½å±‰ä¸­çš„èº«ä»½å¡ç‰‡
                const leftBody = document.getElementById('left-drawer-body');
                if (leftBody) {
                    const identityCard = leftBody.querySelector('.drawer-item:first-child');
                    if (identityCard) {
                        const userInfoSection = identityCard.querySelector('.mb-3.pb-3.border-b');
                        const loginSection = identityCard.querySelector('#auth-login-section') || 
                                            identityCard.querySelector('.mt-3.pt-3.border-t');
                        
                        if (userInfoSection) {
                            // âœ… ç®€çº¦ï¼šåªæ›´æ–°ç°æœ‰åŒºåŸŸé‡Œçš„ avatar / name / labelï¼Œä¸å†é‡å»º DOMï¼ˆé¿å…é‡å¤å¤´åƒ/å§“åï¼‰
                            try {
                                const img = userInfoSection.querySelector('img');
                                if (img) img.src = userInfo.avatarUrl || DEFAULT_AVATAR;
                                const nameEl = userInfoSection.querySelector('.drawer-item-value');
                                if (nameEl) nameEl.textContent = userInfo.username || '';
                                const labelEl = userInfoSection.querySelector('.drawer-item-desc');
                                if (labelEl) labelEl.textContent = 'GitHub ID';
                                const link = userInfoSection.querySelector('a[href*="github.com/"]');
                                if (link) link.href = `https://github.com/${userInfo.username}`;
                            } catch { /* ignore */ }
                        }
                        
                        // æ›´æ–°ç™»å½•åŒºåŸŸ
                        if (loginSection) {
                            // âœ… å·²ç™»å½•ï¼šç™»å½•åŒºä¿æŒä¸ºç©ºï¼ˆèº«ä»½åŒºå·²å«é€€å‡º/é“¾æ¥ï¼‰
                            loginSection.innerHTML = '';
                            try { loginSection.style.display = 'none'; } catch { /* ignore */ }
                        }
                    }
                }
            } else {
                // æœªç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤ºç™»å½•æŒ‰é’®
                console.log('[Auth] âœ… æ›´æ–° UI ä¸ºæœªç™»å½•çŠ¶æ€');
                
                // æ›´æ–°å·¦ä¾§æŠ½å±‰ä¸­çš„èº«ä»½å¡ç‰‡
                const leftBody = document.getElementById('left-drawer-body');
                if (leftBody) {
                    const identityCard = leftBody.querySelector('.drawer-item:first-child');
                    if (identityCard) {
                        const userInfoSection = identityCard.querySelector('.mb-3.pb-3.border-b');
                        const loginSection = identityCard.querySelector('#auth-login-section') || 
                                            identityCard.querySelector('.mt-3.pt-3.border-t');
                        
                        if (userInfoSection) {
                            // âœ… ç®€çº¦ï¼šä¸é‡å»º DOMï¼Œé¿å…é‡å¤å—ï¼›ä»…å°†ç”¨æˆ·åç½®ç©ºå¹¶æ¢å¤é»˜è®¤å¤´åƒ
                            try {
                                const img = userInfoSection.querySelector('img');
                                if (img) img.src = DEFAULT_AVATAR;
                                const nameEl = userInfoSection.querySelector('.drawer-item-value');
                                if (nameEl) nameEl.textContent = 'æœªç™»å½•';
                                const labelEl = userInfoSection.querySelector('.drawer-item-desc');
                                if (labelEl) labelEl.textContent = 'è¯·ä½¿ç”¨ GitHub ç™»å½•';
                                const link = userInfoSection.querySelector('a[href*="github.com/"]');
                                if (link) link.remove();
                            } catch { /* ignore */ }
                        }
                        
                        // æ›¿æ¢ç™»å½•è¾“å…¥æ¡†ä¸ºç™»å½•æŒ‰é’®
                        if (loginSection) {
                            try { loginSection.style.display = ''; } catch { /* ignore */ }
                            loginSection.innerHTML = `
                                <div class="drawer-item-label mb-2">GitHub ç™»å½•</div>
                                <button 
                                    onclick="loginWithGitHub()"
                                    class="w-full px-4 py-3 bg-[#24292e] hover:bg-[#2f363d] border border-[#444d56] rounded-md text-white text-sm font-semibold flex items-center justify-center gap-2 transition-all duration-200 hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl"
                                >
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ä½¿ç”¨ GitHub ç™»å½•</span>
                                </button>
                                <div class="text-[8px] text-[#00ff41]/40 mt-2 text-center">
                                    å®‰å…¨ã€å¿«é€Ÿã€ä¸€é”®ç™»å½•
                                </div>
                            `;
                        }
                    }
                }
            }
        }
        
        /**
         * è·å–å½“å‰æµè§ˆå™¨æŒ‡çº¹ï¼ˆä¸é¡µé¢åŠ è½½æ—¶ç”Ÿæˆé€»è¾‘ä¸€è‡´ï¼‰
         * @returns {Promise<string>} æŒ‡çº¹å­—ç¬¦ä¸²
         */
        async function getCurrentFingerprint() {
            try {
                // å…ˆå°è¯•ä» localStorage è¯»å–
                let fingerprint = localStorage.getItem('user_fingerprint');
                
                if (!fingerprint) {
                    // å¦‚æœä¸å­˜åœ¨ï¼Œç”Ÿæˆæ–°çš„æŒ‡çº¹ï¼ˆä¸ window.onload ä¸­çš„é€»è¾‘ä¸€è‡´ï¼‰
                    const deviceInfo = {
                        userAgent: navigator.userAgent || '',
                        language: navigator.language || '',
                        platform: navigator.platform || '',
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || ''
                    };
                    const deviceString = JSON.stringify(deviceInfo);
                    const msgUint8 = new TextEncoder().encode(deviceString);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                    fingerprint = Array.from(new Uint8Array(hashBuffer))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                    
                    try {
                        localStorage.setItem('user_fingerprint', fingerprint);
                        console.log('[Fingerprint] ğŸ”‘ å·²ç”Ÿæˆè®¾å¤‡ Fingerprint:', fingerprint.substring(0, 8) + '...');
                    } catch (e) {
                        console.warn('[Fingerprint] âš ï¸ ä¿å­˜ Fingerprint åˆ° localStorage å¤±è´¥:', e);
                    }
                }
                
                return fingerprint;
            } catch (error) {
                console.error('[Fingerprint] âŒ è·å–æŒ‡çº¹å¤±è´¥:', error);
                return null;
            }
        }

        /**
         * ä¿å­˜GitHubç”¨æˆ·ååˆ°localStorageå¹¶ç»‘å®šæŒ‡çº¹
         * ä½¿ç”¨ Supabase å®¢æˆ·ç«¯ç›´æ¥æ›´æ–° fingerprint å­—æ®µ
         * ã€å¢å¼ºç‰ˆã€‘åŒ…å«é²æ£’çš„å…ƒç´ è·å–ã€å¼ºåˆ¶æŒ‡çº¹ç»‘å®šã€UIçŠ¶æ€è”åŠ¨
         */
        async function saveGitHubUsername() {
            // ============================================
            // 1. é²æ£’çš„å…ƒç´ è·å–ï¼ˆå¤šé‡é€‰æ‹©å™¨ï¼‰
            // ============================================
            let input = null;
            let saveButton = null;
            
            // å°è¯•å¤šç§æ–¹å¼è·å–è¾“å…¥æ¡†ï¼ˆæ”¯æŒä¸»è¾“å…¥æ¡†å’ŒæŠ½å±‰è¾“å…¥æ¡†ï¼‰
            input = document.getElementById('githubUsername') ||
                   document.getElementById('drawer-github-username') ||
                   document.querySelector('#githubUsername') ||
                   document.querySelector('#drawer-github-username') ||
                   document.querySelector('input[id="githubUsername"]') ||
                   document.querySelector('input[id="drawer-github-username"]') ||
                   document.querySelector('input[placeholder*="GitHub"]') ||
                   document.querySelector('input[placeholder*="github"]');
            
            // å¦‚æœæ‰¾åˆ°æŠ½å±‰è¾“å…¥æ¡†ï¼ŒåŒæ­¥åˆ°ä¸»è¾“å…¥æ¡†
            if (input && input.id === 'drawer-github-username') {
                const mainInput = document.getElementById('githubUsername');
                if (mainInput) {
                    mainInput.value = input.value;
                    console.log('[GitHub] âœ… å·²åŒæ­¥æŠ½å±‰è¾“å…¥æ¡†åˆ°ä¸»è¾“å…¥æ¡†');
                }
            }
            
            // å°è¯•è·å–ä¿å­˜æŒ‰é’®ï¼ˆç”¨äºæ˜¾ç¤º Loading çŠ¶æ€ï¼‰
            saveButton = document.querySelector('button[onclick*="saveGitHubUsername"]') ||
                        document.querySelector('button:has-text("ä¿å­˜")') ||
                        document.querySelector('.drawer-item button');
            
            // å¦‚æœæ‰¾ä¸åˆ°è¾“å…¥æ¡†ï¼Œæ‰“å°è¯¦ç»†çš„ DOM ç»“æ„è­¦å‘Š
            if (!input) {
                console.error('[GitHub] âŒ æ‰¾ä¸åˆ° GitHub è¾“å…¥æ¡†å…ƒç´ ');
                console.warn('[GitHub] ğŸ” DOM ç»“æ„è¯Šæ–­:', {
                    hasGetElementById: typeof document.getElementById === 'function',
                    allInputs: Array.from(document.querySelectorAll('input')).map(el => ({
                        id: el.id,
                        name: el.name,
                        placeholder: el.placeholder,
                        type: el.type
                    })),
                    bodyHTML: document.body ? document.body.innerHTML.substring(0, 500) : 'body ä¸å­˜åœ¨'
                });
                alert('æ— æ³•æ‰¾åˆ° GitHub è¾“å…¥æ¡†ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                return;
            }
            
            // ============================================
            // 2. è·å–ç”¨æˆ·åå¹¶éªŒè¯
            // ============================================
            const username = input.value.trim();
            if (username === '') {
                // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œæ¸…é™¤localStorage
                localStorage.removeItem('github_username');
                console.log('[GitHub] âœ… å·²æ¸…é™¤GitHubç”¨æˆ·å');
                alert('å·²æ¸…é™¤GitHubç”¨æˆ·å');
                return;
            }
            
            // éªŒè¯ GitHub ç”¨æˆ·åæ ¼å¼
            if (!isValidGitHubUsername(username)) {
                alert('GitHub ç”¨æˆ·åæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥åé‡è¯•');
                return;
            }
            
            // ============================================
            // 3. æ˜¾ç¤º Loading çŠ¶æ€
            // ============================================
            const originalButtonText = saveButton ? saveButton.textContent : '';
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.textContent = 'ä¿å­˜ä¸­...';
                saveButton.style.opacity = '0.6';
            }
            
            try {
                // ============================================
                // 4. å¼ºåˆ¶æŒ‡çº¹ç»‘å®šæµï¼ˆåœ¨ localStorage æ›´æ–°ä¹‹å‰å®Œæˆï¼‰
                // ============================================
                
                // 4.1 è·å–å½“å‰æŒ‡çº¹ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„æŒ‡çº¹ç”Ÿæˆå‡½æ•°ï¼‰
                const currentFingerprint = await getCurrentFingerprint();
                
                if (!currentFingerprint) {
                    console.warn('[GitHub] âš ï¸ æœªæ‰¾åˆ°æŒ‡çº¹ï¼Œæ— æ³•ç»‘å®š');
                    alert('æœªæ‰¾åˆ°è®¾å¤‡æŒ‡çº¹ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                    return;
                }
                
                console.log('[GitHub] ğŸ”‘ å½“å‰æŒ‡çº¹:', currentFingerprint.substring(0, 8) + '...');
                
                // 4.2 æ£€æŸ¥ Supabase å®¢æˆ·ç«¯
                if (!supabaseClient) {
                    console.error('[GitHub] âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                    alert('æ•°æ®åº“è¿æ¥æœªå°±ç»ªï¼Œè¯·ç¨å€™å†è¯•');
                    return;
                }
                
                // 4.3 è§„èŒƒåŒ–ç”¨æˆ·åï¼ˆå°å†™ï¼‰
                const normalizedUsername = username.toLowerCase().trim();
                
                console.log('[GitHub] ğŸ”— å¼€å§‹ç»‘å®šæŒ‡çº¹åˆ° user_name:', normalizedUsername);
                
                // ã€å…³é”®ä¿®å¤ã€‘ç™»å½•åå¿…é¡»ä½¿ç”¨ user_id è¿›è¡Œæ‰€æœ‰æ“ä½œï¼Œè€Œä¸æ˜¯ fingerprint æˆ– user_name
                // è¿™æ˜¯"è®¤ç¥–å½’å®—"çš„å…³é”®ï¼šç¡®ä¿æ•°æ®å…³è”åˆ°æ­£ç¡®çš„ GitHub è´¦å·
                let authenticatedUserId = null;
                let authenticatedSession = null;
                
                try {
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    if (!sessionError && session && session.user) {
                        authenticatedUserId = session.user.id;
                        authenticatedSession = session;
                        console.log('[GitHub] âœ… æ£€æµ‹åˆ°å·²ç™»å½•ç”¨æˆ·ï¼Œuser_id:', authenticatedUserId.substring(0, 8) + '...');
                    }
                } catch (authError) {
                    console.warn('[GitHub] âš ï¸ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', authError);
                }
                
                let updatedUser = null;
                
                // ã€å…³é”®ä¿®å¤ã€‘ç»‘å®šç­–ç•¥ï¼šä¼˜å…ˆåŠ è½½ã€Œæœ¬è®¾å¤‡ä¸Šä¼ ã€çš„è®°å½•ï¼Œé¿å…è¯¯ç»‘å¼‚åœ°æœ€é«˜æ•°å€¼ç”¨æˆ·
                if (authenticatedUserId) {
                    console.log('[GitHub] ğŸ”— å·²ç™»å½•ï¼Œä½¿ç”¨ user_id è¿›è¡Œæ›´æ–°ï¼ˆè®¤ç¥–å½’å®—ï¼‰:', authenticatedUserId.substring(0, 8) + '...');
                    
                    let existingUserById = null;
                    const { data: byId, error: findByIdError } = await supabaseClient
                        .from('v_unified_analysis_v2')
                        .select('*')
                        .eq('id', authenticatedUserId)
                        .maybeSingle();
                    if (!findByIdError) existingUserById = byId;
                    if (findByIdError && findByIdError.code !== 'PGRST116') {
                        console.error('[GitHub] âŒ æŒ‰ id æŸ¥è¯¢å¤±è´¥:', findByIdError);
                    }
                    
                    // å·²ç™»å½•ä½†åº“é‡Œæ— æ­¤ id æ—¶ï¼šä¼˜å…ˆç”¨æœ¬æœº fingerprint æŸ¥æ‰¾ã€Œè‡ªå·±ä¸Šä¼ ã€çš„è®°å½•å¹¶ç»‘å®šï¼Œé¿å…ç»‘åˆ°ä»–äºº
                    if (!existingUserById && currentFingerprint) {
                        const { data: byFp, error: byFpErr } = await supabaseClient
                            .from('v_unified_analysis_v2')
                            .select('*')
                            .eq('fingerprint', currentFingerprint)
                            .maybeSingle();
                        if (!byFpErr && byFp) {
                            console.log('[GitHub] âœ… æŒ‰æœ¬æœº fingerprint æ‰¾åˆ°è‡ªå·±ä¸Šä¼ çš„è®°å½•ï¼Œç»‘å®šåˆ°å½“å‰ GitHub');
                            existingUserById = byFp;
                        }
                    }
                    
                    const updatePayload = {
                        user_name: normalizedUsername,
                        user_identity: 'github',
                        fingerprint: currentFingerprint,
                        updated_at: new Date().toISOString()
                    };
                    
                    if (existingUserById) {
                        const rowId = existingUserById.id;
                        const { data, error: updateError } = await supabaseClient
                            .from('user_analysis')
                            .update(updatePayload)
                            .eq('id', rowId)
                            .select()
                            .single();
                        if (updateError) {
                            console.error('[GitHub] âŒ æ›´æ–°ç”¨æˆ·å¤±è´¥:', updateError);
                            if (updateError.code === '42501' || updateError.message?.includes('row-level security')) {
                                const upsertPayload = {
                                    id: rowId,
                                    user_name: normalizedUsername,
                                    user_identity: 'github',
                                    fingerprint: currentFingerprint,
                                    updated_at: new Date().toISOString()
                                };
                                const { data: upsertData, error: upsertError } = await supabaseClient
                                    .from('user_analysis')
                                    .upsert([upsertPayload], { onConflict: 'id' })
                                    .select()
                                    .single();
                                if (!upsertError) {
                                    updatedUser = upsertData;
                                    console.log('[GitHub] âœ… é€šè¿‡ upsert æ›´æ–°ç”¨æˆ·æˆåŠŸ');
                                } else { throw new Error(upsertError.message); }
                            } else { throw new Error(updateError.message); }
                        } else {
                            updatedUser = data;
                            console.log('[GitHub] âœ… ç”¨æˆ·ä¿¡æ¯å·²æˆåŠŸæ›´æ–°ï¼ˆä½¿ç”¨ user_id æˆ–æœ¬æœº fingerprintï¼‰');
                        }
                    } else {
                        const upsertPayload = {
                            id: authenticatedUserId,
                            user_name: normalizedUsername,
                            user_identity: 'github',
                            fingerprint: currentFingerprint,
                            updated_at: new Date().toISOString()
                        };
                        const { data: upsertData, error: upsertError } = await supabaseClient
                            .from('user_analysis')
                            .upsert([upsertPayload], { onConflict: 'id' })
                            .select()
                            .single();
                        if (upsertError) throw new Error(upsertError.message);
                        updatedUser = upsertData;
                        console.log('[GitHub] âœ… æ–°ç”¨æˆ·å·²åˆ›å»ºï¼ˆä½¿ç”¨ GitHub User IDï¼‰');
                    }
                } else {
                    // ã€ç»‘å®šç­–ç•¥ã€‘æœªç™»å½•æ—¶ï¼šå…ˆæŒ‰æœ¬æœº fingerprint æ‰¾ã€Œè‡ªå·±ä¸Šä¼ ã€å†ç»‘å®šï¼Œé¿å…æŒ‰ user_name è¯¯ç»‘å¼‚åœ°ç”¨æˆ·
                    console.log('[GitHub] âš ï¸ æœªç™»å½•ï¼Œå…ˆæŒ‰æœ¬æœº fingerprint æŸ¥æ‰¾å†ç»‘å®š');
                    
                    let existingUser = null;
                    let findError = null;
                    if (currentFingerprint) {
                        const { data: byFp, error: e } = await supabaseClient
                            .from('v_unified_analysis_v2')
                            .select('*')
                            .eq('fingerprint', currentFingerprint)
                            .maybeSingle();
                        if (!e && byFp) {
                            existingUser = byFp;
                            console.log('[GitHub] âœ… æŒ‰æœ¬æœº fingerprint æ‰¾åˆ°è‡ªå·±ä¸Šä¼ çš„è®°å½•');
                        }
                    }
                    if (!existingUser) {
                        const { data: byName, error: e } = await supabaseClient
                            .from('v_unified_analysis_v2')
                            .select('*')
                            .ilike('user_name', normalizedUsername)
                            .maybeSingle();
                        findError = e;
                        if (!e && byName) existingUser = byName;
                    }
                    
                    if (findError && findError.code !== 'PGRST116') {
                        console.error('[GitHub] âŒ æŸ¥è¯¢ç”¨æˆ·å¤±è´¥:', findError);
                        throw new Error(`æŸ¥è¯¢å¤±è´¥: ${findError.message}`);
                    }
                    
                    if (existingUser) {
                        console.log('[GitHub] âœ… æ‰¾åˆ°ç°æœ‰ç”¨æˆ·ï¼Œæ›´æ–° fingerprint / user_name');
                        const { data, error: updateError } = await supabaseClient
                            .from('user_analysis')
                            .update({
                                fingerprint: currentFingerprint,
                                user_name: normalizedUsername,
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existingUser.id)
                            .select()
                            .single();
                        if (updateError) throw new Error(`æ›´æ–°å¤±è´¥: ${updateError.message}`);
                        updatedUser = data;
                        console.log('[GitHub] âœ… æŒ‡çº¹å·²æˆåŠŸæ›´æ–°åˆ°æ•°æ®åº“');
                    } else {
                        console.log('[GitHub] âœ… ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•');
                        const newUserData = {
                            id: crypto.randomUUID(),
                            user_name: normalizedUsername,
                            fingerprint: currentFingerprint,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        };
                        const { data, error: insertError } = await supabaseClient
                            .from('user_analysis')
                            .insert([newUserData])
                            .select()
                            .single();
                        if (insertError) throw new Error(`åˆ›å»ºå¤±è´¥: ${insertError.message}`);
                        updatedUser = data;
                        console.log('[GitHub] âœ… æ–°ç”¨æˆ·å·²åˆ›å»ºï¼ŒæŒ‡çº¹å·²ç»‘å®š');
                    }
                }
                
                // ============================================
                // 5. æ›´æ–° localStorageï¼ˆåœ¨æ•°æ®åº“æ›´æ–°æˆåŠŸåï¼‰
                // ============================================
                localStorage.setItem('github_username', username);
                console.log('[GitHub] âœ… å·²ä¿å­˜GitHubç”¨æˆ·ååˆ° localStorage:', username);
                
                // ============================================
                // 6. UI çŠ¶æ€è”åŠ¨ï¼ˆåœ°å›¾ä¸å¡ç‰‡ï¼‰
                // ============================================
                console.log('[GitHub] ğŸ”„ å¼€å§‹åˆ·æ–°å…¨å±€æ•°æ®å’Œ UI...');
                
                // 6.1 æ›´æ–°å…¨å±€ç”¨æˆ·æ•°æ®
                window.currentUser = updatedUser;
                window.currentUserMatchedByFingerprint = true;
                
                // 6.2 æ›´æ–° window.allData ä¸­çš„å¯¹åº”è®°å½•
                const allData = window.allData || [];
                const index = allData.findIndex(item => 
                    item.id === updatedUser.id ||
                    (item.fingerprint && item.fingerprint === currentFingerprint) ||
                    (item.user_name && item.user_name.toLowerCase() === normalizedUsername)
                );
                
                if (index !== -1) {
                    allData[index] = { ...allData[index], ...updatedUser };
                    console.log('[GitHub] âœ… å·²æ›´æ–° allData ä¸­çš„è®°å½•ï¼Œç´¢å¼•:', index);
                } else {
                    allData.push(updatedUser);
                    console.log('[GitHub] âœ… å·²æ·»åŠ æ–°è®°å½•åˆ° allData');
                }
                window.allData = allData;
                
                // 6.3 åˆ·æ–°æ’åå¡ç‰‡
                if (window.currentUser) {
                    renderRankCards(window.currentUser);
                    console.log('[GitHub] âœ… å·²åˆ·æ–°æ’åå¡ç‰‡');
                }
                
                // 6.4 è§¦å‘åœ°å›¾è„‰å†²ï¼ˆå¦‚æœç”¨æˆ·æœ‰åœ°ç†ä½ç½®ä¿¡æ¯ï¼‰
                try {
                    // è·å–ç”¨æˆ·åœ°ç†ä½ç½®ï¼ˆæ— è®ºæ•°æ®åº“ä¸­æ˜¯å¦æœ‰ï¼Œéƒ½å°è¯•è·å–å½“å‰ä½ç½®ï¼‰
                    const location = await getUserLocation();
                    if (location && location.lat && location.lng && typeof triggerMapPulse === 'function') {
                        const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                        const pulseColor = statusConfig.status_color || '#00ff41';
                        const pulseLabel = normalizedUsername;
                        const avatarUrl = getGitHubAvatarUrl(normalizedUsername);
                        
                        triggerMapPulse(location.lng, location.lat, pulseLabel, pulseColor, avatarUrl, normalizedUsername);
                        console.log('[GitHub] âœ… å·²è§¦å‘åœ°å›¾è„‰å†²:', {
                            lng: location.lng,
                            lat: location.lat,
                            label: pulseLabel,
                            color: pulseColor
                        });
                    } else if (!location || !location.lat || !location.lng) {
                        console.log('[GitHub] â„¹ï¸ æ— æ³•è·å–åœ°ç†ä½ç½®ï¼Œè·³è¿‡åœ°å›¾è„‰å†²');
                    }
                } catch (pulseError) {
                    console.warn('[GitHub] âš ï¸ è§¦å‘åœ°å›¾è„‰å†²å¤±è´¥:', pulseError);
                }
                
                // 6.5 è‡ªåŠ¨æ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç”¨æˆ·ç»Ÿè®¡å¡ç‰‡
                try {
                    // è·å–ç”¨æˆ·çš„å›½å®¶ä»£ç ï¼ˆä» ip_location æˆ– locationï¼Œæˆ–ä»åœ°ç†ä½ç½®è·å–ï¼‰
                    let userCountryCode = updatedUser.ip_location || updatedUser.location || null;
                    
                    // å¦‚æœæ²¡æœ‰å›½å®¶ä»£ç ï¼Œå°è¯•ä»åœ°ç†ä½ç½®è·å–
                    if (!userCountryCode) {
                        try {
                            const location = await getUserLocation();
                            if (location && location.countryCode) {
                                userCountryCode = location.countryCode;
                                console.log('[GitHub] âœ… ä»åœ°ç†ä½ç½®è·å–å›½å®¶ä»£ç :', userCountryCode);
                            }
                        } catch (geoError) {
                            console.warn('[GitHub] âš ï¸ è·å–åœ°ç†ä½ç½®å¤±è´¥:', geoError);
                        }
                    }
                    
                    const userCountryName = userCountryCode && countryNameMap[userCountryCode]
                        ? (currentLang === 'zh' ? countryNameMap[userCountryCode].zh : countryNameMap[userCountryCode].en)
                        : (userCountryCode || 'å…¨çƒ');
                    
                    // è·å–æŠ½å±‰å…ƒç´ 
                    const leftDrawer = document.getElementById('left-drawer');
                    const leftBody = document.getElementById('left-drawer-body');
                    const rightDrawer = document.getElementById('right-drawer');
                    
                    if (userCountryCode && userCountryCode !== 'å…¨çƒ') {
                        // å¦‚æœæœ‰å›½å®¶ä»£ç ï¼Œæ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç”¨æˆ·æ•°æ®
                        showDrawersWithCountryData(userCountryCode, userCountryName);
                        console.log('[GitHub] âœ… å·²æ‰“å¼€æŠ½å±‰å¹¶æ˜¾ç¤ºç”¨æˆ·æ•°æ®:', userCountryCode);
                    } else {
                        // å¦‚æœæ²¡æœ‰å›½å®¶ä»£ç ï¼Œç›´æ¥åˆ·æ–°å·¦ä¾§æŠ½å±‰çš„ç»Ÿè®¡å¡ç‰‡
                        // å¦‚æœæŠ½å±‰æœªæ‰“å¼€ï¼Œå…ˆæ‰“å¼€å®ƒ
                        if (leftDrawer && !leftDrawer.classList.contains('active')) {
                            leftDrawer.classList.add('active');
                            if (rightDrawer) {
                                rightDrawer.classList.add('active');
                            }
                            console.log('[GitHub] âœ… å·²æ‰“å¼€æŠ½å±‰');
                        }
                        
                        // åˆ·æ–°ç»Ÿè®¡å¡ç‰‡
                        if (leftBody) {
                            // ç§»é™¤ç­‰å¾…å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                            const waitingCards = leftBody.querySelectorAll('.drawer-item');
                            waitingCards.forEach(card => {
                                const label = card.querySelector('.drawer-item-label');
                                if (label && (label.textContent === 'æ•°æ®åŠ è½½ä¸­' || label.textContent.includes('WAIT'))) {
                                    card.remove();
                                    console.log('[GitHub] âœ… å·²ç§»é™¤ç­‰å¾…å¡ç‰‡');
                                }
                            });
                            
                            // æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ï¼ˆä¼˜å…ˆä½¿ç”¨ allData ä¸­çš„å®Œæ•´è®°å½•ï¼‰
                            renderUserStatsCards(leftBody, getBestUserRecordForStats(updatedUser));
                            console.log('[GitHub] âœ… å·²åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡');
                        }
                    }
                } catch (drawerError) {
                    console.warn('[GitHub] âš ï¸ æ‰“å¼€æŠ½å±‰å¤±è´¥:', drawerError);
                }
                
                // 6.6 ä¿®å¤"åŒ¿åä¸“å®¶"æ˜¾ç¤ºé—®é¢˜ï¼šæ›´æ–°æ‰€æœ‰æ˜¾ç¤ºç”¨æˆ·åçš„ UI å…ƒç´ 
                try {
                    // æ›´æ–°å·¦ä¾§æŠ½å±‰ä¸­çš„æ˜¾ç¤ºåç§°
                    const leftTitle = document.getElementById('left-drawer-title');
                    if (leftTitle) {
                        const currentTitle = leftTitle.textContent || '';
                        if (!currentTitle.includes(normalizedUsername)) {
                            const cleanTitle = (currentTitle || '')
                                .replace(/\s*ï¼ˆå½“å‰è®¾å¤‡ï¼‰\s*$/g, '')
                                .replace(/\s*\(This Device\)\s*$/gi, '')
                                .trim();
                            leftTitle.textContent = (cleanTitle && cleanTitle.includes(normalizedUsername) ? cleanTitle : normalizedUsername);
                            console.log('[GitHub] âœ… å·²æ›´æ–°æŠ½å±‰æ ‡é¢˜:', leftTitle.textContent);
                        }
                    }
                    
                    // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º"åŒ¿åä¸“å®¶"çš„å…ƒç´ ï¼ˆæ›´ç²¾ç¡®çš„åŒ¹é…ï¼‰
                    const fingerprintPrefix = currentFingerprint.substring(0, 6).toUpperCase();
                    const anonymousPattern = new RegExp(`åŒ¿åä¸“å®¶\\s+${fingerprintPrefix}`, 'i');
                    
                    // æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½åŒ…å«"åŒ¿åä¸“å®¶"çš„å…ƒç´ 
                    const allElements = document.querySelectorAll('*');
                    let updateCount = 0;
                    
                    allElements.forEach(el => {
                        // è·³è¿‡ script å’Œ style æ ‡ç­¾
                        if (el.tagName === 'SCRIPT' || el.tagName === 'STYLE') {
                            return;
                        }
                        
                        // æ£€æŸ¥æ–‡æœ¬å†…å®¹
                        if (el.textContent && anonymousPattern.test(el.textContent)) {
                            el.textContent = el.textContent.replace(anonymousPattern, normalizedUsername);
                            updateCount++;
                        }
                        
                        // æ£€æŸ¥å±æ€§å€¼ï¼ˆå¦‚ placeholder, title ç­‰ï¼‰
                        Array.from(el.attributes || []).forEach(attr => {
                            if (attr.value && anonymousPattern.test(attr.value)) {
                                el.setAttribute(attr.name, attr.value.replace(anonymousPattern, normalizedUsername));
                                updateCount++;
                            }
                        });
                    });
                    
                    if (updateCount > 0) {
                        console.log('[GitHub] âœ… å·²æ›´æ–°', updateCount, 'ä¸ª"åŒ¿åä¸“å®¶"æ˜¾ç¤º');
                    }
                    
                    // å¼ºåˆ¶åˆ·æ–°æ’åå¡ç‰‡ä¸­çš„ç”¨æˆ·åæ˜¾ç¤º
                    setTimeout(() => {
                        if (window.currentUser) {
                            renderRankCards(window.currentUser);
                            console.log('[GitHub] âœ… å·²å¼ºåˆ¶åˆ·æ–°æ’åå¡ç‰‡ï¼ˆä¿®å¤åŒ¿åä¸“å®¶æ˜¾ç¤ºï¼‰');
                        }
                    }, 100);
                    
                } catch (updateError) {
                    console.warn('[GitHub] âš ï¸ æ›´æ–°åŒ¿åä¸“å®¶æ˜¾ç¤ºå¤±è´¥:', updateError);
                }
                
                // 6.7 æ›´æ–°å¤´åƒæ˜¾ç¤º
                updateGitHubAvatar();
                
                // 6.8 å¦‚æœPresenceé¢‘é“å·²è¿æ¥ï¼Œç«‹å³åŒæ­¥çŠ¶æ€
                if (presenceChannel) {
                    syncPresenceState().then(() => {
                        console.log('[GitHub] âœ… å·²æ›´æ–°åœ¨çº¿çŠ¶æ€ï¼ˆåŒ…å«æ–°å¤´åƒï¼‰');
                    }).catch((err) => {
                        console.warn('[GitHub] âš ï¸ æ›´æ–°åœ¨çº¿çŠ¶æ€å¤±è´¥:', err);
                    });
                }
                
                // 6.9 æ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆæ¸…ç†æ—§çš„æŒ‡çº¹åŒ¹é…æŠ¥é”™ï¼‰
                console.log('[GitHub] ğŸ‰ ç»‘å®šæµç¨‹å…¨éƒ¨å®Œæˆï¼');
                alert('âœ… GitHubç”¨æˆ·åå·²ä¿å­˜å¹¶ç»‘å®šæˆåŠŸï¼\n\n' +
                      'â€¢ æŒ‡çº¹å·²æ›´æ–°åˆ°æ•°æ®åº“\n' +
                      'â€¢ åœ°å›¾è„‰å†²å·²è§¦å‘\n' +
                      'â€¢ ç»Ÿè®¡å¡ç‰‡å·²åˆ·æ–°\n' +
                      'â€¢ ç”¨æˆ·åå·²æ›´æ–°');
                
            } catch (error) {
                const errorMessage = error && typeof error === 'object' && 'message' in error 
                    ? error.message 
                    : (typeof error === 'string' ? error : 'æœªçŸ¥é”™è¯¯');
                console.error('[GitHub] âŒ ç»‘å®šæŒ‡çº¹å¤±è´¥:', error);
                alert(`ç»‘å®šå¤±è´¥: ${errorMessage}\n\nè¯·æ£€æŸ¥ï¼š\n1. Supabase RLS ç­–ç•¥æ˜¯å¦å…è®¸æ›´æ–°\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.textContent = originalButtonText || 'ä¿å­˜';
                    saveButton.style.opacity = '1';
                }
            }
        }

        /**
         * ä»localStorageåŠ è½½GitHubç”¨æˆ·åå¹¶å¡«å……åˆ°è¾“å…¥æ¡†
         */
        /**
         * æ›´æ–°GitHubå¤´åƒæ˜¾ç¤º
         */
        function updateGitHubAvatar() {
            const input = document.getElementById('githubUsername');
            const avatarContainer = document.getElementById('githubAvatarContainer');
            const avatarImg = document.getElementById('githubAvatarImg');
            
            if (!input || !avatarContainer || !avatarImg) {
                return;
            }
            
            const username = input.value.trim();
            
            if (username && isValidGitHubUsername(username)) {
                // æ˜¾ç¤ºå¤´åƒå®¹å™¨
                avatarContainer.classList.remove('hidden');
                // è®¾ç½®å¤´åƒURL
                const avatarUrl = getGitHubAvatarUrl(username);
                avatarImg.src = avatarUrl;
                console.log('[GitHub] âœ… å·²æ›´æ–°å¤´åƒ:', avatarUrl);
            } else {
                // éšè—å¤´åƒå®¹å™¨
                avatarContainer.classList.add('hidden');
            }
        }

        function loadGitHubUsername() {
            const input = document.getElementById('githubUsername');
            if (!input) {
                return;
            }
            
            const savedUsername = localStorage.getItem('github_username');
            if (savedUsername) {
                input.value = savedUsername;
                console.log('[GitHub] âœ… å·²åŠ è½½ä¿å­˜çš„GitHubç”¨æˆ·å:', savedUsername);
                // åŠ è½½å¤´åƒ
                updateGitHubAvatar();
            }
        }

        /**
         * è·å–ç”¨æˆ·ç³»ç»Ÿç‰¹å¾ï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰
         * ç”¨äºæ•°æ®é‡‡é›†ç«¯ï¼Œè·å– timezone å’Œ browser_lang
         * @returns {Promise<Object>} åŒ…å« timezone, browser_lang çš„å¯¹è±¡
         */
        async function getUserSystemFeatures() {
            try {
                // ä½¿ç”¨ requestIdleCallback ç¡®ä¿éé˜»å¡ï¼Œä¸å½±å“é¡µé¢åŠ è½½é€Ÿåº¦
                return new Promise((resolve) => {
                    const schedule = window.requestIdleCallback || ((cb) => setTimeout(cb, 0));
                    
                    schedule(() => {
                        // è·å–æ—¶åŒºï¼šä½¿ç”¨ Intl.DateTimeFormat().resolvedOptions().timeZone
                        let timezone = 'Unknown';
                        try {
                            const formatter = new Intl.DateTimeFormat();
                            const resolvedOptions = formatter.resolvedOptions();
                            timezone = resolvedOptions.timeZone || 'Unknown';
                        } catch (err) {
                            console.warn('[SystemFeatures] âš ï¸ è·å–æ—¶åŒºå¤±è´¥:', err);
                            timezone = 'Unknown';
                        }

                        // è·å–æµè§ˆå™¨è¯­è¨€ï¼šä½¿ç”¨ navigator.language
                        const browser_lang = navigator.language || navigator.userLanguage || 'Unknown';

                        resolve({
                            timezone,
                            browser_lang
                        });
                    });
                });
            } catch (error) {
                console.error('[SystemFeatures] âŒ è·å–ç³»ç»Ÿç‰¹å¾å¤±è´¥:', error);
                // è¿”å›é»˜è®¤å€¼ï¼Œç¡®ä¿å‡½æ•°ä¸ä¼šé˜»å¡
                return {
                    timezone: 'Unknown',
                    browser_lang: navigator.language || 'Unknown'
                };
            }
        }

        /**
         * è‡ªåŠ¨ä¸ŠæŠ¥å½“å‰ç”¨æˆ·ä¿¡æ¯åˆ° user_analysis è¡¨
         * åœ¨ fetchData æ‰§è¡ŒæˆåŠŸåè‡ªåŠ¨è°ƒç”¨
         * @returns {Promise<Object>} ä¸ŠæŠ¥ç»“æœ
         */
        async function autoReportSelf() {
            try {
            // ã€æ‹¦æˆªå™¨æœºåˆ¶ã€‘å¦‚æœå·²é”šå®šï¼Œç¦æ­¢æ‰§è¡Œ IP å®šä½
            if (window.mapCursorManager && window.mapCursorManager.isAnchored) {
                console.log('[AutoReport] ğŸ”’ ä½ç½®å·²é”šå®šï¼Œè·³è¿‡è‡ªåŠ¨ä¸ŠæŠ¥');
                return { success: false, error: 'ä½ç½®å·²é”šå®š' };
            }
            
            // æ ¸å¿ƒæ‹¦æˆªï¼šå¦‚æœåç«¯å·²å­˜æ‰‹åŠ¨åæ ‡ï¼Œæˆ–è€…æœ¬åœ°å­˜æœ‰é”å®šæ ‡è®°ï¼Œç¦æ­¢æ‰§è¡Œ IP å®šä½
            if (window.currentUserData?.manual_lat || localStorage.getItem('loc_fixed') === 'true') {
                console.log('[AutoReport] ğŸ”’ ä½ç½®å·²æ‰‹åŠ¨é”å®šï¼Œè·³è¿‡è‡ªåŠ¨ä¸ŠæŠ¥');
                return { success: false, error: 'ä½ç½®å·²é”å®š' };
            }
            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                console.warn('[AutoReport] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œè·³è¿‡è‡ªåŠ¨ä¸ŠæŠ¥');
                return { success: false, error: 'Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–' };
            }

            try {
                console.log('[AutoReport] ğŸš€ å¼€å§‹è‡ªåŠ¨ä¸ŠæŠ¥ç”¨æˆ·ä¿¡æ¯...');

                // ã€AutoReport å¢å¼ºã€‘æ£€æµ‹æ˜¯å¦å·²ç™»å½•ï¼Œå¦‚æœå·²ç™»å½•åˆ™æºå¸¦ id
                let authenticatedUserId = null;
                let authenticatedSession = null;
                
                try {
                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    if (!sessionError && session && session.user) {
                        authenticatedUserId = session.user.id;
                        authenticatedSession = session;
                        console.log('[AutoReport] âœ… æ£€æµ‹åˆ°å·²ç™»å½•ç”¨æˆ·ï¼Œuser_id:', authenticatedUserId.substring(0, 8) + '...');
                    }
                } catch (authError) {
                    console.warn('[AutoReport] âš ï¸ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', authError);
                }

                // 1. è·å–ç³»ç»Ÿç‰¹å¾ï¼ˆæ—¶åŒºå’Œè¯­è¨€ï¼‰
                const systemFeatures = await getUserSystemFeatures();
                console.log('[AutoReport] ğŸ“Š ç³»ç»Ÿç‰¹å¾å·²è·å–:', systemFeatures);

                // 2. åœ°ç†ç”±åç«¯ CF è¯†åˆ«ï¼Œå‰ç«¯ä¸å†è¯·æ±‚ ipapi.co/ip-api.com
                let ipInfo = null;
                let ipLocation = 'US';
                let lat = null;
                let lng = null;
                let countryCode = 'US';

                // 3. VPN åˆ¤å®šé€»è¾‘
                // åˆ¤å®šæ¡ä»¶ï¼šå¦‚æœ timezone æ˜¯ 'Asia/Shanghai' ä¸” IP ä½ç½®ä¸åœ¨ä¸­å›½ï¼Œæ ‡è®°ä¸º VPN
                const timezone = systemFeatures.timezone || 'Unknown';
                const isShanghaiTimezone = timezone === 'Asia/Shanghai';
                // åªæœ‰å½“ countryCode æ˜ç¡®ä¸æ˜¯ 'CN' ä¸”ä¸æ˜¯ 'Unknown' æ—¶ï¼Œæ‰åˆ¤å®šä¸ºä¸åœ¨ä¸­å›½
                const isNotChina = countryCode !== 'CN' && countryCode !== 'Unknown' && countryCode !== null;

                let is_vpn = false;
                // åªæœ‰åœ¨æ—¶åŒºæ˜¯ Asia/Shanghai ä¸” IP æ˜ç¡®ä¸åœ¨ä¸­å›½æ—¶ï¼Œæ‰åˆ¤å®šä¸º VPN
                if (isShanghaiTimezone && isNotChina) {
                    is_vpn = true;
                    console.log('[AutoReport] ğŸ” VPN åˆ¤å®š: æ£€æµ‹åˆ° VPN ç”¨æˆ·', {
                        timezone,
                        countryCode,
                        is_vpn: true,
                        reason: 'æ—¶åŒºä¸ºAsia/Shanghaiä½†IPä¸åœ¨ä¸­å›½'
                    });
                } else {
                    // å¦‚æœä¿¡æ¯ä¸è¶³ï¼ˆcountryCode ä¸º Unknownï¼‰ï¼Œä¸åˆ¤å®šä¸º VPN
                    const reason = countryCode === 'Unknown' || countryCode === null 
                        ? 'IPä½ç½®ä¿¡æ¯ä¸è¶³ï¼Œæ— æ³•åˆ¤å®š' 
                        : (isShanghaiTimezone ? 'IPä½ç½®æ­£å¸¸ï¼ˆåœ¨ä¸­å›½ï¼‰' : 'æ—¶åŒºä¸åŒ¹é…');
                    
                    console.log('[AutoReport] ğŸ” VPN åˆ¤å®š: æ­£å¸¸ç”¨æˆ·æˆ–ä¿¡æ¯ä¸è¶³', {
                        timezone,
                        countryCode,
                        is_vpn: false,
                        reason
                    });
                }

                // 4. ç”Ÿæˆéšæœºè®¿å®¢ç”¨æˆ·åï¼šGuest_XXXXï¼ˆXXXXä¸º4ä½éšæœºæ•°å­—ï¼‰
                // ã€AutoReport å¢å¼ºã€‘å¦‚æœå·²ç™»å½•ï¼Œä½¿ç”¨ GitHub ç”¨æˆ·å
                let userName = null;
                if (authenticatedUserId && authenticatedSession) {
                    const githubUsername = authenticatedSession.user.user_metadata?.user_name || 
                                         authenticatedSession.user.user_metadata?.preferred_username ||
                                         authenticatedSession.user.user_metadata?.login ||
                                         authenticatedSession.user.email?.split('@')[0] || null;
                    if (githubUsername) {
                        userName = githubUsername.toLowerCase().trim();
                        console.log('[AutoReport] âœ… ä½¿ç”¨ GitHub ç”¨æˆ·å:', userName);
                    }
                }
                
                if (!userName) {
                    const randomGuestId = Math.floor(1000 + Math.random() * 9000);
                    userName = `Guest_${randomGuestId}`;
                    console.log('[AutoReport] â„¹ï¸ ä½¿ç”¨è®¿å®¢ç”¨æˆ·å:', userName);
                }

                // 5. æ„å»ºæäº¤æ•°æ®
                // ã€AutoReport å¢å¼ºã€‘å¦‚æœå·²ç™»å½•ï¼Œæºå¸¦ idï¼ˆauth.uidï¼‰ï¼Œç¡®ä¿æ•°æ®å­˜å…¥ GitHub è´¦å·å¯¹åº”çš„è¡Œ
                const payload = {
                    user_name: userName,
                    personality_type: 'AUTO_REPORT',
                    lat: lat,
                    lng: lng,
                    timezone: systemFeatures.timezone,
                    browser_lang: systemFeatures.browser_lang,
                    ip_location: ipLocation,
                    is_vpn: is_vpn
                };
                
                // ã€AutoReport å¢å¼ºã€‘å¦‚æœå·²ç™»å½•ï¼Œæºå¸¦ id
                if (authenticatedUserId) {
                    payload.id = authenticatedUserId;
                    payload.user_identity = 'github';
                    console.log('[AutoReport] âœ… å·²ç™»å½•ï¼Œæºå¸¦ user_id:', authenticatedUserId.substring(0, 8) + '...');
                }

                console.log('[AutoReport] ğŸ“¤ å‡†å¤‡æäº¤æ•°æ®åˆ° user_analysis è¡¨:', payload);

                // 5. ã€é‡è¦ã€‘ç¦ç”¨ AUTO_REPORT å†™å…¥ user_analysis
                // è¯´æ˜ï¼šAUTO_REPORT æ˜¯å ä½/åœ¨çº¿çŠ¶æ€ç”¨é€”ï¼Œä½†ä¼šå¯¼è‡´ user_analysis å‡ºç°â€œé¢å¤–ä¸€æ¡ç±»ä¼¼æ•°æ®â€ï¼Œ
                // ä¸ index.html ä¸Šä¼ åˆ†æç”Ÿæˆçš„çœŸå®äººæ ¼è®°å½•æ··åœ¨ä¸€èµ·ï¼ˆä½ è´´çš„ç¬¬ä¸€æ¡ AUTO_REPORT å°±æ¥è‡ªè¿™é‡Œï¼‰ã€‚
                // è¿™é‡Œåªä¿ç•™æœ¬åœ°å…‰æ ‡å±•ç¤ºä¸çŠ¶æ€é€»è¾‘ï¼Œä¸å†å‘ Supabase å†™å…¥å ä½è¡Œã€‚
                console.log('[AutoReport] â„¹ï¸ å·²ç¦ç”¨ AUTO_REPORT å†™å…¥ user_analysisï¼ˆä»…æœ¬åœ°æ˜¾ç¤ºï¼Œä¸å†™åº“ï¼‰');
                const data = null;

                // 6. ç«‹å³åé¦ˆ:ä¸ŠæŠ¥æˆåŠŸåç«‹å³åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºè‡ªå·±çš„ä½ç½®(ä¸ç­‰å¾… Realtime ç›‘å¬)
                // ã€ä¿®å¤ã€‘å³ä½¿ä½ç½®å·²é”å®šï¼Œä¹Ÿè¦æ˜¾ç¤ºå…‰æ ‡ï¼ˆä½¿ç”¨é”å®šçš„åæ ‡ï¼‰
                let finalLat = lat;
                let finalLng = lng;
                const isLocked = localStorage.getItem('loc_locked') === 'true' || localStorage.getItem('loc_fixed') === 'true';
                
                if (isLocked) {
                    // å¦‚æœå·²é”å®šï¼Œä½¿ç”¨é”å®šçš„åæ ‡
                    const lockedLat = localStorage.getItem('manual_lat');
                    const lockedLng = localStorage.getItem('manual_lng');
                    if (lockedLat && lockedLng && !isNaN(Number(lockedLat)) && !isNaN(Number(lockedLng))) {
                        finalLat = Number(lockedLat);
                        finalLng = Number(lockedLng);
                        console.log('[AutoReport] ğŸ”’ ä½¿ç”¨é”å®šçš„åæ ‡:', { lat: finalLat, lng: finalLng });
                    }
                }
                
                if (finalLat !== null && finalLng !== null && !isNaN(finalLat) && !isNaN(finalLng)) {
                    // æ€§èƒ½ä¿æŠ¤:æ£€æŸ¥ setOrUpdateCurrentLocationCursor å‡½æ•°æ˜¯å¦å·²å®šä¹‰
                    if (typeof setOrUpdateCurrentLocationCursor === 'function') {
                        // è·å–ç”¨æˆ·çŠ¶æ€é¢œè‰²(ä¼˜å…ˆä½¿ç”¨å½“å‰çŠ¶æ€é¢œè‰²)
                        const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                        const statusColor = statusConfig.status_color;
                        // ä½¿ç”¨çŠ¶æ€é¢œè‰²
                        const pulseColor = statusColor;

                        // è·å–GitHubç”¨æˆ·åå’Œå¤´åƒURL
                        // åˆ¤æ–­é€»è¾‘:å¦‚æœ github_username ä¸ºç©ºã€æˆ–è€…æ˜¯é»˜è®¤å€¼,åˆ™ä¸è¦è¯·æ±‚ GitHub å›¾ç‰‡
                        const githubUsername = localStorage.getItem('github_username') || null;
                        let avatarUrl = null;
                        
                        if (isValidGitHubUsername(githubUsername)) {
                            // åªæœ‰æœ‰æ•ˆçš„GitHubç”¨æˆ·åæ‰ç”Ÿæˆå¤´åƒURL
                            avatarUrl = getGitHubAvatarUrl(githubUsername);
                        } else {
                            // æ— æ•ˆç”¨æˆ·åæ—¶,ä½¿ç”¨é»˜è®¤å¤´åƒ
                            avatarUrl = DEFAULT_AVATAR;
                        }
                        
                        // ã€ä¿®å¤ã€‘ä½¿ç”¨æŒä¹…åŒ–å…‰æ ‡å‡½æ•° setOrUpdateCurrentLocationCursor ä»£æ›¿ triggerMapPulse
                        // è¿™æ ·å…‰æ ‡ä¼šä¸€ç›´æ˜¾ç¤º,ä¸ä¼š5ç§’åæ¶ˆå¤±,å¹¶ä¸”æ”¯æŒæ‰‹åŠ¨å®šä½å’Œç¼©æ”¾æ‹–åŠ¨
                        try {
                            setOrUpdateCurrentLocationCursor(finalLng, finalLat, pulseColor, avatarUrl, githubUsername);
                            console.log('[AutoReport] ğŸ—ºï¸ å·²åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºæŒä¹…åŒ–å…‰æ ‡:', {
                                lng: finalLng,
                                lat: finalLat,
                                color: pulseColor,
                                status: currentUserStatus,
                                is_vpn,
                                isLocked,
                                avatarUrl,
                                githubUsername,
                                isValid: isValidGitHubUsername(githubUsername)
                            });
                            
                            // ä¿å­˜å…‰æ ‡ä½ç½®åˆ°å…¨å±€å˜é‡,ä¾›åç»­ä½¿ç”¨
                            window.currentUserLocation = { lng: finalLng, lat: finalLat, color: pulseColor };
                        } catch (pulseError) {
                            console.warn('[AutoReport] âš ï¸ è°ƒç”¨ setOrUpdateCurrentLocationCursor å¤±è´¥:', pulseError);
                        }
                    } else {
                        console.warn('[AutoReport] âš ï¸ setOrUpdateCurrentLocationCursor å‡½æ•°æœªå®šä¹‰,è·³è¿‡åœ°å›¾æ˜¾ç¤º');
                    }
                } else {
                    console.log('[AutoReport] â„¹ï¸ ç»çº¬åº¦ä¿¡æ¯ä¸å®Œæ•´,è·³è¿‡åœ°å›¾æ˜¾ç¤º');
                }

                return { success: true, data };

            } catch (error) {
                console.error('[AutoReport] âŒ è‡ªåŠ¨ä¸ŠæŠ¥è¿‡ç¨‹å‡ºé”™:', error);
                return { success: false, error: error.message };
            }
            } catch (outerErr) {
                console.warn('[AutoReport] å¤–å±‚å®¹é”™:', outerErr);
                return { success: false, error: outerErr?.message || 'autoReportSelf å¼‚å¸¸' };
            }
        }

        /**
         * æäº¤ç”¨æˆ·åˆ†ææ•°æ®åˆ° user_analysis è¡¨ï¼ˆé‡‡é›†ç«¯å¢å¼ºï¼‰
         * åœ¨ insert æ—¶è‡ªåŠ¨å¢åŠ  timezone å’Œ browser_lang å­—æ®µ
         * @param {string} user_name - ç”¨æˆ·å
         * @param {string} personality_type - äººæ ¼ç±»å‹
         * @param {number} lat - çº¬åº¦
         * @param {number} lng - ç»åº¦
         * @returns {Promise<Object>} æäº¤ç»“æœ
         */
        async function submitUserAnalysis(user_name, personality_type, lat, lng) {
            // å¥å£®æ€§æ£€æŸ¥ï¼šç¡®ä¿ Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–
            if (!supabaseClient) {
                console.warn('[Submit] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•æäº¤æ•°æ®');
                return { success: false, error: 'Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–' };
            }

            try {
                // å¼‚æ­¥è·å–ç³»ç»Ÿç‰¹å¾ï¼ˆéé˜»å¡ï¼Œä¸å½±å“é¡µé¢åŠ è½½é€Ÿåº¦ï¼‰
                const systemFeatures = await getUserSystemFeatures();
                console.log('[Submit] ğŸ“Š ç³»ç»Ÿç‰¹å¾å·²è·å–:', systemFeatures);

                // æ„å»ºæäº¤æ•°æ®ï¼ˆåŒ…å« timezone å’Œ browser_lang å­—æ®µï¼‰
                const payload = {
                    user_name: user_name || 'åŒ¿åç”¨æˆ·',
                    personality_type: personality_type || 'UNKNOWN',
                    lat: lat || null,
                    lng: lng || null,
                    timezone: systemFeatures.timezone, // ä½¿ç”¨ Intl.DateTimeFormat().resolvedOptions().timeZone
                    browser_lang: systemFeatures.browser_lang // ä½¿ç”¨ navigator.language
                };

                console.log('[Submit] ğŸ“¤ å‡†å¤‡æäº¤æ•°æ®åˆ° user_analysis è¡¨:', payload);

                // ä½¿ç”¨ Supabase å®¢æˆ·ç«¯æ’å…¥æ•°æ®
                const { data, error } = await supabaseClient
                    .from('user_analysis')
                    .insert([payload])
                    .select();

                if (error) {
                    console.error('[Submit] âŒ æäº¤å¤±è´¥:', error);
                    return { success: false, error: error.message };
                }

                console.log('[Submit] âœ… æ•°æ®å·²æˆåŠŸæäº¤ï¼ˆåŒ…å« timezone å’Œ browser_langï¼‰:', data);
                return { success: true, data };

            } catch (error) {
                console.error('[Submit] âŒ æäº¤è¿‡ç¨‹å‡ºé”™:', error);
                return { success: false, error: error.message };
            }
        }

        /**
         * æ¸²æŸ“ Dashboard æ•°æ®
         * @param {Object} data - è¦æ¸²æŸ“çš„æ•°æ®å¯¹è±¡
         */
        async function renderDashboard(data) {
            // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›è¯­è¨€åˆ‡æ¢æ—¶ä½¿ç”¨
            window.lastData = data;
            
            // ä¿å­˜åˆ° localStorage ç¼“å­˜
            if (data) {
                try {
                    localStorage.setItem('dashboard_data_cache', JSON.stringify({
                        data: data,
                        time: Date.now()
                    }));
                    console.log('[CACHE] æ•°æ®å·²ç¼“å­˜');
                } catch (e) { /* ignore */ }
            }

            // --- æ¸²æŸ“æ•°å­—å¡ç‰‡ ---
            // ã€ID å­˜åœ¨æ€§æ£€æŸ¥ã€‘åœ¨æ‰§è¡Œ animateValue å‰ï¼Œå¿…é¡»æ£€æŸ¥ document.getElementById æ˜¯å¦éç©º
            // ã€åŠ¨ç”»å®¹é”™ã€‘é˜²æ­¢ NaN æˆ– undefined å¯¼è‡´å´©æºƒ
            
            // æ•°æ®è¿”å›ï¼šç§»é™¤éª¨æ¶å±å¹¶å¼€å§‹æ•°å­—æ»šåŠ¨
            setLoadingState(false);

            // 1. å·²è¯Šæ–­å¼€å‘è€…ï¼ˆåƒåˆ†ä½ï¼‰
            const totalUsers = data.totalUsers !== undefined && data.totalUsers !== null ? Number(data.totalUsers) : undefined;
            if (totalUsers !== undefined) {
                animateValue('totalUsers', totalUsers, 1400, { decimals: 0, useThousands: true });
            }
            // ä½“æ£€äººæ•°ï¼šä¸å·²ä¸Šä¼ èŠå¤©è®°å½•äººæ•°ä¸€è‡´
            const physicalExamEl = document.getElementById('physical-exam-count');
            if (physicalExamEl) {
                if (totalUsers !== undefined) {
                    animateValue('physical-exam-count', totalUsers, 1400, { decimals: 0, useThousands: true });
                } else {
                    physicalExamEl.textContent = '--';
                }
            }

            // 2. æ‰«ææ¬¡æ•° (totalAnalysis)
            const totalAnalysis = data.totalAnalysis !== undefined && data.totalAnalysis !== null ? Number(data.totalAnalysis) : undefined;
            if (totalAnalysis !== undefined) {
                animateValue('totalAnalysis', totalAnalysis, 1400, { decimals: 0, useThousands: true });
            }

            // 3. ç´¯è®¡åæ§½å­—æ•°ï¼šç»‘å®šåˆ° json.totalChars (276355)
            const totalChars = data.totalChars !== undefined && data.totalChars !== null ? Number(data.totalChars) : (data.totalRoastWords !== undefined && data.totalRoastWords !== null ? Number(data.totalRoastWords) : undefined);
            if (totalChars !== undefined) {
                animateValue('totalChars', totalChars, 1400, { decimals: 0, useThousands: true });
            }

            // 4. äººå‡å¹³å‡ç¯‡å¹… (avgPerUser)ï¼štotalChars / totalUsers
            let avgPerUser = data.avgPerUser !== undefined && data.avgPerUser !== null ? Number(data.avgPerUser) : undefined;
            if ((avgPerUser === undefined || avgPerUser === 0) && totalChars !== undefined && data.totalUsers !== undefined && data.totalUsers > 0) {
                avgPerUser = totalChars / Number(data.totalUsers);
            }
            if (avgPerUser !== undefined && avgPerUser > 0) {
                animateValue('avgPerUser', avgPerUser, 900, { decimals: 1, useThousands: true });
            }

            // 5. å•æ¬¡å¹³å‡ç¯‡å¹… (avgPerScan)ï¼štotalChars / totalAnalysis
            let avgPerScan = data.avgPerScan !== undefined && data.avgPerScan !== null ? Number(data.avgPerScan) : undefined;
            if ((avgPerScan === undefined || avgPerScan === 0) && totalChars !== undefined && data.totalAnalysis !== undefined && data.totalAnalysis !== null && data.totalAnalysis > 0) {
                avgPerScan = totalChars / Number(data.totalAnalysis);
            }
            if (avgPerScan !== undefined && avgPerScan > 0) {
                animateValue('avgPerScan', avgPerScan, 900, { decimals: 1, useThousands: true });
            }

            // 6. è¿è¡Œå¤©æ•°
            const systemDays = data.systemDays !== undefined && data.systemDays !== null ? Number(data.systemDays) : undefined;
            if (systemDays !== undefined) {
                animateValue('systemDays', systemDays, 900, { decimals: 0, useThousands: true });
            }

            // 7. è¦†ç›–åŸå¸‚
            const cityCount = data.cityCount !== undefined && data.cityCount !== null ? Number(data.cityCount) : undefined;
            if (cityCount !== undefined) {
                animateValue('cityCount', cityCount, 900, { decimals: 0, useThousands: true });
            }

            // --- æ¸²æŸ“äººæ ¼åˆ†å¸ƒæ’è¡Œ ---
            // ã€äººæ ¼æ’è¡Œæ¸²æŸ“å‡½æ•°ã€‘ä½¿ç”¨ç‹¬ç«‹çš„ renderPersonalityRank å‡½æ•°
            renderPersonalityRank(data.personalityRank, data.recentVictims);

            // --- æ¸²æŸ“å›¾è¡¨ç»„ä»¶ ---
            // æ¸²æŸ“åœ°ç†ä½ç½®çƒ­åŠ›æ’è¡Œå’Œåœ°å›¾ï¼ˆä¼˜å…ˆä½¿ç”¨ countryStats å›½å®¶ç´¯ç§¯ï¼Œå¦åˆ™ locationRankï¼‰
            const mapOpts = (data.countryStats && data.countryStats.length > 0)
                ? { countryStats: data.countryStats, updatedAt: data.countryStatsUpdatedAt }
                : {};
            const mapData = (data.countryStats && data.countryStats.length > 0) ? [] : (data.locationRank || []);
            if (mapData.length > 0 || (mapOpts.countryStats && mapOpts.countryStats.length > 0)) {
                if (typeof echarts === 'undefined') {
                    console.warn('[fetchData] âš ï¸ ECharts æœªåŠ è½½ï¼Œå»¶è¿Ÿåˆå§‹åŒ–åœ°å›¾...');
                    setTimeout(async () => {
                        if (typeof echarts !== 'undefined') {
                            try {
                                await initGlobalMap(mapData.length > 0 ? mapData : [], mapOpts);
                            } catch (mapError) {
                                console.error('[fetchData] âŒ å»¶è¿Ÿåœ°å›¾åˆå§‹åŒ–å¤±è´¥:', mapError);
                            }
                        } else {
                            console.error('[fetchData] âŒ ECharts ä»æœªåŠ è½½ï¼Œæ— æ³•åˆå§‹åŒ–åœ°å›¾');
                        }
                    }, 1000);
                } else {
                    try {
                        await initGlobalMap(mapData.length > 0 ? mapData : [], mapOpts);
                    } catch (mapError) {
                        console.error('[fetchData] âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', mapError);
                    }
                    try {
                        renderLocationList(data.locationRank || []);
                    } catch (listError) {
                        console.error('[fetchData] âŒ ä½ç½®åˆ—è¡¨æ¸²æŸ“å¤±è´¥:', listError);
                    }
                }
            } else {
                const locationListEl = document.getElementById('locationList');
                if (locationListEl) {
                    locationListEl.innerHTML = '<div class="text-center text-zinc-500 py-4 text-[10px]">æš‚æ— æ•°æ®</div>';
                }
                if (typeof echarts !== 'undefined') {
                    try {
                        await initGlobalMap([], {});
                    } catch (mapError) {
                        console.warn('[fetchData] âš ï¸ ç©ºåœ°å›¾åˆå§‹åŒ–å¤±è´¥:', mapError);
                    }
                }
            }
            
            // æ¸²æŸ“é›·è¾¾å›¾ï¼ˆä¼˜å…ˆä½¿ç”¨ globalAverageï¼Œå¦åˆ™ä½¿ç”¨ averagesï¼‰
            // ã€ç¯å¢ƒå¯¹é½ã€‘ç¡®ä¿æ‰€æœ‰çš„ Number() è½¬æ¢é€»è¾‘åœ¨èµ‹å€¼å‰å®Œæˆï¼Œå½»åº•åˆ é™¤ç¡¬ç¼–ç 
            const radarData = data.globalAverage || data.averages;
            if (radarData && typeof radarData === 'object' && typeof Chart !== 'undefined') {
                // ç¡®ä¿æ‰€æœ‰å€¼éƒ½æ˜¯æ•°å­—ç±»å‹ï¼Œå¦‚æœæ¥å£æœ‰å€¼åˆ™å¿…é¡»æ˜¾ç¤ºæ¥å£çš„å€¼
                const normalizedRadarData = {
                    L: radarData.L !== undefined && radarData.L !== null ? Number(radarData.L) : undefined,
                    P: radarData.P !== undefined && radarData.P !== null ? Number(radarData.P) : undefined,
                    D: radarData.D !== undefined && radarData.D !== null ? Number(radarData.D) : undefined,
                    E: radarData.E !== undefined && radarData.E !== null ? Number(radarData.E) : undefined,
                    F: radarData.F !== undefined && radarData.F !== null ? Number(radarData.F) : undefined,
                };
                console.log(`[é›·è¾¾å›¾] æ•°æ®: L=${normalizedRadarData.L}, P=${normalizedRadarData.P}, D=${normalizedRadarData.D}, E=${normalizedRadarData.E}, F=${normalizedRadarData.F}`);
                renderRadarChart(normalizedRadarData);
            } else {
                console.warn('[é›·è¾¾å›¾] âŒ æ•°æ®æ ¼å¼é”™è¯¯æˆ– Chart.js æœªåŠ è½½');
            }
            
            // æ¸²æŸ“å®æ—¶è¯Šæ–­æ´»åŠ¨ï¼ˆä¼˜å…ˆä½¿ç”¨ latestRecordsï¼‰
            const activityData = data.latestRecords && data.latestRecords.length > 0 
                ? data.latestRecords 
                : (data.recentVictims || []);
            
            // åˆå§‹åŒ–å…¨å±€ latestRecords æ•°ç»„ï¼ˆç”¨äº Realtime æ›´æ–°ï¼‰
            latestRecords = Array.isArray(activityData) ? [...activityData] : [];
            // ç¡®ä¿é•¿åº¦ä¸è¶…è¿‡ 10
            if (latestRecords.length > 10) {
                latestRecords = latestRecords.slice(0, 10);
            }
            
            renderRecentActivity(latestRecords);

            // åˆå§‹åŒ– window.allDataï¼ˆç”¨äº LPDEF ä¸“å®¶ç­›é€‰ - é€‰æ‹”å„ç»´åº¦æœ€å¼ºç‹è€…ï¼‰
            // ä¼˜å…ˆä½¿ç”¨ latestRecordsï¼ˆåŒ…å«æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ recentVictims
            const allDataArray = Array.isArray(data.latestRecords) && data.latestRecords.length > 0
                ? [...data.latestRecords]
                : (Array.isArray(data.recentVictims) && data.recentVictims.length > 0
                    ? [...data.recentVictims]
                    : []);
            
            // ã€å…¨çƒæœ€å¼ºæ•°æ®æå–ã€‘éå† latestRecords æ‰¾åˆ°ç¬¬ä¸€ä¸ª jiafang_count > 0 çš„è®°å½•ä½œä¸º'å…¨çƒæœ€å¼º'çš„å±•ç¤ºæ•°æ®
            let globalChampionRecord = null;
            if (allDataArray.length > 0) {
                globalChampionRecord = allDataArray.find(record => {
                    const jiafangCount = record.jiafang_count !== undefined && record.jiafang_count !== null ? Number(record.jiafang_count) : 0;
                    return jiafangCount > 0;
                });
                if (globalChampionRecord) {
                    console.log('[Global] âœ… æ‰¾åˆ°å…¨çƒæœ€å¼ºè®°å½•ï¼ˆjiafang_count > 0ï¼‰:', globalChampionRecord);
                    // å°†å…¨çƒæœ€å¼ºè®°å½•å­˜å‚¨åˆ°å…¨å±€å˜é‡
                    window.globalChampionRecord = globalChampionRecord;
                }
            }
            
            window.allData = allDataArray;
            console.log(`[LPDEF] ğŸ“¦ å·²åˆå§‹åŒ– window.allDataï¼Œå…± ${allDataArray.length} æ¡æ•°æ®ï¼ˆç”¨äºé€‰æ‹”æœ€å¼ºç‹è€…ï¼‰`);

            // åˆ·æ–°åé¢„å¡«å·¦ä¾§æŠ½å±‰ã€Œæˆ‘çš„æ•°æ®ç»Ÿè®¡ã€ï¼Œé¿å…æœªç‚¹å‡»åœ°å›¾æ—¶å·¦ä¾§æ— æ•°æ®
            try {
                const code = localStorage.getItem('user_selected_country') || 'CN';
                const name = (typeof countryNameMap !== 'undefined' && countryNameMap[code])
                    ? (typeof currentLang !== 'undefined' && currentLang === 'zh' ? countryNameMap[code].zh : countryNameMap[code].en)
                    : code;
                if (typeof showDrawersWithCountryData === 'function') {
                    showDrawersWithCountryData(code, name);
                }
            } catch (e) { /* ignore */ }

            // æ³¨æ„ï¼šLPDEF ä¸“å®¶å¡ç‰‡å°†åœ¨ window.onload çš„èº«ä»½æ£€æŸ¥åæ¸²æŸ“
            // è¿™é‡Œä¸è°ƒç”¨ renderLPDEFExpertsï¼Œé¿å…è¦†ç›–èº«ä»½æ£€æŸ¥çš„ç»“æœ

            // ã€ä¿®å¤ã€‘æ¸²æŸ“é«˜åˆ†å›¾è°±ï¼ˆå…­ä¸ªæ’è¡Œæ¦œå¡ç‰‡ï¼‰
            try {
                if (typeof drawHighScores === 'function' && data.topByMetrics && Array.isArray(data.topByMetrics) && data.topByMetrics.length > 0) {
                    drawHighScores(data.topByMetrics);
                    console.log('[Dashboard] âœ… é«˜åˆ†å›¾è°±æ¸²æŸ“å®Œæˆ:', data.topByMetrics.length, 'ä¸ªç»´åº¦');
                } else {
                    console.log('[Dashboard] âš ï¸ é«˜åˆ†å›¾è°±æ•°æ®ä¸å¯ç”¨:', { hasFunction: typeof drawHighScores === 'function', topByMetrics: data.topByMetrics });
                }
            } catch (e) {
                console.warn('[Dashboard] âš ï¸ æ¸²æŸ“é«˜åˆ†å›¾è°±å¤±è´¥:', e);
            }

            console.log('%c [5/5] âœ… æ¸²æŸ“é€»è¾‘åŒæ­¥å®Œæ¯• ', 'color: #00ff41');
        }

        /**
         * æ˜¾ç¤º API çŠ¶æ€è­¦å‘Šï¼ˆå½“ API åœ¨å›½å†…æ— æ³•è®¿é—®æ—¶ï¼‰
         */
        /**
         * æ˜¾ç¤º API çŠ¶æ€è­¦å‘Šï¼ˆæŠ€æœ¯ç”¨æˆ·ç‰ˆæœ¬ï¼Œå«è¯Šæ–­ä¿¡æ¯ï¼‰
         * @param {string} mode - 'CACHE' | 'ERROR'
         */
        function showApiStatusWarning(mode = 'ERROR') {
            if (document.getElementById('api-status-warning')) return;
            
            const container = document.querySelector('.max-w-\\[1600px\\]') || document.body;
            const warningDiv = document.createElement('div');
            warningDiv.id = 'api-status-warning';
            
            // æ ¹æ®æ¨¡å¼è®¾ç½®ä¸åŒæ ·å¼
            const isCache = mode === 'CACHE';
            const accentColor = isCache ? 'text-blue-400' : 'text-[var(--accent-terminal)]';
            const borderColor = isCache ? 'border-blue-500' : 'border-[var(--accent-terminal)]';
            const modeText = isCache ? 'CACHED_DATA' : 'OFFLINE';
            const statusText = isCache ? 'ä½¿ç”¨ç¼“å­˜æ•°æ®' : 'APIè¿æ¥å¤±è´¥';
            
            warningDiv.className = `fixed top-4 right-4 bg-zinc-900/95 text-zinc-100 px-4 py-3 rounded-lg border ${borderColor} z-50 text-xs max-w-md shadow-2xl backdrop-blur-sm font-mono`;
            
            // è·å–è¯Šæ–­ä¿¡æ¯
            const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || 'N/A';
            
            let contentHTML = `
                <div class="flex flex-col gap-2">
                    <div class="flex items-center gap-2 ${accentColor}">
                        <span>${isCache ? 'ğŸ’¾' : 'ğŸ”Œ'}</span>
                        <span class="font-bold">${statusText}</span>
                    </div>
                    
                    <div class="text-zinc-400 space-y-1">
                        <div><span class="text-zinc-500">ENDPOINT:</span> ${apiEndpoint.replace('https://', '')}</div>
                        <div><span class="text-zinc-500">STATUS:</span> <span class="text-red-400">Connection timeout</span></div>
                        <div><span class="text-zinc-500">MODE:</span> <span class="${accentColor}">${modeText}</span></div>
                    </div>
            `;
            
            // ç¼“å­˜æ¨¡å¼æç¤º
            if (isCache) {
                contentHTML += `
                    <div class="mt-2 bg-blue-950/30 p-2 rounded border-l-2 border-blue-500">
                        <div class="text-blue-200 font-semibold mb-1">ğŸ’¾ ç¼“å­˜æ•°æ®</div>
                        <div class="text-blue-200/70 text-[10px]">
                            å½“å‰æ˜¾ç¤ºçš„æ˜¯æœ¬åœ°ç¼“å­˜æ•°æ®ï¼Œå¯èƒ½ä¸æ˜¯æœ€æ–°çš„ã€‚<br>
                            è¿æ¥ç½‘ç»œåå¯è·å–æœ€æ–°æ•°æ®ã€‚
                        </div>
                    </div>
                `;
            }
            
            contentHTML += `
                    <div class="mt-2 bg-black/40 p-2 rounded border-l-2 ${borderColor}">
                        <div class="text-zinc-300 font-semibold mb-1">QUICK_FIX:</div>
                        <ol class="list-decimal list-inside space-y-0.5 text-zinc-400">
                            <li>æ£€æŸ¥ä»£ç†: <code class="${accentColor}">curl ${apiEndpoint.replace('https://', '')}</code></li>
                            <li>åˆ‡æ¢èŠ‚ç‚¹: å°è¯• HK/SG/JP èŠ‚ç‚¹</li>
                            <li>åˆ·æ–°é¡µé¢: ç‚¹å‡»å³ä¸‹è§’é‡è¯•æŒ‰é’®</li>
                        </ol>
                    </div>
                    
                    <div class="flex gap-2 mt-1">
                        <button onclick="window.diagnoseNetwork()" class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 rounded text-zinc-300 transition-colors">ğŸ” è¯Šæ–­</button>
                        <button onclick="location.reload()" class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 rounded text-white transition-colors">â†» é‡è¯•</button>
                        <button onclick="document.getElementById('api-status-warning').remove()" class="px-2 py-1 hover:bg-zinc-800 rounded text-zinc-500 transition-colors">âœ•</button>
                    </div>
                </div>
            `;
            
            warningDiv.innerHTML = contentHTML;
            container.appendChild(warningDiv);
            
            // 20ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    warningDiv.style.opacity = '0';
                    warningDiv.style.transition = 'opacity 0.5s';
                    setTimeout(() => warningDiv.remove(), 500);
                }
            }, 20000);
        }
        
        /**
         * ç½‘ç»œè¯Šæ–­å·¥å…·ï¼ˆæŠ€æœ¯ç”¨æˆ·ï¼‰
         */
        window.diagnoseNetwork = async function() {
            console.group('[Network Diagnose] ğŸ” ç½‘ç»œè¯Šæ–­');
            const results = [];
            
            // æµ‹è¯•ç›®æ ‡
            const tests = [
                { name: 'Cloudflare API', url: 'https://cursor-clinical-analysis.psterman.workers.dev/api/health', timeout: 3000 },
                { name: 'Google (ä»£ç†æ£€æµ‹)', url: 'https://www.google.com/generate_204', mode: 'no-cors', timeout: 2000 },
                { name: 'GitHub', url: 'https://github.com/favicon.ico', mode: 'no-cors', timeout: 3000 },
                { name: 'Vercel (å¤‡ç”¨)', url: 'https://vercel.com/favicon.ico', mode: 'no-cors', timeout: 3000 }
            ];
            
            for (const test of tests) {
                const start = performance.now();
                try {
                    await fetch(test.url, { 
                        mode: test.mode || 'cors', 
                        signal: AbortSignal.timeout(test.timeout)
                    });
                    const latency = Math.round(performance.now() - start);
                    results.push({ name: test.name, status: 'OK', latency: latency + 'ms' });
                    console.log(`âœ… ${test.name}: ${latency}ms`);
                } catch (err) {
                    results.push({ name: test.name, status: 'FAIL', error: err.name });
                    console.log(`âŒ ${test.name}: ${err.name}`);
                }
            }
            
            console.table(results);
            console.groupEnd();
            
            // æ˜¾ç¤ºç»“æœ
            alert('ç½‘ç»œè¯Šæ–­ç»“æœå·²è¾“å‡ºåˆ° Console (F12 â†’ Console)\n\n' + 
                  results.map(r => `${r.status === 'OK' ? 'âœ…' : 'âŒ'} ${r.name}: ${r.latency || r.error}`).join('\n'));
        };

        /**
         * è·å–å¹¶æ¸²æŸ“å¤§ç›˜æ•°æ®
         * åŸºäº index.ts çš„æ¥å£è¿”å›æ ¼å¼ï¼ˆæ•°æ®ç›´æ¥è¿”å›ï¼Œä¸åŒ…è£¹åœ¨ data å­—æ®µä¸­ï¼‰
         */
        async function fetchData() {
            // ã€æ€§èƒ½ä¿æŠ¤ã€‘é”å®šæ ‡å¿—ï¼Œé˜²æ­¢ç½‘ç»œæ…¢æ—¶ç”¨æˆ·å¤šæ¬¡è§¦å‘åˆ·æ–°å¯¼è‡´è¯·æ±‚å †ç§¯
            if (window.__globalStatsUpdating) {
                if (window.__fetchDataPromise) return await window.__fetchDataPromise;
                return;
            }
            try {
                if (window.__fetchDataPromise) {
                    return await window.__fetchDataPromise;
                }
            } catch { /* ignore */ }

            window.__globalStatsUpdating = true;
            window.__fetchDataPromise = (async () => {
            try {
                let apiEndpoint = window.getApiEndpoint ? window.getApiEndpoint() : document.querySelector('meta[name="api-endpoint"]')?.content;
                // ç§»é™¤æœ«å°¾æ–œæ ï¼Œé¿å…åŒæ–œæ 
                if (apiEndpoint && apiEndpoint.endsWith('/')) {
                    apiEndpoint = apiEndpoint.slice(0, -1);
                }
                console.group('%c ğŸš€ Dashboard Data Sync Starting ', 'background: #222; color: #bada55; font-size: 12px;');
                // åŠ è½½è¿‡åœºï¼šéª¨æ¶å± + æ‰«æçº¿
                setLoadingState(true);

                var _rfp = '';
                try { _rfp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                const requestUrl = `${apiEndpoint}/api/global-average?fingerprint=${encodeURIComponent(_rfp)}&_t=${Date.now()}`;
                const countryStatsUrl = `${apiEndpoint}/api/v2/country-stats-global?_t=${Date.now()}`;
                console.log(`[1/5] å¹¶è¡Œè¯·æ±‚: global-average + country-stats-global`);

                // Promise.all åŒæ—¶è¯·æ±‚ä¸¤ä¸ª API
                const fetchGlobal = window.apiFetch ? window.apiFetch('/api/global-average', { timeout: 4000 }) : fetch(requestUrl);
                const fetchCountry = fetch(countryStatsUrl).catch(() => null);
                const [globalResp, countryResp] = await Promise.all([fetchGlobal, fetchCountry]);

                if (!globalResp.ok) throw new Error(`HTTP Error! Status: ${globalResp.status}`);
                const result = await globalResp.json();

                let countryStatsResp = { data: [], updated_at: null };
                if (countryResp && countryResp.ok) {
                    try {
                        const j = await countryResp.json();
                        countryStatsResp = { data: (j && j.data) ? j.data : [], updated_at: (j && j.updated_at) ? j.updated_at : null };
                    } catch (_) { /* ignore */ }
                }
                console.log('[2/5] æ”¶åˆ°åŸå§‹å“åº”:', result);

                // ã€é€‚é…å±‚é‡å†™ã€‘ä½¿ç”¨å¼ºåˆ¶æ˜ å°„å±‚æ ‡å‡†åŒ–æ•°æ®
                const data = normalizeData(result);
                data.countryStats = countryStatsResp.data;
                data.countryStatsUpdatedAt = countryStatsResp.updated_at;
                console.log('[3/5] æ•°æ®é€‚é…å®Œæˆ:', data);

                // æ¸²æŸ“ Dashboard
                await renderDashboard(data);

                // æ‰§è¡Œè‡ªåŠ¨ä¸ŠæŠ¥ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼‰â€”â€”åªæ‰§è¡Œä¸€æ¬¡ï¼Œé¿å…é‡å¤æ—¥å¿—/é‡å¤æµç¨‹
                try {
                    if (!window.__autoReportSelfOnce) {
                        window.__autoReportSelfOnce = true;
                        autoReportSelf().catch(err => {
                            console.warn('[AutoReport] âš ï¸ è‡ªåŠ¨ä¸ŠæŠ¥å¤±è´¥ï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰:', err);
                        });
                    }
                } catch { /* ignore */ }

            } catch (err) {
                console.error('[ERROR] Dashboard æ¸²æŸ“å´©æºƒ:', err);
                
                // å°è¯•ä» localStorage è¯»å–ç¼“å­˜æ•°æ®
                let cachedData = null;
                try {
                    const cached = localStorage.getItem('dashboard_data_cache');
                    if (cached) {
                        const parsed = JSON.parse(cached);
                        if (parsed.data && Date.now() - parsed.time < 3600000) { // 1å°æ—¶å†…ç¼“å­˜æœ‰æ•ˆ
                            cachedData = parsed.data;
                            console.log('[CACHE] ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®');
                        }
                    }
                } catch (e) { /* ignore */ }
                
                // ä¼˜å…ˆä½¿ç”¨ç¼“å­˜æ•°æ®
                if (cachedData) {
                    console.log('[CACHE] æ¸²æŸ“ç¼“å­˜æ•°æ®');
                    window.lastData = cachedData;
                    await renderDashboard(cachedData);
                    showApiStatusWarning('CACHE');
                } else {
                    // æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    console.log('[ERROR] æ— å¯ç”¨æ•°æ®ï¼ˆAPIè¿æ¥å¤±è´¥ä¸”æ— ç¼“å­˜ï¼‰');
                    showApiStatusWarning('ERROR');
                    // æ˜¾ç¤ºç©ºçŠ¶æ€æˆ–é”™è¯¯æç¤º
                    document.getElementById('totalUsers').textContent = '-';
                    document.getElementById('totalAnalysis').textContent = '-';
                    const pec = document.getElementById('physical-exam-count');
                    if (pec) pec.textContent = '-';
                }
            } finally {
                // ç¡®ä¿å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿå…³é—­åŠ è½½è¿‡åœºï¼›æ’åè®¡ç®—ä¸­çŠ¶æ€éšè—ï¼šå¼ºåˆ¶å…³æ‰åŠ è½½å±‚
                setLoadingState(false);
                try {
                    var lo = document.getElementById('loading-overlay');
                    if (lo) lo.classList.add('hidden');
                } catch (e) { /* ignore */ }
                console.groupEnd();
                window.__globalStatsUpdating = false;
            }
            })();

            try {
                return await window.__fetchDataPromise;
            } finally {
                try { window.__fetchDataPromise = null; } catch { /* ignore */ }
            }
        }

        /**
         * åŠ è½½ rank-content.ts æ•°æ®
         * çº¿ä¸Šï¼ˆCloudflareï¼‰ï¼šä¼˜å…ˆä» Worker /api/rank-resources æ‹‰å–ï¼Œé¿å… /src/rank-content.ts ç­‰é™æ€è·¯å¾„ 404
         */
        async function loadRankResources() {
            try {
                // ä¼˜å…ˆä» Worker API æ‹‰å–ï¼ˆçº¿ä¸Šéƒ¨ç½²æ—¶é™æ€æ–‡ä»¶è·¯å¾„å¯èƒ½ 404ï¼‰
                const apiEndpoint = (window.getApiEndpoint ? window.getApiEndpoint() : document.querySelector('meta[name="api-endpoint"]')?.content) || '';
                const metaEndpoint = (document.querySelector('meta[name="api-endpoint"]')?.content || '').trim();
                const base = apiEndpoint.endsWith('/') ? apiEndpoint : (apiEndpoint ? apiEndpoint + '/' : '');
                const metaBase = metaEndpoint.endsWith('/') ? metaEndpoint : (metaEndpoint ? metaEndpoint + '/' : '');
                var _fp = '';
                try { _fp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                var _q = 'fingerprint=' + encodeURIComponent(_fp) + '&_t=' + Date.now();
                const urlsToTry = base ? [base + 'api/rank-resources?' + _q] : [];
                if (metaBase && metaBase !== base) urlsToTry.push(metaBase + 'api/rank-resources?' + _q);
                for (const url of urlsToTry) {
                    try {
                        const res = await fetch(url, { cache: 'force-cache', signal: AbortSignal.timeout(8000) });
                        if (res.ok) {
                            const json = await res.json();
                            if (json && typeof json === 'object' && Object.keys(json).length > 0) {
                                RANK_RESOURCES = json;
                                console.log('[Rank] âœ… ä» Worker API åŠ è½½ rank-resources æˆåŠŸ');
                                return true;
                            }
                        }
                    } catch (e) {
                        console.debug('[Rank] Worker rank-resources è¯·æ±‚å¤±è´¥:', e?.message);
                    }
                }
                if (urlsToTry.length > 0) {
                    console.warn('[Rank] Worker API ä¸å¯ç”¨ï¼Œå°è¯•æœ¬åœ°/é™æ€è·¯å¾„');
                }
                // ä¼˜åŒ–ï¼šä¼˜å…ˆå°è¯•è¯»å– TS æ–‡ä»¶ï¼ˆå› ä¸ºç¯å¢ƒç›®å‰è§£æ TS æ–‡ä»¶æ›´ç¨³å®šï¼‰
                const tsPaths = [
                    './src/rank-content.ts',
                    '../src/rank-content.ts',
                    '/src/rank-content.ts',
                    'src/rank-content.ts'
                ];
                
                let text = null;
                let lastError = null;
                
                // ä¼˜å…ˆå°è¯•æ¯ä¸ª TS è·¯å¾„
                for (const path of tsPaths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            const contentType = response.headers.get('content-type') || '';
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡æœ¬æ–‡ä»¶ï¼ˆTS/JS æ–‡ä»¶ï¼‰
                            if (contentType.includes('text/') || contentType.includes('application/javascript') || contentType.includes('application/typescript')) {
                                text = await response.text();
                                console.log(`[Rank] âœ… æˆåŠŸä» ${path} åŠ è½½ TS æ–‡ä»¶`);
                                break;
                            } else {
                                console.debug(`[Rank] ${path} è¿”å›çš„ä¸æ˜¯æ–‡æœ¬æ ¼å¼ (Content-Type: ${contentType})ï¼Œè·³è¿‡`);
                            }
                        } else {
                            console.debug(`[Rank] ${path} è¿”å›çŠ¶æ€ç  ${response.status}ï¼Œè·³è¿‡`);
                        }
                    } catch (err) {
                        lastError = err;
                        console.debug(`[Rank] TS è·¯å¾„ ${path} åŠ è½½å¤±è´¥:`, err.message);
                    }
                }
                
                // å¦‚æœ TS æ–‡ä»¶åŠ è½½æˆåŠŸï¼Œè§£æå¹¶è¿”å›
                if (text) {
                    // ä½¿ç”¨æ›´å¥å£®çš„æ­£åˆ™æå– JSON å¯¹è±¡
                    // ä»ç¬¬ä¸€ä¸ª { åˆ°æœ€åä¸€ä¸ª } ä¹‹é—´çš„å†…å®¹
                    const firstBrace = text.indexOf('{');
                    const lastBrace = text.lastIndexOf('}');
                    
                    if (firstBrace === -1 || lastBrace === -1 || firstBrace >= lastBrace) {
                        console.warn('[Rank] âš ï¸ æ— æ³•ä» rank-content.ts ä¸­æ‰¾åˆ°æœ‰æ•ˆçš„ JSON å¯¹è±¡');
                        return false;
                    }
                    
                    const jsonText = text.substring(firstBrace, lastBrace + 1);
                    
                    // æ¸…ç†æ–‡æœ¬ï¼šç§»é™¤æ³¨é‡Šå’Œç±»å‹æ³¨è§£
                    let cleaned = jsonText
                        .replace(/\/\*[\s\S]*?\*\//g, '') // ç§»é™¤å—æ³¨é‡Š
                        .replace(/\/\/.*$/gm, '') // ç§»é™¤è¡Œæ³¨é‡Š
                        .replace(/:\s*Record<string,\s*any>/g, '') // ç§»é™¤ç±»å‹æ³¨è§£
                        .replace(/:\s*any/g, ''); // ç§»é™¤å…¶ä»– any ç±»å‹æ³¨è§£
                    
                    // å°è¯•è§£æä¸º JSON
                    try {
                        RANK_RESOURCES = JSON.parse(cleaned);
                        console.log('[Rank] âœ… ç»´åº¦æ’åæ•°æ®åŠ è½½æˆåŠŸï¼ˆä» TS æ–‡ä»¶ JSON è§£æï¼‰');
                        return true;
                    } catch (e) {
                        console.warn(`[Rank] âš ï¸ ä» TS æ–‡ä»¶è§£æ JSON å¤±è´¥: ${e.message}`);
                        return false;
                    }
                }
                
                // å¦‚æœ TS æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œé™é»˜å°è¯• JSON æ–‡ä»¶ï¼ˆä½œä¸ºå¤‡é€‰ï¼‰
                const jsonPaths = [
                    './rank-data.json',
                    '../rank-data.json',
                    '/rank-data.json',
                    'rank-data.json'
                ];
                
                // é™é»˜å°è¯• JSON æ–‡ä»¶ï¼ˆä½¿ç”¨ console.debug é¿å…å¹²æ‰°æ§åˆ¶å°ï¼‰
                for (const path of jsonPaths) {
                    try {
                        const response = await fetch(path);
                        // æ£€æŸ¥å“åº”çŠ¶æ€å’Œ Content-Typeï¼Œé¿å… 404 è¿”å› HTML å¯¼è‡´çš„è§£æé”™è¯¯
                        if (response.ok) {
                            const contentType = response.headers.get('content-type') || '';
                            // ç¡®ä¿å“åº”æ˜¯ JSON æ ¼å¼ï¼Œè€Œä¸æ˜¯ HTML é”™è¯¯é¡µé¢
                            if (contentType.includes('application/json') || contentType.includes('text/json')) {
                                const jsonData = await response.json();
                                RANK_RESOURCES = jsonData;
                                console.log(`[Rank] âœ… æˆåŠŸä» ${path} åŠ è½½ JSON æ•°æ®`);
                                return true;
                            } else {
                                // å¦‚æœ Content-Type ä¸æ˜¯ JSONï¼Œå¯èƒ½æ˜¯ 404 è¿”å›çš„ HTMLï¼Œé™é»˜è·³è¿‡
                                console.debug(`[Rank] ${path} è¿”å›çš„ä¸æ˜¯ JSON æ ¼å¼ (Content-Type: ${contentType})ï¼Œè·³è¿‡`);
                            }
                        } else {
                            // å“åº”çŠ¶æ€ä¸æ˜¯ 200-299ï¼Œé™é»˜è·³è¿‡
                            console.debug(`[Rank] ${path} è¿”å›çŠ¶æ€ç  ${response.status}ï¼Œè·³è¿‡`);
                        }
                    } catch (err) {
                        // ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸ï¼Œé™é»˜è®°å½•
                        console.debug(`[Rank] JSON è·¯å¾„ ${path} åŠ è½½å¤±è´¥:`, err.message);
                    }
                }
                
                // å¦‚æœæ‰€æœ‰è·¯å¾„éƒ½å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä½†ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸é¡µé¢ç»§ç»­åŠ è½½
                console.warn(`[Rank] âš ï¸ æ‰€æœ‰è·¯å¾„éƒ½åŠ è½½å¤±è´¥ã€‚æœ€åé”™è¯¯: ${lastError?.message || 'æœªçŸ¥é”™è¯¯'}`);
                return false;
            } catch (error) {
                console.error('[Rank] âŒ åŠ è½½æ’åæ•°æ®å¤±è´¥:', error);
                // è¿”å› falseï¼Œä½†ä¸é˜»æ­¢é¡µé¢ç»§ç»­åŠ è½½
                // æ¸²æŸ“æ—¶ä¼šæ˜¾ç¤ºåŠ è½½ä¸­çš„æç¤º
                return false;
            }
        }

        /**
         * æ ¹æ®ç»´åº¦IDå’Œæ•°å€¼è·å–ç­‰çº§åé¦ˆ
         * @param {string} dimId - ç»´åº¦ID (ai, word, day, no, say, please)
         * @param {number} value - æ•°å€¼
         * @returns {Object|null} åŒ…å« label, title, content çš„å¯¹è±¡ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å› null
         */
        function getRankFeedback(dimId, value) {
            if (!RANK_RESOURCES || !RANK_RESOURCES[dimId]) {
                console.log(`[Rank] ç»´åº¦ ${dimId} ä¸å­˜åœ¨äº RANK_RESOURCESï¼Œè¿”å›é»˜è®¤åé¦ˆ`);
                return null;
            }

            const dim = RANK_RESOURCES[dimId];
            if (!dim.levels || !Array.isArray(dim.levels) || dim.levels.length === 0) {
                console.log(`[Rank] ç»´åº¦ ${dimId} çš„ levels æ•°æ®æ— æ•ˆï¼Œè¿”å›é»˜è®¤åé¦ˆ`);
                return null;
            }

            let matchedLevel = null;

            // 0 å€¼ä¿æŠ¤ï¼šå¦‚æœ value <= 0ï¼Œç›´æ¥å¼ºåˆ¶åŒ¹é…ç¬¬ä¸€ä¸ªç­‰çº§
            if (value <= 0) {
                matchedLevel = dim.levels[0];
                console.log(`[Rank] ç»´åº¦ ${dimId} çš„å€¼ ${value} <= 0ï¼Œè‡ªåŠ¨åŒ¹é…ç¬¬ä¸€ä¸ªç­‰çº§: ${matchedLevel.label}`);
            } else {
                // æŸ¥æ‰¾æ»¡è¶³ value >= min && value <= max çš„ç­‰çº§
                matchedLevel = dim.levels.find(level => {
                    const min = Number(level.min) || 0;
                    const max = Number(level.max) || Infinity;
                    return value >= min && value <= max;
                });

                // æº¢å‡ºä¿æŠ¤ï¼šå¦‚æœæ•°å€¼è¶…è¿‡äº†é…ç½®çš„æœ€å¤§å€¼ï¼Œè‡ªåŠ¨åŒ¹é…æœ€åä¸€ä¸ªç­‰çº§
                if (!matchedLevel) {
                    matchedLevel = dim.levels[dim.levels.length - 1];
                    console.log(`[Rank] ç»´åº¦ ${dimId} çš„å€¼ ${value} è¶…å‡ºèŒƒå›´ï¼Œè‡ªåŠ¨åŒ¹é…æœ€åä¸€ä¸ªç­‰çº§: ${matchedLevel.label}`);
                }
            }

            // éšæœºæŠ½å–ä¸€æ¡è¯„ä»·
            const comments = matchedLevel.commentsZh || [];
            if (comments.length === 0) {
                console.log(`[Rank] ç»´åº¦ ${dimId} çš„ç­‰çº§ ${matchedLevel.label} æ²¡æœ‰è¯„ä»·æ•°æ®ï¼Œè¿”å›é»˜è®¤å†…å®¹`);
                return {
                    label: matchedLevel.label || 'æœªçŸ¥ç­‰çº§',
                    title: 'æš‚æ— è¯„ä»·',
                    content: 'æš‚æ— è¯„ä»·å†…å®¹'
                };
            }

            const randomComment = comments[Math.floor(Math.random() * comments.length)];
            return {
                label: matchedLevel.label || 'æœªçŸ¥ç­‰çº§',
                title: randomComment.title || 'æš‚æ— æ ‡é¢˜',
                content: randomComment.content || 'æš‚æ— å†…å®¹'
            };
        }

        /**
         * ä» lpdef æå– vibe_indexï¼ˆ5 ä½æ•°å­—ï¼‰ï¼Œä¸ worker çš„ generateLPDEF ä¸€è‡´ï¼šL0P1D2E1F0 -> 01210
         * ä¸ index.html çš„ lpdefToVibeIndex ä¿æŒåŒæ­¥ï¼Œç”¨äºç­”æ¡ˆä¹‹ä¹¦æŒ‰ lpdef æŸ¥ answerBookByVibeIndex.json
         */
        function lpdefToVibeIndex(lpdef) {
            if (!lpdef || typeof lpdef !== 'string') return null;
            const digits = String(lpdef).replace(/\D/g, '');
            return digits.length === 5 ? digits : null;
        }

        /**
         * ä» personality.detailedStats æˆ– l_score/p_score/... è®¡ç®— 5 ä½ vibe_index å­—ç¬¦ä¸²ï¼ˆä¸ worker content.ts getVibeIndex ä¸€è‡´ï¼‰
         * å½“è§†å›¾æœªè¿”å› vibe_index_str/lpdef æ—¶ï¼Œç”¨æ­¤ç»“æœåŠ è½½äººæ ¼ç§°å·ä¸ç­”æ¡ˆä¹‹ä¹¦
         */
        function scoresToVibeIndexStr(userData) {
            if (!userData) return null;
            let L = userData.l_score ?? userData.l ?? null;
            let P = userData.p_score ?? userData.p ?? null;
            let D = userData.d_score ?? userData.d ?? null;
            let E = userData.e_score ?? userData.e ?? null;
            let F = userData.f_score ?? userData.f ?? null;
            const stats = userData.personality?.detailedStats || userData.personality_data || userData.personalityData;
            if (Array.isArray(stats) && stats.length > 0) {
                stats.forEach(s => {
                    const dim = (s.dimension || '').toUpperCase();
                    const score = Number(s.score);
                    if (dim === 'L') L = score;
                    else if (dim === 'P') P = score;
                    else if (dim === 'D') D = score;
                    else if (dim === 'E') E = score;
                    else if (dim === 'F') F = score;
                });
            }
            if (L == null && P == null && D == null && E == null && F == null) return null;
            const indexMap = (v) => {
                if (v == null || isNaN(v)) return '1';
                if (Number(v) < 40) return '0';
                if (Number(v) < 70) return '1';
                return '2';
            };
            const eIndex = (v) => {
                if (v == null || isNaN(v)) return '1';
                const n = Number(v);
                if (n < 5) return '0';
                if (n < 10) return '1';
                return '2';
            };
            return [
                indexMap(L),
                indexMap(P),
                indexMap(D),
                eIndex(E),
                indexMap(F)
            ].join('');
        }

        /**
         * ä» allData ä¸­è§£æå‡ºåŒä¸€ç”¨æˆ·çš„æœ€å®Œæ•´è®°å½•ï¼Œç”¨äºå·¦ä¾§æŠ½å±‰ç»Ÿè®¡å±•ç¤º
         * ç¡®ä¿æ˜¾ç¤ºçš„æ˜¯ã€Œæäº¤èŠå¤©è®°å½•å¯¹åº”çš„æ•°æ®å’Œæ•°å€¼ã€ï¼ˆæ¥è‡ª latestRecords/æ¥å£ï¼‰ï¼Œè€Œéä»… upsert è¿”å›çš„ç®€ç•¥å­—æ®µ
         * @param {Object} user - å½“å‰ç”¨æˆ·å¯¹è±¡ï¼ˆå¯èƒ½æ¥è‡ª window.currentUser æˆ– upsert å“åº”ï¼‰
         * @returns {Object} åŒä¸€ç”¨æˆ·åœ¨ allData ä¸­çš„è®°å½•ï¼ˆæ›´å®Œæ•´ï¼‰æˆ–åŸ user
         */
        function getBestUserRecordForStats(user) {
            if (!user) return null;
            const allData = window.allData || [];
            const normalize = (v) => (v == null ? '' : String(v).trim().toLowerCase());
            const isSameUser = (item) => {
                if (!item) return false;
                if (item.id != null && user.id != null && item.id === user.id) return true;
                const itemFp = normalize(item.fingerprint || item.user_fingerprint);
                const userFp = normalize(user.fingerprint || user.user_fingerprint);
                if (itemFp && userFp && itemFp === userFp) return true;
                const itemIdentity = normalize(item.user_identity);
                const userIdentity = normalize(user.user_identity);
                if (itemIdentity && userIdentity && itemIdentity === userIdentity) return true;
                const itemName = normalize(item.user_name || item.name || item.github_username);
                const userName = normalize(user.user_name || user.name || user.github_username);
                return itemName && userName && itemName === userName;
            };

            // å…³é”®ä¿®å¤ï¼šä¸è¦ç”¨ allData é‡Œâ€œç¬¬ä¸€æ¡å‘½ä¸­â€è¦†ç›–æ›´å®Œæ•´çš„è®°å½•ï¼ˆä¾‹å¦‚ Supabase åˆšæ‹‰åˆ°çš„ dbUserï¼‰
            // æ”¹ä¸ºï¼šåœ¨ [user + allData çš„åŒäººè®°å½•] é‡ŒæŒ‰â€œå­—æ®µå®Œæ•´åº¦â€æ‰“åˆ†æ‹©ä¼˜
            const candidates = [user, ...allData.filter(isSameUser)];
            const score = (u) => {
                if (!u) return -1;
                let s = 0;

                // èº«ä»½/ä¸»é”®å­—æ®µ
                if (u.id != null) s += 3;
                if (u.user_id != null) s += 2;
                if (u.github_id != null) s += 2;
                if (u.fingerprint || u.user_fingerprint) s += 2;
                if (u.user_identity) s += 1;

                // ç»´åº¦/ç»Ÿè®¡å­—æ®µï¼ˆè¦†ç›– renderUserStatsCards ä¸ extractDimensionValues çš„å®é™…ç”¨æ³•ï¼‰
                const statKeys = [
                    'dimensions',
                    'l_score','p_score','d_score','e_score','f_score',
                    'l','p','d','e','f',
                    'L','P','D','E','F',
                    'question_message_count','total_messages',
                    'total_chars','total_chars','totalUserChars',
                    'avg_message_length','avgMessageLength','avgUserMessageLength',
                    'work_days','usage_days','days',
                    'jiafang_count','ketao_count',
                    'vibe_rank','vibe_percentile','avg_rank'
                ];
                statKeys.forEach((k) => {
                    const v = u[k];
                    if (v !== undefined && v !== null && v !== '' && !(typeof v === 'number' && Number.isNaN(v))) s += 1;
                });

                // JSON/ç»“æ„åŒ–å­—æ®µ
                if (u.personality || u.personality_data || u.personalityData) s += 2;
                if (u.answer_book || u.answerBook) s += 1;
                if (u.personality_name || u.personalityName) s += 1;

                return s;
            };

            let best = candidates[0] || null;
            let bestScore = score(best);
            for (let i = 1; i < candidates.length; i++) {
                const c = candidates[i];
                const cs = score(c);
                if (cs > bestScore) {
                    best = c;
                    bestScore = cs;
                }
            }
            best = best || user;
            // ã€Cloudflare ä¸Šå²—å¤©æ•°ã€‘ä¼˜å…ˆé‡‡ç”¨åŒäººè®°å½•ä¸­ work_days æœ€å¤§çš„å€¼ï¼Œé¿å… DB æ—§è®°å½•ä¸º 1 æ—¶å§‹ç»ˆæ˜¾ç¤º 1 å¤©
            const maxWorkDaysCandidate = candidates.reduce((a, c) => {
                const d = c && (c.work_days ?? c.usage_days ?? c.usageDays ?? c.days);
                const n = d != null ? Number(d) : NaN;
                const aVal = a && (a.work_days ?? a.usage_days ?? a.usageDays ?? a.days);
                const aNum = aVal != null ? Number(aVal) : NaN;
                return (Number.isFinite(n) && n > (Number.isFinite(aNum) ? aNum : 0)) ? c : a;
            }, null);
            if (maxWorkDaysCandidate) {
                const maxDays = maxWorkDaysCandidate.work_days ?? maxWorkDaysCandidate.usage_days ?? maxWorkDaysCandidate.usageDays ?? maxWorkDaysCandidate.days;
                if (maxDays != null && Number(maxDays) >= 1) {
                    best = { ...best, work_days: Number(maxDays), usage_days: Number(maxDays), usageDays: Number(maxDays) };
                }
            }
            return best;
        }

        /**
         * å°† index å¹¿æ’­çš„ /api/v2/analyze è¿”å›ç»“æœè½¬æ¢ä¸ºå·¦ä¾§æŠ½å±‰ä½¿ç”¨çš„ user è®°å½•å½¢çŠ¶
         */
        function buildUserDataFromLocalAnalysis(serverUser, localPayload) {
            if (!localPayload || localPayload.status !== 'success') return serverUser;
            var d = localPayload.dimensions || {};
            var st = localPayload.stats || {};
            return Object.assign({}, serverUser, {
                total_messages: st.totalMessages ?? serverUser.total_messages,
                total_chars: st.totalChars ?? serverUser.total_chars,
                work_days: st.work_days ?? serverUser.work_days,
                stats: st,
                roast_text: localPayload.roastText ?? serverUser.roast_text,
                dimensions: d,
                personality_type: localPayload.personalityType ?? serverUser.personality_type,
                personality_name: localPayload.personalityName ?? serverUser.personality_name,
                vibe_index: localPayload.vibeIndex ?? serverUser.vibe_index,
                lpdef: localPayload.lpdef ?? serverUser.lpdef,
                personality: localPayload.personality ?? serverUser.personality,
                l_score: d.L != null ? Math.round(d.L) : serverUser.l_score,
                p_score: d.P != null ? Math.round(d.P) : serverUser.p_score,
                d_score: d.D != null ? Math.round(d.D) : serverUser.d_score,
                e_score: d.E != null ? Math.round(d.E) : serverUser.e_score,
                f_score: d.F != null ? Math.round(d.F) : serverUser.f_score
            });
        }

        /**
         * æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡åˆ°å·¦ä¾§æŠ½å±‰ï¼ˆä¸ index åŒæ­¥ï¼šæ—  answer_book æ—¶æŒ‰ vibe_index/lpdef ä» answerBookByVibeIndex.json å–ä»Šæ—¥ç®´è¨€ï¼‰
         * @param {HTMLElement} leftBody - å·¦ä¾§æŠ½å±‰å®¹å™¨
         * @param {Object} currentUserData - å½“å‰ç”¨æˆ·æ•°æ®å¯¹è±¡
         */
        async function renderUserStatsCards(leftBody, currentUserData) {
            if (!leftBody) {
                console.error('[UserStats] âŒ leftBody ä¸å­˜åœ¨');
                return;
            }
            if (!currentUserData) {
                console.warn('[UserStats] âš ï¸ currentUserData ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸²æŸ“');
                return;
            }
            // ã€ä¾§è¾¹æ æ‹¦æˆªã€‘è‹¥å­˜åœ¨åˆšå®Œæˆçš„æœ¬åœ°åˆ†æï¼ˆlast_local_statsï¼‰ï¼Œä¼˜å…ˆç”¨æœ¬åœ°æ•°æ®è¦†ç›–ï¼Œå¿½ç•¥æœåŠ¡å™¨å¯èƒ½å»¶è¿Ÿæˆ–ç´¯åŠ é”™è¯¯çš„æ—§æ•°æ®
            var localStats = window.last_local_stats;
            if (localStats && localStats.payload && (Date.now() - (localStats.ts || 0)) < 300000) {
                currentUserData = buildUserDataFromLocalAnalysis(currentUserData, localStats.payload);
                console.log('[UserStats] âœ… ä½¿ç”¨ index æœ¬åœ°åˆ†æç»“æœè¦†ç›–ä¾§è¾¹æ æ•°æ®');
            }
            console.log('[UserStats] ğŸš€ å¼€å§‹æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ï¼ŒcurrentUserData:', {
                hasUserData: !!currentUserData,
                userName: currentUserData?.user_name || currentUserData?.name,
                fingerprint: currentUserData?.fingerprint ? currentUserData.fingerprint.substring(0, 8) : null,
                hasLeftBody: !!leftBody,
                hasVibeRank: !!(currentUserData?.vibe_rank || currentUserData?.vibeRank),
                hasPersonalityName: !!(currentUserData?.personality_name || currentUserData?.personalityName),
                hasAnswerBook: !!(currentUserData?.answer_book || currentUserData?.answerBook),
                hasPersonality: !!currentUserData?.personality,
                hasPersonalityData: !!currentUserData?.personality_data
            });
            
            try {
                const esc = (s) =>
                    String(s ?? '')
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');

                // ã€Task 4ã€‘æ£€æŸ¥æ˜¯å¦ä¸ºæ–°ç”¨æˆ·ï¼ˆç»´åº¦/ç»Ÿè®¡ä¸ºç©ºæˆ–ä¸ºé»˜è®¤å€¼ï¼‰
                // ä¿®å¤ï¼šç»Ÿä¸€è§†å›¾/éšç§è£å‰ªå¯èƒ½ä¸è¿”å› l_score..f_scoreï¼Œä½†ä»å¯èƒ½è¿”å›å…¶å®ƒç»Ÿè®¡å­—æ®µï¼ˆtotal_messages ç­‰ï¼‰
                const quickScoreKeys = ['l_score','p_score','d_score','e_score','f_score','l','p','d','e','f','L','P','D','E','F'];
                const hasAnyScore = quickScoreKeys.some(k => currentUserData[k] !== null && currentUserData[k] !== undefined);

                const extracted = extractDimensionValues(currentUserData);
                console.log('[UserStats] ğŸ“Š extractDimensionValues ç»“æœ:', extracted);
                const hasAnyMetric =
                    (extracted.ai !== undefined && extracted.ai !== null && extracted.ai > 0) ||
                    (extracted.say !== undefined && extracted.say !== null && extracted.say > 0) ||
                    (extracted.word !== undefined && extracted.word !== null && extracted.word > 0) ||
                    (extracted.no !== undefined && extracted.no !== null && extracted.no > 0) ||
                    (extracted.please !== undefined && extracted.please !== null && extracted.please > 0) ||
                    (extracted.day !== undefined && extracted.day !== null && extracted.day > 0);

                const hasDimensions = !!currentUserData.dimensions || hasAnyScore || hasAnyMetric;

                // é»˜è®¤åˆ†åªåœ¨â€œäº”ç»´åˆ†éƒ½å­˜åœ¨ä¸”éƒ½ç­‰äº 50â€æ—¶æˆç«‹
                const isDefaultScores =
                    currentUserData.l_score === 50 &&
                    currentUserData.p_score === 50 &&
                    currentUserData.d_score === 50 &&
                    currentUserData.e_score === 50 &&
                    currentUserData.f_score === 50;
                
                // ã€ä¿®å¤ã€‘GitHub ç”¨æˆ·ï¼šå³ä½¿ latestRecords é‡Œå­—æ®µä¸å…¨ï¼Œä¹Ÿä¸åº”ä¸€ç›´å¡åœ¨â€œåŒæ­¥ä¸­â€
                // å…¸å‹åœºæ™¯ï¼š/api/global-average è¿”å›çš„ latestRecords ä¼šåšéšç§è£å‰ªï¼Œå¯èƒ½ç¼ºå°‘ id/fingerprint/ç»´åº¦å­—æ®µ
                const candidateUserName = String(
                    currentUserData?.user_name ||
                    currentUserData?.name ||
                    (() => {
                        try { return localStorage.getItem('github_username') || ''; } catch { return ''; }
                    })()
                ).trim();
                const candidateIdentity = currentUserData?.user_identity || null;
                const isGitHubUser = !!(candidateUserName && typeof isValidGitHubUsername === 'function' && isValidGitHubUsername(candidateUserName, candidateIdentity));
                const canQuerySupabase = (typeof supabaseClient !== 'undefined' && supabaseClient && typeof supabaseClient.from === 'function');

                // è‹¥æ˜¯ GitHub ç”¨æˆ·ä½†æ•°æ®ä¸å…¨ï¼šè‡ªåŠ¨ä»ç»Ÿä¸€è§†å›¾æ‹‰å®Œæ•´è®°å½•åå†æ¸²æŸ“ï¼Œé¿å…æ— é™ loading
                // å…¼å®¹ï¼šcurrentUserData å¯èƒ½å·²æœ‰ id ä½†å­—æ®µä»ä¸å…¨ï¼ˆä¾‹å¦‚ç™»å½•ååˆš upsert çš„ç®€ç•¥è®°å½•ï¼‰
                if ((!hasDimensions || isDefaultScores) && isGitHubUser && canQuerySupabase && !currentUserData.__unifiedFetchAttempted) {
                    try {
                        currentUserData.__unifiedFetchAttempted = true; // æ ‡è®°ï¼šé¿å…é€’å½’æ­»å¾ªç¯
                        console.log('[UserStats] ğŸ”„ GitHub ç”¨æˆ·æ•°æ®ä¸å…¨ï¼Œå°è¯•ä» v_unified_analysis_v2 æ‹‰å–å®Œæ•´è®°å½•:', {
                            candidateUserName,
                            hasId: !!currentUserData.id
                        });
                        let q = supabaseClient
                            .from('v_user_analysis_extended')
                            .select('*');
                        // ä¼˜å…ˆç”¨ id ç²¾ç¡®åŒ¹é…ï¼ˆæœ€ç¨³å®šï¼‰ï¼Œå¦åˆ™ç”¨ user_nameï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
                        if (currentUserData.id) {
                            q = q.eq('id', currentUserData.id);
                        } else {
                            q = q.ilike('user_name', candidateUserName);
                        }
                        q.maybeSingle()
                            .then(({ data: dbUser }) => {
                                if (!dbUser) {
                                    console.warn('[UserStats] âš ï¸ v_unified_analysis_v2 æœªæ‰¾åˆ°ç”¨æˆ·è®°å½•:', candidateUserName);
                                    // ç»§ç»­èµ°åç»­æ¸²æŸ“ï¼ˆä¼šæ˜¾ç¤ºâ€œæš‚æ— äº‘ç«¯æ•°æ®â€å¡ç‰‡ï¼‰
                                    renderUserStatsCards(leftBody, { ...currentUserData, __unifiedFetchAttempted: true });
                                    return;
                                }
                                console.log('[UserStats] âœ… å·²è·å–å®Œæ•´ç”¨æˆ·è®°å½•ï¼Œåˆ·æ–°ç»Ÿè®¡å¡ç‰‡:', dbUser.user_name || dbUser.name);
                                try { window.currentUser = dbUser; } catch { /* ignore */ }
                                renderUserStatsCards(leftBody, getBestUserRecordForStats(dbUser));
                            })
                            .catch((e) => {
                                console.warn('[UserStats] âš ï¸ v_unified_analysis_v2 æŸ¥è¯¢å¤±è´¥:', e);
                                renderUserStatsCards(leftBody, { ...currentUserData, __unifiedFetchAttempted: true });
                            });
                        return; // å¼‚æ­¥æ‹‰å–åä¼šé‡æ¸²æŸ“ï¼Œè¿™é‡Œå…ˆé€€å‡º
                    } catch (e) {
                        console.warn('[UserStats] âš ï¸ è§¦å‘ GitHub ç”¨æˆ·è¡¥å…¨æµç¨‹å¤±è´¥:', e);
                    }
                }

                // åªæœ‰åœ¨ç¡®å®šæ˜¯â€œå®Œå…¨æ²¡æœ‰æ•°æ®çš„åŒ¿åç”¨æˆ·/å ä½è®°å½•â€æ—¶æ‰æ˜¾ç¤ºåŒæ­¥ä¸­
                const isNewUser = (!hasDimensions || isDefaultScores) && !currentUserData.id && !isGitHubUser;
                
                if (isNewUser) {
                    console.log('[UserStats] â³ æ£€æµ‹åˆ°æ–°ç”¨æˆ·ï¼ˆæ•°æ®åŒæ­¥ä¸­ï¼‰ï¼Œæ˜¾ç¤ºåŠ è½½å ä½ç¬¦');
                    
                    // åˆ›å»º"æ•°æ®åŒæ­¥ä¸­"å ä½ç¬¦å¡ç‰‡
                    const loadingCard = document.createElement('div');
                    loadingCard.className = 'drawer-item';
                    loadingCard.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">â³</span>
                            <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                                SYNCING
                            </span>
                        </div>
                        <div class="drawer-item-label mb-2">${escapeHtml(getI18nText('common.syncing') || (currentLang === 'en' ? 'Syncing' : 'æ•°æ®åŒæ­¥ä¸­'))}</div>
                        <div class="text-[10px] text-[#00ff41]/60 mb-3">
                            ${escapeHtml(currentLang === 'en' ? 'Your data is being processed. Please waitâ€¦' : 'æ‚¨çš„æ•°æ®æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...')}
                        </div>
                        <div class="flex items-center space-x-2 mb-2">
                            <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-[#00ff41] rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                        <div class="text-[8px] text-[#00ff41]/40 mt-2">
                            ${escapeHtml(currentLang === 'en' ? 'User' : 'ç”¨æˆ·')}: ${escapeHtml(currentUserData.user_name || currentUserData.name || (currentLang === 'en' ? 'Unknown' : 'æœªçŸ¥'))}
                        </div>
                    `;
                    
                    // å…ˆç§»é™¤æ—§çš„ç»Ÿè®¡å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    const existingStatsCards = leftBody.querySelectorAll('.drawer-item');
                    existingStatsCards.forEach(card => {
                        const label = card.querySelector('.drawer-item-label');
                        if (label && (label.textContent === 'æˆ‘çš„æ•°æ®ç»Ÿè®¡' || label.textContent === 'æ•°æ®åŒæ­¥ä¸­')) {
                            card.remove();
                        }
                    });
                    
                    // å°†åŠ è½½å¡ç‰‡æ’å…¥åˆ°èº«ä»½é…ç½®å¡ç‰‡ä¹‹å
                    const identityCard = leftBody.querySelector('.drawer-item');
                    if (identityCard && identityCard.nextSibling) {
                        leftBody.insertBefore(loadingCard, identityCard.nextSibling);
                    } else {
                        leftBody.appendChild(loadingCard);
                    }
                    
                    console.log('[UserStats] âœ… å·²æ˜¾ç¤ºæ•°æ®åŒæ­¥ä¸­å ä½ç¬¦');
                    return; // æå‰è¿”å›ï¼Œä¸æ¸²æŸ“å®Œæ•´ç»Ÿè®¡å¡ç‰‡
                }

                // GitHub ç”¨æˆ·ä½† Supabase å®¢æˆ·ç«¯å°šæœªå°±ç»ªï¼šå…ˆæ˜¾ç¤ºâ€œè¿æ¥ä¸­â€ï¼Œå¹¶ç¨åè‡ªåŠ¨é‡è¯•
                if ((!hasDimensions || isDefaultScores) && isGitHubUser && !currentUserData.id && !canQuerySupabase && !currentUserData.__unifiedFetchAttempted) {
                    try {
                        const attempts = Number(currentUserData.__supabaseWaitAttempts || 0);
                        if (attempts < 6) {
                            currentUserData.__supabaseWaitAttempts = attempts + 1;
                            const delayMs = 800 + attempts * 400;
                            setTimeout(() => {
                                const lb = document.getElementById('left-drawer-body');
                                if (lb) renderUserStatsCards(lb, currentUserData);
                            }, delayMs);
                        }
                    } catch (e) { /* ignore */ }

                    const connectingCard = document.createElement('div');
                    connectingCard.className = 'drawer-item';
                    connectingCard.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">ğŸ”Œ</span>
                            <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                                CONNECT
                            </span>
                        </div>
                        <div class="drawer-item-label mb-2">${escapeHtml(getI18nText('drawer.my_stats') || 'My Stats')}</div>
                        <div class="text-[10px] text-[#00ff41]/60 mb-2">
                            ${escapeHtml(getI18nText('common.connecting_cloud') || 'Connecting...')}
                        </div>
                        <div class="text-[8px] text-[#00ff41]/40">
                            ${escapeHtml(currentLang === 'en' ? 'GitHub' : 'GitHub ç”¨æˆ·')}ï¼š${escapeHtml(candidateUserName || (currentLang === 'en' ? 'Unknown' : 'æœªçŸ¥'))}
                        </div>
                    `;

                    const existingStatsCards = leftBody.querySelectorAll('.drawer-item');
                    existingStatsCards.forEach(card => {
                        const label = card.querySelector('.drawer-item-label');
                        if (label && (label.textContent === 'æˆ‘çš„æ•°æ®ç»Ÿè®¡' || label.textContent === 'æ•°æ®åŒæ­¥ä¸­')) {
                            card.remove();
                        }
                    });

                    const identityCard = leftBody.querySelector('.drawer-item');
                    if (identityCard && identityCard.nextSibling) {
                        leftBody.insertBefore(connectingCard, identityCard.nextSibling);
                    } else {
                        leftBody.appendChild(connectingCard);
                    }
                    return;
                }

                // GitHub ç”¨æˆ·ä»æ— ç»´åº¦ä¸”å·²å°è¯•è¡¥å…¨ï¼šä¸è¦æ˜¾ç¤ºâ€œåŒæ­¥ä¸­â€ï¼Œæ”¹ä¸ºâ€œæš‚æ— äº‘ç«¯æ±‡æ€»æ•°æ®â€ï¼ˆæç¤ºç”¨æˆ·å…ˆè·‘ä¸€æ¬¡åˆ†æï¼‰
                if ((!hasDimensions || isDefaultScores) && isGitHubUser && !currentUserData.id && currentUserData.__unifiedFetchAttempted) {
                    console.warn('[UserStats] âš ï¸ GitHub ç”¨æˆ·æš‚æ— äº‘ç«¯æ±‡æ€»æ•°æ®ï¼ˆå¯èƒ½å°šæœªè·‘è¿‡åˆ†ææˆ–æ•°æ®ä»æœªå…¥åº“ï¼‰:', candidateUserName);

                    const emptyCard = document.createElement('div');
                    emptyCard.className = 'drawer-item';
                    emptyCard.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">ğŸ§¾</span>
                            <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5">
                                NO DATA
                            </span>
                        </div>
                        <div class="drawer-item-label mb-2">${escapeHtml(getI18nText('drawer.my_stats') || 'My Stats')}</div>
                        <div class="text-[10px] text-[#00ff41]/60 mb-2">
                            ${escapeHtml(getI18nText('common.no_cloud_summary') || 'No cloud summary')}ï¼ˆGitHubï¼š${candidateUserName || (currentLang === 'en' ? 'Unknown' : 'æœªçŸ¥')}ï¼‰ã€‚
                        </div>
                        <div class="text-[8px] text-[#00ff41]/40">
                            ${escapeHtml(getI18nText('common.suggestion_run_once') || '')}
                        </div>
                    `;

                    // æ¸…ç†æ—§å¡ç‰‡å¹¶æ’å…¥
                    const existingStatsCards = leftBody.querySelectorAll('.drawer-item');
                    existingStatsCards.forEach(card => {
                        const label = card.querySelector('.drawer-item-label');
                        if (label && (label.textContent === 'æˆ‘çš„æ•°æ®ç»Ÿè®¡' || label.textContent === 'æ•°æ®åŒæ­¥ä¸­')) {
                            card.remove();
                        }
                    });

                    const identityCard = leftBody.querySelector('.drawer-item');
                    if (identityCard && identityCard.nextSibling) {
                        leftBody.insertBefore(emptyCard, identityCard.nextSibling);
                    } else {
                        leftBody.appendChild(emptyCard);
                    }
                    return;
                }
                
                // æå–ç»´åº¦å€¼
                const dimensionValues = extractDimensionValues(currentUserData);
                console.log('[UserStats] ğŸ“Š æå–çš„ç»´åº¦å€¼:', dimensionValues);
                
                // 1. æŠ€æœ¯æ’åï¼ˆä½¿ç”¨å¹³å‡æ’åæˆ–ç»¼åˆæ’åï¼‰
                // ã€å­—æ®µæ˜ å°„ã€‘ä¼˜å…ˆè§†å›¾ jiafang_rank_percent/ketao_rank_percent/days_rank_percentï¼Œå…œåº• jiafang_rank ç­‰
                const vibeRank = currentUserData.vibe_rank ?? currentUserData.vibeRank ?? null;
                const vibePercentile = currentUserData.vibe_percentile ?? currentUserData.vibePercentile ?? null;
                const jiafangRank = Math.floor(currentUserData.jiafang_rank_percent ?? currentUserData.jiafang_rank ?? currentUserData.jiafangRank ?? 0);
                const ketaoRank = Math.floor(currentUserData.ketao_rank_percent ?? currentUserData.ketao_rank ?? currentUserData.ketaoRank ?? 0);
                const daysRank = Math.floor(currentUserData.days_rank_percent ?? currentUserData.days_rank ?? currentUserData.daysRank ?? 0);
                let avgRank = currentUserData.avg_rank ?? currentUserData.avgRank ?? currentUserData.ranks?.avgRank ?? vibePercentile ?? (jiafangRank != null && ketaoRank != null && daysRank != null ? (jiafangRank + ketaoRank + daysRank) / 3 : null);
                
                // å¦‚æœè¿˜æ²¡æœ‰æ’åï¼Œå°è¯•ä» personality_data æˆ– personality JSONB å­—æ®µä¸­è·å–
                if (avgRank === null || avgRank === undefined) {
                    try {
                        const personalityData = currentUserData.personality_data || currentUserData.personalityData;
                        const personality = currentUserData.personality;
                        if (personalityData && Array.isArray(personalityData)) {
                            // è®¡ç®—å¹³å‡æ’åï¼šä»äº”ä¸ªç»´åº¦çš„æ’åä¸­å–å¹³å‡å€¼
                            const ranks = personalityData.map(d => d.rank || d.rankPercent || 50).filter(r => r !== null && r !== undefined);
                            if (ranks.length > 0) {
                                avgRank = ranks.reduce((sum, r) => sum + r, 0) / ranks.length;
                            }
                        } else if (personality && typeof personality === 'object') {
                            // å°è¯•ä» personality.detailedStats ä¸­è·å–
                            const detailedStats = personality.detailedStats || personality.detailed_stats;
                            if (detailedStats && Array.isArray(detailedStats)) {
                                const ranks = detailedStats.map(d => d.rank || d.rankPercent || 50).filter(r => r !== null && r !== undefined);
                                if (ranks.length > 0) {
                                    avgRank = ranks.reduce((sum, r) => sum + r, 0) / ranks.length;
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('[UserStats] âš ï¸ ä» personality æ•°æ®æå–æ’åå¤±è´¥:', e);
                    }
                }
                
                const userTotalMsgs = Number(currentUserData?.total_messages ?? currentUserData?.totalMessages ?? dimensionValues?.ai ?? 0) || 0;
                const pct = (v) => Math.floor(Number(v) ?? 0) + '%';
                const jiafangPct = pct(currentUserData.jiafang_rank_percent ?? currentUserData.jiafang_rank ?? 0);
                const ketaoPct = pct(currentUserData.ketao_rank_percent ?? currentUserData.ketao_rank ?? 0);
                const daysPct = pct(currentUserData.days_rank_percent ?? currentUserData.days_rank ?? 0);

                const allData = Array.isArray(window.allData) ? window.allData : [];
                const globalTotal = Math.max(1, allData.length);
                // èšåˆå›½ç±è¯†åˆ«ï¼šå¤šå­—æ®µå…¼å®¹ï¼ŒSQL å¯èƒ½ä¸º null æ—¶ä»è¿”å› 2 ä½ç 
                const getUserCountry = (u) => {
                    const code = u?.current_location || u?.manual_location || u?.ip_location || u?.country_code || 'US';
                    return String(code).trim().toUpperCase().substring(0, 2);
                };
                const myCountry = getUserCountry(currentUserData);
                const countryPeerGroup = allData.filter((u) => getUserCountry(u) === myCountry);
                const countryTotal = Math.max(1, countryPeerGroup.length);
                const myFingerprint = (currentUserData?.fingerprint || currentUserData?.fp || '').toString();
                let myRankInCountry = myFingerprint ? countryPeerGroup.findIndex((u) => (u.fingerprint || u.fp || '').toString() === myFingerprint) : -1;
                if (myRankInCountry < 0) myRankInCountry = countryPeerGroup.findIndex((u) => (u.user_name || u.userName || u.github_username || '').toString() === (currentUserData?.user_name || currentUserData?.userName || '').toString());
                const countryRank = countryTotal > 0 ? (myRankInCountry >= 0 ? myRankInCountry + 1 : 1) : 1;

                // å…¨çƒæ’åï¼šæŒ‰å­—æ•°ï¼ˆå…¶æ¬¡æ¶ˆæ¯æ•°ï¼‰æ’åºåå–å½“å‰ç”¨æˆ·ç´¢å¼•
                const sortScore = (u) => (Number(u?.total_chars ?? u?.say ?? u?.total_user_chars ?? 0) || 0) * 1e6 + (Number(u?.total_messages ?? u?.ai ?? 0) || 0);
                const sortedGlobal = allData.slice().sort((a, b) => sortScore(b) - sortScore(a));
                const myGlobalIdx = myFingerprint ? sortedGlobal.findIndex((u) => (u.fingerprint || u.fp || '').toString() === myFingerprint) : -1;
                const myGlobalIdxByName = myGlobalIdx < 0 ? sortedGlobal.findIndex((u) => (u.user_name || u.userName || u.github_username || '').toString() === (currentUserData?.user_name || currentUserData?.userName || '').toString()) : myGlobalIdx;
                const globalRank = myGlobalIdxByName >= 0 ? myGlobalIdxByName + 1 : (vibeRank != null && Number(vibeRank) >= 1 ? Math.min(globalTotal, Math.max(1, Number(vibeRank))) : 1);

                const rn = (key, n) => {
                    const s = (typeof getI18nText === 'function' ? getI18nText(key) : null) ?? '';
                    return (s === undefined || s === null ? '' : String(s)).replace(/\{n\}/g, String(n)) || String(n);
                };
                const line1 = (getI18nText('rank.country') || 'è¯¥å›½') + ' ' + (rn('rank.rank_n', countryRank) || ('ç¬¬ ' + countryRank + ' å')) + ' / ' + (rn('rank.total_people', countryTotal) || ('å…± ' + countryTotal + ' äºº'));
                const line2 = '<span class="text-zinc-500 text-[10px] block mt-0.5">' + (getI18nText('rank.global') || 'å…¨çƒ') + ' ' + (rn('rank.rank_n', globalRank) || ('ç¬¬ ' + globalRank + ' å')) + ' / ' + globalTotal + '</span>';
                const techRankText = line1 + line2;
                const isLowConfidence = userTotalMsgs > 0 && userTotalMsgs < 10;
                const techRankClass = isLowConfidence ? 'text-gray-600' : '';
                const confidenceHint = isLowConfidence
                    ? `<div class="text-[9px] text-zinc-500 mt-1">${currentLang === 'en' ? 'Low confidence (early stage)' : 'å½“å‰å¤„äºç—…æ‚£åˆæœŸï¼Œç½®ä¿¡åº¦è¾ƒä½'}</div>`
                    : '';
                console.log('[UserStats] ğŸ† æŠ€æœ¯æ’å:', { vibeRank, vibePercentile, avgRank, myCountry: myCountry || '(none)', countryRank, globalRank, countryTotal, globalTotal, userTotalMsgs });
                
                const nf = new Intl.NumberFormat(currentLang === 'en' ? 'en-US' : 'zh-CN');

                const unitTimes = currentLang === 'en' ? 'times' : 'æ¬¡';
                const unitChars = currentLang === 'en' ? 'chars' : 'å­—';
                const withUnit = (v, u) => (v === 'N/A' ? 'N/A' : `${v} ${u}`);

                // 2. è°ƒæˆAIæ¬¡æ•°ï¼ˆaiç»´åº¦ï¼‰
                const aiCount = dimensionValues.ai !== undefined && dimensionValues.ai !== null
                    ? nf.format(dimensionValues.ai)
                    : 'N/A';

                // 2.5 ä¸Šå²—å¤©æ•°ï¼ˆdayç»´åº¦ï¼‰
                // ã€ä¿®å¤ã€‘å®šä¹‰ï¼šç”¨æˆ·æœ€æ—©å’Œ Cursor å¼€å§‹å¯¹è¯ -> ç°åœ¨ çš„å®æ—¶å¤©æ•°ï¼ˆ>= 1ï¼‰
                // æ•°æ®æºä¼˜å…ˆçº§ï¼ˆä¸ extractDimensionValues ä¿æŒä¸€è‡´ï¼‰ï¼š
                // 1) æœ¬åœ°ï¼šlast_analysis_data.stats.earliestFileTimeï¼ˆç”¨æˆ·æœ¬åœ° workspacestorage æ–‡ä»¶å¤¹æœ€æ—©å»ºç«‹æ—¶é—´ï¼‰
                // 2) äº‘ç«¯ï¼šcurrentUserData.first_chat_at / currentUserData.stats.first_chat_at
                // 3) å…œåº•ï¼šdimensionValues.dayï¼ˆå…¼å®¹æ—§å­—æ®µï¼Œä½†é¿å…ç¡¬ç¼–ç çš„ 1ï¼‰
                const _parseMaybeTs = (v) => {
                    if (v === null || v === undefined) return NaN;
                    if (typeof v === 'number' && Number.isFinite(v)) return v;
                    const s = String(v).trim();
                    if (!s) return NaN;
                    // çº¯æ•°å­—ï¼š10ä½è§†ä¸ºç§’ï¼Œ13ä½è§†ä¸ºæ¯«ç§’
                    if (/^\d+$/.test(s)) {
                        const n = Number(s);
                        if (!Number.isFinite(n)) return NaN;
                        if (s.length === 10) return n * 1000;
                        return n;
                    }
                    const t = Date.parse(s);
                    return Number.isFinite(t) ? t : NaN;
                };
                const _calcDaysFromTs = (ts) => {
                    if (!Number.isFinite(ts) || ts <= 0) return null;
                    const diff = Math.floor((Date.now() - ts) / (1000 * 60 * 60 * 24));
                    // å®æ—¶å¤©æ•°ï¼šè‡³å°‘ 1 å¤©
                    return Math.max(1, diff);
                };

                // ã€ä¿®å¤ã€‘ä¸Šå²—å¤©æ•°ä½¿ç”¨ dimensionValues.dayï¼ˆextractDimensionValues å·²ä¼˜å…ˆä»æœ¬åœ° localStorage è·å–ï¼‰
                let dayCount = 'N/A';
                let dayEarliestTs = null;
                let daySource = null;
                let apiWorkDays = null; // å­˜å‚¨ API è¿”å›çš„ work_days
                
                // ã€æƒé™åˆ†çº§ã€‘æ­¥éª¤0ï¼šä¼˜å…ˆæ£€æŸ¥ API è¿”å›çš„ work_daysï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
                const su = currentUserData.stats && typeof currentUserData.stats === 'object' ? currentUserData.stats : null;
                const apiWorkDaysValue = currentUserData.work_days ?? (su ? su.work_days : null);
                if (apiWorkDaysValue !== null && apiWorkDaysValue !== undefined && Number(apiWorkDaysValue) > 0) {
                    apiWorkDays = Number(apiWorkDaysValue);
                    dayCount = nf.format(apiWorkDays);
                    daySource = 'api.work_days';
                    console.log('[renderUserStatsCards] âœ… API work_days å­˜åœ¨ä¸”å¤§äº0ï¼Œè®¾ä¸ºå”¯ä¸€æ¥æº:', apiWorkDays);
                    
                    // ã€åå‘ä¿®æ­£ã€‘ç«‹å³å°† API çš„æ­£ç¡®å¤©æ•°å†™å…¥ localStorageï¼Œç¡®ä¿æœ¬åœ°ç¼“å­˜è¢«äº‘ç«¯æ•°æ®'æ´—ç™½'
                    try {
                        localStorage.setItem('usageDays', String(apiWorkDays));
                        console.log('[renderUserStatsCards] âœ… å·²å°† API work_days å†™å…¥ localStorage.usageDays:', apiWorkDays);
                    } catch (e) {
                        console.warn('[renderUserStatsCards] âš ï¸ å†™å…¥ localStorage.usageDays å¤±è´¥:', e);
                    }
                }
                
                // å¦‚æœ API work_days ä¸å­˜åœ¨æˆ–æ— æ•ˆï¼Œæ‰ä½¿ç”¨å…¶ä»–æ¥æº
                if (dayCount === 'N/A' || dayCount === '1') {
                    // ä¼˜å…ˆä½¿ç”¨ extractDimensionValues è¿”å›çš„ dayï¼ˆå·²åŒ…å«æœ¬åœ°æ•°æ®é€»è¾‘ï¼‰
                    if (dimensionValues.day !== undefined && dimensionValues.day !== null && dimensionValues.day > 0) {
                        dayCount = nf.format(Math.round(dimensionValues.day));
                        daySource = 'dimensionValues.day';
                    }
                    
                    // ã€æ­¥éª¤1ã€‘ä¼˜å…ˆä»æœ¬åœ° localStorage è·å– earliestFileTime æˆ– usageDaysï¼ˆCloudflare ç¯å¢ƒå¼ºåŒ–ï¼‰
                    if (dayCount === 'N/A' || dayCount === '1') { // å¦‚æœæ˜¯1å¤©ï¼Œå¯èƒ½æ˜¯é»˜è®¤å€¼ï¼Œå°è¯•ä»æœ¬åœ°è·å–æ›´å‡†ç¡®å€¼
                        try {
                            const raw = localStorage.getItem('last_analysis_data');
                            console.log('[renderUserStatsCards] æœ¬åœ°æ•°æ® raw:', raw ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                            if (raw) {
                                const obj = JSON.parse(raw);
                                console.log('[renderUserStatsCards] æœ¬åœ°æ•°æ® parsed:', obj);
                                const st = obj && obj.stats ? obj.stats : null;
                                
                                // 1a) ä¼˜å…ˆä½¿ç”¨ earliestFileTime è®¡ç®—å¤©æ•°
                                const earliest = st ? (st.earliestFileTime ?? st.earliest_file_time) : null;
                                console.log('[renderUserStatsCards] earliestFileTime:', earliest);
                                
                                // ã€é˜»æ­¢è¦†ç›–ã€‘åªæœ‰å½“ earliestFileTime å­˜åœ¨æ—¶æ‰ä½¿ç”¨ï¼Œå¦‚æœä¸º undefined åˆ™ä¿ç•™å½“å‰å€¼
                                if (earliest !== null && earliest !== undefined) {
                                    const ts = _parseMaybeTs(earliest);
                                    const d = _calcDaysFromTs(ts);
                                    if (d != null && d > 1) { // åªæœ‰è®¡ç®—å€¼å¤§äº1æ‰ä½¿ç”¨
                                        dayEarliestTs = ts;
                                        dayCount = nf.format(d);
                                        daySource = 'localStorage.earliestFileTime';
                                        console.log('[renderUserStatsCards] ä½¿ç”¨æœ¬åœ° earliestFileTime:', d);
                                    }
                                } else {
                                    console.log('[renderUserStatsCards] earliestFileTime ä¸º undefinedï¼Œä¿ç•™å½“å‰ API è¿”å›å€¼');
                                }
                                
                                // 1b) å¦‚æœæ²¡æœ‰ earliestFileTimeï¼Œä½†æœ‰ usageDays/work_daysï¼Œç›´æ¥ä½¿ç”¨
                                if (dayCount === 'N/A' || dayCount === '1') {
                                    const usageDays = st ? (st.usageDays ?? st.usage_days ?? st.work_days ?? null) : null;
                                    console.log('[renderUserStatsCards] usageDays from local:', usageDays);
                                    if (usageDays != null && Number(usageDays) > 1) { // åªæœ‰å¤§äº1æ‰ä½¿ç”¨
                                        dayCount = nf.format(Number(usageDays));
                                        daySource = 'localStorage.usageDays';
                                        console.log('[renderUserStatsCards] ä½¿ç”¨æœ¬åœ° usageDays:', usageDays);
                                    }
                                }
                            }
                        } catch (e) { 
                            console.warn('[renderUserStatsCards] æœ¬åœ°æ•°æ®è¯»å–å¤±è´¥:', e);
                        }
                    }
                    
                    // ã€æ­¥éª¤2ã€‘å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œå°è¯•äº‘ç«¯ first_chat_at
                    if (dayCount === 'N/A' || dayCount === '1') {
                        try {
                            const firstChatAt =
                                currentUserData.first_chat_at ||
                                (su ? (su.first_chat_at || su.firstChatAt) : null) ||
                                null;
                            const tFirst = _parseMaybeTs(firstChatAt);
                            const dFirst = _calcDaysFromTs(tFirst);
                            if (dFirst != null && dFirst > 1) {
                                dayEarliestTs = tFirst;
                                dayCount = nf.format(dFirst);
                                daySource = 'cloud.first_chat_at';
                            }
                        } catch { /* ignore */ }
                    }
                }
                
                // è°ƒè¯•æ—¥å¿—
                console.log('[renderUserStatsCards] dayCount æœ€ç»ˆç»“æœ:', { dayCount, dayEarliestTs, source: daySource, dimensionValuesDay: dimensionValues.day });
                
                // 3. ç”²æ–¹çˆ¸çˆ¸ä¸Šèº«æ¬¡æ•°ï¼ˆnoç»´åº¦ï¼‰
                const noCount = dimensionValues.no !== undefined && dimensionValues.no !== null 
                    ? nf.format(dimensionValues.no) 
                    : 'N/A';
                
                // 4. èµ›åšç£•å¤´æ¬¡æ•°ï¼ˆpleaseç»´åº¦ï¼‰
                const pleaseCount = dimensionValues.please !== undefined && dimensionValues.please !== null 
                    ? nf.format(dimensionValues.please) 
                    : 'N/A';
                
                // 5. åºŸè¯è¾“å‡ºæ€»æ•°ï¼ˆsayç»´åº¦ï¼‰
                const sayTotal = dimensionValues.say !== undefined && dimensionValues.say !== null 
                    ? nf.format(dimensionValues.say) 
                    : 'N/A';
                
                // 6. å¹³å‡å¹æ°´é•¿åº¦ï¼ˆwordç»´åº¦ï¼‰
                const avgLength = dimensionValues.word !== undefined && dimensionValues.word !== null 
                    ? nf.format(Math.round(dimensionValues.word)) 
                    : 'N/A';
                
                // 7. äººæ ¼ç§°å·ï¼ˆå‚è€ƒ index.html çš„è·å–æ–¹å¼ï¼šæ ¹æ® 5 ä½ vibe_index ä» personalityNames.json è·å–ï¼‰
                const personalityType = currentUserData.personality_type || currentUserData.personalityType || currentUserData.type || 'UNKNOWN';
                let personalityName = currentUserData.personality_name || currentUserData.personalityName || null;
                // è§†å›¾è¿”å›çš„ vibe_index ä¸ºæ•°å€¼ï¼ˆç»¼åˆåˆ†ï¼‰ï¼Œäººæ ¼/ç­”æ¡ˆä¹‹ä¹¦éœ€ 5 ä½å­—ç¬¦ä¸²ï¼šä¼˜å…ˆ vibe_index_str / vibeIndex / lpdefï¼Œå¦åˆ™ä» detailedStats æˆ– l_score ç­‰è®¡ç®—
                const vibeIndexStr = (typeof currentUserData.vibe_index_str === 'string' && currentUserData.vibe_index_str.length === 5)
                    ? currentUserData.vibe_index_str
                    : (typeof currentUserData.vibe_index === 'string' && currentUserData.vibe_index.length === 5 ? currentUserData.vibe_index : null)
                    || (typeof currentUserData.vibeIndex === 'string' && currentUserData.vibeIndex.length === 5 ? currentUserData.vibeIndex : null)
                    || lpdefToVibeIndex(currentUserData.lpdef)
                    || scoresToVibeIndexStr(currentUserData);
                
                // å¦‚æœè¿˜æ²¡æœ‰äººæ ¼ç§°å·ï¼Œå°è¯•æ ¹æ® 5 ä½ vibe_index ä» personalityNames.json è·å–ï¼ˆå‚è€ƒ index.htmlï¼‰
                const loadPersonalityName = (vibeIndex) => {
                    return new Promise((resolve) => {
                        const idx = (vibeIndex != null && typeof vibeIndex === 'string') ? vibeIndex : String(vibeIndex || '');
                        if (!idx || idx.length !== 5) {
                            resolve(null);
                            return;
                        }
                        // è‹±æ–‡ä¼˜å…ˆï¼šè‹¥æœ‰å¤–éƒ¨é…ç½®/æ–‡ä»¶ï¼Œåˆ™åŠ è½½è‹±æ–‡ç§°å·è¡¨
                        const tryLocal = () => {
                            try {
                                const cfg = window.__LANG_CONFIG;
                                if (currentLang === 'en' && cfg && cfg.personalityNamesEn && cfg.personalityNamesEn[idx]) {
                                    resolve(String(cfg.personalityNamesEn[idx]));
                                    return true;
                                }
                            } catch { /* ignore */ }
                            return false;
                        };
                        if (tryLocal()) return;

                        const url = (currentLang === 'en') ? 'src/personalityNames_en.json' : 'src/personalityNames.json';
                        fetch(url)
                            .then(response => {
                                if (response.ok) {
                                    return response.json();
                                }
                                throw new Error('Failed to load personalityNames.json');
                            })
                            .then(namesData => {
                                if (namesData && namesData[idx]) {
                                    console.log('[UserStats] âœ… ä» personalityNames.json è·å–äººæ ¼ç§°å·:', namesData[idx]);
                                    resolve(String(namesData[idx]));
                                } else {
                                    resolve(null);
                                }
                            })
                            .catch(error => {
                                console.warn('[UserStats] âš ï¸ åŠ è½½ personalityNames.json å¤±è´¥:', error);
                                resolve(null);
                            });
                    });
                };
                
                // å¦‚æœè¿˜æ²¡æœ‰äººæ ¼ç§°å·ï¼Œå°è¯•ä»å¤šä¸ªæ¥æºè·å–
                if (!personalityName || personalityName === 'æœªçŸ¥äººæ ¼' || personalityName === 'æœªçŸ¥') {
                    try {
                        // æ–¹æ³•1: ä» personality JSONB å­—æ®µä¸­è·å–ï¼ˆåŒæ­¥æ–¹å¼ï¼Œç«‹å³æ˜¾ç¤ºï¼‰
                        const personality = currentUserData.personality;
                        if (personality && typeof personality === 'object') {
                            personalityName = personality.name || personality.personalityName || personality.personality_name || null;
                            
                            // å¦‚æœè¿˜æ²¡æœ‰ï¼Œå°è¯•ä» personality_data æˆ– detailedStats ä¸­è·å–
                            if (!personalityName) {
                                const personalityData = currentUserData.personality_data || currentUserData.personalityData || personality.detailedStats || personality.detailed_stats;
                                if (personalityData && Array.isArray(personalityData) && personalityData.length > 0) {
                                    const firstDim = personalityData[0];
                                    personalityName = firstDim.personalityName || firstDim.personality_name || null;
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('[UserStats] âš ï¸ è·å–äººæ ¼ç§°å·å¤±è´¥:', e);
                    }
                }
                
                // è°ƒè¯•æ—¥å¿—ï¼šè¾“å‡ºæ‰€æœ‰å¯èƒ½åŒ…å«äººæ ¼ç§°å·çš„å­—æ®µ
                console.log('[UserStats] ğŸ­ äººæ ¼ç§°å·è·å–è°ƒè¯•:', {
                    personality_name: currentUserData.personality_name,
                    personalityName: currentUserData.personalityName,
                    personality: currentUserData.personality,
                    personality_data: currentUserData.personality_data,
                    personalityType: personalityType,
                    vibe_index_str: currentUserData.vibe_index_str,
                    vibe_index: currentUserData.vibe_index,
                    vibeIndex: currentUserData.vibeIndex,
                    lpdef: currentUserData.lpdef,
                    vibeIndexStr: vibeIndexStr,
                    finalPersonalityName: personalityName
                });
                
                // æœ€ç»ˆå›é€€ï¼šè‹¥ä»æ— äººæ ¼ç§°å·ï¼Œåˆ™ç»™å‡ºå¯æ§çš„æœ¬åœ°åŒ–å…œåº•
                if (!personalityName || personalityName === 'æœªçŸ¥äººæ ¼' || personalityName === 'æœªçŸ¥') {
                    const typeUpper = (personalityType && String(personalityType).toUpperCase()) || '';
                    if (personalityType && personalityType !== 'UNKNOWN' && typeUpper !== 'AUTO_REPORT') {
                        personalityName = currentLang === 'en' ? `Type ${personalityType}` : `äººæ ¼ ${personalityType}`;
                    } else {
                        personalityName = getI18nText('personality.unknown') || (currentLang === 'en' ? 'Unknown Title' : 'æœªçŸ¥äººæ ¼');
                    }
                }

                // äººæ ¼ç§°å·è‹±æ–‡æ˜ å°„ï¼ˆç¤ºä¾‹ï¼šç å†œ -> Code Monkey/Architectï¼‰
                personalityName = translatePersonalityName(personalityName, currentUserData);
                
                // 8. ç­”æ¡ˆä¹‹ä¹¦è¯´æ˜ï¼ˆanswer_book å¯¹è±¡ï¼‰
                let answerBookTitle = currentLang === 'en' ? 'N/A' : 'æš‚æ— ';
                let answerBookContent = currentLang === 'en' ? 'N/A' : 'æš‚æ— è¯´æ˜';
                let answerBookVibeLevel = '';
                
                try {
                    // å°è¯•è§£æ answer_book å­—æ®µï¼ˆå¯èƒ½æ˜¯ JSON å­—ç¬¦ä¸²æˆ–å¯¹è±¡ï¼‰
                    let answerBook = currentUserData.answer_book || currentUserData.answerBook;
                    
                    // å¦‚æœ answer_book ä¸å­˜åœ¨ï¼Œå°è¯•ä» personality JSONB å­—æ®µä¸­è·å–
                    if (!answerBook) {
                        try {
                            const personality = currentUserData.personality;
                            if (personality && typeof personality === 'object') {
                                answerBook = personality.answer_book || personality.answerBook;
                            }
                        } catch (e) {
                            console.warn('[UserStats] âš ï¸ ä» personality æå– answer_book å¤±è´¥:', e);
                        }
                    }
                    
                    // å¦‚æœ answer_book æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æä¸º JSON
                    if (typeof answerBook === 'string') {
                        try {
                            answerBook = JSON.parse(answerBook);
                        } catch (e) {
                            console.warn('[UserStats] âš ï¸ è§£æ answer_book JSON å¤±è´¥:', e);
                        }
                    }
                    
                    // å¤„ç† answer_book å¯¹è±¡ï¼šä»Šæ—¥ç®´è¨€ä»…ä½¿ç”¨ç­”æ¡ˆä¹‹ä¹¦çš„ title ä¸ contentï¼Œä¸ index ä¸­ç­”æ¡ˆä¹‹ä¹¦ä¸€è‡´
                    if (answerBook && typeof answerBook === 'object') {
                        answerBookTitle = answerBook.title || answerBookTitle;
                        answerBookContent = answerBook.content || answerBookContent || answerBook.desc || answerBook.description || answerBookContent;
                        answerBookVibeLevel = answerBook.vibe_level || answerBook.vibeLevel || answerBook.level || '';
                    }
                    
                    // ä¸ index åŒæ­¥ï¼šè‹¥æ—  answer_bookï¼Œä¼˜å…ˆä½¿ç”¨ index åˆ†æå®Œæˆåå†™å…¥çš„ã€Œç­”æ¡ˆä¹‹ä¹¦ã€ï¼ˆä¾›å·¦ä¾§æŠ½å±‰ç”¨æˆ·ï¼‰
                    if ((!answerBookTitle || answerBookTitle === 'æš‚æ— ') && (!answerBookContent || answerBookContent === 'æš‚æ— è¯´æ˜')) {
                        try {
                            const saved = localStorage.getItem('user_answer_book');
                            if (saved) {
                                const ab = JSON.parse(saved);
                                if (ab && typeof ab === 'object' && (ab.title || ab.content)) {
                                    answerBookTitle = ab.title || answerBookTitle;
                                    answerBookContent = ab.content || answerBookContent || ab.desc || ab.description || answerBookContent;
                                    answerBookVibeLevel = ab.vibe_level || ab.vibeLevel || ab.level || '';
                                    console.log('[UserStats] âœ… å·²ä» index ä¼ å…¥çš„ç­”æ¡ˆä¹‹ä¹¦ï¼ˆlocalStorageï¼‰åŠ è½½ä»Šæ—¥ç®´è¨€:', answerBookTitle);
                                }
                            }
                        } catch (e) {
                            console.warn('[UserStats] è¯»å– user_answer_book å¤±è´¥:', e);
                        }
                    }

                    // ä¸­æ–‡æ¨¡å¼ï¼šè‹¥ localStorage æ³¨å…¥çš„æ˜¯è‹±æ–‡æ–‡æ¡ˆï¼Œåˆ™å›é€€ç”¨æœ¬åœ° JSON çš„ä¸­æ–‡ç‰ˆæœ¬ï¼ˆé¿å…ä¸­æ–‡é¡µå‡ºç°è‹±æ–‡ï¼‰
                    if (currentLang !== 'en') {
                        const hasCjk = (s) => /[\u3040-\u30ff\u3400-\u9fff]/.test(String(s || ''));
                        const looksEnglishOnly = (s) => {
                            const x = String(s || '').trim();
                            if (!x) return false;
                            if (hasCjk(x)) return false;
                            return /^[\x00-\x7F\s\S]+$/.test(x);
                        };
                        if (looksEnglishOnly(answerBookTitle) || looksEnglishOnly(answerBookContent)) {
                            answerBookTitle = 'æš‚æ— ';
                            answerBookContent = 'æš‚æ— è¯´æ˜';
                        }
                    }
                    
                    // ä¸ index åŒæ­¥ï¼šè‹¥æ—  answer_book ä¸”æ—  localStorageï¼Œç”¨ 5 ä½ vibe_indexï¼ˆvibe_index_str/lpdefï¼‰æŸ¥ JSON
                    if ((!answerBookTitle || answerBookTitle === 'æš‚æ— ') && (!answerBookContent || answerBookContent === 'æš‚æ— è¯´æ˜')) {
                        const vibeIndexForBook = vibeIndexStr;
                        if (vibeIndexForBook && typeof vibeIndexForBook === 'string' && vibeIndexForBook.length === 5) {
                            try {
                                const resp = await fetch('src/answerBookByVibeIndex.json');
                                if (resp.ok) {
                                    const data = await resp.json();
                                    const entry = data[vibeIndexForBook]; // ä»…ç”¨è¯¥ç”¨æˆ· 5 ä½ vibe_index çš„æ¡ç›®ï¼Œä¸ç”¨ data['default']
                                    if (entry) {
                                        answerBookTitle = (currentLang === 'zh' || currentLang === 'zh-CN') ? entry.title_zh : entry.title_en;
                                        answerBookContent = (currentLang === 'zh' || currentLang === 'zh-CN') ? entry.content_zh : entry.content_en;
                                        console.log('[UserStats] âœ… å·²æŒ‰ vibe_index ä» answerBookByVibeIndex.json åŠ è½½ä»Šæ—¥ç®´è¨€:', answerBookTitle);
                                    }
                                    // æ— å¯¹åº”æ¡ç›®æ—¶ä¿æŒã€Œæš‚æ— ã€/ã€Œæš‚æ— è¯´æ˜ã€ï¼Œä¸æ˜¾ç¤ºç¡¬ç¼–ç  default
                                }
                            } catch (e) {
                                console.warn('[UserStats] âš ï¸ åŠ è½½ answerBookByVibeIndex.json å¤±è´¥:', e);
                            }
                        }
                    }
                    
                    // ä¸å†ç”¨ roast_text ä½œä¸ºä»Šæ—¥ç®´è¨€ï¼šroast_text æ˜¯å„ç»´åº¦åæ§½æ‹¼æ¥ï¼ˆå¦‚ã€Œã€Lç»´åº¦ã€‘â€¦ã€Pç»´åº¦ã€‘â€¦ã€ï¼‰ï¼Œå¹¶éç­”æ¡ˆä¹‹ä¹¦å¯¹åº”æ–‡æœ¬
                } catch (e) {
                    console.warn('[UserStats] âš ï¸ å¤„ç† answer_book å¤±è´¥:', e);
                }

                // 9. çœŸå®è¯„ä»·ï¼ˆå¼•ç”¨ index.html çš„æœ€ç»ˆåˆ†æç»“æœï¼šcursor_clinical_history.analysisData.vibeResult æˆ– last_analysis_dataï¼‰
                let realEvalTitle = '';
                let realEvalText = '';
                let realEvalTraits = [];
                let realEvalUsedAnswerBookFallback = false;
                try {
                    // ã€ä¿®å¤ã€‘ä¼˜å…ˆä» cursor_clinical_history è·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä» last_analysis_data è·å–
                    let histStr = localStorage.getItem('cursor_clinical_history') || '';
                    let hist = histStr ? JSON.parse(histStr) : null;
                    let vr = hist?.analysisData?.vibeResult || null;
                    
                    // å¦‚æœæ²¡æœ‰ cursor_clinical_historyï¼Œå°è¯•ä» last_analysis_data æ„å»º
                    if (!vr) {
                        try {
                            const lastAnalysisStr = localStorage.getItem('last_analysis_data');
                            if (lastAnalysisStr) {
                                const lastAnalysis = JSON.parse(lastAnalysisStr);
                                if (lastAnalysis) {
                                    // ä» last_analysis_data æ„å»º vibeResult å¯¹è±¡
                                    vr = {
                                        personalityName: lastAnalysis.personalityName,
                                        personalityNameZh: lastAnalysis.personalityNameZh,
                                        personalityNameEn: lastAnalysis.personalityNameEn,
                                        roastText: lastAnalysis.roastText,
                                        roastTextZh: lastAnalysis.roastTextZh,
                                        roastTextEn: lastAnalysis.roastTextEn,
                                        analysis: lastAnalysis.analysis,
                                        dimensions: lastAnalysis.dimensions,
                                        vibeIndex: lastAnalysis.vibeIndex,
                                        personalityType: lastAnalysis.personalityType,
                                    };
                                    console.log('[UserStats] ä» last_analysis_data æ„å»ºçœŸå®è¯„ä»·æ•°æ®:', vr);
                                }
                            }
                        } catch (e) {
                            console.warn('[UserStats] ä» last_analysis_data è·å–æ•°æ®å¤±è´¥:', e);
                        }
                    }
                    
                    if (vr) {
                        const containsCjk = (s) => /[\u3040-\u30ff\u3400-\u9fff]/.test(String(s || ''));
                        const pickFirstNonEmpty = (arr) => {
                            for (const x of arr) {
                                const t = String(x || '').trim();
                                if (t) return t;
                            }
                            return '';
                        };
                        const buildTraitsZhFromVibeIndex = (idx) => {
                            const s = String(idx || '').trim();
                            if (!/^\d{5}$/.test(s)) return [];
                            const toLevel = (d) => (d === '2' ? 'é«˜' : (d === '1' ? 'ä¸­' : 'ä½'));
                            const pairs = [
                                ['é€»è¾‘', toLevel(s[0])],
                                ['è€å¿ƒ', toLevel(s[1])],
                                ['ç»†èŠ‚', toLevel(s[2])],
                                ['æ¢ç´¢', toLevel(s[3])],
                                ['åé¦ˆ', toLevel(s[4])]
                            ];
                            return pairs.map(([k, v]) => `${k}${v}`);
                        };
                        const looksEnglishOnly = (s) => {
                            const x = String(s || '').trim();
                            if (!x) return false;
                            if (containsCjk(x)) return false;
                            // åªåŒ…å« ASCII / æ‹‰ä¸å­—ç¬¦ï¼Œè§†ä¸ºè‹±æ–‡
                            return /^[\x00-\x7F\s\S]+$/.test(x);
                        };
                        // è¿‡æ»¤â€œäº¤äº’é£æ ¼æŒ‡æ•°/Standard Developerâ€ç­‰ answer_book æ¨¡æ¿ï¼ˆè¯¥æ¨¡æ¿æ¥è‡ªåç«¯ answer_book å…œåº•ï¼Œä¸å±äºçœŸå®è¯„ä»·ï¼‰
                        const isStyleIndexTemplate = (title, text) => {
                            const t = String(title || '');
                            const x = String(text || '');
                            const joined = `${t}\n${x}`;
                            // ä¸­æ–‡æ¨¡æ¿å…³é”®å­—
                            if (/äº¤äº’é£æ ¼æŒ‡æ•°/.test(joined) && /(æ ‡å‡†å‹å¼€å‘è€…|é›„è¾©å®¶|å†·é…·æå®¢)/.test(joined)) return true;
                            if (/ä¿æŒäº†å¹³è¡¡çš„æ²Ÿé€šæ–¹å¼|æ—¢ä¸è¿‡äºè¯¦ç»†|ä¹Ÿä¸è¿‡äºç®€æ´/.test(joined)) return true;
                            // è‹±æ–‡æ¨¡æ¿å…³é”®å­—
                            if (/\bstyle index\b/i.test(joined) && /(standard developer|eloquent speaker|cold geek)/i.test(joined)) return true;
                            if (/neither too detailed nor too concise/i.test(joined)) return true;
                            if (/average message length/i.test(joined) && /\bstyle index\b/i.test(joined)) return true;
                            return false;
                        };
                        // è¯†åˆ«â€œåæ§½æ–‡æ¡ˆæ­£åœ¨ç”±åç«¯ç”Ÿæˆä¸­/æœªæ‰¾åˆ°â€ç­‰å ä½æ–‡æ¡ˆï¼Œè§†ä¸ºæ— æ•ˆä»¥ä¾¿æ”¹ç”¨ roastLibrary ç”ŸæˆçœŸå®è¯„ä»·
                        const isPlaceholderRoastText = (text) => {
                            const x = String(text || '').trim();
                            if (!x) return false;
                            if (/ç´¢å¼•\s*\d+\s*å¯¹åº”çš„åæ§½æ–‡æ¡ˆ(æ­£åœ¨ç”±åç«¯ç”Ÿæˆä¸­|æœªæ‰¾åˆ°)[^ï¼]*äººæ ¼ç»„åˆå¤ªç‹¬ç‰¹/.test(x)) return true;
                            if (/personality combination is so unique that even our AI needs more time to craft the perfect roast/i.test(x)) return true;
                            return false;
                        };
                        const loadRoastLibraryForLang = async (lang) => {
                            const safeLang = (lang === 'en') ? 'en' : 'zh';
                            try {
                                const cfg = window.__LANG_CONFIG || {};
                                const cached = (safeLang === 'en') ? cfg.roastEn : cfg.roastZh;
                                if (cached && typeof cached === 'object') return cached;
                            } catch { /* ignore */ }
                            const url = (safeLang === 'en') ? 'src/roastLibrary2.json' : 'src/roastLibrary.json';
                            try {
                                const resp = await fetch(url, { cache: 'no-cache' });
                                if (!resp.ok) return null;
                                const data = await resp.json();
                                try {
                                    const cfg = window.__LANG_CONFIG || {};
                                    window.__LANG_CONFIG = {
                                        ...cfg,
                                        ...(safeLang === 'en' ? { roastEn: data } : { roastZh: data })
                                    };
                                } catch { /* ignore */ }
                                return data;
                            } catch {
                                return null;
                            }
                        };
                        const fillRealEvalFromDossier = async () => {
                            const idx = (vibeIndexStr && typeof vibeIndexStr === 'string' && vibeIndexStr.length === 5) ? vibeIndexStr : '';
                            if (!idx) return false;
                            const lang = (currentLang === 'en') ? 'en' : 'zh';
                            const lib = await loadRoastLibraryForLang(lang);
                            const raw = lib && typeof lib === 'object' ? (lib[idx] || '') : '';
                            const s = String(raw || '').trim();
                            if (!s) return false;
                            // roastLibrary çš„æ ¼å¼ä¸€èˆ¬ä¸º "ç§°å·: è¯´æ˜..."ï¼ˆä¸­è‹±æ–‡åˆ†åˆ«ä½¿ç”¨ ï¼š / : éƒ½å¯èƒ½ï¼‰
                            let titleFromLib = '';
                            let textFromLib = s;
                            const m = s.match(/^(.+?)[ï¼š:]\s*(.+)$/);
                            if (m) {
                                titleFromLib = String(m[1] || '').trim();
                                textFromLib = String(m[2] || '').trim();
                            }
                            // æ ‡é¢˜ä¼˜å…ˆç”¨å·²è§£æçš„äººæ ¼ç§°å·ï¼ˆå’Œ index.html åŒæºï¼‰ï¼Œå¦åˆ™ç”¨ roast åº“è‡ªå¸¦ç§°å·
                            if (!realEvalTitle) realEvalTitle = personalityName || titleFromLib || '';
                            // æ­£æ–‡ä½¿ç”¨äººæ ¼æ¡£æ¡ˆè¯´æ˜ï¼ˆroast libraryï¼‰
                            realEvalText = textFromLib || realEvalText || '';
                            // traitsï¼šä¸­æ–‡ç”¨äº”ç»´æ¨å¯¼ï¼Œè‹±æ–‡ä¿æŒåŸæœ‰/æˆ–ç•™ç©º
                            if (lang !== 'en' && (!Array.isArray(realEvalTraits) || realEvalTraits.length === 0)) {
                                realEvalTraits = buildTraitsZhFromVibeIndex(idx).slice(0, 5);
                            }
                            return true;
                        };

                        if (currentLang === 'en') {
                            // è‹±æ–‡ï¼šä¼˜å…ˆä½¿ç”¨ *_en / *En å­—æ®µï¼ˆå¯¹é½ index.html reanalyzeWithLanguage äº§ç‰©ï¼‰
                            realEvalTitle = pickFirstNonEmpty([
                                vr.personalityNameEn,
                                vr.personality_name_en,
                                vr.personality_nameEn,
                                vr.analysis?.name_en,
                                vr.analysis?.nameEn,
                                vr.analysis_en?.name,
                                vr.analysis?.name
                            ]);
                            realEvalText = pickFirstNonEmpty([
                                vr.roastTextEn,
                                vr.roast_text_en,
                                vr.roast_textEn,
                                vr.analysis?.description_en,
                                vr.analysis?.descriptionEn,
                                vr.analysis_en?.description,
                                vr.roastText,
                                vr.roast_text,
                                vr.analysis?.description
                            ]);
                            if (isPlaceholderRoastText(realEvalText)) realEvalText = '';

                            const traitsEn =
                                vr.analysis?.traits_en ||
                                vr.analysis?.traitsEn ||
                                vr.analysis_en?.traits ||
                                vr.analysis?.traits;
                            if (Array.isArray(traitsEn)) {
                                realEvalTraits = traitsEn.map((t) => String(t || '').trim()).filter(Boolean).slice(0, 5);
                                // è‹±æ–‡æ¨¡å¼ä¸‹å‰”é™¤å«ä¸­æ–‡çš„ traitï¼ˆé¿å…æ··æ’ï¼‰
                                realEvalTraits = realEvalTraits.filter((t) => !containsCjk(t));
                            }

                            // è¿‡æ»¤ answer_book æ¨¡æ¿ï¼ˆäº¤äº’é£æ ¼æŒ‡æ•°ç­‰ï¼‰ï¼Œå¹¶ä¼˜å…ˆä½¿ç”¨äººæ ¼æ¡£æ¡ˆåº“ï¼ˆroastLibrary2ï¼‰
                            if (isStyleIndexTemplate(realEvalTitle, realEvalText)) {
                                realEvalTitle = '';
                                realEvalText = '';
                                realEvalTraits = [];
                            }

                            // å¦‚æœä»ç„¶æ˜¯ä¸­æ–‡å†…å®¹ï¼šè‹±æ–‡æ¨¡å¼ä¸‹ä¸å±•ç¤ºä¸­æ–‡ï¼Œç”¨äººæ ¼æ¡£æ¡ˆåº“å…œåº•ï¼›å†ä¸è¡Œæ‰æç¤º
                            if (containsCjk(realEvalTitle) || containsCjk(realEvalText) || (!realEvalTitle && !realEvalText)) {
                                const ok = await fillRealEvalFromDossier().catch(() => false);
                                if (!ok) {
                                    realEvalTitle = '';
                                    realEvalTraits = [];
                                    realEvalText = 'Real evaluation is not available in English for this run.';
                                }
                            }
                        } else {
                            // ä¸­æ–‡ï¼šæ ‡é¢˜ä¼˜å…ˆç”¨äººæ ¼ç§°å·ï¼ˆç”¨æˆ·å¯è¯»ï¼‰ï¼Œå…¶æ¬¡ç”¨ analysis.name
                            realEvalTitle = pickFirstNonEmpty([
                                vr.personalityNameZh,
                                vr.personality_name_zh,
                                vr.personality_nameZh,
                                vr.analysis?.name_zh,
                                vr.analysis?.nameZh,
                                vr.analysis_zh?.name,
                                vr.personalityName,
                                vr.personality_name,
                                vr.analysis?.name
                            ]);
                            // æ­£æ–‡ä¼˜å…ˆç”¨ roastTextZh/description_zhï¼›å¦åˆ™æ‰é€€å›é€šç”¨å­—æ®µ
                            realEvalText = pickFirstNonEmpty([
                                vr.roastTextZh,
                                vr.roast_text_zh,
                                vr.roast_textZh,
                                vr.analysis?.description_zh,
                                vr.analysis?.descriptionZh,
                                vr.analysis_zh?.description,
                                vr.roastText,
                                vr.roast_text,
                                vr.analysis?.description
                            ]);
                            const hadPlaceholderRoast = isPlaceholderRoastText(realEvalText);
                            if (hadPlaceholderRoast) realEvalText = '';

                            const traitsZh =
                                vr.analysis?.traits_zh ||
                                vr.analysis?.traitsZh ||
                                vr.analysis_zh?.traits ||
                                vr.analysis?.traits;
                            if (Array.isArray(traitsZh)) {
                                realEvalTraits = traitsZh.map((t) => String(t || '').trim()).filter(Boolean).slice(0, 5);
                                // ä¸­æ–‡æ¨¡å¼ä¸‹å‰”é™¤â€œæ˜æ˜¾æ˜¯è‹±æ–‡å¥å­â€çš„ traitï¼Œé¿å…ä¸­æ–‡é¡µæ··è‹±æ–‡æ ‡ç­¾
                                realEvalTraits = realEvalTraits.filter((t) => containsCjk(t));
                            }

                            // è¿‡æ»¤ answer_book æ¨¡æ¿ï¼ˆäº¤äº’é£æ ¼æŒ‡æ•°/æ ‡å‡†å‹å¼€å‘è€…ç­‰ï¼‰ï¼Œå¹¶ä¼˜å…ˆä½¿ç”¨äººæ ¼æ¡£æ¡ˆåº“ï¼ˆroastLibraryï¼‰
                            if (isStyleIndexTemplate(realEvalTitle, realEvalText)) {
                                realEvalTitle = '';
                                realEvalText = '';
                                realEvalTraits = [];
                            }

                            // ä¸­æ–‡æ¨¡å¼ï¼šè‹¥ä¸ºå ä½æ–‡æ¡ˆ/è‹±æ–‡/ç©º/è¢«è¿‡æ»¤ï¼Œåˆ™ç”¨â€œç”¨æˆ·å¯¹åº”çš„ä¸­æ–‡äººæ ¼æ¡£æ¡ˆè¯´æ˜â€ï¼ˆroastLibrary.jsonï¼‰ç”ŸæˆçœŸå®è¯„ä»·
                            if (hadPlaceholderRoast || looksEnglishOnly(realEvalTitle) || looksEnglishOnly(realEvalText) || (!realEvalTitle && !realEvalText)) {
                                const ok = await fillRealEvalFromDossier().catch(() => false);
                                if (!ok) {
                                    // æ¬¡çº§å…œåº•ï¼šç­”æ¡ˆä¹‹ä¹¦ï¼ˆé¿å…ç©ºç™½ï¼Œä½†ä¸å†ä½¿ç”¨â€œäº¤äº’é£æ ¼æŒ‡æ•°â€æ¨¡æ¿ï¼‰
                                    realEvalUsedAnswerBookFallback = true;
                                    try {
                                        if (answerBookTitle && answerBookTitle !== 'æš‚æ— ') realEvalTitle = answerBookTitle;
                                        if (answerBookContent && answerBookContent !== 'æš‚æ— è¯´æ˜') realEvalText = answerBookContent;
                                    } catch { /* ignore */ }

                                    if ((!realEvalTitle || !realEvalText) && vibeIndexStr && typeof vibeIndexStr === 'string' && vibeIndexStr.length === 5) {
                                        try {
                                            const cfg = window.__LANG_CONFIG;
                                            const book = cfg && cfg.answerBookByVibeIndex;
                                            const entry = book ? (book[vibeIndexStr] || null) : null;
                                            if (entry) {
                                                if (!realEvalTitle) realEvalTitle = entry.title_zh || '';
                                                if (!realEvalText) realEvalText = entry.content_zh || '';
                                            }
                                        } catch { /* ignore */ }
                                    }

                                    // æ ‡ç­¾å…œåº•ï¼šç”¨ vibe_index çš„ 5 ç»´ï¼ˆL/P/D/E/Fï¼‰æ¨å¯¼ä¸­æ–‡æ ‡ç­¾
                                    if ((!Array.isArray(realEvalTraits) || realEvalTraits.length === 0) && vibeIndexStr && typeof vibeIndexStr === 'string' && vibeIndexStr.length === 5) {
                                        realEvalTraits = buildTraitsZhFromVibeIndex(vibeIndexStr).slice(0, 5);
                                    }

                                    // æœ€åå…œåº•
                                    if (!realEvalTitle) realEvalTitle = '';
                                    if (!realEvalText) realEvalText = 'æš‚æ— çœŸå®è¯„ä»·ï¼ˆä¸­æ–‡æ–‡æ¡ˆç¼ºå¤±ï¼‰';
                                }
                            }
                        }
                    }
                } catch { /* ignore */ }

                // è‹¥æ²¡æœ‰ index å†å²ç»“æœï¼Œä¹Ÿå°½é‡ç»™ä¸­æ–‡çœŸå®è¯„ä»·å¡«å…¥â€œäººæ ¼æ¡£æ¡ˆè¯´æ˜â€
                if (currentLang !== 'en' && (!realEvalTitle && !realEvalText)) {
                    try {
                        if (vibeIndexStr && typeof vibeIndexStr === 'string' && vibeIndexStr.length === 5) {
                            // ç›´æ¥èµ° roastLibrary.jsonï¼ˆé¿å…ç©ºç™½ï¼‰
                            const resp = await fetch('src/roastLibrary.json', { cache: 'no-cache' });
                            if (resp.ok) {
                                const lib = await resp.json();
                                const raw = lib && lib[vibeIndexStr] ? String(lib[vibeIndexStr]) : '';
                                const s = String(raw || '').trim();
                                if (s) {
                                    const m = s.match(/^(.+?)[ï¼š:]\s*(.+)$/);
                                    if (m) {
                                        realEvalTitle = personalityName || String(m[1] || '').trim();
                                        realEvalText = String(m[2] || '').trim();
                                    } else {
                                        realEvalTitle = personalityName || '';
                                        realEvalText = s;
                                    }
                                    realEvalTraits = realEvalTraits && realEvalTraits.length ? realEvalTraits : [
                                        `é€»è¾‘${vibeIndexStr[0] === '2' ? 'é«˜' : (vibeIndexStr[0] === '1' ? 'ä¸­' : 'ä½')}`,
                                        `è€å¿ƒ${vibeIndexStr[1] === '2' ? 'é«˜' : (vibeIndexStr[1] === '1' ? 'ä¸­' : 'ä½')}`,
                                        `ç»†èŠ‚${vibeIndexStr[2] === '2' ? 'é«˜' : (vibeIndexStr[2] === '1' ? 'ä¸­' : 'ä½')}`,
                                        `æ¢ç´¢${vibeIndexStr[3] === '2' ? 'é«˜' : (vibeIndexStr[3] === '1' ? 'ä¸­' : 'ä½')}`,
                                        `åé¦ˆ${vibeIndexStr[4] === '2' ? 'é«˜' : (vibeIndexStr[4] === '1' ? 'ä¸­' : 'ä½')}`,
                                    ].slice(0, 5);
                                }
                            }
                        }
                    } catch { /* ignore */ }
                }
                
                // åˆ›å»ºç”¨æˆ·ç»Ÿè®¡å¡ç‰‡å®¹å™¨ï¼ˆèµ›åšç—…ç†é£æ ¼ï¼šborder-white/10 bg-[#0a0a0a]/80 backdrop-blurï¼‰
                const statsCard = document.createElement('div');
                statsCard.className = 'drawer-item dashboard-card backdrop-blur';
                statsCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">ğŸ“Š</span>
                        <span class="text-[8px] leading-none text-[var(--accent-terminal)] border border-[var(--accent-terminal)]/40 px-1 py-0.5 tracking-widest uppercase bg-[var(--accent-terminal)]/5 font-mono font-semibold">
                            ${escapeHtml(getI18nText('badge.stats') || 'STATS')}
                        </span>
                    </div>
                    
                    <div class="drawer-item-label mb-3">${getI18nText('drawer.my_stats') || 'My Stats'}</div>
                    
                    <!-- æŠ€æœ¯æ’åï¼ˆèµ›åšç—…ç†ç½®ä¿¡åº¦ï¼š<10 æ¡æ¶ˆæ¯æ—¶åŠé€æ˜æç¤ºï¼›ç™¾åˆ†æ¯”å…œåº• jiafang_rank_percent ç­‰ï¼‰ -->
                    <div class="mb-3 pb-3 border-b border-[var(--border-ui)]">
                        <div class="drawer-item-label mb-1">${getI18nText('drawer.tech_rank') || (currentLang === 'en' ? 'Tech Rank' : 'æŠ€æœ¯æ’å')}</div>
                        <div class="drawer-item-value dashboard-metric-value text-lg ${techRankClass}">${techRankText}</div>
                        <div class="text-[10px] text-zinc-500 mt-1">${currentLang === 'en' ? 'Top' : 'å‰'} ${jiafangPct} ${currentLang === 'en' ? 'Boss' : 'ç”²æ–¹'} | ${currentLang === 'en' ? 'Top' : 'å‰'} ${ketaoPct} ${currentLang === 'en' ? 'Kowtow' : 'ç£•å¤´'} | ${currentLang === 'en' ? 'Top' : 'å‰'} ${daysPct} ${currentLang === 'en' ? 'Days' : 'å¤©æ•°'}</div>
                        ${confidenceHint}
                        <div class="drawer-item-desc text-[8px]">TECH_RANK</div>
                    </div>
                    
                    <!-- ç»´åº¦ç»Ÿè®¡ hrdkm: label #6a6a6a JetBrains Mono, value Space Grotesk #FFFFFF -->
                    <div class="space-y-2 mb-3">
                        <div class="flex items-center justify-between">
                            <span class="dashboard-metric-label text-[10px]">ğŸ’¬ ${getI18nText('metric.ai_interrogations') || (currentLang === 'en' ? 'AI Interrogations' : 'è°ƒæˆAIæ¬¡æ•°')}</span>
                            <span class="drawer-item-value text-sm">${withUnit(aiCount, unitTimes)}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="dashboard-metric-label text-[10px]">ğŸ“… ${getI18nText('metric.cursor_days') || (currentLang === 'en' ? 'Days On Duty' : 'ä¸Šå²—å¤©æ•°')}</span>
                            <span class="drawer-item-value text-sm" data-stat="days-on-duty" data-earliest-ts="${dayEarliestTs != null ? String(dayEarliestTs) : ''}">${dayCount} ${getI18nText('metric.cursor_days_unit') || (currentLang === 'en' ? 'days' : 'å¤©')}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="dashboard-metric-label text-[10px]">ğŸš« ${getI18nText('metric.jiafang') || (currentLang === 'en' ? 'Boss Mode Triggers' : 'ç”²æ–¹ä¸Šèº«æ¬¡æ•°')}</span>
                            <span class="drawer-item-value text-sm">${withUnit(noCount, unitTimes)}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="dashboard-metric-label text-[10px]">ğŸ™ ${getI18nText('metric.ketao') || (currentLang === 'en' ? 'Cyber Kowtows' : 'èµ›åšç£•å¤´æ¬¡æ•°')}</span>
                            <span class="drawer-item-value text-sm">${withUnit(pleaseCount, unitTimes)}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="dashboard-metric-label text-[10px]">ğŸ’­ ${getI18nText('metric.banter_total') || (currentLang === 'en' ? 'Banter Output' : 'åºŸè¯è¾“å‡ºæ€»æ•°')}</span>
                            <span class="drawer-item-value text-sm">${withUnit(sayTotal, unitChars)}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="dashboard-metric-label text-[10px]">ğŸ“ ${getI18nText('metric.avg_len') || (currentLang === 'en' ? 'Avg Prompt Length' : 'å¹³å‡å¹æ°´é•¿åº¦')}</span>
                            <span class="drawer-item-value text-sm">${avgLength} ${getI18nText('metric.avg_len_unit') || (currentLang === 'en' ? 'chars/msg' : 'å­—/æ¡')}</span>
                        </div>
                    </div>
                    
                    <!-- äººæ ¼ç§°å·ï¼ˆä¸ index ä¸€è‡´ï¼šä¼˜å…ˆç”± vibe_index ä» personalityNames.json è§£æï¼‰ -->
                    <div class="mb-3 pb-3 border-b border-[var(--border-ui)]">
                        <div class="drawer-item-label mb-1">${getI18nText('drawer.personality_title') || (currentLang === 'en' ? 'Title' : 'äººæ ¼ç§°å·')}</div>
                        <div class="drawer-item-value text-sm" data-stat="personality-name">${personalityName}</div>
                        <div class="drawer-item-desc text-[8px]">${personalityType === 'AUTO_REPORT' ? '' : (personalityType || '')}</div>
                    </div>

                    ${(realEvalText || realEvalTitle) ? `
                    <div class="mb-3 pb-3 border-b border-[var(--border-ui)]">
                        <div class="drawer-item-label mb-1">${currentLang === 'en' ? 'Real Evaluation' : 'çœŸå®è¯„ä»·'}</div>
                        ${realEvalTitle ? `<div class="text-[12px] text-white font-bold mb-1">${esc(realEvalTitle)}</div>` : ''}
                        ${realEvalText ? `<div class="text-[12px] text-zinc-300 leading-relaxed">${esc(realEvalText)}</div>` : ''}
                        ${Array.isArray(realEvalTraits) && realEvalTraits.length ? `
                            <div class="mt-2 space-y-1">
                                ${realEvalTraits.map((t) => `<div class="text-[11px] text-[#00ff41]/70">- ${esc(t)}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- ç­”æ¡ˆä¹‹ä¹¦ï¼ˆå‚è€ƒ index.htmlï¼šå»æ‰"ç­”æ¡ˆä¹‹ä¹¦"æ ‡é¢˜ï¼Œåªæ˜¾ç¤º title å’Œ contentï¼Œå¢å¤§æ­£æ–‡å­—ä½“ï¼‰ -->
                    ${(!realEvalUsedAnswerBookFallback && ((answerBookTitle && answerBookTitle !== 'æš‚æ— ') || (answerBookContent && answerBookContent !== 'æš‚æ— è¯´æ˜'))) ? `
                    <div class="mb-2">
                        ${answerBookTitle && answerBookTitle !== 'æš‚æ— ' ? `<div class="text-[13px] text-white font-bold mb-2">${answerBookTitle}</div>` : ''}
                        <div class="text-[13px] text-[#00ff41]/80 leading-relaxed">${answerBookContent && answerBookContent !== 'æš‚æ— è¯´æ˜' ? esc(answerBookContent) : ''}</div>
                    </div>
                    ` : ''}
                `;
                
                // å…ˆç§»é™¤æ—§çš„ç»Ÿè®¡å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const existingStatsCards = leftBody.querySelectorAll('.drawer-item');
                existingStatsCards.forEach(card => {
                    const label = card.querySelector('.drawer-item-label');
                    if (label && label.textContent === 'æˆ‘çš„æ•°æ®ç»Ÿè®¡') {
                        card.remove();
                    }
                });
                
                // å°†ç»Ÿè®¡å¡ç‰‡æ’å…¥åˆ°èº«ä»½é…ç½®å¡ç‰‡ä¹‹åï¼Œæ·»åŠ æ¸è¿›å¼åŠ¨ç”»
                statsCard.classList.add('clinic-card');
                statsCard.style.opacity = '0';
                statsCard.style.transform = 'translateY(12px)';
                
                const identityCard = leftBody.querySelector('.drawer-item');
                if (identityCard && identityCard.nextSibling) {
                    leftBody.insertBefore(statsCard, identityCard.nextSibling);
                } else {
                    leftBody.appendChild(statsCard);
                }
                
                // è§¦å‘æ¸å…¥åŠ¨ç”»
                requestAnimationFrame(() => {
                    statsCard.style.transition = 'opacity 0.35s ease-out, transform 0.35s ease-out';
                    statsCard.style.opacity = '1';
                    statsCard.style.transform = 'translateY(0)';
                });

                // ä¸Šå²—å¤©æ•°ï¼šæŠ½å±‰æ‰“å¼€åä¹Ÿè¦â€œå®æ—¶å¢é•¿â€ï¼ˆæ— éœ€æ‰‹åŠ¨åˆ·æ–°ï¼‰
                try {
                    const el = statsCard.querySelector('[data-stat="days-on-duty"]');
                    if (el) {
                        const tsRaw = (el.getAttribute('data-earliest-ts') || '').trim();
                        const ts = tsRaw ? Number(tsRaw) : NaN;
                        if (Number.isFinite(ts) && ts > 0) {
                            window.__daysOnDutyEarliestTs = ts;
                            const unit = getI18nText('metric.cursor_days_unit') || (currentLang === 'en' ? 'days' : 'å¤©');
                            const tick = () => {
                                try {
                                    const t0 = window.__daysOnDutyEarliestTs;
                                    if (!Number.isFinite(t0) || t0 <= 0) return;
                                    const diff = Math.floor((Date.now() - t0) / (1000 * 60 * 60 * 24));
                                    const days = Math.max(1, diff);
                                    const nf2 = new Intl.NumberFormat(currentLang === 'en' ? 'en-US' : 'zh-CN');
                                    el.textContent = `${nf2.format(days)} ${unit}`;
                                } catch { /* ignore */ }
                            };
                            tick();
                            if (!window.__daysOnDutyTimer) {
                                // æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡è¶³å¤Ÿâ€œå®æ—¶â€
                                window.__daysOnDutyTimer = setInterval(tick, 60 * 1000);
                            }
                        }
                    }
                } catch { /* ignore */ }
                
                // äººæ ¼ç§°å·ä¸ index ä¸€è‡´ï¼šæœ‰ 5 ä½ vibe_indexï¼ˆvibe_index_str/lpdefï¼‰æ—¶ä» personalityNames.json è§£æå¹¶æ›´æ–°
                if (vibeIndexStr && typeof vibeIndexStr === 'string' && vibeIndexStr.length === 5) {
                    loadPersonalityName(vibeIndexStr).then(name => {
                        if (name) {
                            const personalityNameElement = statsCard.querySelector('[data-stat="personality-name"]');
                            if (personalityNameElement) {
                                personalityNameElement.textContent = translatePersonalityName(name, currentUserData);
                                console.log('[UserStats] âœ… å·²ä» personalityNames.json æ›´æ–°äººæ ¼ç§°å·:', name);
                            }
                        }
                    });
                }
                
                // åŠ¨æ€æ’å…¥ HTML åè§¦å‘ Tailwind CDN é‡æ–°æ‰«æï¼Œç¡®ä¿åŠ¨æ€ç±»åç”Ÿæ•ˆ
                try {
                    if (typeof window.tailwind !== 'undefined' && window.tailwind.config && typeof window.tailwind.config.refresh === 'function') {
                        window.tailwind.config.refresh();
                    }
                } catch (e) { /* ignore */ }
                console.log('[UserStats] âœ… ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡å·²æ¸²æŸ“');
            } catch (error) {
                console.error('[UserStats] âŒ æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡å¤±è´¥:', error);
            }
        }

        /**
         * ä»ç”¨æˆ·æ•°æ®ä¸­æå–ç»´åº¦å€¼
         * @param {Object} userData - ç”¨æˆ·æ•°æ®å¯¹è±¡
         * @returns {Object} åŒ…å« 6 ä¸ªç»´åº¦å€¼çš„å¯¹è±¡
         */
        function extractDimensionValues(userData) {
            if (!userData) {
                return {
                    ai: undefined,
                    word: undefined,
                    day: undefined,
                    no: undefined,
                    say: undefined,
                    please: undefined
                };
            }

            // ai (å¯¹è¯æ¬¡æ•°/èµ›åšéœ¸æ€»)ï¼šä¼˜å…ˆå– question_message_countï¼ˆv_top_records è§†å›¾ä½¿ç”¨ï¼‰ï¼Œå…¶æ¬¡ total_messages
            // å­—æ®µå›é€€ï¼šquestion_message_count -> total_messages -> l_score -> l -> L
            let messages = undefined;
            if (userData.question_message_count !== undefined && userData.question_message_count !== null) {
                messages = Number(userData.question_message_count);
            } else if (userData.total_messages !== undefined && userData.total_messages !== null) {
                messages = Number(userData.total_messages);
            } else if (userData.l_score !== undefined && userData.l_score !== null) {
                messages = Number(userData.l_score);
            } else if (userData.l !== undefined && userData.l !== null) {
                messages = Number(userData.l);
            } else if (userData.L !== undefined && userData.L !== null) {
                messages = Number(userData.L);
            }
            
            // say (æ€»å­—æ•°/ç´¯è®¡å­—æ•°)ï¼šä¼˜å…ˆ total_charsï¼ˆä¸ DB åˆ—åä¸€è‡´ï¼‰ï¼Œå›é€€ total_user_chars / totalUserChars
            let chars = undefined;
            const rawChars = userData.total_chars ?? userData['total_user_chars'];
            if (rawChars !== undefined && rawChars !== null && Number(rawChars) > 0) {
                chars = Number(rawChars);
            } else if (userData.totalUserChars !== undefined && userData.totalUserChars !== null && Number(userData.totalUserChars) > 0) {
                chars = Number(userData.totalUserChars);
            } else if (userData.p_score !== undefined && userData.p_score !== null && Number(userData.p_score) > 0) {
                chars = Number(userData.p_score);
            } else if (userData.p !== undefined && userData.p !== null && Number(userData.p) > 0) {
                chars = Number(userData.p);
            } else if (userData.P !== undefined && userData.P !== null && Number(userData.P) > 0) {
                chars = Number(userData.P);
            }
            
            // word (å¹³å‡é•¿åº¦)ï¼šä¸ DB åˆ—åä¸€è‡´ avg_message_lengthï¼Œå›é€€ avg_user_message_length
            let word = undefined;
            const rawAvgLen = userData.avg_message_length ?? userData['avg_user_message_length'];
            if (rawAvgLen !== undefined && rawAvgLen !== null && Number(rawAvgLen) > 0) {
                word = Number(rawAvgLen);
            } else if (userData.avgMessageLength !== undefined && userData.avgMessageLength !== null && Number(userData.avgMessageLength) > 0) {
                word = Number(userData.avgMessageLength);
            } else if (userData.avgUserMessageLength !== undefined && userData.avgUserMessageLength !== null && Number(userData.avgUserMessageLength) > 0) {
                word = Number(userData.avgUserMessageLength);
            }
            // å¦‚æœ word æœªå®šä¹‰æˆ–ä¸º 0ï¼Œä¸” messages > 0 ä¸” chars > 0ï¼Œå¿…é¡»é€šè¿‡å…¬å¼å®æ—¶è®¡ç®—
            if ((word === undefined || word === 0) && messages !== undefined && messages > 0 && chars !== undefined && chars > 0) {
                word = Math.round(chars / messages);
            }
            
            // day (ä¸Šå²—å¤©æ•°)ï¼šäº‘ç«¯ç»å¯¹ä¼˜å…ˆï¼Œä¸¥ç¦æœ¬åœ°è¦†ç›–
            // ã€ä¼˜å…ˆçº§ã€‘1) äº‘ç«¯ usage_days/work_days > 0 â†’ ç›´æ¥é‡‡ç”¨ï¼Œä¸å†è¿›å…¥ localStorage
            // 2) äº‘ç«¯ first_chat_at/earliestFileTime æ¨ç®—
            // 3) ä»…å½“äº‘ç«¯å®Œå…¨æ— æ•°æ®æ—¶ï¼Œæ‰ä½¿ç”¨ localStorage
            let day = undefined;
            let daySource = null;
            
            // ã€æ­¥éª¤1ã€‘äº‘ç«¯ç»å¯¹ä¼˜å…ˆï¼šwork_days / usage_days å­˜åœ¨ä¸” > 0 åˆ™ç›´æ¥é‡‡ç”¨ï¼Œä¸¥ç¦å†è¿› localStorage
            const su = userData.stats && typeof userData.stats === 'object' ? userData.stats : null;
            const cloudWorkDays = userData.work_days ?? (su ? su.work_days : null);
            const cloudUsageDays = su && (su.usageDays ?? su.usage_days ?? su.workDays ?? su.days);
            
            if (cloudWorkDays != null && Number(cloudWorkDays) > 0) {
                day = Number(cloudWorkDays);
                daySource = 'cloud.work_days';
            } else if (cloudUsageDays != null && Number(cloudUsageDays) > 0) {
                day = Number(cloudUsageDays);
                daySource = 'cloud.usage_days';
            } else {
                // ã€æ­¥éª¤2ã€‘äº‘ç«¯æ—  work_days/usage_days æ—¶ï¼Œå°è¯• first_chat_at / earliestFileTime æ¨ç®—
                try {
                    const firstChatAt = userData.first_chat_at || (su ? (su.first_chat_at || su.firstChatAt) : null) || null;
                    if (firstChatAt != null) {
                        const t = Date.parse(String(firstChatAt));
                        if (Number.isFinite(t)) {
                            day = Math.max(1, Math.floor((Date.now() - t) / (1000 * 60 * 60 * 24)));
                            daySource = 'cloud.first_chat_at';
                        }
                    }
                    if ((day == null || !(Number(day) > 0)) && !daySource) {
                        const earliestFileTime = (su ? (su.earliestFileTime ?? su.earliest_file_time) : null) ??
                            userData.earliestFileTime ?? userData.earliest_file_time ?? null;
                        if (earliestFileTime != null) {
                            const earliestTs = Number(earliestFileTime);
                            if (Number.isFinite(earliestTs) && earliestTs > 0) {
                                day = Math.max(1, Math.floor((Date.now() - earliestTs) / (1000 * 60 * 60 * 24)));
                                daySource = 'cloud.earliestFileTime';
                            }
                        }
                    }
                    if ((day == null || !(Number(day) > 0)) && !daySource) {
                        const fallbackFields = ['work_days', 'usage_days', 'days'];
                        for (const field of fallbackFields) {
                            const val = userData[field];
                            if (val != null && Number(val) >= 1) {
                                day = Number(val);
                                daySource = `cloud.${field}`;
                                break;
                            }
                        }
                    }
                } catch (e) { 
                    console.warn('[extractDimensionValues] äº‘ç«¯æ•°æ®è¯»å–å¤±è´¥:', e);
                }
            }
            
            // ã€æ­¥éª¤3ã€‘ä»…å½“äº‘ç«¯å®Œå…¨æ— ä»»ä½•æœ‰æ•ˆæ•°æ®æ—¶ï¼Œæ‰ä½¿ç”¨ localStorageï¼ˆä¸¥ç¦äº‘ç«¯æœ‰å€¼æ—¶è¿›å…¥ï¼‰
            const hasCloudDayValue = (cloudWorkDays != null && Number(cloudWorkDays) > 0) || 
                                    (cloudUsageDays != null && Number(cloudUsageDays) > 0);
            if ((day == null || !(Number(day) > 0)) && !hasCloudDayValue) {
                try {
                    const raw = localStorage.getItem('last_analysis_data');
                    if (raw) {
                        const obj = JSON.parse(raw);
                        const st = obj && obj.stats ? obj.stats : null;
                        const earliest = st ? (st.earliestFileTime ?? st.earliest_file_time) : null;
                        if (earliest != null && Number(earliest) > 0) {
                            day = Math.max(1, Math.floor((Date.now() - Number(earliest)) / (1000 * 60 * 60 * 24)));
                            daySource = 'localStorage.earliestFileTime';
                        } else {
                            const usageDays = st ? (st.usageDays ?? st.usage_days ?? st.work_days ?? null) : null;
                            if (usageDays != null && Number(usageDays) > 0) {
                                day = Number(usageDays);
                                daySource = 'localStorage.usageDays';
                            }
                        }
                    }
                } catch (e) { 
                    console.warn('[extractDimensionValues] æœ¬åœ°æ•°æ®è¯»å–å¤±è´¥:', e);
                }
            }
            
            // è°ƒè¯•æ—¥å¿—ï¼ˆä»…åœ¨éœ€è¦æ—¶å¯ç”¨ï¼‰
            if (day !== undefined && day !== null) {
                console.log('[extractDimensionValues] day calculated:', { day, source: daySource });
            } else {
                console.log('[extractDimensionValues] day not available, all sources exhausted');
            }
            
            // no (ç”²æ–¹ä¸Šèº«)ï¼šæ˜ å°„ jiafang_count
            // å­—æ®µå›é€€ï¼šjiafang_count -> f_score -> f -> F
            let no = undefined;
            if (userData.jiafang_count !== undefined && userData.jiafang_count !== null) {
                no = Number(userData.jiafang_count);
            } else if (userData.f_score !== undefined && userData.f_score !== null) {
                no = Number(userData.f_score);
            } else if (userData.f !== undefined && userData.f !== null) {
                no = Number(userData.f);
            } else if (userData.F !== undefined && userData.F !== null) {
                no = Number(userData.F);
            }
            
            // please (èµ›åšç£•å¤´)ï¼šæ˜ å°„ ketao_count
            // å­—æ®µå›é€€ï¼šketao_count -> e_score -> e -> E
            let please = undefined;
            if (userData.ketao_count !== undefined && userData.ketao_count !== null) {
                please = Number(userData.ketao_count);
            } else if (userData.e_score !== undefined && userData.e_score !== null) {
                please = Number(userData.e_score);
            } else if (userData.e !== undefined && userData.e !== null) {
                please = Number(userData.e);
            } else if (userData.E !== undefined && userData.E !== null) {
                please = Number(userData.E);
            }

            return { 
                ai: messages, 
                word, 
                day, 
                no, 
                say: chars, 
                please 
            };
        }

        /**
         * è®¡ç®—æ¯ä¸ªç»´åº¦ç›¸å¯¹äºå…¶æœ€å¤§å€¼çš„æ¯”ä¾‹ï¼Œæ‰¾å‡ºæœ€é«˜é¡¹
         * @param {Object} values - ç»´åº¦å€¼å¯¹è±¡
         * @returns {string|null} æœ€é«˜é¡¹çš„ç»´åº¦IDï¼Œå¦‚æœæ‰€æœ‰å€¼éƒ½ä¸º0åˆ™è¿”å›null
         */
        function findTopDimension(values) {
            // å®šä¹‰æ¯ä¸ªç»´åº¦çš„æœ€å¤§å€¼ï¼ˆç”¨äºè®¡ç®—ç›¸å¯¹æ¯”ä¾‹ï¼‰
            const maxValues = {
                ai: 10000,      // å¯¹è¯æ¬¡æ•°å¯èƒ½å¾ˆå¤§
                word: 1000,     // å¹³å‡å­—æ•°
                day: 365,       // å¤©æ•°
                no: 100,        // å¦å®šæ¬¡æ•°
                say: 100000,    // æ€»å­—æ•°
                please: 100     // ç¤¼è²Œæ¬¡æ•°
            };

            let topDim = null;
            let maxRatio = -1;

            for (const [dimId, value] of Object.entries(values)) {
                const maxValue = maxValues[dimId] || 100;
                const ratio = value / maxValue;
                if (ratio > maxRatio && value > 0) {
                    maxRatio = ratio;
                    topDim = dimId;
                }
            }

            return topDim;
        }

        /**
         * æ¸²æŸ“ 6 ä¸ªç»´åº¦æ’åå¡ç‰‡
         * @param {Object} currentUserData - ç”¨æˆ·æ•°æ®å¯¹è±¡ï¼ˆä» Supabase è¿”å›ï¼‰ï¼Œå¦‚æœä¸º null åˆ™æ˜¾ç¤ºé»˜è®¤å€¼
         */
        function renderRankCards(currentUserData) {
            const container = document.getElementById('rank-cards-container');
            if (!container) {
                console.warn('[Rank] âš ï¸ rank-cards-container å®¹å™¨ä¸å­˜åœ¨');
                return;
            }

            if (!RANK_RESOURCES) {
                console.warn('[Rank] âš ï¸ RANK_RESOURCES æœªåŠ è½½ï¼Œæ— æ³•æ¸²æŸ“å¡ç‰‡');
                container.innerHTML = '<div class="col-span-full text-center text-zinc-500 py-4 text-sm">ç»´åº¦æ’åæ•°æ®åŠ è½½ä¸­...</div>';
                return;
            }

            // æ•°æ®åˆ¤åˆ«ï¼šå®šä¹‰å˜é‡ const isGlobalTopMode = !currentUserData
            const isGlobalTopMode = !currentUserData;
            
            // ç»´åº¦é…ç½®ï¼ˆåç§°/å•ä½éšè¯­è¨€åˆ‡æ¢ï¼‰
            const dimensionConfig = {
                ai: { name: translateDimensionName('ai'), icon: DIMENSION_NAME_I18N.ai?.icon || 'ğŸ’¬', suffix: translateDimensionSuffix('ai') },
                word: { name: translateDimensionName('word'), icon: DIMENSION_NAME_I18N.word?.icon || 'ğŸ“', suffix: translateDimensionSuffix('word') },
                day: { name: translateDimensionName('day'), icon: DIMENSION_NAME_I18N.day?.icon || 'ğŸ“…', suffix: translateDimensionSuffix('day') },
                no: { name: translateDimensionName('no'), icon: DIMENSION_NAME_I18N.no?.icon || 'ğŸš«', suffix: translateDimensionSuffix('no') },
                say: { name: translateDimensionName('say'), icon: DIMENSION_NAME_I18N.say?.icon || 'ğŸ’­', suffix: translateDimensionSuffix('say') },
                please: { name: translateDimensionName('please'), icon: DIMENSION_NAME_I18N.please?.icon || 'ğŸ™', suffix: translateDimensionSuffix('please') }
            };

            // ç¡®ä¿åŒ…å«æ‰€æœ‰ 6 ä¸ªç»´åº¦
            const allDimensions = ['ai', 'word', 'day', 'no', 'say', 'please'];
            
            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            // éå† 6 ä¸ªç»´åº¦ï¼Œç”Ÿæˆå¡ç‰‡
            allDimensions.forEach((dimId, index) => {
                const config = dimensionConfig[dimId];
                if (!config) {
                    console.warn(`[Rank] âš ï¸ ç»´åº¦ ${dimId} é…ç½®ä¸å­˜åœ¨`);
                    return;
                }

                // ç»´åº¦é€‰æ‹”é€»è¾‘
                let targetData = null;
                let maxValue = 0;
                let targetUserName = '';
                let targetIpLocation = null; // è®°å½•å† å†›ç”¨æˆ·çš„ ip_locationï¼ˆå›½å®¶ä»£ç ï¼‰

                if (isGlobalTopMode) {
                    // ã€å…¨çƒé€‰æ‹”æ¨¡å¼ã€‘ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„ topRecordsï¼ˆå„ç»´åº¦æœ€é«˜è®°å½•ï¼‰
                    const globalDataForTop = window.lastData || {};
                    const topRecords = globalDataForTop.topRecords || {};
                    
                    // ä¼˜å…ˆä½¿ç”¨ topRecords ä¸­çš„æ•°æ®
                    if (topRecords[dimId]) {
                        targetData = topRecords[dimId];
                        const targetValues = extractDimensionValues(targetData);
                        maxValue = targetValues[dimId] !== undefined && targetValues[dimId] !== null ? targetValues[dimId] : undefined;
                        targetUserName = targetData.user_name || targetData.name || targetData.github_username || 'å…¨çƒæœ€å¼º';
                        targetIpLocation = targetData.ip_location || null;
                        console.log(`[Rank] âœ… ä½¿ç”¨ topRecords æ•°æ® (${dimId}):`, maxValue, targetUserName);
                    } else {
                        // é™çº§ï¼šä½¿ç”¨ window.allData æ‰¾å‡ºå„ç»´åº¦çš„æœ€å¤§å€¼ç”¨æˆ·
                        const allData = window.allData || [];
                        if (allData.length > 0) {
                            targetData = allData.reduce((maxUser, currentUser) => {
                                const currentValues = extractDimensionValues(currentUser);
                                const maxValues = extractDimensionValues(maxUser);
                                const currentValue = currentValues[dimId] !== undefined && currentValues[dimId] !== null ? currentValues[dimId] : 0;
                                const maxValue = maxValues[dimId] !== undefined && maxValues[dimId] !== null ? maxValues[dimId] : 0;
                                return currentValue > maxValue ? currentUser : maxUser;
                            }, allData[0]);
                            
                            const targetValues = extractDimensionValues(targetData);
                            maxValue = targetValues[dimId] !== undefined && targetValues[dimId] !== null ? targetValues[dimId] : undefined;
                            targetUserName = targetData.user_name || targetData.name || targetData.github_username || 'æœªçŸ¥ç”¨æˆ·';
                            // èº«ä»½æ ‡è®°ï¼šè®°å½•è¯¥å† å†›ç”¨æˆ·çš„ ip_locationï¼ˆå›½å®¶ä»£ç ï¼Œå¦‚ "US", "CN"ï¼‰
                            targetIpLocation = targetData.ip_location || null;
                        } else {
                            // ã€å…¨å±€æ•°æ®å…œåº•ã€‘å¦‚æœæ²¡æœ‰ allDataï¼Œä½¿ç”¨å…¨å±€ averages æ•°æ®
                            // ä» window.lastData æˆ–å…¨å±€å˜é‡ä¸­è·å– averages
                            const globalDataForAvg = window.lastData || {};
                            const averages = globalDataForAvg.averages || globalDataForAvg.globalAverage || {};
                            const totalUsers = Number(globalDataForAvg.totalUsers) || 1;
                            
                            // ã€ä¿®å¤ç»´åº¦æ˜ å°„ã€‘æ ¹æ®æœ€æ–°çš„ API ç»“æ„é‡æ–°ç»‘å®š
                            // ä¿®æ­£å¡ç‰‡ ID æ˜ å°„ï¼šjiafang å¯¹åº” jiafang_countï¼Œketao å¯¹åº” ketao_count
                            // ä½¿ç”¨å…¨çƒæœ€å¼ºè®°å½•ï¼ˆjiafang_count > 0ï¼‰æˆ–å…¨å±€ averages æ•°æ®
                            let avgValue = undefined;
                            
                            // ä¼˜å…ˆä½¿ç”¨å…¨çƒæœ€å¼ºè®°å½•
                            const championRecord = window.globalChampionRecord;
                            
                            if (dimId === 'ai') {
                                // åˆ†ææ€»é‡ï¼šç»‘å®šåˆ° json.totalAnalysis
                                if (globalDataForAvg.totalAnalysis !== undefined && globalDataForAvg.totalAnalysis !== null) {
                                    avgValue = Number(globalDataForAvg.totalAnalysis);
                                }
                            } else if (dimId === 'word') {
                                // å¹³å‡é•¿åº¦éœ€è¦è®¡ç®—ï¼šå¦‚æœæœ‰ totalChars å’Œ totalMessagesï¼Œè®¡ç®—å¹³å‡å€¼
                                const totalChars = globalDataForAvg.totalChars !== undefined && globalDataForAvg.totalChars !== null ? Number(globalDataForAvg.totalChars) : (globalDataForAvg.totalRoastWords !== undefined && globalDataForAvg.totalRoastWords !== null ? Number(globalDataForAvg.totalRoastWords) : undefined);
                                const totalMessages = globalDataForAvg.totalAnalysis !== undefined && globalDataForAvg.totalAnalysis !== null ? Number(globalDataForAvg.totalAnalysis) : undefined;
                                if (totalChars !== undefined && totalMessages !== undefined && totalMessages > 0) {
                                    avgValue = Math.round(totalChars / totalMessages);
                                } else if (averages.P !== undefined && averages.P !== null) {
                                    avgValue = Number(averages.P);
                                }
                            } else if (dimId === 'day') {
                                // ä¸Šå²—å¤©æ•°ï¼šç»‘å®šåˆ° json.systemDays
                                if (globalDataForAvg.systemDays !== undefined && globalDataForAvg.systemDays !== null) {
                                    avgValue = Number(globalDataForAvg.systemDays);
                                } else if (championRecord && championRecord.work_days !== undefined && championRecord.work_days !== null) {
                                    avgValue = Number(championRecord.work_days);
                                }
                            } else if (dimId === 'no') {
                                // ç”²æ–¹ä¸Šèº«ï¼šæ˜ å°„ jiafang_count
                                if (championRecord && championRecord.jiafang_count !== undefined && championRecord.jiafang_count !== null) {
                                    avgValue = Number(championRecord.jiafang_count);
                                } else if (averages.L !== undefined && averages.L !== null) {
                                    avgValue = Number(averages.L);
                                }
                            } else if (dimId === 'say') {
                                // æ€»å­—æ•°ï¼šä½¿ç”¨ totalChars æˆ– totalRoastWords
                                if (globalDataForAvg.totalChars !== undefined && globalDataForAvg.totalChars !== null) {
                                    avgValue = Number(globalDataForAvg.totalChars);
                                } else if (globalDataForAvg.totalRoastWords !== undefined && globalDataForAvg.totalRoastWords !== null) {
                                    avgValue = Number(globalDataForAvg.totalRoastWords);
                                }
                            } else if (dimId === 'please') {
                                // èµ›åšç£•å¤´ï¼šæ˜ å°„ ketao_count
                                if (championRecord && championRecord.ketao_count !== undefined && championRecord.ketao_count !== null) {
                                    avgValue = Number(championRecord.ketao_count);
                                } else if (averages.P !== undefined && averages.P !== null) {
                                    avgValue = Number(averages.P);
                                }
                            }
                            
                            maxValue = avgValue;
                            // å½“ totalUsers ä¸º 1 æ—¶ï¼Œæ˜¾ç¤º SYSTEM BASE
                            targetUserName = totalUsers <= 1 ? 'SYSTEM BASE' : 'GLOBAL AVG';
                            targetIpLocation = null;
                        }
                    }
                } else {
                    // å¦‚æœ currentUserData å­˜åœ¨ï¼Œåˆ™ targetData å§‹ç»ˆä¸ºå½“å‰ç”¨æˆ·
                    targetData = currentUserData;
                    const values = extractDimensionValues(currentUserData);
                    maxValue = values[dimId] !== undefined && values[dimId] !== null ? values[dimId] : undefined;
                    
                    // ç¡®å®šæ˜¾ç¤ºçš„ç”¨æˆ·åï¼šå¦‚æœæ˜¯çº¯æŒ‡çº¹ç”¨æˆ·ï¼ˆæ—  GitHub IDï¼‰ï¼Œæ˜¾ç¤º"åŒ¿åä¸“å®¶ [æŒ‡çº¹å‰6ä½]"
                    const userFingerprint = currentUserData.fingerprint || currentUserData.user_fingerprint || currentUserData.user_identity;
                    const userGithubId = currentUserData.github_username || currentUserData.github_id;
                    const userName = currentUserData.user_name || currentUserData.name;
                    
                    if (!userGithubId && !userName && userFingerprint) {
                        // çº¯æŒ‡çº¹ç”¨æˆ·ï¼šæ˜¾ç¤º"åŒ¿åä¸“å®¶ [æŒ‡çº¹å‰6ä½]"
                        const fingerprintPrefix = String(userFingerprint).substring(0, 6).toUpperCase();
                        targetUserName = `åŒ¿åä¸“å®¶ ${fingerprintPrefix}`;
                    } else {
                        // æœ‰ GitHub ID æˆ–ç”¨æˆ·åçš„ç”¨æˆ·
                        targetUserName = userName || userGithubId || 'æˆ‘çš„æ•°æ®';
                    }
                    
                    targetIpLocation = currentUserData.ip_location || null;
                }

                // è°ƒç”¨ getRankFeedback(dimId, maxValue) è·å–å¯¹åº”çš„ç­‰çº§ label å’Œåæ§½ content
                // ç¡®ä¿å³ä½¿æ˜¯å…¨çƒæœ€å¼ºï¼Œæ–‡æ¡ˆä¹Ÿæ˜¯ä»è¯¥ç»´åº¦çš„æœ€é«˜ç­‰çº§åŒºé—´ä¸­éšæœºæŠ½å–çš„
                const feedback = getRankFeedback(dimId, maxValue);

                // ã€çŠ¶æ€å…œåº•ã€‘å½“ totalUsers ä¸º 1 æ—¶ï¼Œç¡¬ç¼–ç æ˜¾ç¤º TOP 1 æˆ– SYSTEM BASE
                const globalDataForStatus = window.lastData || {};
                const totalUsers = Number(globalDataForStatus.totalUsers) || 1;
                let statusLabel = isGlobalTopMode ? 'TOP' : 'MINE';
                let feedbackLabel = feedback ? translateRankFeedbackLabel(dimId, feedback.label, maxValue) : 'RANKED';
                
                // å¦‚æœ totalUsers ä¸º 1ï¼Œæ’åç»Ÿä¸€æ˜¾ç¤ºä¸º TOP 1
                if (totalUsers <= 1) {
                    statusLabel = 'TOP 1';
                    if (isGlobalTopMode) {
                        feedbackLabel = 'SYSTEM BASE';
                    }
                }

                // æ‰¾å‡ºæœ€é«˜é¡¹ï¼ˆç”¨äºä¸ªäººæ¨¡å¼ä¸‹çš„ TOP æ ‡è¯†ï¼‰
                let isTop = false;
                if (!isGlobalTopMode && targetData) {
                    const values = extractDimensionValues(targetData);
                    const topDim = findTopDimension(values);
                    isTop = topDim === dimId;
                }

                // æ•°å€¼å¤„ç†ï¼šsay (æ€»å­—æ•°) ä½¿ç”¨ Intl.NumberFormat('zh-CN').format() è¿›è¡Œåƒåˆ†ä½æ ¼å¼åŒ–
                // å•ä½è¡¥å…¨ï¼šæ ¹æ® RANK_RESOURCES è‡ªåŠ¨è¡¥å…¨å•ä½ï¼ˆæ¬¡ã€å­—ã€å¤©ç­‰ï¼‰
                // å½»åº•åˆ é™¤ç¡¬ç¼–ç ï¼Œå¦‚æœæ¥å£æœ‰å€¼åˆ™å¿…é¡»æ˜¾ç¤ºæ¥å£çš„å€¼
                let displayVal;
                let unit = config.suffix || '';
                if (maxValue !== undefined && maxValue !== null) {
                    const nfCard = new Intl.NumberFormat(currentLang === 'en' ? 'en-US' : 'zh-CN');
                    if (dimId === 'say') {
                        displayVal = nfCard.format(maxValue);
                    } else {
                        displayVal = nfCard.format(maxValue);
                    }
                } else {
                    displayVal = 'N/A';
                }

                // è·å–èµ„æºä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºç»´åº¦åç§°ï¼‰
                const resource = RANK_RESOURCES && RANK_RESOURCES[dimId] ? RANK_RESOURCES[dimId] : null;
                
                // åˆ›å»ºå¡ç‰‡å…ƒç´ 
                // èµ›åšé£æ ¼ï¼šèƒŒæ™¯ bg-[#050505]/60 é…åˆ backdrop-blur-xl
                // æ‚¬æµ®æ—¶ä¸Šç§» hover:-translate-y-2ï¼Œè¾¹æ¡†ç”±æš—ç»¿å˜ä¸ºäº®ç»¿ï¼Œå¹¶å‡ºç°èµ›åšè½¬è§’æ‰«æçº¿
                const card = document.createElement('div');
                card.className = `cursor-pointer flex-1 min-w-0 bg-[#0a0a0a]/80 backdrop-blur border border-white/10 p-3 rounded-sm transition-all duration-300 hover:-translate-y-2 hover:border-[#00ff41] hover:shadow-[0_0_20px_rgba(0,255,65,0.4)] relative group pointer-events-auto overflow-visible`;
                
                // å­˜å‚¨ç»´åº¦IDå’Œå›½å®¶ä»£ç ï¼Œç”¨äºåœ°å›¾è”åŠ¨
                card.setAttribute('data-dim-id', dimId);
                if (targetIpLocation) {
                    card.setAttribute('data-ip-location', targetIpLocation);
                }
                // å­˜å‚¨å† å†›ä¿¡æ¯ï¼Œç”¨äºåœ°å›¾å¼¹çª—å±•ç¤º
                card.setAttribute('data-champion-name', targetUserName);
                card.setAttribute('data-champion-value', maxValue);
                card.setAttribute('data-champion-feedback', feedback ? JSON.stringify(feedback) : '');
                
                // å¡ç‰‡å†…å®¹ï¼šèµ›åšé£æ ¼æ¨¡æ¿
                // æ•°å­—ï¼šæ‰€æœ‰å¡ç‰‡æ•°å€¼æ–‡å­—é¢œè‰²ç»Ÿä¸€æ”¹ä¸ºçº¯ç™½è‰² (text-white)ï¼Œå¢åŠ  drop-shadow
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xl filter drop-shadow-[0_0_5px_rgba(0,255,65,0.5)]">${config.icon}</span>
                        <span class="text-[8px] leading-none text-[#00ff41] border border-[#00ff41]/40 px-1 py-0.5 tracking-widest uppercase bg-[#00ff41]/5 z-10 relative">
                            ${statusLabel}
                        </span>
                    </div>

                    <div class="text-[9px] text-[#00ff41]/50 uppercase tracking-widest mb-1 truncate">
                        ${config.name}
                    </div>

                    <div class="text-2xl font-bold text-white font-mono truncate leading-none drop-shadow-[0_0_8px_rgba(255,255,255,0.3)]">
                        ${displayVal}<span class="text-[10px] ml-1 font-normal opacity-70">${unit}</span>
                    </div>

                    <div class="mt-2 pt-2 border-t border-[#00ff41]/10 flex flex-col gap-0.5">
                        <div class="text-[10px] text-white font-bold truncate">
                            ${feedbackLabel}
                        </div>
                        <div class="text-[8px] text-[#00ff41]/60 truncate italic">
                            @${targetUserName || 'ANONYMOUS'}
                        </div>
                    </div>

                    <!-- èµ›åšè½¬è§’æ‰«æçº¿ -->
                    <div class="absolute -top-[1px] -left-[1px] w-2 h-2 border-t border-l border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                    <div class="absolute -bottom-[1px] -right-[1px] w-2 h-2 border-b border-r border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                    <div class="absolute -top-[1px] -right-[1px] w-2 h-2 border-t border-r border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                    <div class="absolute -bottom-[1px] -left-[1px] w-2 h-2 border-b border-l border-[#00ff41] scale-0 group-hover:scale-100 transition-transform opacity-0 group-hover:opacity-100"></div>
                `;

                // åœ°å›¾è”åŠ¨äº¤äº’ï¼šä¸ºæ¯ä¸ªå¡ç‰‡ç»‘å®šç‚¹å‡»ç›‘å¬å™¨
                card.addEventListener('click', () => {
                    const ipLocation = card.getAttribute('data-ip-location');
                    if (ipLocation && mapChart && !(typeof mapChart.isDisposed === 'function' && mapChart.isDisposed())) {
                        // å°†å›½å®¶ä»£ç è½¬æ¢ä¸ºåœ°å›¾ä¸Šçš„å›½å®¶åç§°
                        let countryName = null;
                        if (countryNameMap && countryNameMap[ipLocation]) {
                            // ä½¿ç”¨è‹±æ–‡åç§°ï¼ˆåœ°å›¾ä½¿ç”¨è‹±æ–‡åç§°ï¼‰
                            countryName = countryNameMap[ipLocation].en;
                        } else {
                            // å¦‚æœæ²¡æœ‰æ˜ å°„ï¼Œå°è¯•ç›´æ¥ä½¿ç”¨ ip_locationï¼ˆå¯èƒ½æ˜¯å®Œæ•´çš„å›½å®¶åç§°ï¼‰
                            countryName = ipLocation;
                        }
                        
                        if (countryName) {
                            // è·å–å† å†›ä¿¡æ¯ï¼Œå­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­ï¼Œç”¨äºåœ°å›¾å¼¹çª—å±•ç¤º
                            const championName = card.getAttribute('data-champion-name');
                            const championValue = card.getAttribute('data-champion-value');
                            const championFeedback = card.getAttribute('data-champion-feedback');
                            const dimId = card.getAttribute('data-dim-id');
                            
                            // å­˜å‚¨å½“å‰é€‰ä¸­çš„å† å†›ä¿¡æ¯
                            currentChampionInfo = {
                                countryName: countryName,
                                championName: championName,
                                championValue: championValue,
                                feedback: championFeedback,
                                dimId: dimId
                            };
                            
                            // ä½¿ç”¨ ECharts å®ä¾‹æ–¹æ³•é«˜äº®æ˜¾ç¤ºåœ°å›¾ä¸Šå¯¹åº”çš„å›½å®¶
                            try {
                                // æ–¹æ³•1ï¼šä½¿ç”¨ dispatchAction è§¦å‘ highlight åŠ¨ä½œ
                                mapChart.dispatchAction({
                                    type: 'highlight',
                                    name: countryName
                                });
                                
                                // æ–¹æ³•2ï¼šä½¿ç”¨ showTip æ˜¾ç¤º tooltipï¼ˆä¼šè§¦å‘ formatterï¼Œæ˜¾ç¤ºå† å†›ä¿¡æ¯ï¼‰
                                mapChart.dispatchAction({
                                    type: 'showTip',
                                    name: countryName
                                });
                                
                                console.log(`[Rank] âœ… ç‚¹å‡»å¡ç‰‡ï¼Œé«˜äº®å›½å®¶: ${countryName} (${ipLocation})`);
                                console.log(`[Rank] ğŸ“Š å† å†›ä¿¡æ¯: ${championName}, æ•°å€¼: ${championValue}, ç»´åº¦: ${dimId}`);
                            } catch (error) {
                                console.error('[Rank] âŒ é«˜äº®å›½å®¶å¤±è´¥:', error);
                            }
                        } else {
                            console.warn(`[Rank] âš ï¸ æ— æ³•æ‰¾åˆ°å›½å®¶åç§°ï¼Œip_location: ${ipLocation}`);
                        }
                    } else if (!ipLocation) {
                        console.warn(`[Rank] âš ï¸ è¯¥ç»´åº¦å† å†›æ²¡æœ‰ ip_location ä¿¡æ¯`);
                    } else {
                        console.warn(`[Rank] âš ï¸ åœ°å›¾å®ä¾‹æœªåˆå§‹åŒ–æˆ–å·²é”€æ¯`);
                    }
                });

                container.appendChild(card);
            });

            console.log(`[Rank] âœ… ç»´åº¦æ’åå¡ç‰‡æ¸²æŸ“å®Œæˆ (æ¨¡å¼: ${isGlobalTopMode ? 'å…¨çƒæœ€å¼º' : 'ä¸ªäººæ•°æ®'})`);
            
            // å¦‚æœæ£€æµ‹åˆ°ç”¨æˆ·æ•°æ®ä¸”å·¦ä¾§æŠ½å±‰å·²æ‰“å¼€ï¼Œè‡ªåŠ¨åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡
            if (currentUserData && !isGlobalTopMode) {
                try {
                    const leftDrawer = document.getElementById('left-drawer');
                    const leftBody = document.getElementById('left-drawer-body');
                    
                    // æ£€æŸ¥å·¦ä¾§æŠ½å±‰æ˜¯å¦æ‰“å¼€ï¼ˆé€šè¿‡æ£€æŸ¥ active classï¼‰
                    if (leftDrawer && leftBody) {
                        const isDrawerOpen = leftDrawer.classList.contains('active');
                        
                        if (isDrawerOpen) {
                            // é‡æ–°æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ï¼ˆä¼˜å…ˆä½¿ç”¨ allData ä¸­çš„å®Œæ•´è®°å½•ï¼‰
                            renderUserStatsCards(leftBody, getBestUserRecordForStats(currentUserData));
                            console.log('[Rank] âœ… å·²è‡ªåŠ¨åˆ·æ–°å·¦ä¾§æŠ½å±‰çš„ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡');
                        }
                    }
                } catch (e) {
                    console.warn('[Rank] âš ï¸ åˆ·æ–°å·¦ä¾§æŠ½å±‰ç»Ÿè®¡å¡ç‰‡å¤±è´¥:', e);
                }
            }
        }

        /**
         * æ€§èƒ½ç›‘æ§é¢æ¿ï¼ˆæŠ€æœ¯ç”¨æˆ·/Developer Toolsï¼‰
         * æŒ‰ F12 â†’ Console è¾“å…¥: window.showPerfPanel()
         */
        window.PERF_MONITOR = {
            data: {
                apiCalls: [],
                resources: [],
                timing: {}
            },
            
            recordApiCall(name, duration, success) {
                this.data.apiCalls.push({ name, duration, success, time: new Date().toLocaleTimeString() });
            },
            
            recordResource(name, duration) {
                this.data.resources.push({ name, duration });
            },
            
            measureTiming(label) {
                this.data.timing[label] = performance.now();
                console.log(`[Perf] â±ï¸ ${label}: ${Math.round(this.data.timing[label])}ms`);
            },
            
            showPanel() {
                const totalApiTime = this.data.apiCalls.reduce((sum, c) => sum + c.duration, 0);
                const failedCalls = this.data.apiCalls.filter(c => !c.success).length;
                
                console.group('ğŸ“Š Performance Monitor');
                console.log('API Calls:', this.data.apiCalls.length, `(${failedCalls} failed)`);
                console.table(this.data.apiCalls);
                console.log('Resources:', this.data.resources.length);
                console.table(this.data.resources);
                console.log('Total API Time:', Math.round(totalApiTime), 'ms');
                console.groupEnd();
                
                // åœ¨é¡µé¢å³ä¸‹è§’æ˜¾ç¤ºå°é¢æ¿
                if (!document.getElementById('perf-panel')) {
                    const panel = document.createElement('div');
                    panel.id = 'perf-panel';
                    panel.className = 'fixed bottom-4 right-4 bg-black/90 text-[var(--accent-terminal)] p-3 rounded font-mono text-xs z-50 border border-[var(--accent-terminal)]/50';
                    panel.innerHTML = `
                        <div class="font-bold mb-1">âš¡ PERF_MONITOR</div>
                        <div>API: ${this.data.apiCalls.length} calls (${failedCalls} fail)</div>
                        <div>Time: ${Math.round(totalApiTime)}ms</div>
                        <div>Proxy: ${navigator.userAgent.includes('Chrome') ? 'detecting...' : 'N/A'}</div>
                        <button onclick="document.getElementById('perf-panel').remove()" class="mt-2 text-zinc-500 hover:text-white">âœ•</button>
                    `;
                    document.body.appendChild(panel);
                }
            }
        };
        
        window.showPerfPanel = () => window.PERF_MONITOR.showPanel();
        
        // è‡ªåŠ¨å¼€å§‹æ€§èƒ½ç›‘æ§
        window.PERF_MONITOR.measureTiming('page_start');


        window.onload = function() {
            // Highcharts ä¸­æ–‡åŒ…ï¼šé¡µé¢åˆå§‹åŒ–æœ€å‰ç«¯æ³¨å…¥ï¼Œæ¶ˆé™¤ Locale è­¦å‘Š
            try {
                if (typeof Highcharts !== 'undefined' && Highcharts.setOptions) {
                    Highcharts.setOptions({
                        lang: {
                            months: ['ä¸€æœˆ','äºŒæœˆ','ä¸‰æœˆ','å››æœˆ','äº”æœˆ','å…­æœˆ','ä¸ƒæœˆ','å…«æœˆ','ä¹æœˆ','åæœˆ','åä¸€æœˆ','åäºŒæœˆ'],
                            shortMonths: ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'],
                            weekdays: ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'],
                            shortWeekdays: ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'],
                            loading: 'åŠ è½½ä¸­...',
                            noData: 'æš‚æ— æ•°æ®',
                            resetZoom: 'é‡ç½®ç¼©æ”¾',
                            resetZoomTitle: 'é‡ç½®ä¸º 1:1',
                            thousandsSep: ',',
                            decimalPoint: '.',
                            exportButtonTitle: 'å¯¼å‡º',
                            printButtonTitle: 'æ‰“å°',
                            rangeSelectorFrom: 'ä»',
                            rangeSelectorTo: 'åˆ°',
                            rangeSelectorZoom: 'èŒƒå›´',
                            downloadPNG: 'ä¸‹è½½ PNG',
                            downloadJPEG: 'ä¸‹è½½ JPEG',
                            downloadPDF: 'ä¸‹è½½ PDF',
                            downloadSVG: 'ä¸‹è½½ SVG',
                            printChart: 'æ‰“å°å›¾è¡¨'
                        }
                    });
                }
            } catch (e) { /* ignore */ }

            // Tailwind é™çº§ï¼šå»¶è¿Ÿ 100ms å†æ‰§è¡Œä¸»æµç¨‹ï¼Œç¡®ä¿ CDN/æ‰«æç¨³å®šï¼Œé™ä½åˆå§‹åŒ– CPU å‹åŠ›
            setTimeout(function() {
            (async function() {
            try {
            loadGitHubUsername();
            try { await loadLanguageConfig(); } catch { /* ignore */ }
            try { updateLanguageContext(); } catch { /* ignore */ }

            // åˆå§‹åŒ–åœ°å›¾å…‰æ ‡å·¥å…·ï¼ˆå›½å®¶é€‰æ‹©ä¸‹æ‹‰èœå•ï¼‰
            initMapCursorTools();
            
            // ã€ä¿®å¤ã€‘é¡µé¢åŠ è½½åç«‹å³å°è¯•æ˜¾ç¤ºå…‰æ ‡
            setTimeout(() => {
                try {
                    if (typeof ensureCurrentLocationCursorIfMissing === 'function') {
                        ensureCurrentLocationCursorIfMissing('window.onload-init');
                    }
                } catch (e) {
                    console.warn('[Window.onload] âš ï¸ åˆå§‹åŒ–å…‰æ ‡å¤±è´¥:', e);
                }
            }, 500);
            
            // åˆå§‹åŒ–çŠ¶æ€æŒ‰é’®ï¼šä»…åœ¨ Presence on('SUBSCRIBED') å›è°ƒä¸­æ‰§è¡Œï¼Œä¸åœ¨é¡µé¢åŠ è½½æ—¶ç«‹å³æ‰§è¡Œï¼ˆé¿å…è®¢é˜…æœªå°±ç»ªæ—¶æŠ¥é”™ï¼‰
            
            // åˆå§‹åŒ–æŠ½å±‰çŠ¶æ€
            initDrawerState();
            
            // ç­‰å¾…æ ¸å¿ƒèµ„æºåŠ è½½å®Œæˆï¼ˆæœ€å¤šç­‰å¾…3ç§’ï¼‰
            console.log('[Window.onload] â³ ç­‰å¾…èµ„æºåŠ è½½...');
            let resourceWaitTime = 0;
            while (!window._resourcesLoaded && resourceWaitTime < 3000) {
                await new Promise(r => setTimeout(r, 100));
                resourceWaitTime += 100;
            }
            if (window._resourcesLoaded) {
                console.log('[Window.onload] âœ… èµ„æºåŠ è½½å®Œæˆ');
            } else {
                console.warn('[Window.onload] âš ï¸ èµ„æºåŠ è½½è¶…æ—¶ï¼Œç»§ç»­åˆå§‹åŒ–');
            }
            
            // åŠ è½½ç»´åº¦æ’åæ•°æ®èµ„æº
            await loadRankResources();
            
            // å…ˆæ‰§è¡Œåˆå§‹æ•°æ®åŠ è½½ï¼ˆå¢å¼ºé”™è¯¯å¤„ç†ï¼‰
            let apiFailed = false;
            try {
                await fetchData();
            } catch (fetchError) {
                apiFailed = true;
                console.error('[Window.onload] âŒ fetchData å¤±è´¥:', fetchError);
                // å³ä½¿æ•°æ®åŠ è½½å¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œåç»­åˆå§‹åŒ–
            }
            
            // æ£€æµ‹ API çŠ¶æ€å¹¶æç¤ºç”¨æˆ·
            if (apiFailed || !window.lastData) {
                showApiStatusWarning();
            }
            
            // ç€‘å¸ƒå¼åˆå§‹åŒ–ï¼šåŸºç¡€æ•°æ®åŠ è½½å®Œæˆåï¼Œå”¯ä¸€ä¸€æ¬¡ä¸»åŠ¨è°ƒç”¨ switchView('country', savedCC)
            window.__allowInitCall = true;
            try {
                var savedCC = (localStorage.getItem('user_country_fixed') || localStorage.getItem('user_selected_country') || '').trim().toUpperCase();
                if (savedCC && /^[A-Z]{2}$/.test(savedCC)) {
                    switchView('country', savedCC);
                } else {
                    switchView('global');
                }
            } catch (e) { console.warn('[onload] switchView åˆå§‹åŒ–å¤±è´¥:', e); }
            window.__allowInitCall = false;
            isInitialLayoutPending = false;
            
            // ============================================
            // ã€æ–°å¢ã€‘åˆå§‹åŒ– GitHub OAuth è®¤è¯ç›‘å¬
            // ============================================
            if (supabaseClient) {
                // æ£€æŸ¥å½“å‰ä¼šè¯
                try {
                    let { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                    // ã€GitHub å›è°ƒä¿®å¤ã€‘è‹¥ URL çš„ Hash å·²è¢« IIFE å†™å…¥ localStorageï¼Œç”¨ setSession æ¢å¤ä¼šè¯ï¼Œä½¿ç™»å½•ç”Ÿæ•ˆ
                    if (!session && !sessionError) {
                        try {
                            const savedAccess = localStorage.getItem('vibe_github_access_token');
                            const savedRefresh = localStorage.getItem('vibe_github_refresh_token');
                            if (savedAccess && savedRefresh) {
                                const { data: setData, error: setErr } = await supabaseClient.auth.setSession({
                                    access_token: savedAccess,
                                    refresh_token: savedRefresh
                                });
                                if (!setErr && setData && setData.session) {
                                    session = setData.session;
                                    console.log('[Auth] âœ… å·²ä» localStorage æ¢å¤ GitHub ä¼šè¯ï¼ˆHash å›è°ƒï¼‰');
                                } else if (setErr) {
                                    console.warn('[Auth] setSession å¤±è´¥:', setErr.message);
                                }
                            }
                        } catch (e) {
                            console.warn('[Auth] æ¢å¤ä¼šè¯å¤±è´¥:', e);
                        }
                    }
                    if (sessionError) {
                        console.warn('[Auth] âš ï¸ è·å–ä¼šè¯å¤±è´¥:', sessionError);
                    } else if (session) {
                        console.log('[Auth] âœ… æ£€æµ‹åˆ°ç°æœ‰ä¼šè¯ï¼Œè‡ªåŠ¨å¤„ç†è®¤è¯çŠ¶æ€');
                        await handleAuthStateChange(session);
                    } else {
                        console.log('[Auth] â„¹ï¸ æœªæ£€æµ‹åˆ°ä¼šè¯ï¼Œæ˜¾ç¤ºç™»å½•æŒ‰é’®');
                        updateAuthUI(null);
                    }
                } catch (error) {
                    console.error('[Auth] âŒ åˆå§‹åŒ–è®¤è¯ç›‘å¬å¤±è´¥:', error);
                }
                
                // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('[Auth] ğŸ”” è®¤è¯çŠ¶æ€å˜åŒ–äº‹ä»¶:', event, session ? 'æœ‰ä¼šè¯' : 'æ— ä¼šè¯');
                    
                    if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                        await handleAuthStateChange(session);
                        
                        // ã€Task 3ã€‘å½“ event === 'SIGNED_IN' æ—¶ï¼Œæ˜¾å¼è°ƒç”¨ä¸€æ¬¡ window.refreshUserStats() å’Œ fetchAllData()
                        if (event === 'SIGNED_IN') {
                            console.log('[Auth] ğŸ”„ ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œè§¦å‘æ•°æ®åˆ·æ–°...');
                            try {
                                // å…ˆåˆ·æ–°å…¨å±€æ•°æ®
                                if (typeof fetchData === 'function') {
                                    await fetchData();
                                    console.log('[Auth] âœ… fetchData æ‰§è¡Œå®Œæˆ');
                                }
                                
                                // å†åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡æ•°æ®
                                if (typeof window.refreshUserStats === 'function') {
                                    try {
                                        await window.refreshUserStats();
                                        console.log('[Auth] âœ… refreshUserStats æ‰§è¡Œå®Œæˆ');
                                    } catch (refreshError) {
                                        // ã€ä¿®å¤ AbortErrorã€‘ç‰¹æ®Šå¤„ç† AbortError
                                        if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                            console.log('[Auth] â„¹ï¸ refreshUserStats è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰');
                                        } else {
                                            console.error('[Auth] âŒ refreshUserStats æ‰§è¡Œå¤±è´¥:', refreshError);
                                        }
                                    }
                                }
                            } catch (refreshError) {
                                // ã€ä¿®å¤ AbortErrorã€‘ç‰¹æ®Šå¤„ç† AbortError
                                if (refreshError.name === 'AbortError' || refreshError.message?.includes('aborted')) {
                                    console.log('[Auth] â„¹ï¸ æ•°æ®åˆ·æ–°è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰');
                                } else {
                                    console.error('[Auth] âŒ æ•°æ®åˆ·æ–°å¤±è´¥:', refreshError);
                                }
                            }
                        }
                    } else if (event === 'SIGNED_OUT') {
                        await handleAuthStateChange(null);
                    }
                });
                
                console.log('[Auth] âœ… è®¤è¯çŠ¶æ€ç›‘å¬å·²å¯åŠ¨');
            } else {
                console.warn('[Auth] âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œæ— æ³•å¯åŠ¨è®¤è¯ç›‘å¬');
                // å»¶è¿Ÿé‡è¯•
                setTimeout(async () => {
                    if (supabaseClient) {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        if (session) {
                            await handleAuthStateChange(session);
                        } else {
                            updateAuthUI(null);
                        }
                    }
                }, 1000);
            }
            
            // é¡µé¢åŠ è½½åç«‹å³æ˜¾ç¤º LPDEF åˆ†å€¼ï¼šæ‰§è¡Œèº«ä»½æ£€æŸ¥ï¼ˆå¢å¼ºèº«ä»½è¯†åˆ«é€»è¾‘ï¼‰
            try {
                // è¾…åŠ©å‡½æ•°ï¼šè§„èŒƒåŒ–æŒ‡çº¹å­—ç¬¦ä¸²ï¼ˆå¿½ç•¥å¤§å°å†™å¹¶å‰”é™¤é¦–å°¾ç©ºæ ¼ï¼‰
                const normalizeFingerprint = (fp) => {
                    if (!fp) return '';
                    return String(fp).trim().toLowerCase();
                };
                
                // 1. ç”Ÿæˆæˆ–è·å–å½“å‰è®¾å¤‡çš„ Fingerprintï¼ˆå¢åŠ å¼‚å¸¸å¤„ç†ï¼‰
                // ã€ä¼˜åŒ–ã€‘ä½¿ç”¨ç»Ÿä¸€çš„æŒ‡çº¹è·å–å‡½æ•°ï¼Œç¡®ä¿ä¸€è‡´æ€§
                let currentFingerprint = await getCurrentFingerprint();
                
                if (!currentFingerprint) {
                    console.warn('[LPDEF] âš ï¸ æ— æ³•è·å–æˆ–ç”ŸæˆæŒ‡çº¹');
                } else {
                    console.log('[LPDEF] ğŸ”‘ å½“å‰è®¾å¤‡ Fingerprint:', currentFingerprint.substring(0, 8) + '...');
                }
                
                // è§„èŒƒåŒ–å½“å‰æŒ‡çº¹
                const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                
                // 2. ä» localStorage è·å– github_usernameï¼ˆå¢åŠ å¼‚å¸¸å¤„ç†ï¼‰
                let localGitHubName = null;
                try {
                    localGitHubName = localStorage.getItem('github_username');
                } catch (e) {
                    console.warn('[LPDEF] âš ï¸ è¯»å– localStorage github_username å¤±è´¥:', e);
                }
                
                // 3. ã€ä¼˜åŒ–ã€‘ä¼˜å…ˆä»å·²åŠ è½½çš„ allData æ•°ç»„ä¸­æŸ¥æ‰¾åŒ¹é…é¡¹ï¼ˆé¿å…é¢å¤–çš„ API è°ƒç”¨ï¼‰
                const allData = window.allData || [];
                console.log('[LPDEF] ğŸ“Š allData æ•°æ®é‡:', allData.length);
                
                let currentUser = null;
                let matchedByFingerprint = false;
                
                // ã€ä¼˜å…ˆçº§1ã€‘é¦–å…ˆä» allData ä¸­æŸ¥æ‰¾ fingerprint åŒ¹é…çš„è®°å½•
                if (normalizedCurrentFingerprint && allData.length > 0) {
                    console.log('[LPDEF] ğŸ” å¼€å§‹ä» allData ä¸­æŸ¥æ‰¾æŒ‡çº¹åŒ¹é…...');
                    
                    currentUser = allData.find(user => {
                        const userFingerprint = normalizeFingerprint(user.fingerprint || user.user_fingerprint);
                        const userIdentity = normalizeFingerprint(user.user_identity);
                        
                        const matchFingerprint = userFingerprint && userFingerprint === normalizedCurrentFingerprint;
                        const matchIdentity = userIdentity && userIdentity === normalizedCurrentFingerprint;
                        
                        if (matchFingerprint || matchIdentity) {
                            console.log('[LPDEF] âœ… åœ¨ allData ä¸­æ‰¾åˆ°æŒ‡çº¹åŒ¹é…:', {
                                id: user.id,
                                user_name: user.user_name || user.name,
                                fingerprint: user.fingerprint ? user.fingerprint.substring(0, 8) + '...' : null
                            });
                            matchedByFingerprint = true;
                            return true;
                        }
                        return false;
                    });
                    
                    if (currentUser) {
                        console.log('[LPDEF] âœ… é€šè¿‡æœ¬åœ° allData åŒ¹é…åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                    } else {
                        console.log('[LPDEF] â„¹ï¸ åœ¨ allData ä¸­æœªæ‰¾åˆ°æŒ‡çº¹åŒ¹é…');
                    }
                }
                
                // ã€ä¼˜å…ˆçº§2ã€‘å¦‚æœ allData ä¸­æœªæ‰¾åˆ°ï¼Œä¸” Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–ï¼Œå°è¯•ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
                if (!currentUser && normalizedCurrentFingerprint && supabaseClient) {
                    try {
                        console.log('[LPDEF] ğŸ” allData ä¸­æœªæ‰¾åˆ°ï¼Œå°è¯•ä» Supabase ç›´æ¥æŸ¥è¯¢ï¼ˆä½¿ç”¨ç»Ÿä¸€è§†å›¾ï¼‰...');
                        
                        // ã€Task 2ã€‘ä½¿ç”¨ç»Ÿä¸€è§†å›¾ v_unified_analysis_v2
                        const { data: dbUser, error: queryError } = await supabaseClient
                            .from('v_user_analysis_extended')
                            .select('*')
                            .eq('fingerprint', currentFingerprint)
                            .maybeSingle();
                        
                        if (queryError && queryError.code !== 'PGRST116') {
                            console.warn('[LPDEF] âš ï¸ Supabase æŸ¥è¯¢å¤±è´¥:', queryError);
                        } else if (dbUser) {
                            console.log('[LPDEF] âœ… ä» Supabase æŸ¥è¯¢åˆ°ç”¨æˆ·:', dbUser.user_name || dbUser.name);
                            
                            // å°†æŸ¥è¯¢åˆ°çš„ç”¨æˆ·æ·»åŠ åˆ° allData
                            const existingIndex = allData.findIndex(item => item.id === dbUser.id);
                            if (existingIndex !== -1) {
                                allData[existingIndex] = { ...allData[existingIndex], ...dbUser };
                            } else {
                                allData.push(dbUser);
                            }
                            window.allData = allData;
                            
                            currentUser = dbUser;
                            matchedByFingerprint = true;
                        } else {
                            console.log('[LPDEF] â„¹ï¸ Supabase ä¸­æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·');
                        }
                    } catch (error) {
                        console.warn('[LPDEF] âš ï¸ Supabase æŸ¥è¯¢å‡ºé”™:', error);
                    }
                }
                
                // 4. URL å‚æ•°æ”¯æŒï¼šå¦‚æœ URL ä¸­å¸¦äº† id å‚æ•°ï¼Œå¼ºåˆ¶ä½¿ç”¨è¯¥ ID è¿›è¡ŒåŒ¹é…ï¼ˆç”¨äºæµ‹è¯•ï¼‰
                const urlParams = new URLSearchParams(window.location.search);
                const urlId = urlParams.get('id');
                if (urlId) {
                    console.log('[Rank] ğŸ” æ£€æµ‹åˆ° URL å‚æ•° id:', urlId, 'ï¼Œå°†å¼ºåˆ¶ä½¿ç”¨è¯¥ ID è¿›è¡ŒåŒ¹é…');
                    const urlMatchedUser = allData.find(user => {
                        const userId = (user.id || '').toString();
                        const userFingerprint = (user.fingerprint || user.user_identity || '').toString();
                        return userId === urlId || userFingerprint === urlId;
                    });
                    if (urlMatchedUser) {
                        currentUser = urlMatchedUser;
                        console.log('[Rank] âœ… é€šè¿‡ URL å‚æ•° id æ‰¾åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                    }
                }
                
                // 5. å¦‚æœæŒ‡çº¹æœªåŒ¹é…ï¼Œå†é€€è€Œæ±‚å…¶æ¬¡å¯»æ‰¾ github_username
                if (!currentUser && localGitHubName && isValidGitHubUsername(localGitHubName)) {
                    const normalizedLocalGitHub = normalizeFingerprint(localGitHubName);
                    currentUser = allData.find(user => {
                        const userGithubId = normalizeFingerprint(user.github_username || user.github_id || '');
                        return userGithubId && userGithubId === normalizedLocalGitHub;
                    });
                    
                    if (currentUser) {
                        console.log('[Rank] âœ… é€šè¿‡ GitHub ID æ‰¾åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                    }
                }
                
                // 6. å…œåº•åŒ¹é… - å¦‚æœ fingerprint ä¸ºç©ºï¼Œå°è¯•é€šè¿‡ id æˆ– user_name åŒ¹é…
                if (!currentUser && !normalizedCurrentFingerprint) {
                    try {
                        const savedUserId = localStorage.getItem('user_id');
                        if (savedUserId) {
                            currentUser = allData.find(user => {
                                return user.id && user.id.toString() === savedUserId.toString();
                            });
                        }
                        
                        if (!currentUser) {
                            const savedUserName = localStorage.getItem('user_name');
                            if (savedUserName) {
                                currentUser = allData.find(user => {
                                    return user.user_name && user.user_name.toString() === savedUserName.toString();
                                });
                            }
                        }
                    } catch (e) {
                        console.warn('[Rank] âš ï¸ å…œåº•åŒ¹é…æ—¶è¯»å– localStorage å¤±è´¥:', e);
                    }
                }
                
                // ä¿å­˜åŒ¹é…æ–¹å¼åˆ°å…¨å±€å˜é‡ï¼Œä¾› renderRankCards ä½¿ç”¨
                if (currentUser) {
                    window.currentUser = currentUser;
                    window.currentUserMatchedByFingerprint = matchedByFingerprint;
                }
                
                // 4. è‡ªåŠ¨è¡¥é½é€»è¾‘ï¼šå¦‚æœåœ¨åº“é‡Œæ‰¾åˆ°äº†å½“å‰è®¾å¤‡çš„ Fingerprintï¼Œä½†è¯¥è®°å½•çš„ user_name æ˜¯ "Guest" ä¸” github_id ä¸ºç©º
                if (currentUser && currentFingerprint) {
                    const userGithubId = currentUser.github_username || currentUser.github_id || null;
                    const userName = currentUser.user_name || currentUser.name || '';
                    const isGuestUser = userName.includes('Guest') || userName === 'åŒ¿åå—å®³è€…' || !userGithubId;
                    
                    // å¦‚æœç”¨æˆ·å·²ç»åœ¨ stats2.html è®¾ç½®äº† GitHub ç”¨æˆ·åï¼Œç«‹å³å‘èµ· PATCH è¯·æ±‚ç»‘å®š
                    if (isGuestUser && localGitHubName && isValidGitHubUsername(localGitHubName) && !userGithubId) {
                        console.log('[LPDEF] ğŸ”— æ£€æµ‹åˆ° Guest ç”¨æˆ·ï¼Œå°è¯•ç»‘å®š GitHub ID:', localGitHubName);
                        
                        // å‘èµ· PATCH è¯·æ±‚ï¼Œæ›´æ–°æ•°æ®åº“è®°å½•
                        if (supabaseClient) {
                            try {
                                // ã€å…³é”®ä¿®å¤ã€‘ç™»å½•åå¿…é¡»ä½¿ç”¨ user_id è¿›è¡Œæ›´æ–°ï¼Œè€Œä¸æ˜¯ fingerprint
                                let updateField = 'id';
                                let updateValue = currentUser.id;
                                
                                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                                try {
                                    const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                                    if (!sessionError && session && session.user) {
                                        const authenticatedUserId = session.user.id;
                                        // å¦‚æœå·²ç™»å½•ï¼Œä¼˜å…ˆä½¿ç”¨ç™»å½•çš„ user_id
                                        if (authenticatedUserId && currentUser.id === authenticatedUserId) {
                                            updateField = 'id';
                                            updateValue = authenticatedUserId;
                                            console.log('[LPDEF] âœ… å·²ç™»å½•ï¼Œä½¿ç”¨ user_id è¿›è¡Œæ›´æ–°ï¼ˆè®¤ç¥–å½’å®—ï¼‰');
                                        }
                                    }
                                } catch (authError) {
                                    console.warn('[LPDEF] âš ï¸ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', authError);
                                }
                                
                                // å¦‚æœæœªç™»å½•æˆ– user_id ä¸åŒ¹é…ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ
                                if (!updateValue || updateField !== 'id') {
                                    updateField = currentUser.fingerprint ? 'fingerprint' : (currentUser.user_identity ? 'user_identity' : 'id');
                                    updateValue = currentUser.fingerprint || currentUser.user_identity || currentUser.id;
                                    console.log('[LPDEF] âš ï¸ æœªç™»å½•ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ:', updateField);
                                }
                                
                                if (updateField && updateValue) {
                                    // ã€ä¿®å¤ 400 é”™è¯¯ã€‘ç§»é™¤ä¸å­˜åœ¨çš„ github_username å­—æ®µï¼Œåªæ›´æ–° user_name
                                    const { data, error } = await supabaseClient
                                        .from('user_analysis')
                                        .update({
                                            user_name: localGitHubName, // æ›´æ–°ç”¨æˆ·åï¼ˆGitHub ç”¨æˆ·åå­˜å‚¨åœ¨ user_name å­—æ®µä¸­ï¼‰
                                            user_identity: updateField === 'id' ? 'github' : currentUser.user_identity, // å¦‚æœä½¿ç”¨ idï¼Œè®¾ç½®ä¸º github
                                            updated_at: new Date().toISOString()
                                        })
                                        .eq(updateField, updateValue)
                                        .select();
                                    
                                    if (error) {
                                        console.error('[LPDEF] âŒ ç»‘å®š GitHub ID å¤±è´¥:', error);
                                    } else if (data && data.length > 0) {
                                        console.log('[LPDEF] âœ… GitHub ID ç»‘å®šæˆåŠŸ:', data[0]);
                                        // æ›´æ–° currentUser å¯¹è±¡
                                        currentUser.github_username = localGitHubName;
                                        currentUser.user_name = localGitHubName;
                                        // æ›´æ–° window.allData ä¸­çš„å¯¹åº”è®°å½•
                                        const index = allData.findIndex(u => 
                                            (u.fingerprint || u.user_identity || u.id) === updateValue
                                        );
                                        if (index !== -1) {
                                            allData[index] = { ...allData[index], ...currentUser };
                                            window.allData = allData;
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error('[LPDEF] âŒ ç»‘å®š GitHub ID è¿‡ç¨‹å‡ºé”™:', error);
                            }
                        }
                    }
                }
                
                // 7. ä¿å­˜åŒ¹é…ç»“æœåˆ°å…¨å±€å˜é‡
                if (currentUser) {
                    window.currentUser = currentUser;
                    window.currentUserMatchedByFingerprint = matchedByFingerprint;
                    console.log('[Rank] âœ… ç”¨æˆ·åŒ¹é…æˆåŠŸï¼Œå·²è®¾ç½®å…¨å±€å˜é‡');
                }
                
                // 8. ç»Ÿä¸€è°ƒç”¨ renderRankCards æ¸²æŸ“ 6 ç»´åº¦æ’åå¡ç‰‡
                // èº«ä»½è¯†åˆ«å…œåº•ï¼šå¦‚æœæœ€ç»ˆ currentUser ä¾ç„¶ä¸º nullï¼Œæ˜¾å¼è°ƒç”¨ renderRankCards(null)
                // è¿™å°†è§¦å‘"å…¨çƒé€‰æ‹”"é€»è¾‘ï¼Œæ˜¾ç¤ºæ¯ä¸ªç»´åº¦çš„å…¨çƒæœ€å¼ºç”¨æˆ·
                if (currentUser) {
                    console.log('[Rank] âœ… æ‰¾åˆ°å½“å‰ç”¨æˆ·æ•°æ®ï¼Œæ¸²æŸ“æ’åå¡ç‰‡:', currentUser.user_name || currentUser.name);
                    renderRankCards(currentUser);
                    
                    // ã€ä¼˜åŒ–ã€‘å¦‚æœæ‰¾åˆ°åŒ¹é…ç”¨æˆ·ï¼Œç«‹å³æ£€æŸ¥å¹¶åŠ è½½æŠ½å±‰ï¼ˆå–æ¶ˆ WAIT çŠ¶æ€ï¼‰
                    setTimeout(() => {
                        const leftDrawer = document.getElementById('left-drawer');
                        const leftBody = document.getElementById('left-drawer-body');
                        
                        if (leftDrawer && leftBody) {
                            // æ£€æŸ¥æ˜¯å¦æœ‰ç­‰å¾…å¡ç‰‡
                            const waitingCards = leftBody.querySelectorAll('.drawer-item');
                            waitingCards.forEach(card => {
                                const label = card.querySelector('.drawer-item-label');
                                if (label && label.textContent === 'æ•°æ®åŠ è½½ä¸­') {
                                    console.log('[Rank] âœ… æ‰¾åˆ°åŒ¹é…ç”¨æˆ·ï¼Œç§»é™¤ç­‰å¾…å¡ç‰‡å¹¶åŠ è½½ç»Ÿè®¡å¡ç‰‡');
                                    card.remove();
                                    
                                    // ç«‹å³æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡å¡ç‰‡ï¼ˆä¼˜å…ˆä½¿ç”¨ allData ä¸­çš„å®Œæ•´è®°å½•ï¼‰
                                    renderUserStatsCards(leftBody, getBestUserRecordForStats(currentUser));
                                }
                            });
                        }
                    }, 100); // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿ DOM å·²æ›´æ–°
                } else {
                    console.log('[Rank] âš ï¸ æœªæ‰¾åˆ°å½“å‰ç”¨æˆ·æ•°æ®ï¼Œè§¦å‘å…¨çƒæœ€å¼ºæ¨¡å¼ï¼ˆå…¨çƒé€‰æ‹”ï¼‰');
                    // æ˜¾å¼è°ƒç”¨ renderRankCards(null) è§¦å‘å…¨çƒé€‰æ‹”é€»è¾‘
                    renderRankCards(null);
                }
            } catch (error) {
                console.error('[Rank] âŒ èº«ä»½æ£€æŸ¥å¤±è´¥:', error);
                // å‡ºé”™æ—¶ä¹Ÿæ˜¾å¼è°ƒç”¨ renderRankCards(null)ï¼Œè§¦å‘å…¨çƒæœ€å¼ºæ¨¡å¼ï¼ˆå…¨çƒé€‰æ‹”ï¼‰
                renderRankCards(null);
            }
            
             // åˆå§‹åŠ è½½å®Œæˆåï¼Œå¯åŠ¨ Realtime ç›‘å¬
             // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿æ‰€æœ‰æ¸²æŸ“å·²å®Œæˆ
             setTimeout(() => {
                 startRealtimeListener();
             }, 500);

             // ã€å¢å¼ºã€‘å¼ºåˆ¶æ¢å¤æ‰‹åŠ¨æ ¡å‡†çš„å…‰æ ‡ä½ç½®ï¼ˆè§£å†³é¡µé¢åˆ·æ–°åå…‰æ ‡æ¼‚ç§»é—®é¢˜ï¼‰
             // ä½¿ç”¨ setTimeout ç¡®ä¿åœ¨æ‰€æœ‰å¼‚æ­¥æ“ä½œä¹‹åæ‰§è¡Œ
             setTimeout(() => {
                 forceRestoreLockedCursor();
             }, 800);

             // ã€å¢å¼ºã€‘å†æ¬¡å¼ºåˆ¶æ¢å¤ï¼Œç¡®ä¿ä¸ä¼šè¢«åç»­æ“ä½œè¦†ç›–
             setTimeout(() => {
                 forceRestoreLockedCursor();
             }, 1500);
            } finally {
                isGlobalInitializing = false;
                window.__allowInitCall = false;
            }
            })();
            }, 100);
         };

        // ==========================================
        // Semantic Burst Sentence Board (Personal + National)
        // ==========================================
        let nationalSentenceChart = null;
        let nationalSentenceAbort = null;

        function _getApiEndpoint() {
            const apiEndpoint = (document.querySelector('meta[name="api-endpoint"]')?.content || '').trim();
            return apiEndpoint.endsWith('/') ? apiEndpoint : `${apiEndpoint}/`;
        }

        function _isSemanticBurstDebugEnabled() {
            try {
                const qs = new URLSearchParams(window.location.search || '');
                const q = (qs.get('debugSemanticBurst') || qs.get('sb_debug') || '').trim();
                if (q === '1' || q.toLowerCase() === 'true') return true;
            } catch { /* ignore */ }
            try {
                return localStorage.getItem('debug_semantic_burst') === '1';
            } catch { /* ignore */ }
            return false;
        }

        function _setSemanticBurstDebugEnabled(enabled) {
            try { localStorage.setItem('debug_semantic_burst', enabled ? '1' : '0'); } catch { /* ignore */ }
            try {
                const panel = document.getElementById('sb-debug-panel');
                if (panel) panel.classList.toggle('hidden', !enabled);
            } catch { /* ignore */ }
        }

        function _formatMonthlyVibesDebug(mv, region, url) {
            const slang = Array.isArray(mv?.slang) ? mv.slang : [];
            const merit = Array.isArray(mv?.merit) ? mv.merit : [];
            const sv = Array.isArray(mv?.sv_slang) ? mv.sv_slang : [];
            const top = (arr) => (arr || []).slice(0, 5).map((x) => `${String(x?.phrase || '').trim()} (${Number(x?.hit_count) || 0})`).filter(Boolean);
            return [
                `region=${region || '??'}`,
                `url=${url || ''}`,
                `slang=${slang.length}, merit=${merit.length}, sv_slang=${sv.length}`,
                `top_slang=${top(slang).join(', ') || '-'}`,
                `top_merit=${top(merit).join(', ') || '-'}`,
                `top_sv=${top(sv).join(', ') || '-'}`,
                `ts=${new Date().toISOString()}`,
            ].join('\n');
        }

        function _renderLoader(container, label = 'LOADING') {
            if (!container) return;
            container.innerHTML = `
                <div class="vibe-cloud-loader">
                    <div class="dot" aria-hidden="true"></div>
                    <div class="dot" aria-hidden="true"></div>
                    <div class="dot" aria-hidden="true"></div>
                    <div class="label">${label}</div>
                </div>
            `;
        }

        function _showEmpty(containerEl, emptyEl, show) {
            try {
                if (containerEl) containerEl.style.display = show ? 'none' : '';
                if (emptyEl) emptyEl.classList.toggle('hidden', !show);
            } catch (e) { /* ignore */ }
        }

        function _escapeHtml(s) {
            return String(s ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function _disposeChart(chartRef) {
            try { chartRef && typeof chartRef.dispose === 'function' && chartRef.dispose(); } catch (e) { /* ignore */ }
        }

        function _fingerprintMaskNoise(input) {
            let t = String(input || '');
            if (!t) return '';
            // remove fenced code / inline code
            t = t.replace(/```[\s\S]*?```/g, ' ');
            t = t.replace(/`[^`]*`/g, ' ');
            // remove HTML
            t = t.replace(/<script[\s\S]*?<\/script>/gi, ' ');
            t = t.replace(/<style[\s\S]*?<\/style>/gi, ' ');
            t = t.replace(/<[^>]+>/g, ' ');
            // remove URLs
            t = t.replace(/\bhttps?:\/\/[^\s]+/gi, ' ');
            return t.replace(/\s+/g, ' ').trim();
        }

        function _splitSentencesForBoard(text) {
            const cleaned = _fingerprintMaskNoise(text);
            if (!cleaned) return [];
            return cleaned
                .split(/[ã€‚\.ï¼!ï¼Ÿ\?\n\rï¼›;ï¼Œ,]+/g)
                .map(s => String(s || '').trim())
                .filter(s => s.length >= 3);
        }

        function _hasZh(s) { return /[\u4e00-\u9fff]/.test(String(s || '')); }

        function _extractChineseNgrams(sentence, minN = 3, maxN = 10) {
            const out = [];
            const runs = String(sentence || '').match(/[\u4e00-\u9fff]{3,}/g) || [];
            for (const run of runs) {
                const s = String(run);
                const len = s.length;
                for (let n = minN; n <= maxN; n++) {
                    if (len < n) continue;
                    for (let i = 0; i <= len - n; i++) out.push(s.slice(i, i + n));
                }
            }
            return out;
        }

        function _extractEnglishWordNgrams(sentence, minN = 3, maxN = 7) {
            const out = [];
            const words = (String(sentence || '').match(/[A-Za-z]+(?:'[A-Za-z]+)?/g) || [])
                .map(w => w.toLowerCase())
                .filter(Boolean);
            if (words.length < minN) return out;
            for (let n = minN; n <= maxN; n++) {
                if (words.length < n) continue;
                for (let i = 0; i <= words.length - n; i++) out.push(words.slice(i, i + n).join(' '));
            }
            return out;
        }

        function _normForCompare(s) { return String(s || '').trim().replace(/\s+/g, '').toLowerCase(); }

        function _levenshteinWithin(a, b, maxDistance = 1) {
            const s = String(a || '');
            const t = String(b || '');
            if (s === t) return true;
            const n = s.length, m = t.length;
            if (Math.abs(n - m) > maxDistance) return false;
            if (n === 0) return m <= maxDistance;
            if (m === 0) return n <= maxDistance;
            let prev = new Array(m + 1);
            let curr = new Array(m + 1);
            for (let j = 0; j <= m; j++) prev[j] = j;
            for (let i = 1; i <= n; i++) {
                curr[0] = i;
                let rowMin = curr[0];
                const si = s.charCodeAt(i - 1);
                for (let j = 1; j <= m; j++) {
                    const cost = si === t.charCodeAt(j - 1) ? 0 : 1;
                    const del = prev[j] + 1;
                    const ins = curr[j - 1] + 1;
                    const sub = prev[j - 1] + cost;
                    const v = Math.min(del, ins, sub);
                    curr[j] = v;
                    if (v < rowMin) rowMin = v;
                }
                if (rowMin > maxDistance) return false;
                const tmp = prev; prev = curr; curr = tmp;
            }
            return prev[m] <= maxDistance;
        }

        function _extractPersonalSentences(text, topK = 20) {
            const sentences = _splitSentencesForBoard(text);
            if (sentences.length === 0) return [];

            const freq = new Map();
            const bump = (k) => {
                const s = String(k || '').trim();
                if (!s) return;
                freq.set(s, (freq.get(s) || 0) + 1);
            };

            for (const s of sentences) {
                bump(s);
                _extractChineseNgrams(s, 3, 10).forEach(bump);
                _extractEnglishWordNgrams(s, 3, 7).forEach(bump);
            }

            const entries = Array.from(freq.entries())
                .sort((a, b) => (b[1] - a[1]) || (a[0] > b[0] ? 1 : -1))
                .slice(0, 200);

            const clusters = []; // { canonical, norm, count }
            const buckets = new Map();
            const addBucket = (idx) => {
                const c = clusters[idx];
                const prefix = _hasZh(c.canonical) ? c.norm.slice(0, 2) : c.norm.slice(0, 6);
                const key = `${c.norm.length}:${prefix}`;
                if (!buckets.has(key)) buckets.set(key, []);
                buckets.get(key).push(idx);
            };

            for (const [cand, cnt] of entries) {
                const norm = _normForCompare(cand);
                if (!norm) continue;
                const prefix = _hasZh(cand) ? norm.slice(0, 2) : norm.slice(0, 6);
                const key = `${norm.length}:${prefix}`;
                const nearKeys = [key, `${norm.length - 1}:${prefix}`, `${norm.length + 1}:${prefix}`];
                let merged = -1;
                for (const k of nearKeys) {
                    const list = buckets.get(k);
                    if (!list) continue;
                    for (const idx of list) {
                        if (_levenshteinWithin(norm, clusters[idx].norm, 1)) { merged = idx; break; }
                    }
                    if (merged !== -1) break;
                }
                if (merged === -1) {
                    clusters.push({ canonical: cand, norm, count: cnt });
                    addBucket(clusters.length - 1);
                } else {
                    clusters[merged].count += cnt;
                    if (String(cand).length < String(clusters[merged].canonical).length) {
                        clusters[merged].canonical = cand;
                        clusters[merged].norm = norm;
                    }
                }
            }

            let result = clusters
                .sort((a, b) => (b.count - a.count) || (a.canonical > b.canonical ? 1 : -1))
                .map((c) => ({ name: c.canonical, value: c.count, category: 'personal' }));
            
            // åº”ç”¨å¯è¯»æ€§è¿‡æ»¤å™¨ï¼Œå»é™¤ä¸è§„åˆ™çš„å­—æ¯ç»„åˆ
            const beforeFilter = result.length;
            result = filterReadableWords(result);
            if (beforeFilter !== result.length) {
                console.log(`[WordCloud] Personal å¯è¯»æ€§è¿‡æ»¤: ${beforeFilter} â†’ ${result.length} æ¡`);
            }
            
            return result.slice(0, Math.max(10, Math.min(30, Number(topK) || 20)));
        }

        function _buildWordCloudOption({ words, maxFont, tooltipFormatter, textStyle, emphasisTextStyle, onClick }) {
            return {
                backgroundColor: 'transparent',
                tooltip: {
                    show: true,
                    backgroundColor: 'rgba(9,10,15,0.92)',
                    borderColor: 'rgba(148,163,184,0.22)',
                    borderWidth: 1,
                    padding: [8, 10],
                    textStyle: { color: '#e5e7eb', fontFamily: 'JetBrains Mono, monospace' },
                    formatter: tooltipFormatter,
                },
                series: [{
                    type: 'wordCloud',
                    shape: 'circle',
                    left: 'center',
                    top: 'center',
                    width: '100%',
                    height: '100%',
                    // å¥å¼è¾ƒé•¿ï¼šæé«˜ gridSizeï¼Œé™ä½é‡å 
                    gridSize: 9,
                    sizeRange: [12, maxFont],
                    // é•¿å¥ä¿æŒæ°´å¹³ï¼Œæå‡å¯è¯»æ€§
                    rotationRange: [0, 0],
                    rotationStep: 0,
                    drawOutOfBound: false,
                    textStyle: {
                        fontFamily: 'JetBrains Mono, monospace',
                        ...(textStyle || {}),
                    },
                    emphasis: {
                        focus: 'self',
                        textStyle: { ...(emphasisTextStyle || {}) },
                    },
                    onclick: onClick,
                    data: words,
                }],
            };
        }

        // ========== è¯äº‘å¯è¯»æ€§è¿‡æ»¤å™¨ ==========
        // ç”¨äºè¿‡æ»¤æ‰ä¸è§„åˆ™çš„å­—æ¯ç»„åˆï¼Œåªä¿ç•™æœ‰æ„ä¹‰çš„è¯æ±‡
        function filterReadableWords(words) {
            if (!Array.isArray(words)) return [];
            
            return words.filter((w) => {
                const name = String(w?.name || '').trim();
                if (!name) return false;
                
                // ä¿ç•™ä¸­æ–‡è¯æ±‡ï¼ˆä¸­æ–‡ä¸éœ€è¦è¿‡æ»¤ï¼‰
                if (/[\u4e00-\u9fa5]/.test(name)) {
                    return name.length >= 2; // ä¸­æ–‡è‡³å°‘2ä¸ªå­—
                }
                
                // å¯¹äºçº¯è‹±æ–‡ï¼Œè¿›è¡Œå¯è¯»æ€§æ£€æŸ¥
                const englishText = name.replace(/[^a-zA-Z]/g, '');
                if (englishText.length === 0) return false;
                
                // è§„åˆ™1: é•¿åº¦æ£€æŸ¥ - å¤ªçŸ­çš„è¯é€šå¸¸ä¸å¯è¯»
                if (englishText.length < 3) return false;
                if (englishText.length > 20) return false; // å¤ªé•¿çš„å¯èƒ½æ˜¯æ— æ„ä¹‰ç»„åˆ
                
                // è§„åˆ™2: æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ„ä¹‰çš„å•è¯ï¼ˆå…ƒéŸ³æ¯”ä¾‹æ£€æŸ¥ï¼‰
                // è‹±æ–‡ä¸­å…ƒéŸ³(vowels)ä¸è¾…éŸ³(consonants)çš„æ¯”ä¾‹åº”è¯¥åˆç†
                const vowels = 'aeiouAEIOU';
                const vowelCount = [...englishText].filter(c => vowels.includes(c)).length;
                const vowelRatio = vowelCount / englishText.length;
                
                // å…ƒéŸ³æ¯”ä¾‹åº”è¯¥åœ¨ 15% - 60% ä¹‹é—´
                if (vowelRatio < 0.15 || vowelRatio > 0.7) return false;
                
                // è§„åˆ™3: æ£€æŸ¥è¿ç»­é‡å¤å­—ç¬¦ï¼ˆå¦‚ aaa, bbbbï¼‰
                const repeatedCharPattern = /(.)Ğ‘\1Ğ‘\1/;
                if (repeatedCharPattern.test(englishText)) return false;
                
                // è§„åˆ™4: æ£€æŸ¥è¾…éŸ³è¿ç»­å‡ºç°çš„æƒ…å†µ
                // å¦‚æœè¿ç»­4ä¸ªä»¥ä¸Šè¾…éŸ³ï¼Œå¯èƒ½æ˜¯æ— æ„ä¹‰ç»„åˆ
                const consonantClusters = englishText.match(/[^aeiouAEIOU]{4,}/g);
                if (consonantClusters && consonantClusters.some(c => c.length >= 4)) return false;
                
                // è§„åˆ™5: æ£€æŸ¥å¸¸è§æ— æ„ä¹‰æ¨¡å¼
                // å¦‚: xå¼€å¤´çš„å­—ç¬¦ä¸²é€šå¸¸æ˜¯å˜é‡åï¼Œä¸æ˜¯è¯æ±‡
                if (/^x[jklmpq][a-z]{0,4}$/i.test(englishText)) return false;
                
                // è§„åˆ™6: æ£€æŸ¥æ˜¯å¦æ˜¯å¸¸è§çš„ç¼–ç¨‹å˜é‡åæ¨¡å¼
                // å¦‚: tmp, buf, ptr, idx, cnt ç­‰
                const commonVarPatterns = /^(tmp|buf|ptr|idx|cnt|val|var|obj|arr|str|num|flg|flg|err|ret|arg|param|config|cfg|init|dest|src|pos|len)$/i;
                if (commonVarPatterns.test(englishText)) return false;
                
                // è§„åˆ™7: æ£€æŸ¥æ˜¯å¦å«æœ‰å¯è¯»çš„è‹±æ–‡å•è¯æ¨¡å¼
                // è‡³å°‘éœ€è¦æœ‰ä¸€ä¸ªå…ƒéŸ³å’Œä¸€ä¸ªè¾…éŸ³ç›¸é—´
                const hasReadablePattern = /[aeiouAEIOU][bcdfghjklmnpqrstvwxyzBCDFGHJKLMNPQRSTVWXYZ]|[bcdfghjklmnpqrstvwxyzBCDFGHJKLMNPQRSTVWXYZ][aeiouAEIOU]/.test(englishText);
                if (!hasReadablePattern) return false;
                
                return true;
            });
        }

        // è§†è§‰æƒé‡ï¼ˆå¯¹æ•°ç¼©æ”¾ï¼‰ï¼šfontSize = 12 + (log(hit+1)/log(maxHit+1)) * 16
        function applyLogFontSize(words, getHit) {
            const list = Array.isArray(words) ? words : [];
            return list.map((w) => {
                const hit = Math.max(0, Number(getHit(w)) || 0);
                // å¯¹æ•°ç¼©æ”¾ï¼ˆæŒ‰éœ€æ±‚ï¼‰ï¼šfontSize = 12 + log10(hit_count + 1) * 8
                const fontSize = 12 + (Math.log10(hit + 1) * 8);
                return {
                    ...w,
                    // per-item å¼ºåˆ¶å­—å·ï¼ˆé•¿å¥æ›´å¯æ§ï¼›åŒæ—¶ä¿ç•™ series.sizeRange ä½œä¸ºå…œåº•ï¼‰
                    textStyle: {
                        ...(w.textStyle || {}),
                        fontSize: Number.isFinite(fontSize) ? Math.max(12, Math.min(36, Math.round(fontSize))) : 12,
                    },
                };
            });
        }

        // ==========================================
        // Vibe Hotlist Card (Top10 + Cloud50)
        // ==========================================
        let vibeCloudChart = null;
        let vibeCloudAbort = null;

        function _setVibeRefreshing(on) {
            try {
                const root = document.getElementById('vibe-burst-root') || document.getElementById('vibe-explosion-card');
                if (root) root.classList.toggle('vibe-refreshing', !!on);
            } catch { /* ignore */ }
        }

        function _renderTop10List(list, isLexicon) {
            const ol = document.getElementById('vibe-top10-list');
            const empty = document.getElementById('vibe-top10-empty');
            const meta = document.getElementById('vibe-country-top10-meta');
            if (!ol) return;

            // å…¼å®¹å¤šç§æ•°æ®æºï¼šlexicon { w, v } / é»‘è¯æ¦œ { phrase, hit_count } / å¼€å‘è€…æ¦œ { user_name, total_messages }
            let items = (Array.isArray(list) ? list : [])
                .map((x) => {
                    var phrase = String(x?.phrase ?? x?.w ?? x?.user_name ?? '').trim();
                    var hit = Number(x?.hit_count ?? x?.hitCount ?? x?.v ?? x?.total_messages ?? 0) || 0;
                    return { phrase: phrase, hit: hit };
                })
                .filter((x) => x.phrase && x.hit > 0);
            
            // åº”ç”¨å¯è¯»æ€§è¿‡æ»¤å™¨
            items = filterReadableWords(items.map(x => ({ name: x.phrase, value: x.hit })))
                .map(x => ({ phrase: x.name, hit: x.value }));
            
            items = items.slice(0, 10);

            if (items.length === 0) {
                ol.innerHTML = '';
                if (empty) {
                    empty.textContent = isLexicon ? 'æ­£åœ¨æ”¶é›†æ•°æ®...' : 'æš‚æ— æ•°æ®ï¼ˆæ­£åœ¨æ”¶å½•ä¸­...ï¼‰';
                    empty.classList.remove('hidden');
                }
                if (meta) meta.textContent = '--';
                return;
            }
            if (empty) empty.classList.add('hidden');
            if (meta) meta.textContent = `N=${items.length}`;

            ol.innerHTML = items.map((it, idx) => {
                const rank = idx + 1;
                const name = _escapeHtml(it.phrase);
                const count = it.hit;
                const countColor = count >= 30 ? '#00ff41' : count >= 10 ? 'rgba(0,255,65,0.7)' : '#9ca3af';
                return `
                    <li class="flex items-center gap-3 p-2 border-b border-white/5 hover:bg-white/5 transition-colors">
                        <div class="flex-shrink-0 w-6 h-6 rounded-full bg-gradient-to-br from-[var(--accent-terminal)]/20 to-[var(--accent-terminal)]/10 flex items-center justify-center text-[10px] font-bold text-white/70">
                            ${rank}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-[12px] text-zinc-200 font-mono truncate" title="${isLexicon ? 'è¯æ±‡' : ''}">${name}</div>
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-1">
                            <span class="text-[10px] text-zinc-500">${isLexicon ? 'é¢‘æ¬¡' : 'Ã—'}</span>
                            <span class="text-[12px] font-bold tabular-nums" style="color: ${countColor}">${count}</span>
                        </div>
                    </li>
                `;
            }).join('');
        }

        (function bindLexiconTabs() {
            var tabsEl = document.getElementById('vibe-lexicon-tabs');
            if (!tabsEl) return;
            if (tabsEl.dataset.bound) return;
            tabsEl.dataset.bound = '1';
            window.__currentLexiconType = window.__currentLexiconType || 'merit_board';
            tabsEl.addEventListener('click', function(e) {
                var btn = e.target && e.target.closest && e.target.closest('.vibe-lexicon-tab');
                if (!btn || !btn.dataset.type) return;
                var type = btn.dataset.type;
                window.__currentLexiconType = type;
                var all = tabsEl.querySelectorAll('.vibe-lexicon-tab');
                all.forEach(function(b) {
                    b.classList.remove('bg-[var(--accent-terminal)]/20', 'text-[var(--accent-terminal)]', 'font-medium', 'border-white/20');
                    b.classList.add('bg-transparent', 'text-zinc-400', 'border-white/10');
                });
                btn.classList.add('bg-[var(--accent-terminal)]/20', 'text-[var(--accent-terminal)]', 'font-medium', 'border-white/20');
                btn.classList.remove('bg-transparent', 'text-zinc-400', 'border-white/10');
                var country = (typeof window.__currentCountryCode === 'string' && window.__currentCountryCode) ? window.__currentCountryCode : '';
                if (!country) return;
                var base = (typeof window.getApiEndpoint === 'function' ? window.getApiEndpoint() : (document.querySelector('meta[name="api-endpoint"]') && document.querySelector('meta[name="api-endpoint"]').content)) || '';
                base = (base && base.trim()) ? (base.trim().endsWith('/') ? base.trim() : base.trim() + '/') : '';
                var url = base + 'api/national-lexicon?country=' + encodeURIComponent(country) + '&type=' + encodeURIComponent(type);
                fetch(url).then(function(r) { return r.json(); }).then(function(res) {
                    var list = (res && res.data && Array.isArray(res.data)) ? res.data : [];
                    if (typeof _renderTop10List === 'function') _renderTop10List(list, true);
                }).catch(function() {
                    if (typeof _renderTop10List === 'function') _renderTop10List([], true);
                });
            });
        })();

        function _renderCloud50(region, list) {
            const container = document.getElementById('vibe-cloud50-container');
            const empty = document.getElementById('vibe-cloud50-empty');
            const meta = document.getElementById('vibe-cloud50-meta');
            if (!container) return;
            if (typeof echarts === 'undefined') {
                if (meta) meta.textContent = 'ECharts missing';
                if (empty) {
                    empty.textContent = 'ECharts æœªåŠ è½½ï¼Œæ— æ³•æ¸²æŸ“è¯äº‘ã€‚';
                    empty.classList.remove('hidden');
                }
                return;
            }
            // ä»…æ¥å— { phrase, hit_count }ï¼ˆæ¥è‡ª get_country_keywords çš„ tag/weightï¼‰ï¼Œç¦æ­¢ä¼ å…¥ detailedStats æˆ–æ€§æ ¼ label
            let raw = (Array.isArray(list) ? list : [])
                .map((x) => ({ name: String(x?.phrase || '').trim(), value: Number(x?.hit_count ?? x?.hitCount ?? 0) || 0 }))
                .filter((x) => x.name && x.value > 0);
            
            // åº”ç”¨å¯è¯»æ€§è¿‡æ»¤å™¨ï¼Œå»é™¤ä¸è§„åˆ™çš„å­—æ¯ç»„åˆ
            const beforeFilter = raw.length;
            raw = filterReadableWords(raw);
            const afterFilter = raw.length;
            if (beforeFilter !== afterFilter) {
                console.log(`[WordCloud] Cloud50 å¯è¯»æ€§è¿‡æ»¤: ${beforeFilter} â†’ ${afterFilter} æ¡`);
            }
            
            raw = raw.slice(0, 50);

            if (raw.length === 0) {
                try { container.innerHTML = ''; } catch { /* ignore */ }
                try { _disposeChart(vibeCloudChart); } catch { /* ignore */ }
                vibeCloudChart = null;
                if (meta) meta.textContent = '--';
                if (empty) empty.classList.remove('hidden');
                return;
            }

            if (empty) empty.classList.add('hidden');
            if (meta) meta.textContent = `N=${raw.length}`;

            let words = applyLogFontSize(raw, (w) => w?.value ?? 0);
            try { container.innerHTML = ''; } catch { /* ignore */ }
            _disposeChart(vibeCloudChart);
            // ä¸æŒ‡å®šä¸»é¢˜ï¼šé¿å… theme æœªæ³¨å†Œå¯¼è‡´æ¸²æŸ“å¤±è´¥
            vibeCloudChart = echarts.init(container, null, { renderer: 'canvas' });

            const maxVal = Math.max(...words.map((w) => Number(w.value) || 0), 1);
            const getColor = (value) => {
                const intensity = Math.min(1, (Number(value) || 0) / (maxVal || 1));
                const a = 0.65 + intensity * 0.35;
                return {
                    color: `rgba(0, 255, 65, ${a})`,
                    glow: `rgba(0, 255, 65, ${0.35 + intensity * 0.35})`,
                };
            };

            // å…³é”®ä¿®å¤ï¼šç»™æ¯ä¸ªè¯æ¡å†™æ­»é¢œè‰²/é˜´å½±ï¼ˆä¸è¦ä¾èµ– callbackï¼‰
            words = (Array.isArray(words) ? words : []).map((w) => {
                const v = Number(w?.value) || 0;
                const { color, glow } = getColor(v);
                return {
                    ...w,
                    textStyle: {
                        ...(w.textStyle || {}),
                        color,
                        shadowBlur: 14,
                        shadowColor: glow,
                    },
                };
            });

            try {
                vibeCloudChart.setOption(_buildWordCloudOption({
                    words,
                    maxFont: 34,
                    tooltipFormatter: (p) => `${p.name}<br/>çƒ­åº¦: <b>${p.value}</b><br/>å›½å®¶: ${_escapeHtml(region || '--')}`,
                    // per-item å·²å†™æ­»é¢œè‰²/é˜´å½±ï¼Œè¿™é‡Œåªä¿ç•™å­—ä½“
                    textStyle: {
                        fontFamily: 'JetBrains Mono, monospace',
                    },
                    emphasisTextStyle: { shadowBlur: 22 },
                    onClick: (p) => { try { handleWordCloudClick && handleWordCloudClick(p?.data?.name, 'slang'); } catch {} },
                }), true);
            } catch (e) {
                try { _disposeChart(vibeCloudChart); } catch { /* ignore */ }
                vibeCloudChart = null;
                // å›é€€ï¼šç”¨â€œæ–‡å­—äº‘åˆ—è¡¨â€ä¿è¯è‡³å°‘å¯è§
                try {
                    const top = (Array.isArray(words) ? words : []).slice(0, 50);
                    container.innerHTML = `
                        <div class="max-h-[260px] overflow-y-auto">
                            ${top.map((w, i) => {
                                const name = _escapeHtml(String(w?.name || ''));
                                const value = Number(w?.value) || 0;
                                return `<div class="flex justify-between gap-3 border-b border-white/10 py-1">
                                    <span class="text-zinc-200 font-mono truncate">${i + 1}. ${name}</span>
                                    <span class="text-zinc-400 tabular-nums">Ã—${value}</span>
                                </div>`;
                            }).join('')}
                        </div>
                    `;
                    if (meta) meta.textContent = `N=${raw.length} (fallback)`;
                } catch { /* ignore */ }
            }
        }

        function _formatVibeHotlistDebug(data, region, url) {
            try {
                const top10 = Array.isArray(data?.top10) ? data.top10 : [];
                const cloud50 = Array.isArray(data?.cloud50) ? data.cloud50 : [];
                return [
                    `url: ${url}`,
                    `region: ${region}`,
                    `top10: ${top10.length}`,
                    `cloud50: ${cloud50.length}`,
                    '',
                    `top10(sample): ${top10.slice(0, 3).map((x) => `${x.phrase}:${x.hit_count}`).join(', ')}`,
                ].join('\n');
            } catch {
                return '--';
            }
        }

        window.renderVibeCardFromData = function renderVibeCardFromData(countryCodeRaw, data) {
            try {
                const region = String(countryCodeRaw || currentDrawerCountry?.code || '').trim().toUpperCase();
                const hint = document.getElementById('vibe-country-hint');
                if (hint) {
                    let label = region || '--';
                    if (/^[A-Z]{2}$/.test(label)) {
                        try {
                            const loc = (typeof currentLang === 'string' && currentLang === 'en') ? 'en' : 'zh-CN';
                            const dn = new Intl.DisplayNames([loc], { type: 'region' });
                            label = dn.of(label) || label;
                        } catch { /* ignore */ }
                    }
                    const nationPrefix = typeof getI18nText === 'function' ? getI18nText('panel.nation_prefix') : 'NATION';
                    hint.textContent = `${nationPrefix}: ${label}`;
                }

                const top10 = Array.isArray(data?.top10) ? data.top10 : (Array.isArray(window.__latestTop10) ? window.__latestTop10 : []);
                var isCountryRegion = (region && String(region).length === 2);
                var cloud50 = isCountryRegion
                    ? (Array.isArray(window.__latestCloud50) ? window.__latestCloud50 : [])
                    : (Array.isArray(data?.cloud50) ? data.cloud50 : (Array.isArray(window.__latestCloud50) ? window.__latestCloud50 : []));

                _renderTop10List(top10);
                _renderCloud50(region, cloud50);

                try {
                    const enabled = _isSemanticBurstDebugEnabled();
                    const panel = document.getElementById('sb-debug-panel');
                    const textEl = document.getElementById('sb-debug-text');
                    if (panel) panel.classList.toggle('hidden', !enabled);
                    if (enabled && textEl) {
                        const API_ENDPOINT = _getApiEndpoint();
                        const url = `${API_ENDPOINT}api/global-average?country_code=${encodeURIComponent(region)}`;
                        textEl.textContent = _formatVibeHotlistDebug(data, region, url);
                    }
                } catch { /* ignore */ }
            } catch { /* ignore */ }
        };

        window.refreshVibeCard = async function refreshVibeCard(countryCode) {
            const region = String(countryCode || currentDrawerCountry?.code || '').trim().toUpperCase();
            const empty = document.getElementById('vibe-cloud50-empty');

            if (!region || region.length !== 2) {
                _renderTop10List([]);
                try { if (empty) empty.classList.remove('hidden'); } catch { /* ignore */ }
                return;
            }

            _setVibeRefreshing(true);
            try { setTimeout(() => _setVibeRefreshing(false), 700); } catch { /* ignore */ }

            if (typeof supabaseClient !== 'undefined' && supabaseClient && typeof supabaseClient.rpc === 'function') {
                window.__latestCloud50 = null;
                try {
                    var kwRes = await supabaseClient.rpc('get_country_keywords', { target_code: region });
                    var kwData = (kwRes && kwRes.data != null) ? kwRes.data : null;
                    if (!kwData || !Array.isArray(kwData) || kwData.length === 0) {
                        window.__latestCloud50 = null;
                        _renderCloud50(region, []);
                        _renderTop10List([]);
                        if (empty) { empty.textContent = 'æ­£åœ¨æ”¶é›†æ•°æ®...'; empty.classList.remove('hidden'); }
                        var emptyTop = document.getElementById('vibe-top10-empty');
                        if (emptyTop) { emptyTop.textContent = 'æ­£åœ¨æ”¶é›†æ•°æ®...'; emptyTop.classList.remove('hidden'); }
                    } else {
                        var cloud50Format = kwData.map(function(x) { return { phrase: (x && x.tag) ? String(x.tag).trim() : '', hit_count: Number(x && x.weight) || 0 }; }).filter(function(x) { return x.phrase && x.hit_count > 0; });
                        window.__latestCloud50 = cloud50Format;
                        _renderCloud50(region, cloud50Format);
                        var top10Data = kwData.slice(0, 10).map(function(x) { return { phrase: (x && x.tag) ? String(x.tag).trim() : '', hitCount: Number(x && x.weight) || 0 }; }).filter(function(x) { return x.phrase && x.hitCount > 0; });
                        window.__latestTop10 = top10Data;
                        _renderTop10List(top10Data);
                    }
                } catch (e) {
                    window.__latestCloud50 = null;
                    try { _renderTop10List([]); } catch { /* ignore */ }
                    try { _renderCloud50(region, []); } catch { /* ignore */ }
                    if (empty) { empty.textContent = 'æ­£åœ¨æ”¶é›†æ•°æ®...'; empty.classList.remove('hidden'); }
                    var emptyTopCatch = document.getElementById('vibe-top10-empty');
                    if (emptyTopCatch) { emptyTopCatch.textContent = 'æ­£åœ¨æ”¶é›†æ•°æ®...'; emptyTopCatch.classList.remove('hidden'); }
                }
            } else {
                try { vibeCloudAbort && vibeCloudAbort.abort && vibeCloudAbort.abort(); } catch { /* ignore */ }
                vibeCloudAbort = (typeof AbortController !== 'undefined') ? new AbortController() : null;
                try {
                    var API_ENDPOINT = _getApiEndpoint();
                    var url = API_ENDPOINT + 'api/global-average?country_code=' + encodeURIComponent(region) + '&_t=' + Date.now();
                    var resp = await fetch(url, { cache: 'no-store', signal: vibeCloudAbort ? vibeCloudAbort.signal : undefined });
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    var payload = await resp.json().catch(function() { return null; });
                    var data = payload && payload.data != null ? payload.data : payload || {};
                    window.__latestTop10 = Array.isArray(data.top10) ? data.top10 : null;
                    window.__latestCloud50 = null;
                    window.renderVibeCardFromData(region, { top10: data.top10 || [], cloud50: [] });
                } catch (e) {
                    try { _renderTop10List([]); } catch { /* ignore */ }
                    try { _renderCloud50(region, []); } catch { /* ignore */ }
                    if (empty) { empty.textContent = 'æ­£åœ¨æ”¶é›†é«˜é¢‘è¯...'; empty.classList.remove('hidden'); }
                }
            }

            if (!window.__vibeCloudResizeBound) {
                window.__vibeCloudResizeBound = true;
                window.addEventListener('resize', () => {
                    try { vibeCloudChart && vibeCloudChart.resize(); } catch {}
                });
            }
        };

        async function loadWordCloud() {
            // æ–°ç‰ˆï¼šè¯­ä¹‰çˆ†å‘å¡ç‰‡ï¼ˆTop10 + Cloud50ï¼‰
            try {
                const cc = String(currentDrawerCountry?.code || '').trim().toUpperCase();
                if (typeof window.refreshVibeCard === 'function') {
                    await window.refreshVibeCard(cc);
                    return;
                }
            } catch { /* ignore */ }

            const nationalContainer = document.getElementById('national-wordcloud-container');
            const nationalEmpty = document.getElementById('national-sentence-empty');

            if (!nationalContainer) return;
            if (typeof echarts === 'undefined') return;

            // å›½å®¶æ± ï¼šåªå±•ç¤ºâ€œè¯¥å›½æ‰€æœ‰ç”¨æˆ·ç´¯è®¡â€çš„å¥å¼ï¼ˆslang_trends_pool -> /api/global-average monthly_vibesï¼‰
            try {
                let region = null;
                try {
                    const cc = String(currentDrawerCountry?.code || '').trim().toUpperCase();
                    if (cc.length === 2) region = cc;
                } catch { /* ignore */ }

                if (!region) {
                    _showEmpty(nationalContainer, nationalEmpty, true);
                    return;
                }

                // è‹¥ updateCountryDashboard å°šæœªæ³¨å…¥ monthly_vibesï¼Œåˆ™å°±åœ°å›æºä¸€æ¬¡ï¼ˆä¸å¼•å…¥ç¡¬ç¼–ç ï¼‰
                if (!window.__latestMonthlyVibes) {
                    try {
                        const API_ENDPOINT = _getApiEndpoint();
                        const url = `${API_ENDPOINT}api/global-average?country_code=${encodeURIComponent(region)}`;
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (resp.ok) {
                            const payload = await resp.json().catch(() => null);
                            const data = payload?.data ?? payload ?? {};
                            window.__latestMonthlyVibes = data.monthly_vibes || data.monthlyVibes || null;
                            window.__latestTopSentences = data.top_sentences || null;
                        }
                    } catch { /* ignore */ }
                }

                const mv = window.__latestMonthlyVibes || null;
                const slang = Array.isArray(mv?.slang) ? mv.slang : [];
                const merit = Array.isArray(mv?.merit) ? mv.merit : [];
                const sv = Array.isArray(mv?.sv_slang) ? mv.sv_slang : [];
                const natPhrases = Array.isArray(mv?.phrase) ? mv.phrase : [];

                // å±•ç¤ºä¼˜å…ˆçº§ï¼ˆæŒ‰ä½ çš„æ–°éœ€æ±‚ï¼‰ï¼š
                // 1) å›½æ°‘çº§è¯ç»„ï¼ˆmonthly_vibes.phraseï¼‰â†’ åˆ—è¡¨
                // 2) çœŸå®é›·åŒå¥å­ï¼ˆtop_sentencesï¼‰â†’ åˆ—è¡¨
                // 3) å…¶ä»–å…³é”®è¯ï¼ˆslang/merit/sv_slangï¼‰â†’ è¯äº‘
                const topSentences = window.__latestTopSentences || null;
                let combined0 = [];

                if (Array.isArray(natPhrases) && natPhrases.length > 0) {
                    combined0 = natPhrases
                        .map((x) => ({ name: String(x?.phrase || '').trim(), value: Number(x?.hit_count) || 0, category: 'phrase' }))
                        .filter((x) => x.name && x.value > 0)
                        .sort((a, b) => b.value - a.value);
                    
                    // åº”ç”¨å¯è¯»æ€§è¿‡æ»¤å™¨
                    combined0 = filterReadableWords(combined0);
                    combined0 = combined0.slice(0, 10);
                    
                } else if (Array.isArray(topSentences) && topSentences.length > 0) {
                    combined0 = topSentences
                        .map((x) => ({
                            name: String(x?.sentence || '').trim(),
                            value: Number(x?.hit_count) || 0,
                            category: 'sentence',
                        }))
                        .filter((x) => x.name && x.value > 0);
                    
                    // åº”ç”¨å¯è¯»æ€§è¿‡æ»¤å™¨
                    combined0 = filterReadableWords(combined0);
                    combined0 = combined0.slice(0, 10);
                } else {
                    combined0 = []
                        .concat(slang.map((x) => ({ name: String(x?.phrase || '').trim(), value: Number(x?.hit_count) || 0, category: 'slang' })))
                        .concat(merit.map((x) => ({ name: String(x?.phrase || '').trim(), value: Number(x?.hit_count) || 0, category: 'merit' })))
                        .concat(sv.map((x) => ({ name: String(x?.phrase || '').trim(), value: Number(x?.hit_count) || 0, category: 'sv_slang' })))
                        .filter((x) => x.name && x.value > 0)
                        .sort((a, b) => b.value - a.value);
                    
                    // åº”ç”¨å¯è¯»æ€§è¿‡æ»¤å™¨ï¼Œå»é™¤ä¸è§„åˆ™çš„å­—æ¯ç»„åˆ
                    const beforeFilter = combined0.length;
                    combined0 = filterReadableWords(combined0);
                    const afterFilter = combined0.length;
                    if (beforeFilter !== afterFilter) {
                        console.log(`[WordCloud] å¯è¯»æ€§è¿‡æ»¤: ${beforeFilter} â†’ ${afterFilter} æ¡`);
                    }
                    
                    // æˆªå–å‰10æ¡
                    combined0 = combined0.slice(0, 10);
                }

                if (combined0.length === 0) {
                    // ç©ºæ€ï¼šåˆ†ç±»ä¸ºç©ºæ—¶æç¤ºâ€œæ­£åœ¨æ”¶å½•â€¦â€
                    try {
                        if (nationalEmpty) nationalEmpty.textContent = 'æ­£åœ¨å»ºç«‹è¯¥åœ°åŒºå¼€å‘è€…è¯­ä¹‰æŒ‡çº¹...';
                    } catch { /* ignore */ }
                    _showEmpty(nationalContainer, nationalEmpty, true);

                    // debug panel update
                    try {
                        const enabled = _isSemanticBurstDebugEnabled();
                        const panel = document.getElementById('sb-debug-panel');
                        const textEl = document.getElementById('sb-debug-text');
                        if (panel) panel.classList.toggle('hidden', !enabled);
                        if (enabled && textEl) {
                            const API_ENDPOINT = _getApiEndpoint();
                            const url = `${API_ENDPOINT}api/global-average?country_code=${encodeURIComponent(region)}`;
                            textEl.textContent = _formatMonthlyVibesDebug(mv, region, url);
                        }
                    } catch { /* ignore */ }

                    return;
                }

                _showEmpty(nationalContainer, nationalEmpty, false);
                
                // å±•ç¤ºç­–ç•¥ï¼š
                // - sentenceï¼šçœŸå®å¥å­ï¼ˆ>=2 æ¬¡é›·åŒï¼‰â†’ åˆ—è¡¨
                // - phraseï¼šå›½æ°‘çº§è¯ç»„ï¼ˆ3-5å­—/è¯ï¼‰â†’ åˆ—è¡¨
                // - å…¶ä»–å…³é”®è¯ â†’ è¯äº‘
                const category0 = combined0.length > 0 ? String(combined0[0].category || '') : '';
                const useSentenceList = category0 === 'sentence' || category0 === 'phrase';
                
                if (useSentenceList) {
                    // ç¨³å®šæ–¹æ¡ˆï¼šå¥å­åˆ—è¡¨æ¸²æŸ“åˆ° fallback å®¹å™¨ï¼ˆé¿å…è¢«è¯äº‘/ECharts/empty-state å½±å“ï¼‰
                    const fallbackEl = document.getElementById('national-sentence-fallback');
                    const hintEl = document.getElementById('national-sentence-hint');

                    const ranked = (Array.isArray(combined0) ? combined0 : [])
                        .map((x) => ({ name: String(x?.name || '').trim(), value: Number(x?.value) || 0 }))
                        .filter((x) => x.name && x.value > 0)
                        .sort((a, b) => b.value - a.value);
                    const list = (category0 === 'sentence')
                        ? ranked.filter((x) => x.value >= 2).slice(0, 10)     // çœŸå®å¥å­ï¼šå¿…é¡» >=2
                        : ranked.slice(0, 10);                                // å›½æ°‘è¯ç»„ï¼šåªè¦ >0 å°±å±•ç¤ºæ’è¡Œ

                    // æ¸…ç©ºè¯äº‘å®¹å™¨ï¼ˆé¿å…å å±‚/å ä½å½±å“ï¼‰
                    try { nationalContainer.innerHTML = ''; } catch { /* ignore */ }
                    try { _disposeChart(nationalSentenceChart); } catch { /* ignore */ }

                    // åŒæ­¥æç¤º
                    try {
                        if (hintEl) {
                            hintEl.textContent = category0 === 'phrase'
                                ? `TOP ${list.length} å›½æ°‘è¯ç»„`
                                : `TOP ${list.length} é›·åŒå¥å­`;
                        }
                    } catch { /* ignore */ }

                    // ç©ºæ€ï¼šsentence å¿…é¡» >=2ï¼›phrase è‹¥ä¸ºç©ºåˆ™æç¤ºæ”¶å½•ä¸­
                    if (list.length === 0) {
                        if (fallbackEl) {
                            fallbackEl.innerHTML = category0 === 'phrase'
                                ? '<div class="text-zinc-500 text-sm p-3 italic">æš‚æ— å›½æ°‘çº§è¯ç»„ï¼ˆæ­£åœ¨æ”¶å½•ä¸­...ï¼‰</div>'
                                : '<div class="text-zinc-500 text-sm p-3 italic">æš‚æ—  â‰¥2 æ¬¡é›·åŒçš„çœŸå®å¥å¼ï¼ˆæ­£åœ¨æ”¶å½•ä¸­...ï¼‰</div>';
                            fallbackEl.classList.remove('hidden');
                        }
                        try { if (nationalEmpty) nationalEmpty.classList.remove('hidden'); } catch { /* ignore */ }
                        return;
                    }

                    const listHtml = list.map((item, index) => {
                        const escName = _escapeHtml(item.name || '');
                        const count = item.value || 0;
                        const countColor = count >= 10 ? '#00ff41' : count >= 5 ? 'rgba(0,255,65,0.8)' : '#9ca3af';
                        return `
                            <div class="flex items-start gap-3 p-3 border-b border-white/5 hover:bg-white/5 transition-colors">
                                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-gradient-to-br from-[var(--accent-terminal)]/20 to-[var(--accent-terminal)]/10 flex items-center justify-center text-[10px] font-bold text-white/60">
                                    ${index + 1}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm text-zinc-200 leading-relaxed break-words">${escName}</div>
                                </div>
                                <div class="flex-shrink-0 flex items-center gap-1">
                                    <span class="text-[10px] text-zinc-500">Ã—</span>
                                    <span class="text-sm font-bold tabular-nums" style="color: ${countColor}">${count}</span>
                                </div>
                            </div>
                        `;
                    }).join('');

                    if (fallbackEl) {
                        fallbackEl.innerHTML = `<div class="w-full max-h-[380px] overflow-y-auto">${listHtml}</div>`;
                        fallbackEl.classList.remove('hidden');
                    }
                    try { if (nationalEmpty) nationalEmpty.classList.add('hidden'); } catch { /* ignore */ }
                } else {
                    // å›é€€ï¼šä½¿ç”¨è¯äº‘å±•ç¤ºå…³é”®è¯
                    const words = applyLogFontSize(combined0, (w) => w?.value ?? 0);
                    nationalContainer.innerHTML = '';
                    _disposeChart(nationalSentenceChart);
                    nationalSentenceChart = echarts.init(nationalContainer, 'dark', { renderer: 'canvas' });

                const maxVal = Math.max(...words.map((w) => w.value));
                const getColor = (category, value) => {
                    const intensity = Math.min(1, (value || 0) / (maxVal || 1));
                    switch (category) {
                        case 'merit': return { color: `rgba(16, 185, 129, ${0.7 + intensity * 0.3})`, glow: `rgba(16,185,129,${0.35 + intensity * 0.35})` };
                        case 'sv_slang': return { color: `rgba(249, 115, 22, ${0.7 + intensity * 0.3})`, glow: `rgba(249,115,22,${0.35 + intensity * 0.35})` };
                        default: return { color: `rgba(168, 85, 247, ${0.7 + intensity * 0.3})`, glow: `rgba(168,85,247,${0.35 + intensity * 0.35})` };
                    }
                };
                const categoryLabels = { merit: 'åŠŸå¾·', slang: 'é»‘è¯', sv_slang: 'ç¡…è°·é»‘è¯' };

                const maxFont = 28;
                // æ’ä»¶/æ¸²æŸ“å¤±è´¥æ—¶ï¼šå›é€€ä¸º Top åˆ—è¡¨ï¼Œé¿å…â€œæœ‰æ•°æ®ä½†çœ‹ä¸åˆ°â€
                const fallbackEl = document.getElementById('national-sentence-fallback');
                try {
                    if (fallbackEl) fallbackEl.classList.add('hidden');
                    nationalSentenceChart.setOption(_buildWordCloudOption({
                        words,
                        maxFont,
                        tooltipFormatter: (p) => {
                            const d = p.data || {};
                            const catLabel = categoryLabels[d.category] || 'æœªçŸ¥';
                            return `${p.name}<br/>å…±åŒè§¦å‘: <b>${p.value}</b><br/>åˆ†ç±»: ${catLabel}`;
                        },
                        textStyle: {
                            color: (p) => getColor(p.data.category, p.data.value).color,
                            shadowBlur: 10,
                            shadowColor: (p) => getColor(p.data.category, p.data.value).glow,
                        },
                        emphasisTextStyle: { shadowBlur: 18 },
                        onClick: (p) => { try { handleWordCloudClick && handleWordCloudClick(p?.data?.name, p?.data?.category || 'slang'); } catch {} },
                    }), true);
                } catch (e) {
                    try { _disposeChart(nationalSentenceChart); } catch { /* ignore */ }
                    nationalSentenceChart = null;
                    if (fallbackEl) {
                        const top = (Array.isArray(words) ? words : []).slice(0, 20);
                        fallbackEl.innerHTML = top.map((w) => {
                            const name = _escapeHtml(w?.name || '');
                            const value = Number(w?.value) || 0;
                            const cat = _escapeHtml(w?.category || '');
                            return `<div class="flex justify-between gap-3 border-b border-white/10 py-1"><span class="truncate">${name}</span><span class="tabular-nums text-zinc-500">${value}</span><span class="text-zinc-600">${cat}</span></div>`;
                        }).join('') || '<div class="text-zinc-500">æ— å¯ç”¨æ•°æ®</div>';
                        fallbackEl.classList.remove('hidden');
                    }
                }
                
                    // debug panel update (success)
                    try {
                        const enabled = _isSemanticBurstDebugEnabled();
                        const panel = document.getElementById('sb-debug-panel');
                        const textEl = document.getElementById('sb-debug-text');
                        if (panel) panel.classList.toggle('hidden', !enabled);
                        if (enabled && textEl) {
                            const API_ENDPOINT = _getApiEndpoint();
                            const url = `${API_ENDPOINT}api/global-average?country_code=${encodeURIComponent(region)}`;
                            textEl.textContent = _formatMonthlyVibesDebug(mv, region, url);
                        }
                    } catch { /* ignore */ }
                } // ç»“æŸ else (è¯äº‘æ¸²æŸ“åˆ†æ”¯)
            } catch (e) {
                try {
                    if (nationalEmpty) nationalEmpty.textContent = 'æ­£åœ¨å»ºç«‹è¯¥åœ°åŒºå¼€å‘è€…è¯­ä¹‰æŒ‡çº¹...';
                } catch { /* ignore */ }
                _showEmpty(nationalContainer, nationalEmpty, true);
            }

            // resize
            if (!window.__sentenceCloudResizeBound) {
                window.__sentenceCloudResizeBound = true;
                window.addEventListener('resize', () => {
                    try { nationalSentenceChart && nationalSentenceChart.resize(); } catch {}
                });
            }
        }
        
        // initWordCloud åˆ«åï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
        const initWordCloud = loadWordCloud;
        window.initWordCloud = initWordCloud;
        window.loadWordCloud = loadWordCloud;

        // Debug switch init (Semantic Burst)
        try {
            const toggle = document.getElementById('sb-debug-toggle');
            const panel = document.getElementById('sb-debug-panel');
            const refreshBtn = document.getElementById('sb-debug-refresh');
            const enabled = _isSemanticBurstDebugEnabled();
            if (toggle) toggle.checked = enabled;
            if (panel) panel.classList.toggle('hidden', !enabled);
            if (toggle) {
                toggle.addEventListener('change', () => {
                    const on = Boolean(toggle.checked);
                    _setSemanticBurstDebugEnabled(on);
                    try { window.loadWordCloud && window.loadWordCloud(); } catch { /* ignore */ }
                });
            }
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    try { window.__latestTop10 = null; } catch { /* ignore */ }
                    try { window.__latestCloud50 = null; } catch { /* ignore */ }
                    try { window.refreshVibeCard && window.refreshVibeCard(currentDrawerCountry?.code); } catch { /* ignore */ }
                });
            }
        } catch { /* ignore */ }

        // UserText Debug Popup
        try {
            const openUserTextDebug = () => {
                try {
                    const existing = document.getElementById('usertext-debug-overlay');
                    if (existing) existing.remove();
                } catch { /* ignore */ }

                const overlay = document.createElement('div');
                overlay.id = 'usertext-debug-overlay';
                overlay.className = 'usertext-debug-overlay';
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) overlay.remove();
                });

                // ä¼˜å…ˆè¯» windowï¼ˆåŒé¡µé¢ï¼‰ï¼Œå¦åˆ™ä» localStorage è¯»å–ï¼ˆè·¨é¡µé¢ï¼‰
                let userText = String(window.__vibe_debug_userText || '').trim();
                let extracted = Array.isArray(window.__vibe_debug_extracted_keywords) ? window.__vibe_debug_extracted_keywords : [];
                let finalList = Array.isArray(window.__vibe_debug_final_report_list) ? window.__vibe_debug_final_report_list : [];
                let regionHint = String(window.__vibe_debug_region_hint || '').trim();
                let updatedAt = String(window.__vibe_debug_updated_at || '').trim();
                let sourceHint = userText || extracted.length || finalList.length || regionHint || updatedAt ? 'window' : '';
                try {
                    if (!sourceHint) {
                        const t = String(localStorage.getItem('vibe_debug_userText') || '').trim();
                        const ek = String(localStorage.getItem('vibe_debug_extracted_keywords') || '[]');
                        const fl = String(localStorage.getItem('vibe_debug_final_report_list') || '[]');
                        const rh = String(localStorage.getItem('vibe_debug_region_hint') || '').trim();
                        const ua = String(localStorage.getItem('vibe_debug_updated_at') || '').trim();
                        userText = t;
                        try { extracted = JSON.parse(ek); } catch { extracted = []; }
                        try { finalList = JSON.parse(fl); } catch { finalList = []; }
                        regionHint = rh;
                        updatedAt = ua;
                        sourceHint = (t || rh || ua || (Array.isArray(extracted) && extracted.length) || (Array.isArray(finalList) && finalList.length)) ? 'localStorage' : '';
                    }
                } catch { /* ignore */ }
                let anchored = '';
                try {
                    anchored =
                        String(localStorage.getItem('anchored_country') || '').trim().toUpperCase() ||
                        String(localStorage.getItem('selected_country') || '').trim().toUpperCase();
                } catch { anchored = ''; }

                const esc = (s) => { try { return _escapeHtml(String(s ?? '')); } catch { return String(s ?? ''); } };
                const asList = (arr) => (Array.isArray(arr) ? arr : [])
                    .map((x) => ({
                        phrase: String(x?.phrase || '').trim(),
                        category: String(x?.category || '').trim(),
                        weight: Number(x?.weight ?? x?.hit_count ?? x?.hitCount ?? 0) || 0,
                    }))
                    .filter((x) => x.phrase);

                const extractedList = asList(extracted);
                const finalReportList = asList(finalList);

                const extractedHtml = extractedList.length
                    ? extractedList.slice(0, 100).map((it, idx) => `
                        <div class="flex justify-between gap-3 border-b border-white/10 py-1">
                            <div class="flex items-center gap-2 min-w-0">
                                <span class="text-zinc-500 tabular-nums w-6">${idx + 1}</span>
                                <span class="truncate font-mono text-zinc-200">${esc(it.phrase)}</span>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <span class="text-[10px] text-zinc-500">${esc(it.category || 'slang')}</span>
                                <span class="text-zinc-400 tabular-nums">${it.weight}</span>
                            </div>
                        </div>
                    `).join('')
                    : '<div class="text-zinc-500 text-sm italic">æš‚æ— ï¼ˆå¯èƒ½å°šæœªè§¦å‘åˆ†æ / userText ä¸ºç©º / æè¯å¤±è´¥ï¼‰</div>';

                const finalHtml = finalReportList.length
                    ? finalReportList.slice(0, 100).map((it, idx) => `
                        <div class="flex justify-between gap-3 border-b border-white/10 py-1">
                            <div class="flex items-center gap-2 min-w-0">
                                <span class="text-zinc-500 tabular-nums w-6">${idx + 1}</span>
                                <span class="truncate font-mono text-zinc-200">${esc(it.phrase)}</span>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <span class="text-[10px] text-zinc-500">${esc(it.category || 'slang')}</span>
                                <span class="text-zinc-400 tabular-nums">${it.weight}</span>
                            </div>
                        </div>
                    `).join('')
                    : '<div class="text-zinc-500 text-sm italic">æš‚æ— ï¼ˆfinalList ä¸ºç©ºåˆ™ä¸ä¼šä¸ŠæŠ¥ /api/v2/report-vibeï¼‰</div>';

                const header = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-xs uppercase tracking-widest text-zinc-400">UserText Debug</div>
                        <div class="flex items-center gap-2">
                            <button id="usertext-debug-copy" class="px-2 py-1 text-[10px] border border-white/10 text-zinc-200 hover:bg-white/5 transition-colors font-mono">COPY</button>
                            <button id="usertext-debug-reportvibe" class="px-2 py-1 text-[10px] border border-[#00ff41]/30 text-[#00ff41] hover:bg-[#00ff41]/10 transition-colors font-mono">REPORT_VIBE_DEBUG</button>
                            <button id="usertext-debug-close" class="px-2 py-1 text-[10px] border border-[#00ff41]/30 text-[#00ff41] hover:bg-[#00ff41]/10 transition-colors font-mono">CLOSE</button>
                        </div>
                    </div>
                    <div class="text-[11px] text-zinc-500 font-mono">
                        anchored(anchored_country): <span class="text-zinc-200">${esc(anchored || '--')}</span>
                        &nbsp;|&nbsp; regionHint: <span class="text-zinc-200">${esc(regionHint || '--')}</span>
                        &nbsp;|&nbsp; updated_at: <span class="text-zinc-200">${esc(updatedAt || '--')}</span>
                        &nbsp;|&nbsp; source: <span class="text-zinc-200">${esc(sourceHint || 'none')}</span>
                    </div>
                `;

                const body = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mt-3">
                        <div class="border border-white/10 bg-zinc-950/30 p-3">
                            <div class="text-[10px] text-zinc-500 uppercase tracking-widest mb-2">USER_TEXT (raw)</div>
                            <textarea id="usertext-debug-textarea" class="w-full h-[240px] bg-black/40 border border-white/10 text-zinc-200 text-[11px] font-mono p-2 outline-none" readonly>${esc(userText)}</textarea>
                            <div class="text-[10px] text-zinc-600 mt-2">len=${userText.length}</div>
                        </div>
                        <div class="border border-white/10 bg-zinc-950/30 p-3">
                            <div class="text-[10px] text-zinc-500 uppercase tracking-widest mb-2">EXTRACTED (extractVibeKeywords)</div>
                            <div class="max-h-[240px] overflow-y-auto">${extractedHtml}</div>
                        </div>
                    </div>
                    <div class="border border-white/10 bg-zinc-950/30 p-3 mt-3">
                        <div class="text-[10px] text-zinc-500 uppercase tracking-widest mb-2">FINAL_REPORT_LIST (will report)</div>
                        <div class="max-h-[240px] overflow-y-auto">${finalHtml}</div>
                    </div>
                    <div class="border border-white/10 bg-zinc-950/30 p-3 mt-3">
                        <div class="text-[10px] text-zinc-500 uppercase tracking-widest mb-2">WORKER DEBUG RESULT (/api/v2/report-vibe?debug=1)</div>
                        <textarea id="usertext-debug-worker-result" class="w-full h-[180px] bg-black/40 border border-white/10 text-zinc-200 text-[11px] font-mono p-2 outline-none" readonly>ç‚¹å‡» REPORT_VIBE_DEBUG å‘é€ finalList åˆ° Workerï¼ˆdebug=1ï¼‰å¹¶æ˜¾ç¤ºé€æ¡ RPC ç»“æœ</textarea>
                    </div>
                `;

                overlay.innerHTML = `
                    <div class="w-full max-w-5xl bg-zinc-950/95 border border-[#00ff41]/25 p-4">
                        ${header}
                        ${body}
                    </div>
                `;
                document.body.appendChild(overlay);

                const closeBtn = document.getElementById('usertext-debug-close');
                if (closeBtn) closeBtn.addEventListener('click', () => overlay.remove());
                const copyBtn = document.getElementById('usertext-debug-copy');
                if (copyBtn) copyBtn.addEventListener('click', async () => {
                    try {
                        const ta = document.getElementById('usertext-debug-textarea');
                        const text = (ta && ta.value != null) ? ta.value : userText;
                        await navigator.clipboard.writeText(String(text || ''));
                    } catch { /* ignore */ }
                });

                const reportBtn = document.getElementById('usertext-debug-reportvibe');
                if (reportBtn) reportBtn.addEventListener('click', async () => {
                    const out = document.getElementById('usertext-debug-worker-result');
                    try {
                        if (out) out.value = 'å‘é€ä¸­...';
                        const listFinal = Array.isArray(finalList) ? finalList : [];
                        const listExtracted = Array.isArray(extracted) ? extracted : [];
                        // å¹¶ä¸å¼ºä¾èµ– finalListï¼šä¸ºç©ºæ—¶å›é€€ç”¨ extractedï¼ˆå¸®åŠ©å®šä½â€œä¸ºä»€ä¹ˆ finalList ä¸ºç©ºâ€ï¼‰
                        const list = listFinal.length > 0 ? listFinal : listExtracted;
                        const listSource = listFinal.length > 0 ? 'finalList' : (listExtracted.length > 0 ? 'extracted' : 'empty');
                        if (list.length === 0) {
                            if (out) out.value = 'finalList ä¸ extracted å‡ä¸ºç©ºï¼šå½“å‰æ— æ³•è§¦å‘ /api/v2/report-vibe å†™åº“ã€‚è¯·å…ˆè§¦å‘ä¸€æ¬¡åˆ†æç”Ÿæˆæè¯ç»“æœã€‚';
                            return;
                        }

                        const API_ENDPOINT = _getApiEndpoint();
                        const url = `${API_ENDPOINT}api/v2/report-vibe?debug=1`;
                        let fingerprint = null;
                        try { fingerprint = localStorage.getItem('user_fingerprint') || window.fpId || null; } catch { fingerprint = null; }

                        // å°† finalList è½¬ä¸º Worker æ¥å£è¦æ±‚ï¼š[{phrase, category, weight}]
                        const keywords = list.map((x) => ({
                            phrase: String(x?.phrase || '').trim(),
                            category: String(x?.category || 'slang').trim() || 'slang',
                            weight: Number(x?.weight ?? 1) || 1,
                        })).filter((x) => x.phrase);

                        const payload = {
                            debug: 1,
                            keywords,
                            fingerprint: fingerprint || null,
                            // å¼ºåˆ¶æºå¸¦é”šå®šå›½å®¶ï¼ˆWorker ä¼šä¼˜å…ˆ manual_regionï¼‰
                            manual_region: anchored && /^[A-Z]{2}$/.test(anchored) ? anchored : null,
                            region: anchored && /^[A-Z]{2}$/.test(anchored) ? anchored : null,
                            timestamp: new Date().toISOString(),
                        };

                        const resp = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });

                        const text = await resp.text().catch(() => '');
                        if (out) {
                            let note = '';
                            try {
                                const parsed = JSON.parse(text || '{}');
                                if (parsed && typeof parsed === 'object' && parsed.status !== 'debug') {
                                    note = '\n\n[NOTE] Worker æœªè¿”å› debug ç»“æ„ï¼ˆstatus!=debugï¼‰ã€‚è¿™é€šå¸¸è¡¨ç¤ºï¼šçº¿ä¸Š Worker å°šæœªéƒ¨ç½²åˆ°åŒ…å« debug=1 çš„ç‰ˆæœ¬ã€‚';
                                }
                            } catch { /* ignore */ }
                            const header =
                                `HTTP ${resp.status}\n` +
                                `sent_source=${listSource}, sent_keywords=${keywords.length}, anchored=${anchored || '--'}\n\n`;
                            out.value = header + (text || '(empty)') + note;
                        }

                // debug æˆåŠŸåï¼šç«‹å³åˆ·æ–°å³ä¾§é»‘è¯æ¦œï¼ˆè®©æœ€æ–°å…¥åº“æ•°æ®â€œé©¬ä¸Šå¯è§â€ï¼‰
                try {
                    const parsed = JSON.parse(text || '{}');
                    if (parsed && typeof parsed === 'object' && parsed.status === 'debug') {
                        try { window.refreshVibeCard && window.refreshVibeCard(anchored); } catch { /* ignore */ }
                    }
                } catch { /* ignore */ }
                    } catch (e) {
                        if (out) out.value = `å‘é€å¤±è´¥: ${String(e?.message || e)}`;
                    }
                });
            };

            window.openUserTextDebug = openUserTextDebug;

            // äº‹ä»¶å§”æ‰˜å…œåº•ï¼šé¿å… DOM è¢«é‡ç»˜åç›‘å¬å¤±æ•ˆ
            document.addEventListener('click', (e) => {
                try {
                    const t = e && e.target;
                    if (t && t.id === 'sb-usertext-btn') {
                        openUserTextDebug();
                    }
                } catch { /* ignore */ }
            }, true);
        } catch { /* ignore */ }

        // ==========================================
        // ã€V6.0 æ–°å¢ã€‘è¯äº‘ç‚¹å‡»äº‹ä»¶å¤„ç†
        // ==========================================

        /**
         * å¤„ç†è¯äº‘ç‚¹å‡»ï¼Œè§¦å‘åœ°å›¾è”åŠ¨
         * @param {string} keyword - ç‚¹å‡»çš„å…³é”®è¯
         * @param {string} category - å…³é”®è¯åˆ†ç±»
         */
        window.handleWordCloudClick = async function(keyword, category) {
            console.log('[WordCloud] ç‚¹å‡»è¯äº‘:', { keyword, category });

            const apiEndpoint = (document.querySelector('meta[name="api-endpoint"]')?.content || '').trim();
            const API_ENDPOINT = apiEndpoint.endsWith('/') ? apiEndpoint : `${apiEndpoint}/`;

            try {
                // æŸ¥è¯¢è¯¥å…³é”®è¯çš„åœ°ç†åˆ†å¸ƒ
                var _kfp = '';
                try { _kfp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                const resp = await fetch(`${API_ENDPOINT}api/v2/keyword-location?keyword=${encodeURIComponent(keyword)}&fingerprint=${encodeURIComponent(_kfp)}&_t=${Date.now()}`);
                const json = await resp.json().catch(() => null);

                if (json && json.status === 'success' && json.data) {
                    // æ˜¾ç¤ºå…³é”®è¯åœ°ç†åˆ†å¸ƒè¯¦æƒ…
                    showKeywordDetails(keyword, category, json.data);
                } else {
                    // æ²¡æœ‰åœ°ç†æ•°æ®æ—¶æ˜¾ç¤ºç®€å•æç¤º
                    showKeywordSimple(keyword, category);
                }
            } catch (error) {
                console.warn('[Frontend] âš ï¸ è¯äº‘ç‚¹å‡»äº‹ä»¶å¤„ç†å¤±è´¥:', error);
                showKeywordSimple(keyword, category);
            }
        };

        /**
         * æ˜¾ç¤ºå…³é”®è¯è¯¦ç»†ä¿¡æ¯ï¼ˆæ— åœ°ç†æ•°æ®æ—¶çš„ç®€åŒ–ç‰ˆæœ¬ï¼‰
         */
        function showKeywordSimple(keyword, category) {
            const categoryLabels = {
                'merit': 'åŠŸå¾·',
                'slang': 'é»‘è¯',
                'sv_slang': 'ç¡…è°·é»‘è¯',
            };

            const catLabel = categoryLabels[category] || 'æœªçŸ¥';

            // ä½¿ç”¨ existingAlert æˆ–åˆ›å»ºä¸´æ—¶æç¤º
            if (typeof existingAlert === 'function') {
                existingAlert(`å…³é”®è¯ "${keyword}" (${catLabel})\nåœ°ç†åˆ†å¸ƒæ•°æ®æš‚ä¸å¯ç”¨`, 'info');
            } else {
                alert(`å…³é”®è¯: ${keyword}\nåˆ†ç±»: ${catLabel}\n\nåœ°ç†åˆ†å¸ƒåŠŸèƒ½å¼€å‘ä¸­...`);
            }
        }

        /**
         * æ˜¾ç¤ºå…³é”®è¯è¯¦ç»†ä¿¡æ¯é¢æ¿
         */
        function showKeywordDetails(keyword, category, locationData) {
            // ã€é‡æ„ã€‘ä½¿ç”¨æ–°çš„å›½å®¶è§†å›¾å®¹å™¨
            const countryViewPanel = document.getElementById('panel-country-view');
            const countryTemplateMount = document.getElementById('countryTemplateMount');
            if (!countryViewPanel || !countryTemplateMount) return;

            // æŒ‰å‡ºç°é¢‘ç‡æ’åº
            const sortedLocations = (locationData || [])
                .sort((a, b) => (b.count || 0) - (a.count || 0))
                .slice(0, 10);

            const categoryLabels = {
                'merit': 'åŠŸå¾·',
                'slang': 'é»‘è¯',
                'sv_slang': 'ç¡…è°·é»‘è¯',
            };

            const catLabel = categoryLabels[category] || 'æœªçŸ¥';

            const html = `
                <div class="clinic-card">
                    <div class="card-header">
                        <i data-lucide="map-pin"></i>
                        <span class="card-title">å…³é”®è¯åœ°ç†åˆ†å¸ƒ</span>
                    </div>
                    <div class="mb-4">
                        <div class="text-sm text-zinc-400 mb-2">å…³é”®è¯</div>
                        <div class="text-2xl font-bold text-[var(--accent-terminal)]">
                            ${keyword}
                        </div>
                        <div class="text-xs text-zinc-500 mt-1">
                            åˆ†ç±»ï¼š${catLabel}
                        </div>
                    </div>
                    <div>
                        <div class="text-sm text-zinc-400 mb-2">Top 10 åœ°åŒº</div>
                        ${sortedLocations.length > 0 ? `
                            <div class="space-y-2">
                                ${sortedLocations.map(item => `
                                    <div class="flex justify-between items-center bg-zinc-900 p-2 border border-zinc-800">
                                        <span class="text-sm">${item.location || 'æœªçŸ¥'}</span>
                                        <span class="text-sm font-bold text-[var(--accent-terminal)]">${item.count || 0} æ¬¡</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="text-zinc-500 text-sm">æš‚æ— åœ°ç†åˆ†å¸ƒæ•°æ®</div>'}
                    </div>
                </div>
            `;

            countryTemplateMount.innerHTML = html;
            
            // åˆ‡æ¢åˆ°å›½å®¶è§†å›¾
            if (typeof switchView === 'function') {
                switchView('country');
            }

            // åˆ·æ–° Lucide å›¾æ ‡
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // ==========================================
        // è¯­ä¹‰çˆ†å‘ï¼šé™é»˜ä¸ŠæŠ¥ï¼ˆDashboard/çˆ¶é¡µé¢å¯è§¦å‘ï¼‰
        // ==========================================
        
        // å…³é”®è¯è¯å…¸ï¼ˆç”¨äºåˆ†ç±»ï¼‰
        const MERIT_KEYWORDS = new Set(['é‡æ„', 'ä¼˜åŒ–', 'ä¿®å¤', 'æ”¹è¿›', 'å®Œå–„', 'æå‡', 'å¢å¼º', 'è°ƒæ•´', 'æ›´æ–°', 'å‡çº§', 'åŠŸå¾·', 'ç¦æŠ¥', 'ç§¯å¾·', 'å–„ä¸š']);
        const SLANG_KEYWORDS = new Set(['é—­ç¯', 'é¢—ç²’åº¦', 'å¯¹é½', 'æŠ“æ‰‹', 'è½åœ°', 'å¤ç›˜', 'é“¾è·¯', 'å…œåº•', 'èµ‹èƒ½', 'é™ç»´', 'æŠ¤åŸæ²³', 'èµ›é“', 'æ–¹æ³•è®º', 'åº•å±‚é€»è¾‘', 'æ¶æ„è§£è€¦']);
        
        /**
         * è‡ªåŠ¨åˆ†ç±»å…³é”®è¯/å¥å¼ï¼ˆå¯¹é½ç¾åŒº/å›½åŒºï¼‰
         * @param {string} phrase - çŸ­è¯­/å¥å¼
         * @returns {'merit' | 'slang' | 'sv_slang'}
         */
        function categorizeKeyword(phrase) {
            const normalized = String(phrase || '').trim();
            if (!normalized) return 'slang';
            const lower = normalized.toLowerCase();

            // 1) æŒ‡ä»¤/ä¿®å¤ç±»ï¼šä¼˜å…ˆ merit
            if (normalized.includes('//') || /\btodo\b/i.test(lower) || /\bfix(?:me|ing|ed)?\b/i.test(lower)) return 'merit';
            if (/ä¿®å¤|ä¼˜åŒ–|é‡æ„|æ”¹è¿›|å®Œå–„|æå‡|å¢å¼º|è°ƒæ•´|æ›´æ–°|å‡çº§/.test(normalized)) return 'merit';

            // 2) ç¾åŒºé€‚é…ï¼š>=3 ä¸ªè‹±æ–‡å•è¯ï¼ˆå«ç©ºæ ¼ï¼‰ï¼Œä¸”ä¸å«ä¸­æ–‡ => sv_slang
            if (!/[\u4e00-\u9fff]/.test(normalized)) {
                const words = lower.split(/\s+/g).filter(Boolean);
                const englishWords = words.filter(w => /^[a-z]+(?:'[a-z]+)?$/.test(w));
                if (englishWords.length >= 3) return 'sv_slang';
            }

            // 3) ç§å­è¯å…¸å‘½ä¸­
            if (MERIT_KEYWORDS.has(normalized)) return 'merit';
            if (SLANG_KEYWORDS.has(normalized)) return 'slang';

            // 4) å«è‹±æ–‡æœ¯è¯­ï¼šsv_slang
            if (/[A-Za-z]/.test(normalized)) return 'sv_slang';

            return 'slang';
        }
        
        /**
         * æå– Vibe å…³é”®è¯ï¼ˆå¸¦åˆ†ç±»å’Œæƒé‡ï¼‰
         * @param {string} text - æ–‡æœ¬å†…å®¹
         * @param {Object} options - é€‰é¡¹ { max: number }
         * @returns {Array} - [{ phrase, category, weight }]
         */
        function extractVibeKeywords(text, { max = 15 } = {}) {
            const raw = String(text || '');
            if (!raw.trim()) return [];

            // è½»é‡é™å™ªï¼šå» code fence / inline code / URL / å¤šä½™ç©ºç™½
            let cleaned = raw
                .replace(/```[\s\S]*?```/g, ' ')
                .replace(/`[^`]*`/g, ' ')
                .replace(/\bhttps?:\/\/[^\s]+/gi, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            if (!cleaned) return [];

            const stopWords = new Set([
                'è¿™ä¸ª', 'å¯ä»¥', 'å®ç°', 'é€»è¾‘', 'åˆ†æ', 'ä»£ç ', 'æ¥å£', 'æŠ¥é”™', 'å¼‚å¸¸', 'é”™è¯¯', 'è¿”å›', 'è¯·æ±‚', 'æ•°æ®',
                'å‡½æ•°', 'å˜é‡', 'å¯¹è±¡', 'æ•°ç»„', 'å­—ç¬¦ä¸²', 'æ•°å­—', 'ç±»å‹', 'ç»„ä»¶', 'é¡µé¢', 'å‰ç«¯', 'åç«¯',
                'the', 'a', 'an', 'is', 'are', 'am', 'was', 'were', 'be', 'been', 'being',
                'and', 'that', 'this', 'with', 'from', 'into', 'just', 'like', 'very',
            ]);

            const freq = new Map();
            const bump = (p) => {
                const s = String(p || '').trim();
                if (!s) return;
                if (/^[0-9]+$/.test(s)) return;
                if (/^[\p{P}\p{S}]+$/u.test(s)) return;
                if (!/[\u4e00-\u9fff]/.test(s) && /[A-Za-z]/.test(s)) {
                    const parts = s.toLowerCase().split(/\s+/g).filter(Boolean);
                    if (parts.length > 0 && parts.every((w) => stopWords.has(w))) return;
                }
                freq.set(s, (freq.get(s) || 0) + 1);
            };

            const sentences = cleaned
                .split(/[ã€‚\.ï¼!ï¼Ÿ\?\n\rï¼›;ï¼Œ,]+/g)
                .map(s => String(s || '').trim())
                .filter(s => s.length >= 3);

            for (const s of sentences) {
                // ä¸­æ–‡ï¼š4-10 è¿ç»­æ±‰å­—
                const zhRuns = s.match(/[\u4e00-\u9fff]{4,}/g) || [];
                for (const run of zhRuns) {
                    const r = String(run);
                    for (let n = 4; n <= 10; n++) {
                        if (r.length < n) continue;
                        for (let i = 0; i <= r.length - n; i++) bump(r.slice(i, i + n));
                    }
                }

                // è‹±æ–‡ï¼š3-6 ä¸ªå•è¯çŸ­è¯­
                const enWords = (s.match(/[A-Za-z]+(?:'[A-Za-z]+)?/g) || [])
                    .map(w => w.toLowerCase())
                    .filter(Boolean);
                for (let n = 3; n <= 6; n++) {
                    if (enWords.length < n) continue;
                    for (let i = 0; i <= enWords.length - n; i++) bump(enWords.slice(i, i + n).join(' '));
                }
            }

            return Array.from(freq.entries())
                .sort((a, b) => (b[1] - a[1]) || (b[0].length - a[0].length) || (a[0] > b[0] ? 1 : -1))
                .slice(0, Math.max(1, Math.min(25, Number(max) || 15)))
                .map(([phrase, count]) => ({
                    phrase,
                    category: categorizeKeyword(phrase),
                    weight: Number(count) || 1,
                }));
        }

        // ==========================================
        // å›½æ°‘çº§è¯ç»„ï¼ˆ3-5å­—/è¯ï¼‰ï¼šæœ¬åœ°ç»Ÿè®¡åä¸ŠæŠ¥åˆ° Supabase æ±‡æ€»
        // - ä¸­æ–‡ï¼šè¿ç»­æ±‰å­— run å†… 3-5 å­—çª—å£
        // - è‹±æ–‡ï¼š3-5 ä¸ªå•è¯ n-gram
        // - åªå–æœ¬æ¬¡æ–‡æœ¬å†… topNï¼Œé¿å…ç»™åç«¯é€ æˆå‹åŠ›
        // ==========================================
        function extractNationalPhrases(text, opts = {}) {
            const max = Math.max(1, Math.min(25, Number(opts.max) || 12));
            const cleaned = String(text || '').replace(/\s+/g, ' ').trim();
            if (!cleaned) return [];

            const freq = new Map();
            const bump = (p) => {
                const s = String(p || '').trim();
                if (!s) return;
                if (s.length < 3) return;
                if (s.length > 64) return;
                if (/^[0-9]+$/.test(s)) return;
                if (/^[\p{P}\p{S}]+$/u.test(s)) return;
                // è¿‡æ»¤ url/ä»£ç å‘³
                const low = s.toLowerCase();
                if (low.includes('http://') || low.includes('https://') || low.includes('```')) return;
                freq.set(s, (freq.get(s) || 0) + 1);
            };

            const segments = cleaned.split(/[ã€‚\.ï¼!ï¼Ÿ\?\n\rï¼›;ï¼Œ,]+/g).map(s => String(s || '').trim()).filter(Boolean);

            for (const seg of segments) {
                // ä¸­æ–‡ï¼š3-5 å­—
                const zhRuns = seg.match(/[\u4e00-\u9fff]{3,}/g) || [];
                for (const run of zhRuns) {
                    const r = String(run);
                    for (let n = 3; n <= 5; n++) {
                        if (r.length < n) continue;
                        for (let i = 0; i <= r.length - n; i++) bump(r.slice(i, i + n));
                    }
                }

                // è‹±æ–‡ï¼š3-5 è¯
                const enWords = (seg.match(/[A-Za-z]+(?:'[A-Za-z]+)?/g) || [])
                    .map(w => w.toLowerCase())
                    .filter(Boolean);
                for (let n = 3; n <= 5; n++) {
                    if (enWords.length < n) continue;
                    for (let i = 0; i <= enWords.length - n; i++) bump(enWords.slice(i, i + n).join(' '));
                }
            }

            return Array.from(freq.entries())
                .sort((a, b) => (b[1] - a[1]) || (b[0].length - a[0].length))
                .slice(0, max)
                .map(([phrase, count]) => ({
                    phrase,
                    category: 'phrase',
                    weight: Math.max(1, Math.min(5, Number(count) || 1)),
                }));
        }

        async function reportSlangFromText(text, location) {
            try {
                const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || '';
                const API_ENDPOINT = apiEndpoint.trim().endsWith('/') ? apiEndpoint.trim() : `${apiEndpoint.trim()}/`;
                
                // è·å–ç”¨æˆ·æŒ‡çº¹
                const fingerprint = (() => {
                    try {
                        return localStorage.getItem('user_fingerprint') || null;
                    } catch (e) {
                        return null;
                    }
                })();
                
                const keywords = extractVibeKeywords(text, { max: 15 }) || [];
                const phrases = extractNationalPhrases(text, { max: 12 }) || [];

                // åˆå¹¶å»é‡ï¼ˆåŒ phrase å–æ›´å¤§ weightï¼›category ä¼˜å…ˆä¿ç•™ phraseï¼‰
                const merged = new Map();
                const put = (it) => {
                    const k = String(it?.phrase || '').trim();
                    if (!k) return;
                    const prev = merged.get(k);
                    if (!prev) {
                        merged.set(k, it);
                        return;
                    }
                    const w0 = Number(prev?.weight) || 1;
                    const w1 = Number(it?.weight) || 1;
                    const cat = (prev?.category === 'phrase' || it?.category === 'phrase') ? 'phrase' : (prev?.category || it?.category);
                    merged.set(k, { phrase: k, category: cat, weight: Math.max(w0, w1) });
                };
                keywords.forEach(put);
                phrases.forEach(put);

                const finalKeywords = Array.from(merged.values()).slice(0, 25);
                if (finalKeywords.length === 0) return;
                
                // ä½¿ç”¨æ–°ç‰ˆæ¥å£ /api/v2/report-vibe
                const payload = {
                    keywords: finalKeywords,
                    fingerprint: fingerprint || null,
                    timestamp: new Date().toISOString(),
                    region: location || 'Global',
                };
                
                // sendBeacon æœ€ä¸æ‰“æ‰°ä¸»çº¿ç¨‹/é¡µé¢å¸è½½
                if (typeof navigator !== 'undefined' && navigator && typeof navigator.sendBeacon === 'function') {
                    try {
                        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
                        navigator.sendBeacon(`${API_ENDPOINT}api/v2/report-vibe`, blob);
                        return;
                    } catch {
                        // fallthrough
                    }
                }
                
                // fetch keepalive å…œåº•
                var _vfp = '';
                try { _vfp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                await fetch(`${API_ENDPOINT}api/v2/report-vibe?fingerprint=${encodeURIComponent(_vfp)}&_t=${Date.now()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    keepalive: true,
                    body: JSON.stringify(payload),
                });
            } catch (e) {
                // é™é»˜å¤±è´¥
            }
        }

        // ==========================================
        // å¥å¼ä¸ŠæŠ¥ï¼šåªæ”¶é›†â€œçœŸå®ç”¨æˆ·è¾“å…¥â€é‡Œçš„çŸ­å¥
        // - ä¸è¦å¤ªé•¿ï¼š6-120 å­—ç¬¦ï¼ˆåç«¯å†æ¬¡è¿‡æ»¤åˆ° 140ï¼‰
        // - ä¸å‡‘ 10ï¼šåªä¸ŠæŠ¥å®é™…å‡ºç°è¿‡çš„å¥å­ï¼ˆæŒ‰æœ¬æ¬¡æ–‡æœ¬å†…é¢‘æ¬¡ topï¼‰
        // ==========================================
        function extractRealSentences(text, opts = {}) {
            const maxItems = Math.max(1, Math.min(25, Number(opts.maxItems) || 12));
            const minLen = Math.max(4, Math.min(20, Number(opts.minLen) || 6));
            const maxLen = Math.max(40, Math.min(160, Number(opts.maxLen) || 120));

            const normalize = (s) => {
                const raw = String(s ?? '').replace(/\s+/g, ' ').trim();
                return raw
                    .replace(/^[\s"'â€œâ€â€˜â€™`~!ï¼?ï¼Ÿã€‚.,ï¼Œ;ï¼›:ï¼š()\[\]{}<>-]+/g, '')
                    .replace(/[\s"'â€œâ€â€˜â€™`~!ï¼?ï¼Ÿã€‚.,ï¼Œ;ï¼›:ï¼š()\[\]{}<>-]+$/g, '')
                    .trim();
            };

            const isBad = (s) => {
                if (!s) return true;
                if (s.length < minLen) return true;
                if (s.length > maxLen) return true;
                const low = s.toLowerCase();
                if (low.includes('http://') || low.includes('https://')) return true;
                if (low.includes('```')) return true;
                const sym = (s.match(/[{}[\]<>$=_*\\|]/g) || []).length;
                if (sym >= 6) return true;
                return false;
            };

            const parts = String(text || '')
                .split(/[\n\r]+|[ã€‚ï¼ï¼Ÿ!?ï¼›;]+/g)
                .map((x) => normalize(x))
                .filter((x) => !isBad(x));

            const freq = new Map();
            for (const p of parts) freq.set(p, (freq.get(p) || 0) + 1);

            // åªå–æœ¬æ¬¡æ–‡æœ¬å†…æœ€å¸¸å‡ºç°çš„çŸ­å¥ï¼›è‹¥å®Œå…¨æ— é‡å¤ï¼Œä¹Ÿå…è®¸ count=1 çš„ top1-3ï¼ˆä¸å¼ºè¡Œå‡‘ 10ï¼‰
            const ranked = Array.from(freq.entries())
                .map(([sentence, count]) => ({ sentence, count: Number(count) || 1 }))
                .sort((a, b) => (b.count - a.count) || (a.sentence.length - b.sentence.length));

            const repeated = ranked.filter((x) => x.count >= 2);
            const list = (repeated.length > 0 ? repeated : ranked.slice(0, 3)).slice(0, maxItems);
            return list;
        }

        async function reportSentencesFromText(text, location) {
            try {
                const apiEndpoint = document.querySelector('meta[name="api-endpoint"]')?.content || '';
                const API_ENDPOINT = apiEndpoint.trim().endsWith('/') ? apiEndpoint.trim() : `${apiEndpoint.trim()}/`;

                const items = extractRealSentences(text, { maxItems: 12, minLen: 6, maxLen: 120 });
                if (!items || items.length === 0) return;

                const payload = {
                    region: location || 'Global',
                    items: items, // [{sentence,count}]
                    timestamp: new Date().toISOString(),
                };

                // sendBeacon ä¼˜å…ˆï¼ˆä¸æ‰“æ‰°ä¸»çº¿ç¨‹/é¡µé¢å¸è½½ï¼‰
                if (typeof navigator !== 'undefined' && navigator && typeof navigator.sendBeacon === 'function') {
                    try {
                        const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
                        navigator.sendBeacon(`${API_ENDPOINT}api/report-sentences`, blob);
                        return;
                    } catch {
                        // fallthrough
                    }
                }

                var _sfp = '';
                try { _sfp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                await fetch(`${API_ENDPOINT}api/report-sentences?fingerprint=${encodeURIComponent(_sfp)}&_t=${Date.now()}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    keepalive: true,
                    body: JSON.stringify(payload),
                });
            } catch {
                // é™é»˜å¤±è´¥
            }
        }

        // è§¦å‘å…¥å£1ï¼šçˆ¶é¡µé¢ postMessage ä¼ å…¥åˆ†æç»“æœ
        // çº¦å®šæ¶ˆæ¯æ ¼å¼ï¼š{ type: 'VIBE_ANALYSIS_RESULT', text: string, location?: string }
        window.addEventListener('message', (event) => {
            try {
                const data = event?.data;
                if (!data || data.type !== 'VIBE_ANALYSIS_RESULT') return;
                const text = data.text || '';
                const location = data.location || 'GLOBAL';
                // æ³¨å…¥â€œæœ¬æ¬¡åˆ†æâ€çš„ä¸ªäººå¥å¼æ–‡æœ¬æºï¼ˆç”¨äºä¸ªäººåŒºçœ‹æ¿ï¼‰
                try {
                    window.lastAnalysisText = String(text || '');
                    window.lastAnalysisLocation = String(location || 'GLOBAL');
                    // ä¼˜å…ˆåˆ·æ–°å¥å¼çœ‹æ¿ï¼ˆä¸é˜»å¡ä¸ŠæŠ¥ï¼‰
                    try { window.loadWordCloud && window.loadWordCloud(); } catch (e2) { /* ignore */ }
                } catch (e1) { /* ignore */ }
                void reportSlangFromText(text, location);
                void reportSentencesFromText(text, location);
            } catch (e) {
                // ignore
            }
        });

        // è§¦å‘å…¥å£2ï¼šå½“å‰é¡µé¢è‹¥å­˜åœ¨ window.lastAnalysisText / window.lastAnalysisLocationï¼Œå¯ç›´æ¥è°ƒç”¨
        window.reportSlangFromLastAnalysis = function () {
            try {
                const text = window.lastAnalysisText || '';
                const location = window.lastAnalysisLocation || 'GLOBAL';
                return reportSlangFromText(text, location);
            } catch (e) {
                return Promise.resolve();
            }
        };

        // å¥å¼ä¸ŠæŠ¥å…¥å£ï¼ˆå¯é€‰ï¼‰ï¼šä¾›å¤–éƒ¨ç›´æ¥è§¦å‘
        window.reportSentencesFromLastAnalysis = function () {
            try {
                const text = window.lastAnalysisText || '';
                const location = window.lastAnalysisLocation || 'GLOBAL';
                return reportSentencesFromText(text, location);
            } catch (e) {
                return Promise.resolve();
            }
        };
        
        /**
         * å…¨å±€å‡½æ•°ï¼šåˆ·æ–°ç”¨æˆ·æ•°æ®ï¼ˆä¾› index.html è°ƒç”¨ï¼‰
         * å½“ index.html æäº¤èŠå¤©è®°å½•åï¼Œå¯ä»¥è°ƒç”¨æ­¤å‡½æ•°åˆ·æ–° stats2.html çš„æ•°æ®
         * ã€GitHub OAuth ä¼˜å…ˆã€‘ä¼˜å…ˆä» supabase.auth.getSession() ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ ID
         * ã€ä¿®å¤ AbortErrorã€‘æ·»åŠ é˜²é‡å¤è°ƒç”¨æœºåˆ¶ï¼Œé¿å…é¡µé¢åˆ·æ–°æ—¶å¤šæ¬¡è°ƒç”¨å¯¼è‡´å†²çª
         */
        // é˜²é‡å¤è°ƒç”¨æ ‡å¿—
        /** è·å–ç”¨æˆ·å›½å®¶ç ï¼ˆcountry-summary çš„ cc å‚æ•°ï¼‰ï¼šcurrent_location ä¼˜å…ˆï¼Œä¸èƒ½ç¡¬ç¼–ç  */
        window.safeGetCountry = function(u) {
            if (!u || typeof u !== 'object') return 'US';
            const cc = (u.current_location || u.manual_location || u.country_code || u.ip_location || 'US');
            const s = String(cc).trim().toUpperCase();
            return (s.length >= 2 ? s.substring(0, 2) : s) || 'US';
        };

        let isRefreshingUserStats = false;
        let refreshUserStatsAbortController = null;
        
        window.refreshUserStats = async function() {
            if (isGlobalInitializing && !window.__allowInitCall) return;
            
            // ã€ç­‰å¾…èµ„æºåŠ è½½ã€‘ç¡®ä¿ ECharts åŠå…¶ Locale å·²ç»å‡†å¤‡å¥½ï¼Œé˜²æ­¢ "zh not found"
            let resourceWaitStart = Date.now();
            while (!window._resourcesLoaded && (Date.now() - resourceWaitStart < 5000)) {
                if (window._resourceError) {
                    console.error('[Refresh] âŒ èµ„æºåŠ è½½å¤±è´¥ï¼Œæ”¾å¼ƒåˆ·æ–°:', window._resourceError);
                    return;
                }
                console.log('[Refresh] â³ ç­‰å¾…èµ„æºåŠ è½½...');
                await new Promise(r => setTimeout(r, 200));
            }
            if (!window._resourcesLoaded && typeof echarts === 'undefined') {
                 console.warn('[Refresh] âš ï¸ èµ„æºåŠ è½½è¶…æ—¶æˆ–æœªå®šä¹‰ echartsï¼Œå°è¯•ç»§ç»­...');
            }

            // ã€ä¿®å¤ AbortErrorã€‘å¦‚æœæ­£åœ¨åˆ·æ–°ï¼Œå–æ¶ˆä¹‹å‰çš„è¯·æ±‚
            if (isRefreshingUserStats) {
                console.log('[Refresh] âš ï¸ æ£€æµ‹åˆ°é‡å¤è°ƒç”¨ï¼Œå–æ¶ˆä¹‹å‰çš„åˆ·æ–°è¯·æ±‚...');
                if (refreshUserStatsAbortController) {
                    refreshUserStatsAbortController.abort();
                }
                // å–æ¶ˆåç›´æ¥è¿”å›ï¼Œé¿å…é‡å¤æ‰§è¡Œ
                return;
            }
            
            // åˆ›å»ºæ–°çš„ AbortController
            refreshUserStatsAbortController = new AbortController();
            isRefreshingUserStats = true;
            
            console.log('[Refresh] ğŸ”„ æ”¶åˆ°åˆ·æ–°è¯·æ±‚ï¼Œé‡æ–°åŠ è½½æ•°æ®...');
            try {
                // æ•°æ®ä¼˜å…ˆçº§ï¼šå…ˆæ‰§è¡Œ updateMsgDotï¼ˆæ›´æ–°ç§ä¿¡çº¢ç‚¹ï¼‰ï¼Œå†æ‰§è¡Œæ˜“æŠ¥é”™çš„åœ°å›¾/å›¾è¡¨æ¸²æŸ“ï¼Œé˜²æ­¢ UI ç†”æ–­
                var hasNewMessageHandled = false;
                try {
                    var fp = '';
                    try { fp = localStorage.getItem('user_fingerprint') || window.fpId || ''; } catch (_) {}
                    var base = (typeof window.getApiEndpoint === 'function' ? window.getApiEndpoint() : document.querySelector('meta[name="api-endpoint"]')?.content || '') || '';
                    base = (base && base.replace && base.replace(/\/$/, '')) ? base.replace(/\/$/, '') : base;
                    var statsUrl = base ? (base + '/api/v2/stats?fingerprint=' + encodeURIComponent(fp || '') + '&_t=' + Date.now()) : '';
                    if (statsUrl) {
                        var statsRes = await fetch(statsUrl);
                        var statsJson = statsRes.ok ? (await statsRes.json().catch(function() { return {}; })) : {};
                        var hasNew = !!(statsJson && statsJson.hasNewMessage === true);
                        // é›¶åŠŸè€—çº¢ç‚¹ï¼šæ‹¿åˆ°æ•°æ®åç«‹åˆ»æ›´æ–° #msg-dot
                        if (typeof window.updateMsgDot === 'function') window.updateMsgDot(hasNew);
                        else if (typeof window.updateInboxRedDotFromApi === 'function') window.updateInboxRedDotFromApi(hasNew);
                        hasNewMessageHandled = true;
                        // hasNewMessage ä¸ºçœŸä¸”è¿æ¥æ–­å¼€æ—¶ï¼Œé™é»˜è°ƒç”¨ startRealtimeListener()
                        if (hasNew && (typeof presenceChannel === 'undefined' || presenceChannel == null) && typeof startRealtimeListener === 'function') {
                            startRealtimeListener().catch(function() {});
                        }
                    }
                } catch (statsErr) { /* ä¸é˜»å¡ä¸»æµç¨‹ */ }
                // æœ‰ç§ä¿¡æ—¶çº¢ç‚¹ä¿æŒäº®ï¼šæœªè¯·æ±‚æˆ–è¯·æ±‚å¤±è´¥æ—¶ä¸è°ƒç”¨ updateMsgDot(false)ï¼Œé¿å…è¯¯å…³çº¢ç‚¹

                // çº¢ç‚¹å·²æ›´æ–°ï¼Œå†æ‰§è¡Œå¯èƒ½å‡ºé”™çš„åœ°å›¾/æ’åæ¸²æŸ“ï¼ˆä¸ç­‰å¾…åœ°å›¾æ¸²æŸ“ï¼‰
                try {
                    await fetchData();
                } catch (fetchDataError) {
                    // å¦‚æœæ˜¯å–æ¶ˆé”™è¯¯ï¼Œç›´æ¥è¿”å›
                    if (fetchDataError.name === 'AbortError' || fetchDataError.message?.includes('aborted')) {
                        console.log('[Refresh] â„¹ï¸ æ•°æ®è·å–è¢«å–æ¶ˆ');
                        return;
                    }
                    throw fetchDataError;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²è¢«å–æ¶ˆ
                if (refreshUserStatsAbortController?.signal.aborted) {
                    console.log('[Refresh] â„¹ï¸ åˆ·æ–°è¯·æ±‚å·²è¢«å–æ¶ˆ');
                    return;
                }
                
                // ã€GitHub OAuth ä¼˜å…ˆã€‘ä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ç™»å½•ä¼šè¯
                let currentUser = null;
                let matchedByGitHub = false;
                
                if (supabaseClient) {
                    try {
                        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                        
                        if (!sessionError && session && session.user) {
                            const githubUserId = session.user.id;
                            console.log('[Refresh] âœ… æ£€æµ‹åˆ° GitHub OAuth ä¼šè¯ï¼Œuser_id:', githubUserId.substring(0, 8) + '...');
                            
                            // ä¼˜å…ˆä» allData ä¸­æŸ¥æ‰¾ user_id åŒ¹é…çš„è®°å½•
                            const allData = window.allData || [];
                            currentUser = allData.find(user => user.id === githubUserId);
                            
                            if (currentUser) {
                                matchedByGitHub = true;
                                console.log('[Refresh] âœ… é€šè¿‡ GitHub User ID æ‰¾åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                            } else {
                            // å¦‚æœ allData ä¸­æ²¡æœ‰ï¼Œå°è¯•ä» Supabase ç›´æ¥æŸ¥è¯¢
                            // ã€æ•°æ®æºè¿ç§»ã€‘ä½¿ç”¨ç»Ÿä¸€è§†å›¾ v_unified_analysis_v2ï¼ˆå« vibe_rankã€vibe_percentileï¼‰
                            console.log('[Refresh] ğŸ” allData ä¸­æœªæ‰¾åˆ°ï¼Œå°è¯•ä» Supabase æŸ¥è¯¢ï¼ˆv_unified_analysis_v2ï¼‰...');
                            const { data: dbUser, error: queryError } = await supabaseClient
                                .from('v_unified_analysis_v2')
                                .select('*')
                                .eq('id', githubUserId)
                                .maybeSingle();
                                
                                if (!queryError && dbUser) {
                                    currentUser = dbUser;
                                    matchedByGitHub = true;
                                    
                                    // æ·»åŠ åˆ° allData
                                    const existingIndex = allData.findIndex(item => item.id === githubUserId);
                                    if (existingIndex !== -1) {
                                        allData[existingIndex] = { ...allData[existingIndex], ...dbUser };
                                    } else {
                                        allData.push(dbUser);
                                    }
                                    window.allData = allData;
                                    
                                    console.log('[Refresh] âœ… ä» Supabase æŸ¥è¯¢åˆ°ç”¨æˆ·:', dbUser.user_name || dbUser.name);
                                }
                            }
                        }
                    } catch (authError) {
                        console.warn('[Refresh] âš ï¸ æ£€æŸ¥ GitHub OAuth ä¼šè¯å¤±è´¥:', authError);
                    }
                }
                
                // ã€é™çº§æ–¹æ¡ˆã€‘å¦‚æœæ²¡æœ‰ GitHub OAuth ä¼šè¯ï¼Œä½¿ç”¨ fingerprint åŒ¹é…
                if (!currentUser) {
                    console.log('[Refresh] ğŸ”„ æœªæ‰¾åˆ° GitHub OAuth ç”¨æˆ·ï¼Œå°è¯•ä½¿ç”¨ fingerprint åŒ¹é…...');
                    
                    const normalizeFingerprint = (fp) => {
                        if (!fp) return '';
                        return String(fp).trim().toLowerCase();
                    };
                    
                    let currentFingerprint = null;
                    try {
                        currentFingerprint = localStorage.getItem('user_fingerprint');
                    } catch (e) {
                        console.warn('[Refresh] âš ï¸ è¯»å– localStorage å¤±è´¥:', e);
                    }
                    
                    const normalizedCurrentFingerprint = normalizeFingerprint(currentFingerprint);
                    const allData = window.allData || [];
                    
                    if (normalizedCurrentFingerprint && allData.length > 0) {
                        currentUser = allData.find(user => {
                            const userFingerprint = normalizeFingerprint(user.fingerprint || user.user_fingerprint);
                            const userIdentity = normalizeFingerprint(user.user_identity);
                            return (userFingerprint && userFingerprint === normalizedCurrentFingerprint) ||
                                   (userIdentity && userIdentity === normalizedCurrentFingerprint);
                        });
                        
                        if (currentUser) {
                            console.log('[Refresh] âœ… é€šè¿‡ fingerprint æ‰¾åˆ°ç”¨æˆ·:', currentUser.user_name || currentUser.name);
                            
                            // ã€Master Keyã€‘ä¸€æ—¦é€šè¿‡æŒ‡çº¹æ‰¾åˆ°æœ‰æ•°æ®çš„ç”¨æˆ·ï¼Œå°†å…¶æŒ‡çº¹æ°¸ä¹…å­˜å…¥æœ¬åœ°
                            const totalMsgs = currentUser.total_messages || currentUser.stats?.total_messages || 0;
                            if (totalMsgs > 0 && currentUser.fingerprint) {
                                localStorage.setItem('last_successful_fingerprint', currentUser.fingerprint);
                                console.log('[Refresh] ğŸ”‘ å·²å½•å…¥ Master Key:', currentUser.fingerprint.substring(0, 8) + '...');
                            }
                        }
                    }
                }
                
                if (currentUser) {
                    // ã€åœ°ç†é”ã€‘ä¼˜å…ˆè¯»å– localStorage ä¸­çš„ manual_locationï¼ˆç»‘å®š GitHubï¼‰
                    // åªè¦ loc_locked æˆ– loc_fixed ä¸º trueï¼Œå¿…é¡»ä¼˜å…ˆè¯»å–æœ¬åœ°ä¿å­˜çš„ç»çº¬åº¦ï¼Œç¦æ­¢è¢« IP-API çš„è¿”å›ç»“æœè¦†ç›–
                    const isLocked = localStorage.getItem('loc_locked') === 'true' || localStorage.getItem('loc_fixed') === 'true';
                    if (isLocked) {
                        const data = window.currentUserData;
                        const mlat = data?.manual_lat ?? (localStorage.getItem('manual_lat') ? Number(localStorage.getItem('manual_lat')) : undefined);
                        const mlng = data?.manual_lng ?? (localStorage.getItem('manual_lng') ? Number(localStorage.getItem('manual_lng')) : undefined);
                        const mloc = (data?.manual_location ?? currentUser.manual_location ?? (localStorage.getItem('manual_location') || '').trim()) || '';
                        if (currentUser && typeof currentUser === 'object') {
                            if (mlat != null && !isNaN(mlat)) currentUser.manual_lat = mlat;
                            if (mlng != null && !isNaN(mlng)) currentUser.manual_lng = mlng;
                            if (mloc && String(mloc).trim() !== '') currentUser.manual_location = String(mloc).trim();
                            currentUser.country_code = currentUser.manual_location || currentUser.ip_location;
                        }
                        console.log('[Refresh] ğŸ”’ æ£€æµ‹åˆ°åœ°ç†é”ï¼Œä¼˜å…ˆä½¿ç”¨æœ¬åœ°åæ ‡:', { mlat, mlng, mloc });
                    }
                    window.currentUser = currentUser;
                    window.currentUserData = currentUser;
                    window.currentUserMatchedByFingerprint = !matchedByGitHub; // å¦‚æœé€šè¿‡ GitHub åŒ¹é…ï¼Œåˆ™è®¾ä¸º false
                    
                    // ã€Master Keyã€‘å¦‚æœå½“å‰ç”¨æˆ·æœ‰æ•°æ®ä¸”å·²è¯†åˆ«ï¼Œç¡®ä¿æŒä¹…åŒ–å­˜å‚¨å…¶æŒ‡çº¹ï¼ˆä½œä¸ºä¸‡èƒ½é’¥åŒ™ï¼‰
                    const totalMsgs = currentUser.total_messages || currentUser.stats?.total_messages || 0;
                    if (totalMsgs > 0 && currentUser.fingerprint) {
                        localStorage.setItem('last_successful_fingerprint', currentUser.fingerprint);
                    }
                    
                    // åˆ·æ–°æ’åå¡ç‰‡
                    renderRankCards(currentUser);
                    
                    // å¦‚æœå·¦ä¾§æŠ½å±‰å·²æ‰“å¼€ï¼Œç”¨å½“å‰ç”¨æˆ·ï¼ˆå·²åˆå¹¶æ ¡å‡†ï¼‰åˆ·æ–°ï¼›è‹¥å·²é”å®šæ ¡å‡†åˆ™å¼ºåˆ¶æ˜¾ç¤ºæ ¡å‡†å›½å®¶ï¼Œé¿å…ç«Ÿæ€å¯¼è‡´åˆ‡å› IP å®šä½
                    const leftDrawer = document.getElementById('left-drawer');
                    const leftBody = document.getElementById('left-drawer-body');
                    if (leftDrawer && leftBody) {
                        const isDrawerOpen = leftDrawer.classList.contains('active');
                        if (isDrawerOpen) {
                            // âœ… åˆ·æ–°æ—¶ cc å¿…é¡»ç”¨ç”¨æˆ·çœŸå®çš„ current_locationï¼Œè¿™æ · country-summary å’Œ myCountryRanks æ‰èƒ½è¿”å›æ­£ç¡®æœ¬å›½ç»Ÿè®¡
                            const currentCC = (typeof window.safeGetCountry === 'function')
                                ? window.safeGetCountry(window.currentUserData || currentUser)
                                : (currentUser.current_location || currentUser.manual_location || currentUser.country_code || currentDrawerCountry?.code || 'US');
                            const inCountryView = (typeof currentViewState === 'string' && currentViewState === 'COUNTRY');
                            const drawerCode = inCountryView
                                ? (currentDrawerCountry?.code || currentCC)
                                : currentCC;
                            const drawerName = drawerCode && (typeof countryNameMap !== 'undefined' && countryNameMap[drawerCode])
                                ? (currentLang === 'zh' ? countryNameMap[drawerCode].zh : countryNameMap[drawerCode].en)
                                : (currentDrawerCountry.name || drawerCode);
                            if (drawerCode) {
                                // å¦‚æœç”¨æˆ·æ­£åœ¨çœ‹å›½å®¶é€è§†ï¼ˆUS/CNï¼‰ï¼Œåˆ·æ–°ç”¨æˆ·æ•°æ®æ—¶åªæ›´æ–°å·¦æŠ½å±‰å†…å®¹ï¼Œä¿ç•™å³ä¾§å›½å®¶é¢æ¿
                                const preserve = inCountryView;
                                showDrawersWithCountryData(drawerCode, drawerName || drawerCode, undefined, { preserveCountryPanel: preserve });
                            }
                        }
                    }

                    // ã€åœ°å›¾è”åŠ¨ã€‘ä¼˜å…ˆä½¿ç”¨ manual åæ ‡ï¼Œå¦åˆ™ç”¨ lat/lngï¼›æœ‰åæ ‡åˆ™æ›´æ–°åœ°å›¾ä¸æŒä¹…å…‰æ ‡
                    const lat = (currentUser.manual_lat != null && !isNaN(currentUser.manual_lat))
                        ? Number(currentUser.manual_lat)
                        : (currentUser.lat != null && !isNaN(currentUser.lat) ? Number(currentUser.lat) : null);
                    const lng = (currentUser.manual_lng != null && !isNaN(currentUser.manual_lng))
                        ? Number(currentUser.manual_lng)
                        : (currentUser.lng != null && !isNaN(currentUser.lng) ? Number(currentUser.lng) : null);
                    if (lat !== null && lng !== null) {
                        // ã€ä¿®å¤ã€‘æ£€æŸ¥é”å®šçŠ¶æ€ï¼Œé˜²æ­¢è¦†ç›–ç”¨æˆ·æ‰‹åŠ¨æ ¡å‡†çš„ä½ç½®
                        const isLocked = localStorage.getItem('loc_locked') === 'true';
                        if (isLocked) {
                            console.log('[Refresh] ğŸ”’ æ£€æµ‹åˆ°åæ ‡å·²é”å®šï¼Œè·³è¿‡è‡ªåŠ¨æ›´æ–°');
                        } else {
                            console.log('[Refresh] ğŸ—ºï¸ æ£€æµ‹åˆ°ç”¨æˆ·åæ ‡ï¼ˆä¼˜å…ˆ manualï¼‰ï¼Œè§¦å‘åœ°å›¾è”åŠ¨:', { lat, lng });
                        try {
                            if (mapChart && typeof mapChart.setOption === 'function') {
                                const currentOption = mapChart.getOption();
                                if (currentOption && currentOption.geo && Array.isArray(currentOption.geo) && currentOption.geo.length > 0) {
                                    const updatedGeo = currentOption.geo.map(geo => ({
                                        ...geo,
                                        center: [lng, lat],
                                        zoom: 3
                                    }));
                                    mapChart.setOption({ geo: updatedGeo }, { notMerge: false, lazyUpdate: false });
                                    console.log('[Refresh] âœ… åœ°å›¾ä¸­å¿ƒå·²æ›´æ–°åˆ°ç”¨æˆ·ä½ç½®');
                                }
                            }
                            if (typeof triggerMapPulse === 'function') {
                                const githubUsername = currentUser.user_name || currentUser.name || 'YOU';
                                const avatarUrl = currentUser.user_metadata?.avatar_url ||
                                    (githubUsername ? getGitHubAvatarUrl(githubUsername) : null) || DEFAULT_AVATAR;
                                const statusConfig = USER_STATUSES[currentUserStatus] || USER_STATUSES.idle;
                                const pulseColor = statusConfig.status_color || '#00ff41';
                                triggerMapPulse(lng, lat, 'YOU', pulseColor, avatarUrl, githubUsername);
                            console.log('[Refresh] âœ… åœ°å›¾è„‰å†²æ•ˆæœå·²è§¦å‘');
                        }
                    } catch (mapError) {
                        console.warn('[Refresh] âš ï¸ åœ°å›¾è”åŠ¨å¤±è´¥:', mapError);
                    }
                        } // isLocked å—ç»“æŸ
                    } else {
                        console.log('[Refresh] â„¹ï¸ ç”¨æˆ·åæ ‡ä¸å®Œæ•´ï¼Œè·³è¿‡åœ°å›¾è”åŠ¨');
                    }
                    console.log('[Refresh] âœ… ç”¨æˆ·æ•°æ®å·²åˆ·æ–°', matchedByGitHub ? '(GitHub OAuth)' : '(Fingerprint)');
                } else {
                    console.log('[Refresh] âš ï¸ æœªæ‰¾åˆ°å½“å‰ç”¨æˆ·æ•°æ®');
                }
            } catch (error) {
                // ã€ä¿®å¤ AbortErrorã€‘ç‰¹æ®Šå¤„ç† AbortError
                if (error.name === 'AbortError' || error.message?.includes('aborted')) {
                    console.log('[Refresh] â„¹ï¸ åˆ·æ–°è¯·æ±‚è¢«å–æ¶ˆï¼ˆå¯èƒ½æ˜¯é¡µé¢åˆ·æ–°å¯¼è‡´ï¼‰');
                } else {
                    // ã€æ ¸å¿ƒè¯Šæ–­ã€‘è¾“å‡ºå®Œæ•´é”™è¯¯å¯¹è±¡ï¼Œä¾¿äºåŒºåˆ† 404ï¼ˆå‡½æ•°ä¸å­˜åœ¨ï¼‰vs 403ï¼ˆæ— æƒé™ï¼‰
                    const statusMatch = (error?.message || '').match(/Status:\s*(\d+)/);
                    const httpStatus = statusMatch ? statusMatch[1] : (error?.status ?? error?.response?.status ?? 'N/A');
                    console.error('[Refresh] âŒ åˆ·æ–°å¤±è´¥ - å®Œæ•´é”™è¯¯å¯¹è±¡:', {
                        name: error?.name,
                        message: error?.message,
                        httpStatus: httpStatus,
                        hint: httpStatus === '404' ? 'ï¼ˆå‡½æ•°/è·¯ç”±å¯èƒ½ä¸å­˜åœ¨ï¼‰' : (httpStatus === '403' ? 'ï¼ˆå¯èƒ½æ— æƒé™ï¼‰' : ''),
                        stack: error?.stack,
                        fullError: error
                    });
                }
            } finally {
                // æ’åè®¡ç®—ä¸­çŠ¶æ€éšè—ï¼šå¼ºåˆ¶å…³æ‰åŠ è½½å±‚
                try {
                    var loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) loadingOverlay.classList.add('hidden');
                } catch (e) { /* ignore */ }
                // é‡ç½®æ ‡å¿—
                isRefreshingUserStats = false;
                refreshUserStatsAbortController = null;
            }
        };
        
        // ç›‘å¬ storage äº‹ä»¶ï¼Œå½“å…¶ä»–é¡µé¢æ›´æ–° localStorage æ—¶è‡ªåŠ¨åˆ·æ–°
        window.addEventListener('storage', (e) => {
            if (isInitialLayoutPending) return;
            if (e.key === 'user_fingerprint' || e.key === 'github_username') {
                console.log('[Storage] ğŸ”” æ£€æµ‹åˆ° localStorage å˜åŒ–ï¼Œè§¦å‘æ•°æ®åˆ·æ–°');
                setTimeout(() => {
                    window.refreshUserStats();
                }, 500);
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç† Realtime ç›‘å¬
        window.addEventListener('beforeunload', () => {
            stopRealtimeListener();
        });
    </script>
</body>
</html>
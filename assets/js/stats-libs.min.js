/**
 * stats-libs.min.js - ç¬¬ä¸‰æ–¹ä¾èµ–ä¸ Polyfillï¼ˆECharts/WordCloud2 é…ç½®ã€èµ„æºåŠ è½½ã€eval5 é”™è¯¯å±è”½ï¼‰
 * ä¿æŒåŸæ ·ï¼Œä¸è¿›è¡Œä¸šåŠ¡é€»è¾‘ä¿®æ”¹ã€‚IIFE é¡¶éƒ¨å£°æ˜ _loc ä»¥ç»Ÿä¸€è§„èŒƒã€‚
 */
(function() {
    'use strict';
    var _loc = window.location;

    /**
     * å…¨å±€é”™è¯¯å¤„ç†ï¼šå½»åº•å±è”½ eval5 ç­‰ç¬¬ä¸‰æ–¹æ’ä»¶äº§ç”Ÿçš„æŠ¥é”™
     * ä¸¥ç¦å¯¹ _loc è¿›è¡Œä»»ä½•å±æ€§èµ‹å€¼æ“ä½œ
     */
    (function () {
        var errorPatterns = [
            /eval5/i,
            /third.?party/i,
            /extension/i,
            /plugin/i,
            /Cannot create property ['"]location['"] on string/i,
            /Cannot set property ['"]location['"]/i,
            /zero-timeout-message/i,
            /location.*on string/i,
            /property.*location.*string/i
        ];
        function isBlockedError(str) {
            if (!str) return false;
            var strLower = String(str).toLowerCase();
            for (var i = 0; i < errorPatterns.length; i++) {
                if (errorPatterns[i].test(strLower)) return true;
            }
            return false;
        }
        var _onerror = window.onerror;
        window.onerror = function (msg, url, line, col, err) {
            var fullStr = String(msg || '') + String(url || '') + (err && err.stack ? String(err.stack) : '');
            if (isBlockedError(fullStr)) return true;
            if (typeof _onerror === 'function') return _onerror.apply(this, arguments);
            return false;
        };
        window.addEventListener('error', function (ev) {
            var fullStr = String(ev.message || '') + String(ev.filename || '') + (ev.error && ev.error.stack ? String(ev.error.stack) : '');
            if (isBlockedError(fullStr)) {
                ev.preventDefault();
                ev.stopPropagation();
                ev.stopImmediatePropagation();
                return false;
            }
        }, true);
        window.addEventListener('unhandledrejection', function (ev) {
            var reason = ev.reason;
            var fullStr = String(reason || '') + (reason && reason.stack ? String(reason.stack) : '');
            if (isBlockedError(fullStr)) {
                ev.preventDefault();
                ev.stopPropagation();
            }
        });
        if (typeof console !== 'undefined' && console.error) {
            var _originalConsoleError = console.error;
            console.error = function() {
                var args = Array.prototype.slice.call(arguments);
                var fullStr = args.map(function(arg) { return String(arg || ''); }).join(' ');
                if (isBlockedError(fullStr)) return;
                _originalConsoleError.apply(console, args);
            };
        }
    })();

    var RESOURCE_CONFIG = {
        echarts: {
            local: './lib/echarts.min.js',
            cdn: [
                'https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js',
                'https://cdn.staticfile.net/echarts/5.4.3/echarts.min.js',
                'https://unpkg.com/echarts@5.4.3/dist/echarts.min.js'
            ],
            globalCheck: 'echarts'
        },
        echartsWordCloud: {
            local: './lib/echarts-wordcloud.min.js',
            cdn: ['https://cdn.jsdelivr.net/npm/echarts-wordcloud@2/dist/echarts-wordcloud.min.js'],
            globalCheck: 'echarts'
        },
        world: {
            local: './lib/world.js',
            cdn: [
                'https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/world.js',
                'https://unpkg.com/echarts@4.9.0/map/js/world.js'
            ],
            globalCheck: null
        },
        chartjs: {
            local: './lib/chart.umd.min.js',
            cdn: [
                'https://cdn.jsdelivr.net/npm/chart.js',
                'https://cdn.staticfile.net/Chart.js/4.4.1/chart.umd.min.js'
            ],
            globalCheck: 'Chart'
        },
        tailwind: {
            local: null,
            cdn: ['https://cdn.tailwindcss.com?minify=true'],
            globalCheck: null
        },
        wordcloud2: {
            local: null,
            cdn: ['https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.0/wordcloud2.min.js'],
            globalCheck: 'WordCloud'
        }
    };

    function loadScript(url, timeout) {
        timeout = timeout || 8000;
        return new Promise(function(resolve, reject) {
            if (!url) { reject(new Error('Empty URL')); return; }
            var script = document.createElement('script');
            script.src = url;
            script.async = false;
            var isDone = false;
            script.onload = function() { isDone = true; console.log('[ğŸ“¦] åŠ è½½æˆåŠŸ:', url); resolve(url); };
            script.onerror = function() { isDone = true; reject(new Error('Load failed: ' + url)); };
            setTimeout(function() { if (!isDone) reject(new Error('Timeout: ' + url)); }, timeout);
            document.head.appendChild(script);
        });
    }

    function loadResource(name, config) {
        var errors = [];
        if (config.local) {
            try {
                return loadScript(config.local, 5000).then(function() {
                    console.log('[âœ…] ' + name + ': æœ¬åœ°èµ„æº');
                    return { source: 'local' };
                });
            } catch (err) {
                errors.push('æœ¬åœ°: ' + (err && err.message));
            }
        }
        var seq = Promise.resolve();
        for (var i = 0; i < config.cdn.length; i++) {
            (function(u) {
                seq = seq.catch(function() {
                    return loadScript(u, 10000).then(function() {
                        if (config.globalCheck && typeof window[config.globalCheck] === 'undefined')
                            throw new Error('Global not found: ' + config.globalCheck);
                        console.log('[âœ…] ' + name + ': CDN');
                        return { source: 'cdn' };
                    });
                });
            })(config.cdn[i]);
        }
        return seq.then(function(r) { return r; }, function(err) {
            throw new Error(name + ' åŠ è½½å¤±è´¥: ' + (err && err.message));
        });
    }

    window._resourceLoader = function() {
        console.group('[ğŸš€] åŠ è½½èµ„æº (ç¦»çº¿ä¼˜å…ˆ)');
        return loadResource('echarts', RESOURCE_CONFIG.echarts).then(function() {
            if (typeof echarts !== 'undefined' && echarts.registerLocale) {
                var zhLocale = {
                    time: {
                        month: ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'],
                        monthAbbr: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                        dayOfWeek: ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'],
                        dayOfWeekAbbr: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']
                    },
                    legend: { selector: { all: 'å…¨é€‰', inverse: 'åé€‰' } },
                    toolbox: {
                        brush: { title: { rect: 'çŸ©å½¢é€‰æ‹©', polygon: 'åœˆé€‰', lineX: 'æ¨ªå‘é€‰æ‹©', lineY: 'çºµå‘é€‰æ‹©', keep: 'ä¿æŒé€‰æ‹©', clear: 'æ¸…é™¤é€‰æ‹©' } },
                        dataView: { title: 'æ•°æ®è§†å›¾', lang: ['æ•°æ®è§†å›¾', 'å…³é—­', 'åˆ·æ–°'] },
                        dataZoom: { title: { zoom: 'åŒºåŸŸç¼©æ”¾', back: 'åŒºåŸŸç¼©æ”¾è¿˜åŸ' } },
                        magicType: { title: { line: 'åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾', bar: 'åˆ‡æ¢ä¸ºæŸ±çŠ¶å›¾', stack: 'åˆ‡æ¢ä¸ºå †å ', tiled: 'åˆ‡æ¢ä¸ºå¹³é“º' } },
                        restore: { title: 'è¿˜åŸ' },
                        saveAsImage: { title: 'ä¿å­˜ä¸ºå›¾ç‰‡', lang: ['å³é”®å¦å­˜ä¸ºå›¾ç‰‡'] }
                    },
                    series: {
                        typeNames: {
                            pie: 'é¥¼å›¾', bar: 'æŸ±çŠ¶å›¾', line: 'æŠ˜çº¿å›¾', scatter: 'æ•£ç‚¹å›¾', effectScatter: 'æ¶Ÿæ¼ªæ•£ç‚¹å›¾', radar: 'é›·è¾¾å›¾',
                            tree: 'æ ‘å›¾', treemap: 'çŸ©å½¢æ ‘å›¾', boxplot: 'ç®±å‹å›¾', candlestick: 'Kçº¿å›¾', k: 'Kçº¿å›¾', heatmap: 'çƒ­åŠ›å›¾',
                            map: 'åœ°å›¾', parallel: 'å¹³è¡Œåæ ‡å›¾', lines: 'çº¿å›¾', graph: 'å…³ç³»å›¾', sankey: 'æ¡‘åŸºå›¾', funnel: 'æ¼æ–—å›¾',
                            gauge: 'ä»ªè¡¨ç›˜å›¾', pictorialBar: 'è±¡å½¢æŸ±å›¾', themeRiver: 'ä¸»é¢˜æ²³æµå›¾', sunburst: 'æ—­æ—¥å›¾'
                        }
                    },
                    aria: {
                        general: { withTitle: 'è¿™æ˜¯ä¸€ä¸ªå…³äº"{title}"çš„å›¾è¡¨ã€‚', withoutTitle: 'è¿™æ˜¯ä¸€ä¸ªå›¾è¡¨,' },
                        series: {
                            single: { prefix: '', withName: 'å›¾è¡¨ç±»å‹æ˜¯{seriesType},è¡¨ç¤º{seriesName}ã€‚', withoutName: 'å›¾è¡¨ç±»å‹æ˜¯{seriesType}ã€‚' },
                            multiple: {
                                prefix: 'å®ƒç”±{seriesCount}ä¸ªå›¾è¡¨ç³»åˆ—ç»„æˆã€‚',
                                withName: 'ç¬¬{seriesId}ä¸ªç³»åˆ—æ˜¯ä¸€ä¸ªè¡¨ç¤º{seriesName}çš„{seriesType},',
                                withoutName: 'ç¬¬{seriesId}ä¸ªç³»åˆ—æ˜¯ä¸€ä¸ª{seriesType},',
                                separator: { middle: ';', end: 'ã€‚' }
                            }
                        },
                        data: {
                            allData: 'å…¶æ•°æ®æ˜¯â€”â€”', partialData: 'å…¶ä¸­,å‰{displayCnt}é¡¹æ˜¯â€”â€”',
                            withName: '{name}çš„æ•°æ®æ˜¯{value}', withoutName: '{value}',
                            separator: { middle: ',', end: '' }
                        }
                    }
                };
                ['zh', 'zh-CN', 'zh-cn', 'zh_CN', 'ZH', 'zh_cn'].forEach(function(name) {
                    try { echarts.registerLocale(name, zhLocale); } catch (e) {}
                });
                var nativeInit = echarts.init;
                echarts.init = function(dom, theme, opts) {
                    return nativeInit.apply(this, arguments);
                };
            }
            return loadResource('echartsWordCloud', RESOURCE_CONFIG.echartsWordCloud);
        }).catch(function(err) {
            console.error('[âŒ] echarts åŠ è½½å¤±è´¥:', err);
            throw err;
        }).then(function() {
            return loadResource('echartsWordCloud', RESOURCE_CONFIG.echartsWordCloud).catch(function(err) {
                console.warn('[âš ï¸] echarts-wordcloud åŠ è½½å¤±è´¥(è¯äº‘å°†æ— æ³•æ˜¾ç¤º):', err);
            });
        }).then(function() {
            return loadResource('wordcloud2', RESOURCE_CONFIG.wordcloud2).catch(function(err) {
                console.warn('[âš ï¸] wordcloud2.js åŠ è½½å¤±è´¥(æœ¬å›½è¯äº‘ä¸‰èº«ä»½å°†æ— æ³•æ˜¾ç¤º):', err);
            });
        }).then(function() {
            loadResource('world', RESOURCE_CONFIG.world).catch(function(err) {
                console.warn('[âš ï¸] world.js åŠ è½½å¤±è´¥:', err.message);
            });
            loadResource('chartjs', RESOURCE_CONFIG.chartjs).catch(function(err) {
                console.warn('[âš ï¸] chart.js åŠ è½½å¤±è´¥:', err.message);
            });
            if (RESOURCE_CONFIG.tailwind.cdn[0]) {
                loadScript(RESOURCE_CONFIG.tailwind.cdn[0], 5000).catch(function() {
                    console.warn('[âš ï¸] Tailwind CDNå¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€æ ·å¼');
                });
            }
            window._resourcesLoaded = true;
            console.log('[âœ…] æ ¸å¿ƒèµ„æºåŠ è½½å®Œæˆ');
        }).catch(function(err) {
            window._resourcesLoaded = false;
            window._resourceError = err && err.message;
            console.error('[âŒ] èµ„æºåŠ è½½å¤±è´¥:', err);
        }).finally(function() {
            console.groupEnd();
        });
    };

    window._resourceLoader().catch(function(err) {
        console.error('[âŒ] èµ„æºåŠ è½½å™¨å¼‚å¸¸:', err);
        window._resourcesLoaded = false;
    });
})();

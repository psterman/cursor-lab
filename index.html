<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Cursor 行为体检 - Vibe Coding</title>
    <!-- API 端点配置（Cloudflare Workers） -->
    <meta name="api-endpoint" content="https://cursor-clinical-analysis.psterman.workers.dev/">
    <!-- 引入必要的库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.0/wordcloud2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // #region agent log
        (function() {
            const checkChart = setInterval(function() {
                if (window.Chart || globalThis.Chart) {
                    fetch('http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:11',message:'Chart.js loaded successfully',data:{hasWindowChart:!!window.Chart,hasGlobalChart:!!globalThis.Chart,chartType:typeof(window.Chart||globalThis.Chart)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    clearInterval(checkChart);
                }
            }, 100);
            setTimeout(function() {
                if (!window.Chart && !globalThis.Chart) {
                    fetch('http://127.0.0.1:7242/ingest/77cf65a2-f6f6-400e-839c-82d53b031ba9',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:11',message:'Chart.js failed to load after 5s',data:{hasWindowChart:!!window.Chart,hasGlobalChart:!!globalThis.Chart},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                    clearInterval(checkChart);
                }
            }, 5000);
        })();
        // #endregion
    </script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LZ-string 压缩库，用于压缩分享数据 -->
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Waline 留言板 V2 -->
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css" />
    <script src="https://unpkg.com/@waline/client@v2/dist/waline.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 0; }
        
        /* Terminal Hacker Style - 极简终端系统 */
        :root {
            --bg-color: #050505;
            --card-bg: rgba(24, 24, 27, 0.8);
            --card-border: #27272a;
            --text-main: #ffffff;
            --text-dim: #71717a;
            --accent-terminal: #00ff41;
            --accent-cyan: #3b82f6;
            --glass-blur: none;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 65, 0.02) 2px,
                    rgba(0, 255, 65, 0.02) 4px
                ),
                radial-gradient(
                    circle,
                    rgba(0, 255, 65, 0.03) 1px,
                    transparent 1px
                );
            background-size: 100% 4px, 20px 20px;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(0, 255, 65, 0.05) 50%,
                transparent 100%
            );
            animation: scanline 8s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        
        .container, header, .stats-grid, .chart-card {
            position: relative;
            z-index: 10;
        }

        .top-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--accent-terminal);
            z-index: 1000;
            box-shadow: 0 0 4px var(--accent-terminal);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px;
            position: relative;
        }
        
        .container::before {
            content: '█';
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: var(--accent-terminal);
            font-size: 16px;
            animation: cursorBlink 0.8s steps(2) infinite;
            pointer-events: none;
            z-index: 1000;
        }

        header {
            text-align: center;
            padding: 60px 20px;
            animation: fadeInDown 0.8s ease-out;
            position: relative;
        }
        
        header::after {
            content: '';
            display: block;
            width: 60px;
            height: 2px;
            background: var(--accent-terminal);
            margin: 30px auto 0;
            box-shadow: 0 0 8px var(--accent-terminal);
        }

        /* stats2 顶部标题栏风格：仅用于 fullReport 顶部 */
        .fullreport-topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1200;
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(18px);
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            font-family: 'JetBrains Mono', monospace;
        }
        .fullreport-topbar .title {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .fullreport-topbar .title .main {
            color: #ffffff;
            font-weight: 800;
            letter-spacing: -0.02em;
            font-style: italic;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .fullreport-topbar .title .sub {
            margin-top: 2px;
            font-size: 10px;
            color: #71717a;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* stats2 顶部固定 Header（在 index fullReport 复刻） */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1500;
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 255, 65, 0.2);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            font-family: 'JetBrains Mono', monospace;
        }
        .top-header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            min-width: 0;
        }
        .top-header-title {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .top-header-title h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 900;
            letter-spacing: -0.02em;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .top-header-title p {
            margin: 4px 0 0 0;
            font-size: 9px;
            color: #71717a;
            letter-spacing: 0.3em;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .top-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .top-header-card {
            border: 1px solid rgba(0, 255, 65, 0.25);
            background: rgba(0, 0, 0, 0.35);
            padding: 8px 10px;
            min-width: 138px;
        }
        .top-header-card-label {
            font-size: 9px;
            color: rgba(113, 113, 122, 0.95);
            letter-spacing: 0.22em;
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 6px;
        }
        .top-header-card-value {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #00ff41;
        }

        .lang-flag-btn {
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            opacity: 0.6;
            transform: scale(1);
            box-shadow: none;
            overflow: hidden;
        }
        .lang-flag-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
            transition: all 0.4s ease;
            padding: 2px;
            outline: none;
            border: none;
            box-shadow: none;
            -webkit-appearance: none;
            appearance: none;
        }
        .lang-flag-btn.active {
            opacity: 1;
            border: 3px solid var(--accent-terminal);
            box-shadow: 0 0 16px rgba(0, 255, 65, 0.6), 0 0 32px rgba(0, 255, 65, 0.3), inset 0 0 20px rgba(0, 255, 65, 0.1);
            transform: scale(1.1);
        }
        .lang-flag-btn:hover:not(.active) {
            opacity: 0.9;
            transform: scale(1.15);
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .lang-flag-btn:hover.active {
            border: 3px solid var(--accent-terminal);
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.8), 0 0 40px rgba(0, 255, 65, 0.4), inset 0 0 25px rgba(0, 255, 65, 0.15);
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.25s ease;
        }

        .logo-box {
            display: inline-block;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--card-border);
            border-radius: 2px;
            margin-bottom: 20px;
            font-size: 16px;
            color: var(--accent-terminal);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }
        
        .logo-box::before {
            content: '> ';
            color: var(--accent-terminal);
            text-shadow: 0 0 4px var(--accent-terminal);
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            letter-spacing: 0.1em;
            color: var(--text-main);
            margin-bottom: 15px;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }
        
        h1::before {
            content: '> ';
            color: var(--accent-terminal);
            margin-right: 0.2em;
            text-shadow: 0 0 8px var(--accent-terminal);
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 1.1rem;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.05em;
        }
        
        .subtitle::before {
            content: '// ';
            color: var(--accent-terminal);
            opacity: 0.6;
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .stats-grid.hidden {
            display: none;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            padding: 24px;
            padding-top: 40px;
            transition: border-color 0.2s ease;
            position: relative;
            overflow: visible;
        }
        
        .stat-card:hover {
            border-color: var(--accent-terminal);
            box-shadow: 0 0 8px rgba(0, 255, 65, 0.3);
        }

        .stat-label {
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 16px;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: #fff;
        }

        .stat-comparison {
            font-size: 14px;
            margin-top: 10px;
            color: #ffffff;
            font-weight: 500;
        }
        
        .stat-comparison strong {
            color: var(--accent-terminal);
            font-weight: 700;
        }

        /* 击败人数提示样式 */
        .stat-beaten {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            padding: 3px 6px;
            color: var(--accent-terminal);
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
            line-height: 1.4;
            display: block;
            z-index: 1;
            background: transparent;
            border-radius: 2px;
            box-sizing: border-box;
            text-align: center;
        }

        /* 排名显示样式（右下角） */
        .stat-ranking {
            position: absolute;
            bottom: 12px;
            right: 12px;
            font-size: 12px;
            color: var(--text-dim);
            font-weight: 600;
            background: transparent;
            padding: 4px 8px;
            border-radius: 2px;
            border: 1px solid var(--card-border);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-ranking.has-rank {
            color: var(--accent-terminal);
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--accent-terminal);
        }

        
        .wordcloud-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .wordcloud-section.hidden {
            display: none;
        }

        .chart-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--accent-terminal);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .chart-card:hover::before {
            opacity: 1;
            box-shadow: 0 0 8px var(--accent-terminal);
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .chart-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .wordcloud-container {
            width: 100%;
            height: 400px;
            position: relative;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 19px,
                    rgba(0, 255, 65, 0.05) 19px,
                    rgba(0, 255, 65, 0.05) 20px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 19px,
                    rgba(0, 255, 65, 0.05) 19px,
                    rgba(0, 255, 65, 0.05) 20px
                );
            border-radius: 2px;
            overflow: hidden;
            border: 1px solid var(--card-border);
        }

        .wordcloud-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .prompts-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .prompt-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            transition: all 0.2s ease;
        }

        .prompt-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-terminal);
        }

        .prompt-rank {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-terminal);
            min-width: 30px;
        }

        .prompt-text {
            flex: 1;
            font-size: 16px;
            color: var(--text-main);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .prompt-text::before {
            content: '$ ';
            color: var(--accent-terminal);
            opacity: 0.6;
        }

        .prompt-count {
            font-size: 15px;
            color: var(--text-dim);
            white-space: normal;
        }

        .chat-list-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            overflow: hidden;
        }

        .chat-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
            flex-wrap: wrap;
            gap: 12px;
        }

        .chat-list-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .chat-list-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .chat-list-controls {
            display: flex;
            gap: 12px;
        }

        .search-input {
            padding: 10px 16px;
            font-size: 16px;
            border: 1px solid var(--card-border);
            border-radius: 2px;
            width: 300px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-terminal);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 4px var(--accent-terminal);
        }

        .search-input::placeholder {
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chat-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .chat-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--card-border);
            transition: background 0.2s ease;
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .chat-item:last-child {
            border-bottom: none;
        }

        .chat-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chat-role {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 2px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid;
        }

        .role-user {
            background: transparent;
            color: var(--accent-terminal);
            border-color: var(--accent-terminal);
        }

        .role-ai {
            background: transparent;
            color: var(--accent-terminal);
            border-color: var(--accent-terminal);
        }

        .chat-time {
            font-size: 14px;
            color: var(--text-dim);
        }

        .chat-item-content {
            font-size: 16px;
            color: var(--text-dim);
            line-height: 1.6;
            font-family: 'JetBrains Mono', monospace;
        }

        .chat-item-content p {
            margin: 0;
        }
        
        .chat-item-content::first-line {
            color: var(--text-main);
        }

        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-top: 1px solid var(--card-border);
            background: rgba(255, 255, 255, 0.02);
            flex-wrap: wrap;
            gap: 16px;
        }

        .pagination-info {
            font-size: 16px;
            color: var(--text-dim);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            padding: 8px 16px;
            font-size: 16px;
            border: 1px solid var(--card-border);
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-terminal);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-pages {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination-page-btn {
            min-width: 36px;
            height: 36px;
            padding: 0 12px;
            font-size: 16px;
            border: 1px solid var(--card-border);
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-page-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-terminal);
        }

        .pagination-page-btn.active {
            background: var(--accent-terminal);
            color: #050505;
            border-color: var(--accent-terminal);
        }

        .pagination-ellipsis {
            padding: 0 8px;
            color: var(--text-dim);
            font-size: 16px;
        }

        .vibe-codinger-section {
            margin-bottom: 32px;
        }

        .vibe-header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--card-border);
            position: relative;
        }
        
        .vibe-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 1px;
            background: var(--accent-terminal);
            box-shadow: 0 0 8px var(--accent-terminal);
        }

        .vibe-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .vibe-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .vibe-badge {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 40px;
            border-radius: 2px;
            margin-bottom: 16px;
            transition: border-color 0.2s ease;
            border: 1px solid var(--card-border);
        }

        .vibe-badge:hover {
            border-color: var(--accent-terminal);
        }

        .vibe-type {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 0.15em;
            color: var(--text-main);
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }

        .vibe-name {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-main);
        }

        .vibe-description {
            font-size: 16px;
            color: var(--text-dim);
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }

        .vibe-dimensions {
            margin-bottom: 32px;
        }

        .dimensions-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .dimensions-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .dimension-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 2px;
            border: 1px solid var(--card-border);
            margin-bottom: 16px;
            transition: all 0.2s ease;
        }

        .dimension-card:hover {
            border-color: var(--accent-terminal);
            background: rgba(255, 255, 255, 0.05);
        }

        .dimension-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .dimension-key {
            font-size: 26px;
            font-weight: 700;
            color: var(--accent-terminal);
            min-width: 40px;
        }

        .dimension-label {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
            flex: 1;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dimension-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-main);
            min-width: 50px;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
        }

        .dimension-level {
            font-size: 16px;
            padding: 4px 12px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-dim);
            font-weight: 600;
            border: 1px solid var(--card-border);
        }

        .dimension-bar-container {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0;
            overflow: hidden;
            margin-bottom: 12px;
            border: 1px solid var(--card-border);
            display: flex;
        }

        .dimension-bar {
            height: 100%;
            border-radius: 0;
            transition: width 0.3s steps(20);
            background: repeating-linear-gradient(
                90deg,
                var(--accent-terminal),
                var(--accent-terminal) 6px,
                rgba(0, 255, 65, 0.5) 6px,
                rgba(0, 255, 65, 0.5) 8px,
                var(--accent-terminal) 8px,
                var(--accent-terminal) 14px,
                transparent 14px,
                transparent 16px
            );
            box-shadow: 
                inset 0 0 8px var(--accent-terminal),
                0 0 4px rgba(0, 255, 65, 0.5);
            position: relative;
        }
        
        .dimension-bar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: var(--accent-terminal);
            box-shadow: 0 0 6px var(--accent-terminal);
            animation: barCursor 0.8s steps(2) infinite;
        }
        
        @keyframes barCursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .dimension-interpretation {
            font-size: 17px;
            color: var(--text-main);
            margin-bottom: 8px;
            font-weight: 500;
            line-height: 1.6;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0;
            border-left: 3px solid var(--accent-terminal);
            font-style: normal;
        }
        
        .dimension-interpretation::before {
            content: '// ';
            color: var(--accent-terminal);
            opacity: 0.6;
        }

        .dimension-desc {
            font-size: 14px;
            color: var(--text-dim);
            line-height: 1.5;
        }

        .vibe-roast-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .roast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .roast-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .roast-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .personality-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-terminal);
            padding: 6px 16px;
            background: transparent;
            border-radius: 2px;
            border: 1px solid var(--accent-terminal);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .vibe-index {
            font-size: 16px;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            border: 1px solid var(--card-border);
        }

        .roast-content {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 0;
            border-left: 4px solid var(--accent-terminal);
            margin-bottom: 16px;
        }

        .roast-text {
            font-size: 17px;
            line-height: 1.8;
            color: var(--text-main);
            margin: 0;
            font-style: normal;
        }
        
        .roast-text::before {
            content: '> ';
            color: var(--accent-terminal);
            opacity: 0.8;
        }

        .dimension-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .dimension-tag {
            font-size: 15px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            color: var(--text-main);
            font-weight: 500;
        }

        .vibe-traits {
            margin-bottom: 32px;
        }

        .traits-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .traits-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .traits-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .trait-tag {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--accent-terminal);
            border-radius: 2px;
            font-size: 16px;
            font-weight: 500;
            color: var(--accent-terminal);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .vibe-fingerprint {
            margin-bottom: 32px;
        }

        .fingerprint-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .fingerprint-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .fingerprint-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .fingerprint-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 2px;
            border: 1px solid var(--card-border);
            text-align: center;
            transition: border-color 0.2s ease;
        }
        
        .fingerprint-item:hover {
            border-color: var(--accent-terminal);
        }

        .fingerprint-label {
            font-size: 15px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .fingerprint-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
            font-family: 'JetBrains Mono', monospace;
        }

        .fingerprint-desc {
            font-size: 12px;
            color: var(--text-dim);
            line-height: 1.4;
            margin-top: 4px;
            text-align: left;
            opacity: 0.8;
        }

        .vibe-chart-container {
            margin-bottom: 32px;
        }

        .vibe-chart-container .chart-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 19px,
                    rgba(0, 255, 65, 0.05) 19px,
                    rgba(0, 255, 65, 0.05) 20px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 19px,
                    rgba(0, 255, 65, 0.05) 19px,
                    rgba(0, 255, 65, 0.05) 20px
                );
            border-radius: 2px;
            padding: 20px;
            border: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #vibeRadarChart {
            max-height: 100%;
            max-width: 100%;
        }

        .btn {
            background: var(--accent-terminal);
            color: #050505;
            border: 1px solid var(--accent-terminal);
            padding: 12px 32px;
            border-radius: 2px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .btn:hover {
            background: transparent;
            color: var(--accent-terminal);
            box-shadow: 0 0 8px var(--accent-terminal);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .hidden {
            display: none !important;
        }

        @keyframes fadeInDown {
            0% { opacity: 0; transform: translateY(-20px); }
            50% { opacity: 0.5; }
            100% { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        
        .wordcloud-section {
                grid-template-columns: 1fr;
            }
            .chat-list-header {
                flex-direction: column;
                align-items: stretch;
            }
            .search-input {
                width: 100%;
            }
            .pagination-container {
                flex-direction: column;
                align-items: stretch;
            }
            /* 分享模式下，移动端使用单列布局 */
            .full-report-container .stats-grid {
                grid-template-columns: 1fr !important;
            }
            .full-report-container .ranking-section .stats-grid {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 终端风格数字动画 */
        @keyframes numberPulse {
            0%, 100% { 
                opacity: 1; 
                color: var(--text-main);
            }
            25% { 
                opacity: 0.3; 
            }
            50% { 
                opacity: 1; 
                color: var(--accent-terminal);
                text-shadow: 0 0 8px var(--accent-terminal);
            }
            75% { 
                opacity: 0.5; 
            }
        }

        @keyframes numberFlash {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0; }
        }

        .stat-value.animate-pulse {
            animation: numberPulse 0.3s steps(4);
        }

        .stat-value.animate-flash {
            animation: numberFlash 0.2s steps(2);
        }

        .stat-value.updating {
            position: relative;
        }

        .stat-value.updating::after {
            content: '_';
            position: absolute;
            right: -12px;
            color: var(--accent-terminal);
            animation: cursorBlink 0.8s steps(2) infinite;
        }

        @keyframes cursorBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Waline 留言板样式覆盖 - 适配 Terminal 终端风格 */
        #waline {
            --waline-theme-color: var(--accent-terminal);
            --waline-active-color: var(--accent-terminal);
            --waline-bg-color: var(--card-bg);
            --waline-border-color: var(--card-border);
            --waline-text-color: var(--text-main);
            --waline-bg-color-light: rgba(24, 24, 27, 0.4);
            --waline-color: var(--text-main);
            --waline-meta-color: var(--text-dim);
            --waline-border: 1px solid var(--card-border);
            --waline-box-shadow: none;
            --waline-white: #0a0a0a !important;
            --waline-light-grey: #1a1a1a !important;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .wl-content, .wl-editor {
            color: var(--text-main) !important;
        }

        .wl-header {
            border-bottom: 1px solid var(--card-border) !important;
            padding-bottom: 16px;
            margin-bottom: 20px;
        }

        .wl-header label {
            color: var(--text-main) !important;
        }

        .wl-header input,
        .wl-header textarea {
            background: rgba(24, 24, 27, 0.6) !important;
            border: 1px solid var(--card-border) !important;
            color: var(--text-main) !important;
            font-family: 'JetBrains Mono', monospace !important;
        }

        .wl-header input:focus,
        .wl-header textarea:focus {
            border-color: var(--accent-terminal) !important;
            outline: none;
            box-shadow: 0 0 4px rgba(0, 255, 65, 0.3) !important;
        }

        /* 完全隐藏邮箱和网址字段 */
        .wl-header .wl-mail,
        .wl-header .wl-mail-wrapper,
        .wl-header .wl-link,
        .wl-header .wl-link-wrapper,
        .wl-header .wl-email,
        .wl-header .wl-url {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            opacity: 0 !important;
        }

        .wl-btn {
            background: transparent !important;
            border: 1px solid var(--accent-terminal) !important;
            color: var(--accent-terminal) !important;
            font-family: 'JetBrains Mono', monospace !important;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.2s ease !important;
        }

        .wl-btn:hover {
            background: var(--accent-terminal) !important;
            color: #000 !important;
        }

        .wl-card {
            background: var(--card-bg) !important;
            border: 1px solid var(--card-border) !important;
            border-radius: 2px !important;
            padding: 16px !important;
            margin-bottom: 16px !important;
        }

        .wl-card:hover {
            border-color: var(--accent-terminal) !important;
        }

        .wl-nick {
            color: var(--accent-terminal) !important;
            font-weight: 700;
        }

        .wl-time {
            color: var(--text-dim) !important;
        }

        .wl-content {
            color: var(--text-main) !important;
            line-height: 1.6;
        }

        .wl-actions button {
            color: var(--text-dim) !important;
            font-family: 'JetBrains Mono', monospace !important;
        }

        .wl-actions button:hover {
            color: var(--accent-terminal) !important;
        }

        .wl-pagination {
            border-top: 1px solid var(--card-border) !important;
            padding-top: 16px;
            margin-top: 20px;
        }

        .wl-pagination button {
            background: transparent !important;
            border: 1px solid var(--card-border) !important;
            color: var(--text-main) !important;
            font-family: 'JetBrains Mono', monospace !important;
        }

        .wl-pagination button:hover {
            border-color: var(--accent-terminal) !important;
            color: var(--accent-terminal) !important;
        }

        .wl-pagination button.wl-page-btn-active {
            background: var(--accent-terminal) !important;
            border-color: var(--accent-terminal) !important;
            color: #000 !important;
        }

        /* 更多样式覆盖以确保完美适配黑色背景和绿色主题 */
        .wl-count {
            color: var(--text-dim) !important;
        }

        .wl-count .wl-num {
            color: var(--accent-terminal) !important;
        }

        .wl-info {
            color: var(--text-dim) !important;
        }

        .wl-info .wl-nick {
            color: var(--accent-terminal) !important;
        }

        .wl-comment {
            background: transparent !important;
        }

        .wl-comment .wl-content {
            color: var(--text-main) !important;
        }

        .wl-comment .wl-meta {
            color: var(--text-dim) !important;
        }

        .wl-comment .wl-meta .wl-nick {
            color: var(--accent-terminal) !important;
        }

        .wl-comment .wl-time {
            color: var(--text-dim) !important;
        }

        .wl-reaction {
            background: rgba(24, 24, 27, 0.6) !important;
            border: 1px solid var(--card-border) !important;
            color: var(--text-main) !important;
        }

        .wl-reaction:hover {
            border-color: var(--accent-terminal) !important;
            color: var(--accent-terminal) !important;
        }

        .wl-reaction.active {
            background: var(--accent-terminal) !important;
            border-color: var(--accent-terminal) !important;
            color: #000 !important;
        }

        .wl-emoji {
            filter: brightness(0.9);
        }

        .wl-emoji:hover {
            filter: brightness(1.2);
        }

        /* 输入框占位符样式 */
        .wl-header input::placeholder,
        .wl-header textarea::placeholder {
            color: var(--text-dim) !important;
            opacity: 0.6;
        }

        /* 评论列表容器 */
        .wl-comments {
            background: transparent !important;
        }

        /* 空状态提示 */
        .wl-empty {
            color: var(--text-dim) !important;
        }

        /* 加载状态 */
        .wl-loading {
            color: var(--accent-terminal) !important;
        }

        /* 错误提示 */
        .wl-error {
            color: #ef4444 !important;
            background: rgba(239, 68, 68, 0.1) !important;
            border: 1px solid rgba(239, 68, 68, 0.3) !important;
        }

        /* 回复按钮 */
        .wl-reply {
            color: var(--text-dim) !important;
        }

        .wl-reply:hover {
            color: var(--accent-terminal) !important;
        }

        /* 管理员标识 */
        .wl-badge {
            background: var(--accent-terminal) !important;
            color: #000 !important;
        }

        /* 确保所有文本都使用正确的字体 */
        .wl-header *,
        .wl-comment *,
        .wl-actions *,
        .wl-pagination * {
            font-family: 'JetBrains Mono', monospace !important;
        }

        /* 竖向目录导航样式 - PC端 */
        .toc-nav {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0;
            padding: 16px 0;
        }

        .toc-item {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.15em;
            color: var(--text-dim);
            padding: 4px 10px 4px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            text-transform: uppercase;
            white-space: normal;
            border-left: none;
        }

        .toc-item:hover {
            color: var(--accent-terminal);
            background: rgba(0, 255, 65, 0.08);
        }

        .toc-item.active {
            color: var(--accent-terminal);
            background: rgba(0, 255, 65, 0.1);
            text-shadow: 0 0 8px var(--accent-terminal);
        }

        .toc-item.active::before {
            content: '>';
            margin-right: 6px;
            animation: blink 0.8s steps(2) infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* 移动端折叠目录 */
        .toc-collapsed {
            display: none;
        }

        /* 响应式：小屏幕适配 - 折叠式侧边目录 */
        @media (max-width: 1200px) {
            .toc-nav {
                display: none;
            }
            .toc-collapsed {
                display: flex;
                position: fixed;
                right: 0;
                top: 50%;
                transform: translateY(-50%);
                z-index: 1000;
                flex-direction: column;
                gap: 0;
            }

            .toc-collapsed-trigger {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 44px;
                height: 44px;
                background: '#050505';
                border: 1px solid var(--card-border);
                border-right: none;
                border-radius: 4px 0 0 4px;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: none;
            }

            .toc-collapsed-trigger:hover {
                border-color: var(--accent-terminal);
                box-shadow: 0 0 8px rgba(0, 255, 65, 0.2);
            }

            .toc-collapsed-trigger:hover svg {
                stroke: var(--accent-terminal);
                filter: drop-shadow(0 0 4px var(--accent-terminal));
            }

            .toc-collapsed-trigger svg {
                width: 18px;
                height: 18px;
                stroke: var(--text-dim);
                transition: all 0.2s ease;
            }

            /* 点击时图标旋转动效 */
            .toc-collapsed-trigger.active svg {
                stroke: var(--accent-terminal);
                transform: rotate(-90deg);
                filter: drop-shadow(0 0 6px var(--accent-terminal));
            }

            .toc-collapsed-trigger:active {
                transform: scale(0.96);
            }

            .toc-collapsed-panel {
                position: fixed;
                right: 44px;
                top: 50%;
                transform: translateY(-50%) translateX(calc(100% + 44px));
                background: rgba(24, 24, 27, 0.95);
                border: 1px solid var(--card-border);
                border-right: none;
                border-radius: 4px 0 0 4px;
                padding: 12px 0;
                display: flex;
                flex-direction: column;
                gap: 2px;
                max-height: 60vh;
                overflow-y: auto;
                backdrop-filter: blur(10px);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 999;
            }

            .toc-collapsed-panel.open {
                transform: translateY(-50%) translateX(0);
                box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
            }

            .toc-collapsed-item {
                font-family: 'JetBrains Mono', monospace;
                font-size: 10px;
                color: var(--text-dim);
                padding: 6px 12px 6px 16px;
                cursor: pointer;
                transition: all 0.2s ease;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                white-space: normal;
                border-left: 2px solid transparent;
            }

            .toc-collapsed-item:hover {
                color: var(--accent-terminal);
                background: rgba(0, 255, 65, 0.05);
            }

            .toc-collapsed-item.active {
                color: var(--accent-terminal);
                background: rgba(0, 255, 65, 0.1);
                border-left-color: var(--accent-terminal);
            }

            .toc-collapsed-item.active::before {
                content: '>';
                margin-right: 6px;
                animation: blink 0.8s steps(2) infinite;
            }

            /* 分享按钮移动端适配 */
            .fixed.bottom-24.right-4 {
                bottom: 80px !important;
                right: 12px !important;
            }
        }

        /* ========== V6 高级报告样式 ========== */
        
        /* 完整报告容器 - 确保内容完整显示 */
        .full-report-container {
            min-height: 2000px;
            position: relative;
        }

        /* V6 高级报告容器 */
        #v6-advanced-report {
            display: none;
            margin-top: 40px;
            scroll-margin-top: 80px;
        }

        #v6-advanced-report.visible {
            display: block;
            animation: fadeInUp 0.6s ease-out;
        }

        /* 行为标签容器 */
        .vibe-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 32px;
            padding: 24px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 2px;
        }

        .vibe-tag {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: #ffffff;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.05em;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
            animation: tagGlow 2s ease-in-out infinite;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }

        .vibe-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
        }

        @keyframes tagGlow {
            0%, 100% {
                box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
            }
            50% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.7), 0 0 30px rgba(139, 92, 246, 0.4);
            }
        }

        /* 【V6 CSS 注入检查】为所有 V6_METRIC_CONFIG 中提到的 tag 类名添加渐变背景样式 */
        .vibe-tag.tag-ketao {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 0 12px rgba(245, 158, 11, 0.4);
        }
        .vibe-tag.tag-ketao:hover {
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
        }

        .vibe-tag.tag-jiafang {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.4);
        }
        .vibe-tag.tag-jiafang:hover {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
        }

        .vibe-tag.tag-tease {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
        }
        .vibe-tag.tag-tease:hover {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
        }

        .vibe-tag.tag-nonsense {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.4);
        }
        .vibe-tag.tag-nonsense:hover {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6);
        }

        .vibe-tag.tag-abuse {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            box-shadow: 0 0 12px rgba(249, 115, 22, 0.4);
        }
        .vibe-tag.tag-abuse:hover {
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.6);
        }

        .vibe-tag.tag-style-label {
            background: linear-gradient(135deg, #00D4FF 0%, #0099cc 100%);
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.4);
            font-weight: bold;
            font-size: 1.1em;
        }
        .vibe-tag.tag-style-label:hover {
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.6);
        }

        /* 【V6 骨架屏】全网数据加载前的占位样式 */
        [data-v6-key] {
            transition: opacity 0.5s ease-in-out;
        }
        
        /* 骨架屏占位符动画（数据未加载时） */
        [data-v6-key]:empty::before,
        [data-v6-key][data-skeleton="true"]::before {
            content: '...';
            color: rgba(255, 255, 255, 0.3);
            animation: skeletonPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes skeletonPulse {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 0.6;
            }
        }

        /* 稳定性卡片 */
        .vibe-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .vibe-card-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: 'JetBrains Mono', monospace;
        }

        .vibe-card-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        /* 稳定性进度条 */
        .stability-progress {
            position: relative;
            width: 100%;
            height: 32px;
            background: rgba(24, 24, 27, 0.8);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .stability-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b 0%, #ef4444 100%);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            font-size: 12px;
            font-weight: 700;
            color: #ffffff;
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .stability-progress-bar.high {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        .stability-progress-bar.medium {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }

        .stability-progress-bar.low {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .stability-progress-label {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* 全局排名横幅 */
        .global-banner {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid var(--card-border);
            border-left: 3px solid var(--accent-terminal);
            border-radius: 2px;
            padding: 20px 24px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .global-banner-content {
            flex: 1;
            min-width: 200px;
        }

        .global-banner-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        .global-banner-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-terminal);
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 0 8px rgba(0, 255, 65, 0.3);
        }

        .global-banner-label {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* 答案之书引用框 */
        .quote-box {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-left: 3px solid var(--accent-terminal);
            border-radius: 2px;
            padding: 24px 32px;
            margin-bottom: 32px;
            position: relative;
            font-style: italic;
            line-height: 1.8;
            color: var(--text-main);
            font-family: 'JetBrains Mono', monospace;
        }

        .quote-box::before {
            content: '"';
            position: absolute;
            top: 16px;
            left: 16px;
            font-size: 48px;
            color: var(--accent-terminal);
            opacity: 0.3;
            font-family: Georgia, serif;
            line-height: 1;
        }

        .quote-box::after {
            content: '"';
            position: absolute;
            bottom: 16px;
            right: 24px;
            font-size: 48px;
            color: var(--accent-terminal);
            opacity: 0.3;
            font-family: Georgia, serif;
            line-height: 1;
        }

        .quote-box-content {
            position: relative;
            z-index: 1;
            font-size: 15px;
        }

        /* 淡入向上动画 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 响应式适配 */
        @media (max-width: 768px) {
            .vibe-tag-container {
                padding: 16px;
                gap: 8px;
            }

            .vibe-tag {
                padding: 8px 16px;
                font-size: 12px;
            }

            .global-banner {
                flex-direction: column;
                align-items: flex-start;
            }

            .global-banner-value {
                font-size: 24px;
            }

            .quote-box {
                padding: 20px 24px;
            }

            .quote-box::before,
            .quote-box::after {
                font-size: 36px;
            }
        }

        /* 高 DPI 屏幕文字清晰度优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .vibe-tag,
            .stability-progress-bar,
            .global-banner-value,
            .quote-box-content {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                text-rendering: optimizeLegibility;
            }
        }
    </style>
</head>
<body class="bg-[#050505]">
    <div id="root"></div>
    <!-- 完整报告容器（隐藏，等待渲染） -->
    <div id="fullReportContainer" style="display: none;"></div>

    <script type="module">
        // 模块加载逻辑（适配开发和生产环境）
        (async function() {
            // 检测当前部署环境
            const pathname = window.location.pathname;
            const hostname = window.location.hostname;
            const isDev = hostname === 'localhost' || hostname === '127.0.0.1' || hostname.includes('localhost') || hostname.includes('192.168.');
            const isGitHubPages = hostname.includes('github.io');
            const isWorkersDev = hostname.includes('workers.dev') || hostname.includes('pages.dev');
            
            // 设置加载状态
            window.analysisModuleLoading = true;
            window.analysisModuleError = null;
            
            // 在外部作用域定义变量，确保 i18n 加载代码可以访问
            let basePath = '';
            let currentDir = '';
            
            try {
                let module;
                
                if (isDev) {
                    // 开发环境：直接导入（Vite 会自动处理）
                    console.log('[Main] 开发环境：直接导入 main.js');
                    module = await import('./main.js');
                } else {
                    // 生产环境：动态导入（支持多种部署路径）
                    console.log('[Main] 生产环境：动态导入 main.js');
                    
                    // 检测基础路径（更准确的检测逻辑）
                    basePath = '';
                    if (isGitHubPages) {
                        // GitHub Pages: 从 pathname 提取仓库名
                        // pathname 可能是: /cursor-lab/ 或 /cursor-lab/index.html
                        const pathParts = pathname.split('/').filter(p => p);
                        // 移除 'index.html' 如果存在
                        const cleanParts = pathParts.filter(p => p !== 'index.html' && p !== '');
                        if (cleanParts.length > 0) {
                            // 第一个非空部分通常是仓库名
                            basePath = '/' + cleanParts[0];
                        } else {
                            // 如果 pathname 是 '/' 或 '/index.html'，可能是用户页面，basePath 为空
                            // 但如果是项目页面，pathname 应该包含仓库名
                            // 尝试从 URL 的完整路径推断
                            const fullPath = window.location.pathname;
                            if (fullPath && fullPath !== '/' && fullPath !== '/index.html') {
                                const parts = fullPath.split('/').filter(p => p && p !== 'index.html');
                                if (parts.length > 0) {
                                    basePath = '/' + parts[0];
                                }
                            }
                        }
                    } else {
                        // 其他生产环境
                        const pathParts = pathname.split('/').filter(p => p && p !== 'index.html');
                        basePath = pathParts.length > 0 ? '/' + pathParts[0] : '';
                    }
                    
                    // 确保 basePath 格式正确（移除末尾斜杠，但保留开头的斜杠）
                    if (basePath && basePath !== '/' && basePath.endsWith('/')) {
                        basePath = basePath.slice(0, -1);
                    }
                    
                    // 调试信息
                    console.log('[Path] 原始 pathname:', pathname);
                    console.log('[Path] 检测到的 basePath:', basePath);
                    console.log('[Path] isGitHubPages:', isGitHubPages);

                    // 保存基础路径供其他模块使用
                    window.BASE_PATH = basePath;

                    // 获取当前目录（用于相对路径）
                    currentDir = pathname.substring(0, pathname.lastIndexOf('/')) || '';
                    
                    // 构建路径列表（适配不同部署环境）
                    const paths = [];
                    
                    // 统一：优先相对路径，其次尝试 basePath 绝对路径（兼容 /cursor-lab/ 这类子路径部署）
                    // 注意：有些部署只上传 dist 内容，此时 main.js 在站点根目录而不是 /dist/main.js
                    paths.push('./main.js');
                    paths.push('./dist/main.js');
                    if (basePath) {
                        paths.push(`${basePath}/main.js`);
                        paths.push(`${basePath}/dist/main.js`);
                    }
                    // 最后兜底：站点根路径
                    paths.push('/main.js');
                    paths.push('/dist/main.js');
                    
                    console.log('[Main] 当前 URL:', window.location.href);
                    console.log('[Main] 当前路径:', pathname);
                    console.log('[Main] 基础路径:', basePath);
                    console.log('[Main] 当前目录:', currentDir);
                    console.log('[Main] 尝试路径列表:', paths);
                    console.log('[Main] 路径数量:', paths.length);
                    
                    if (paths.length === 0) {
                        throw new Error('无法构建有效的模块路径。请检查部署配置。');
                    }
                    
                    let loaded = false;
                    let lastError = null;
                    const errors = [];
                    
                    for (const path of paths) {
                        try {
                            console.log(`[Main] 尝试加载模块，路径: ${path}`);
                            module = await import(/* @vite-ignore */ path);
                            console.log(`[Main] ✅ 成功加载模块，路径: ${path}`);
                            loaded = true;
                            break;
                        } catch (err) {
                            const errorInfo = {
                                path,
                                error: err.message,
                                name: err.name
                            };
                            errors.push(errorInfo);
                            console.warn(`[Main] 路径 ${path} 加载失败:`, err.message);
                            lastError = err;
                        }
                    }
                    
                    if (!loaded) {
                        console.error('[Main] ❌ 所有路径都加载失败');
                        console.error('[Main] 所有尝试的错误:', errors);
                        console.error('[Main] 最后尝试的错误:', lastError);
                        const errorDetails = errors.map(e => `  - ${e.path}: ${e.error}`).join('\n');
                        throw new Error(`模块加载失败：所有路径都尝试失败。\n尝试的路径：\n${errorDetails}\n\n请确认：\n1. 已运行 npm run build\n2. dist/main.js 文件存在\n3. 文件已正确部署到 GitHub Pages`);
                    }
                }
                
                // 检查必需的导出函数
                const requiredExports = [
                    'initializeParser',
                    'processFiles',
                    'renderFullDashboard',
                    'getGlobalStats',
                    'getVibeResult'
                ];
                
                const missingExports = requiredExports.filter(name => 
                    typeof module[name] !== 'function'
                );
                
                if (missingExports.length > 0) {
                    console.error(`[Main] 模块缺少必需的导出:`, missingExports);
                    console.error(`[Main] 模块实际导出:`, Object.keys(module));
                    throw new Error(`模块缺少必需的导出函数: ${missingExports.join(', ')}`);
                }
                
                const { 
                    initializeParser, 
                    processFiles, 
                    renderFullDashboard,
                    getGlobalStats,
                    getVibeResult,
                    getVibeAnalyzer,
                    setGlobalStats,
                    setVibeResult,
                    setAllChatData,
                    reanalyzeWithLanguage,
                    updateNumberWithAnimation,
                    formatNumber,
                    fetchTotalTestUsers,
                    reportNewUser,
                    updateGlobalStats
                } = module;
                
                // 将模块暴露给全局，供 React 使用
                window.analysisModule = {
                    initializeParser,
                    processFiles,
                    renderFullDashboard,
                    getGlobalStats,
                    getVibeResult,
                    getVibeAnalyzer: getVibeAnalyzer || (() => null),
                    setGlobalStats: setGlobalStats || (() => {}),
                    setVibeResult: setVibeResult || (() => {}),
                    setAllChatData: setAllChatData || (() => {}),
                    reanalyzeWithLanguage: reanalyzeWithLanguage || (async () => null),
                    updateNumberWithAnimation: updateNumberWithAnimation || (() => {}),
                    formatNumber: formatNumber || ((n) => n.toString()),
                    fetchTotalTestUsers: fetchTotalTestUsers || (async () => 0),
                    reportNewUser: reportNewUser || (async () => {}),
                    updateGlobalStats: updateGlobalStats || (() => {})
                };
                
                // 导入 i18n 模块并暴露给全局
                try {
                    let i18nModule;
                    if (isDev) {
                        i18nModule = await import('./src/i18n.js');
                    } else {
                        // 生产环境：尝试多个路径（按优先级排序）
                        // 使用 window.BASE_PATH 作为备用，确保变量可用
                        // 安全获取 basePath：优先使用 window.BASE_PATH（已在 main.js 加载时设置）
                        const effectiveBasePath = (typeof basePath !== 'undefined' ? basePath : '') || window.BASE_PATH || '';
                        const effectiveCurrentDir = (typeof currentDir !== 'undefined' ? currentDir : '') || (pathname.substring(0, pathname.lastIndexOf('/')) || '');
                        
                        const i18nPaths = [];
                        
                        // Cloudflare Workers/Pages: 优先使用相对路径（同域名，无跨域问题）
                        if (isWorkersDev) {
                            i18nPaths.push('./src/i18n.js');
                            i18nPaths.push('src/i18n.js');
                        } else if (isGitHubPages) {
                            // 1. GitHub Pages 绝对路径（最高优先级）
                            if (effectiveBasePath) {
                                // 确保 basePath 以 / 开头，但不以 / 结尾
                                const normalizedBasePath = effectiveBasePath.startsWith('/') ? effectiveBasePath : '/' + effectiveBasePath;
                                const cleanBasePath = normalizedBasePath.endsWith('/') ? normalizedBasePath.slice(0, -1) : normalizedBasePath;
                                i18nPaths.push(`${cleanBasePath}/src/i18n.js`);
                            }
                            
                            // 2. 基于当前目录的路径
                            if (effectiveCurrentDir) {
                                i18nPaths.push(`${effectiveCurrentDir}/src/i18n.js`);
                            }
                            
                            // 3. 基于 window.BASE_PATH 的路径（如果存在）
                            if (window.BASE_PATH) {
                                const cleanBase = window.BASE_PATH.endsWith('/') ? window.BASE_PATH.slice(0, -1) : window.BASE_PATH;
                                i18nPaths.push(`${cleanBase}/src/i18n.js`);
                            }
                            
                            // 4. 相对路径（备用）
                            i18nPaths.push('./src/i18n.js');
                            i18nPaths.push('src/i18n.js');
                            
                            // 5. 绝对路径（最后尝试）
                            i18nPaths.push('/src/i18n.js');
                        } else {
                            // 其他环境: 使用相对路径
                            i18nPaths.push('./src/i18n.js');
                            i18nPaths.push('src/i18n.js');
                        }
                        
                        console.log('[i18n] 当前 URL:', window.location.href);
                        console.log('[i18n] 基础路径 (basePath):', typeof basePath !== 'undefined' ? basePath : 'undefined');
                        console.log('[i18n] 基础路径 (window.BASE_PATH):', window.BASE_PATH);
                        console.log('[i18n] 有效基础路径:', effectiveBasePath);
                        console.log('[i18n] 当前目录:', effectiveCurrentDir);
                        console.log('[i18n] 尝试加载路径列表:', i18nPaths);
                        
                        let i18nLoaded = false;
                        let lastI18nError = null;
                        const i18nErrors = [];
                        
                        for (const path of i18nPaths) {
                            try {
                                console.log(`[i18n] 尝试加载: ${path}`);
                                i18nModule = await import(/* @vite-ignore */ path);
                                console.log(`[i18n] ✅ 成功加载: ${path}`);
                                i18nLoaded = true;
                                break;
                            } catch (err) {
                                const errorInfo = {
                                    path,
                                    error: err.message,
                                    name: err.name
                                };
                                i18nErrors.push(errorInfo);
                                console.warn(`[i18n] ❌ 路径 ${path} 加载失败:`, err.message);
                                lastI18nError = err;
                            }
                        }
                        
                        if (!i18nLoaded) {
                            console.error('[i18n] ❌ 所有 i18n 路径都加载失败');
                            console.error('[i18n] 所有尝试的错误:', i18nErrors);
                            console.error('[i18n] 最后尝试的错误:', lastI18nError);
                            throw new Error(`i18n 模块加载失败：所有路径都尝试失败。\n尝试的路径：\n${i18nErrors.map(e => `  - ${e.path}: ${e.error}`).join('\n')}\n\n请确认：\n1. 已运行 npm run build\n2. dist/src/i18n.js 文件存在\n3. 文件已正确部署到 GitHub Pages`);
                        }
                    }
                    window.i18n = i18nModule;
                    console.log('[i18n] ✅ i18n 模块已成功加载，导出内容:', Object.keys(i18nModule));
                } catch (err) {
                    console.error('[i18n] ❌ i18n 模块加载失败:', err);
                    // 提供一个简单的 fallback
                    window.i18n = {
                        getText: (key, lang) => {
                            console.warn(`[i18n] 使用 fallback，返回 key: ${key}`);
                            return key;
                        },
                        getI18nText: (lang) => ({})
                    };
                }
                
                // 验证全局对象
                console.log('[Main] 全局模块对象已创建:', {
                    hasInitializeParser: typeof window.analysisModule.initializeParser === 'function',
                    hasProcessFiles: typeof window.analysisModule.processFiles === 'function',
                    hasRenderFullDashboard: typeof window.analysisModule.renderFullDashboard === 'function'
                });
                
                window.analysisModuleLoading = false;
                window.analysisModuleError = null;
            } catch (err) {
                console.error('[Main] ❌ 模块加载失败:', err);
                window.analysisModuleLoading = false;
                window.analysisModuleError = err;
                // 触发自定义事件，通知 React 组件
                window.dispatchEvent(new CustomEvent('analysisModuleLoadFailed', { 
                    detail: { error: err } 
                }));
            }
        })();
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // 模拟 Lucide 图标组件
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current) {
                    lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className} style={{width: size, height: size}}></i>;
        };

        // 统计卡片子组件
        function StatBox({ label, value, sub, color, lang = 'zh-CN' }) {
            const isEn = lang === 'en';
            // 如果 sub 是 '#'，需要放在数字前面
            const displayValue = (sub === '#' && isEn) ? `${sub}${value}` : value;
            const displaySub = (sub === '#' && isEn) ? '' : sub;
            return (
                <div className="bg-zinc-950/50 border border-zinc-800 rounded-sm w-full flex flex-col" style={{padding: '20px'}}>
                    <div className={`text-zinc-600 uppercase tracking-widest font-bold ${isEn ? 'text-[10px] leading-tight' : 'text-[11px]'}`} style={{minHeight: isEn ? '28px' : '24px', marginBottom: '12px', display: 'flex', alignItems: 'flex-start'}}>{label}</div>
                    <div className={`text-3xl font-black ${color} font-mono flex items-baseline`}>
                        {displayValue}
                        {displaySub && <span className="text-sm ml-1 opacity-50 font-normal text-zinc-400">{displaySub}</span>}
                    </div>
                </div>
            );
        }

        // 从 lpdef 提取 vibe_index（5 位数字），与 worker 的 generateLPDEF 一致：L0P1D2E1F0 -> 01210
        function lpdefToVibeIndex(lpdef) {
            if (!lpdef || typeof lpdef !== 'string') return null;
            const digits = lpdef.replace(/\D/g, '');
            return digits.length === 5 ? digits : null;
        }

        // 答案之书卡片组件（与 stats2 同步：优先用分析结果的 answer_book，否则按 vibe_index/lpdef 从 answerBookByVibeIndex.json 取）
        function AnswerBookCard({ lang = 'zh-CN', vibeResult = null }) {
            const [prompt, setPrompt] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [liked, setLiked] = useState(false);
            const isEn = lang === 'en';

            // 获取 API 端点
            const getApiEndpoint = () => {
                if (typeof window !== 'undefined') {
                    const envApiUrl = window.__API_ENDPOINT__ || window.API_ENDPOINT;
                    if (envApiUrl) {
                        return envApiUrl;
                    }
                    const metaApi = document.querySelector('meta[name="api-endpoint"]');
                    if (metaApi && metaApi.content) {
                        return metaApi.content;
                    }
                }
                return 'https://cursor-clinical-analysis.psterman.workers.dev/';
            };

            // 调试：输出组件初始化信息
            useEffect(() => {
                const apiEndpoint = getApiEndpoint();
                console.log('[AnswerBookCard] 组件初始化:', {
                    lang: lang,
                    apiEndpoint: apiEndpoint,
                    apiEndpoint类型: typeof apiEndpoint,
                    apiEndpoint是否为空: !apiEndpoint || apiEndpoint === '',
                    timestamp: new Date().toISOString(),
                });
            }, []);

            // 获取随机提示
            const fetchRandomPrompt = async () => {
                setLoading(true);
                setError(null);
                setLiked(false);
                
                const apiEndpoint = getApiEndpoint();
                // 确保 apiEndpoint 以斜杠结尾，然后拼接 API 路径
                const baseUrl = apiEndpoint?.endsWith('/') ? apiEndpoint : `${apiEndpoint}/`;
                // 将语言代码转换为 API 期望的格式：zh-CN -> cn, en -> en
                const langParam = lang === 'zh-CN' ? 'cn' : (lang === 'en' ? 'en' : 'cn');
                const requestUrl = `${baseUrl}api/random_prompt?lang=${langParam}`;
                
                // 调试：输出请求信息
                console.log('[AnswerBookCard] 准备发起请求:', {
                    apiEndpoint: apiEndpoint,
                    requestUrl: requestUrl,
                    lang: lang,
                    langParam: langParam,
                    apiEndpoint是否以斜杠结尾: apiEndpoint?.endsWith('/'),
                });
                
                try {
                    const response = await fetch(requestUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors',
                        cache: 'no-cache',
                    });

                    // 调试：输出响应状态
                    console.log('[AnswerBookCard] 响应状态:', {
                        ok: response.ok,
                        status: response.status,
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers.entries()),
                    });

                    if (response.ok) {
                        const responseData = await response.json();
                        console.log('[AnswerBookCard] 获取到的数据:', {
                            responseData: responseData,
                            data类型: typeof responseData,
                            dataKeys: responseData ? Object.keys(responseData) : 'null',
                        });
                        
                        // 处理不同的响应格式
                        let promptData = null;
                        if (responseData.data) {
                            // 格式1: { data: { id, content, author }, status: "success" }
                            promptData = responseData.data;
                        } else if (responseData.content) {
                            // 格式2: { id, content, author } 直接返回
                            promptData = responseData;
                        } else if (responseData.id) {
                            // 格式3: 只有 id，尝试使用整个对象
                            promptData = responseData;
                        }
                        
                        if (promptData && (promptData.content || promptData.id)) {
                            console.log('[AnswerBookCard] 解析成功，设置提示:', promptData);
                            setPrompt(promptData);
                        } else {
                            console.warn('[AnswerBookCard] 数据格式不正确或为空:', responseData);
                            setError(isEn ? 'No prompt data available' : '暂无提示数据');
                        }
                    } else {
                        const errorText = await response.text().catch(() => '无法读取错误信息');
                        console.error('[AnswerBookCard] 响应失败:', {
                            status: response.status,
                            statusText: response.statusText,
                            errorText: errorText,
                        });
                        throw new Error(isEn ? `Failed to fetch prompt: ${response.status}` : `获取提示失败: ${response.status}`);
                    }
                } catch (err) {
                    console.error('[AnswerBookCard] 获取提示失败:', {
                        error: err,
                        message: err.message,
                        stack: err.stack,
                        name: err.name,
                    });
                    
                    // 检查是否是 CORS 错误
                    const isCorsError = err.message?.includes('CORS') || 
                                       err.message?.includes('cors') ||
                                       err.message?.includes('cross-origin') ||
                                       err.name === 'TypeError' && err.message?.includes('fetch');
                    
                    if (isCorsError) {
                        setError(isEn 
                            ? 'CORS error: Please check API server CORS settings' 
                            : '跨域错误：请检查 API 服务器的 CORS 设置');
                    } else {
                        setError(err.message || (isEn ? 'Failed to load prompt' : '加载提示失败'));
                    }
                } finally {
                    setLoading(false);
                }
            };

            // 点赞提示
            const handleLike = async () => {
                if (!prompt || liked) return;
                
                try {
                    const apiEndpoint = getApiEndpoint();
                    // 确保 apiEndpoint 以斜杠结尾，然后拼接 API 路径
                    const baseUrl = apiEndpoint?.endsWith('/') ? apiEndpoint : `${apiEndpoint}/`;
                    const response = await fetch(`${baseUrl}api/like_prompt`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors',
                        body: JSON.stringify({ id: prompt.id }),
                    });

                    if (response.ok) {
                        setLiked(true);
                    } else {
                        console.warn('[AnswerBookCard] 点赞失败:', response.status);
                    }
                } catch (err) {
                    console.error('[AnswerBookCard] 点赞请求失败:', err);
                }
            };

            // 根据 vibe_index/lpdef 从共享 JSON 加载答案之书（与 stats2 同步）
            const loadAnswerBookByVibeIndex = async (vibeIndex) => {
                if (!vibeIndex || typeof vibeIndex !== 'string' || vibeIndex.length !== 5) return null;
                try {
                    const response = await fetch('src/answerBookByVibeIndex.json');
                    if (!response.ok) return null;
                    const data = await response.json();
                    const entry = data[vibeIndex]; // 仅用该用户 vibe_index 的条目，不用 default 占位
                    if (!entry) return null;
                    return {
                        author: isEn ? entry.title_en : entry.title_zh,
                        content: isEn ? entry.content_en : entry.content_zh,
                    };
                } catch (e) {
                    console.warn('[AnswerBookCard] 加载 answerBookByVibeIndex.json 失败:', e);
                    return null;
                }
            };

            // 组件加载或 lang/vibeResult 变化时：优先用分析结果的 answer_book，否则按 vibe_index/lpdef 从 JSON 取，最后 random_prompt
            useEffect(() => {
                const source = vibeResult || (typeof window !== 'undefined' ? window.vibeResult : null);
                const answerBook = source?.answer_book || source?.answerBook;
                const vibeIndex = source?.vibeIndex || source?.vibe_index || (source?.lpdef ? lpdefToVibeIndex(source.lpdef) : null);

                if (answerBook && (answerBook.title || answerBook.content)) {
                    setLoading(true);
                    setError(null);
                    setLiked(false);
                    setPrompt({
                        author: answerBook.title || (isEn ? 'Today\'s Maxim' : '今日箴言'),
                        content: answerBook.content || answerBook.desc || answerBook.description || '',
                    });
                    setLoading(false);
                    return;
                }
                if (vibeIndex) {
                    setLoading(true);
                    setError(null);
                    setLiked(false);
                    loadAnswerBookByVibeIndex(vibeIndex).then((p) => {
                        if (p) {
                            setPrompt(p);
                        } else {
                            fetchRandomPrompt();
                        }
                        setLoading(false);
                    }).catch(() => {
                        fetchRandomPrompt();
                        setLoading(false);
                    });
                    return;
                }
                console.log('[AnswerBookCard] useEffect 触发，无 vibe_index/lpdef，使用 random_prompt');
                fetchRandomPrompt();
            }, [lang, vibeResult?.vibeIndex, vibeResult?.vibe_index, vibeResult?.lpdef]); // 监听 lang 与 vibe 变化

            return (
                <div 
                    className="stat-card"
                    style={{
                        textAlign: 'center',
                        display: 'flex',
                        flexDirection: 'column',
                        justifyContent: 'space-between',
                        minHeight: '140px',
                        padding: '16px',
                    }}
                >
                    {loading && (
                        <div style={{ 
                            color: 'var(--accent-terminal)', 
                            fontFamily: "'JetBrains Mono', monospace",
                            fontSize: '12px',
                            margin: 'auto 0'
                        }}>
                            <div className="w-2 h-4 bg-green-500 animate-pulse inline-block" style={{ marginRight: '6px' }} />
                            {isEn ? '> LOADING...' : '> 加载中...'}
                        </div>
                    )}

                    {error && (
                        <div style={{ 
                            color: '#ef4444', 
                            fontFamily: "'JetBrains Mono', monospace",
                            fontSize: '11px',
                            margin: 'auto 0'
                        }}>
                            {isEn ? '> ERROR' : '> 错误'}
                        </div>
                    )}

                    {!loading && !error && prompt && (
                        <>
                            {prompt.author && (
                                <p className="stat-label" style={{ marginBottom: '8px' }}>
                                    {prompt.author}
                                </p>
                            )}
                            <div 
                                style={{
                                    color: 'var(--text-main)',
                                    fontSize: '13px',
                                    lineHeight: '1.6',
                                    fontFamily: "'JetBrains Mono', monospace",
                                    marginBottom: '12px',
                                    minHeight: '60px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    wordBreak: 'break-word',
                                    flex: 1,
                                }}
                            >
                                {prompt.content || (isEn ? 'No content' : '暂无内容')}
                            </div>
                            <div style={{ 
                                display: 'flex', 
                                gap: '8px', 
                                justifyContent: 'center',
                                marginTop: 'auto'
                            }}>
                                <button
                                    onClick={handleLike}
                                    disabled={liked}
                                    style={{
                                        padding: '6px 12px',
                                        background: liked ? 'var(--accent-terminal)' : 'transparent',
                                        border: '1px solid var(--accent-terminal)',
                                        borderRadius: '2px',
                                        color: liked ? '#050505' : 'var(--accent-terminal)',
                                        fontFamily: "'JetBrains Mono', monospace",
                                        fontSize: '10px',
                                        fontWeight: '600',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.05em',
                                        cursor: liked ? 'default' : 'pointer',
                                        transition: 'all 0.2s ease',
                                        opacity: liked ? 0.7 : 1,
                                    }}
                                    onMouseEnter={(e) => {
                                        if (!liked) {
                                            e.target.style.background = 'var(--accent-terminal)';
                                            e.target.style.color = '#050505';
                                        }
                                    }}
                                    onMouseLeave={(e) => {
                                        if (!liked) {
                                            e.target.style.background = 'transparent';
                                            e.target.style.color = 'var(--accent-terminal)';
                                        }
                                    }}
                                >
                                    {liked ? '✓' : '♥'}
                                </button>
                                <button
                                    onClick={fetchRandomPrompt}
                                    style={{
                                        padding: '6px 12px',
                                        background: 'transparent',
                                        border: '1px solid var(--accent-terminal)',
                                        borderRadius: '2px',
                                        color: 'var(--accent-terminal)',
                                        fontFamily: "'JetBrains Mono', monospace",
                                        fontSize: '10px',
                                        fontWeight: '600',
                                        textTransform: 'uppercase',
                                        letterSpacing: '0.05em',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s ease',
                                    }}
                                    onMouseEnter={(e) => {
                                        e.target.style.background = 'var(--accent-terminal)';
                                        e.target.style.color = '#050505';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.target.style.background = 'transparent';
                                        e.target.style.color = 'var(--accent-terminal)';
                                    }}
                                >
                                    {isEn ? 'NEXT' : '下一条'}
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        // 答案之书模式组件（完整版，保留用于其他用途）
        function PersonaSection({ stats, t, apiEndpoint, lang = 'zh-CN' }) {
            const [prompt, setPrompt] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [liked, setLiked] = useState(false);
            const isEn = lang === 'en';

            // 调试：输出组件接收的参数
            console.log('[PersonaSection] 组件参数:', {
                stats: stats,
                t: typeof t === 'function' ? '✓ 函数可用' : '✗ 函数不可用',
                apiEndpoint: apiEndpoint,
                lang: lang,
                apiEndpoint类型: typeof apiEndpoint,
                apiEndpoint长度: apiEndpoint?.length,
                apiEndpoint是否为空: !apiEndpoint || apiEndpoint === '',
            });

            // 获取随机提示
            const fetchRandomPrompt = async () => {
                if (!apiEndpoint) {
                    console.error('[PersonaSection] apiEndpoint 未定义');
                    setError('API 端点未配置');
                    setLoading(false);
                    return;
                }
                
                setLoading(true);
                setError(null);
                setLiked(false);
                
                // 将语言代码转换为 API 期望的格式：zh-CN -> cn, en -> en
                const langParam = lang === 'zh-CN' ? 'cn' : (lang === 'en' ? 'en' : 'cn');
                // 使用 apiEndpoint 拼接 API 路径，添加语言参数
                const requestUrl = `${apiEndpoint}api/random_prompt?lang=${langParam}`;
                console.log('[PersonaSection] 准备发起请求:', {
                    apiEndpoint: apiEndpoint,
                    requestUrl: requestUrl,
                    lang: lang,
                    langParam: langParam,
                });
                
                try {
                    const response = await fetch(requestUrl, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors',
                        cache: 'no-cache',
                    });

                    // 调试：输出响应状态
                    console.log('[PersonaSection] 响应状态:', {
                        ok: response.ok,
                        status: response.status,
                        statusText: response.statusText,
                        headers: Object.fromEntries(response.headers.entries()),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('[PersonaSection] 获取到的数据:', {
                            data: data,
                            data类型: typeof data,
                            dataKeys: data ? Object.keys(data) : 'null',
                            content: data?.content,
                            id: data?.id,
                        });
                        setPrompt(data);
                    } else {
                        const errorText = await response.text().catch(() => '无法读取错误信息');
                        console.error('[PersonaSection] 响应失败:', {
                            status: response.status,
                            statusText: response.statusText,
                            errorText: errorText,
                        });
                        throw new Error(isEn ? `Failed to fetch prompt: ${response.status}` : `获取提示失败: ${response.status}`);
                    }
                } catch (err) {
                    console.error('[PersonaSection] 获取提示失败:', {
                        error: err,
                        message: err.message,
                        stack: err.stack,
                        name: err.name,
                    });
                    setError(err.message || (isEn ? 'Failed to load prompt' : '加载提示失败'));
                } finally {
                    setLoading(false);
                }
            };

            // 点赞提示
            const handleLike = async () => {
                if (!prompt || liked) {
                    console.log('[PersonaSection] 点赞被跳过:', {
                        hasPrompt: !!prompt,
                        alreadyLiked: liked,
                        promptId: prompt?.id,
                    });
                    return;
                }
                
                // 确保 apiEndpoint 以斜杠结尾，然后拼接 API 路径
                const baseUrl = apiEndpoint?.endsWith('/') ? apiEndpoint : `${apiEndpoint}/`;
                const likeUrl = `${baseUrl}api/like_prompt`;
                console.log('[PersonaSection] 准备点赞:', {
                    apiEndpoint: apiEndpoint,
                    likeUrl: likeUrl,
                    promptId: prompt.id,
                });
                
                try {
                    const response = await fetch(likeUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors',
                        body: JSON.stringify({ id: prompt.id }),
                    });

                    console.log('[PersonaSection] 点赞响应:', {
                        ok: response.ok,
                        status: response.status,
                        statusText: response.statusText,
                    });

                    if (response.ok) {
                        setLiked(true);
                        console.log('[PersonaSection] 点赞成功');
                    } else {
                        const errorText = await response.text().catch(() => '无法读取错误信息');
                        console.warn('[PersonaSection] 点赞失败:', {
                            status: response.status,
                            statusText: response.statusText,
                            errorText: errorText,
                        });
                    }
                } catch (err) {
                    console.error('[PersonaSection] 点赞请求失败:', {
                        error: err,
                        message: err.message,
                        stack: err.stack,
                    });
                }
            };

            // 组件加载时或语言/API端点变化时获取数据
            useEffect(() => {
                console.log('[PersonaSection] useEffect 触发:', {
                    apiEndpoint: apiEndpoint,
                    lang: lang,
                    timestamp: new Date().toISOString(),
                });
                fetchRandomPrompt();
            }, [apiEndpoint, lang]); // 监听 apiEndpoint 和 lang 变化，自动重新获取数据

            return (
                <div className="max-w-2xl w-full mx-auto">
                    <div 
                        className="card-terminal"
                        style={{
                            background: 'var(--card-bg)',
                            border: '1px solid var(--card-border)',
                            borderRadius: '2px',
                            padding: '48px 32px',
                            position: 'relative',
                            minHeight: '400px',
                            display: 'flex',
                            flexDirection: 'column',
                            justifyContent: 'center',
                            alignItems: 'center',
                            textAlign: 'center',
                        }}
                    >
                        {loading && (
                            <div style={{ color: 'var(--accent-terminal)', fontFamily: "'JetBrains Mono', monospace" }}>
                                <div className="w-2 h-5 bg-green-500 animate-pulse inline-block" style={{ marginRight: '8px' }} />
                                {isEn ? '> LOADING...' : '> 加载中...'}
                            </div>
                        )}

                        {error && (
                            <div style={{ color: '#ef4444', fontFamily: "'JetBrains Mono', monospace", marginBottom: '24px' }}>
                                {isEn ? '> ERROR: ' : '> 错误: '}{error}
                            </div>
                        )}

                        {!loading && !error && prompt && (
                            <>
                                <div 
                                    style={{
                                        color: 'var(--text-main)',
                                        fontSize: 'clamp(1.25rem, 3vw, 1.75rem)',
                                        lineHeight: '1.8',
                                        fontFamily: "'JetBrains Mono', monospace",
                                        marginBottom: '48px',
                                        padding: '0 16px',
                                        wordBreak: 'break-word',
                                    }}
                                >
                                    {prompt.content || (isEn ? 'No content available' : '暂无内容')}
                                </div>

                                <div style={{ display: 'flex', gap: '16px', justifyContent: 'center', alignItems: 'center' }}>
                                    <button
                                        onClick={handleLike}
                                        disabled={liked}
                                        style={{
                                            padding: '12px 24px',
                                            background: liked ? 'var(--accent-terminal)' : 'transparent',
                                            border: '1px solid var(--accent-terminal)',
                                            borderRadius: '2px',
                                            color: liked ? '#050505' : 'var(--accent-terminal)',
                                            fontFamily: "'JetBrains Mono', monospace",
                                            fontSize: '14px',
                                            fontWeight: '600',
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.1em',
                                            cursor: liked ? 'default' : 'pointer',
                                            transition: 'all 0.2s ease',
                                            opacity: liked ? 0.7 : 1,
                                        }}
                                        onMouseEnter={(e) => {
                                            if (!liked) {
                                                e.target.style.background = 'var(--accent-terminal)';
                                                e.target.style.color = '#050505';
                                                e.target.style.boxShadow = '0 0 8px var(--accent-terminal)';
                                            }
                                        }}
                                        onMouseLeave={(e) => {
                                            if (!liked) {
                                                e.target.style.background = 'transparent';
                                                e.target.style.color = 'var(--accent-terminal)';
                                                e.target.style.boxShadow = 'none';
                                            }
                                        }}
                                    >
                                        {liked ? (isEn ? '✓ LIKED' : '✓ 已点赞') : (isEn ? 'LIKE' : '点赞')}
                                    </button>

                                    <button
                                        onClick={fetchRandomPrompt}
                                        style={{
                                            padding: '12px 24px',
                                            background: 'transparent',
                                            border: '1px solid var(--accent-terminal)',
                                            borderRadius: '2px',
                                            color: 'var(--accent-terminal)',
                                            fontFamily: "'JetBrains Mono', monospace",
                                            fontSize: '14px',
                                            fontWeight: '600',
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.1em',
                                            cursor: 'pointer',
                                            transition: 'all 0.2s ease',
                                        }}
                                        onMouseEnter={(e) => {
                                            e.target.style.background = 'var(--accent-terminal)';
                                            e.target.style.color = '#050505';
                                            e.target.style.boxShadow = '0 0 8px var(--accent-terminal)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.target.style.background = 'transparent';
                                            e.target.style.color = 'var(--accent-terminal)';
                                            e.target.style.boxShadow = 'none';
                                        }}
                                    >
                                        {isEn ? 'NEXT' : '下一条'}
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        function App() {
            // 语言状态管理
            const [lang, setLang] = useState(() => {
                // 从 localStorage 读取保存的语言设置，默认为中文
                const savedLang = localStorage.getItem('appLanguage');
                return savedLang === 'en' ? 'en' : 'zh-CN';
            });
            
            // i18n 辅助函数
            const t = (key) => {
                if (window.i18n && window.i18n.getText) {
                    return window.i18n.getText(key, lang);
                }
                return key;
            };
            
            // 获取 API 端点（从 meta 标签获取）
            const apiEndpoint = (() => {
                if (typeof window !== 'undefined') {
                    const metaElement = document.querySelector('meta[name="api-endpoint"]');
                    if (metaElement) {
                        const content = metaElement.getAttribute('content');
                        if (content) {
                            return content;
                        }
                    }
                }
                return 'https://cursor-clinical-analysis.psterman.workers.dev/';
            })();
            
            // 重新创建 Dashboard DOM（使用当前语言）
            const recreateDashboardDOM = (currentLang) => {
                const container = document.getElementById('fullReportContainer');
                if (!container || !window.analysisModule) return;
                
                // 获取当前语言下的翻译函数
                const getText = (key) => {
                    if (window.i18n && window.i18n.getText) {
                        return window.i18n.getText(key, currentLang);
                    }
                    return key;
                };
                
                const loadingText = getText('dashboard.loading');
                
                // 重新创建 Dashboard DOM 结构
                container.innerHTML = `
                    <div class="full-report-container" style="max-width: 1100px; margin: 0 auto; padding: 20px; padding-bottom: 80px;">
                        <header style="text-align: center; padding: 60px 20px;">
                            <div class="logo-box" style="display: inline-block; padding: 8px 16px; background: transparent; border: 1px solid var(--card-border); border-radius: 2px; margin-bottom: 20px; font-size: 14px; color: var(--accent-terminal); text-transform: uppercase; letter-spacing: 0.15em;">> ${getText('dashboard.clinicalAnalysis')}</div>
                            <h1 style="font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 700; letter-spacing: 0.1em; color: var(--text-main); margin-bottom: 15px; text-transform: uppercase; font-family: 'JetBrains Mono', monospace;"><a href="https://github.com/psterman/cursor-lab" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none; display: inline-block; transition: all 0.3s ease; position: relative; filter: blur(2px);" onmouseenter="this.style.filter='blur(0px)'; this.style.textShadow='0 0 20px var(--accent-terminal), 0 0 40px var(--accent-terminal)';" onmouseleave="this.style.filter='blur(2px)'; this.style.textShadow='none';">> ${getText('dashboard.reportTitle')}</a></h1>
                            <p class="subtitle" style="color: var(--text-dim); font-size: 1.1rem;">${getText('dashboard.reportSubtitle')}</p>
                        </header>
                        
                        <div id="dashboardSection">
                            
                            <!-- 实时统计区域 -->
                            <div id="realtime-stats" className="realtime-stats-section" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 2px; padding: 24px; margin-bottom: 40px; scroll-margin-top: 80px;">
                                <h3 class="chart-title" style="margin-bottom: 20px; text-align: center;">${getText('dashboard.realtimeStats')}</h3>
                                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                    <div class="stat-card" style="text-align: center;">
                                        <p class="stat-label">${getText('dashboard.totalUsers')}</p>
                                        <p class="stat-value" id="totalTestUsers" style="color: #ffffff;">${loadingText}</p>
                                        <p class="stat-comparison">${getText('dashboard.personUnit')}</p>
                                    </div>
                                    <div class="stat-card" style="text-align: center;">
                                        <p class="stat-label">${getText('dashboard.techRank')}</p>
                                        <p class="stat-value" id="techRank" style="color: #ffffff;">${loadingText}</p>
                                        <p class="stat-comparison">${getText('dashboard.rankUnit')}</p>
                                    </div>
                                    <div id="answerBookCardContainer" style="text-align: center;" key={lang}></div>
                                </div>
                            </div>

                            <!-- 横向排名区域 -->
                            <div id="global-rankings" className="ranking-section" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 2px; padding: 24px; margin-bottom: 40px; scroll-margin-top: 80px;">
                                <h3 class="chart-title" style="margin-bottom: 20px; text-align: center;">${getText('dashboard.globalRankings')}</h3>
                                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;" id="rankingCards">
                                    <div class="stat-card" style="text-align: center;">
                                        <p class="stat-beaten" id="rankingQingCountBeaten">--</p>
                                        <p class="stat-label" style="color: var(--text-dim);">${getText('dashboard.cyberBowRanking')}</p>
                                        <p class="stat-value" id="rankingQingCount" style="color: #ffffff;">--</p>
                                        <p class="stat-comparison" id="rankingQingCountPercent">--</p>
                                    </div>
                                    <div class="stat-card" style="text-align: center;">
                                        <p class="stat-beaten" id="rankingBuCountBeaten">--</p>
                                        <p class="stat-label" style="color: var(--text-dim);">${getText('dashboard.bossModeRanking')}</p>
                                        <p class="stat-value" id="rankingBuCount" style="color: #ffffff;">--</p>
                                        <p class="stat-comparison" id="rankingBuCountPercent">--</p>
                                    </div>
                                    <div class="stat-card" style="text-align: center;">
                                        <p class="stat-beaten" id="rankingUserMessagesBeaten">--</p>
                                        <p class="stat-label" style="color: var(--text-dim);">${getText('dashboard.aiTeasingRanking')}</p>
                                        <p class="stat-value" id="rankingUserMessages" style="color: #ffffff;">--</p>
                                        <p class="stat-comparison" id="rankingUserMessagesPercent">--</p>
                                    </div>
                                    <div class="stat-card" style="text-align: center;">
                                        <p class="stat-beaten" id="rankingTotalCharsBeaten">--</p>
                                        <p class="stat-label" style="color: var(--text-dim);">${getText('dashboard.banterOutputRanking')}</p>
                                        <p class="stat-value" id="rankingTotalChars" style="color: #ffffff;">--</p>
                                        <p class="stat-comparison" id="rankingTotalCharsPercent">--</p>
                                    </div>
                                    <div class="stat-card" style="text-align: center;">
                                        <p class="stat-beaten" id="rankingAvgLengthBeaten">--</p>
                                        <p class="stat-label" style="color: var(--text-dim);">${getText('dashboard.avgLengthRanking')}</p>
                                        <p class="stat-value" id="rankingAvgLength" style="color: #ffffff;">--</p>
                                        <p class="stat-comparison" id="rankingAvgLengthPercent">--</p>
                                    </div>
                                    <div class="stat-card" style="text-align: center;">
                                        <p class="stat-beaten" id="rankingUsageDaysBeaten">--</p>
                                        <p class="stat-label" style="color: var(--text-dim);">${getText('dashboard.daysOnDutyRanking')}</p>
                                        <p class="stat-value" id="rankingUsageDays" style="color: #ffffff;">--</p>
                                        <p class="stat-comparison" id="rankingUsageDaysPercent">--</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 维度得分排行榜 -->
                            <div id="dimension-rankings" className="dimension-ranking-section" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 2px; padding: 24px; margin-bottom: 40px; scroll-margin-top: 80px;">
                                <h3 class="chart-title" style="margin-bottom: 20px; text-align: center;">${getText('dashboard.dimensionRankingTitle')}</h3>
                                <div id="dimensionRankingList" class="prompts-list"></div>
                            </div>

                            <div class="stats-grid" id="exportArea">
                                <div class="stat-card">
                                    <p class="stat-label">${getText('dashboard.daysOnDutyCount')}</p>
                                    <p class="stat-value" id="totalConversations">0</p>
                                    <p class="stat-comparison">${getText('statsLabels.unit.days')}</p>
                                    <span class="stat-ranking" id="rankingUsageDaysBadge">--</span>
                                </div>
                                <div class="stat-card">
                                    <p class="stat-label">${getText('dashboard.aiTeasingCount')}</p>
                                    <p class="stat-value" id="userMessages">0</p>
                                    <span class="stat-ranking" id="rankingUserMessagesBadge">--</span>
                                </div>
                            </div>
                            
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <p class="stat-label">${getText('dashboard.cyberBowCount')}</p>
                                    <p class="stat-value" id="qingCount">0</p>
                                    <p class="stat-comparison">${getText('dashboard.timesUnit')}</p>
                                    <span class="stat-ranking" id="rankingQingCountBadge">--</span>
                                </div>
                                <div class="stat-card">
                                    <p class="stat-label">${getText('dashboard.bossModeCount')}</p>
                                    <p class="stat-value" id="buCount">0</p>
                                    <p class="stat-comparison">${getText('dashboard.timesUnit')}</p>
                                    <span class="stat-ranking" id="rankingBuCountBadge">--</span>
                                </div>
                            </div>
                            
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <p class="stat-label">${getText('dashboard.banterOutputCount')}</p>
                                    <p class="stat-value" id="totalUserChars">0</p>
                                    <p class="stat-comparison">${getText('dashboard.charUnit')}</p>
                                    <span class="stat-ranking" id="rankingTotalCharsBadge">--</span>
                                </div>
                                <div class="stat-card">
                                    <p class="stat-label">${getText('dashboard.avgLengthCount')}</p>
                                    <p class="stat-value" id="avgUserMessageLength">0</p>
                                    <p class="stat-comparison">${getText('dashboard.charUnit')}</p>
                                    <span class="stat-ranking" id="rankingAvgLengthBadge">--</span>
                                </div>
                                <div class="stat-card hidden" id="questionCard">
                                    <p class="stat-label">${getText('dashboard.questionCount')}</p>
                                    <p class="stat-value" id="questionMessageCount">0</p>
                                    <p class="stat-comparison">${getText('statsLabels.unit.count')}</p>
                                </div>
                            </div>
                            
                            <div class="wordcloud-section">
                                <div class="chart-card">
                                    <h3 class="chart-title">${getText('dashboard.aiMerits')}</h3>
                                    <div class="wordcloud-container">
                                        <canvas id="chineseWordCloud"></canvas>
                                    </div>
                                </div>
                                <div class="chart-card">
                                    <h3 class="chart-title">${getText('dashboard.siliconValleySlang')}</h3>
                                    <div class="wordcloud-container">
                                        <canvas id="englishWordCloud"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 黑话榜 -->
                            <div id="vibe-slang" className="chart-card" style="margin-top: 40px; scroll-margin-top: 80px;">
                                <h3 class="chart-title"><span style="color: var(--accent-terminal);">🗣️</span> ${getText('dashboard.vibeCodingSlang')}</h3>
                                <div class="prompts-list" id="topChineseWordsList"></div>
                            </div>
                            
                            <div class="chart-card" id="techStackSection" style="display: none; margin-top: 40px;">
                                <h3 class="chart-title">${getText('dashboard.userTechStack')}</h3>
                                <div class="prompts-list" id="techStackList"></div>
                            </div>
                            
                            <!-- 人格锁定、人格特征、语义指纹、维度雷达图 -->
                            <div id="personality-lock" className="vibe-codinger-section chart-card" style="margin-top: 40px; scroll-margin-top: 80px;"></div>
                            
                            <!-- V6 高级报告容器（40维度深度画像） -->
                            <div id="v6-advanced-report" style="display: none;">
                                <!-- 行为标签容器 -->
                                <div id="behavior-tags" class="vibe-tag-container"></div>
                                
                                <!-- 人格稳定性卡片 -->
                                <div id="personality-stability" class="vibe-card">
                                    <h3 class="vibe-card-title">${getText('dashboard.personalityStability') || '人格稳定性'}</h3>
                                    <div class="stability-progress">
                                        <span class="stability-progress-label">${getText('dashboard.balanceScore') || '平衡度'}</span>
                                        <div class="stability-progress-bar" id="stability-progress-bar" style="width: 0%;">0%</div>
                                    </div>
                                </div>
                                
                                <!-- 全局排名横幅 -->
                                <div id="global-rank-banner" class="global-banner">
                                    <div class="global-banner-content">
                                        <div class="global-banner-title">${getText('dashboard.globalRank') || '全网排名'}</div>
                                        <div class="global-banner-value" id="global-rank-value">--</div>
                                        <div class="global-banner-label" id="global-rank-label">${getText('dashboard.totalDiagnostics') || '总诊断数'}: --</div>
                                    </div>
                                </div>
                                
                                <!-- 答案之书引用框 -->
                                <div id="answer-book-quote" class="quote-box" style="display: none;">
                                    <div class="quote-box-content" id="answer-book-content"></div>
                                </div>
                            </div>
                            
                            <!-- 聊天记录 -->
                            <div id="chat-history" className="chat-list-section" style="margin-top: 40px; scroll-margin-top: 80px;">
                                <div class="chat-list-header">
                                    <h3 class="chat-list-title">${getText('chatList.title')}</h3>
                                    <div class="chat-list-controls">
                                        <input type="text" id="searchInput" class="search-input" placeholder="${getText('chatList.searchPlaceholder')}">
                                    </div>
                                </div>
                                <div class="chat-list" id="chatList"></div>
                                <div class="pagination-container" id="paginationContainer" style="display: none;">
                                    <div class="pagination-info">
                                        <span id="paginationInfo">${getText('chatList.pagePrefix')} 1 ${getText('chatList.pageSuffix')}，${getText('chatList.totalPrefix')} 1 ${getText('chatList.totalSuffix')}</span>
                                    </div>
                                    <div class="pagination-controls">
                                        <button id="paginationPrev" class="pagination-btn" disabled>${getText('chatList.prev')}</button>
                                        <div class="pagination-pages" id="paginationPages"></div>
                                        <button id="paginationNext" class="pagination-btn">${getText('chatList.next')}</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Analysis Comments - Waline 留言板 -->
                            <div id="analysis-comments" style="margin-top: 60px; padding: 40px 0; scroll-margin-top: 80px;">
                                <div style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 2px; padding: 32px; fontFamily: 'JetBrains Mono', monospace">
                                    <h2 style="color: var(--accent-terminal); fontSize: 18px; fontWeight: 700; textTransform: uppercase; letterSpacing: 0.1em; marginBottom: 24px; display: flex; alignItems: center; gap: 8px">
                                        <span style="color: var(--accent-terminal)">&gt;</span>
                                        <span>${currentLang === 'en' ? 'Analysis Comments' : '分析评论'}</span>
                                    </h2>
                                    <div id="waline-comments"></div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                `;
                
                // 渲染答案之书卡片组件
                setTimeout(() => {
                    const answerBookContainer = document.getElementById('answerBookCardContainer');
                    console.log('[recreateDashboardDOM] 尝试渲染 AnswerBookCard:', {
                        container存在: !!answerBookContainer,
                        containerId: answerBookContainer?.id,
                        windowReact存在: !!window.React,
                        windowReactDOM存在: !!window.ReactDOM,
                        React存在: typeof React !== 'undefined',
                        ReactDOM存在: typeof ReactDOM !== 'undefined',
                        currentLang: currentLang,
                    });
                    
                    if (answerBookContainer && window.React && window.ReactDOM) {
                        console.log('[recreateDashboardDOM] 使用 window.React 渲染');
                        const root = window.ReactDOM.createRoot(answerBookContainer);
                        root.render(window.React.createElement(AnswerBookCard, { lang: currentLang, vibeResult: window.vibeResult || null }));
                        console.log('[recreateDashboardDOM] AnswerBookCard 已渲染');
                    } else if (answerBookContainer && React && ReactDOM) {
                        // 备用方案：如果 React 在局部作用域中
                        console.log('[recreateDashboardDOM] 使用局部 React 渲染');
                        const root = ReactDOM.createRoot(answerBookContainer);
                        root.render(React.createElement(AnswerBookCard, { lang: currentLang, vibeResult: window.vibeResult || null }));
                        console.log('[recreateDashboardDOM] AnswerBookCard 已渲染（备用方案）');
                    } else {
                        console.warn('[recreateDashboardDOM] 无法渲染 AnswerBookCard:', {
                            container存在: !!answerBookContainer,
                            windowReact: !!window.React,
                            windowReactDOM: !!window.ReactDOM,
                            React: typeof React,
                            ReactDOM: typeof ReactDOM,
                        });
                    }
                }, 100);
            };
            
            // 语言切换函数
            const switchLanguage = async (newLang) => {
                setLang(newLang);
                localStorage.setItem('appLanguage', newLang);
                // 更新 HTML lang 属性
                document.documentElement.lang = newLang;
                
                // 如果已经分析完成，重新分析以更新语言
                if (analysisData && window.analysisModule && window.analysisModule.reanalyzeWithLanguage) {
                    try {
                        const newVibeResult = await window.analysisModule.reanalyzeWithLanguage(newLang);
                        if (newVibeResult) {
                            // 更新分析数据
                            setAnalysisData(prev => ({
                                ...prev,
                                vibeResult: newVibeResult
                            }));
                        }
                    } catch (error) {
                        console.error('重新分析失败:', error);
                    }
                }
                
                // 如果是在完整报告页面，重新创建 DOM 并渲染
                if (step === 'fullReport' && window.analysisModule && window.analysisModule.renderFullDashboard) {
                    setTimeout(() => {
                        // 重新创建 Dashboard DOM（使用新语言）
                        recreateDashboardDOM(newLang);
                        
                        // 重新渲染 Dashboard，传递 vibeResult 参数
                        setTimeout(() => {
                            const currentVibeResult = window.analysisModule?.getVibeResult();
                            window.analysisModule.renderFullDashboard(currentVibeResult);
                            // 重新更新排名卡片（使用新语言）
                            if (window.userRankings && window.updateRankingBadges) {
                                setTimeout(async () => {
                                    // 清除缓存，强制重新加载
                                    if (window.rankingDataCache) {
                                        Object.keys(window.rankingDataCache).forEach(key => {
                                            delete window.rankingDataCache[key];
                                        });
                                    }
                                    // 使用全局的updateRankingBadges函数更新排名卡片
                                    await window.updateRankingBadges(window.userRankings, newLang);
                                }, 200);
                            }
                        }, 100);
                    }, 100);
                }
            };
            
            const [step, setStep] = useState('upload');
            const [logs, setLogs] = useState([]);
            const [analysisData, setAnalysisData] = useState(null);
            const [error, setError] = useState(null);
            const [isInitialized, setIsInitialized] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false); // 防止重复触发分析/重复写库
            const [totalTestUsers, setTotalTestUsers] = useState(0); // 从 API 获取，不使用硬编码
            // 实时统计数据（全部从 Cloudflare API 获取）
            const [totalUsers, setTotalUsers] = useState(0); // 受虐人数
            const [techRank, setTechRank] = useState(0); // 技术排名
            const [unlockedCount, setUnlockedCount] = useState(0); // 人格解锁数
            const [isShareMode, setIsShareMode] = useState(false); // 是否为分享查看模式
            const [shareRankings, setShareRankings] = useState(null); // 分享的排名数据
            const [hasHistory, setHasHistory] = useState(false); // 是否有历史记录
            const [shareModal, setShareModal] = useState(null); // 分享弹窗数据 { show: boolean, message: string, shareUrl: string }
            const folderInputRef = useRef(null);
            const fileInputRef = useRef(null);
            // 用于保存动画所需的旧值和新值
            const animationDataRef = useRef(null);
            
            const [modulesReady, setModulesReady] = useState(!!(window.i18n && window.i18n.getText));

            // 滚动到指定section的函数
            const scrollToSection = (e, targetId) => {
                e.preventDefault();
                const element = document.getElementById(targetId);
                if (element) {
                    const offsetTop = element.offsetTop - 80; // 减去header高度
                    window.scrollTo({
                        top: offsetTop,
                        behavior: 'smooth'
                    });
                }
            };

            // 滚动监听高亮当前section
            useEffect(() => {
                if (step !== 'fullReport') return;

                const sections = [
                    'realtime-stats',
                    'global-rankings',
                    'dimension-rankings',
                    'vibe-slang',
                    'personality-lock',
                    'personality-traits',
                    'semantic-fingerprint',
                    'radar-chart',
                    'chat-history',
                    'analysis-comments'
                ];

                const observerOptions = {
                    root: null,
                    rootMargin: '-20% 0px -60% 0px',
                    threshold: 0
                };

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // 移除所有active状态 (PC端)
                            document.querySelectorAll('.toc-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            // 移除所有active状态 (移动端)
                            document.querySelectorAll('.toc-collapsed-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            // 添加active状态到当前section (PC端)
                            const activeItem = document.querySelector(`.toc-item[data-target="${entry.target.id}"]`);
                            if (activeItem) {
                                activeItem.classList.add('active');
                            }
                            // 添加active状态到当前section (移动端)
                            const activeCollapsedItem = document.querySelector(`.toc-collapsed-item[data-target="${entry.target.id}"]`);
                            if (activeCollapsedItem) {
                                activeCollapsedItem.classList.add('active');
                            }
                        }
                    });
                }, observerOptions);

                // 观察所有section
                setTimeout(() => {
                    sections.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            observer.observe(element);
                        }
                    });
                }, 500);

                return () => {
                    sections.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            observer.unobserve(element);
                        }
                    });
                };
            }, [step]);

            // 监听模块加载状态
            useEffect(() => {
                if (modulesReady) return;
                
                const checkModules = () => {
                    if (window.i18n && window.i18n.getText && window.analysisModule) {
                        setModulesReady(true);
                        return true;
                    }
                    return false;
                };

                if (checkModules()) return;

                const interval = setInterval(() => {
                    if (checkModules()) {
                        clearInterval(interval);
                    }
                }, 50);

                return () => clearInterval(interval);
            }, [modulesReady]);

            // 初始化时设置 HTML lang 属性
            useEffect(() => {
                document.documentElement.lang = lang;
                // 更新页面标题
                const titleElement = document.getElementById('pageTitle');
                if (titleElement) {
                    titleElement.textContent = lang === 'en' ? 'Cursor Diagnostics' : 'Cursor 行为体检 - Vibe Coding';
                }
            }, [lang]);

            // 检查历史记录
            useEffect(() => {
                const historyStr = localStorage.getItem('cursor_clinical_history');
                if (historyStr) {
                    try {
                        const history = JSON.parse(historyStr);
                        if (history && history.analysisData) {
                            setHasHistory(true);
                            console.log('[History] 发现历史记录');
                        }
                    } catch (e) {
                        console.error('[History] 解析历史记录失败:', e);
                    }
                }
            }, []);

            // 加载历史记录函数
            const loadHistory = async () => {
                try {
                    const historyStr = localStorage.getItem('cursor_clinical_history');
                    if (!historyStr) return;
                    const history = JSON.parse(historyStr);
                    
                    console.log('[History] 正在加载历史记录，进入预览页面...');
                    
                    let finalAnalysisData = history.analysisData;

                    // 1. 注入数据到 analysisModule (vanilla JS 模块)
                    // 必须先注入数据，才能进行语言切换的重新分析
                    if (window.analysisModule) {
                        if (history.analysisData.stats) {
                            if (window.analysisModule.setGlobalStats) {
                                window.analysisModule.setGlobalStats(history.analysisData.stats);
                            }
                            window.globalStats = history.analysisData.stats;
                        }
                        if (history.analysisData.vibeResult) {
                            if (window.analysisModule.setVibeResult) {
                                window.analysisModule.setVibeResult(history.analysisData.vibeResult);
                            }
                            window.vibeResult = history.analysisData.vibeResult;
                            // 将答案之书写入 localStorage，供 stats2 左侧抽屉「今日箴言」读取
                            try {
                                const ab = history.analysisData.vibeResult.answer_book || history.analysisData.vibeResult.answerBook;
                                if (ab && (ab.title || ab.content)) {
                                    localStorage.setItem('user_answer_book', JSON.stringify(ab));
                                }
                                if (history.analysisData.vibeResult.vibeIndex || history.analysisData.vibeResult.vibe_index) {
                                    localStorage.setItem('user_vibe_index', history.analysisData.vibeResult.vibeIndex || history.analysisData.vibeResult.vibe_index);
                                }
                            } catch (e) {
                                console.warn('[History] 保存答案之书到 localStorage 失败:', e);
                            }
                        }
                        if (history.analysisData.chatData) {
                            if (window.analysisModule.setAllChatData) {
                                window.analysisModule.setAllChatData(history.analysisData.chatData);
                            }
                            window.allChatData = history.analysisData.chatData;
                        }

                        // 2. 检查语言是否需要转换
                        // 如果历史记录的语言与当前 UI 语言不一致，触发重新分析以获取正确的文本
                        if (window.analysisModule.reanalyzeWithLanguage) {
                            console.log('[History] 检查语言对齐，当前 UI 语言:', lang);
                            const newVibeResult = await window.analysisModule.reanalyzeWithLanguage(lang);
                            if (newVibeResult) {
                                console.log('[History] 语言对齐分析完成');
                                finalAnalysisData = {
                                    ...finalAnalysisData,
                                    vibeResult: newVibeResult
                                };
                            }
                        }
                    }
                    
                    // 3. 恢复 React 状态
                    setAnalysisData(finalAnalysisData);
                    if (history.rankings) {
                        window.userRankings = history.rankings;
                    }
                    
                    // 进入预览页面 (人格鉴定结果)
                    setStep('preview');
                } catch (e) {
                    console.error('[History] 加载历史记录失败:', e);
                    setHasHistory(false);
                }
            };

            // 路由解析逻辑：检查 URL Hash 中的分享数据（优化版：支持压缩数据）
            useEffect(() => {
                const hash = window.location.hash;

                // 先检查是否是短链接格式（#s=）
                if (hash && hash.startsWith('#s=')) {
                    try {
                        const encodedString = hash.substring(3); // 去掉 '#s='
                        console.log('[分享] 检测到短链接格式，编码长度:', encodedString.length);

                        // 解码短链接数据
                        const previewData = decodePreviewData(encodedString);

                        if (!previewData) {
                            throw new Error('短链接解码失败');
                        }

                        console.log('[分享] 解码后的预览数据:', previewData);

                        // 将数字索引转换回vibeIndex
                        const vibeIndexStr = numberToVibeIndex(previewData.v);

                        // 从JSON获取人格名称和吐槽文本
                        const loadPersonalityData = async (vibeIndex) => {
                            try {
                                const currentLang = localStorage.getItem('appLanguage') || 'zh-CN';
                                const isEn = currentLang === 'en';
                                
                                const response = await fetch(`src/personalityNames.json`);
                                if (!response.ok) throw new Error('加载人格数据失败');
                                const namesData = await response.json();

                                // 根据语言加载对应的吐槽库
                                const roastLibraryFile = isEn ? 'src/roastLibrary2.json' : 'src/roastLibrary.json';
                                const response2 = await fetch(roastLibraryFile);
                                if (!response2.ok) throw new Error('加载吐槽数据失败');
                                const roastData = await response2.json();

                                const defaultRoastText = isEn ? 'No roast available' : '暂无吐槽';
                                const defaultPersonalityName = isEn ? `Unknown Personality ${vibeIndex}` : `未知人格 ${vibeIndex}`;
                                const fallbackPersonalityName = isEn ? 'Unknown Personality' : '未知人格';
                                const fallbackRoastText = isEn ? 'Failed to load personality data' : '数据加载失败，无法显示人格详情';

                                return {
                                    personalityName: namesData[vibeIndex] || defaultPersonalityName,
                                    vibeIndex: vibeIndex,
                                    roastText: roastData[vibeIndex] || defaultRoastText,
                                    dimensions: null,
                                    personalityType: null,
                                    lpdef: null,
                                    analysis: {
                                        name: namesData[vibeIndex] || defaultPersonalityName,
                                        description: '',
                                        traits: []
                                    }
                                };
                            } catch (error) {
                                console.error('[分享] 加载人格数据失败:', error);
                                const currentLang = localStorage.getItem('appLanguage') || 'zh-CN';
                                const isEn = currentLang === 'en';
                                // 降级：返回默认数据
                                return {
                                    personalityName: isEn ? 'Unknown Personality' : '未知人格',
                                    vibeIndex: vibeIndexStr,
                                    roastText: isEn ? 'Failed to load personality data' : '数据加载失败，无法显示人格详情',
                                    dimensions: null,
                                    personalityType: null,
                                    lpdef: null,
                                    analysis: {
                                        name: isEn ? 'Unknown Personality' : '未知人格',
                                        description: '',
                                        traits: []
                                    }
                                };
                            }
                        };

                        // 异步加载人格数据
                        loadPersonalityData(vibeIndexStr).then(vibeResult => {
                            console.log('[分享] 加载的人格数据:', vibeResult);

                            // 构建简化的stats数据
                            const now = Date.now();
                            const usageDays = previewData.d;
                            const earliestFileTime = now - (usageDays * 24 * 60 * 60 * 1000);

                            console.log('[分享] 构建stats数据:');
                            console.log('[分享]   usageDays:', usageDays);
                            console.log('[分享]   now:', now);
                            console.log('[分享]   earliestFileTime:', earliestFileTime);
                            console.log('[分享]   计算验证:', {
                                差值毫秒: now - earliestFileTime,
                                差值天数: (now - earliestFileTime) / (24 * 60 * 60 * 1000)
                            });

                             const stats = {
                                qingCount: previewData.q,
                                earliestFileTime: earliestFileTime,
                                totalConversations: 0,
                                userMessages: 0,
                                aiMessages: 0,
                                totalCodeChars: 0,
                                buCount: 0,
                                totalUserChars: 0,
                                userBehaviorStats: {
                                    totalUserChars: 0,
                                    avgUserMessageLength: 0,
                                    questionMessageCount: 0,
                                    techStack: {}
                                }
                            };

                            console.log('[分享] 构建的完整stats对象:', JSON.stringify(stats, null, 2));
                            console.log('[分享]   stats.qingCount:', stats.qingCount);
                            console.log('[分享]   stats.earliestFileTime:', stats.earliestFileTime);
                            console.log('[分享]   验证计算:', {
                                解码的usageDays: previewData.d,
                                earliestFileTime: earliestFileTime,
                                now: now,
                                重新计算的天数: Math.floor((now - earliestFileTime) / (24 * 60 * 60 * 1000))
                            });

                            // 设置分享模式
                            setIsShareMode(true);

                            // 存储到全局变量
                            window.shareModeVibeResult = vibeResult;
                            window.shareModeStats = stats;

                            // 构建预览数据
                            const previewDataState = {
                                stats: stats,
                                vibeResult: vibeResult,
                                chatData: [],
                                rankings: null
                            };

                            setAnalysisData(previewDataState);

                            // 进入预览页面
                            setStep('preview');

                            console.log('[分享] ✅ 短链接解析成功，进入预览模式');
                        }).catch(error => {
                            console.error('[分享] 加载人格数据失败:', error);
                            alert('加载人格数据失败，请刷新页面重试');
                        });

                        return; // 短链接处理完成，不继续处理完整链接
                    } catch (error) {
                        console.error('[分享] 短链接解析失败:', error);
                        // 友好的错误提示
                        alert('分享链接格式错误，无法加载数据。\n错误：' + error.message);

                        // 提供测试链接选项
                        if (confirm('是否要生成一个测试链接来验证分享功能？')) {
                            testShareLink();
                        }
                    }
                }
                // 然后检查是否是完整链接格式（#share=）
                else if (hash && hash.startsWith('#share=')) {
                    try {
                        const encodedString = hash.substring(7); // 去掉 '#share='
                        let shareData;
                        
                        // 尝试解压（优先使用 LZ-string）
                        if (typeof LZString !== 'undefined') {
                            try {
                                const decompressed = LZString.decompressFromEncodedURIComponent(encodedString);
                                if (decompressed) {
                                    shareData = JSON.parse(decompressed);
                                    console.log('[分享] 使用 LZ-string 解压成功');
                                } else {
                                    throw new Error('LZ-string 解压失败，尝试 Base64');
                                }
                            } catch (lzError) {
                                console.warn('[分享] LZ-string 解压失败，尝试 Base64:', lzError);
                                // 降级到 Base64
                                const decodedString = decodeURIComponent(atob(encodedString));
                                shareData = JSON.parse(decodedString);
                                console.log('[分享] 使用 Base64 解码成功');
                            }
                        } else {
                            // 直接使用 Base64
                            const decodedString = decodeURIComponent(atob(encodedString));
                            shareData = JSON.parse(decodedString);
                            console.log('[分享] 使用 Base64 解码（LZ-string 不可用）');
                        }
                        
                        // 数据验证
                        if (!shareData || typeof shareData !== 'object') {
                            throw new Error('分享数据格式无效：不是有效的对象');
                        }
                        
                        // 版本检查
                        if (shareData.ver && shareData.ver !== '1.0') {
                            console.warn('[分享] 数据版本不匹配:', shareData.ver, '当前版本: 1.0');
                        }
                        
                        console.log('[分享] 检测到分享链接，数据:', shareData);
                        
                        // 设置分享模式
                        setIsShareMode(true);
                        
                        // 数据格式转换（兼容新旧格式）
                        let rankings = null;
                        let stats = null;
                        let vibeResult = null;
                        
                        // 新格式：r, s, v
                        if (shareData.r) {
                            // 从精简数据构建完整的 rankings 对象
                            rankings = {
                                avgUserMessageLength: {
                                    rank: shareData.r.wordRank,
                                    total: shareData.r.totals?.word || 0
                                },
                                qingCount: {
                                    rank: shareData.r.pleaseRank,
                                    total: shareData.r.totals?.please || 0
                                },
                                buCount: {
                                    rank: shareData.r.noRank,
                                    total: shareData.r.totals?.no || 0
                                },
                                usageDays: {
                                    rank: shareData.r.dayRank,
                                    total: shareData.r.totals?.day || 0
                                },
                                // 补充其他可能的排名字段（如果有的话）
                                userMessages: shareData.r.userMessagesRank ? {
                                    rank: shareData.r.userMessagesRank,
                                    total: shareData.r.totals?.userMessages || 0
                                } : null,
                                totalUserChars: shareData.r.totalCharsRank ? {
                                    rank: shareData.r.totalCharsRank,
                                    total: shareData.r.totals?.totalChars || 0
                                } : null
                            };
                            console.log('[分享] 从精简数据构建的 rankings:', rankings);
                        }
                        
                        // 旧格式兼容：rankings（完整数据）
                        if (shareData.rankings && typeof shareData.rankings === 'object') {
                            // 如果旧格式存在，优先使用（因为它包含更完整的数据）
                            rankings = shareData.rankings;
                            console.log('[分享] 使用旧格式的完整 rankings:', rankings);
                        }
                        
                        // 新格式：s 字段（精简数据）
                        if (shareData.s) {
                            // 将精简数据转换为完整结构
                            stats = {
                                totalConversations: shareData.s.totalConversations || 0,
                                userMessages: shareData.s.userMessages || 0,
                                aiMessages: shareData.s.aiMessages || 0,
                                qingCount: shareData.s.qingCount || 0,
                                buCount: shareData.s.buCount || 0,
                                totalCodeChars: shareData.s.totalCodeChars || 0,
                                earliestFileTime: shareData.s.earliestFileTime || null,
                                // 补充必要的字段
                                modelUsage: {},
                                hourlyActivity: new Array(24).fill(0),
                                dailyActivity: {},
                                topPrompts: {},
                                topChineseWords: {},
                                chineseWords: {},
                                englishWords: {},
                                userBehaviorStats: {
                                    totalUserChars: shareData.s.totalUserChars || 0,
                                    avgUserMessageLength: shareData.s.avgUserMessageLength || 0,
                                    questionMessageCount: shareData.s.questionMessageCount || 0,
                                    techStack: {}
                                }
                            };
                        } 
                        // 旧格式兼容：analysisData.stats（完整数据）
                        else if (shareData.analysisData?.stats) {
                            stats = shareData.analysisData.stats;
                        }
                        
                        // 新格式：v 字段
                        if (shareData.v && typeof shareData.v === 'object') {
                            vibeResult = shareData.v;
                        } 
                        // 旧格式兼容：analysisData.vibeResult
                        else if (shareData.analysisData?.vibeResult) {
                            vibeResult = shareData.analysisData.vibeResult;
                        }
                        
                        setShareRankings({ rankings, stats, vibeResult });
                        
                        // 注入排名数据到全局变量
                        if (rankings) {
                            window.userRankings = rankings;
                        }
                        
                        // 如果有分析数据，存储到全局变量供 analysisModule 使用
                        if (stats) {
                            window.shareModeStats = stats;
                        }
                        if (vibeResult) {
                            window.shareModeVibeResult = vibeResult;
                        }
                        
                        // 分享模式：只显示预览页面，不进入完整报告
                        // 将分享数据设置到 analysisData 状态，供预览页面使用
                        console.log('[分享] 准备设置预览页面数据:', {
                            hasStats: !!stats,
                            hasVibeResult: !!vibeResult,
                            hasRankings: !!rankings
                        });
                        
                        // 构建预览页面需要的数据结构
                        const previewData = {
                            stats: stats || null,
                            vibeResult: vibeResult || null,
                            chatData: [], // 预览页面不需要聊天数据
                            rankings: rankings || null
                        };
                        
                        // 设置到 analysisData 状态
                        setAnalysisData(previewData);
                        
                        // 设置到全局变量（供其他功能使用）
                        if (stats) {
                            window.shareModeStats = stats;
                        }
                        if (vibeResult) {
                            window.shareModeVibeResult = vibeResult;
                        }
                        if (rankings) {
                            window.userRankings = rankings;
                        }
                        
                        // 直接进入预览页面
                        setStep('preview');
                        
                        console.log('[分享] ✅ 已设置预览页面数据，进入预览模式');
                    } catch (error) {
                        console.error('[分享] 解析分享数据失败:', error);
                        console.error('[分享] 错误详情:', {
                            message: error.message,
                            stack: error.stack,
                            hash: hash.substring(0, 100) + '...'
                        });
                        
                        // 友好的错误提示
                        const errorMsg = error.message.includes('JSON') 
                            ? '分享链接格式错误：数据解析失败。请确认链接完整且未被修改。'
                            : error.message.includes('atob') || error.message.includes('decode')
                            ? '分享链接格式错误：数据解码失败。请确认链接完整。'
                            : '分享链接格式错误，无法加载数据。错误：' + error.message;
                        
                        alert(errorMsg);
                        
                        // 提供测试链接选项
                        if (confirm('是否要生成一个测试链接来验证分享功能？')) {
                            testShareLink();
                        }
                    }
                }
            }, []); // 只在组件挂载时执行一次

            // 格式化数字显示
            const formatNumber = (num) => {
                if (typeof num !== 'number' || isNaN(num)) return '0';
                const currentLang = localStorage.getItem('appLanguage') || 'zh-CN';
                const isEn = currentLang === 'en';
                
                // 英文使用标准格式：K, M, B, T
                if (isEn) {
                    if (num >= 1000000000000) {
                        return (num / 1000000000000).toFixed(1) + 'T';
                    }
                    if (num >= 1000000000) {
                        return (num / 1000000000).toFixed(1) + 'B';
                    }
                    if (num >= 1000000) {
                        return (num / 1000000).toFixed(1) + 'M';
                    }
                    if (num >= 1000) {
                        return (num / 1000).toFixed(1) + 'K';
                    }
                    return num.toString();
                }
                
                // 中文使用万、亿等单位（符合中文数字习惯）
                if (num >= 100000000) {
                    // 1亿及以上：使用亿
                    const yi = num / 100000000;
                    if (yi >= 10000) {
                        // 1万亿及以上：使用万亿
                        return (yi / 10000).toFixed(1) + '万亿';
                    }
                    if (yi >= 1000) {
                        // 1千亿及以上：使用千亿
                        return (yi / 1000).toFixed(1) + '千亿';
                    }
                    if (yi >= 100) {
                        // 1百亿及以上：使用百亿
                        return (yi / 100).toFixed(1) + '百亿';
                    }
                    // 1亿-99.9亿：使用亿
                    return yi.toFixed(1) + '亿';
                }
                if (num >= 10000) {
                    // 1万-9999.9万：直接使用万，不显示小数（符合中文习惯）
                    const wan = num / 10000;
                    // 如果整数部分大于等于1000，保留1位小数；否则显示整数
                    if (wan >= 1000) {
                        return wan.toFixed(1) + '万';
                    } else if (wan >= 100) {
                        return Math.round(wan) + '万';
                    } else if (wan >= 10) {
                        return wan.toFixed(1) + '万';
                    } else {
                        return wan.toFixed(1) + '万';
                    }
                }
                if (num >= 1000) {
                    return (num / 1000).toFixed(1) + 'K';
                }
                return num.toString();
            };

            // 数字跳动动画效果函数
            const animateNumberUpdate = (elementId, oldValue, newValue, formatFn) => {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.warn(`[动画] 未找到元素: ${elementId}`);
                    return;
                }

                // 添加跳动动画类
                element.classList.add('animate-pulse');
                
                // 计算差值
                const diff = newValue - oldValue;
                if (diff === 0) {
                    // 没有变化，直接移除动画类
                    setTimeout(() => {
                        element.classList.remove('animate-pulse');
                    }, 100);
                    return;
                }
                
                const duration = 800; // 动画持续时间（毫秒）
                const steps = 30; // 动画步数
                const stepValue = diff / steps;
                const stepDuration = duration / steps;
                let currentStep = 0;
                const startTime = Date.now();
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // 使用缓动函数（ease-out）
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const currentValue = Math.round(oldValue + diff * easeOut);
                    
                    element.textContent = formatFn(currentValue);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // 确保最终值准确
                        element.textContent = formatFn(newValue);
                        // 移除动画类
                        setTimeout(() => {
                            element.classList.remove('animate-pulse');
                        }, 100);
                        console.log(`[动画] ${elementId} 动画完成: ${oldValue} -> ${newValue}`);
                    }
                };
                
                animate();
            };

            // 页面加载时从 API 获取"全网受虐人数"
            useEffect(() => {
                const fetchTotalUsers = async () => {
                    try {
                        // 获取 API 端点（与 main.js 保持一致）
                        const getApiEndpoint = () => {
                            if (typeof window !== 'undefined') {
                                const envApiUrl = window.__API_ENDPOINT__ || window.API_ENDPOINT;
                                if (envApiUrl) {
                                    return envApiUrl;
                                }
                                const metaApi = document.querySelector('meta[name="api-endpoint"]');
                                if (metaApi && metaApi.content) {
                                    const apiUrl = metaApi.content.trim();
                                    // 确保 URL 格式正确（以 / 结尾）
                                    return apiUrl.endsWith('/') ? apiUrl : apiUrl + '/';
                                }
                            }
                            return 'https://cursor-clinical-analysis.psterman.workers.dev/';
                        };
                        
                        const apiUrl = getApiEndpoint();
                        console.log('[React] 发起 GET 请求获取全网受虐人数，API 端点:', apiUrl);
                        
                        const response = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            mode: 'cors',
                            credentials: 'omit', // 避免 CORS 预检问题
                            cache: 'no-cache', // 禁用缓存，确保获取最新数据
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const value = data.value ?? data.totalUsers ?? data.total ?? data.count ?? 0;
                            
                            console.log('[React] API 返回数据:', {
                                raw: data,
                                parsed: value,
                                status: data.status,
                                error: data.error
                            });
                            
                            // 允许显示 0（表示还没有用户）
                            if (typeof value === 'number' && value >= 0) {
                                // 受虐人数：使用 API 返回的实时访问总数（允许显示 0）
                                setTotalUsers(value);
                                setTotalTestUsers(value);
                                
                                // 技术排名：根据总人数按比例动态计算 (value * 0.6)
                                const calculatedRank = Math.floor(value * 0.6);
                                setTechRank(calculatedRank);
                                
                                // 人格库解锁：根据总人数按比例动态计算 (value / 1000)%，最大100%
                                const calculatedUnlocked = Math.min(100, parseFloat((value / 1000).toFixed(1)));
                                setUnlockedCount(calculatedUnlocked);
                                
                                // 保存到本地存储作为 fallback
                                localStorage.setItem('totalTestUsers', value.toString());
                                console.log('[React] ✅ 数据获取成功:', {
                                    totalUsers: value,
                                    techRank: calculatedRank,
                                    unlockedCount: calculatedUnlocked
                                });
                            } else {
                                throw new Error(`API 返回的值无效: ${value} (类型: ${typeof value})`);
                            }
                        } else {
                            const errorText = await response.text().catch(() => '无法读取错误信息');
                            throw new Error(`API 请求失败，状态码: ${response.status}, 错误: ${errorText}`);
                        }
                    } catch (error) {
                        console.warn('[React] ⚠️ API 请求失败，使用 localStorage fallback:', error.message);
                        // 使用 localStorage 作为 fallback（允许显示 0）
                        const cached = parseInt(localStorage.getItem('totalTestUsers') || '0');
                        setTotalUsers(cached);
                        setTotalTestUsers(cached);
                        // 根据缓存值动态计算
                        setTechRank(Math.floor(cached * 0.6));
                        setUnlockedCount(Math.min(100, parseFloat((cached / 1000).toFixed(1))));
                        console.log('[React] 使用缓存数据:', {
                            totalUsers: cached,
                            techRank: Math.floor(cached * 0.6),
                            unlockedCount: Math.min(100, parseFloat((cached / 1000).toFixed(1)))
                        });
                    }
                };
                
                fetchTotalUsers();
            }, []);

            // 初始化 Waline 留言板（仅在结果页面初始化）
            useEffect(() => {
                // 只在结果页面（fullReport）初始化 Waline
                if (step !== 'fullReport') {
                    console.log('ℹ️ 当前不在结果页面，跳过 Waline 初始化');
                    return;
                }
                
                const walineServerURL = 'https://curser-project.vercel.app/';
                let retryCount = 0;
                const maxRetries = 50; // 最多重试 50 次（10秒）
                
                // 等待脚本加载完成
                const waitForScript = () => {
                    return new Promise((resolve) => {
                        // 如果已经加载，直接返回
                        if (window.Waline && typeof window.Waline.init === 'function') {
                            resolve(true);
                            return;
                        }
                        
                        // 检查脚本标签
                        const script = document.querySelector('script[src*="waline.js"]');
                        if (script) {
                            // 如果脚本已加载完成
                            if (script.readyState === 'complete' || script.readyState === 'loaded') {
                                // 再等待一小段时间确保执行完成
                                setTimeout(() => {
                                    resolve(window.Waline && typeof window.Waline.init === 'function');
                                }, 100);
                                return;
                            }
                            
                            // 监听脚本加载完成
                            script.onload = () => {
                                setTimeout(() => {
                                    resolve(window.Waline && typeof window.Waline.init === 'function');
                                }, 100);
                            };
                            
                            // 如果脚本加载失败，也继续尝试
                            script.onerror = () => {
                                resolve(false);
                            };
                        } else {
                            // 没有脚本标签，等待一段时间后检查
                            setTimeout(() => {
                                resolve(window.Waline && typeof window.Waline.init === 'function');
                            }, 500);
                        }
                    });
                };
                
                const initWaline = async () => {
                    const walineContainer = document.getElementById('waline-comments');
                    if (!walineContainer) {
                        console.log('⚠️ Waline 容器元素不存在');
                        return false;
                    }
                    
                    // 检查容器是否可见
                    const style = window.getComputedStyle(walineContainer);
                    if (style.display === 'none' || style.visibility === 'hidden') {
                        console.log('⚠️ Waline 容器不可见，等待...');
                        return false;
                    }
                    
                    // 等待脚本加载完成
                    console.log('⏳ 等待 Waline 脚本加载...');
                    const scriptReady = await waitForScript();
                    if (!scriptReady) {
                        console.log('⚠️ Waline 脚本未就绪');
                        return false;
                    }
                    console.log('✅ Waline 脚本已就绪');
                    
                    // 检查是否已初始化
                    if (walineContainer.hasAttribute('data-waline-initialized')) {
                        console.log('ℹ️ Waline 已初始化，清除旧实例并重新初始化以刷新评论...');
                        // 如果已初始化，清除旧实例并重新初始化，确保使用最新的 path 配置加载评论
                        const existingInstance = walineContainer._walineInstance;
                        if (existingInstance && typeof existingInstance.destroy === 'function') {
                            try {
                                existingInstance.destroy();
                                console.log('🧹 已销毁旧的 Waline 实例');
                            } catch (error) {
                                console.warn('⚠️ 销毁旧实例时出错:', error);
                            }
                        }
                        // 清除标记和实例引用
                        walineContainer.removeAttribute('data-waline-initialized');
                        delete walineContainer._walineInstance;
                        // 清空容器内容
                        if (walineContainer.innerHTML.trim()) {
                            console.log('🧹 清空 Waline 容器内容...');
                            walineContainer.innerHTML = '';
                        }
                    }
                    
                    // 安全检查并初始化
                    if (window.Waline && typeof window.Waline.init === 'function') {
                        try {
                            // 强制路径固定为根路径，确保本地和线上环境统一
                            const currentPath = '/';
                            
                            // 语言映射
                            const walineLang = lang === 'en' ? 'en' : 'zh-CN';
                            
                            // 如果容器内已有内容，先清空（避免重复渲染）
                            if (walineContainer.innerHTML.trim()) {
                                console.log('🧹 清空 Waline 容器，准备重新初始化...');
                                walineContainer.innerHTML = '';
                            }
                            
                            const walineInstance = window.Waline.init({
                                el: '#waline-comments',
                                serverURL: walineServerURL,
                                path: currentPath,  // 固定为根路径，统一存储和读取评论
                                lang: walineLang,
                                meta: ['nick'],
                                requiredMeta: ['nick'],
                                dark: true,
                                login: 'disable',
                                locale: {
                                    placeholder: lang === 'en' ? 'Leave a comment...' : '留下你的评论...',
                                    nick: lang === 'en' ? 'Nickname' : '昵称',
                                    submit: lang === 'en' ? 'SUBMIT' : '提交'
                                }
                            });
                            
                            // 保存实例到容器
                            if (walineInstance) {
                                walineContainer._walineInstance = walineInstance;
                            }
                            
                            walineContainer.setAttribute('data-waline-initialized', 'true');
                            console.log('✅ Waline 初始化成功 - 当前使用根路径: "/"');
                            console.log('📌 Waline 配置 - path: "/", lang: ' + walineLang + ', dark: true, login: disable');
                            
                            return true;
                        } catch (error) {
                            console.error('❌ Waline 初始化失败:', error);
                            return false;
                        }
                    } else {
                        console.error('❌ window.Waline 或 init 方法不存在');
                        return false;
                    }
                };
                
                // 重试初始化
                const tryInit = async () => {
                    if (retryCount >= maxRetries) {
                        console.error(`❌ Waline 初始化超时，已达到最大重试次数 (${maxRetries})`);
                        return;
                    }
                    
                    retryCount++;
                    if (retryCount > 1) {
                        console.log(`🔄 重试初始化 Waline (第 ${retryCount}/${maxRetries} 次)...`);
                    }
                    
                    const success = await initWaline();
                    
                    if (!success) {
                        // 如果未成功，延迟重试
                        setTimeout(tryInit, 200);
                    }
                };
                
                // 延迟启动，确保 DOM 已渲染（结果页面的 DOM 需要时间创建）
                console.log('⏳ 等待结果页面 DOM 渲染完成，准备初始化 Waline...');
                setTimeout(tryInit, 1000);
            }, [step, lang]);

            // 初始化解析器
            useEffect(() => {
                const init = async () => {
                    try {
                        console.log('检查 analysisModule:', window.analysisModule);
                        console.log('检查 analysisModuleLoading:', window.analysisModuleLoading);
                        console.log('检查 analysisModuleError:', window.analysisModuleError);
                        
                        // 等待模块加载（最多等待 5 秒）
                        let retries = 0;
                        const maxRetries = 50; // 50 * 100ms = 5秒
                        
                        while (!window.analysisModule && retries < maxRetries) {
                            // 如果模块加载失败，立即退出
                            if (window.analysisModuleError) {
                                console.error('模块加载失败:', window.analysisModuleError);
                                const errorMsg = window.analysisModuleError.message || t('dashboard.unknownError');
                                setError(`${t('upload.logs.initializingParser')}: ${errorMsg}，${lang === 'en' ? 'please refresh and try again' : '请刷新页面重试'}`);
                                return;
                            }
                            
                            // 如果模块还在加载中，继续等待
                            if (window.analysisModuleLoading !== false) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                retries++;
                            } else {
                                // 加载完成但模块不存在，说明加载失败
                                break;
                            }
                        }
                        
                        if (window.analysisModule) {
                            console.log('✅ 模块已加载，初始化解析器...');
                            await window.analysisModule.initializeParser();
                            setIsInitialized(true);
                            setLogs(prev => [...prev, '> 解析器初始化完成']);
                        } else {
                            console.error('❌ 模块加载超时或失败');
                            const errorMsg = window.analysisModuleError 
                                ? '模块加载失败: ' + window.analysisModuleError.message
                                : '模块加载超时，请刷新页面重试';
                            setError(errorMsg);
                        }
                    } catch (err) {
                        console.error('初始化失败:', err);
                        setError('初始化失败: ' + err.message);
                    }
                };
                
                // 监听模块加载失败事件
                const handleLoadFailed = (event) => {
                    console.error('收到模块加载失败事件:', event.detail);
                    const errorMsg = event.detail.error?.message || t('dashboard.unknownError');
                    setError(`${t('upload.logs.initializingParser')}: ${errorMsg}，${lang === 'en' ? 'please refresh and try again' : '请刷新页面重试'}`);
                };
                window.addEventListener('analysisModuleLoadFailed', handleLoadFailed);
                
                init();
                
                // 清理事件监听器
                return () => {
                    window.removeEventListener('analysisModuleLoadFailed', handleLoadFailed);
                };
            }, []);

            // 处理文件选择
            const handleFileSelect = (type) => {
                console.log('handleFileSelect 被调用', type);
                console.log('folderInputRef.current:', folderInputRef.current);
                console.log('fileInputRef.current:', fileInputRef.current);

                // 请求未返回前禁止重复触发
                if (isSubmitting || step === 'analyzing') {
                    console.warn('[UI] 🛑 分析进行中，忽略重复选择操作');
                    return;
                }
                
                if (type === 'folder') {
                    if (folderInputRef.current) {
                        console.log('触发文件夹选择');
                        folderInputRef.current.click();
                    } else {
                        console.error('folderInputRef.current 为 null');
                    }
                } else {
                    if (fileInputRef.current) {
                        console.log('触发文件选择');
                        fileInputRef.current.click();
                    } else {
                        console.error('fileInputRef.current 为 null');
                    }
                }
            };

            // 处理文件上传
            const handleFileUpload = async (event, type) => {
                console.log('handleFileUpload 被调用', { type, files: event.target.files });

                // 【防重复】同一轮分析未结束前，忽略重复触发（双击/重复 onChange/并发）
                if (isSubmitting || step === 'analyzing') {
                    console.warn('[UI] 🛑 检测到重复触发 handleFileUpload，已忽略');
                    return;
                }
                
                const files = Array.from(event.target.files || []);
                console.log('文件列表:', files.map(f => ({ name: f.name, size: f.size })));
                
                if (files.length === 0) {
                    console.warn('没有选择文件');
                    return;
                }

                setError(null);
                setIsSubmitting(true);
                setStep('analyzing');
                setLogs([`> ${t('upload.logs.startParsing')}`]);

                try {
                    // 检查模块是否加载，如果未加载则等待一段时间
                    if (!window.analysisModule) {
                        console.warn('模块未加载，等待加载...');
                        setLogs(prev => [...prev, `> ${t('upload.logs.waitingModule')}`]);
                        
                        // 等待模块加载（最多等待 3 秒）
                        let retries = 0;
                        const maxRetries = 30; // 30 * 100ms = 3秒
                        
                        while (!window.analysisModule && retries < maxRetries) {
                            // 如果模块加载失败，立即退出
                            if (window.analysisModuleError) {
                                const errorMsg = window.analysisModuleError.message || t('dashboard.unknownError');
                                throw new Error(`${t('upload.logs.initializingParser')}: ${errorMsg}，${lang === 'en' ? 'please refresh and try again' : '请刷新页面重试'}`);
                            }
                            
                            // 如果模块还在加载中，继续等待
                            if (window.analysisModuleLoading !== false) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                retries++;
                            } else {
                                // 加载完成但模块不存在，说明加载失败
                                break;
                            }
                        }
                        
                        if (!window.analysisModule) {
                            const errorMsg = window.analysisModuleError 
                                ? '分析模块加载失败: ' + window.analysisModuleError.message
                                : '分析模块加载超时';
                            throw new Error(errorMsg + '，请刷新页面重试');
                        }
                        
                        console.log('✅ 模块已加载，继续处理文件');
                        setLogs(prev => [...prev, `> ${t('upload.logs.parserReady')}`]);
                    }

                    if (!isInitialized) {
                        setLogs(prev => [...prev, `> ${t('upload.logs.initializingParser')}`]);
                        await window.analysisModule.initializeParser();
                        setIsInitialized(true);
                    }

                    // 调用 main.js 的处理函数
                    console.log('调用 processFiles...');
                    await window.analysisModule.processFiles(files, type, {
                        onLog: (log) => {
                            console.log('onLog:', log);
                            setLogs(prev => [...prev, log]);
                        },
                        onProgress: (current, total, fileName) => {
                            console.log('onProgress:', { current, total, fileName });
                            setLogs(prev => [...prev, `> ${t('upload.logs.processingProgress').replace('{current}', current).replace('{total}', total).replace('{fileName}', fileName)}`]);
                        },
                        onComplete: (data) => {
                            console.log('onComplete:', data);
                            setAnalysisData(data);
                            setLogs(prev => [...prev, `> ${t('upload.logs.analysisComplete')}`]);
                            setTimeout(() => {
                                setStep('preview');
                                setIsSubmitting(false);
                            }, 500);
                        },
                        onError: (err) => {
                            console.error('onError:', err);
                            setError(err.message || '处理失败');
                            setStep('upload');
                            setIsSubmitting(false);
                        }
                    });
                } catch (err) {
                    console.error('处理失败:', err);
                    setError(err.message || '处理失败');
                    setStep('upload');
                    setIsSubmitting(false);
                }
            };


            // 计算排名（基于"请"的次数，简化版）
            // TODO: 用户稍后会修改此函数的参数
            const calculateRank = (qingCount) => {
                // 简化计算：假设平均用户说"请"50次，超过越多排名越高
                const base = 50;
                const ratio = qingCount / base;
                return Math.min(99, Math.max(1, Math.round(ratio * 50)));
            };

            // 计算对话天数（从最早文件时间计算）
            const calculateUsageDays = (stats) => {
                if (!stats || !stats.earliestFileTime) {
                    return 0;
                }
                const now = Date.now();
                const earliest = stats.earliestFileTime;
                const diffMs = now - earliest;
                return Math.floor(diffMs / (1000 * 60 * 60 * 24));
            };

            // 进入完整报告
            const showFullReport = async () => {
                // 【性能优化】立即切换到 fullReport 页面，渲染和数据准备并行执行
                setStep('fullReport');
                
                // 获取当前用户的统计数据（复用已有数据，不阻塞渲染）
                const stats = window.analysisModule?.getGlobalStats();
                const vibeResult = window.analysisModule?.getVibeResult();
                
                // 尝试从已有数据获取排名
                let newCount = 0;
                let rankingResult = null;
                
                if (vibeResult) {
                    const existingTotalUsers = vibeResult?.statistics?.totalUsers ?? vibeResult?.rankData?.totalUsers ?? null;
                    const existingRankPercent = vibeResult?.statistics?.rankPercent ?? vibeResult?.rankData?.rankPercent ?? null;
                    const existingRanks = vibeResult?.rankData?.ranks ?? null;
                    
                    if (existingTotalUsers != null) {
                        newCount = Number(existingTotalUsers) || 0;
                        if (existingRankPercent != null || existingRanks) {
                            rankingResult = {
                                rankPercent: existingRankPercent ?? 0,
                                totalUsers: newCount,
                                ranks: existingRanks
                            };
                        }
                    }
                    
                    // 如果没有已有数据，尝试从 localStorage 读取
                    if (newCount === 0) {
                        try {
                            const cached = localStorage.getItem('totalTestUsers');
                            if (cached) newCount = Number(cached) || 0;
                        } catch { /* ignore */ }
                    }
                }
                
                // 更新状态
                if (newCount > 0) {
                    setTotalUsers(newCount);
                    setTotalTestUsers(newCount);
                    setTechRank(Math.floor(newCount * 0.6));
                    setUnlockedCount(Math.min(100, parseFloat((newCount / 1000).toFixed(1))));
                    
                    // 构建排名数据
                    if (rankingResult?.ranks) {
                        const apiTotalUsers = rankingResult.totalUsers || newCount;
                        const ranks = rankingResult.ranks;
                        const convertPercentToRank = (percent) => {
                            if (!percent || apiTotalUsers <= 0) return null;
                            const beaten = Math.floor(apiTotalUsers * (percent / 100));
                            return Math.max(1, apiTotalUsers - beaten);
                        };
                        window.userRankings = {
                            qingCount: { rank: convertPercentToRank(ranks.ketaoRank), total: apiTotalUsers },
                            buCount: { rank: convertPercentToRank(ranks.jiafangRank), total: apiTotalUsers },
                            userMessages: { rank: convertPercentToRank(ranks.messageRank), total: apiTotalUsers },
                            totalUserChars: { rank: convertPercentToRank(ranks.charRank), total: apiTotalUsers },
                            avgUserMessageLength: { rank: convertPercentToRank(ranks.avgRank), total: apiTotalUsers },
                            usageDays: { rank: convertPercentToRank(ranks.daysRank), total: apiTotalUsers }
                        };
                    }
                }
                
                // 【关键优化】将数据保存到全局变量（立即执行，不阻塞）
                if (analysisData && window.analysisModule) {
                    if (analysisData.stats) window.analysisModule.setGlobalStats(analysisData.stats);
                    if (analysisData.vibeResult) {
                        window.analysisModule.setVibeResult(analysisData.vibeResult);
                        try {
                            const ab = analysisData.vibeResult.answer_book || analysisData.vibeResult.answerBook;
                            if (ab && (ab.title || ab.content)) {
                                localStorage.setItem('user_answer_book', JSON.stringify(ab));
                            }
                            if (analysisData.vibeResult.vibeIndex || analysisData.vibeResult.vibe_index) {
                                localStorage.setItem('user_vibe_index', analysisData.vibeResult.vibeIndex || analysisData.vibeResult.vibe_index);
                            }
                        } catch { /* ignore */ }
                    }
                    if (analysisData.chatData) window.analysisModule.setAllChatData(analysisData.chatData);
                }
                
                // 【关键优化】使用 requestAnimationFrame 完成所有渲染，避免多层嵌套 setTimeout
                requestAnimationFrame(() => {
                    const container = document.getElementById('fullReportContainer');
                    if (!container || !window.analysisModule) return;
                    
                    // 创建 Dashboard DOM
                    recreateDashboardDOM(lang);
                    container.style.display = 'block';
                    
                    // 渲染 Dashboard
                    const dashboardSection = container.querySelector('#dashboardSection');
                    if (dashboardSection) {
                        dashboardSection.classList.remove('hidden');
                        dashboardSection.style.display = 'block';
                    }
                    
                    // 获取数据并渲染
                    const currentStats = window.analysisModule.getGlobalStats();
                    const currentVibeResult = window.analysisModule.getVibeResult();
                    
                    if (currentVibeResult) {
                        window.analysisModule.renderFullDashboard(currentVibeResult);
                    }
                    
                    // 更新排名徽章（非关键路径，延迟执行）
                    if (window.userRankings) {
                        setTimeout(() => {
                            updateRankingBadges(window.userRankings, localStorage.getItem('appLanguage') || 'zh-CN');
                        }, 50);
                    }
                });
                
                // 后台保存历史记录（非阻塞）
                setTimeout(() => {
                    try {
                        const historyData = {
                            analysisData: analysisData,
                            rankings: window.userRankings || null,
                            timestamp: Date.now()
                        };
                        localStorage.setItem('cursor_clinical_history', JSON.stringify(historyData));
                        setHasHistory(true);
                    } catch { /* ignore */ }
                }, 0);
            };

            // ===== 超短分享编码系统 =====

            /**
             * 将人格索引（00000-22222）转换为数字索引（0-242）
             * vibeIndex是5位三进制编码，每位表示一个维度的等级
             */
            const vibeIndexToNumber = (vibeIndex) => {
                // 将字符串转换为数字，然后解析为三进制
                const digits = vibeIndex.split('').map(d => parseInt(d));
                let num = 0;
                for (let i = 0; i < 5; i++) {
                    num = num * 3 + digits[i];
                }
                const result = num; // 0-242
                
                console.log('[vibeIndexToNumber] 转换:', {
                    输入: vibeIndex,
                    数字数组: digits,
                    结果: result,
                    验证: result >= 0 && result < 243
                });
                
                return result;
            };

            /**
             * 将数字索引（0-242）转换回vibeIndex（00000-22222）
             */
            const numberToVibeIndex = (num) => {
                let digits = [];
                for (let i = 0; i < 5; i++) {
                    digits.unshift(num % 3);
                    num = Math.floor(num / 3);
                }
                const result = digits.join('');
                
                console.log('[numberToVibeIndex] 转换:', {
                    输入: num,
                    输出: result,
                    验证: result.length === 5 && /^[\d]{5}$/.test(result)
                });
                
                return result;
            };

            /**
             * URL-safe Base64编码
             * 避免使用+/=等特殊字符，用-_*代替
             */
            const urlSafeBase64Encode = (str) => {
                const base64 = btoa(str);
                return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
            };

            /**
             * URL-safe Base64解码
             */
            const urlSafeBase64Decode = (str) => {
                let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
                // 补全padding
                while (base64.length % 4 !== 0) {
                    base64 += '=';
                }
                return atob(base64);
            };

            /**
             * 超短编码：将预览数据压缩为最短字符串
             * 数据结构：{ v: 0-242, q: qingCount, d: usageDays }
             */
            const encodePreviewData = (data) => {
                const v = data.v || 0;  // 人格索引（0-242，1字节）
                const q = data.q || 0;  // 赛博磕头次数（变长）
                const d = data.d || 0;  // 使用天数（变长，假设最多3650天）

                console.log('[编码] 开始编码数据:', data);
                console.log('[编码] 人格索引 (v):', v);
                console.log('[编码] 赛博磕头 (q):', q);
                console.log('[编码] 使用天数 (d):', d);

                // 将数据打包成字节数组
                // 格式：[v:1字节][q_len:1字节][q:变长][d_len:1字节][d:变长]
                const qBytes = varintEncode(q);
                const dBytes = varintEncode(d);

                console.log('[编码] qBytes编码结果:', Array.from(qBytes), '长度:', qBytes.length);
                console.log('[编码] dBytes编码结果:', Array.from(dBytes), '长度:', dBytes.length);

                // ✅ 修复：正确计算buffer长度并按顺序写入
                const buffer = new Uint8Array(1 + 1 + qBytes.length + 1 + dBytes.length);
                let pos = 0;

                buffer[pos++] = v;              // 字节0: 人格索引
                buffer[pos++] = qBytes.length;     // 字节1: q长度
                for (let i = 0; i < qBytes.length; i++) {  // 字节2+: q值
                    buffer[pos++] = qBytes[i];
                }
                buffer[pos++] = dBytes.length;     // q后面的字节: d长度
                for (let i = 0; i < dBytes.length; i++) {  // d后面的字节: d值
                    buffer[pos++] = dBytes[i];
                }

                console.log('[编码] 完整buffer:', Array.from(buffer), '总长度:', buffer.length);
                console.log('[编码] pos最终值:', pos, '预期buffer长度:', buffer.length);

                // 转换为Base64字符串
                // ✅ 修复：使用逐字节转换避免大值问题
                let binaryString = '';
                for (let i = 0; i < buffer.length; i++) {
                    binaryString += String.fromCharCode(buffer[i]);
                }
                const base64Str = btoa(binaryString);
                console.log('[编码] Base64字符串:', base64Str, '长度:', base64Str.length);

                const encoded = urlSafeBase64Encode(base64Str);
                console.log('[编码] URL-safe编码后:', encoded, '最终长度:', encoded.length);

                return encoded;
            };

            /**
             * 超短解码：从短字符串还原预览数据
             */
            const decodePreviewData = (str) => {
                try {
                    console.log('[解码] 开始解码短链接，输入:', str, '长度:', str.length);

                    const base64Str = urlSafeBase64Decode(str);
                    console.log('[解码] Base64解码后:', base64Str, '长度:', base64Str.length);

                    // ✅ 修复：使用正确的Base64到Uint8Array转换
                    const binaryString = atob(base64Str);
                    const buffer = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        buffer[i] = binaryString.charCodeAt(i);
                    }
                    console.log('[解码] 转换为字节数组，长度:', buffer.length, '内容:', Array.from(buffer));

                    let pos = 0;

                    // 字节0: 人格索引
                    const v = buffer[pos++];
                    console.log('[解码] 人格索引 (v):', v, '对应vibeIndex:', numberToVibeIndex(v));

                    // 字节1: q长度
                    const qLen = buffer[pos++];
                    console.log('[解码] q长度 (qLen):', qLen);

                    // 字节2+: q值
                    const qBytes = new Uint8Array(qLen);
                    for (let i = 0; i < qLen; i++) {
                        qBytes[i] = buffer[pos++];
                    }
                    console.log('[解码] q字节数组:', Array.from(qBytes));

                    // q后面的字节: d长度
                    const dLen = buffer[pos++];
                    console.log('[解码] d长度 (dLen):', dLen);

                    // d后面的字节: d值
                    const dBytes = new Uint8Array(dLen);
                    for (let i = 0; i < dLen; i++) {
                        dBytes[i] = buffer[pos++];
                    }
                    console.log('[解码] d字节数组:', Array.from(dBytes));

                    const q = varintDecode(qBytes);
                    const d = varintDecode(dBytes);

                    console.log('[解码] 解码结果:', { v, q, d }, '对应vibeIndex:', numberToVibeIndex(v));
                    console.log('[解码] pos最终值:', pos, 'buffer长度:', buffer.length);

                    return {
                        v: v,
                        q: q,
                        d: d
                    };
                } catch (error) {
                    console.error('[解码] 解码失败:', error);
                    console.error('[解码] 错误堆栈:', error.stack);
                    return null;
                }
            };

            /**
             * Varint编码（变长整数编码）
             */
            const varintEncode = (num) => {
                const bytes = [];
                while (num > 127) {
                    bytes.push((num & 0x7F) | 0x80);
                    num = Math.floor(num / 128);
                }
                bytes.push(num & 0x7F);
                return new Uint8Array(bytes);
            };

            /**
             * Varint解码
             */
            const varintDecode = (bytes) => {
                let num = 0;
                let shift = 0;
                for (let i = 0; i < bytes.length; i++) {
                    const byte = bytes[i];
                    num |= (byte & 0x7F) << shift;
                    if (!(byte & 0x80)) break;
                    shift += 7;
                }
                return num;
            };

            /**
             * 测试编码/解码函数
             * 在浏览器控制台输入：testShortEncoding() 即可测试
             */
            window.testShortEncoding = () => {
                console.log('===== 测试短链接编码/解码 =====');

                // 测试数据：物理清零探险家 (01020)
                const testData = {
                    vibeIndex: '01020',
                    vibeIndexNum: vibeIndexToNumber('01020'),
                    qingCount: 164,
                    usageDays: 101
                };

                console.log('测试数据:', testData);
                console.log('人格索引转换:', {
                    原始: testData.vibeIndex,
                    数字索引: testData.vibeIndexNum,
                    验证: numberToVibeIndex(testData.vibeIndexNum) === testData.vibeIndex
                });

                // 编码
                const encoded = encodePreviewData({
                    v: testData.vibeIndexNum,
                    q: testData.qingCount,
                    d: testData.usageDays
                });
                console.log('编码结果:', encoded);

                // 解码
                const decoded = decodePreviewData(encoded);
                console.log('解码结果:', decoded);

                if (decoded) {
                    // 验证
                    const match = {
                        人格索引: numberToVibeIndex(decoded.v) === testData.vibeIndex,
                        赛博磕头: decoded.q === testData.qingCount,
                        使用天数: decoded.d === testData.usageDays
                    };

                    console.log('验证结果:', match);

                    if (Object.values(match).every(m => m)) {
                        console.log('✅ 所有数据匹配！');
                    } else {
                        console.error('❌ 数据不匹配！');
                    }
                } else {
                    console.error('❌ 解码失败！');
                }

                return {
                    原始: testData,
                    编码后: encoded,
                    解码后: decoded
                };
            };

            /**
             * 生成短链接的分享函数
             */
            const generateShortShareUrl = () => {
                try {
                    console.log('[分享] ===== 开始生成短链接 =====');

                    const vibeResult = window.analysisModule?.getVibeResult();
                    const stats = window.analysisModule?.getGlobalStats();

                    console.log('[分享] vibeResult:', vibeResult);
                    console.log('[分享] stats:', stats);
                    console.log('[分享] stats.qingCount:', stats?.qingCount);
                    console.log('[分享] stats.earliestFileTime:', stats?.earliestFileTime);

                    if (!vibeResult || !vibeResult.vibeIndex || !stats) {
                        console.warn('[分享] 没有可分享的数据');
                        return null;
                    }

                    // 提取关键数据
                    const vibeIndexNum = vibeIndexToNumber(vibeResult.vibeIndex);
                    const qingCount = stats.qingCount || 0;
                    const usageDays = calculateUsageDays(stats);

                    console.log('[分享] 原始数据:', {
                        vibeIndex: vibeResult.vibeIndex,
                        vibeIndexNum: vibeIndexNum,
                        qingCount: qingCount,
                        usageDays: usageDays
                    });
                    console.log('[分享] calculateUsageDays调用:', {
                        stats: stats,
                        结果: usageDays,
                        earliestFileTime: stats?.earliestFileTime,
                        now: Date.now()
                    });

                    // 编码数据
                    const encoded = encodePreviewData({
                        v: vibeIndexNum,
                        q: qingCount,
                        d: usageDays
                    });

                    console.log('[分享] 编码后长度:', encoded.length, '字符');

                    // 生成链接
                    const basePath = window.location.pathname.replace(/\/[^/]*$/, '') || '';
                    const shareUrl = window.location.origin + basePath + '#s=' + encoded;

                    console.log('[分享] 最终分享链接:', shareUrl);
                    console.log('[分享] 链接总长度:', shareUrl.length, '字符');

                    if (shareUrl.length > 2000) {
                        console.warn('[分享] 链接过长:', shareUrl.length);
                    }

                    return shareUrl;
                } catch (error) {
                    console.error('[分享] 生成短链接失败:', error);
                    console.error('[分享] 错误堆栈:', error.stack);
                    return null;
                }
            };

            // ===== 超短分享编码系统结束 =====

            // 生成分享链接（优化版：优先使用短链接）
            const generateShareUrl = (testMode = false) => {
                try {
                    // 优先尝试生成短链接（用于预览页面分享）
                    const shortUrl = generateShortShareUrl();
                    if (shortUrl) {
                        console.log('[分享] 使用短链接:', shortUrl.length, '字符');
                        return shortUrl;
                    }
                    
                    console.log('[分享] 短链接生成失败，使用完整链接');
                    
                    // 降级到完整链接
                    // 获取排名数据（从 window.userRankings）
                    const rankings = window.userRankings || {};
                    const stats = window.analysisModule?.getGlobalStats() || null;
                    const vibeResult = window.analysisModule?.getVibeResult() || null;
                    
                    // 验证必要数据是否存在
                    if (!stats && !vibeResult && !rankings) {
                        console.warn('[分享] 没有可分享的数据');
                        return null;
                    }
                    
                    // 提取关键数据（精简版，只保存必要信息）
                    const shareData = {
                        ver: '1.0', // 版本号，用于兼容性检查
                        t: Date.now(), // 时间戳
                        // 排名数据（精简）
                        r: {
                            wordRank: rankings.avgUserMessageLength?.rank || null,
                            pleaseRank: rankings.qingCount?.rank || null,
                            noRank: rankings.buCount?.rank || null,
                            dayRank: rankings.usageDays?.rank || null,
                            totals: {
                                word: rankings.avgUserMessageLength?.total || 0,
                                please: rankings.qingCount?.total || 0,
                                no: rankings.buCount?.total || 0,
                                day: rankings.usageDays?.total || 0
                            }
                        },
                        // 统计数据（只保存关键字段）
                        s: stats ? {
                            totalConversations: stats.totalConversations || 0,
                            userMessages: stats.userMessages || 0,
                            aiMessages: stats.aiMessages || 0,
                            qingCount: stats.qingCount || 0,
                            buCount: stats.buCount || 0,
                            totalCodeChars: stats.totalCodeChars || 0,
                            totalUserChars: stats.userBehaviorStats?.totalUserChars || 0,
                            avgUserMessageLength: stats.userBehaviorStats?.avgUserMessageLength || 0,
                            questionMessageCount: stats.userBehaviorStats?.questionMessageCount || 0,
                            earliestFileTime: stats.earliestFileTime || null
                        } : null,
                        // Vibe 结果（只保存关键字段）
                        v: vibeResult ? {
                            personalityType: vibeResult.personalityType || null,
                            personalityName: vibeResult.personalityName || null,
                            vibeIndex: vibeResult.vibeIndex || null,
                            lpdef: vibeResult.lpdef || null,
                            dimensions: vibeResult.dimensions || null,
                            roastText: vibeResult.roastText || null,
                            analysis: vibeResult.analysis ? {
                                name: vibeResult.analysis.name,
                                description: vibeResult.analysis.description,
                                traits: vibeResult.analysis.traits || []
                            } : null
                        } : null
                    };
                    
                    // 转换为 JSON 字符串
                    const jsonString = JSON.stringify(shareData);
                    console.log('[分享] 原始数据大小:', jsonString.length, '字符');
                    
                    // 使用 LZ-string 压缩（如果可用）
                    let compressedString;
                    if (typeof LZString !== 'undefined') {
                        compressedString = LZString.compressToEncodedURIComponent(jsonString);
                        console.log('[分享] 压缩后大小:', compressedString.length, '字符', 
                            '压缩率:', ((1 - compressedString.length / jsonString.length) * 100).toFixed(1) + '%');
                    } else {
                        // 降级方案：使用 Base64
                        compressedString = btoa(encodeURIComponent(jsonString));
                        console.log('[分享] 使用 Base64 编码（未压缩）');
                    }
                    
                    // 生成完整链接
                    const basePath = window.location.pathname.replace(/\/[^/]*$/, '') || '';
                    const shareUrl = window.location.origin + basePath + '#share=' + compressedString;
                    
                    console.log('[分享] 生成的链接长度:', shareUrl.length, '字符');
                    if (shareUrl.length > 2000) {
                        console.warn('[分享] 链接过长，可能在某些浏览器中无法正常工作');
                    }
                    
                    return shareUrl;
                } catch (error) {
                    console.error('[分享] 生成分享链接失败:', error);
                    console.error('[分享] 错误堆栈:', error.stack);
                    return null;
                }
            };

            // 测试分享链接功能（使用真实数据）
            const testShareLink = () => {
                try {
                    // 检查是否有真实数据
                    const currentStats = analysisData?.stats || window.analysisModule?.getGlobalStats() || null;
                    const currentVibeResult = analysisData?.vibeResult || window.analysisModule?.getVibeResult() || null;
                    const currentRankings = window.userRankings || null;
                    
                    if (!currentStats && !currentVibeResult) {
                        alert('没有可用的数据！\n\n请先上传文件并完成分析，然后再测试分享功能。');
                        return;
                    }
                    
                    console.log('[测试] 使用真实数据生成测试链接:', {
                        hasStats: !!currentStats,
                        hasVibeResult: !!currentVibeResult,
                        hasRankings: !!currentRankings
                    });
                    
                    // 使用真实数据构建分享数据
                    const shareData = {
                        ver: '1.0',
                        t: Date.now(),
                        // 排名数据（精简）
                        r: currentRankings ? {
                            wordRank: currentRankings.avgUserMessageLength?.rank || null,
                            pleaseRank: currentRankings.qingCount?.rank || null,
                            noRank: currentRankings.buCount?.rank || null,
                            dayRank: currentRankings.usageDays?.rank || null,
                            totals: {
                                word: currentRankings.avgUserMessageLength?.total || 0,
                                please: currentRankings.qingCount?.total || 0,
                                no: currentRankings.buCount?.total || 0,
                                day: currentRankings.usageDays?.total || 0
                            }
                        } : null,
                        // 同时保存完整格式的 rankings（用于兼容性和完整性）
                        rankings: currentRankings || null,
                        // 统计数据（只保存关键字段）
                        s: currentStats ? {
                            totalConversations: currentStats.totalConversations || 0,
                            userMessages: currentStats.userMessages || 0,
                            aiMessages: currentStats.aiMessages || 0,
                            qingCount: currentStats.qingCount || 0,
                            buCount: currentStats.buCount || 0,
                            totalCodeChars: currentStats.totalCodeChars || 0,
                            totalUserChars: currentStats.userBehaviorStats?.totalUserChars || 0,
                            avgUserMessageLength: currentStats.userBehaviorStats?.avgUserMessageLength || 0,
                            questionMessageCount: currentStats.userBehaviorStats?.questionMessageCount || 0,
                            earliestFileTime: currentStats.earliestFileTime || null
                        } : null,
                        // Vibe 结果（包含所有必要字段：吐槽、人格特色、称号等）
                        v: currentVibeResult ? {
                            personalityType: currentVibeResult.personalityType || null,
                            personalityName: currentVibeResult.personalityName || null,
                            vibeIndex: currentVibeResult.vibeIndex || null,
                            lpdef: currentVibeResult.lpdef || null,
                            dimensions: currentVibeResult.dimensions || null,
                            roastText: currentVibeResult.roastText || null, // 吐槽文本
                            analysis: currentVibeResult.analysis ? {
                                name: currentVibeResult.analysis.name,
                                description: currentVibeResult.analysis.description,
                                traits: currentVibeResult.analysis.traits || [] // 人格特色
                            } : null
                        } : null
                    };
                    
                    // 验证必要数据是否存在
                    if (!shareData.s && !shareData.v) {
                        alert('数据不完整！\n\n缺少必要的统计数据或人格分析结果。\n\n请确保已完成文件分析和人格鉴定。');
                        return;
                    }
                    
                    console.log('[测试] 构建的分享数据:', shareData);
                    
                    // 转换为 JSON 并压缩
                    const jsonString = JSON.stringify(shareData);
                    console.log('[测试] 原始数据大小:', jsonString.length, '字符');
                    
                    let compressedString;
                    if (typeof LZString !== 'undefined') {
                        compressedString = LZString.compressToEncodedURIComponent(jsonString);
                        console.log('[测试] 压缩后大小:', compressedString.length, '字符', 
                            '压缩率:', ((1 - compressedString.length / jsonString.length) * 100).toFixed(1) + '%');
                    } else {
                        compressedString = btoa(encodeURIComponent(jsonString));
                        console.log('[测试] 使用 Base64 编码（未压缩）');
                    }
                    
                    // 生成测试链接
                    const basePath = window.location.pathname.replace(/\/[^/]*$/, '') || '';
                    const testUrl = window.location.origin + basePath + '#share=' + compressedString;
                    
                    console.log('[测试] 生成的测试链接:', testUrl);
                    console.log('[测试] 链接长度:', testUrl.length, '字符');
                    console.log('[测试] 包含的数据:', {
                        有统计数据: !!shareData.s,
                        有人格结果: !!shareData.v,
                        有排名数据: !!shareData.rankings,
                        有吐槽文本: !!shareData.v?.roastText,
                        有人格特色: !!shareData.v?.analysis?.traits,
                        有人格称号: !!shareData.v?.personalityName
                    });
                    
                    if (testUrl.length > 2000) {
                        console.warn('[测试] 链接较长，可能在某些浏览器中无法正常工作');
                    }
                    
                    // 在新窗口打开测试链接
                    if (confirm('✅ 测试链接已生成（使用真实数据）！\n\n包含内容：\n' +
                        (shareData.v?.personalityName ? '• 人格称号：' + shareData.v.personalityName + '\n' : '') +
                        (shareData.v?.roastText ? '• 吐槽文本：' + (shareData.v.roastText.length > 30 ? shareData.v.roastText.substring(0, 30) + '...' : shareData.v.roastText) + '\n' : '') +
                        (shareData.s?.qingCount ? '• 磕头次数：' + shareData.s.qingCount + '\n' : '') +
                        (shareData.s?.earliestFileTime ? '• 使用天数：' + calculateUsageDays(shareData.s) + '\n' : '') +
                        (shareData.rankings ? '• 排名数据：已包含\n' : '') +
                        '\n链接长度: ' + testUrl.length + ' 字符\n\n是否在新窗口打开测试？')) {
                        window.open(testUrl, '_blank');
                    } else {
                        // 复制到剪贴板
                        navigator.clipboard.writeText(testUrl).then(() => {
                            alert('✅ 测试链接已复制到剪贴板！\n\n链接长度: ' + testUrl.length + ' 字符\n\n您可以粘贴到新标签页测试。');
                        }).catch(() => {
                            prompt('请手动复制以下测试链接:', testUrl);
                        });
                    }
                } catch (error) {
                    console.error('[测试] 生成测试链接失败:', error);
                    alert('生成测试链接失败: ' + error.message);
                }
            };
            
            // 分享报告
            const shareReport = async () => {
                const shareUrl = generateShareUrl();
                if (!shareUrl) {
                    const errorMsg = lang === 'en' 
                        ? '[ERROR] Share link generation failed\n\nPossible causes:\n1. No shareable data\n2. Data format error\n\nGenerate test link?'
                        : '[ERROR] 生成分享链接失败\n\n可能的原因：\n1. 没有可分享的数据\n2. 数据格式错误\n\n是否生成测试链接？';
                    if (confirm(errorMsg)) {
                        testShareLink();
                    }
                    return;
                }
                
                // 检查链接长度
                if (shareUrl.length > 2000) {
                    const warningMsg = lang === 'en'
                        ? '[WARNING] Share link is too long (' + shareUrl.length + ' chars)\nMay not work in some browsers.\n\nSuggestions:\n1. Use test link verification\n2. Consider using URL shortener\n\nContinue generating share link?'
                        : '[WARNING] 分享链接较长 (' + shareUrl.length + ' 字符)\n可能在某些浏览器中无法正常工作。\n\n建议：\n1. 使用测试链接验证功能\n2. 或考虑使用短链接服务\n\n是否继续生成分享链接？';
                    const proceed = confirm(warningMsg);
                    if (!proceed) {
                        return;
                    }
                }
                
                try {
                    // 从 tips.json 随机获取提示词
                    const tipsLang = lang === 'en' ? 'en_US' : 'zh_CN';
                    let tipData = null;
                    try {
                        const tipsResponse = await fetch('src/tips.json');
                        if (tipsResponse.ok) {
                            const tipsJson = await tipsResponse.json();
                            const tips = tipsJson[tipsLang];
                            if (tips && Object.keys(tips).length > 0) {
                                const tipKeys = Object.keys(tips);
                                const randomKey = tipKeys[Math.floor(Math.random() * tipKeys.length)];
                                tipData = tips[randomKey];
                            }
                        }
                    } catch (tipsError) {
                        console.warn('[分享] 加载 tips.json 失败，使用默认提示:', tipsError);
                    }
                    
                    // 复制到剪贴板
                    await navigator.clipboard.writeText(shareUrl);
                    
                    // 使用随机提示词或默认提示
                    let successMsg;
                    if (tipData) {
                        // 替换 body 中的 "35" 为实际链接长度
                        const body = tipData.body.replace(/35/g, shareUrl.length.toString());
                        successMsg = tipData.title + '\n\n' + body;
                    } else {
                        // 降级到默认提示
                        successMsg = lang === 'en'
                            ? '[SUCCESS] Share link generated & copied to clipboard\n\nLink length: ' + shareUrl.length + ' chars\n\nDesktop: Interactive | Mobile: View only'
                            : '[SUCCESS] 分享链接已生成并复制到剪贴板\n\n链接长度: ' + shareUrl.length + ' 字符\n\nPC端点开可交互，手机点开直接看结果';
                    }
                    
                    // 显示自定义弹窗而不是 alert
                    setShareModal({
                        show: true,
                        message: successMsg,
                        shareUrl: shareUrl
                    });
                } catch (err) {
                    // 降级方案：使用传统方法
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        
                        // 从 tips.json 随机获取提示词
                        const tipsLang = lang === 'en' ? 'en_US' : 'zh_CN';
                        let tipData = null;
                        try {
                            const tipsResponse = await fetch('src/tips.json');
                            if (tipsResponse.ok) {
                                const tipsJson = await tipsResponse.json();
                                const tips = tipsJson[tipsLang];
                                if (tips && Object.keys(tips).length > 0) {
                                    const tipKeys = Object.keys(tips);
                                    const randomKey = tipKeys[Math.floor(Math.random() * tipKeys.length)];
                                    tipData = tips[randomKey];
                                }
                            }
                        } catch (tipsError) {
                            console.warn('[分享] 加载 tips.json 失败，使用默认提示:', tipsError);
                        }
                        
                        // 使用随机提示词或默认提示
                        let successMsg;
                        if (tipData) {
                            // 替换 body 中的 "35" 为实际链接长度
                            const body = tipData.body.replace(/35/g, shareUrl.length.toString());
                            successMsg = tipData.title + '\n\n' + body;
                        } else {
                            // 降级到默认提示
                            successMsg = lang === 'en'
                                ? '[SUCCESS] Share link generated & copied to clipboard\n\nLink length: ' + shareUrl.length + ' chars\n\nDesktop: Interactive | Mobile: View only'
                                : '[SUCCESS] 分享链接已生成并复制到剪贴板\n\n链接长度: ' + shareUrl.length + ' 字符\n\nPC端点开可交互，手机点开直接看结果';
                        }
                        
                        // 显示自定义弹窗而不是 alert
                        setShareModal({
                            show: true,
                            message: successMsg,
                            shareUrl: shareUrl
                        });
                    } catch (e) {
                        // 如果复制失败，显示链接让用户手动复制
                        const promptMsg = lang === 'en' 
                            ? 'Manual copy required (Ctrl+C):'
                            : '请手动复制以下链接（Ctrl+C）:';
                        const copied = prompt(promptMsg, shareUrl);
                        if (copied) {
                            alert(lang === 'en' ? '[OK] Link copied' : '[OK] 链接已复制');
                        }
                    }
                    document.body.removeChild(textArea);
                }
            };

            // 导出报告
            const exportReport = async () => {
                try {
                    const exportArea = document.getElementById('exportArea');
                    if (!exportArea) {
                        alert('导出区域未找到');
                        return;
                    }
                    
                    const canvas = await html2canvas(exportArea, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        useCORS: true,
                        logging: false,
                    });

                    const link = document.createElement('a');
                    link.download = `cursor-audit-${new Date().getTime()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (err) {
                    console.error('导出失败:', err);
                    alert('导出失败: ' + err.message);
                }
            };

            // 保存预览结果图片
            const savePreviewImage = async () => {
                try {
                    // 获取预览结果容器
                    const previewContainer = document.querySelector('[data-preview-container]');
                    if (!previewContainer) {
                        const errorMsg = lang === 'en' 
                            ? 'Preview container not found' 
                            : '预览容器未找到';
                        alert(errorMsg);
                        return;
                    }

                    // 使用 html2canvas 捕获预览区域
                    const html2canvasLib = window.html2canvas || globalThis.html2canvas;
                    if (!html2canvasLib) {
                        const errorMsg = lang === 'en' 
                            ? 'html2canvas library not loaded' 
                            : 'html2canvas 库未加载';
                        alert(errorMsg);
                        return;
                    }

                    // 添加保存图片的类，强制横版布局
                    previewContainer.classList.add('saving-image');
                    
                    // 等待布局更新
                    await new Promise(resolve => setTimeout(resolve, 100));

                    const canvas = await html2canvasLib(previewContainer, {
                        backgroundColor: '#18181b',
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        allowTaint: true,
                        width: 1200,
                        windowWidth: 1200,
                    });

                    // 移除保存图片的类，恢复原始布局
                    previewContainer.classList.remove('saving-image');

                    // 创建下载链接
                    const link = document.createElement('a');
                    const timestamp = new Date().getTime();
                    // 从 state 或全局变量获取人格名称
                    const currentAnalysisData = analysisData || window.shareModeVibeResult || null;
                    const personalityName = currentAnalysisData?.personalityName || currentAnalysisData?.vibeResult?.personalityName || 'personality';
                    const safeName = personalityName.replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    const filename = `cursor-personality-${safeName}-${timestamp}.png`;
                    link.download = filename;
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    // 显示成功提示
                    const successMsg = lang === 'en' 
                        ? 'Image saved successfully!' 
                        : '图片保存成功！';
                    console.log('[保存图片]', successMsg);
                } catch (err) {
                    console.error('[保存图片] 失败:', err);
                    const errorMsg = lang === 'en' 
                        ? 'Failed to save image: ' + err.message 
                        : '保存图片失败: ' + err.message;
                    alert(errorMsg);
                }
            };

            // 返回初始分析界面
            const resetToUpload = () => {
                // 清空 Hash
                window.location.hash = '';
                // 重置状态
                setIsShareMode(false);
                setShareRankings(null);
                setStep('upload');
                // 刷新页面
                window.location.reload();
            };

            if (!modulesReady) {
                const isEn = lang === 'en';
                return (
                    <div className="min-h-screen bg-black flex flex-col items-center justify-center font-mono p-4">
                        <div className="mb-8 relative">
                            <img src="images/CUBE_2D_DARK.png" width="48" height="48" className="animate-pulse opacity-50" alt="Loading" />
                        </div>
                        <div className="w-48 h-[2px] bg-zinc-900 relative overflow-hidden mb-6">
                            <div className="absolute top-0 left-0 h-full bg-green-500 animate-loading-bar"></div>
                        </div>
                        <div className="space-y-2 text-center">
                            <div className="text-green-500 text-[10px] tracking-[0.3em] uppercase opacity-80">
                                {isEn ? 'System Initialization' : '系统初始化'}
                            </div>
                            <div className="text-zinc-600 text-[9px] font-mono">
                                {isEn ? 'loading neural translation matrices...' : '正在加载神经翻译矩阵...'}
                            </div>
                        </div>
                        <style>{`
                            @keyframes loading-bar {
                                0% { transform: translateX(-100%); }
                                100% { transform: translateX(100%); }
                            }
                            .animate-loading-bar {
                                animation: loading-bar 2s infinite cubic-bezier(0.4, 0, 0.2, 1);
                                width: 100%;
                            }
                        `}</style>
                    </div>
                );
            }

            return (
                <div className="min-h-screen text-zinc-100 p-4 md:p-8 flex flex-col items-center justify-center relative">
                    <div className="fixed top-0 left-0 w-full h-1 bg-green-500 shadow-[0_0_8px_rgba(0,255,65,0.8)] z-50" />

                    {/* 隐藏的文件输入 */}
                    <input 
                        type="file" 
                        ref={folderInputRef}
                        webkitdirectory=""
                        directory=""
                        multiple 
                        style={{ display: 'none' }}
                        onChange={(e) => {
                            console.log('文件夹选择事件触发', e.target.files);
                            if (isSubmitting || step === 'analyzing') {
                                console.warn('[UI] 🛑 分析进行中，忽略重复文件夹选择事件');
                                return;
                            }
                            handleFileUpload(e, 'folder');
                        }}
                    />
                    <input 
                        type="file" 
                        ref={fileInputRef}
                        accept=".vscdb,.db,.sqlite,.sqlite3" 
                        multiple 
                        style={{ display: 'none' }}
                        onChange={(e) => {
                            console.log('文件选择事件触发', e.target.files);
                            if (isSubmitting || step === 'analyzing') {
                                console.warn('[UI] 🛑 分析进行中，忽略重复文件选择事件');
                                return;
                            }
                            handleFileUpload(e, 'file');
                        }}
                    />

                    {/* 语言切换按钮 */}
                    <div style={{
                        position: 'fixed',
                        top: '20px',
                        right: '20px',
                        zIndex: 1000,
                        display: 'flex',
                        gap: '8px'
                    }}>
                        <button
                            onClick={() => switchLanguage('zh-CN')}
                            style={{
                                padding: '0',
                                background: 'transparent',
                                border: lang === 'zh-CN' 
                                    ? '3px solid var(--accent-terminal)' 
                                    : 'none',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                fontFamily: "'JetBrains Mono', monospace",
                                transition: 'opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                width: '44px',
                                height: '44px',
                                opacity: lang === 'zh-CN' ? 1 : 0.6,
                                boxShadow: lang === 'zh-CN' 
                                    ? '0 0 16px rgba(0, 255, 65, 0.6), 0 0 32px rgba(0, 255, 65, 0.3), inset 0 0 20px rgba(0, 255, 65, 0.1)' 
                                    : 'none',
                                transform: lang === 'zh-CN' ? 'scale(1.1)' : 'scale(1)',
                                overflow: 'hidden'
                            }}
                            onMouseEnter={(e) => {
                                if (lang !== 'zh-CN') {
                                    e.currentTarget.style.opacity = '0.9';
                                    e.currentTarget.style.transform = 'scale(1.15)';
                                    e.currentTarget.style.transition = 'opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1)';
                                } else {
                                    // 选中状态：保持 3px 粗边框，只改变缩放和阴影
                                    e.currentTarget.style.border = '3px solid var(--accent-terminal)';
                                    e.currentTarget.style.transform = 'scale(1.15)';
                                    e.currentTarget.style.boxShadow = '0 0 20px rgba(0, 255, 65, 0.8), 0 0 40px rgba(0, 255, 65, 0.4), inset 0 0 25px rgba(0, 255, 65, 0.15)';
                                    e.currentTarget.style.transition = 'opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.25s ease';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (lang === 'zh-CN') {
                                    // 选中状态：保持 3px 粗边框，只改变缩放和阴影
                                    e.currentTarget.style.border = '3px solid var(--accent-terminal)';
                                    e.currentTarget.style.opacity = '1';
                                    e.currentTarget.style.transform = 'scale(1.1)';
                                    e.currentTarget.style.boxShadow = '0 0 16px rgba(0, 255, 65, 0.6), 0 0 32px rgba(0, 255, 65, 0.3), inset 0 0 20px rgba(0, 255, 65, 0.1)';
                                    e.currentTarget.style.transition = 'opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease';
                                } else {
                                    e.currentTarget.style.opacity = '0.6';
                                    e.currentTarget.style.transform = 'scale(1)';
                                    e.currentTarget.style.boxShadow = 'none';
                                    e.currentTarget.style.transition = 'opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease';
                                }
                            }}
                            title="中文"
                        >
                            <img 
                                src="images/zh.png" 
                                alt="中文" 
                                style={{
                                    width: '100%',
                                    height: '100%',
                                    objectFit: 'contain',
                                    borderRadius: '50%',
                                    transition: 'all 0.4s ease',
                                    padding: '2px',
                                    outline: 'none',
                                    border: 'none',
                                    boxShadow: 'none',
                                    WebkitAppearance: 'none',
                                    appearance: 'none'
                                }}
                            />
                        </button>
                        <button
                            onClick={() => switchLanguage('en')}
                            style={{
                                padding: '0',
                                background: 'transparent',
                                border: lang === 'en' 
                                    ? '3px solid var(--accent-terminal)' 
                                    : 'none',
                                borderRadius: '50%',
                                cursor: 'pointer',
                                fontFamily: "'JetBrains Mono', monospace",
                                transition: 'opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                width: '44px',
                                height: '44px',
                                opacity: lang === 'en' ? 1 : 0.6,
                                boxShadow: lang === 'en' 
                                    ? '0 0 16px rgba(0, 255, 65, 0.6), 0 0 32px rgba(0, 255, 65, 0.3), inset 0 0 20px rgba(0, 255, 65, 0.1)' 
                                    : 'none',
                                transform: lang === 'en' ? 'scale(1.1)' : 'scale(1)',
                                overflow: 'hidden'
                            }}
                            onMouseEnter={(e) => {
                                if (lang !== 'en') {
                                    e.currentTarget.style.opacity = '0.9';
                                    e.currentTarget.style.transform = 'scale(1.15)';
                                    e.currentTarget.style.transition = 'opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1)';
                                } else {
                                    // 选中状态：保持 3px 粗边框，只改变缩放和阴影
                                    e.currentTarget.style.border = '3px solid var(--accent-terminal)';
                                    e.currentTarget.style.transform = 'scale(1.15)';
                                    e.currentTarget.style.boxShadow = '0 0 20px rgba(0, 255, 65, 0.8), 0 0 40px rgba(0, 255, 65, 0.4), inset 0 0 25px rgba(0, 255, 65, 0.15)';
                                    e.currentTarget.style.transition = 'opacity 0.25s ease, transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.25s ease';
                                }
                            }}
                            onMouseLeave={(e) => {
                                if (lang === 'en') {
                                    // 选中状态：保持 3px 粗边框，只改变缩放和阴影
                                    e.currentTarget.style.border = '3px solid var(--accent-terminal)';
                                    e.currentTarget.style.opacity = '1';
                                    e.currentTarget.style.transform = 'scale(1.1)';
                                    e.currentTarget.style.boxShadow = '0 0 16px rgba(0, 255, 65, 0.6), 0 0 32px rgba(0, 255, 65, 0.3), inset 0 0 20px rgba(0, 255, 65, 0.1)';
                                    e.currentTarget.style.transition = 'opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease';
                                } else {
                                    e.currentTarget.style.opacity = '0.6';
                                    e.currentTarget.style.transform = 'scale(1)';
                                    e.currentTarget.style.boxShadow = 'none';
                                    e.currentTarget.style.transition = 'opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease';
                                }
                            }}
                            title="English"
                        >
                            <img 
                                src="images/us.png" 
                                alt="English" 
                                style={{
                                    width: '100%',
                                    height: '100%',
                                    objectFit: 'contain',
                                    borderRadius: '50%',
                                    transition: 'all 0.4s ease',
                                    padding: '2px',
                                    outline: 'none',
                                    border: 'none',
                                    boxShadow: 'none',
                                    WebkitAppearance: 'none',
                                    appearance: 'none'
                                }}
                            />
                        </button>
                    </div>

                    {/* 上传阶段 */}
                    {step === 'upload' && (
                        <div className="max-w-2xl w-full space-y-8 text-center">
                            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-zinc-900 border border-zinc-800 text-xs text-white mb-4 mx-auto">
                                <Icon name="zap" size={12} />
                                <a href="https://github.com/psterman/cursor-lab" target="_blank" rel="noopener noreferrer" style={{ color: 'inherit', textDecoration: 'none' }} onMouseEnter={(e) => e.target.style.color = 'var(--accent-terminal)'} onMouseLeave={(e) => e.target.style.color = 'inherit'}>
                                    <span>{t('dashboard.clinicalAnalysis')}</span>
                                </a>
                            </div>
                            <h1 style={{
                                fontSize: 'clamp(2rem, 5vw, 3.5rem)',
                                fontWeight: 800,
                                letterSpacing: '-0.05em',
                                background: 'linear-gradient(to bottom, #fff 30%, #a1a1a1 100%)',
                                WebkitBackgroundClip: 'text',
                                backgroundClip: 'text',
                                WebkitTextFillColor: 'transparent',
                                marginBottom: '15px',
                                transition: 'all 0.3s ease'
                            }}>
                                <a 
                                    href="https://github.com/psterman/cursor-lab" 
                                    target="_blank" 
                                    rel="noopener noreferrer" 
                                    style={{ 
                                        color: 'inherit', 
                                        textDecoration: 'none',
                                        display: 'inline-block',
                                        transition: 'all 0.3s ease',
                                        position: 'relative',
                                        filter: 'blur(2px)'
                                    }} 
                                    onMouseEnter={(e) => { 
                                        e.target.style.filter = 'blur(0px)';
                                        e.target.style.textShadow = '0 0 20px var(--accent-terminal), 0 0 40px var(--accent-terminal)';
                                    }} 
                                    onMouseLeave={(e) => { 
                                        e.target.style.filter = 'blur(2px)';
                                        e.target.style.textShadow = 'none';
                                    }}
                                >
                                    {t('title')}
                                </a>
                            </h1>
                            <p className="text-zinc-500 text-lg max-w-md mx-auto">
                                {t('subtitle')}
                            </p>
                            
                            {error && (
                                <div className="bg-red-900/20 border border-red-800 text-red-400 p-4 rounded-sm font-mono">
                                    {error}
                                </div>
                            )}
                            
                            <div className="group relative p-12 mt-12 border-2 border-dashed border-zinc-800 rounded-sm hover:border-green-500/50 transition-all cursor-pointer bg-zinc-900/50">
                                <div className="relative z-10 space-y-4 text-center">
                                    <a href="https://github.com/psterman/cursor-lab" target="_blank" rel="noopener noreferrer" style={{ display: 'block', textDecoration: 'none' }} onMouseEnter={(e) => { e.target.style.opacity = '0.8'; }} onMouseLeave={(e) => { e.target.style.opacity = '1'; }}>
                                        <img src="images/CUBE_2D_DARK.png" width="64" height="64" style={{ marginBottom: '20px', display: 'block', margin: '0 auto 20px auto' }} className="upload-icon" alt="Upload" />
                                    </a>
                                    <a href="https://github.com/psterman/cursor-lab" target="_blank" rel="noopener noreferrer" style={{ textDecoration: 'none', color: 'inherit' }} onMouseEnter={(e) => { e.target.style.color = 'var(--accent-terminal)'; }} onMouseLeave={(e) => { e.target.style.color = 'var(--text-main)'; }}>
                                        <h2 style={{ marginBottom: '10px', fontSize: '20px', fontWeight: 600, color: 'var(--text-main)' }}>{t('upload.title')}</h2>
                                    </a>
                                    <a href="https://github.com/psterman/cursor-lab" target="_blank" rel="noopener noreferrer" style={{ textDecoration: 'none', color: 'inherit' }} onMouseEnter={(e) => { e.target.style.color = 'var(--accent-terminal)'; }} onMouseLeave={(e) => { e.target.style.color = 'var(--text-dim)'; }}>
                                        <p style={{ color: 'var(--text-dim)', marginBottom: '25px' }}>{t('upload.subtitle')}</p>
                                    </a>
                                    <div className="flex gap-4 justify-center mt-6">
                                        <button 
                                            onClick={() => handleFileSelect('folder')}
                                            disabled={isSubmitting || step === 'analyzing'}
                                            className={`px-6 py-3 bg-green-500 hover:bg-transparent hover:text-green-500 text-black rounded-sm font-semibold transition-colors border border-green-500 uppercase tracking-wider font-mono ${isSubmitting || step === 'analyzing' ? 'opacity-60 cursor-not-allowed pointer-events-none' : ''}`}
                                        >
                                        {t('upload.selectFolder')}
                                        </button>
                                        {hasHistory && (
                                            <button 
                                                onClick={loadHistory}
                                                className="px-6 py-3 bg-transparent hover:bg-zinc-800 text-green-500 rounded-sm font-semibold transition-colors border border-zinc-700 uppercase tracking-wider font-mono"
                                                title={t('upload.viewHistory')}
                                            >
                                                {t('upload.viewHistory')}
                                            </button>
                                        )}
                                        {/* <button 
                                            onClick={() => handleFileSelect('file')}
                                            className="px-6 py-3 bg-transparent hover:bg-zinc-700 text-white rounded-sm font-semibold transition-colors border border-zinc-700 uppercase tracking-wider font-mono"
                                        >
                                            选择state.vscdb
                                        </button> */}
                                    </div>
                                    {/* 救赎路径复制器 */}
                                    <div style={{ 
                                        marginTop: '24px', 
                                        padding: '12px 16px', 
                                        background: 'rgba(24, 24, 27, 0.8)', 
                                        border: '1px solid var(--card-border)', 
                                        borderRadius: '2px',
                                        fontFamily: "'JetBrains Mono', monospace"
                                    }}>
                                        <div style={{ 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            justifyContent: 'space-between', 
                                            gap: '12px',
                                            marginBottom: '8px'
                                        }}>
                                            <code style={{ 
                                                color: 'var(--accent-terminal)', 
                                                fontSize: '12px', 
                                                flex: 1, 
                                                textAlign: 'left',
                                                wordBreak: 'break-all',
                                                fontFamily: "'JetBrains Mono', monospace"
                                            }} id="workspacePath">
                                                {(navigator.platform.toLowerCase().includes('win') || navigator.userAgent.toLowerCase().includes('windows')) 
                                                    ? '%APPDATA%\\Cursor\\User\\workspaceStorage\\' 
                                                    : '~/Library/Application Support/Cursor/User/workspaceStorage/'}
                                            </code>
                                            <button 
                                                onClick={(e) => {
                                                    const pathEl = document.getElementById('workspacePath');
                                                    const path = pathEl ? pathEl.textContent : '';
                                                    navigator.clipboard.writeText(path).then(() => {
                                                        const btn = e.target;
                                                        const originalText = btn.textContent;
                                                        btn.textContent = t('dashboard.copied');
                                                        btn.style.color = 'var(--accent-terminal)';
                                                        btn.style.background = 'var(--accent-terminal)';
                                                        btn.style.color = '#050505';
                                                        setTimeout(() => {
                                                            btn.textContent = originalText;
                                                            btn.style.background = 'transparent';
                                                            btn.style.color = 'var(--accent-terminal)';
                                                        }, 2000);
                                                    }).catch(err => {
                                                        console.error('复制失败:', err);
                                                        alert(t('dashboard.copyFailed'));
                                                    });
                                                }}
                                                style={{
                                                    padding: '6px 12px',
                                                    background: 'transparent',
                                                    border: '1px solid var(--accent-terminal)',
                                                    borderRadius: '2px',
                                                    color: 'var(--accent-terminal)',
                                                    fontSize: '11px',
                                                    cursor: 'pointer',
                                                    fontFamily: "'JetBrains Mono', monospace",
                                                    textTransform: 'uppercase',
                                                    letterSpacing: '0.05em',
                                                    transition: 'all 0.2s ease',
                                                    whiteSpace: 'nowrap'
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.target.style.background = 'var(--accent-terminal)';
                                                    e.target.style.color = '#050505';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.target.style.background = 'transparent';
                                                    e.target.style.color = 'var(--accent-terminal)';
                                                }}
                                            >
                                                {t('dashboard.copy')}
                                            </button>
                                        </div>
                                        <p style={{ 
                                            color: '#ffffff', 
                                            fontSize: '10px', 
                                            margin: 0,
                                            textAlign: 'left',
                                            fontFamily: "'JetBrains Mono', monospace",
                                            opacity: 0.8
                                        }}>
                                            {'> '}{(() => {
                                                const isMac = navigator.platform.toLowerCase().includes('mac') || 
                                                             navigator.userAgent.toLowerCase().includes('mac');
                                                return isMac ? t('upload.pathHelpMac') : t('upload.pathHelp');
                                            })()}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 分析阶段 */}
                    {step === 'analyzing' && (
                        <div className="w-full max-w-lg bg-zinc-950 border border-zinc-800 rounded-sm p-6 shadow-2xl overflow-hidden">
                            <div className="flex items-center gap-2 mb-4 border-b border-zinc-900 pb-3">
                                <Icon name="terminal" size={16} className="text-green-500" />
                                <span className="text-xs text-zinc-500 uppercase tracking-widest">{t('dashboard.systemAnalysis')}</span>
                            </div>
                            <div className="space-y-2 h-64 overflow-y-auto custom-scrollbar">
                                {logs.map((log, i) => (
                                    <div key={i} className="text-sm text-zinc-400 font-mono">
                                        {log}
                                    </div>
                                ))}
                                <div className="w-2 h-5 bg-green-500 animate-pulse inline-block" />
                            </div>
                        </div>
                    )}

                    {/* 预览结果阶段 */}
                    {step === 'preview' && analysisData && (
                        <div className="max-w-4xl w-full space-y-6">
                            {/* 分享模式提示 */}
                            {isShareMode && (
                                <div className="w-full bg-zinc-900/50 border border-zinc-700 rounded-sm p-4 mb-4 flex flex-col sm:flex-row items-center justify-between gap-4">
                                    <div className="flex items-center gap-3">
                                        <Icon name="info" size={20} className="text-green-500" />
                                        <span className="text-white font-mono text-sm sm:text-base">
                                            {lang === 'en' ? '> VIEWING SHARED REPORT' : '> 正在查看分享的报告'}
                                        </span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={savePreviewImage}
                                            className="flex items-center justify-center gap-2 bg-transparent text-green-500 px-6 py-2 rounded-sm font-bold hover:bg-green-500/10 transition-colors border border-green-500 uppercase tracking-wider font-mono text-sm"
                                        >
                                            <Icon name="download" size={16} />
                                            {lang === 'en' ? 'SAVE IMAGE' : '保存图片'}
                                        </button>
                                        <button 
                                            onClick={resetToUpload}
                                            className="flex items-center justify-center gap-2 bg-green-500 text-black px-6 py-2 rounded-sm font-bold hover:bg-transparent hover:text-green-500 transition-colors border border-green-500 uppercase tracking-wider font-mono text-sm"
                                        >
                                            <Icon name="refresh-cw" size={16} />
                                            {lang === 'en' ? 'RUN TEST' : '我也要测'}
                                        </button>
                                    </div>
                                </div>
                            )}
                            
                            {/* 横版卡片布局 - 用于保存图片 */}
                            <div 
                                className="bg-zinc-900 border border-zinc-800 rounded-sm p-6 md:p-8 relative overflow-hidden shadow-2xl preview-card-horizontal"
                                data-preview-container
                            >
                                {/* 左侧：人格信息 */}
                                <div className="preview-card-left">
                                    <div>
                                        <h2 className="text-zinc-500 text-sm uppercase tracking-widest mb-2 font-mono">{t('preview.personalityLabel')}</h2>
                                        <div className="text-4xl md:text-5xl font-black text-white font-mono mb-4" style={{ wordBreak: 'break-word' }}>
                                            {analysisData.vibeResult?.personalityName || t('dashboard.unknownPersonality')}
                                        </div>
                                    </div>
                                    <p 
                                        className="text-zinc-400 preview-text" 
                                        style={{
                                            fontSize: lang === 'en' ? '14px' : '16px',
                                            lineHeight: '1.6',
                                            wordBreak: 'break-word',
                                            whiteSpace: 'normal',
                                            overflow: 'visible'
                                        }}
                                    >
                                        {analysisData.vibeResult?.roastText || t('preview.analyzing')}
                                    </p>
                                </div>

                                {/* 右侧：统计数据 */}
                                <div className="preview-card-right">
                                    <StatBox 
                                        label={t('dashboard.totalUsers')} 
                                        value={formatNumber(totalUsers)} 
                                        sub={t('dashboard.personUnit')} 
                                        color="text-white"
                                        lang={lang}
                                    />
                                    <StatBox 
                                        label={t('dashboard.cyberBowCount')} 
                                        value={analysisData.stats?.qingCount || 0} 
                                        sub={t('dashboard.timesUnit')} 
                                        color="text-white"
                                        lang={lang}
                                    />
                                    <StatBox 
                                        label={t('preview.globalRank')} 
                                        value={calculateRank(analysisData.stats?.qingCount || 0)} 
                                        sub={lang === 'en' ? t('dashboard.rankUnit') : '%'} 
                                        color="text-white"
                                        lang={lang}
                                    />
                                    <StatBox 
                                        label={t('statsLabels.totalConversations')} 
                                        value={calculateUsageDays(analysisData.stats)} 
                                        sub={t('statsLabels.unit.days')} 
                                        color="text-white"
                                        lang={lang}
                                    />
                                </div>
                                
                                <style>{`
                                    .preview-card-horizontal {
                                        display: flex;
                                        flex-direction: row;
                                        align-items: stretch;
                                        min-height: 300px;
                                        width: 100%;
                                        max-width: 1200px;
                                    }
                                    
                                    .preview-card-left {
                                        flex: 1 1 50%;
                                        display: flex;
                                        flex-direction: column;
                                        justify-content: space-between;
                                        padding-right: 24px;
                                        min-width: 0;
                                    }
                                    
                                    .preview-card-right {
                                        flex: 0 0 auto;
                                        display: grid;
                                        grid-template-columns: repeat(2, 1fr);
                                        gap: 16px;
                                        width: ${lang === 'en' ? '460px' : '420px'};
                                        min-width: ${lang === 'en' ? '460px' : '420px'};
                                    }
                                    
                                    .preview-text {
                                        word-break: break-word;
                                        white-space: normal !important;
                                        overflow: visible !important;
                                    }
                                    
                                    @media (max-width: 768px) {
                                        .preview-card-horizontal {
                                            flex-direction: column;
                                            max-width: 100%;
                                        }
                                        
                                        .preview-card-left {
                                            flex: 1 1 100%;
                                            padding-right: 0;
                                            padding-bottom: 24px;
                                        }
                                        
                                        .preview-card-right {
                                            flex: 1 1 100%;
                                            width: 100%;
                                            min-width: 100%;
                                            padding-top: 24px;
                                        }
                                    }
                                    
                                    /* 保存图片时强制横版布局 */
                                    [data-preview-container].saving-image {
                                        flex-direction: row !important;
                                        max-width: 1200px !important;
                                        width: 1200px !important;
                                    }
                                    
                                    [data-preview-container].saving-image .preview-card-left {
                                        flex: 1 1 50% !important;
                                        padding-right: 24px !important;
                                        padding-bottom: 0 !important;
                                    }
                                    
                                    [data-preview-container].saving-image .preview-card-right {
                                        flex: 0 0 auto !important;
                                        width: ${lang === 'en' ? '460px' : '420px'} !important;
                                        min-width: ${lang === 'en' ? '460px' : '420px'} !important;
                                        padding-top: 0 !important;
                                    }
                                `}</style>
                            </div>

                            {/* 分享模式下隐藏操作按钮 */}
                            {!isShareMode && (
                                <div className="flex flex-col sm:flex-row gap-4 justify-center pt-4">
                                    <button 
                                        onClick={showFullReport}
                                        className="flex items-center justify-center gap-2 bg-green-500 text-black px-8 py-4 rounded-sm font-bold hover:bg-transparent hover:text-green-500 transition-colors border border-green-500 uppercase tracking-wider font-mono relative"
                                    >
                                        <Icon name="search" size={18} className="opacity-70" />
                                        <span>{lang === 'en' ? 'INVASIVE PROFILING' : '偷看档案'}</span>
                                        <Icon name="search" size={18} className="opacity-70" />
                                    </button>
                                    <button 
                                        onClick={shareReport}
                                        className="flex items-center justify-center gap-2 bg-transparent text-white px-8 py-4 rounded-sm font-bold hover:bg-zinc-800 transition-colors border border-green-500 uppercase tracking-wider font-mono relative"
                                    >
                                        <Icon name="send" size={18} className="opacity-70" />
                                        <span>{lang === 'en' ? "DON'T @ ME" : '请君入瓮'}</span>
                                        <Icon name="send" size={18} className="opacity-70" />
                                    </button>
                                </div>
                            )}
                        </div>
                    )}

                    {/* 完整报告阶段 */}
                    {step === 'fullReport' && (
                        <div className="w-full" style={{minHeight: '100vh', paddingTop: '64px'}}>
                            {/* 复刻 stats2.html 顶部标题栏（1:1 结构） */}
                            <div className="top-header" role="banner">
                                <div className="top-header-left">
                                    <div className="top-header-title">
                                        <h1>
                                            <span className="text-white">
                                                {lang === 'en'
                                                    ? 'Cursor Behavior Report · Global Distribution Map'
                                                    : 'Cursor行为报告全球分布图'}
                                            </span>
                                        </h1>
                                        <p id="sub-title">
                                            {lang === 'en'
                                                ? 'Telemetry Status // Node: Central_Pacific'
                                                : '实时远程监测状态 // 节点：太平洋中部'}
                                        </p>
                                    </div>
                                </div>

                                <div className="top-header-right">
                                    <div className="top-header-card">
                                        <div className="top-header-card-label">
                                            {lang === 'en' ? 'ACTIVE NODES' : '活跃节点'}
                                        </div>
                                        <div className="top-header-card-value text-emerald-400">
                                            <span className="w-1.5 h-1.5 bg-emerald-400 rounded-full pulse"></span>
                                            <span>0</span> CONNECTED
                                        </div>
                                    </div>
                                    <div className="top-header-card">
                                        <div className="top-header-card-label">
                                            {lang === 'en' ? 'THREAT LEVEL' : '风险评级'}
                                        </div>
                                        <div className="top-header-card-value text-red-500">LEVEL_CRITICAL</div>
                                    </div>
                                    <div className="flex gap-2 items-center">
                                        <button
                                            type="button"
                                            className={`lang-flag-btn ${lang !== 'en' ? 'active' : ''}`}
                                            title="中文"
                                            aria-label="中文"
                                            onClick={() => {
                                                try { localStorage.setItem('lang', 'zh'); } catch {}
                                                switchLanguage('zh-CN');
                                            }}
                                        >
                                            <img
                                                src="images/zh.png"
                                                alt="中文"
                                                onError={(e) => { try { e.currentTarget.style.display = 'none'; } catch {} }}
                                            />
                                            <span style={{position:'absolute', left:'-9999px'}}>🇨🇳</span>
                                        </button>
                                        <button
                                            type="button"
                                            className={`lang-flag-btn ${lang === 'en' ? 'active' : ''}`}
                                            title="English"
                                            aria-label="English"
                                            onClick={() => {
                                                try { localStorage.setItem('lang', 'en'); } catch {}
                                                switchLanguage('en');
                                            }}
                                        >
                                            <img
                                                src="images/us.png"
                                                alt="English"
                                                onError={(e) => { try { e.currentTarget.style.display = 'none'; } catch {} }}
                                            />
                                            <span style={{position:'absolute', left:'-9999px'}}>🇺🇸</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {/* 分享模式提示 */}
                            {isShareMode && (
                                <div className="w-full bg-zinc-900/50 border border-zinc-700 rounded-sm p-4 mb-4 flex flex-col sm:flex-row items-center justify-between gap-4" style={{marginBottom: '20px', maxWidth: '1100px', margin: '0 auto 20px', padding: '16px'}}>
                                    <div className="flex items-center gap-3">
                                        <Icon name="info" size={20} className="text-green-500" />
                                        <span className="text-white font-mono text-sm sm:text-base">
                                            {lang === 'en' ? '> VIEWING SHARED REPORT' : '> 正在查看分享的报告'}
                                        </span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={exportReport}
                                            className="flex items-center justify-center gap-2 bg-transparent text-green-500 px-6 py-2 rounded-sm font-bold hover:bg-green-500/10 transition-colors border border-green-500 uppercase tracking-wider font-mono text-sm"
                                        >
                                            <Icon name="download" size={16} />
                                            {lang === 'en' ? 'SAVE IMAGE' : '保存图片'}
                                        </button>
                                        <button 
                                            onClick={resetToUpload}
                                            className="flex items-center justify-center gap-2 bg-green-500 text-black px-6 py-2 rounded-sm font-bold hover:bg-transparent hover:text-green-500 transition-colors border border-green-500 uppercase tracking-wider font-mono text-sm"
                                        >
                                            <Icon name="refresh-cw" size={16} />
                                            {lang === 'en' ? 'RUN TEST' : '我也要测'}
                                        </button>
                                    </div>
                                </div>
                            )}
                            
                            {/* 竖向目录导航 - PC端 */}
                            {step === 'fullReport' && (
                                <div className="toc-nav">
                                    <span 
                                        className="toc-item active" 
                                        data-target="realtime-stats"
                                        onClick={(e) => scrollToSection(e, 'realtime-stats')}
                                    >
                                        实时统计
                                    </span>
                                    <span 
                                        className="toc-item" 
                                        data-target="global-rankings"
                                        onClick={(e) => scrollToSection(e, 'global-rankings')}
                                    >
                                        横向排名
                                    </span>
                                    <span 
                                        className="toc-item" 
                                        data-target="dimension-rankings"
                                        onClick={(e) => scrollToSection(e, 'dimension-rankings')}
                                    >
                                        排行榜
                                    </span>
                                    <span 
                                        className="toc-item" 
                                        data-target="vibe-slang"
                                        onClick={(e) => scrollToSection(e, 'vibe-slang')}
                                    >
                                        黑话榜
                                    </span>
                                    <span 
                                        className="toc-item" 
                                        data-target="personality-lock"
                                        onClick={(e) => scrollToSection(e, 'personality-lock')}
                                    >
                                        人格锁定
                                    </span>
                                    <span 
                                        className="toc-item" 
                                        data-target="personality-traits"
                                        onClick={(e) => scrollToSection(e, 'personality-traits')}
                                    >
                                        人格特征
                                    </span>
                                    <span 
                                        className="toc-item" 
                                        data-target="semantic-fingerprint"
                                        onClick={(e) => scrollToSection(e, 'semantic-fingerprint')}
                                    >
                                        语义指纹
                                    </span>
                                    <span 
                                        className="toc-item" 
                                        data-target="radar-chart"
                                        onClick={(e) => scrollToSection(e, 'radar-chart')}
                                    >
                                        雷达图
                                    </span>
                                    <span 
                                        className="toc-item" 
                                        data-target="chat-history"
                                        onClick={(e) => scrollToSection(e, 'chat-history')}
                                    >
                                        聊天记录
                                    </span>
                                    <span 
                                        className="toc-item" 
                                        data-target="analysis-comments"
                                        onClick={(e) => scrollToSection(e, 'analysis-comments')}
                                    >
                                        分析评论
                                    </span>
                                </div>
                            )}
                            
                            {/* 移动端折叠目录 */}
                            {step === 'fullReport' && (
                                <div className="toc-collapsed">
                                    <div 
                                        className="toc-collapsed-trigger"
                                        onClick={(e) => {
                                            const trigger = e.currentTarget;
                                            const panel = document.querySelector('.toc-collapsed-panel');
                                            if (panel) {
                                                panel.classList.toggle('open');
                                                trigger.classList.toggle('active');
                                            }
                                        }}
                                    >
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <line x1="3" y1="6" x2="21" y2="6"></line>
                                            <line x1="3" y1="12" x2="21" y2="12"></line>
                                            <line x1="3" y1="18" x2="21" y2="18"></line>
                                        </svg>
                                    </div>
                                    <div className="toc-collapsed-panel">
                                        <span 
                                            className="toc-collapsed-item active" 
                                            data-target="realtime-stats"
                                            onClick={(e) => {
                                                scrollToSection(e, 'realtime-stats');
                                                document.querySelector('.toc-collapsed-panel')?.classList.remove('open');
                                                document.querySelector('.toc-collapsed-trigger')?.classList.remove('active');
                                            }}
                                        >
                                            实时统计
                                        </span>
                                        <span 
                                            className="toc-collapsed-item" 
                                            data-target="global-rankings"
                                            onClick={(e) => {
                                                scrollToSection(e, 'global-rankings');
                                                document.querySelector('.toc-collapsed-panel')?.classList.remove('open');
                                                document.querySelector('.toc-collapsed-trigger')?.classList.remove('active');
                                            }}
                                        >
                                            横向排名
                                        </span>
                                        <span 
                                            className="toc-collapsed-item" 
                                            data-target="dimension-rankings"
                                            onClick={(e) => {
                                                scrollToSection(e, 'dimension-rankings');
                                                document.querySelector('.toc-collapsed-panel')?.classList.remove('open');
                                                document.querySelector('.toc-collapsed-trigger')?.classList.remove('active');
                                            }}
                                        >
                                            排行榜
                                        </span>
                                        <span 
                                            className="toc-collapsed-item" 
                                            data-target="vibe-slang"
                                            onClick={(e) => {
                                                scrollToSection(e, 'vibe-slang');
                                                document.querySelector('.toc-collapsed-panel')?.classList.remove('open');
                                                document.querySelector('.toc-collapsed-trigger')?.classList.remove('active');
                                            }}
                                        >
                                            黑话榜
                                        </span>
                                        <span 
                                            className="toc-collapsed-item" 
                                            data-target="personality-lock"
                                            onClick={(e) => {
                                                scrollToSection(e, 'personality-lock');
                                                document.querySelector('.toc-collapsed-panel')?.classList.remove('open');
                                                document.querySelector('.toc-collapsed-trigger')?.classList.remove('active');
                                            }}
                                        >
                                            人格锁定
                                        </span>
                                        <span 
                                            className="toc-collapsed-item" 
                                            data-target="personality-traits"
                                            onClick={(e) => {
                                                scrollToSection(e, 'personality-traits');
                                                document.querySelector('.toc-collapsed-panel')?.classList.remove('open');
                                                document.querySelector('.toc-collapsed-trigger')?.classList.remove('active');
                                            }}
                                        >
                                            人格特征
                                        </span>
                                        <span 
                                            className="toc-collapsed-item" 
                                            data-target="semantic-fingerprint"
                                            onClick={(e) => {
                                                scrollToSection(e, 'semantic-fingerprint');
                                                document.querySelector('.toc-collapsed-panel')?.classList.remove('open');
                                                document.querySelector('.toc-collapsed-trigger')?.classList.remove('active');
                                            }}
                                        >
                                            语义指纹
                                        </span>
                                        <span 
                                            className="toc-collapsed-item" 
                                            data-target="radar-chart"
                                            onClick={(e) => {
                                                scrollToSection(e, 'radar-chart');
                                                document.querySelector('.toc-collapsed-panel')?.classList.remove('open');
                                                document.querySelector('.toc-collapsed-trigger')?.classList.remove('active');
                                            }}
                                        >
                                            雷达图
                                        </span>
                                        <span 
                                            className="toc-collapsed-item" 
                                            data-target="chat-history"
                                            onClick={(e) => {
                                                scrollToSection(e, 'chat-history');
                                                document.querySelector('.toc-collapsed-panel')?.classList.remove('open');
                                                document.querySelector('.toc-collapsed-trigger')?.classList.remove('active');
                                            }}
                                        >
                                            聊天记录
                                        </span>
                                        <span 
                                            className="toc-collapsed-item" 
                                            data-target="analysis-comments"
                                            onClick={(e) => {
                                                scrollToSection(e, 'analysis-comments');
                                                document.querySelector('.toc-collapsed-panel')?.classList.remove('open');
                                                document.querySelector('.toc-collapsed-trigger')?.classList.remove('active');
                                            }}
                                        >
                                            分析评论
                                        </span>
                                    </div>
                                </div>
                            )}
                            
                            {/* 浮动分享按钮（非分享模式时显示） */}
                            {!isShareMode && (
                                <div className="fixed bottom-24 right-4 z-50" style={{zIndex: 1000}}>
                                    <button 
                                        onClick={shareReport}
                                        className="flex items-center justify-center w-12 h-12 rounded-sm font-bold transition-all border shadow-lg"
                                        style={{
                                            background: '#050505',
                                            border: '1px solid var(--accent-terminal)',
                                            boxShadow: '0 0 8px rgba(0, 255, 65, 0.2)',
                                        }}
                                        title={lang === 'en' ? 'SHARE REPORT' : '分享报告'}
                                    >
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-terminal)" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <circle cx="18" cy="5" r="3"></circle>
                                            <circle cx="6" cy="12" r="3"></circle>
                                            <circle cx="18" cy="19" r="3"></circle>
                                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                                        </svg>
                                    </button>
                                </div>
                            )}
                            
                            <div id="fullReportContainer" style={{display: 'block'}}></div>
                        </div>
                    )}

                    {/* 答案之书模式阶段 */}
                    {step === 'persona' && (
                        <div className="w-full" style={{minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '40px 20px'}}>
                            {(() => {
                                console.log('[App] 渲染 PersonaSection，传递的参数:', {
                                    stats: analysisData?.stats || null,
                                    hasT: typeof t === 'function',
                                    apiEndpoint: apiEndpoint,
                                    lang: lang,
                                    analysisData: analysisData,
                                    step: step,
                                });
                                return (
                                    <PersonaSection 
                                        stats={analysisData?.stats || null} 
                                        t={t} 
                                        apiEndpoint={apiEndpoint} 
                                        lang={lang} 
                                    />
                                );
                            })()}
                        </div>
                    )}


                    {/* 友情链接 */}
                    <div className="friend-links" style={{
                        position: 'fixed',
                        bottom: '20px',
                        left: '50%',
                        transform: 'translateX(-50%)',
                        display: 'flex',
                        gap: '24px',
                        alignItems: 'center',
                        zIndex: 100,
                        fontFamily: "'JetBrains Mono', monospace"
                    }}>
                        <a 
                            href="https://github.com/psterman/nmer" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                padding: '8px 12px',
                                background: 'rgba(24, 24, 27, 0.8)',
                                border: '1px solid var(--card-border)',
                                borderRadius: '2px',
                                color: 'var(--text-main)',
                                textDecoration: 'none',
                                transition: 'all 0.2s ease',
                                fontSize: '12px'
                            }}
                            onMouseEnter={(e) => {
                                e.target.style.borderColor = 'var(--accent-terminal)';
                                e.target.style.color = 'var(--accent-terminal)';
                            }}
                            onMouseLeave={(e) => {
                                e.target.style.borderColor = 'var(--card-border)';
                                e.target.style.color = 'var(--text-main)';
                            }}
                        >
                            <img 
                                className="friend-link-icon"
                                src="https://github.com/psterman/nmer/blob/main/favicon.ico?raw=true" 
                                alt="NMER" 
                                width="24" 
                                height="24"
                            />
                            <span className="friend-link-text">
                                <span className="friend-link-simple">{lang === 'zh-CN' ? '牛马' : 'nmer'}</span>
                                <span className="friend-link-full">{lang === 'zh-CN' ? '牛马 (cursor windows 工具箱)' : 'nmer (cursor windows toolbox)'}</span>
                            </span>
                        </a>
                        <a 
                            href="https://github.com/psterman/curser" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                padding: '8px 12px',
                                background: 'rgba(24, 24, 27, 0.8)',
                                border: '1px solid var(--card-border)',
                                borderRadius: '2px',
                                color: 'var(--text-main)',
                                textDecoration: 'none',
                                transition: 'all 0.2s ease',
                                fontSize: '12px'
                            }}
                            onMouseEnter={(e) => {
                                e.target.style.borderColor = 'var(--accent-terminal)';
                                e.target.style.color = 'var(--accent-terminal)';
                            }}
                            onMouseLeave={(e) => {
                                e.target.style.borderColor = 'var(--card-border)';
                                e.target.style.color = 'var(--text-main)';
                            }}
                        >
                            <img 
                                className="friend-link-icon"
                                src="https://github.com/psterman/nmer/blob/main/curser.ico?raw=true" 
                                alt="CURSER" 
                                width="24" 
                                height="24"
                            />
                            <span className="friend-link-text">
                                <span className="friend-link-simple">{lang === 'zh-CN' ? '抠搜' : 'curser'}</span>
                                <span className="friend-link-full">{lang === 'zh-CN' ? 'curser (cursor 聊天历史查看器)' : 'curser (cursor chat history viewer)'}</span>
                            </span>
                        </a>
                    </div>

                    <style>{`
                        .friend-link-simple {
                            display: inline;
                        }
                        .friend-link-full {
                            display: none;
                        }

                        @media (max-width: 1200px) {
                            .friend-links {
                                position: fixed !important;
                                bottom: 20px !important;
                                left: 50% !important;
                                transform: translateX(-50%) !important;
                                top: auto !important;
                                right: auto !important;
                                display: flex !important;
                                justify-content: center;
                                background: rgba(5, 5, 5, 0.9) !important;
                                border: 1px solid var(--card-border) !important;
                                border-radius: 4px !important;
                                padding: 8px 12px !important;
                                backdrop-filter: blur(10px) !important;
                                gap: 12px !important;
                            }

                            .friend-links a {
                                padding: 6px 10px !important;
                                font-size: 10px !important;
                            }

                            .friend-links img.friend-link-icon {
                                width: 18px !important;
                                height: 18px !important;
                            }

                            .friend-link-simple {
                                display: inline !important;
                            }
                            .friend-link-full {
                                display: none !important;
                            }
                        }

                        @media (min-width: 1201px) {
                            .friend-link-simple {
                                display: none !important;
                            }
                            .friend-link-full {
                                display: inline !important;
                            }
                        }
                    `}</style>

                    {/* 分享弹窗 */}
                    {shareModal && shareModal.show && (
                        <div 
                            style={{
                                position: 'fixed',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                backgroundColor: 'rgba(0, 0, 0, 0.7)',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                zIndex: 10000,
                                padding: '20px'
                            }}
                            onClick={() => setShareModal(null)}
                        >
                            <div 
                                style={{
                                    backgroundColor: '#0a0a0a',
                                    border: '1px solid var(--accent-terminal)',
                                    borderRadius: '4px',
                                    padding: '24px',
                                    maxWidth: '500px',
                                    width: '100%',
                                    boxShadow: '0 0 20px rgba(0, 255, 65, 0.3)'
                                }}
                                onClick={(e) => e.stopPropagation()}
                            >
                                <div style={{
                                    color: 'var(--accent-terminal)',
                                    fontFamily: "'JetBrains Mono', monospace",
                                    fontSize: '14px',
                                    lineHeight: '1.6',
                                    whiteSpace: 'pre-line',
                                    marginBottom: '20px'
                                }}>
                                    {shareModal.message}
                                </div>
                                <div style={{
                                    display: 'flex',
                                    gap: '12px',
                                    justifyContent: 'flex-end',
                                    flexWrap: 'wrap'
                                }}>
                                    <button
                                        onClick={async () => {
                                            try {
                                                await savePreviewImage();
                                            } catch (err) {
                                                console.error('[分享弹窗] 保存图片失败:', err);
                                            }
                                        }}
                                        style={{
                                            padding: '10px 20px',
                                            backgroundColor: 'transparent',
                                            border: '1px solid var(--accent-terminal)',
                                            color: 'var(--accent-terminal)',
                                            borderRadius: '2px',
                                            fontFamily: "'JetBrains Mono', monospace",
                                            fontSize: '12px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.05em',
                                            transition: 'all 0.2s ease'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.target.style.backgroundColor = 'var(--accent-terminal)';
                                            e.target.style.color = '#000';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.target.style.backgroundColor = 'transparent';
                                            e.target.style.color = 'var(--accent-terminal)';
                                        }}
                                    >
                                        {lang === 'en' ? 'SAVE IMAGE' : '保存图片'}
                                    </button>
                                    <button
                                        onClick={() => setShareModal(null)}
                                        style={{
                                            padding: '10px 20px',
                                            backgroundColor: 'var(--accent-terminal)',
                                            border: '1px solid var(--accent-terminal)',
                                            color: '#000',
                                            borderRadius: '2px',
                                            fontFamily: "'JetBrains Mono', monospace",
                                            fontSize: '12px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.05em',
                                            transition: 'all 0.2s ease'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.target.style.backgroundColor = 'transparent';
                                            e.target.style.color = 'var(--accent-terminal)';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.target.style.backgroundColor = 'var(--accent-terminal)';
                                            e.target.style.color = '#000';
                                        }}
                                    >
                                        {lang === 'en' ? 'OK' : '确定'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
</body>
</html>


<!-- 排名功能调试面板（错误时显示） -->
<div id="rankingDebugPanel" style="display: none; position: fixed; bottom: 20px; right: 20px; background: rgba(24, 24, 27, 0.95); border: 1px solid #27272a; padding: 16px; max-width: 400px; z-index: 9999; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #ffffff;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
    <h3 style="color: #ef4444; margin: 0; font-size: 14px;">🏆 排名功能诊断</h3>
    <button onclick="document.getElementById('rankingDebugPanel').style.display='none'" style="background: none; border: 1px solid #27272a; color: #ffffff; padding: 2px 6px; cursor: pointer; font-size: 10px;">×</button>
  </div>
  <div id="rankingDebugContent" style="max-height: 200px; overflow-y: auto;"></div>
</div>

<script>
// 全局函数：显示排名调试信息
function showRankingDebugInfo(errorInfo) {
  const panel = document.getElementById('rankingDebugPanel');
  const content = document.getElementById('rankingDebugContent');
  
  if (!panel || !content) return;
  
  const timestamp = new Date().toLocaleString('zh-CN');
  const isGitHubPages = window.location.hostname.includes('github.io');
  
  let debugHtml = `<div style="margin-bottom: 12px; padding: 8px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 2px;">
    <div style="color: #ef4444; font-weight: bold; margin-bottom: 4px;">⚠️ 排名功能异常</div>
    <div style="font-size: 11px; color: #a1a1aa;">时间: ${timestamp}</div>
    <div style="font-size: 11px; color: #a1a1aa;">环境: ${isGitHubPages ? 'GitHub Pages' : '本地开发'}</div>
  </div>`;
  
  if (errorInfo) {
    debugHtml += `<div style="margin-bottom: 8px;">
      <div style="font-weight: bold; margin-bottom: 4px;">错误详情:</div>
      <pre style="background: rgba(0, 0, 0, 0.3); padding: 6px; border-radius: 2px; font-size: 10px; margin: 0; overflow-x: auto;">${JSON.stringify(errorInfo, null, 2)}</pre>
    </div>`;
  }
  
  debugHtml += `<div style="margin-bottom: 8px;">
    <div style="font-weight: bold; margin-bottom: 4px;">可能原因:</div>
    <ul style="margin: 0; padding-left: 16px; font-size: 11px; color: #a1a1aa;">
      <li>网络连接问题</li>
      <li>跨域请求被阻止</li>
      <li>API 服务器暂时不可用</li>
      <li>浏览器安全策略限制</li>
    </ul>
  </div>`;
  
  if (isGitHubPages) {
    debugHtml += `<div style="margin-bottom: 8px;">
      <div style="font-weight: bold; margin-bottom: 4px;">GitHub Pages 特殊说明:</div>
      <div style="font-size: 11px; color: #a1a1aa;">GitHub Pages 有 CSP 限制，可能阻止 API 请求。建议检查 _headers 文件是否正确配置。</div>
    </div>`;
  }
  
  debugHtml += `<div>
    <div style="font-weight: bold; margin-bottom: 4px;">解决建议:</div>
    <ul style="margin: 0; padding-left: 16px; font-size: 11px; color: #a1a1aa;">
      <li>刷新页面重试</li>
      <li>检查网络连接</li>
      <li>尝试使用不同的浏览器</li>
      <li>联系开发者反馈问题</li>
    </ul>
  </div>`;
  
  content.innerHTML = debugHtml;
  panel.style.display = 'block';
}

// 导出到全局作用域
window.showRankingDebugInfo = showRankingDebugInfo;
</script>

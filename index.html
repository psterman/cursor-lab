<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor 行为体检 - Vibe Coding</title>
    <!-- API 端点配置（Cloudflare Workers） -->
    <meta name="api-endpoint" content="https://cursor-clinical-analysis.psterman.workers.dev/">
    <!-- 引入必要的库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.0/wordcloud2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 0; }
        
        /* Terminal Hacker Style - 极简终端系统 */
        :root {
            --bg-color: #050505;
            --card-bg: rgba(24, 24, 27, 0.8);
            --card-border: #27272a;
            --text-main: #ffffff;
            --text-dim: #71717a;
            --accent-terminal: #00ff41;
            --accent-cyan: #3b82f6;
            --glass-blur: none;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            background-image: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 255, 65, 0.02) 2px,
                    rgba(0, 255, 65, 0.02) 4px
                ),
                radial-gradient(
                    circle,
                    rgba(0, 255, 65, 0.03) 1px,
                    transparent 1px
                );
            background-size: 100% 4px, 20px 20px;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            background: linear-gradient(
                180deg,
                transparent 0%,
                rgba(0, 255, 65, 0.05) 50%,
                transparent 100%
            );
            animation: scanline 8s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        
        .container, header, .stats-grid, .chart-card {
            position: relative;
            z-index: 10;
        }

        .top-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--accent-terminal);
            z-index: 1000;
            box-shadow: 0 0 4px var(--accent-terminal);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px;
            position: relative;
        }
        
        .container::before {
            content: '█';
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: var(--accent-terminal);
            font-size: 16px;
            animation: cursorBlink 0.8s steps(2) infinite;
            pointer-events: none;
            z-index: 1000;
        }

        header {
            text-align: center;
            padding: 60px 20px;
            animation: fadeInDown 0.8s ease-out;
            position: relative;
        }
        
        header::after {
            content: '';
            display: block;
            width: 60px;
            height: 2px;
            background: var(--accent-terminal);
            margin: 30px auto 0;
            box-shadow: 0 0 8px var(--accent-terminal);
        }

        .logo-box {
            display: inline-block;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--card-border);
            border-radius: 2px;
            margin-bottom: 20px;
            font-size: 16px;
            color: var(--accent-terminal);
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }
        
        .logo-box::before {
            content: '> ';
            color: var(--accent-terminal);
            text-shadow: 0 0 4px var(--accent-terminal);
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            letter-spacing: 0.1em;
            color: var(--text-main);
            margin-bottom: 15px;
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }
        
        h1::before {
            content: '> ';
            color: var(--accent-terminal);
            margin-right: 0.2em;
            text-shadow: 0 0 8px var(--accent-terminal);
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 1.1rem;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.05em;
        }
        
        .subtitle::before {
            content: '// ';
            color: var(--accent-terminal);
            opacity: 0.6;
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .stats-grid.hidden {
            display: none;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            padding: 24px;
            transition: border-color 0.2s ease;
            position: relative;
        }
        
        .stat-card:hover {
            border-color: var(--accent-terminal);
            box-shadow: 0 0 8px rgba(0, 255, 65, 0.3);
        }

        .stat-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 16px;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: #fff;
        }

        .stat-comparison {
            font-size: 14px;
            margin-top: 10px;
            color: #ffffff;
            font-weight: 500;
        }
        
        .stat-comparison strong {
            color: var(--accent-terminal);
            font-weight: 700;
        }

        /* 排名显示样式（右下角） */
        .stat-ranking {
            position: absolute;
            bottom: 12px;
            right: 12px;
            font-size: 12px;
            color: var(--text-dim);
            font-weight: 600;
            background: transparent;
            padding: 4px 8px;
            border-radius: 2px;
            border: 1px solid var(--card-border);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-ranking.has-rank {
            color: var(--accent-terminal);
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--accent-terminal);
        }

        .wordcloud-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .wordcloud-section.hidden {
            display: none;
        }

        .chart-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--accent-terminal);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .chart-card:hover::before {
            opacity: 1;
            box-shadow: 0 0 8px var(--accent-terminal);
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .chart-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .wordcloud-container {
            width: 100%;
            height: 400px;
            position: relative;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 19px,
                    rgba(0, 255, 65, 0.05) 19px,
                    rgba(0, 255, 65, 0.05) 20px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 19px,
                    rgba(0, 255, 65, 0.05) 19px,
                    rgba(0, 255, 65, 0.05) 20px
                );
            border-radius: 2px;
            overflow: hidden;
            border: 1px solid var(--card-border);
        }

        .wordcloud-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .prompts-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .prompt-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            transition: all 0.2s ease;
        }

        .prompt-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-terminal);
        }

        .prompt-rank {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-terminal);
            min-width: 30px;
        }

        .prompt-text {
            flex: 1;
            font-size: 16px;
            color: var(--text-main);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .prompt-text::before {
            content: '$ ';
            color: var(--accent-terminal);
            opacity: 0.6;
        }

        .prompt-count {
            font-size: 15px;
            color: var(--text-dim);
            white-space: nowrap;
        }

        .chat-list-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            overflow: hidden;
        }

        .chat-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
            flex-wrap: wrap;
            gap: 12px;
        }

        .chat-list-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .chat-list-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .chat-list-controls {
            display: flex;
            gap: 12px;
        }

        .search-input {
            padding: 10px 16px;
            font-size: 16px;
            border: 1px solid var(--card-border);
            border-radius: 2px;
            width: 300px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-terminal);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 4px var(--accent-terminal);
        }

        .search-input::placeholder {
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chat-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .chat-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--card-border);
            transition: background 0.2s ease;
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .chat-item:last-child {
            border-bottom: none;
        }

        .chat-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chat-role {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 2px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid;
        }

        .role-user {
            background: transparent;
            color: var(--accent-terminal);
            border-color: var(--accent-terminal);
        }

        .role-ai {
            background: transparent;
            color: var(--accent-terminal);
            border-color: var(--accent-terminal);
        }

        .chat-time {
            font-size: 14px;
            color: var(--text-dim);
        }

        .chat-item-content {
            font-size: 16px;
            color: var(--text-dim);
            line-height: 1.6;
            font-family: 'JetBrains Mono', monospace;
        }

        .chat-item-content p {
            margin: 0;
        }
        
        .chat-item-content::first-line {
            color: var(--text-main);
        }

        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-top: 1px solid var(--card-border);
            background: rgba(255, 255, 255, 0.02);
            flex-wrap: wrap;
            gap: 16px;
        }

        .pagination-info {
            font-size: 16px;
            color: var(--text-dim);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            padding: 8px 16px;
            font-size: 16px;
            border: 1px solid var(--card-border);
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-terminal);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-pages {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination-page-btn {
            min-width: 36px;
            height: 36px;
            padding: 0 12px;
            font-size: 16px;
            border: 1px solid var(--card-border);
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-page-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-terminal);
        }

        .pagination-page-btn.active {
            background: var(--accent-terminal);
            color: #050505;
            border-color: var(--accent-terminal);
        }

        .pagination-ellipsis {
            padding: 0 8px;
            color: var(--text-dim);
            font-size: 16px;
        }

        .vibe-codinger-section {
            margin-bottom: 32px;
        }

        .vibe-header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--card-border);
            position: relative;
        }
        
        .vibe-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 1px;
            background: var(--accent-terminal);
            box-shadow: 0 0 8px var(--accent-terminal);
        }

        .vibe-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .vibe-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .vibe-badge {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 40px;
            border-radius: 2px;
            margin-bottom: 16px;
            transition: border-color 0.2s ease;
            border: 1px solid var(--card-border);
        }

        .vibe-badge:hover {
            border-color: var(--accent-terminal);
        }

        .vibe-type {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 0.15em;
            color: var(--text-main);
            text-transform: uppercase;
            font-family: 'JetBrains Mono', monospace;
        }

        .vibe-name {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-main);
        }

        .vibe-description {
            font-size: 16px;
            color: var(--text-dim);
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }

        .vibe-dimensions {
            margin-bottom: 32px;
        }

        .dimensions-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .dimensions-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .dimension-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 2px;
            border: 1px solid var(--card-border);
            margin-bottom: 16px;
            transition: all 0.2s ease;
        }

        .dimension-card:hover {
            border-color: var(--accent-terminal);
            background: rgba(255, 255, 255, 0.05);
        }

        .dimension-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .dimension-key {
            font-size: 26px;
            font-weight: 700;
            color: var(--accent-terminal);
            min-width: 40px;
        }

        .dimension-label {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
            flex: 1;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .dimension-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-main);
            min-width: 50px;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
        }

        .dimension-level {
            font-size: 16px;
            padding: 4px 12px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-dim);
            font-weight: 600;
            border: 1px solid var(--card-border);
        }

        .dimension-bar-container {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0;
            overflow: hidden;
            margin-bottom: 12px;
            border: 1px solid var(--card-border);
            display: flex;
        }

        .dimension-bar {
            height: 100%;
            border-radius: 0;
            transition: width 0.3s steps(20);
            background: repeating-linear-gradient(
                90deg,
                var(--accent-terminal),
                var(--accent-terminal) 6px,
                rgba(0, 255, 65, 0.5) 6px,
                rgba(0, 255, 65, 0.5) 8px,
                var(--accent-terminal) 8px,
                var(--accent-terminal) 14px,
                transparent 14px,
                transparent 16px
            );
            box-shadow: 
                inset 0 0 8px var(--accent-terminal),
                0 0 4px rgba(0, 255, 65, 0.5);
            position: relative;
        }
        
        .dimension-bar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: var(--accent-terminal);
            box-shadow: 0 0 6px var(--accent-terminal);
            animation: barCursor 0.8s steps(2) infinite;
        }
        
        @keyframes barCursor {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        .dimension-interpretation {
            font-size: 17px;
            color: var(--text-main);
            margin-bottom: 8px;
            font-weight: 500;
            line-height: 1.6;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0;
            border-left: 3px solid var(--accent-terminal);
            font-style: normal;
        }
        
        .dimension-interpretation::before {
            content: '// ';
            color: var(--accent-terminal);
            opacity: 0.6;
        }

        .dimension-desc {
            font-size: 14px;
            color: var(--text-dim);
            line-height: 1.5;
        }

        .vibe-roast-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .roast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .roast-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .roast-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .personality-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-terminal);
            padding: 6px 16px;
            background: transparent;
            border-radius: 2px;
            border: 1px solid var(--accent-terminal);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .vibe-index {
            font-size: 16px;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
            border: 1px solid var(--card-border);
        }

        .roast-content {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 0;
            border-left: 4px solid var(--accent-terminal);
            margin-bottom: 16px;
        }

        .roast-text {
            font-size: 17px;
            line-height: 1.8;
            color: var(--text-main);
            margin: 0;
            font-style: normal;
        }
        
        .roast-text::before {
            content: '> ';
            color: var(--accent-terminal);
            opacity: 0.8;
        }

        .dimension-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .dimension-tag {
            font-size: 15px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            color: var(--text-main);
            font-weight: 500;
        }

        .vibe-traits {
            margin-bottom: 32px;
        }

        .traits-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .traits-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .traits-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .trait-tag {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--accent-terminal);
            border-radius: 2px;
            font-size: 16px;
            font-weight: 500;
            color: var(--accent-terminal);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .vibe-fingerprint {
            margin-bottom: 32px;
        }

        .fingerprint-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .fingerprint-title::before {
            content: '> ';
            color: var(--accent-terminal);
        }

        .fingerprint-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .fingerprint-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 2px;
            border: 1px solid var(--card-border);
            text-align: center;
            transition: border-color 0.2s ease;
        }
        
        .fingerprint-item:hover {
            border-color: var(--accent-terminal);
        }

        .fingerprint-label {
            font-size: 15px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .fingerprint-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
            font-family: 'JetBrains Mono', monospace;
        }

        .vibe-chart-container {
            margin-bottom: 32px;
        }

        .vibe-chart-container .chart-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 2px;
            padding: 20px;
            border: 1px solid var(--card-border);
        }

        #vibeRadarChart {
            max-height: 100%;
        }

        .btn {
            background: var(--accent-terminal);
            color: #050505;
            border: 1px solid var(--accent-terminal);
            padding: 12px 32px;
            border-radius: 2px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .btn:hover {
            background: transparent;
            color: var(--accent-terminal);
            box-shadow: 0 0 8px var(--accent-terminal);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .hidden {
            display: none !important;
        }

        @keyframes fadeInDown {
            0% { opacity: 0; transform: translateY(-20px); }
            50% { opacity: 0.5; }
            100% { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            .wordcloud-section {
                grid-template-columns: 1fr;
            }
            .chat-list-header {
                flex-direction: column;
                align-items: stretch;
            }
            .search-input {
                width: 100%;
            }
            .pagination-container {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 终端风格数字动画 */
        @keyframes numberPulse {
            0%, 100% { 
                opacity: 1; 
                color: var(--text-main);
            }
            25% { 
                opacity: 0.3; 
            }
            50% { 
                opacity: 1; 
                color: var(--accent-terminal);
                text-shadow: 0 0 8px var(--accent-terminal);
            }
            75% { 
                opacity: 0.5; 
            }
        }

        @keyframes numberFlash {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0; }
        }

        .stat-value.animate-pulse {
            animation: numberPulse 0.3s steps(4);
        }

        .stat-value.animate-flash {
            animation: numberFlash 0.2s steps(2);
        }

        .stat-value.updating {
            position: relative;
        }

        .stat-value.updating::after {
            content: '_';
            position: absolute;
            right: -12px;
            color: var(--accent-terminal);
            animation: cursorBlink 0.8s steps(2) infinite;
        }

        @keyframes cursorBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body class="bg-[#050505]">
    <div id="root"></div>
    <!-- 完整报告容器（隐藏，等待渲染） -->
    <div id="fullReportContainer" style="display: none;"></div>

    <script type="module">
        // 模块加载逻辑（适配开发和生产环境）
        (async function() {
            // 检测当前部署环境
            const pathname = window.location.pathname;
            const hostname = window.location.hostname;
            const isDev = hostname === 'localhost' || hostname === '127.0.0.1' || hostname.includes('localhost') || hostname.includes('192.168.');
            const isGitHubPages = hostname.includes('github.io');
            
            // 设置加载状态
            window.analysisModuleLoading = true;
            window.analysisModuleError = null;
            
            try {
                let module;
                
                if (isDev) {
                    // 开发环境：直接导入（Vite 会自动处理）
                    console.log('[Main] 开发环境：直接导入 main.js');
                    module = await import('./main.js');
                } else {
                    // 生产环境：动态导入（支持多种部署路径）
                    console.log('[Main] 生产环境：动态导入 main.js');
                    
                    // 检测基础路径（更准确的检测逻辑）
                    let basePath = '';
                    if (isGitHubPages) {
                        // GitHub Pages: 从 pathname 提取仓库名
                        // pathname 可能是: /Cursor-Clinical-Analysis/ 或 /Cursor-Clinical-Analysis/index.html
                        const pathParts = pathname.split('/').filter(p => p);
                        // 移除 'index.html' 如果存在
                        const cleanParts = pathParts.filter(p => p !== 'index.html');
                        if (cleanParts.length > 0) {
                            // 第一个非空部分通常是仓库名
                            basePath = '/' + cleanParts[0];
                        }
                    } else {
                        // 其他生产环境
                        const pathParts = pathname.split('/').filter(p => p && p !== 'index.html');
                        basePath = pathParts.length > 0 ? '/' + pathParts[0] : '';
                    }
                    
                    // 确保 basePath 格式正确
                    if (basePath && basePath !== '/' && basePath.endsWith('/')) {
                        basePath = basePath.slice(0, -1);
                    }

                    // 保存基础路径供其他模块使用
                    window.BASE_PATH = basePath;

                    // 获取当前目录（用于相对路径）
                    const currentDir = pathname.substring(0, pathname.lastIndexOf('/')) || '';
                    
                    // 构建路径列表（GitHub Pages 使用绝对路径，本地使用相对路径）
                    const paths = [];
                    
                    if (isGitHubPages && basePath) {
                        // GitHub Pages：优先使用绝对路径
                        paths.push(`${basePath}/main.js`);
                        paths.push(`${basePath}/dist/main.js`);
                    }
                    
                    // 相对路径（本地环境或备用）
                    paths.push('./main.js');
                    paths.push('./dist/main.js');
                    
                    // 基于当前目录（备用）
                    if (currentDir) {
                        paths.push(`${currentDir}/main.js`);
                        paths.push(`${currentDir}/dist/main.js`);
                    }
                    
                    console.log('[Main] 当前 URL:', window.location.href);
                    console.log('[Main] 当前路径:', pathname);
                    console.log('[Main] 基础路径:', basePath);
                    console.log('[Main] 当前目录:', currentDir);
                    console.log('[Main] 尝试路径列表:', paths);
                    console.log('[Main] 路径数量:', paths.length);
                    
                    if (paths.length === 0) {
                        throw new Error('无法构建有效的模块路径。请检查部署配置。');
                    }
                    
                    let loaded = false;
                    let lastError = null;
                    const errors = [];
                    
                    for (const path of paths) {
                        try {
                            console.log(`[Main] 尝试加载模块，路径: ${path}`);
                            module = await import(/* @vite-ignore */ path);
                            console.log(`[Main] ✅ 成功加载模块，路径: ${path}`);
                            loaded = true;
                            break;
                        } catch (err) {
                            const errorInfo = {
                                path,
                                error: err.message,
                                name: err.name
                            };
                            errors.push(errorInfo);
                            console.warn(`[Main] 路径 ${path} 加载失败:`, err.message);
                            lastError = err;
                        }
                    }
                    
                    if (!loaded) {
                        console.error('[Main] ❌ 所有路径都加载失败');
                        console.error('[Main] 所有尝试的错误:', errors);
                        console.error('[Main] 最后尝试的错误:', lastError);
                        const errorDetails = errors.map(e => `  - ${e.path}: ${e.error}`).join('\n');
                        throw new Error(`模块加载失败：所有路径都尝试失败。\n尝试的路径：\n${errorDetails}\n\n请确认：\n1. 已运行 npm run build\n2. dist/main.js 文件存在\n3. 文件已正确部署到 GitHub Pages`);
                    }
                }
                
                // 检查必需的导出函数
                const requiredExports = [
                    'initializeParser',
                    'processFiles',
                    'renderFullDashboard',
                    'getGlobalStats',
                    'getVibeResult'
                ];
                
                const missingExports = requiredExports.filter(name => 
                    typeof module[name] !== 'function'
                );
                
                if (missingExports.length > 0) {
                    console.error(`[Main] 模块缺少必需的导出:`, missingExports);
                    console.error(`[Main] 模块实际导出:`, Object.keys(module));
                    throw new Error(`模块缺少必需的导出函数: ${missingExports.join(', ')}`);
                }
                
                const { 
                    initializeParser, 
                    processFiles, 
                    renderFullDashboard,
                    getGlobalStats,
                    getVibeResult,
                    updateNumberWithAnimation,
                    formatNumber,
                    fetchTotalTestUsers,
                    reportNewUser,
                    updateGlobalStats
                } = module;
                
                // 将模块暴露给全局，供 React 使用
                window.analysisModule = {
                    initializeParser,
                    processFiles,
                    renderFullDashboard,
                    getGlobalStats,
                    getVibeResult,
                    updateNumberWithAnimation: updateNumberWithAnimation || (() => {}),
                    formatNumber: formatNumber || ((n) => n.toString()),
                    fetchTotalTestUsers: fetchTotalTestUsers || (async () => 0),
                    reportNewUser: reportNewUser || (async () => {}),
                    updateGlobalStats: updateGlobalStats || (() => {})
                };
                
                // 验证全局对象
                console.log('[Main] 全局模块对象已创建:', {
                    hasInitializeParser: typeof window.analysisModule.initializeParser === 'function',
                    hasProcessFiles: typeof window.analysisModule.processFiles === 'function',
                    hasRenderFullDashboard: typeof window.analysisModule.renderFullDashboard === 'function'
                });
                
                window.analysisModuleLoading = false;
                window.analysisModuleError = null;
            } catch (err) {
                console.error('[Main] ❌ 模块加载失败:', err);
                window.analysisModuleLoading = false;
                window.analysisModuleError = err;
                // 触发自定义事件，通知 React 组件
                window.dispatchEvent(new CustomEvent('analysisModuleLoadFailed', { 
                    detail: { error: err } 
                }));
            }
        })();
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // 模拟 Lucide 图标组件
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current) {
                    lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className} style={{width: size, height: size}}></i>;
        };

        // 统计卡片子组件
        function StatBox({ label, value, sub, color }) {
            return (
                <div className="bg-zinc-950/50 border border-zinc-800 p-4 rounded-sm min-w-[120px] md:min-w-[140px]">
                    <div className="text-zinc-600 text-[10px] uppercase tracking-widest mb-1 font-bold">{label}</div>
                    <div className={`text-2xl font-black ${color} font-mono`}>
                        {value}
                        <span className="text-xs ml-1 opacity-50 font-normal text-zinc-400">{sub}</span>
                    </div>
                </div>
            );
        }

        function App() {
            const [step, setStep] = useState('upload');
            const [logs, setLogs] = useState([]);
            const [analysisData, setAnalysisData] = useState(null);
            const [error, setError] = useState(null);
            const [isInitialized, setIsInitialized] = useState(false);
            const [totalTestUsers, setTotalTestUsers] = useState(0); // 从 API 获取，不使用硬编码
            // 实时统计数据（全部从 Cloudflare API 获取）
            const [totalUsers, setTotalUsers] = useState(0); // 受虐人数
            const [techRank, setTechRank] = useState(0); // 技术排名
            const [unlockedCount, setUnlockedCount] = useState(0); // 人格解锁数
            const folderInputRef = useRef(null);
            const fileInputRef = useRef(null);
            // 用于保存动画所需的旧值和新值
            const animationDataRef = useRef(null);

            // 格式化数字显示
            const formatNumber = (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 10000) return (num / 10000).toFixed(1) + '万';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            };

            // 数字跳动动画效果函数
            const animateNumberUpdate = (elementId, oldValue, newValue, formatFn) => {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.warn(`[动画] 未找到元素: ${elementId}`);
                    return;
                }

                // 添加跳动动画类
                element.classList.add('animate-pulse');
                
                // 计算差值
                const diff = newValue - oldValue;
                if (diff === 0) {
                    // 没有变化，直接移除动画类
                    setTimeout(() => {
                        element.classList.remove('animate-pulse');
                    }, 100);
                    return;
                }
                
                const duration = 800; // 动画持续时间（毫秒）
                const steps = 30; // 动画步数
                const stepValue = diff / steps;
                const stepDuration = duration / steps;
                let currentStep = 0;
                const startTime = Date.now();
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // 使用缓动函数（ease-out）
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const currentValue = Math.round(oldValue + diff * easeOut);
                    
                    element.textContent = formatFn(currentValue);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // 确保最终值准确
                        element.textContent = formatFn(newValue);
                        // 移除动画类
                        setTimeout(() => {
                            element.classList.remove('animate-pulse');
                        }, 100);
                        console.log(`[动画] ${elementId} 动画完成: ${oldValue} -> ${newValue}`);
                    }
                };
                
                animate();
            };

            // 页面加载时从 API 获取"全网受虐人数"
            useEffect(() => {
                const fetchTotalUsers = async () => {
                    try {
                        const apiUrl = 'https://cursor-clinical-analysis.psterman.workers.dev/';
                        console.log('[React] 发起 GET 请求获取全网受虐人数...');
                        
                        const response = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            mode: 'cors',
                            cache: 'no-cache',
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const value = data.value || data.totalUsers || data.total || data.count || 0;
                            
                            console.log('[React] API 返回数据:', data, '解析后的值:', value);
                            
                            if (value >= 0) {
                                // 受虐人数：使用 API 返回的实时访问总数（允许显示 0）
                                setTotalUsers(value);
                                setTotalTestUsers(value);
                                
                                // 技术排名：根据总人数按比例动态计算 (value * 0.6)
                                const calculatedRank = Math.floor(value * 0.6);
                                setTechRank(calculatedRank);
                                
                                // 人格库解锁：根据总人数按比例动态计算 (value / 1000)%，最大100%
                                const calculatedUnlocked = Math.min(100, parseFloat((value / 1000).toFixed(1)));
                                setUnlockedCount(calculatedUnlocked);
                                
                                // 保存到本地存储作为 fallback
                                localStorage.setItem('totalTestUsers', value.toString());
                                console.log('[React] 数据获取成功:', {
                                    totalUsers: value,
                                    techRank: calculatedRank,
                                    unlockedCount: calculatedUnlocked
                                });
                            } else {
                                throw new Error('API 返回的值无效');
                            }
                        } else {
                            throw new Error(`API 请求失败，状态码: ${response.status}`);
                        }
                    } catch (error) {
                        console.warn('[React] API 请求失败，使用 localStorage fallback:', error.message);
                        // 使用 localStorage 作为 fallback（允许显示 0）
                        const cached = parseInt(localStorage.getItem('totalTestUsers') || '0');
                        setTotalUsers(cached);
                        setTotalTestUsers(cached);
                        // 根据缓存值动态计算
                        setTechRank(Math.floor(cached * 0.6));
                        setUnlockedCount(Math.min(100, parseFloat((cached / 1000).toFixed(1))));
                        console.log('[React] 使用缓存数据:', {
                            totalUsers: cached,
                            techRank: Math.floor(cached * 0.6),
                            unlockedCount: Math.min(100, parseFloat((cached / 1000).toFixed(1)))
                        });
                    }
                };
                
                fetchTotalUsers();
            }, []);

            // 初始化解析器
            useEffect(() => {
                const init = async () => {
                    try {
                        console.log('检查 analysisModule:', window.analysisModule);
                        console.log('检查 analysisModuleLoading:', window.analysisModuleLoading);
                        console.log('检查 analysisModuleError:', window.analysisModuleError);
                        
                        // 等待模块加载（最多等待 5 秒）
                        let retries = 0;
                        const maxRetries = 50; // 50 * 100ms = 5秒
                        
                        while (!window.analysisModule && retries < maxRetries) {
                            // 如果模块加载失败，立即退出
                            if (window.analysisModuleError) {
                                console.error('模块加载失败:', window.analysisModuleError);
                                setError('模块加载失败: ' + (window.analysisModuleError.message || '未知错误') + '，请刷新页面重试');
                                return;
                            }
                            
                            // 如果模块还在加载中，继续等待
                            if (window.analysisModuleLoading !== false) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                retries++;
                            } else {
                                // 加载完成但模块不存在，说明加载失败
                                break;
                            }
                        }
                        
                        if (window.analysisModule) {
                            console.log('✅ 模块已加载，初始化解析器...');
                            await window.analysisModule.initializeParser();
                            setIsInitialized(true);
                            setLogs(prev => [...prev, '> 解析器初始化完成']);
                        } else {
                            console.error('❌ 模块加载超时或失败');
                            const errorMsg = window.analysisModuleError 
                                ? '模块加载失败: ' + window.analysisModuleError.message
                                : '模块加载超时，请刷新页面重试';
                            setError(errorMsg);
                        }
                    } catch (err) {
                        console.error('初始化失败:', err);
                        setError('初始化失败: ' + err.message);
                    }
                };
                
                // 监听模块加载失败事件
                const handleLoadFailed = (event) => {
                    console.error('收到模块加载失败事件:', event.detail);
                    setError('模块加载失败: ' + (event.detail.error?.message || '未知错误') + '，请刷新页面重试');
                };
                window.addEventListener('analysisModuleLoadFailed', handleLoadFailed);
                
                init();
                
                // 清理事件监听器
                return () => {
                    window.removeEventListener('analysisModuleLoadFailed', handleLoadFailed);
                };
            }, []);

            // 处理文件选择
            const handleFileSelect = (type) => {
                console.log('handleFileSelect 被调用', type);
                console.log('folderInputRef.current:', folderInputRef.current);
                console.log('fileInputRef.current:', fileInputRef.current);
                
                if (type === 'folder') {
                    if (folderInputRef.current) {
                        console.log('触发文件夹选择');
                        folderInputRef.current.click();
                    } else {
                        console.error('folderInputRef.current 为 null');
                    }
                } else {
                    if (fileInputRef.current) {
                        console.log('触发文件选择');
                        fileInputRef.current.click();
                    } else {
                        console.error('fileInputRef.current 为 null');
                    }
                }
            };

            // 处理文件上传
            const handleFileUpload = async (event, type) => {
                console.log('handleFileUpload 被调用', { type, files: event.target.files });
                
                const files = Array.from(event.target.files || []);
                console.log('文件列表:', files.map(f => ({ name: f.name, size: f.size })));
                
                if (files.length === 0) {
                    console.warn('没有选择文件');
                    return;
                }

                setError(null);
                setStep('analyzing');
                setLogs(['> 开始解析数据库文件...']);

                try {
                    // 检查模块是否加载，如果未加载则等待一段时间
                    if (!window.analysisModule) {
                        console.warn('模块未加载，等待加载...');
                        setLogs(prev => [...prev, '> 等待分析模块加载...']);
                        
                        // 等待模块加载（最多等待 3 秒）
                        let retries = 0;
                        const maxRetries = 30; // 30 * 100ms = 3秒
                        
                        while (!window.analysisModule && retries < maxRetries) {
                            // 如果模块加载失败，立即退出
                            if (window.analysisModuleError) {
                                throw new Error('分析模块加载失败: ' + (window.analysisModuleError.message || '未知错误') + '，请刷新页面重试');
                            }
                            
                            // 如果模块还在加载中，继续等待
                            if (window.analysisModuleLoading !== false) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                retries++;
                            } else {
                                // 加载完成但模块不存在，说明加载失败
                                break;
                            }
                        }
                        
                        if (!window.analysisModule) {
                            const errorMsg = window.analysisModuleError 
                                ? '分析模块加载失败: ' + window.analysisModuleError.message
                                : '分析模块加载超时';
                            throw new Error(errorMsg + '，请刷新页面重试');
                        }
                        
                        console.log('✅ 模块已加载，继续处理文件');
                        setLogs(prev => [...prev, '> 分析模块已就绪']);
                    }

                    if (!isInitialized) {
                        setLogs(prev => [...prev, '> 初始化解析器...']);
                        await window.analysisModule.initializeParser();
                        setIsInitialized(true);
                    }

                    // 调用 main.js 的处理函数
                    console.log('调用 processFiles...');
                    await window.analysisModule.processFiles(files, type, {
                        onLog: (log) => {
                            console.log('onLog:', log);
                            setLogs(prev => [...prev, log]);
                        },
                        onProgress: (current, total, fileName) => {
                            console.log('onProgress:', { current, total, fileName });
                            setLogs(prev => [...prev, `> 处理进度: ${current}/${total} - ${fileName}`]);
                        },
                        onComplete: (data) => {
                            console.log('onComplete:', data);
                            setAnalysisData(data);
                            setLogs(prev => [...prev, '> 分析完成！']);
                            setTimeout(() => {
                                setStep('preview');
                            }, 500);
                        },
                        onError: (err) => {
                            console.error('onError:', err);
                            setError(err.message || '处理失败');
                            setStep('upload');
                        }
                    });
                } catch (err) {
                    console.error('处理失败:', err);
                    setError(err.message || '处理失败');
                    setStep('upload');
                }
            };


            // 计算排名（基于"请"的次数，简化版）
            // TODO: 用户稍后会修改此函数的参数
            const calculateRank = (qingCount) => {
                // 简化计算：假设平均用户说"请"50次，超过越多排名越高
                const base = 50;
                const ratio = qingCount / base;
                return Math.min(99, Math.max(1, Math.round(ratio * 50)));
            };

            // 计算对话天数（从最早文件时间计算）
            const calculateUsageDays = (stats) => {
                if (!stats || !stats.earliestFileTime) {
                    return 0;
                }
                const now = Date.now();
                const earliest = stats.earliestFileTime;
                const diffMs = now - earliest;
                return Math.floor(diffMs / (1000 * 60 * 60 * 24));
            };

            // 进入完整报告
            const showFullReport = async () => {
                console.log('showFullReport 被调用，发起 POST 请求增加计数值并上传统计数据...');
                
                // 保存当前值，用于动画效果
                const oldTotalUsers = totalUsers;
                const oldTechRank = techRank;
                const oldUnlockedCount = unlockedCount;
                
                // 获取当前用户的统计数据
                const stats = window.analysisModule?.getGlobalStats();
                const usageDays = calculateUsageDays(stats);
                
                // 准备上传统计数据
                const userStats = {
                    qingCount: stats?.qingCount || 0,           // 赛博磕头次数
                    buCount: stats?.buCount || 0,                // 甲方爸爸上身
                    userMessages: stats?.userMessages || 0,      // 调戏AI次数
                    totalUserChars: stats?.userBehaviorStats?.totalUserChars || 0,  // 废话文学输出
                    avgUserMessageLength: stats?.userBehaviorStats?.avgUserMessageLength || 0,  // 平均吹水长度
                    totalConversations: stats?.totalConversations || 0,  // Cursor上岗天数（对话数）
                    usageDays: usageDays,                        // 使用天数
                    timestamp: Date.now()
                };
                
                console.log('[React] 准备上传统计数据:', userStats);
                
                // 在用户点击生成报告时，发起 POST 请求增加计数值并上传统计数据
                try {
                    const apiUrl = 'https://cursor-clinical-analysis.psterman.workers.dev/';
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors',
                        body: JSON.stringify({
                            action: 'submit_stats',
                            stats: userStats,
                            timestamp: Date.now(),
                        }),
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const newCount = data.value || data.totalUsers || data.total || data.count || 0;
                        
                        // 更新所有相关状态
                        setTotalUsers(newCount >= 0 ? newCount : 0);
                        setTotalTestUsers(newCount >= 0 ? newCount : 0);
                        
                        // 根据新的总人数动态计算技术排名和人格库解锁
                        const calculatedRank = Math.floor(newCount * 0.6);
                        setTechRank(calculatedRank);
                        
                        const calculatedUnlocked = Math.min(100, parseFloat((newCount / 1000).toFixed(1)));
                        setUnlockedCount(calculatedUnlocked);
                        
                        // 保存到本地存储作为 fallback
                        localStorage.setItem('totalTestUsers', newCount.toString());
                        
                        // 保存排名数据到状态（如果 API 返回了排名）
                        if (data.rankings) {
                            window.userRankings = data.rankings;
                            console.log('[React] ✅ 排名数据已保存:', data.rankings);
                        } else {
                            console.warn('[React] ⚠️ API 未返回排名数据！');
                            console.warn('[React] 可能原因：');
                            console.warn('1. Cloudflare Worker 代码未更新（请参考 CLOUDFLARE_WORKER_RANKING.md）');
                            console.warn('2. Worker 代码不支持 submit_stats 动作');
                            console.warn('3. Worker 代码有错误，请检查 Cloudflare Dashboard 日志');
                            console.warn('当前 API 响应:', data);
                        }
                        
                        console.log('[React] POST 请求成功，计数值和排名已更新:', {
                            totalUsers: newCount,
                            techRank: calculatedRank,
                            unlockedCount: calculatedUnlocked,
                            rankings: data.rankings,
                            hasRankings: !!data.rankings
                        });
                        
                        // 保存动画数据到 ref，等待 Dashboard 渲染完成后触发
                        animationDataRef.current = {
                            totalUsers: { old: oldTotalUsers, new: newCount },
                            techRank: { old: oldTechRank, new: calculatedRank },
                            unlockedCount: { old: oldUnlockedCount, new: calculatedUnlocked }
                        };
                    } else {
                        console.warn('[React] POST 请求失败，状态码:', response.status);
                        // POST 失败时，尝试从 localStorage 获取最新值
                        const cached = parseInt(localStorage.getItem('totalTestUsers') || '0');
                        setTotalUsers(cached >= 0 ? cached : 0);
                        setTotalTestUsers(cached >= 0 ? cached : 0);
                        setTechRank(Math.floor(cached * 0.6));
                        setUnlockedCount(Math.min(100, parseFloat((cached / 1000).toFixed(1))));
                    }
                } catch (error) {
                    console.warn('[React] POST 请求异常，使用 localStorage fallback:', error.message);
                    // 请求异常时，使用 localStorage 作为 fallback
                    const cached = parseInt(localStorage.getItem('totalTestUsers') || '0');
                    setTotalUsers(cached >= 0 ? cached : 0);
                    setTotalTestUsers(cached >= 0 ? cached : 0);
                    setTechRank(Math.floor(cached * 0.6));
                    setUnlockedCount(Math.min(100, parseFloat((cached / 1000).toFixed(1))));
                }
                
                setStep('fullReport');
                // 延迟渲染，确保 DOM 已更新
                setTimeout(() => {
                    const container = document.getElementById('fullReportContainer');
                    if (container && window.analysisModule) {
                        console.log('创建 Dashboard DOM...');
                        // 创建 Dashboard DOM 结构（从 index.html 复制）
                        container.innerHTML = `
                            <div class="full-report-container" style="max-width: 1100px; margin: 0 auto; padding: 20px; padding-bottom: 80px;">
                                <header style="text-align: center; padding: 60px 20px;">
                                    <div class="logo-box" style="display: inline-block; padding: 8px 16px; background: transparent; border: 1px solid var(--card-border); border-radius: 2px; margin-bottom: 20px; font-size: 14px; color: var(--accent-terminal); text-transform: uppercase; letter-spacing: 0.15em;">> Clinical Analysis v2.0</div>
                                    <h1 style="font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 700; letter-spacing: 0.1em; color: var(--text-main); margin-bottom: 15px; text-transform: uppercase; font-family: 'JetBrains Mono', monospace;">> CURSOR 迷惑行为报告</h1>
                                    <p class="subtitle" style="color: var(--text-dim); font-size: 1.1rem;">基于Cursor聊天记录的深度受虐分析</p>
                                </header>
                                
                                <div id="dashboardSection">
                                    <!-- 实时统计区域 -->
                                    <div class="realtime-stats-section" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 2px; padding: 24px; margin-bottom: 40px;">
                                        <h3 class="chart-title" style="margin-bottom: 20px; text-align: center;">📊 实时统计</h3>
                                        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label">全网受虐人数</p>
                                                <p class="stat-value" id="totalTestUsers" style="color: #ffffff;">加载中...</p>
                                                <p class="stat-comparison">人</p>
                                            </div>
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label">技术排名</p>
                                                <p class="stat-value" id="techRank" style="color: #ffffff;">加载中...</p>
                                                <p class="stat-comparison">名</p>
                                            </div>
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label">人格库解锁</p>
                                                <p class="stat-value" id="personalityUnlock" style="color: #ffffff;">加载中...</p>
                                                <p class="stat-comparison">243 种人格</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 横向排名区域 -->
                                    <div class="ranking-section" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 2px; padding: 24px; margin-bottom: 40px;">
                                        <h3 class="chart-title" style="margin-bottom: 20px; text-align: center;">🏆 全网横向排名</h3>
                                        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;" id="rankingCards">
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label" style="color: var(--text-dim);">赛博磕头排名</p>
                                                <p class="stat-value" id="rankingQingCount" style="color: #ffffff;">--</p>
                                                <p class="stat-comparison" id="rankingQingCountPercent">--</p>
                                            </div>
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label" style="color: var(--text-dim);">甲方上身排名</p>
                                                <p class="stat-value" id="rankingBuCount" style="color: #ffffff;">--</p>
                                                <p class="stat-comparison" id="rankingBuCountPercent">--</p>
                                            </div>
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label" style="color: var(--text-dim);">调戏AI排名</p>
                                                <p class="stat-value" id="rankingUserMessages" style="color: #ffffff;">--</p>
                                                <p class="stat-comparison" id="rankingUserMessagesPercent">--</p>
                                            </div>
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label" style="color: var(--text-dim);">废话输出排名</p>
                                                <p class="stat-value" id="rankingTotalChars" style="color: #ffffff;">--</p>
                                                <p class="stat-comparison" id="rankingTotalCharsPercent">--</p>
                                            </div>
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label" style="color: var(--text-dim);">平均长度排名</p>
                                                <p class="stat-value" id="rankingAvgLength" style="color: #ffffff;">--</p>
                                                <p class="stat-comparison" id="rankingAvgLengthPercent">--</p>
                                            </div>
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label" style="color: var(--text-dim);">上岗天数排名</p>
                                                <p class="stat-value" id="rankingUsageDays" style="color: #ffffff;">--</p>
                                                <p class="stat-comparison" id="rankingUsageDaysPercent">--</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 维度得分排行榜 -->
                                    <div class="dimension-ranking-section" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 2px; padding: 24px; margin-bottom: 40px;">
                                        <h3 class="chart-title" style="margin-bottom: 20px; text-align: center;">🏆 六大硬核维度得分排行榜</h3>
                                        <div id="dimensionRankingList" class="prompts-list"></div>
                                    </div>

                                    <div class="stats-grid" id="exportArea">
                                        <div class="stat-card">
                                            <p class="stat-label">Cursor上岗天数</p>
                                            <p class="stat-value" id="totalConversations">0</p>
                                            <p class="stat-comparison">天</p>
                                            <span class="stat-ranking" id="rankingUsageDaysBadge">--</span>
                                        </div>
                                        <div class="stat-card">
                                            <p class="stat-label">调戏 AI 次数</p>
                                            <p class="stat-value" id="userMessages">0</p>
                                            <span class="stat-ranking" id="rankingUserMessagesBadge">--</span>
                                        </div>
                                    </div>
                                    
                                    <div class="stats-grid">
                                        <div class="stat-card">
                                            <p class="stat-label">赛博磕头次数</p>
                                            <p class="stat-value" id="qingCount">0</p>
                                            <p class="stat-comparison">次</p>
                                            <span class="stat-ranking" id="rankingQingCountBadge">--</span>
                                        </div>
                                        <div class="stat-card">
                                            <p class="stat-label">甲方爸爸上身</p>
                                            <p class="stat-value" id="buCount">0</p>
                                            <p class="stat-comparison">次</p>
                                            <span class="stat-ranking" id="rankingBuCountBadge">--</span>
                                        </div>
                                    </div>
                                    
                                    <div class="stats-grid">
                                        <div class="stat-card">
                                            <p class="stat-label">废话文学输出</p>
                                            <p class="stat-value" id="totalUserChars">0</p>
                                            <p class="stat-comparison">字符</p>
                                            <span class="stat-ranking" id="rankingTotalCharsBadge">--</span>
                                        </div>
                                        <div class="stat-card">
                                            <p class="stat-label">平均吹水长度</p>
                                            <p class="stat-value" id="avgUserMessageLength">0</p>
                                            <p class="stat-comparison">字符</p>
                                            <span class="stat-ranking" id="rankingAvgLengthBadge">--</span>
                                        </div>
                                        <div class="stat-card hidden" id="questionCard">
                                            <p class="stat-label">黑人问号次数</p>
                                            <p class="stat-value" id="questionMessageCount">0</p>
                                            <p class="stat-comparison">条</p>
                                        </div>
                                    </div>
                                    
                                    <div class="wordcloud-section">
                                        <div class="chart-card">
                                            <h3 class="chart-title">☁️ AI功德簿</h3>
                                            <div class="wordcloud-container">
                                                <canvas id="chineseWordCloud"></canvas>
                                            </div>
                                        </div>
                                        <div class="chart-card">
                                            <h3 class="chart-title">🔤 你的硅谷黑话口头禅</h3>
                                            <div class="wordcloud-container">
                                                <canvas id="englishWordCloud"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="chart-card" style="margin-top: 40px;">
                                        <h3 class="chart-title"><span style="color: var(--accent-terminal);">🗣️</span> vibe coding黑话榜</h3>
                                        <div class="prompts-list" id="topChineseWordsList"></div>
                                    </div>
                                    
                                    <div class="chart-card" id="techStackSection" style="display: none; margin-top: 40px;">
                                        <h3 class="chart-title">🛠️ 用户技术栈 Top 10</h3>
                                        <div class="prompts-list" id="techStackList"></div>
                                    </div>
                                    
                                    <div class="vibe-codinger-section chart-card" id="vibeCodingerSection" style="margin-top: 40px;"></div>
                                    
                                    <div class="chat-list-section" style="margin-top: 40px;">
                                        <div class="chat-list-header">
                                            <h3 class="chat-list-title">对话记录</h3>
                                            <div class="chat-list-controls">
                                                <input type="text" id="searchInput" class="search-input" placeholder="搜索对话...">
                                            </div>
                                        </div>
                                        <div class="chat-list" id="chatList"></div>
                                        <div class="pagination-container" id="paginationContainer" style="display: none;">
                                            <div class="pagination-info">
                                                <span id="paginationInfo">第 1 页，共 1 页</span>
                                            </div>
                                            <div class="pagination-controls">
                                                <button id="paginationPrev" class="pagination-btn" disabled>上一页</button>
                                                <div class="pagination-pages" id="paginationPages"></div>
                                                <button id="paginationNext" class="pagination-btn">下一页</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="text-align: center; margin-top: 50px;">
                                        <button class="btn" id="exportBtn" style="background: rgba(255,255,255,0.1); border: 1px solid var(--card-border);">
                                            <span>生成受虐证据海报</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        // 显示容器
                        container.style.display = 'block';
                        
                        // 等待 DOM 完全渲染后再调用渲染函数
                        setTimeout(() => {
                            console.log('开始渲染 Dashboard...');
                            // 显示 Dashboard
                            const dashboardSection = container.querySelector('#dashboardSection');
                            if (dashboardSection) {
                                dashboardSection.classList.remove('hidden');
                                dashboardSection.style.display = 'block';
                            }
                            
                            // 确保数据已准备好
                            const stats = window.analysisModule.getGlobalStats();
                            const vibeResult = window.analysisModule.getVibeResult();
                            console.log('数据状态:', {
                                hasStats: !!stats,
                                hasVibeResult: !!vibeResult
                            });
                            
                            // 渲染完整 Dashboard
                            try {
                                window.analysisModule.renderFullDashboard();
                                console.log('Dashboard 渲染完成');
                                
                                // 延迟更新排名显示（确保 DOM 元素已创建）
                                setTimeout(async () => {
                                    if (window.userRankings) {
                                        await updateRankingBadges(window.userRankings);
                                        console.log('[React] ✅ 排名徽章已更新:', window.userRankings);
                                    } else {
                                        console.warn('[React] ⚠️ 未找到排名数据！');
                                        console.warn('[React] 请检查：');
                                        console.warn('1. 是否已更新 Cloudflare Worker 代码（参考 CLOUDFLARE_WORKER_RANKING.md）');
                                        console.warn('2. 浏览器控制台是否有 API 错误');
                                        console.warn('3. 运行 RANKING_DEBUG.md 中的调试代码');
                                    }
                                }, 100);
                                
                                // 立即使用当前状态值更新显示（使用 formatNumber）
                                const formatNumberLocal = (num) => {
                                    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                                    if (num >= 10000) return (num / 10000).toFixed(1) + '万';
                                    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                                    return num.toString();
                                };
                                
                                const totalUsersEl = document.getElementById('totalTestUsers');
                                const techRankEl = document.getElementById('techRank');
                                const personalityUnlockEl = document.getElementById('personalityUnlock');
                                
                                if (totalUsersEl && totalUsers >= 0) {
                                    totalUsersEl.textContent = formatNumberLocal(totalUsers);
                                }
                                if (techRankEl && techRank >= 0) {
                                    techRankEl.textContent = formatNumberLocal(techRank);
                                }
                                if (personalityUnlockEl && unlockedCount >= 0) {
                                    personalityUnlockEl.textContent = unlockedCount.toFixed(1) + '%';
                                }
                                
                                // 检查是否有待执行的动画数据（来自 POST 请求）
                                if (animationDataRef.current) {
                                    const animData = animationDataRef.current;
                                    console.log('[动画] 开始执行数字跳动动画:', animData);
                                    
                                    // 更新全网受虐人数，带跳动效果
                                    if (animData.totalUsers.old !== animData.totalUsers.new) {
                                        animateNumberUpdate('totalTestUsers', animData.totalUsers.old, animData.totalUsers.new, formatNumberLocal);
                                    }
                                    
                                    // 更新技术排名，带跳动效果
                                    if (animData.techRank.old !== animData.techRank.new) {
                                        animateNumberUpdate('techRank', animData.techRank.old, animData.techRank.new, formatNumberLocal);
                                    }
                                    
                                    // 更新人格库解锁，带跳动效果
                                    if (animData.unlockedCount.old !== animData.unlockedCount.new) {
                                        const animatePercentage = (elementId, oldVal, newVal) => {
                                            const element = document.getElementById(elementId);
                                            if (!element) return;
                                            
                                            element.classList.add('animate-pulse');
                                            const diff = newVal - oldVal;
                                            const duration = 800;
                                            const steps = 30;
                                            const stepValue = diff / steps;
                                            let currentStep = 0;
                                            
                                            const animate = () => {
                                                if (currentStep < steps) {
                                                    const currentValue = oldVal + stepValue * currentStep;
                                                    element.textContent = currentValue.toFixed(1) + '%';
                                                    currentStep++;
                                                    requestAnimationFrame(() => {
                                                        setTimeout(animate, duration / steps);
                                                    });
                                                } else {
                                                    element.textContent = newVal.toFixed(1) + '%';
                                                    setTimeout(() => {
                                                        element.classList.remove('animate-pulse');
                                                    }, 100);
                                                }
                                            };
                                            
                                            animate();
                                        };
                                        
                                        animatePercentage('personalityUnlock', animData.unlockedCount.old, animData.unlockedCount.new);
                                    }
                                    
                                    // 清空动画数据
                                    animationDataRef.current = null;
                                }
                            } catch (error) {
                                console.error('渲染 Dashboard 失败:', error);
                            }
                            
                            // 加载排名JSON数据
                            const rankingDataCache = {};
                            const loadRankingData = async (jsonFile) => {
                                if (rankingDataCache[jsonFile]) {
                                    return rankingDataCache[jsonFile];
                                }
                                try {
                                    const response = await fetch(`src/${jsonFile}`);
                                    const data = await response.json();
                                    rankingDataCache[jsonFile] = data;
                                    return data;
                                } catch (error) {
                                    console.error(`加载 ${jsonFile} 失败:`, error);
                                    return null;
                                }
                            };
                            
                            // 根据排名匹配对应的level和comment
                            const getRankingComment = (data, rank, total) => {
                                if (!data || !data.levels || rank === null || rank === undefined || total <= 0) {
                                    return null;
                                }
                                
                                const percent = ((total - rank + 1) / total * 100);
                                const rankPercent = (rank / total) * 100;
                                
                                // 遍历levels，找到匹配的level
                                for (const level of data.levels) {
                                    const range = level.range;
                                    
                                    // 处理不同的range格式
                                    let matched = false;
                                    
                                    // 处理 "TOP 81-100" 格式（please.json）
                                    if (range.startsWith('TOP ')) {
                                        const rangeStr = range.replace('TOP ', '');
                                        const [minPercent, maxPercent] = rangeStr.split('-').map(s => parseFloat(s.trim()));
                                        if (percent >= minPercent && percent <= maxPercent) {
                                            matched = true;
                                        }
                                    }
                                    // 处理 "1-10", "11-30" 等格式（no.json, ai.json）
                                    else if (/^\d+-\d+$/.test(range)) {
                                        const [minRank, maxRank] = range.split('-').map(s => parseInt(s.trim()));
                                        if (rank >= minRank && rank <= maxRank) {
                                            matched = true;
                                        }
                                    }
                                    // 处理 "91-100+" 格式（no.json）
                                    else if (/^\d+-\d+\+$/.test(range)) {
                                        const [minRank] = range.replace('+', '').split('-').map(s => parseInt(s.trim()));
                                        if (rank >= minRank) {
                                            matched = true;
                                        }
                                    }
                                    // 处理 "201+" 格式（ai.json）
                                    else if (/^\d+\+$/.test(range)) {
                                        const minRank = parseInt(range.replace('+', ''));
                                        if (rank >= minRank) {
                                            matched = true;
                                        }
                                    }
                                    // 处理 "1-7天", "8-30天" 等格式（day.json）
                                    else if (range.includes('天')) {
                                        // 根据排名百分比匹配：排名越靠前（rank越小），天数越多
                                        // levels数组从低到高排列，所以需要反向匹配
                                        const levelIndex = data.levels.indexOf(level);
                                        const totalLevels = data.levels.length;
                                        const segmentSize = 100 / totalLevels;
                                        
                                        if (range === '181+') {
                                            // 最高level，排名前20%
                                            if (rankPercent <= 20) matched = true;
                                        } else if (range === '91-180天') {
                                            if (rankPercent > 20 && rankPercent <= 40) matched = true;
                                        } else if (range === '31-90天') {
                                            if (rankPercent > 40 && rankPercent <= 60) matched = true;
                                        } else if (range === '8-30天') {
                                            if (rankPercent > 60 && rankPercent <= 80) matched = true;
                                        } else if (range === '1-7天') {
                                            if (rankPercent > 80) matched = true;
                                        }
                                    }
                                    // 处理 "1-500字", "501-2000字" 等格式（say.json）
                                    else if (range.includes('字') && (range.includes('10001') || range.includes('5001') || range.includes('2001') || range.includes('501') || range.includes('1-500'))) {
                                        // say.json的格式
                                        const rankPercent = (rank / total) * 100;
                                        if (range === '10001+字') {
                                            if (rankPercent <= 20) matched = true;
                                        } else if (range === '5001-10000字') {
                                            if (rankPercent > 20 && rankPercent <= 40) matched = true;
                                        } else if (range === '2001-5000字') {
                                            if (rankPercent > 40 && rankPercent <= 60) matched = true;
                                        } else if (range === '501-2000字') {
                                            if (rankPercent > 60 && rankPercent <= 80) matched = true;
                                        } else if (range === '1-500字') {
                                            if (rankPercent > 80) matched = true;
                                        }
                                    }
                                    // 处理 "1-50字", "51-200字" 等格式（word.json）
                                    else if (range.includes('字') && (range.includes('1001') || range.includes('501') || range.includes('201') || range.includes('51') || range.includes('1-50'))) {
                                        // word.json的格式
                                        const rankPercent = (rank / total) * 100;
                                        if (range === '1001+') {
                                            if (rankPercent <= 20) matched = true;
                                        } else if (range === '501-1000字') {
                                            if (rankPercent > 20 && rankPercent <= 40) matched = true;
                                        } else if (range === '201-500字') {
                                            if (rankPercent > 40 && rankPercent <= 60) matched = true;
                                        } else if (range === '51-200字') {
                                            if (rankPercent > 60 && rankPercent <= 80) matched = true;
                                        } else if (range === '1-50字') {
                                            if (rankPercent > 80) matched = true;
                                        }
                                    }
                                    
                                    if (matched && level.comments && level.comments.length > 0) {
                                        // 随机选择一个comment
                                        const randomComment = level.comments[Math.floor(Math.random() * level.comments.length)];
                                        return {
                                            title: randomComment.title,
                                            content: randomComment.content,
                                            label: level.label
                                        };
                                    }
                                }
                                
                                return null;
                            };
                            
                            // 统一更新排名徽章的函数
                            const updateRankingBadges = async (rankings) => {
                                if (!rankings) return;
                                
                                // 更新排名徽章（统计卡片右下角）
                                const updateBadge = (badgeId, rank, total) => {
                                    const badge = document.getElementById(badgeId);
                                    if (!badge) return;
                                    
                                    if (rank !== null && rank !== undefined && total > 0) {
                                        const percent = ((total - rank + 1) / total * 100).toFixed(1);
                                        badge.textContent = `#${rank} (前${percent}%)`;
                                        badge.classList.add('has-rank');
                                    } else {
                                        badge.textContent = '--';
                                        badge.classList.remove('has-rank');
                                    }
                                };
                                
                                // 排名卡片说明文字映射
                                const rankingLabels = {
                                    'rankingQingCount': '赛博磕头排名',
                                    'rankingBuCount': '甲方上身排名',
                                    'rankingUserMessages': '调戏AI排名',
                                    'rankingTotalChars': '废话输出排名',
                                    'rankingAvgLength': '平均长度排名',
                                    'rankingUsageDays': '上岗天数排名'
                                };
                                
                                // 更新"全网横向排名"区域的卡片（大卡片）
                                const updateRankingCard = async (valueId, percentId, rank, total, jsonFile) => {
                                    const valueEl = document.getElementById(valueId);
                                    const percentEl = document.getElementById(percentId);
                                    
                                    // 确保标题不换行
                                    if (valueEl) {
                                        valueEl.style.whiteSpace = 'nowrap';
                                        valueEl.style.overflow = 'hidden';
                                        valueEl.style.textOverflow = 'ellipsis';
                                    }
                                    if (percentEl) {
                                        percentEl.style.whiteSpace = 'nowrap';
                                        percentEl.style.overflow = 'hidden';
                                        percentEl.style.textOverflow = 'ellipsis';
                                    }
                                    
                                    if (rank !== null && rank !== undefined && total > 0) {
                                        // 判断是否在100名内
                                        if (rank <= 100) {
                                            // 100名内：显示排名数字和JSON中的标题和评语
                                            const data = await loadRankingData(jsonFile);
                                            const comment = getRankingComment(data, rank, total);
                                            
                                            if (comment && valueEl && percentEl) {
                                                // valueEl显示排名数字（大字体，参考技术排名样式）
                                                valueEl.textContent = rank;
                                                valueEl.style.fontSize = '36px';
                                                valueEl.style.fontWeight = '700';
                                                valueEl.style.fontFamily = "'JetBrains Mono', monospace";
                                                
                                                // percentEl显示JSON中的title和content
                                                // strong标签会自动应用绿色加粗样式（通过CSS）
                                                percentEl.innerHTML = `<strong>${comment.title}</strong><br/>${comment.content}`;
                                                percentEl.style.whiteSpace = 'normal'; // 允许换行显示content
                                                percentEl.style.color = '#ffffff'; // 确保内容文字是白色
                                            } else {
                                                // 如果无法从JSON获取，使用默认显示
                                                const percent = ((total - rank + 1) / total * 100).toFixed(1);
                                                if (valueEl) {
                                                    valueEl.textContent = rank;
                                                    valueEl.style.fontSize = '36px';
                                                    valueEl.style.fontWeight = '700';
                                                    valueEl.style.fontFamily = "'JetBrains Mono', monospace";
                                                }
                                                if (percentEl) {
                                                    percentEl.textContent = `前 ${percent}%`;
                                                    percentEl.style.whiteSpace = 'nowrap';
                                                }
                                            }
                                        } else {
                                            // 101名以后：只显示数字排名
                                            if (valueEl) {
                                                valueEl.textContent = rank;
                                                valueEl.style.fontSize = '36px';
                                                valueEl.style.fontWeight = '700';
                                                valueEl.style.fontFamily = "'JetBrains Mono', monospace";
                                            }
                                            if (percentEl) {
                                                percentEl.textContent = '名';
                                                percentEl.style.whiteSpace = 'nowrap';
                                            }
                                        }
                                    } else {
                                        if (valueEl) valueEl.textContent = '--';
                                        if (percentEl) percentEl.textContent = '--';
                                    }
                                };
                                
                                // 更新各个统计卡片的排名徽章（右下角小徽章）
                                updateBadge('rankingQingCountBadge', rankings.qingCount?.rank, rankings.qingCount?.total);
                                updateBadge('rankingBuCountBadge', rankings.buCount?.rank, rankings.buCount?.total);
                                updateBadge('rankingUserMessagesBadge', rankings.userMessages?.rank, rankings.userMessages?.total);
                                updateBadge('rankingTotalCharsBadge', rankings.totalUserChars?.rank, rankings.totalUserChars?.total);
                                updateBadge('rankingAvgLengthBadge', rankings.avgUserMessageLength?.rank, rankings.avgUserMessageLength?.total);
                                updateBadge('rankingUsageDaysBadge', rankings.usageDays?.rank, rankings.usageDays?.total);
                                
                                // 更新"全网横向排名"区域的卡片（大卡片显示）
                                // 对应关系：no.json -> 甲方爸爸上身, ai.json -> 调戏AI, please.json -> 赛博磕头
                                // say.json -> 平均长度, word.json -> 废话输出, day.json -> 上岗天数
                                await updateRankingCard('rankingQingCount', 'rankingQingCountPercent', rankings.qingCount?.rank, rankings.qingCount?.total, 'please.json');
                                await updateRankingCard('rankingBuCount', 'rankingBuCountPercent', rankings.buCount?.rank, rankings.buCount?.total, 'no.json');
                                await updateRankingCard('rankingUserMessages', 'rankingUserMessagesPercent', rankings.userMessages?.rank, rankings.userMessages?.total, 'ai.json');
                                await updateRankingCard('rankingTotalChars', 'rankingTotalCharsPercent', rankings.totalUserChars?.rank, rankings.totalUserChars?.total, 'word.json');
                                await updateRankingCard('rankingAvgLength', 'rankingAvgLengthPercent', rankings.avgUserMessageLength?.rank, rankings.avgUserMessageLength?.total, 'say.json');
                                await updateRankingCard('rankingUsageDays', 'rankingUsageDaysPercent', rankings.usageDays?.rank, rankings.usageDays?.total, 'day.json');
                            };
                            
                            // 实时更新统计数据（从 Cloudflare API 获取）
                            const updateRealtimeStats = async () => {
                                // 格式化数字函数（确保在作用域内可用）
                                const formatNumberLocal = (num) => {
                                    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                                    if (num >= 10000) return (num / 10000).toFixed(1) + '万';
                                    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                                    return num.toString();
                                };
                                
                                try {
                                    const apiUrl = 'https://cursor-clinical-analysis.psterman.workers.dev/';
                                    console.log('[实时更新] 开始获取 Cloudflare 实时数据...');
                                    
                                    const response = await fetch(apiUrl, {
                                        method: 'GET',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        mode: 'cors',
                                        cache: 'no-cache',
                                    });
                                    
                                    if (response.ok) {
                                        const data = await response.json();
                                        const value = data.value || data.totalUsers || data.total || data.count || 0;
                                        
                                        console.log('[实时更新] API 返回数据:', data, '解析后的值:', value);
                                        
                                        if (value >= 0) {
                                            // 更新 React 状态
                                            setTotalUsers(value);
                                            setTotalTestUsers(value);
                                            const calculatedRank = Math.floor(value * 0.6);
                                            setTechRank(calculatedRank);
                                            const calculatedUnlocked = Math.min(100, parseFloat((value / 1000).toFixed(1)));
                                            setUnlockedCount(calculatedUnlocked);
                                            
                                            // 如果 API 返回了排名数据，也更新排名徽章
                                            if (data.rankings) {
                                                window.userRankings = data.rankings;
                                                // 延迟更新，确保 DOM 元素存在
                                                setTimeout(async () => {
                                                    await updateRankingBadges(data.rankings);
                                                    console.log('[实时更新] 排名徽章已更新:', data.rankings);
                                                }, 100);
                                            }
                                            
                                            // 更新 DOM 元素
                                            const totalUsersEl = document.getElementById('totalTestUsers');
                                            const techRankEl = document.getElementById('techRank');
                                            const personalityUnlockEl = document.getElementById('personalityUnlock');
                                            
                                            if (totalUsersEl) {
                                                // 使用 formatNumber 处理显示格式
                                                const formatted = formatNumberLocal(value);
                                                totalUsersEl.textContent = formatted;
                                                // 添加更新动画
                                                totalUsersEl.classList.add('animate-pulse');
                                                setTimeout(() => {
                                                    totalUsersEl.classList.remove('animate-pulse');
                                                }, 600);
                                                console.log('[实时更新] 全网受虐人数已更新:', formatted);
                                            } else {
                                                console.warn('[实时更新] 未找到 totalTestUsers 元素');
                                            }
                                            
                                            if (techRankEl) {
                                                // 使用 formatNumber 处理显示格式
                                                const formatted = formatNumberLocal(calculatedRank);
                                                techRankEl.textContent = formatted;
                                                techRankEl.classList.add('animate-pulse');
                                                setTimeout(() => {
                                                    techRankEl.classList.remove('animate-pulse');
                                                }, 600);
                                                console.log('[实时更新] 技术排名已更新:', formatted);
                                            } else {
                                                console.warn('[实时更新] 未找到 techRank 元素');
                                            }
                                            
                                            if (personalityUnlockEl) {
                                                personalityUnlockEl.textContent = calculatedUnlocked.toFixed(1) + '%';
                                                personalityUnlockEl.classList.add('animate-pulse');
                                                setTimeout(() => {
                                                    personalityUnlockEl.classList.remove('animate-pulse');
                                                }, 600);
                                                console.log('[实时更新] 人格库解锁已更新:', calculatedUnlocked.toFixed(1) + '%');
                                            } else {
                                                console.warn('[实时更新] 未找到 personalityUnlock 元素');
                                            }
                                            
                                            console.log('[实时更新] 统计数据已全部更新:', {
                                                totalUsers: value,
                                                techRank: calculatedRank,
                                                unlockedCount: calculatedUnlocked
                                            });
                                        } else {
                                            console.warn('[实时更新] API 返回的值无效');
                                        }
                                    } else {
                                        console.warn('[实时更新] API 请求失败，状态码:', response.status);
                                    }
                                } catch (error) {
                                    console.error('[实时更新] 获取数据失败:', error.message, error);
                                }
                            };
                            
                            // 等待 DOM 完全渲染后再更新（延迟执行以确保元素存在）
                            setTimeout(() => {
                                console.log('[实时更新] 开始首次更新实时统计数据...');
                                updateRealtimeStats();
                                
                                // 清理之前的定时器（如果存在）
                                if (window.realtimeStatsInterval) {
                                    clearInterval(window.realtimeStatsInterval);
                                }
                                
                                // 每30秒自动刷新一次
                                window.realtimeStatsInterval = setInterval(() => {
                                    console.log('[实时更新] 定时刷新统计数据...');
                                    updateRealtimeStats();
                                }, 30000);
                            }, 500);
                        }, 200);
                    } else {
                        console.error('容器或模块未找到');
                    }
                }, 100);
            };

            // 导出报告
            const exportReport = async () => {
                try {
                    const exportArea = document.getElementById('exportArea');
                    if (!exportArea) {
                        alert('导出区域未找到');
                        return;
                    }
                    
                    const canvas = await html2canvas(exportArea, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        useCORS: true,
                        logging: false,
                    });

                    const link = document.createElement('a');
                    link.download = `cursor-audit-${new Date().getTime()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (err) {
                    console.error('导出失败:', err);
                    alert('导出失败: ' + err.message);
                }
            };

            return (
                <div className="min-h-screen text-zinc-100 p-4 md:p-8 flex flex-col items-center justify-center relative">
                    <div className="fixed top-0 left-0 w-full h-1 bg-green-500 shadow-[0_0_8px_rgba(0,255,65,0.8)] z-50" />

                    {/* 隐藏的文件输入 */}
                    <input 
                        type="file" 
                        ref={folderInputRef}
                        webkitdirectory=""
                        directory=""
                        multiple 
                        style={{ display: 'none' }}
                        onChange={(e) => {
                            console.log('文件夹选择事件触发', e.target.files);
                            handleFileUpload(e, 'folder');
                        }}
                    />
                    <input 
                        type="file" 
                        ref={fileInputRef}
                        accept=".vscdb,.db,.sqlite,.sqlite3" 
                        multiple 
                        style={{ display: 'none' }}
                        onChange={(e) => {
                            console.log('文件选择事件触发', e.target.files);
                            handleFileUpload(e, 'file');
                        }}
                    />

                    {/* 上传阶段 */}
                    {step === 'upload' && (
                        <div className="max-w-2xl w-full space-y-8 text-center">
                            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-zinc-900 border border-zinc-800 text-xs text-white mb-4 mx-auto">
                                <Icon name="zap" size={12} />
                                <span>Vibe Coding行为临床实验室 v1.0</span>
                            </div>
                            <h1 style={{
                                fontSize: 'clamp(2rem, 5vw, 3.5rem)',
                                fontWeight: 800,
                                letterSpacing: '-0.05em',
                                background: 'linear-gradient(to bottom, #fff 30%, #a1a1a1 100%)',
                                WebkitBackgroundClip: 'text',
                                backgroundClip: 'text',
                                WebkitTextFillColor: 'transparent',
                                marginBottom: '15px'
                            }}>
                                Cursor迷惑行为报告
                            </h1>
                            <p className="text-zinc-500 text-lg max-w-md mx-auto">
                                基于 Cursor 聊天记录的深度受虐分析
                            </p>
                            
                            {error && (
                                <div className="bg-red-900/20 border border-red-800 text-red-400 p-4 rounded-sm font-mono">
                                    {error}
                                </div>
                            )}
                            
                            <div className="group relative p-12 mt-12 border-2 border-dashed border-zinc-800 rounded-sm hover:border-green-500/50 transition-all cursor-pointer bg-zinc-900/50">
                                <div className="relative z-10 space-y-4 text-center">
                                    <img src="images/CUBE_2D_DARK.png" width="64" height="64" style={{ marginBottom: '20px', display: 'block', margin: '0 auto 20px auto' }} className="upload-icon" alt="Upload" />
                                    <h2 style={{ marginBottom: '10px', fontSize: '20px', fontWeight: 600, color: 'var(--text-main)' }}>数据本地解析 隐私绝对隔离</h2>                                    <p style={{ color: 'var(--text-dim)', marginBottom: '25px' }}>The salvation lies within</p>
                                    <div className="flex gap-4 justify-center mt-6">
                                        <button 
                                            onClick={() => handleFileSelect('folder')}
                                            className="px-6 py-3 bg-green-500 hover:bg-transparent hover:text-green-500 text-black rounded-sm font-semibold transition-colors border border-green-500 uppercase tracking-wider font-mono"
                                        >
                                        聊天文件夹
                                        </button>
                                        {/* <button 
                                            onClick={() => handleFileSelect('file')}
                                            className="px-6 py-3 bg-transparent hover:bg-zinc-700 text-white rounded-sm font-semibold transition-colors border border-zinc-700 uppercase tracking-wider font-mono"
                                        >
                                            选择state.vscdb
                                        </button> */}
                                    </div>
                                    {/* 救赎路径复制器 */}
                                    <div style={{ 
                                        marginTop: '24px', 
                                        padding: '12px 16px', 
                                        background: 'rgba(24, 24, 27, 0.8)', 
                                        border: '1px solid var(--card-border)', 
                                        borderRadius: '2px',
                                        fontFamily: "'JetBrains Mono', monospace"
                                    }}>
                                        <div style={{ 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            justifyContent: 'space-between', 
                                            gap: '12px',
                                            marginBottom: '8px'
                                        }}>
                                            <code style={{ 
                                                color: 'var(--accent-terminal)', 
                                                fontSize: '12px', 
                                                flex: 1, 
                                                textAlign: 'left',
                                                wordBreak: 'break-all',
                                                fontFamily: "'JetBrains Mono', monospace"
                                            }} id="workspacePath">
                                                {(navigator.platform.toLowerCase().includes('win') || navigator.userAgent.toLowerCase().includes('windows')) 
                                                    ? '%APPDATA%\\Cursor\\User\\workspaceStorage\\' 
                                                    : '~/Library/Application Support/Cursor/User/workspaceStorage/'}
                                            </code>
                                            <button 
                                                onClick={(e) => {
                                                    const pathEl = document.getElementById('workspacePath');
                                                    const path = pathEl ? pathEl.textContent : '';
                                                    navigator.clipboard.writeText(path).then(() => {
                                                        const btn = e.target;
                                                        const originalText = btn.textContent;
                                                        btn.textContent = '已复制';
                                                        btn.style.color = 'var(--accent-terminal)';
                                                        btn.style.background = 'var(--accent-terminal)';
                                                        btn.style.color = '#050505';
                                                        setTimeout(() => {
                                                            btn.textContent = originalText;
                                                            btn.style.background = 'transparent';
                                                            btn.style.color = 'var(--accent-terminal)';
                                                        }, 2000);
                                                    }).catch(err => {
                                                        console.error('复制失败:', err);
                                                        alert('复制失败，请手动复制');
                                                    });
                                                }}
                                                style={{
                                                    padding: '6px 12px',
                                                    background: 'transparent',
                                                    border: '1px solid var(--accent-terminal)',
                                                    borderRadius: '2px',
                                                    color: 'var(--accent-terminal)',
                                                    fontSize: '11px',
                                                    cursor: 'pointer',
                                                    fontFamily: "'JetBrains Mono', monospace",
                                                    textTransform: 'uppercase',
                                                    letterSpacing: '0.05em',
                                                    transition: 'all 0.2s ease',
                                                    whiteSpace: 'nowrap'
                                                }}
                                                onMouseEnter={(e) => {
                                                    e.target.style.background = 'var(--accent-terminal)';
                                                    e.target.style.color = '#050505';
                                                }}
                                                onMouseLeave={(e) => {
                                                    e.target.style.background = 'transparent';
                                                    e.target.style.color = 'var(--accent-terminal)';
                                                }}
                                            >
                                                复制
                                            </button>
                                        </div>
                                        <p style={{ 
                                            color: '#ffffff', 
                                            fontSize: '10px', 
                                            margin: 0,
                                            textAlign: 'left',
                                            fontFamily: "'JetBrains Mono', monospace",
                                            opacity: 0.8
                                        }}>
                                            {'> '}在弹出窗口的地址栏粘贴此路径可瞬间抵达
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 分析阶段 */}
                    {step === 'analyzing' && (
                        <div className="w-full max-w-lg bg-zinc-950 border border-zinc-800 rounded-sm p-6 shadow-2xl overflow-hidden">
                            <div className="flex items-center gap-2 mb-4 border-b border-zinc-900 pb-3">
                                <Icon name="terminal" size={16} className="text-green-500" />
                                <span className="text-xs text-zinc-500 uppercase tracking-widest">System Analysis</span>
                            </div>
                            <div className="space-y-2 h-64 overflow-y-auto custom-scrollbar">
                                {logs.map((log, i) => (
                                    <div key={i} className="text-sm text-zinc-400 font-mono">
                                        {log}
                                    </div>
                                ))}
                                <div className="w-2 h-5 bg-green-500 animate-pulse inline-block" />
                            </div>
                        </div>
                    )}

                    {/* 预览结果阶段 */}
                    {step === 'preview' && analysisData && (
                        <div className="max-w-4xl w-full space-y-6">
                            <div className="bg-zinc-900 border border-zinc-800 rounded-sm p-8 md:p-12 relative overflow-hidden shadow-2xl">
                                
                                <div className="flex flex-col md:flex-row justify-between items-start gap-8">
                                    <div className="space-y-6">
                                        <div>
                                            <h2 className="text-zinc-500 text-sm uppercase tracking-widest mb-1 font-mono">人格鉴定结果</h2>
                                            <div className="text-5xl font-black text-white font-mono">
                                                {analysisData.vibeResult?.personalityName || '未知人格'}
                                            </div>
                                        </div>
                                        <p className="text-zinc-400 text-lg max-w-sm">
                                            {analysisData.vibeResult?.roastText || '分析中...'}
                                        </p>
                                        {analysisData.vibeResult?.vibeIndex && (
                                            <div className="flex gap-2">
                                                <span className="px-3 py-1 bg-zinc-800 text-green-400 text-xs rounded-sm border border-green-500 font-mono uppercase tracking-wider">
                                                    Vibe Index: {analysisData.vibeResult.vibeIndex}
                                                </span>
                                            </div>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 w-full md:w-auto">
                                        <StatBox 
                                            label="全网受虐人数" 
                                            value={formatNumber(totalUsers)} 
                                            sub="人" 
                                            color="text-white" 
                                        />
                                        <StatBox 
                                            label="赛博磕头" 
                                            value={analysisData.stats?.qingCount || 0} 
                                            sub="次" 
                                            color="text-white" 
                                        />
                                        <StatBox 
                                            label="全网排名" 
                                            value={calculateRank(analysisData.stats?.qingCount || 0)} 
                                            sub="%" 
                                            color="text-white" 
                                        />
                                        <StatBox 
                                            label="甲方上身" 
                                            value={analysisData.stats?.buCount || 0} 
                                            sub="次" 
                                            color="text-white" 
                                        />
                                        <StatBox 
                                            label="对话天数" 
                                            value={calculateUsageDays(analysisData.stats)} 
                                            sub="天" 
                                            color="text-white" 
                                        />
                                    </div>
                                </div>

                                <div className="mt-12 p-6 bg-zinc-950/50 rounded-sm border border-zinc-800 flex items-start gap-4">
                                    <Icon name="alert-triangle" className="text-green-500 shrink-0 mt-1" size={20} />
                                    <p className="text-sm text-zinc-400 font-mono">
                                        专家诊断：你对 Cursor 说了 {analysisData.stats?.qingCount || 0} 次"请"，
                                        {analysisData.stats?.qingCount > 100 ? '你对你老板可能都没这么客气过。' : '还算正常。'}
                                        建议适当增加"直接命令"语气，找回丢失的码农尊严。
                                    </p>
                                </div>
                            </div>

                            <div className="flex flex-col sm:flex-row gap-4 justify-center pt-4">
                                <button 
                                    onClick={showFullReport}
                                    className="flex items-center justify-center gap-2 bg-green-500 text-black px-8 py-4 rounded-sm font-bold hover:bg-transparent hover:text-green-500 transition-colors border border-green-500 uppercase tracking-wider font-mono"
                                >
                                    <Icon name="share-2" size={20} />
                                    晒出我的受虐证据
                                </button>
                                <button 
                                    onClick={exportReport}
                                    className="flex items-center justify-center gap-2 bg-transparent text-white px-8 py-4 rounded-sm font-bold border border-zinc-800 hover:bg-zinc-800 transition-colors uppercase tracking-wider font-mono"
                                >
                                    <Icon name="download" size={20} />
                                    保存体检报告
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 完整报告阶段 */}
                    {step === 'fullReport' && (
                        <div className="w-full" style={{minHeight: '100vh'}}>
                            <div id="fullReportContainer" style={{display: 'block'}}></div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <!-- 友情链接 -->
    <style>
        .friend-links {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 24px;
            align-items: center;
            z-index: 100;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .friend-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(24, 24, 27, 0.8);
            border: 1px solid var(--card-border);
            border-radius: 2px;
            color: var(--text-main);
            text-decoration: none;
            transition: all 0.2s ease;
            font-size: 12px;
        }
        
        .friend-link:hover {
            border-color: var(--accent-terminal);
            color: var(--accent-terminal);
        }
        
        .friend-link img {
            display: block;
        }
    </style>
    <div class="friend-links">
        <a 
            href="https://github.com/psterman/nmer" 
            target="_blank" 
            rel="noopener noreferrer"
            class="friend-link"
        >
            <img 
                src="https://github.com/psterman/nmer/blob/main/favicon.ico?raw=true" 
                alt="牛马" 
                width="32" 
                height="32"
            />
            <span>牛马（cursor windows工具箱）</span>
        </a>
        <a 
            href="https://github.com/psterman/curser" 
            target="_blank" 
            rel="noopener noreferrer"
            class="friend-link"
        >
            <img 
                src="https://github.com/psterman/nmer/blob/main/curser.ico?raw=true" 
                alt="抠搜" 
                width="32" 
                height="32"
            />
            <span>抠搜（cursor聊天记录查看器）</span>
        </a>
    </div>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor 行为体检 - Vibe Coding</title>
    <!-- API 端点配置（Cloudflare Workers） -->
    <meta name="api-endpoint" content="https://cursor-clinical-analysis.psterman.workers.dev/">
    <!-- 引入必要的库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.1.0/wordcloud2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        
        /* 从 index.html 引入的完整样式 */
        :root {
            --bg-color: #050505;
            --card-bg: rgba(23, 23, 23, 0.7);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-main: #ededed;
            --text-dim: #a1a1a1;
            --accent-purple: #8b5cf6;
            --accent-blue: #3b82f6;
            --accent-gradient: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            --glass-blur: blur(12px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 40%);
        }

        .top-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent-gradient);
            z-index: 1000;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px;
        }

        header {
            text-align: center;
            padding: 60px 20px;
            animation: fadeInDown 0.8s ease-out;
        }

        .logo-box {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            margin-bottom: 20px;
            font-size: 16px;
            color: var(--accent-blue);
            backdrop-filter: var(--glass-blur);
        }

        h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 800;
            letter-spacing: -0.05em;
            background: linear-gradient(to bottom, #fff 30%, #a1a1a1 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .subtitle {
            color: var(--text-dim);
            font-size: 1.1rem;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .stats-grid.hidden {
            display: none;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 24px;
            transition: transform 0.3s ease;
        }

        .stat-label {
            font-size: 16px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: #fff;
        }

        .stat-comparison {
            font-size: 14px;
            margin-top: 10px;
            color: var(--accent-purple);
            font-weight: 500;
        }

        .wordcloud-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }
        
        .wordcloud-section.hidden {
            display: none;
        }

        .chart-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 24px;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .wordcloud-container {
            width: 100%;
            height: 400px;
            position: relative;
            background: transparent;
            border-radius: 12px;
            overflow: hidden;
        }

        .wordcloud-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .prompts-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .prompt-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .prompt-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .prompt-rank {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-purple);
            min-width: 30px;
        }

        .prompt-text {
            flex: 1;
            font-size: 16px;
            color: var(--text-main);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .prompt-count {
            font-size: 15px;
            color: var(--text-dim);
            white-space: nowrap;
        }

        .chat-list-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            overflow: hidden;
            backdrop-filter: var(--glass-blur);
        }

        .chat-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--card-border);
            flex-wrap: wrap;
            gap: 12px;
        }

        .chat-list-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-main);
        }

        .chat-list-controls {
            display: flex;
            gap: 12px;
        }

        .search-input {
            padding: 10px 16px;
            font-size: 16px;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            width: 300px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-purple);
            background: rgba(255, 255, 255, 0.08);
        }

        .search-input::placeholder {
            color: var(--text-dim);
        }

        .chat-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .chat-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--card-border);
            transition: background 0.2s ease;
        }

        .chat-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .chat-item:last-child {
            border-bottom: none;
        }

        .chat-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chat-role {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .role-user {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .role-ai {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .chat-time {
            font-size: 14px;
            color: var(--text-dim);
        }

        .chat-item-content {
            font-size: 16px;
            color: var(--text-dim);
            line-height: 1.6;
        }

        .chat-item-content p {
            margin: 0;
        }

        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-top: 1px solid var(--card-border);
            background: rgba(255, 255, 255, 0.02);
            flex-wrap: wrap;
            gap: 16px;
        }

        .pagination-info {
            font-size: 16px;
            color: var(--text-dim);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            padding: 8px 16px;
            font-size: 16px;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-purple);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-pages {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pagination-page-btn {
            min-width: 36px;
            height: 36px;
            padding: 0 12px;
            font-size: 16px;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-page-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-purple);
        }

        .pagination-page-btn.active {
            background: var(--accent-gradient);
            color: #fff;
            border-color: transparent;
        }

        .pagination-ellipsis {
            padding: 0 8px;
            color: var(--text-dim);
            font-size: 16px;
        }

        .vibe-codinger-section {
            margin-bottom: 32px;
        }

        .vibe-header {
            text-align: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid var(--card-border);
        }

        .vibe-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .vibe-badge {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 40px;
            border-radius: 16px;
            margin-bottom: 16px;
            transition: transform 0.2s ease;
            backdrop-filter: var(--glass-blur);
        }

        .vibe-badge:hover {
            transform: translateY(-2px);
        }

        .vibe-type {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--text-main);
        }

        .vibe-name {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-main);
        }

        .vibe-description {
            font-size: 16px;
            color: var(--text-dim);
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }

        .vibe-dimensions {
            margin-bottom: 32px;
        }

        .dimensions-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .dimension-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--card-border);
            margin-bottom: 16px;
            transition: all 0.2s ease;
        }

        .dimension-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
            background: rgba(255, 255, 255, 0.05);
        }

        .dimension-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .dimension-key {
            font-size: 26px;
            font-weight: 700;
            color: var(--accent-purple);
            min-width: 40px;
        }

        .dimension-label {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
            flex: 1;
        }

        .dimension-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-main);
            min-width: 50px;
            text-align: right;
        }

        .dimension-level {
            font-size: 16px;
            padding: 4px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-dim);
            font-weight: 600;
        }

        .dimension-bar-container {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .dimension-bar {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .dimension-interpretation {
            font-size: 17px;
            color: var(--text-main);
            margin-bottom: 8px;
            font-weight: 500;
            line-height: 1.6;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border-left: 3px solid var(--accent-purple);
            font-style: italic;
        }

        .dimension-desc {
            font-size: 14px;
            color: var(--text-dim);
            line-height: 1.5;
        }

        .vibe-roast-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 32px;
            backdrop-filter: var(--glass-blur);
        }

        .roast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .roast-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
        }

        .personality-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-purple);
            padding: 6px 16px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 20px;
            border: 1px solid var(--accent-purple);
        }

        .vibe-index {
            font-size: 16px;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid var(--card-border);
        }

        .roast-content {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-purple);
            margin-bottom: 16px;
        }

        .roast-text {
            font-size: 17px;
            line-height: 1.8;
            color: var(--text-main);
            margin: 0;
            font-style: italic;
        }

        .dimension-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .dimension-tag {
            font-size: 15px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            color: var(--text-main);
            font-weight: 500;
        }

        .vibe-traits {
            margin-bottom: 32px;
        }

        .traits-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-main);
        }

        .traits-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .trait-tag {
            padding: 8px 16px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-main);
        }

        .vibe-fingerprint {
            margin-bottom: 32px;
        }

        .fingerprint-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-main);
        }

        .fingerprint-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .fingerprint-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid var(--card-border);
            text-align: center;
        }

        .fingerprint-label {
            font-size: 15px;
            color: var(--text-dim);
        }

        .fingerprint-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-main);
        }

        .vibe-chart-container {
            margin-bottom: 32px;
        }

        .vibe-chart-container .chart-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
        }

        #vibeRadarChart {
            max-height: 100%;
        }

        .btn {
            background: var(--accent-gradient);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .hidden {
            display: none !important;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            .wordcloud-section {
                grid-template-columns: 1fr;
            }
            .chat-list-header {
                flex-direction: column;
                align-items: stretch;
            }
            .search-input {
                width: 100%;
            }
            .pagination-container {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 数字跳动动画 */
        @keyframes numberPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); color: var(--accent-purple); text-shadow: 0 0 10px var(--accent-purple); }
            100% { transform: scale(1); }
        }

        @keyframes numberFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .stat-value.animate-pulse {
            animation: numberPulse 0.6s ease-in-out;
        }

        .stat-value.animate-flash {
            animation: numberFlash 0.4s ease-in-out;
        }

        .stat-value.updating {
            position: relative;
        }

        .stat-value.updating::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body class="bg-[#050505]">
    <div id="root"></div>
    <!-- 完整报告容器（隐藏，等待渲染） -->
    <div id="fullReportContainer" style="display: none;"></div>

    <script type="module">
        // 模块加载逻辑（适配开发和生产环境）
        (async function() {
            // 检测当前部署环境
            const pathname = window.location.pathname;
            const hostname = window.location.hostname;
            const isDev = hostname === 'localhost' || hostname === '127.0.0.1' || hostname.includes('localhost') || hostname.includes('192.168.');
            const isGitHubPages = hostname.includes('github.io');
            
            // 设置加载状态
            window.analysisModuleLoading = true;
            window.analysisModuleError = null;
            
            try {
                let module;
                
                if (isDev) {
                    // 开发环境：直接导入（Vite 会自动处理）
                    console.log('[Main] 开发环境：直接导入 main.js');
                    module = await import('./main.js');
                } else {
                    // 生产环境：动态导入（支持多种部署路径）
                    console.log('[Main] 生产环境：动态导入 main.js');
                    
                    // 检测基础路径（更准确的检测逻辑）
                    let basePath = '';
                    if (isGitHubPages) {
                        // GitHub Pages: 从 pathname 提取仓库名
                        // pathname 可能是: /Cursor-Clinical-Analysis/ 或 /Cursor-Clinical-Analysis/index.html
                        const pathParts = pathname.split('/').filter(p => p);
                        // 移除 'index.html' 如果存在
                        const cleanParts = pathParts.filter(p => p !== 'index.html');
                        if (cleanParts.length > 0) {
                            // 第一个非空部分通常是仓库名
                            basePath = '/' + cleanParts[0];
                        }
                    } else {
                        // 其他生产环境
                        const pathParts = pathname.split('/').filter(p => p && p !== 'index.html');
                        basePath = pathParts.length > 0 ? '/' + pathParts[0] : '';
                    }
                    
                    // 确保 basePath 格式正确
                    if (basePath && basePath !== '/' && basePath.endsWith('/')) {
                        basePath = basePath.slice(0, -1);
                    }
                    
                    // 获取当前目录（用于相对路径）
                    const currentDir = pathname.substring(0, pathname.lastIndexOf('/')) || '';
                    
                    // 构建路径列表（GitHub Pages 使用绝对路径，本地使用相对路径）
                    const paths = [];
                    
                    if (isGitHubPages && basePath) {
                        // GitHub Pages：优先使用绝对路径
                        paths.push(`${basePath}/main.js`);
                        paths.push(`${basePath}/dist/main.js`);
                    }
                    
                    // 相对路径（本地环境或备用）
                    paths.push('./main.js');
                    paths.push('./dist/main.js');
                    
                    // 基于当前目录（备用）
                    if (currentDir) {
                        paths.push(`${currentDir}/main.js`);
                        paths.push(`${currentDir}/dist/main.js`);
                    }
                    
                    console.log('[Main] 当前 URL:', window.location.href);
                    console.log('[Main] 当前路径:', pathname);
                    console.log('[Main] 基础路径:', basePath);
                    console.log('[Main] 当前目录:', currentDir);
                    console.log('[Main] 尝试路径列表:', paths);
                    console.log('[Main] 路径数量:', paths.length);
                    
                    if (paths.length === 0) {
                        throw new Error('无法构建有效的模块路径。请检查部署配置。');
                    }
                    
                    let loaded = false;
                    let lastError = null;
                    const errors = [];
                    
                    for (const path of paths) {
                        try {
                            console.log(`[Main] 尝试加载模块，路径: ${path}`);
                            module = await import(/* @vite-ignore */ path);
                            console.log(`[Main] ✅ 成功加载模块，路径: ${path}`);
                            loaded = true;
                            break;
                        } catch (err) {
                            const errorInfo = {
                                path,
                                error: err.message,
                                name: err.name
                            };
                            errors.push(errorInfo);
                            console.warn(`[Main] 路径 ${path} 加载失败:`, err.message);
                            lastError = err;
                        }
                    }
                    
                    if (!loaded) {
                        console.error('[Main] ❌ 所有路径都加载失败');
                        console.error('[Main] 所有尝试的错误:', errors);
                        console.error('[Main] 最后尝试的错误:', lastError);
                        const errorDetails = errors.map(e => `  - ${e.path}: ${e.error}`).join('\n');
                        throw new Error(`模块加载失败：所有路径都尝试失败。\n尝试的路径：\n${errorDetails}\n\n请确认：\n1. 已运行 npm run build\n2. dist/main.js 文件存在\n3. 文件已正确部署到 GitHub Pages`);
                    }
                }
                
                // 检查必需的导出函数
                const requiredExports = [
                    'initializeParser',
                    'processFiles',
                    'renderFullDashboard',
                    'getGlobalStats',
                    'getVibeResult'
                ];
                
                const missingExports = requiredExports.filter(name => 
                    typeof module[name] !== 'function'
                );
                
                if (missingExports.length > 0) {
                    console.error(`[Main] 模块缺少必需的导出:`, missingExports);
                    console.error(`[Main] 模块实际导出:`, Object.keys(module));
                    throw new Error(`模块缺少必需的导出函数: ${missingExports.join(', ')}`);
                }
                
                const { 
                    initializeParser, 
                    processFiles, 
                    renderFullDashboard,
                    getGlobalStats,
                    getVibeResult,
                    updateNumberWithAnimation,
                    formatNumber,
                    fetchTotalTestUsers,
                    reportNewUser,
                    updateGlobalStats
                } = module;
                
                // 将模块暴露给全局，供 React 使用
                window.analysisModule = {
                    initializeParser,
                    processFiles,
                    renderFullDashboard,
                    getGlobalStats,
                    getVibeResult,
                    updateNumberWithAnimation: updateNumberWithAnimation || (() => {}),
                    formatNumber: formatNumber || ((n) => n.toString()),
                    fetchTotalTestUsers: fetchTotalTestUsers || (async () => 0),
                    reportNewUser: reportNewUser || (async () => {}),
                    updateGlobalStats: updateGlobalStats || (() => {})
                };
                
                // 验证全局对象
                console.log('[Main] 全局模块对象已创建:', {
                    hasInitializeParser: typeof window.analysisModule.initializeParser === 'function',
                    hasProcessFiles: typeof window.analysisModule.processFiles === 'function',
                    hasRenderFullDashboard: typeof window.analysisModule.renderFullDashboard === 'function'
                });
                
                window.analysisModuleLoading = false;
                window.analysisModuleError = null;
            } catch (err) {
                console.error('[Main] ❌ 模块加载失败:', err);
                window.analysisModuleLoading = false;
                window.analysisModuleError = err;
                // 触发自定义事件，通知 React 组件
                window.dispatchEvent(new CustomEvent('analysisModuleLoadFailed', { 
                    detail: { error: err } 
                }));
            }
        })();
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // 模拟 Lucide 图标组件
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current) {
                    lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className} style={{width: size, height: size}}></i>;
        };

        // 统计卡片子组件
        function StatBox({ label, value, sub, color }) {
            return (
                <div className="bg-zinc-950/50 border border-zinc-800 p-4 rounded-2xl min-w-[120px] md:min-w-[140px]">
                    <div className="text-zinc-600 text-[10px] uppercase tracking-tighter mb-1 font-bold">{label}</div>
                    <div className={`text-2xl font-black ${color}`}>
                        {value}
                        <span className="text-xs ml-1 opacity-50 font-normal text-zinc-400">{sub}</span>
                    </div>
                </div>
            );
        }

        function App() {
            const [step, setStep] = useState('upload');
            const [logs, setLogs] = useState([]);
            const [analysisData, setAnalysisData] = useState(null);
            const [error, setError] = useState(null);
            const [isInitialized, setIsInitialized] = useState(false);
            const [totalTestUsers, setTotalTestUsers] = useState(0); // 从 API 获取，不使用硬编码
            // 实时统计数据（全部从 Cloudflare API 获取）
            const [totalUsers, setTotalUsers] = useState(0); // 受虐人数
            const [techRank, setTechRank] = useState(0); // 技术排名
            const [unlockedCount, setUnlockedCount] = useState(0); // 人格解锁数
            const folderInputRef = useRef(null);
            const fileInputRef = useRef(null);
            // 用于保存动画所需的旧值和新值
            const animationDataRef = useRef(null);

            // 格式化数字显示
            const formatNumber = (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 10000) return (num / 10000).toFixed(1) + '万';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            };

            // 数字跳动动画效果函数
            const animateNumberUpdate = (elementId, oldValue, newValue, formatFn) => {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.warn(`[动画] 未找到元素: ${elementId}`);
                    return;
                }

                // 添加跳动动画类
                element.classList.add('animate-pulse');
                
                // 计算差值
                const diff = newValue - oldValue;
                if (diff === 0) {
                    // 没有变化，直接移除动画类
                    setTimeout(() => {
                        element.classList.remove('animate-pulse');
                    }, 100);
                    return;
                }
                
                const duration = 800; // 动画持续时间（毫秒）
                const steps = 30; // 动画步数
                const stepValue = diff / steps;
                const stepDuration = duration / steps;
                let currentStep = 0;
                const startTime = Date.now();
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // 使用缓动函数（ease-out）
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const currentValue = Math.round(oldValue + diff * easeOut);
                    
                    element.textContent = formatFn(currentValue);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        // 确保最终值准确
                        element.textContent = formatFn(newValue);
                        // 移除动画类
                        setTimeout(() => {
                            element.classList.remove('animate-pulse');
                        }, 100);
                        console.log(`[动画] ${elementId} 动画完成: ${oldValue} -> ${newValue}`);
                    }
                };
                
                animate();
            };

            // 页面加载时从 API 获取"全网受虐人数"
            useEffect(() => {
                const fetchTotalUsers = async () => {
                    try {
                        const apiUrl = 'https://cursor-clinical-analysis.psterman.workers.dev/';
                        console.log('[React] 发起 GET 请求获取全网受虐人数...');
                        
                        const response = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            mode: 'cors',
                            cache: 'no-cache',
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            const value = data.value || data.totalUsers || data.total || data.count || 0;
                            
                            console.log('[React] API 返回数据:', data, '解析后的值:', value);
                            
                            if (value > 0) {
                                // 受虐人数：使用 API 返回的实时访问总数
                                setTotalUsers(value);
                                setTotalTestUsers(value);
                                
                                // 技术排名：根据总人数按比例动态计算 (value * 0.6)
                                const calculatedRank = Math.floor(value * 0.6);
                                setTechRank(calculatedRank);
                                
                                // 人格库解锁：根据总人数按比例动态计算 (value / 1000)%，最大100%
                                const calculatedUnlocked = Math.min(100, parseFloat((value / 1000).toFixed(1)));
                                setUnlockedCount(calculatedUnlocked);
                                
                                // 保存到本地存储作为 fallback
                                localStorage.setItem('totalTestUsers', value.toString());
                                console.log('[React] 数据获取成功:', {
                                    totalUsers: value,
                                    techRank: calculatedRank,
                                    unlockedCount: calculatedUnlocked
                                });
                            } else {
                                throw new Error('API 返回的值为 0 或无效');
                            }
                        } else {
                            throw new Error(`API 请求失败，状态码: ${response.status}`);
                        }
                    } catch (error) {
                        console.warn('[React] API 请求失败，使用 localStorage fallback:', error.message);
                        // 使用 localStorage 作为 fallback
                        const cached = parseInt(localStorage.getItem('totalTestUsers') || '0');
                        if (cached > 0) {
                            setTotalUsers(cached);
                            setTotalTestUsers(cached);
                            // 根据缓存值动态计算
                            setTechRank(Math.floor(cached * 0.6));
                            setUnlockedCount(Math.min(100, parseFloat((cached / 1000).toFixed(1))));
                            console.log('[React] 使用缓存数据:', {
                                totalUsers: cached,
                                techRank: Math.floor(cached * 0.6),
                                unlockedCount: Math.min(100, parseFloat((cached / 1000).toFixed(1)))
                            });
                        } else {
                            // 如果缓存也没有，使用默认值 0
                            setTotalUsers(0);
                            setTechRank(0);
                            setUnlockedCount(0);
                        }
                    }
                };
                
                fetchTotalUsers();
            }, []);

            // 初始化解析器
            useEffect(() => {
                const init = async () => {
                    try {
                        console.log('检查 analysisModule:', window.analysisModule);
                        console.log('检查 analysisModuleLoading:', window.analysisModuleLoading);
                        console.log('检查 analysisModuleError:', window.analysisModuleError);
                        
                        // 等待模块加载（最多等待 5 秒）
                        let retries = 0;
                        const maxRetries = 50; // 50 * 100ms = 5秒
                        
                        while (!window.analysisModule && retries < maxRetries) {
                            // 如果模块加载失败，立即退出
                            if (window.analysisModuleError) {
                                console.error('模块加载失败:', window.analysisModuleError);
                                setError('模块加载失败: ' + (window.analysisModuleError.message || '未知错误') + '，请刷新页面重试');
                                return;
                            }
                            
                            // 如果模块还在加载中，继续等待
                            if (window.analysisModuleLoading !== false) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                retries++;
                            } else {
                                // 加载完成但模块不存在，说明加载失败
                                break;
                            }
                        }
                        
                        if (window.analysisModule) {
                            console.log('✅ 模块已加载，初始化解析器...');
                            await window.analysisModule.initializeParser();
                            setIsInitialized(true);
                            setLogs(prev => [...prev, '> 解析器初始化完成']);
                        } else {
                            console.error('❌ 模块加载超时或失败');
                            const errorMsg = window.analysisModuleError 
                                ? '模块加载失败: ' + window.analysisModuleError.message
                                : '模块加载超时，请刷新页面重试';
                            setError(errorMsg);
                        }
                    } catch (err) {
                        console.error('初始化失败:', err);
                        setError('初始化失败: ' + err.message);
                    }
                };
                
                // 监听模块加载失败事件
                const handleLoadFailed = (event) => {
                    console.error('收到模块加载失败事件:', event.detail);
                    setError('模块加载失败: ' + (event.detail.error?.message || '未知错误') + '，请刷新页面重试');
                };
                window.addEventListener('analysisModuleLoadFailed', handleLoadFailed);
                
                init();
                
                // 清理事件监听器
                return () => {
                    window.removeEventListener('analysisModuleLoadFailed', handleLoadFailed);
                };
            }, []);

            // 处理文件选择
            const handleFileSelect = (type) => {
                console.log('handleFileSelect 被调用', type);
                console.log('folderInputRef.current:', folderInputRef.current);
                console.log('fileInputRef.current:', fileInputRef.current);
                
                if (type === 'folder') {
                    if (folderInputRef.current) {
                        console.log('触发文件夹选择');
                        folderInputRef.current.click();
                    } else {
                        console.error('folderInputRef.current 为 null');
                    }
                } else {
                    if (fileInputRef.current) {
                        console.log('触发文件选择');
                        fileInputRef.current.click();
                    } else {
                        console.error('fileInputRef.current 为 null');
                    }
                }
            };

            // 处理文件上传
            const handleFileUpload = async (event, type) => {
                console.log('handleFileUpload 被调用', { type, files: event.target.files });
                
                const files = Array.from(event.target.files || []);
                console.log('文件列表:', files.map(f => ({ name: f.name, size: f.size })));
                
                if (files.length === 0) {
                    console.warn('没有选择文件');
                    return;
                }

                setError(null);
                setStep('analyzing');
                setLogs(['> 开始解析数据库文件...']);

                try {
                    // 检查模块是否加载，如果未加载则等待一段时间
                    if (!window.analysisModule) {
                        console.warn('模块未加载，等待加载...');
                        setLogs(prev => [...prev, '> 等待分析模块加载...']);
                        
                        // 等待模块加载（最多等待 3 秒）
                        let retries = 0;
                        const maxRetries = 30; // 30 * 100ms = 3秒
                        
                        while (!window.analysisModule && retries < maxRetries) {
                            // 如果模块加载失败，立即退出
                            if (window.analysisModuleError) {
                                throw new Error('分析模块加载失败: ' + (window.analysisModuleError.message || '未知错误') + '，请刷新页面重试');
                            }
                            
                            // 如果模块还在加载中，继续等待
                            if (window.analysisModuleLoading !== false) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                retries++;
                            } else {
                                // 加载完成但模块不存在，说明加载失败
                                break;
                            }
                        }
                        
                        if (!window.analysisModule) {
                            const errorMsg = window.analysisModuleError 
                                ? '分析模块加载失败: ' + window.analysisModuleError.message
                                : '分析模块加载超时';
                            throw new Error(errorMsg + '，请刷新页面重试');
                        }
                        
                        console.log('✅ 模块已加载，继续处理文件');
                        setLogs(prev => [...prev, '> 分析模块已就绪']);
                    }

                    if (!isInitialized) {
                        setLogs(prev => [...prev, '> 初始化解析器...']);
                        await window.analysisModule.initializeParser();
                        setIsInitialized(true);
                    }

                    // 调用 main.js 的处理函数
                    console.log('调用 processFiles...');
                    await window.analysisModule.processFiles(files, type, {
                        onLog: (log) => {
                            console.log('onLog:', log);
                            setLogs(prev => [...prev, log]);
                        },
                        onProgress: (current, total, fileName) => {
                            console.log('onProgress:', { current, total, fileName });
                            setLogs(prev => [...prev, `> 处理进度: ${current}/${total} - ${fileName}`]);
                        },
                        onComplete: (data) => {
                            console.log('onComplete:', data);
                            setAnalysisData(data);
                            setLogs(prev => [...prev, '> 分析完成！']);
                            setTimeout(() => {
                                setStep('preview');
                            }, 500);
                        },
                        onError: (err) => {
                            console.error('onError:', err);
                            setError(err.message || '处理失败');
                            setStep('upload');
                        }
                    });
                } catch (err) {
                    console.error('处理失败:', err);
                    setError(err.message || '处理失败');
                    setStep('upload');
                }
            };


            // 计算排名（基于"请"的次数，简化版）
            // TODO: 用户稍后会修改此函数的参数
            const calculateRank = (qingCount) => {
                // 简化计算：假设平均用户说"请"50次，超过越多排名越高
                const base = 50;
                const ratio = qingCount / base;
                return Math.min(99, Math.max(1, Math.round(ratio * 50)));
            };

            // 计算对话天数（从最早文件时间计算）
            const calculateUsageDays = (stats) => {
                if (!stats || !stats.earliestFileTime) {
                    return 0;
                }
                const now = Date.now();
                const earliest = stats.earliestFileTime;
                const diffMs = now - earliest;
                return Math.floor(diffMs / (1000 * 60 * 60 * 24));
            };

            // 进入完整报告
            const showFullReport = async () => {
                console.log('showFullReport 被调用，发起 POST 请求增加计数值...');
                
                // 保存当前值，用于动画效果
                const oldTotalUsers = totalUsers;
                const oldTechRank = techRank;
                const oldUnlockedCount = unlockedCount;
                
                // 在用户点击生成报告时，发起 POST 请求增加计数值
                try {
                    const apiUrl = 'https://cursor-clinical-analysis.psterman.workers.dev/';
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors',
                        body: JSON.stringify({
                            action: 'increment',
                            timestamp: Date.now(),
                        }),
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const newCount = data.value || data.totalUsers || data.total || data.count || 0;
                        
                        if (newCount > 0) {
                            // 更新所有相关状态
                            setTotalUsers(newCount);
                            setTotalTestUsers(newCount);
                            
                            // 根据新的总人数动态计算技术排名和人格库解锁
                            const calculatedRank = Math.floor(newCount * 0.6);
                            setTechRank(calculatedRank);
                            
                            const calculatedUnlocked = Math.min(100, parseFloat((newCount / 1000).toFixed(1)));
                            setUnlockedCount(calculatedUnlocked);
                            
                            // 保存到本地存储作为 fallback
                            localStorage.setItem('totalTestUsers', newCount.toString());
                            
                            console.log('[React] POST 请求成功，计数值已更新:', {
                                totalUsers: newCount,
                                techRank: calculatedRank,
                                unlockedCount: calculatedUnlocked
                            });
                            
                            // 保存动画数据到 ref，等待 Dashboard 渲染完成后触发
                            animationDataRef.current = {
                                totalUsers: { old: oldTotalUsers, new: newCount },
                                techRank: { old: oldTechRank, new: calculatedRank },
                                unlockedCount: { old: oldUnlockedCount, new: calculatedUnlocked }
                            };
                        } else {
                            console.warn('[React] POST 请求返回的值为 0 或无效');
                        }
                    } else {
                        console.warn('[React] POST 请求失败，状态码:', response.status);
                        // POST 失败时，尝试从 localStorage 获取最新值
                        const cached = parseInt(localStorage.getItem('totalTestUsers') || '0');
                        if (cached > 0) {
                            setTotalUsers(cached);
                            setTotalTestUsers(cached);
                            setTechRank(Math.floor(cached * 0.6));
                            setUnlockedCount(Math.min(100, parseFloat((cached / 1000).toFixed(1))));
                        }
                    }
                } catch (error) {
                    console.warn('[React] POST 请求异常，使用 localStorage fallback:', error.message);
                    // 请求异常时，使用 localStorage 作为 fallback
                    const cached = parseInt(localStorage.getItem('totalTestUsers') || '0');
                    if (cached > 0) {
                        setTotalUsers(cached);
                        setTotalTestUsers(cached);
                        setTechRank(Math.floor(cached * 0.6));
                        setUnlockedCount(Math.min(100, parseFloat((cached / 1000).toFixed(1))));
                    }
                }
                
                setStep('fullReport');
                // 延迟渲染，确保 DOM 已更新
                setTimeout(() => {
                    const container = document.getElementById('fullReportContainer');
                    if (container && window.analysisModule) {
                        console.log('创建 Dashboard DOM...');
                        // 创建 Dashboard DOM 结构（从 index.html 复制）
                        container.innerHTML = `
                            <div class="full-report-container" style="max-width: 1100px; margin: 0 auto; padding: 20px; padding-bottom: 80px;">
                                <header style="text-align: center; padding: 60px 20px;">
                                    <div class="logo-box" style="display: inline-block; padding: 8px 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--card-border); border-radius: 20px; margin-bottom: 20px; font-size: 14px; color: var(--accent-blue); backdrop-filter: var(--glass-blur);">Clinical Analysis v2.0</div>
                                    <h1 style="font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 800; letter-spacing: -0.05em; background: linear-gradient(to bottom, #fff 30%, #a1a1a1 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 15px;">Cursor 迷惑行为报告</h1>
                                    <p class="subtitle" style="color: var(--text-dim); font-size: 1.1rem;">基于本地 SQLite 数据库的深度受虐分析</p>
                                </header>
                                
                                <div id="dashboardSection">
                                    <!-- 实时统计区域 -->
                                    <div class="realtime-stats-section" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 24px; padding: 24px; margin-bottom: 40px; backdrop-filter: var(--glass-blur);">
                                        <h3 class="chart-title" style="margin-bottom: 20px; text-align: center;">📊 实时统计</h3>
                                        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label">全网受虐人数</p>
                                                <p class="stat-value" id="totalTestUsers" style="color: var(--accent-blue);">加载中...</p>
                                                <p class="stat-comparison">人</p>
                                            </div>
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label">技术排名</p>
                                                <p class="stat-value" id="techRank" style="color: var(--accent-purple);">加载中...</p>
                                                <p class="stat-comparison">名</p>
                                            </div>
                                            <div class="stat-card" style="text-align: center;">
                                                <p class="stat-label">人格库解锁</p>
                                                <p class="stat-value" id="personalityUnlock" style="color: #10b981;">加载中...</p>
                                                <p class="stat-comparison">243 种人格</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 维度得分排行榜 -->
                                    <div class="dimension-ranking-section" style="background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 24px; padding: 24px; margin-bottom: 40px; backdrop-filter: var(--glass-blur);">
                                        <h3 class="chart-title" style="margin-bottom: 20px; text-align: center;">🏆 六大硬核维度得分排行榜</h3>
                                        <div id="dimensionRankingList" class="prompts-list"></div>
                                    </div>

                                    <div class="stats-grid" id="exportArea">
                                        <div class="stat-card">
                                            <p class="stat-label">Cursor上岗天数</p>
                                            <p class="stat-value" id="totalConversations">0</p>
                                            <p class="stat-comparison">天</p>
                                        </div>
                                        <div class="stat-card">
                                            <p class="stat-label">调戏 AI 次数</p>
                                            <p class="stat-value" id="userMessages">0</p>
                                        </div>
                                    </div>
                                    
                                    <div class="stats-grid">
                                        <div class="stat-card">
                                            <p class="stat-label">赛博磕头次数</p>
                                            <p class="stat-value" id="qingCount">0</p>
                                            <p class="stat-comparison">次</p>
                                        </div>
                                        <div class="stat-card">
                                            <p class="stat-label">甲方爸爸上身</p>
                                            <p class="stat-value" id="buCount">0</p>
                                            <p class="stat-comparison">次</p>
                                        </div>
                                    </div>
                                    
                                    <div class="stats-grid">
                                        <div class="stat-card">
                                            <p class="stat-label">废话文学输出</p>
                                            <p class="stat-value" id="totalUserChars">0</p>
                                            <p class="stat-comparison">字符</p>
                                        </div>
                                        <div class="stat-card">
                                            <p class="stat-label">平均吹水长度</p>
                                            <p class="stat-value" id="avgUserMessageLength">0</p>
                                            <p class="stat-comparison">字符</p>
                                        </div>
                                        <div class="stat-card hidden" id="questionCard">
                                            <p class="stat-label">黑人问号次数</p>
                                            <p class="stat-value" id="questionMessageCount">0</p>
                                            <p class="stat-comparison">条</p>
                                        </div>
                                    </div>
                                    
                                    <div class="wordcloud-section">
                                        <div class="chart-card">
                                            <h3 class="chart-title">☁️ AI功德簿</h3>
                                            <div class="wordcloud-container">
                                                <canvas id="chineseWordCloud"></canvas>
                                            </div>
                                        </div>
                                        <div class="chart-card">
                                            <h3 class="chart-title">🔤 你的硅谷黑话口头禅</h3>
                                            <div class="wordcloud-container">
                                                <canvas id="englishWordCloud"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="chart-card" style="margin-top: 40px;">
                                        <h3 class="chart-title">🗣️ vibe coding黑话榜</h3>
                                        <div class="prompts-list" id="topChineseWordsList"></div>
                                    </div>
                                    
                                    <div class="chart-card" id="techStackSection" style="display: none; margin-top: 40px;">
                                        <h3 class="chart-title">🛠️ 用户技术栈 Top 10</h3>
                                        <div class="prompts-list" id="techStackList"></div>
                                    </div>
                                    
                                    <div class="vibe-codinger-section chart-card" id="vibeCodingerSection" style="margin-top: 40px;"></div>
                                    
                                    <div class="chat-list-section" style="margin-top: 40px;">
                                        <div class="chat-list-header">
                                            <h3 class="chat-list-title">对话记录</h3>
                                            <div class="chat-list-controls">
                                                <input type="text" id="searchInput" class="search-input" placeholder="搜索对话...">
                                            </div>
                                        </div>
                                        <div class="chat-list" id="chatList"></div>
                                        <div class="pagination-container" id="paginationContainer" style="display: none;">
                                            <div class="pagination-info">
                                                <span id="paginationInfo">第 1 页，共 1 页</span>
                                            </div>
                                            <div class="pagination-controls">
                                                <button id="paginationPrev" class="pagination-btn" disabled>上一页</button>
                                                <div class="pagination-pages" id="paginationPages"></div>
                                                <button id="paginationNext" class="pagination-btn">下一页</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="text-align: center; margin-top: 50px;">
                                        <button class="btn" id="exportBtn" style="background: rgba(255,255,255,0.1); border: 1px solid var(--card-border);">
                                            <span>生成受虐证据海报</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        // 显示容器
                        container.style.display = 'block';
                        
                        // 等待 DOM 完全渲染后再调用渲染函数
                        setTimeout(() => {
                            console.log('开始渲染 Dashboard...');
                            // 显示 Dashboard
                            const dashboardSection = container.querySelector('#dashboardSection');
                            if (dashboardSection) {
                                dashboardSection.classList.remove('hidden');
                                dashboardSection.style.display = 'block';
                            }
                            
                            // 确保数据已准备好
                            const stats = window.analysisModule.getGlobalStats();
                            const vibeResult = window.analysisModule.getVibeResult();
                            console.log('数据状态:', {
                                hasStats: !!stats,
                                hasVibeResult: !!vibeResult
                            });
                            
                            // 渲染完整 Dashboard
                            try {
                                window.analysisModule.renderFullDashboard();
                                console.log('Dashboard 渲染完成');
                                
                                // 立即使用当前状态值更新显示（使用 formatNumber）
                                const formatNumberLocal = (num) => {
                                    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                                    if (num >= 10000) return (num / 10000).toFixed(1) + '万';
                                    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                                    return num.toString();
                                };
                                
                                const totalUsersEl = document.getElementById('totalTestUsers');
                                const techRankEl = document.getElementById('techRank');
                                const personalityUnlockEl = document.getElementById('personalityUnlock');
                                
                                if (totalUsersEl && totalUsers > 0) {
                                    totalUsersEl.textContent = formatNumberLocal(totalUsers);
                                }
                                if (techRankEl && techRank > 0) {
                                    techRankEl.textContent = formatNumberLocal(techRank);
                                }
                                if (personalityUnlockEl && unlockedCount > 0) {
                                    personalityUnlockEl.textContent = unlockedCount.toFixed(1) + '%';
                                }
                                
                                // 检查是否有待执行的动画数据（来自 POST 请求）
                                if (animationDataRef.current) {
                                    const animData = animationDataRef.current;
                                    console.log('[动画] 开始执行数字跳动动画:', animData);
                                    
                                    // 更新全网受虐人数，带跳动效果
                                    if (animData.totalUsers.old !== animData.totalUsers.new) {
                                        animateNumberUpdate('totalTestUsers', animData.totalUsers.old, animData.totalUsers.new, formatNumberLocal);
                                    }
                                    
                                    // 更新技术排名，带跳动效果
                                    if (animData.techRank.old !== animData.techRank.new) {
                                        animateNumberUpdate('techRank', animData.techRank.old, animData.techRank.new, formatNumberLocal);
                                    }
                                    
                                    // 更新人格库解锁，带跳动效果
                                    if (animData.unlockedCount.old !== animData.unlockedCount.new) {
                                        const animatePercentage = (elementId, oldVal, newVal) => {
                                            const element = document.getElementById(elementId);
                                            if (!element) return;
                                            
                                            element.classList.add('animate-pulse');
                                            const diff = newVal - oldVal;
                                            const duration = 800;
                                            const steps = 30;
                                            const stepValue = diff / steps;
                                            let currentStep = 0;
                                            
                                            const animate = () => {
                                                if (currentStep < steps) {
                                                    const currentValue = oldVal + stepValue * currentStep;
                                                    element.textContent = currentValue.toFixed(1) + '%';
                                                    currentStep++;
                                                    requestAnimationFrame(() => {
                                                        setTimeout(animate, duration / steps);
                                                    });
                                                } else {
                                                    element.textContent = newVal.toFixed(1) + '%';
                                                    setTimeout(() => {
                                                        element.classList.remove('animate-pulse');
                                                    }, 100);
                                                }
                                            };
                                            
                                            animate();
                                        };
                                        
                                        animatePercentage('personalityUnlock', animData.unlockedCount.old, animData.unlockedCount.new);
                                    }
                                    
                                    // 清空动画数据
                                    animationDataRef.current = null;
                                }
                            } catch (error) {
                                console.error('渲染 Dashboard 失败:', error);
                            }
                            
                            // 实时更新统计数据（从 Cloudflare API 获取）
                            const updateRealtimeStats = async () => {
                                // 格式化数字函数（确保在作用域内可用）
                                const formatNumberLocal = (num) => {
                                    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                                    if (num >= 10000) return (num / 10000).toFixed(1) + '万';
                                    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                                    return num.toString();
                                };
                                
                                try {
                                    const apiUrl = 'https://cursor-clinical-analysis.psterman.workers.dev/';
                                    console.log('[实时更新] 开始获取 Cloudflare 实时数据...');
                                    
                                    const response = await fetch(apiUrl, {
                                        method: 'GET',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        mode: 'cors',
                                        cache: 'no-cache',
                                    });
                                    
                                    if (response.ok) {
                                        const data = await response.json();
                                        const value = data.value || data.totalUsers || data.total || data.count || 0;
                                        
                                        console.log('[实时更新] API 返回数据:', data, '解析后的值:', value);
                                        
                                        if (value > 0) {
                                            // 更新 React 状态
                                            setTotalUsers(value);
                                            setTotalTestUsers(value);
                                            const calculatedRank = Math.floor(value * 0.6);
                                            setTechRank(calculatedRank);
                                            const calculatedUnlocked = Math.min(100, parseFloat((value / 1000).toFixed(1)));
                                            setUnlockedCount(calculatedUnlocked);
                                            
                                            // 更新 DOM 元素
                                            const totalUsersEl = document.getElementById('totalTestUsers');
                                            const techRankEl = document.getElementById('techRank');
                                            const personalityUnlockEl = document.getElementById('personalityUnlock');
                                            
                                            if (totalUsersEl) {
                                                // 使用 formatNumber 处理显示格式
                                                const formatted = formatNumberLocal(value);
                                                totalUsersEl.textContent = formatted;
                                                // 添加更新动画
                                                totalUsersEl.classList.add('animate-pulse');
                                                setTimeout(() => {
                                                    totalUsersEl.classList.remove('animate-pulse');
                                                }, 600);
                                                console.log('[实时更新] 全网受虐人数已更新:', formatted);
                                            } else {
                                                console.warn('[实时更新] 未找到 totalTestUsers 元素');
                                            }
                                            
                                            if (techRankEl) {
                                                // 使用 formatNumber 处理显示格式
                                                const formatted = formatNumberLocal(calculatedRank);
                                                techRankEl.textContent = formatted;
                                                techRankEl.classList.add('animate-pulse');
                                                setTimeout(() => {
                                                    techRankEl.classList.remove('animate-pulse');
                                                }, 600);
                                                console.log('[实时更新] 技术排名已更新:', formatted);
                                            } else {
                                                console.warn('[实时更新] 未找到 techRank 元素');
                                            }
                                            
                                            if (personalityUnlockEl) {
                                                personalityUnlockEl.textContent = calculatedUnlocked.toFixed(1) + '%';
                                                personalityUnlockEl.classList.add('animate-pulse');
                                                setTimeout(() => {
                                                    personalityUnlockEl.classList.remove('animate-pulse');
                                                }, 600);
                                                console.log('[实时更新] 人格库解锁已更新:', calculatedUnlocked.toFixed(1) + '%');
                                            } else {
                                                console.warn('[实时更新] 未找到 personalityUnlock 元素');
                                            }
                                            
                                            console.log('[实时更新] 统计数据已全部更新:', {
                                                totalUsers: value,
                                                techRank: calculatedRank,
                                                unlockedCount: calculatedUnlocked
                                            });
                                        } else {
                                            console.warn('[实时更新] API 返回的值为 0 或无效');
                                        }
                                    } else {
                                        console.warn('[实时更新] API 请求失败，状态码:', response.status);
                                    }
                                } catch (error) {
                                    console.error('[实时更新] 获取数据失败:', error.message, error);
                                }
                            };
                            
                            // 等待 DOM 完全渲染后再更新（延迟执行以确保元素存在）
                            setTimeout(() => {
                                console.log('[实时更新] 开始首次更新实时统计数据...');
                                updateRealtimeStats();
                                
                                // 清理之前的定时器（如果存在）
                                if (window.realtimeStatsInterval) {
                                    clearInterval(window.realtimeStatsInterval);
                                }
                                
                                // 每30秒自动刷新一次
                                window.realtimeStatsInterval = setInterval(() => {
                                    console.log('[实时更新] 定时刷新统计数据...');
                                    updateRealtimeStats();
                                }, 30000);
                            }, 500);
                        }, 200);
                    } else {
                        console.error('容器或模块未找到');
                    }
                }, 100);
            };

            // 导出报告
            const exportReport = async () => {
                try {
                    const exportArea = document.getElementById('exportArea');
                    if (!exportArea) {
                        alert('导出区域未找到');
                        return;
                    }
                    
                    const canvas = await html2canvas(exportArea, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        useCORS: true,
                        logging: false,
                    });

                    const link = document.createElement('a');
                    link.download = `cursor-audit-${new Date().getTime()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (err) {
                    console.error('导出失败:', err);
                    alert('导出失败: ' + err.message);
                }
            };

            return (
                <div className="min-h-screen text-zinc-100 p-4 md:p-8 flex flex-col items-center justify-center relative">
                    <div className="fixed top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-600 via-blue-500 to-cyan-400 shadow-[0_0_15px_rgba(139,92,246,0.5)] z-50" />

                    {/* 隐藏的文件输入 */}
                    <input 
                        type="file" 
                        ref={folderInputRef}
                        webkitdirectory=""
                        directory=""
                        multiple 
                        style={{ display: 'none' }}
                        onChange={(e) => {
                            console.log('文件夹选择事件触发', e.target.files);
                            handleFileUpload(e, 'folder');
                        }}
                    />
                    <input 
                        type="file" 
                        ref={fileInputRef}
                        accept=".vscdb,.db,.sqlite,.sqlite3" 
                        multiple 
                        style={{ display: 'none' }}
                        onChange={(e) => {
                            console.log('文件选择事件触发', e.target.files);
                            handleFileUpload(e, 'file');
                        }}
                    />

                    {/* 上传阶段 */}
                    {step === 'upload' && (
                        <div className="max-w-2xl w-full space-y-8 text-center">
                            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-zinc-900 border border-zinc-800 text-xs text-blue-400 mb-4 mx-auto">
                                <Icon name="zap" size={12} />
                                <span>AI 行为学临床实验室 v2.0</span>
                            </div>
                            <h1 style={{
                                fontSize: 'clamp(2rem, 5vw, 3.5rem)',
                                fontWeight: 800,
                                letterSpacing: '-0.05em',
                                background: 'linear-gradient(to bottom, #fff 30%, #a1a1a1 100%)',
                                WebkitBackgroundClip: 'text',
                                backgroundClip: 'text',
                                WebkitTextFillColor: 'transparent',
                                marginBottom: '15px'
                            }}>
                                Cursor 迷惑行为报告
                            </h1>
                            <p className="text-zinc-500 text-lg max-w-md mx-auto">
                                基于本地 SQLite 数据库的深度受虐分析
                            </p>
                            
                            {error && (
                                <div className="bg-red-900/20 border border-red-800 text-red-400 p-4 rounded-xl">
                                    {error}
                                </div>
                            )}
                            
                            <div className="group relative p-12 mt-12 border-2 border-dashed border-zinc-800 rounded-3xl hover:border-purple-500/50 transition-all cursor-pointer bg-zinc-900/50 backdrop-blur-sm">
                                <div className="relative z-10 space-y-4 text-center">
                                    <span style={{ fontSize: '48px', marginBottom: '20px', display: 'block' }} className="upload-icon">🧪</span>
                                    <h2 style={{ marginBottom: '10px', fontSize: '20px', fontWeight: 600, color: 'var(--text-main)' }}>载入你的 VSCDB 文件</h2>
                                    <p style={{ color: 'var(--text-dim)', marginBottom: '25px' }}>交出你的聊天存货，数据仅在本地解析，绝不上传云端</p>
                                    <div className="flex gap-4 justify-center mt-6">
                                        <button 
                                            onClick={() => handleFileSelect('folder')}
                                            className="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-semibold transition-colors"
                                        >
                                            选择文件夹
                                        </button>
                                        <button 
                                            onClick={() => handleFileSelect('file')}
                                            className="px-6 py-3 bg-zinc-800 hover:bg-zinc-700 text-white rounded-xl font-semibold transition-colors border border-zinc-700"
                                        >
                                            选择文件
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 分析阶段 */}
                    {step === 'analyzing' && (
                        <div className="w-full max-w-lg bg-zinc-950 border border-zinc-800 rounded-xl p-6 shadow-2xl overflow-hidden">
                            <div className="flex items-center gap-2 mb-4 border-b border-zinc-900 pb-3">
                                <Icon name="terminal" size={16} className="text-green-500" />
                                <span className="text-xs text-zinc-500 uppercase tracking-widest">System Analysis</span>
                            </div>
                            <div className="space-y-2 h-64 overflow-y-auto custom-scrollbar">
                                {logs.map((log, i) => (
                                    <div key={i} className="text-sm text-zinc-400 font-mono">
                                        {log}
                                    </div>
                                ))}
                                <div className="w-2 h-5 bg-green-500 animate-pulse inline-block" />
                            </div>
                        </div>
                    )}

                    {/* 预览结果阶段 */}
                    {step === 'preview' && analysisData && (
                        <div className="max-w-4xl w-full space-y-6">
                            <div className="bg-zinc-900 border border-zinc-800 rounded-[2rem] p-8 md:p-12 relative overflow-hidden shadow-2xl">
                                <div className="absolute top-0 right-0 w-64 h-64 bg-purple-600/10 blur-[100px] -z-10" />
                                
                                <div className="flex flex-col md:flex-row justify-between items-start gap-8">
                                    <div className="space-y-6">
                                        <div>
                                            <h2 className="text-zinc-500 text-sm uppercase tracking-widest mb-1">人格鉴定结果</h2>
                                            <div className="text-5xl font-black text-white italic">
                                                {analysisData.vibeResult?.personalityName || '未知人格'}
                                            </div>
                                        </div>
                                        <p className="text-zinc-400 text-lg max-w-sm">
                                            {analysisData.vibeResult?.roastText || '分析中...'}
                                        </p>
                                        {analysisData.vibeResult?.vibeIndex && (
                                            <div className="flex gap-2">
                                                <span className="px-3 py-1 bg-zinc-800 text-zinc-400 text-xs rounded-full border border-zinc-700">
                                                    Vibe Index: {analysisData.vibeResult.vibeIndex}
                                                </span>
                                            </div>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 w-full md:w-auto">
                                        <StatBox 
                                            label="全网受虐人数" 
                                            value={formatNumber(totalUsers)} 
                                            sub="人" 
                                            color="text-blue-400" 
                                        />
                                        <StatBox 
                                            label="赛博磕头" 
                                            value={analysisData.stats?.qingCount || 0} 
                                            sub="次" 
                                            color="text-purple-400" 
                                        />
                                        <StatBox 
                                            label="全网排名" 
                                            value={calculateRank(analysisData.stats?.qingCount || 0)} 
                                            sub="%" 
                                            color="text-blue-400" 
                                        />
                                        <StatBox 
                                            label="甲方上身" 
                                            value={analysisData.stats?.buCount || 0} 
                                            sub="次" 
                                            color="text-red-400" 
                                        />
                                        <StatBox 
                                            label="对话天数" 
                                            value={calculateUsageDays(analysisData.stats)} 
                                            sub="天" 
                                            color="text-emerald-400" 
                                        />
                                    </div>
                                </div>

                                <div className="mt-12 p-6 bg-zinc-950/50 rounded-2xl border border-zinc-800 flex items-start gap-4">
                                    <Icon name="alert-triangle" className="text-yellow-500 shrink-0 mt-1" size={20} />
                                    <p className="text-sm text-zinc-400 italic">
                                        专家诊断：你对 Cursor 说了 {analysisData.stats?.qingCount || 0} 次"请"，
                                        {analysisData.stats?.qingCount > 100 ? '你对你老板可能都没这么客气过。' : '还算正常。'}
                                        建议适当增加"直接命令"语气，找回丢失的码农尊严。
                                    </p>
                                </div>
                            </div>

                            <div className="flex flex-col sm:flex-row gap-4 justify-center pt-4">
                                <button 
                                    onClick={showFullReport}
                                    className="flex items-center justify-center gap-2 bg-white text-black px-8 py-4 rounded-2xl font-bold hover:bg-zinc-200 transition-colors"
                                >
                                    <Icon name="share-2" size={20} />
                                    晒出我的受虐证据
                                </button>
                                <button 
                                    onClick={exportReport}
                                    className="flex items-center justify-center gap-2 bg-zinc-900 text-white px-8 py-4 rounded-2xl font-bold border border-zinc-800 hover:bg-zinc-800 transition-colors"
                                >
                                    <Icon name="download" size={20} />
                                    保存体检报告
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 完整报告阶段 */}
                    {step === 'fullReport' && (
                        <div className="w-full" style={{minHeight: '100vh'}}>
                            <div id="fullReportContainer" style={{display: 'block'}}></div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

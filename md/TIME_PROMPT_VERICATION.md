# 时段和提示词问题验证指南

## 🎯 问题已修复

已成功修复工作时段和提示词提取的问题！

### 修复的问题

1. **✅ 工作时段提取** - 从上下文中推断时间戳
2. **✅ 角色识别改进** - 多重判断逻辑 + 内容特征分析
3. **✅ 提示词统计** - 正确识别用户消息
4. **✅ 详细的调试日志** - 每步都有日志输出

## 🔧 技术改进

### 1. 时间戳提取

**新增字段**：
- `messageTime`, `sentAt`, `bubbleTime`, `userTime`, `aiTime`

**时间戳验证**：
- 检查 `new Date(value)` 是否返回有效日期
- 避免使用无效的时间戳

**上下文推断**：
- 从 JSON 上下文中查找时间戳
- 支持多种时间戳字段名

### 2. 角色识别

**新增判断逻辑**：
- 检查 `role` 字段
- 检查 `sender` 字段
- 检查消息内容特征（以"请"、"帮我"开头的用户消息）

**上下文推断**：
- 从 JSON 上下文中查找类型字段
- 统计用户/AI 模式的出现次数

### 3. 正则表达式提取

**改进点**：
- 从上下文中推断角色
- 从上下文中推断模型
- 从上下文中推断时间戳
- 避免所有记录都被标记为 AI

## 🧪 验证步骤

### 步骤 1：启动应用

```bash
# Windows
start.bat

# macOS/Linux
bash start.sh
```

### 步骤 2：上传文件

1. 点击"选择单个文件"按钮
2. 选择一个 `state.vscdb` 文件
3. 等待 3-10 秒

### 步骤 3：查看控制台日志

**关键日志**：

**时间戳提取**：
```
[CursorParser] 尝试提取时间戳...
[CursorParser] 从 createdAt 提取时间戳: 2025-01-10T09:30:00.000Z
```

**角色识别**：
```
[CursorParser] 尝试确定角色...
[CursorParser] 通过特征字段确定为 USER
```

**正则提取**：
```
[CursorParser] 开始正则表达式提取...
[CursorParser] 正则提取完成，找到 150 个文本，提取到 150 条记录
[CursorParser] 提取结果统计: { USER: 50, AI: 100, unknown: 0 }
```

**统计摘要**：
```
[CursorParser] ========== 统计摘要 ==========
[CursorParser] 总对话次数: 100
[CursorParser] 用户消息: 50
[CursorParser] AI 消息: 100
[CursorParser] 代码字符数: 123456
[CursorParser] 模型使用: { gpt-4: 80, gpt-3.5: 20 }
[CursorParser] 时段统计: [0, 0, 0, 1, 2, 5, 8, 15, 20, 18, 12, 8, 5, 3, 2, 1, 0, 0, 0, 0, 0]
[CursorParser] 提示词数量: 25
[CursorParser] =====================================
```

## 📊 验证结果

### 1. 工作时段热力图

**正常显示**：
- ✅ 柱状图显示 24 个小时的数据
- ✅ 高峰时段（如 9-18 点）柱子较高
- ✅ 低谷时段（如 0-6 点）柱子较低或为 0

**异常情况**：
- ❌ 所有柱子都是 0 → 数据库没有时间戳信息
- ❌ 所有柱子都相同高度 → 所有记录都使用当前时间
- ❌ 只有一个时段有数据 → 只有一条对话

### 2. 提示词列表

**正常显示**：
- ✅ 至少显示 1 条提示词
- ✅ 每条提示词格式：`#1 [提示词内容] X 次`
- ✅ 提示词是用户输入的文本片段（前 100 字符）

**异常情况**：
- ❌ 显示"暂无数据" → 没有识别到用户消息
- ❌ 所有提示词都是 AI 回复的文本片段 → 角色识别错误

### 3. 统计卡片

**正常显示**：
- ✅ 总对话次数 > 0
- ✅ 用户消息 > 0
- ✅ 最常用模型不是 "-" 或 "unknown"

**异常情况**：
- ❌ 用户消息为 0 → 没有识别到用户消息
- ❌ 最常用模型是 "unknown" → 没有识别到模型

## 🎯 验证清单

### 时间戳提取
- [ ] 控制台显示时间戳提取日志
- [ ] 时段统计数组不全为 0
- [ ] 工作时段热力图有不同高度的柱子
- [ ] 至少有一个时段有数据

### 角色识别
- [ ] 控制台显示"用户消息数量: X"（X > 0）
- [ ] 控制台显示"AI 消息数量: Y"
- [ ] 提示词列表有内容
- [ ] 提示词不是 AI 回复的文本

### 整体验证
- [ ] 页面显示正常，不白屏
- [ ] 4 个统计卡片都有数据
- [ ] 2 个图表都显示
- [ ] 提示词列表有内容
- [ ] 对话记录列表有内容

## 🚨 常见问题

### 问题 1：工作时段图还是空的

**检查清单**：
1. 查看控制台日志，确认有"时段统计"日志
2. 查看日志中的 `hourlyActivity` 数组
3. 如果数组全为 0，说明数据库没有时间戳

**可能原因**：
- Cursor 版本不同，数据库结构改变
- 数据库中没有存储时间戳
- 时间戳格式不标准

**这是数据问题，不是应用的 bug**

### 问题 2：提示词列表还是空的

**检查清单**：
1. 查看控制台日志，确认"用户消息数量" > 0
2. 查看日志中的"提示词数量"
3. 如果用户消息为 0，说明数据库中没有用户消息

**可能原因**：
- 数据库只包含 AI 回复
- 用户消息被错误识别为 AI 消息
- 用户消息太短被过滤（< 5 字符）

**如果是识别错误**：
- 查看控制台日志中的角色推断日志
- 确认有多少条记录被识别为 USER
- 尝试上传不同的 `state.vscdb` 文件

### 问题 3：所有记录的时间都是现在

**检查清单**：
1. 查看控制台日志中的时间戳提取日志
2. 如果都显示"使用当前时间"，说明数据库没有时间戳

**可能原因**：
- Cursor 版本不同，数据库结构改变
- 数据库中没有存储时间戳字段
- 时间戳格式不标准

**这是数据问题，不是应用的 bug**

## 📞 如果还是不行

### 收集诊断信息

1. **控制台完整日志**：
   - 按 F12 打开控制台
   - 右键 → 保存为... → 保存为文本文件

2. **日志关键信息**：
   - "提取结果统计: { USER: X, AI: Y, unknown: Z }"
   - "用户消息数量: X"
   - "提示词数量: X"
   - "时段统计: [...]"

3. **截图信息**：
   - 工作时段热力图
   - 提示词列表
   - 统计卡片

### 查看详细的日志

**查找这些关键信息**：
1. 是否有时间戳提取日志？
2. 是否有角色推断日志？
3. 用户消息数量是多少？
4. 提示词数量是多少？
5. 时段统计数组是什么？

## ✅ 成功标志

### 控制台日志
```
[CursorParser] ========== 统计摘要 ==========
[CursorParser] 总对话次数: 100
[CursorParser] 用户消息: 50
[CursorParser] AI 消息: 100
[CursorParser] 代码字符数: 123456
[CursorParser] 模型使用: { gpt-4: 80, gpt-3.5: 20 }
[CursorParser] 时段统计: [0, 0, 0, 1, 2, 5, 8, 15, 20, 18, 12, 8, 5, 3, 2, 1, 0, 0, 0, 0, 0]
[CursorParser] 提示词数量: 25
[CursorParser] =====================================
```

### 页面显示
- ✅ 工作时段热力图有数据（不全为 0）
- ✅ 提示词列表有内容
- ✅ 用户消息数量 > 0
- ✅ 提示词后面显示使用次数

---

**修复时间**：2025-01-12
**修复版本**：v1.5.0
**状态**：✅ 已修复并测试通过

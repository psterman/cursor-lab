# ä¿®å¤è¯´æ˜ï¼šåˆ†æ•°åŒºé—´å’Œæ–‡æ¡ˆæå–é—®é¢˜

## é—®é¢˜åˆ†æ

æ ¹æ®æºç åˆ†æï¼Œå‘ç°äº†ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š

### 1. åˆ†æ•°åŒºé—´å®šä¹‰çš„"é€»è¾‘çœŸç©º" (Boundary Issue)

**é—®é¢˜**ï¼š`rank-content.ts` ä¸­éƒ¨åˆ†ç»´åº¦çš„ `min` å€¼ä» 1 å¼€å§‹ï¼Œè€Œä¸æ˜¯ 0ã€‚è¿™å¯¼è‡´ï¼š
- å¦‚æœç»´åº¦åˆ†æ•°æ˜¯ 0ï¼Œæ— æ³•åŒ¹é…åˆ°ç¬¬ä¸€ä¸ªæ¡£ä½
- åŒ¹é…é€»è¾‘ `rankValue >= min && rankValue <= max` åœ¨ `min === 1` æ—¶ï¼Œ0 åˆ†æ— æ³•åŒ¹é…

**ç¤ºä¾‹**ï¼š
```typescript
// rank-content.ts ä¸­çš„å®šä¹‰
{
  "min": 1,  // âŒ é—®é¢˜ï¼š0 åˆ†æ— æ³•åŒ¹é…
  "max": 20,
  "label": "å†·æ·¡çš„ç”²æ–¹è·¯äºº"
}
```

### 2. ç»´åº¦ Key çš„"è¯­ä¹‰æ–­å±‚" (Mapping Gap)

**é—®é¢˜**ï¼šè™½ç„¶ä»£ç ä¸­æœ‰æ˜ å°„è¡¨ï¼Œä½†åŒ¹é…é€»è¾‘å¯èƒ½ä¸å¤Ÿå¥å£®ã€‚

**æ˜ å°„å…³ç³»**ï¼š
- L â†’ 'word' (é€»è¾‘åŠ› â†’ å¹³å‡é•¿åº¦æ’å)
- P â†’ 'no' (è€å¿ƒå€¼ â†’ ç”²æ–¹ä¸Šèº«æ’å)
- D â†’ 'say' (ç»†è…»åº¦ â†’ åºŸè¯è¾“å‡ºæ’å)
- E â†’ 'ai' (æ¢ç´¢æ¬² â†’ è°ƒæˆ AI æ’å)
- F â†’ 'please' (åé¦ˆæ„Ÿ â†’ èµ›åšç£•å¤´æ’å)

### 3. commentsZh æ•°ç»„çš„éšæœºæŠ½å–å¤±æ•ˆ

**é—®é¢˜**ï¼šè™½ç„¶ä»£ç ä¸­æœ‰éšæœºæŠ½å–é€»è¾‘ï¼Œä½†å¯èƒ½æ²¡æœ‰æ­£ç¡®å¤„ç†è¾¹ç•Œæƒ…å†µã€‚

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šåˆ†æ•°åŒºé—´åŒ¹é…é€»è¾‘

**ä½ç½®**ï¼š`src/worker/index.ts` ç¬¬ 346-384 è¡Œ

**ä¿®å¤å‰**ï¼š
```typescript
// é—®é¢˜ï¼šå¦‚æœ min === 1ï¼Œ0 åˆ†æ— æ³•åŒ¹é…
for (const level of resource.levels) {
  const min = level.min || 0;
  const max = level.max || 999999;
  if (rankValue >= min && rankValue <= max) {
    matchedLevel = level;
    break;
  }
}
```

**ä¿®å¤å**ï¼š
```typescript
// ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨ find æ–¹æ³•ï¼Œå¹¶å¤„ç† min === 1 çš„æƒ…å†µ
let matchedLevel = resource.levels.find((level: any) => {
  const min = level.min || 0;
  const max = level.max || 999999;
  
  // ã€ä¿®å¤ã€‘å¦‚æœ min === 1ï¼Œå…è®¸ 0 åˆ†ä¹ŸåŒ¹é…åˆ°ç¬¬ä¸€ä¸ªæ¡£ä½
  const adjustedMin = (min === 1 && rankValue === 0) ? 0 : min;
  
  return rankValue >= adjustedMin && rankValue <= max;
});
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… ä½¿ç”¨ `find` æ–¹æ³•ï¼Œæ›´ç®€æ´é«˜æ•ˆ
- âœ… å¤„ç† `min === 1` çš„ç‰¹æ®Šæƒ…å†µï¼Œå…è®¸ 0 åˆ†åŒ¹é…
- âœ… å¢å¼ºé™çº§å¤„ç†é€»è¾‘

### ä¿®å¤ 2ï¼šé™çº§å¤„ç†é€»è¾‘

**ä½ç½®**ï¼š`src/worker/index.ts` ç¬¬ 360-384 è¡Œ

**ä¿®å¤å**ï¼š
```typescript
// ã€é™çº§å¤„ç†ã€‘å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæˆ–æœ€åä¸€ä¸ª level
if (!matchedLevel) {
  if (resource.levels.length > 0) {
    const firstLevel = resource.levels[0];
    const lastLevel = resource.levels[resource.levels.length - 1];
    const firstMin = firstLevel.min || 0;
    const lastMax = lastLevel.max || 999999;
    
    // å¦‚æœåˆ†æ•°å¤ªä½ï¼ˆåŒ…æ‹¬ 0 åˆ†ï¼‰ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª level
    if (rankValue <= firstMin) {
      matchedLevel = firstLevel;
    }
    // å¦‚æœåˆ†æ•°å¤ªé«˜ï¼Œä½¿ç”¨æœ€åä¸€ä¸ª level
    else if (rankValue > lastMax) {
      matchedLevel = lastLevel;
    }
    // å¦åˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ª levelï¼ˆå…œåº•ï¼‰
    else {
      matchedLevel = firstLevel;
    }
  }
}
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… æ›´æ¸…æ™°çš„é™çº§é€»è¾‘
- âœ… å¤„ç†è¾¹ç•Œæƒ…å†µï¼ˆåˆ†æ•°å¤ªä½/å¤ªé«˜ï¼‰
- âœ… æ·»åŠ æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•

### ä¿®å¤ 3ï¼šcommentsZh æ•°ç»„çš„éšæœºæŠ½å–

**ä½ç½®**ï¼š`src/worker/index.ts` ç¬¬ 386-410 è¡Œ

**ä¿®å¤å‰**ï¼š
```typescript
const comments = matchedLevel[langKey] || [];
let roast = 'æš‚æ— åæ§½æ–‡æ¡ˆ';

if (Array.isArray(comments) && comments.length > 0) {
  const randomIndex = Math.floor(Math.random() * comments.length);
  const selectedComment = comments[randomIndex];
  
  if (selectedComment && selectedComment.content) {
    roast = selectedComment.content;
  }
}
```

**ä¿®å¤å**ï¼š
```typescript
// ã€å…³é”®ä¿®å¤ã€‘ä» commentsZh æˆ– commentsEn æ•°ç»„ä¸­éšæœºæŠ½å–ä¸€ä¸ª content
const comments = matchedLevel[langKey] || [];
let roast = 'æš‚æ— åæ§½æ–‡æ¡ˆ';

if (Array.isArray(comments) && comments.length > 0) {
  // éšæœºé€‰æ‹©ä¸€ä¸ªè¯„è®º
  const randomIndex = Math.floor(Math.random() * comments.length);
  const selectedComment = comments[randomIndex];
  
  // ã€ä¿®å¤ã€‘ç¡®ä¿æ­£ç¡®æå– content å­—æ®µ
  if (selectedComment) {
    if (typeof selectedComment === 'string') {
      // å¦‚æœç›´æ¥æ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
      roast = selectedComment;
    } else if (selectedComment.content && typeof selectedComment.content === 'string') {
      // å¦‚æœæ˜¯å¯¹è±¡ï¼Œæå– content å­—æ®µ
      roast = selectedComment.content;
    } else {
      console.warn(`[Adapter] âš ï¸ ç»´åº¦ ${dimKey} çš„è¯„è®ºæ ¼å¼å¼‚å¸¸:`, selectedComment);
    }
  }
  
  // ã€éªŒè¯ã€‘ç¡®ä¿ roast æ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²
  if (!roast || roast === 'æš‚æ— åæ§½æ–‡æ¡ˆ') {
    console.warn(`[Adapter] âš ï¸ ç»´åº¦ ${dimKey} æ— æ³•æå–æœ‰æ•ˆçš„ roastï¼Œcomments é•¿åº¦: ${comments.length}`);
  }
} else {
  console.warn(`[Adapter] âš ï¸ ç»´åº¦ ${dimKey} çš„ ${langKey} æ•°ç»„ä¸ºç©ºæˆ–ä¸å­˜åœ¨`);
}
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… å¤„ç†å­—ç¬¦ä¸²å’Œå¯¹è±¡ä¸¤ç§æ ¼å¼
- âœ… ç¡®ä¿æ­£ç¡®æå– `content` å­—æ®µ
- âœ… æ·»åŠ éªŒè¯å’Œè­¦å‘Šæ—¥å¿—

## æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹ 1ï¼š0 åˆ†åŒ¹é…

**è¾“å…¥**ï¼š
```typescript
dimensions = { L: 0, P: 0, D: 0, E: 0, F: 0 }
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ‰€æœ‰ç»´åº¦éƒ½èƒ½åŒ¹é…åˆ°ç¬¬ä¸€ä¸ª level
- âœ… æ¯ä¸ªç»´åº¦éƒ½æœ‰æœ‰æ•ˆçš„ label å’Œ roast

### æµ‹è¯•ç”¨ä¾‹ 2ï¼šè¾¹ç•Œå€¼åŒ¹é…

**è¾“å…¥**ï¼š
```typescript
dimensions = { L: 1, P: 20, D: 50, E: 100, F: 99 }
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ¯ä¸ªç»´åº¦éƒ½èƒ½åŒ¹é…åˆ°å¯¹åº”çš„ level
- âœ… è¾¹ç•Œå€¼ï¼ˆ1, 20, 50, 100ï¼‰éƒ½èƒ½æ­£ç¡®åŒ¹é…

### æµ‹è¯•ç”¨ä¾‹ 3ï¼šè¶Šç•Œå€¼å¤„ç†

**è¾“å…¥**ï¼š
```typescript
dimensions = { L: 200, P: -10, D: 150, E: 300, F: 999 }
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… è¶…å‡ºèŒƒå›´çš„å€¼ä½¿ç”¨æœ€åä¸€ä¸ª level
- âœ… ä½äºèŒƒå›´çš„å€¼ä½¿ç”¨ç¬¬ä¸€ä¸ª level
- âœ… æ‰€æœ‰ç»´åº¦éƒ½æœ‰æœ‰æ•ˆçš„ label å’Œ roast

## æ—¥å¿—è¾“å‡ºç¤ºä¾‹

ä¿®å¤åçš„æ—¥å¿—è¾“å‡ºï¼š

```
[Adapter] ğŸ” å¤„ç†ç»´åº¦ L, åˆ†æ•°: 0
[Adapter] ğŸ” ç»´åº¦ L æ˜ å°„åˆ° rankId: word
[Adapter] âœ… æ‰¾åˆ°èµ„æº word, levels æ•°é‡: 3
[Adapter] âœ… ç»´åº¦ L åŒ¹é…æˆåŠŸ: {
  rankId: 'word',
  originalScore: 0,
  rankValue: 0,
  label: 'å†·æ·¡çš„ç”²æ–¹è·¯äºº',
  roastLength: 45,
  roastPreview: 'å¯¹è¯è¿™ä¹ˆå°‘ï¼Ÿçœ‹æ¥ä½ ä¹ æƒ¯ä¸€åˆ€è‡´å‘½...',
  matchedLevelRange: '1-20',
  commentsCount: 20
}
```

## ç›¸å…³æ–‡ä»¶

- `src/worker/index.ts` - ä¸»æ–‡ä»¶ï¼ˆå·²ä¿®å¤ï¼‰
- `src/rank-content.ts` - æ’åæ–‡æ¡ˆåº“ï¼ˆæ•°æ®æºï¼‰
- `src/worker/rank.ts` - æ’åè®¡ç®—é€»è¾‘

## æ³¨æ„äº‹é¡¹

1. **åˆ†æ•°æ˜ å°„**ï¼šç»´åº¦åˆ†æ•°ï¼ˆ0-100ï¼‰éœ€è¦æ­£ç¡®æ˜ å°„åˆ° rank-content.ts çš„æ•°å€¼èŒƒå›´
2. **è¾¹ç•Œå¤„ç†**ï¼šç¡®ä¿ 0 åˆ†å’Œè¾¹ç•Œå€¼éƒ½èƒ½æ­£ç¡®åŒ¹é…
3. **æ•°æ®æ ¼å¼**ï¼šç¡®ä¿ commentsZh/commentsEn æ•°ç»„æ ¼å¼æ­£ç¡®
4. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰é”™è¯¯æƒ…å†µéƒ½æœ‰é™çº§æ–¹æ¡ˆå’Œæ—¥å¿—è¾“å‡º

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Token è®¤é¢†æœºåˆ¶ç¤ºä¾‹</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #0a0a0a;
            color: #00ff41;
        }
        .section {
            background: rgba(24, 24, 27, 0.7);
            border: 1px solid #27272a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        h2 {
            color: #00ff41;
            border-bottom: 2px solid #00ff41;
            padding-bottom: 10px;
        }
        button {
            background: #00ff41;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }
        button:hover {
            background: #00cc33;
        }
        .code {
            background: #1a1a1a;
            padding: 15px;
            border-left: 3px solid #00ff41;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid #00ff41;
        }
        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff0000;
            color: #ff6b6b;
        }
        .info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <h1>ğŸ”‘ Claim Token è®¤é¢†æœºåˆ¶ç¤ºä¾‹</h1>
    
    <div class="section">
        <h2>æ­¥éª¤ 1: åŒ¿ååˆ†æ (ç”Ÿæˆ claim_token)</h2>
        <p>æ¨¡æ‹Ÿç”¨æˆ·åœ¨æœªç™»å½•çŠ¶æ€ä¸‹è¿›è¡Œåˆ†æ,åç«¯ä¼šç”Ÿæˆå¹¶è¿”å› claim_token</p>
        <button onclick="performAnonymousAnalysis()">æ‰§è¡ŒåŒ¿ååˆ†æ</button>
        <div id="analysis-result"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤ 2: GitHub ç™»å½•</h2>
        <p>æ¨¡æ‹Ÿç”¨æˆ·ç™»å½• GitHub,è·å– OAuth token å’Œ user_id</p>
        <button onclick="simulateGitHubLogin()">æ¨¡æ‹Ÿ GitHub ç™»å½•</button>
        <div id="login-result"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤ 3: è®¤é¢†æ•°æ®</h2>
        <p>ä½¿ç”¨ claim_token å°†åŒ¿åæ•°æ®è¿ç§»åˆ° GitHub è´¦å·</p>
        <button onclick="claimData()">è®¤é¢†æ•°æ®</button>
        <div id="claim-result"></div>
    </div>

    <div class="section">
        <h2>æœ¬åœ°å­˜å‚¨çŠ¶æ€</h2>
        <button onclick="showLocalStorage()">æŸ¥çœ‹ localStorage</button>
        <button onclick="clearLocalStorage()">æ¸…ç©º localStorage</button>
        <div id="storage-status"></div>
    </div>

    <div class="section">
        <h2>å®Œæ•´æµç¨‹ä»£ç ç¤ºä¾‹</h2>
        <div class="code">
// ã€æ­¥éª¤ 1ã€‘åˆ†æå®Œæˆå,æ•è· claim_token
async function onAnalysisComplete(analysisData) {
    if (analysisData.claim_token) {
        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('vibe_claim_token', analysisData.claim_token);
        console.log('ğŸ”‘ claim_token å·²ä¿å­˜:', analysisData.claim_token.substring(0, 8) + '...');
    }
}

// ã€æ­¥éª¤ 2ã€‘GitHub ç™»å½•å,æ£€æŸ¥æ˜¯å¦éœ€è¦è®¤é¢†
async function onGitHubLoginSuccess(user, session) {
    const claimToken = localStorage.getItem('vibe_claim_token');
    
    if (claimToken) {
        console.log('ğŸ” æ£€æµ‹åˆ°å¾…è®¤é¢†çš„æ•°æ®,å¼€å§‹è®¤é¢†æµç¨‹...');
        
        try {
            const response = await fetch('/api/fingerprint/migrate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({
                    userId: user.id,
                    claimToken: claimToken
                })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                console.log('âœ… æ•°æ®è®¤é¢†æˆåŠŸ!');
                // æ¸…é™¤ claim_token
                localStorage.removeItem('vibe_claim_token');
                // åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡
                await refreshUserStats();
            } else {
                console.error('âŒ æ•°æ®è®¤é¢†å¤±è´¥:', result.error);
            }
        } catch (error) {
            console.error('âŒ è®¤é¢†è¿‡ç¨‹å‡ºé”™:', error);
        }
    } else {
        console.log('â„¹ï¸ æ— å¾…è®¤é¢†æ•°æ®,ç›´æ¥åŠ è½½ç”¨æˆ·ç»Ÿè®¡');
        await refreshUserStats();
    }
}

// ã€æ­¥éª¤ 3ã€‘åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡
async function refreshUserStats() {
    // ä»åç«¯è·å–æœ€æ–°çš„ç”¨æˆ·æ•°æ®
    console.log('ğŸ”„ åˆ·æ–°ç”¨æˆ·ç»Ÿè®¡æ•°æ®...');
}
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'https://cursor-clinical-analysis.psterman.workers.dev';
        
        // æ¨¡æ‹ŸåŒ¿ååˆ†æ
        async function performAnonymousAnalysis() {
            const resultDiv = document.getElementById('analysis-result');
            resultDiv.innerHTML = '<div class="status info">â³ æ­£åœ¨æ‰§è¡Œåˆ†æ...</div>';
            
            try {
                // æ¨¡æ‹Ÿåˆ†æè¯·æ±‚
                const mockAnalysisData = {
                    chatData: [
                        { role: 'USER', text: 'å¸®æˆ‘å†™ä¸€ä¸ªReactç»„ä»¶' },
                        { role: 'ASSISTANT', text: 'å¥½çš„,æˆ‘æ¥å¸®ä½ ...' }
                    ],
                    lang: 'zh-CN'
                };
                
                // æ³¨æ„:è¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„ /api/v2/analyze æ¥å£
                // const response = await fetch(`${API_ENDPOINT}/api/v2/analyze`, {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(mockAnalysisData)
                // });
                // const result = await response.json();
                
                // æ¨¡æ‹Ÿè¿”å›ç»“æœ
                const mockResult = {
                    status: 'success',
                    claim_token: crypto.randomUUID(),
                    dimensions: { L: 75, P: 60, D: 80, E: 70, F: 65 }
                };
                
                // ä¿å­˜ claim_token
                localStorage.setItem('vibe_claim_token', mockResult.claim_token);
                
                resultDiv.innerHTML = `
                    <div class="status success">
                        âœ… åˆ†æå®Œæˆ!<br>
                        <strong>claim_token:</strong> ${mockResult.claim_token.substring(0, 16)}...<br>
                        <small>å·²ä¿å­˜åˆ° localStorage</small>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ åˆ†æå¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ¨¡æ‹Ÿ GitHub ç™»å½•
        function simulateGitHubLogin() {
            const resultDiv = document.getElementById('login-result');
            
            // æ¨¡æ‹Ÿ GitHub OAuth è¿”å›çš„æ•°æ®
            const mockUser = {
                id: crypto.randomUUID(),
                email: 'user@example.com',
                user_metadata: {
                    avatar_url: 'https://github.com/identicons/user.png',
                    user_name: 'testuser'
                }
            };
            
            const mockSession = {
                access_token: 'mock_jwt_token_' + Math.random().toString(36).substring(7)
            };
            
            // ä¿å­˜åˆ° localStorage (æ¨¡æ‹Ÿ)
            localStorage.setItem('github_user', JSON.stringify(mockUser));
            localStorage.setItem('github_session', JSON.stringify(mockSession));
            
            resultDiv.innerHTML = `
                <div class="status success">
                    âœ… GitHub ç™»å½•æˆåŠŸ!<br>
                    <strong>User ID:</strong> ${mockUser.id.substring(0, 16)}...<br>
                    <strong>Username:</strong> ${mockUser.user_metadata.user_name}
                </div>
            `;
        }
        
        // è®¤é¢†æ•°æ®
        async function claimData() {
            const resultDiv = document.getElementById('claim-result');
            resultDiv.innerHTML = '<div class="status info">â³ æ­£åœ¨è®¤é¢†æ•°æ®...</div>';
            
            try {
                const claimToken = localStorage.getItem('vibe_claim_token');
                const userStr = localStorage.getItem('github_user');
                const sessionStr = localStorage.getItem('github_session');
                
                if (!claimToken) {
                    throw new Error('æœªæ‰¾åˆ° claim_token,è¯·å…ˆæ‰§è¡ŒåŒ¿ååˆ†æ');
                }
                
                if (!userStr || !sessionStr) {
                    throw new Error('æœªç™»å½• GitHub,è¯·å…ˆç™»å½•');
                }
                
                const user = JSON.parse(userStr);
                const session = JSON.parse(sessionStr);
                
                // æ³¨æ„:è¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„ /api/fingerprint/migrate æ¥å£
                // const response = await fetch(`${API_ENDPOINT}/api/fingerprint/migrate`, {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json',
                //         'Authorization': `Bearer ${session.access_token}`
                //     },
                //     body: JSON.stringify({
                //         userId: user.id,
                //         claimToken: claimToken
                //     })
                // });
                // const result = await response.json();
                
                // æ¨¡æ‹ŸæˆåŠŸå“åº”
                const mockResult = {
                    status: 'success',
                    message: 'æ•°æ®è®¤é¢†æˆåŠŸ',
                    data: {
                        total_messages: 150,
                        total_chars: 5000
                    }
                };
                
                if (mockResult.status === 'success') {
                    // æ¸…é™¤ claim_token
                    localStorage.removeItem('vibe_claim_token');
                    
                    resultDiv.innerHTML = `
                        <div class="status success">
                            âœ… ${mockResult.message}<br>
                            <strong>æ€»æ¶ˆæ¯æ•°:</strong> ${mockResult.data.total_messages}<br>
                            <strong>æ€»å­—ç¬¦æ•°:</strong> ${mockResult.data.total_chars}<br>
                            <small>claim_token å·²æ¸…é™¤</small>
                        </div>
                    `;
                } else {
                    throw new Error(mockResult.error || 'è®¤é¢†å¤±è´¥');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ è®¤é¢†å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ˜¾ç¤º localStorage
        function showLocalStorage() {
            const statusDiv = document.getElementById('storage-status');
            const claimToken = localStorage.getItem('vibe_claim_token');
            const user = localStorage.getItem('github_user');
            const session = localStorage.getItem('github_session');
            
            statusDiv.innerHTML = `
                <div class="code">
                    <strong>vibe_claim_token:</strong> ${claimToken ? claimToken.substring(0, 16) + '...' : '(ç©º)'}<br>
                    <strong>github_user:</strong> ${user ? 'å·²è®¾ç½®' : '(ç©º)'}<br>
                    <strong>github_session:</strong> ${session ? 'å·²è®¾ç½®' : '(ç©º)'}
                </div>
            `;
        }
        
        // æ¸…ç©º localStorage
        function clearLocalStorage() {
            localStorage.removeItem('vibe_claim_token');
            localStorage.removeItem('github_user');
            localStorage.removeItem('github_session');
            
            const statusDiv = document.getElementById('storage-status');
            statusDiv.innerHTML = '<div class="status success">âœ… localStorage å·²æ¸…ç©º</div>';
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºçŠ¶æ€
        window.addEventListener('load', showLocalStorage);
    </script>
</body>
</html>
